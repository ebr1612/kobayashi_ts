!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).zeaEngine={})}(this,(function(e){"use strict";var t={name:"@zeainc/zea-engine",fileName:"index",libraryName:"ZeaEngine",version:"3.8.0",description:"Zea Engine",browser:"dist/index.umd.js",plugins:"dist/plugins.umd.js",main:"dist/index.cjs.js",module:"dist/index.esm.js",author:"Zea Inc.",license:"AGPL-3.0",files:["dist/","dist/public-resources/"],scripts:{build:"rollup -c","build:watch":"rollup -w -c",dev:"npm-run-all --parallel build:watch start:watch",prepare:"yarn run build",dist:"yarn publish --access=public",docs:"cp CHANGELOG.md docs/ && adg --config adg.config.json","docs-w":"cp CHANGELOG.md docs/ && adg -w --config=adg.config.json","docs:serve":"docsify serve docs/",generate:"plop",release:"standard-version",start:"http-server --cors --port 8000 --silent","start:watch":"es-dev-server --cors --app-index testing-e2e/index.html --open --watch",test:"jest","test:coverage":"jest --coverage","test:debug":"node --inspect ./node_modules/jest/bin/jest.js --runInBand --watch","test:watch":"jest --watch","test:e2e":"percy exec cypress run --browser chrome --headless","test:e2e:watch":"percy exec cypress open","to-cleanup":"rm -Rf dist/ node_modules/ yarn.lock"},dependencies:{debug:"^4.1.1",semver:"^7.3.2"},devDependencies:{"@babel/preset-env":"^7.11.5","@percy/cypress":"^2.3.1","@rollup/plugin-commonjs":"^15.1.0","@rollup/plugin-json":"^4.1.0","@rollup/plugin-node-resolve":"^9.0.0","@zeainc/jsdocs2md":"^0.0.7",cypress:"^5.1.0","docsify-cli":"^4.4.1","es-dev-server":"^1.57.8",eslint:"^7.8.1","eslint-config-google":"^0.14.0","eslint-config-prettier":"^6.3.0","eslint-plugin-prettier":"^3.1.1","http-server":"^0.12.3",husky:"^4.3.0","ink-docstrap":"^1.3.2",jest:"^26.1.0","jest-coverage-badges":"^1.1.2","npm-run-all":"^4.1.5",plop:"^2.7.4",prettier:"^2.1.1",rollup:"^2.32.1","rollup-plugin-node-polyfills":"^0.2.1","rollup-plugin-svg":"^2.0.0","rollup-plugin-terser":"^7.0.2","rollup-plugin-web-worker-loader":"^1.3.0","standard-version":"^9.0.0"},husky:{hooks:{"pre-commit":"npm test","pre-push":"npm test"}}},i="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function s(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}var r=s,n=a;function o(e){if(r===setTimeout)return setTimeout(e,0);if((r===s||!r)&&setTimeout)return r=setTimeout,setTimeout(e,0);try{return r(e,0)}catch(t){try{return r.call(null,e,0)}catch(t){return r.call(this,e,0)}}}"function"==typeof i.setTimeout&&(r=setTimeout),"function"==typeof i.clearTimeout&&(n=clearTimeout);var l,h=[],d=!1,c=-1;function u(){d&&l&&(d=!1,l.length?h=l.concat(h):c=-1,h.length&&m())}function m(){if(!d){var e=o(u);d=!0;for(var t=h.length;t;){for(l=h,h=[];++c<t;)l&&l[c].run();c=-1,t=h.length}l=null,d=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===a||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function g(e,t){this.fun=e,this.array=t}g.prototype.run=function(){this.fun.apply(null,this.array)};function _(){}var f=_,p=_,y=_,G=_,X=_,x=_,I=_;var V=i.performance||{},v=V.now||V.mozNow||V.msNow||V.oNow||V.webkitNow||function(){return(new Date).getTime()};var R=new Date;var w={nextTick:function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];h.push(new g(e,t)),1!==h.length||d||o(m)},title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:f,addListener:p,once:y,off:G,removeListener:X,removeAllListeners:x,emit:I,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*v.call(V),i=Math.floor(t),s=Math.floor(t%1*1e9);return e&&(i-=e[0],(s-=e[1])<0&&(i--,s+=1e9)),[i,s]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-R)/1e3}};function M(e,t,i){return e(i={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&i.path)}},i.exports),i.exports}var T=1e3,L=60*T,S=60*L,Z=24*S,C=7*Z,F=365.25*Z,E=function(e,t){t=t||{};var i=typeof e;if("string"===i&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return;var i=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return i*F;case"weeks":case"week":case"w":return i*C;case"days":case"day":case"d":return i*Z;case"hours":case"hour":case"hrs":case"hr":case"h":return i*S;case"minutes":case"minute":case"mins":case"min":case"m":return i*L;case"seconds":case"second":case"secs":case"sec":case"s":return i*T;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return i;default:return}}(e);if("number"===i&&isFinite(e))return t.long?function(e){var t=Math.abs(e);if(t>=Z)return z(e,t,Z,"day");if(t>=S)return z(e,t,S,"hour");if(t>=L)return z(e,t,L,"minute");if(t>=T)return z(e,t,T,"second");return e+" ms"}(e):function(e){var t=Math.abs(e);if(t>=Z)return Math.round(e/Z)+"d";if(t>=S)return Math.round(e/S)+"h";if(t>=L)return Math.round(e/L)+"m";if(t>=T)return Math.round(e/T)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))};function z(e,t,i,s){var a=t>=1.5*i;return Math.round(e/i)+" "+s+(a?"s":"")}var N=function(e){function t(e){let s,a=null;function r(...e){if(!r.enabled)return;const i=r,a=Number(new Date),n=a-(s||a);i.diff=n,i.prev=s,i.curr=a,s=a,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let o=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((s,a)=>{if("%%"===s)return"%";o++;const r=t.formatters[a];if("function"==typeof r){const t=e[o];s=r.call(i,t),e.splice(o,1),o--}return s})),t.formatArgs.call(i,e);(i.log||t.log).apply(i,e)}return r.namespace=e,r.useColors=t.useColors(),r.color=t.selectColor(e),r.extend=i,r.destroy=t.destroy,Object.defineProperty(r,"enabled",{enumerable:!0,configurable:!1,get:()=>null===a?t.enabled(e):a,set:e=>{a=e}}),"function"==typeof t.init&&t.init(r),r}function i(e,i){const s=t(this.namespace+(void 0===i?":":i)+e);return s.log=this.log,s}function s(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},t.disable=function(){const e=[...t.names.map(s),...t.skips.map(s).map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=function(e){let i;t.save(e),t.names=[],t.skips=[];const s=("string"==typeof e?e:"").split(/[\s,]+/),a=s.length;for(i=0;i<a;i++)s[i]&&("-"===(e=s[i].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let i,s;for(i=0,s=t.skips.length;i<s;i++)if(t.skips[i].test(e))return!1;for(i=0,s=t.names.length;i<s;i++)if(t.names[i].test(e))return!0;return!1},t.humanize=E,t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((i=>{t[i]=e[i]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let i=0;for(let t=0;t<e.length;t++)i=(i<<5)-i+e.charCodeAt(t),i|=0;return t.colors[Math.abs(i)%t.colors.length]},t.enable(t.load()),t};const P=M((function(e,t){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const i="color: "+this.color;t.splice(1,0,i,"color: inherit");let s=0,a=0;t[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(s++,"%c"===e&&(a=s))})),t.splice(a,0,i)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}!e&&void 0!==w&&"env"in w&&(e=w.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=N(t);const{formatters:i}=e.exports;i.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}))("zea:engine");var W={SEMVER_SPEC_VERSION:"2.0.0",MAX_LENGTH:256,MAX_SAFE_INTEGER:Number.MAX_SAFE_INTEGER||9007199254740991,MAX_SAFE_COMPONENT_LENGTH:16};var B="object"==typeof w&&w.env&&w.env.NODE_DEBUG&&/\bsemver\b/i.test(w.env.NODE_DEBUG)?(...e)=>console.error("SEMVER",...e):()=>{},Y=M((function(e,t){const{MAX_SAFE_COMPONENT_LENGTH:i}=W,s=(t=e.exports={}).re=[],a=t.src=[],r=t.t={};let n=0;const o=(e,t,i)=>{const o=n++;B(o,t),r[e]=o,a[o]=t,s[o]=new RegExp(t,i?"g":void 0)};o("NUMERICIDENTIFIER","0|[1-9]\\d*"),o("NUMERICIDENTIFIERLOOSE","[0-9]+"),o("NONNUMERICIDENTIFIER","\\d*[a-zA-Z-][a-zA-Z0-9-]*"),o("MAINVERSION",`(${a[r.NUMERICIDENTIFIER]})\\.(${a[r.NUMERICIDENTIFIER]})\\.(${a[r.NUMERICIDENTIFIER]})`),o("MAINVERSIONLOOSE",`(${a[r.NUMERICIDENTIFIERLOOSE]})\\.(${a[r.NUMERICIDENTIFIERLOOSE]})\\.(${a[r.NUMERICIDENTIFIERLOOSE]})`),o("PRERELEASEIDENTIFIER",`(?:${a[r.NUMERICIDENTIFIER]}|${a[r.NONNUMERICIDENTIFIER]})`),o("PRERELEASEIDENTIFIERLOOSE",`(?:${a[r.NUMERICIDENTIFIERLOOSE]}|${a[r.NONNUMERICIDENTIFIER]})`),o("PRERELEASE",`(?:-(${a[r.PRERELEASEIDENTIFIER]}(?:\\.${a[r.PRERELEASEIDENTIFIER]})*))`),o("PRERELEASELOOSE",`(?:-?(${a[r.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${a[r.PRERELEASEIDENTIFIERLOOSE]})*))`),o("BUILDIDENTIFIER","[0-9A-Za-z-]+"),o("BUILD",`(?:\\+(${a[r.BUILDIDENTIFIER]}(?:\\.${a[r.BUILDIDENTIFIER]})*))`),o("FULLPLAIN",`v?${a[r.MAINVERSION]}${a[r.PRERELEASE]}?${a[r.BUILD]}?`),o("FULL",`^${a[r.FULLPLAIN]}$`),o("LOOSEPLAIN",`[v=\\s]*${a[r.MAINVERSIONLOOSE]}${a[r.PRERELEASELOOSE]}?${a[r.BUILD]}?`),o("LOOSE",`^${a[r.LOOSEPLAIN]}$`),o("GTLT","((?:<|>)?=?)"),o("XRANGEIDENTIFIERLOOSE",`${a[r.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),o("XRANGEIDENTIFIER",`${a[r.NUMERICIDENTIFIER]}|x|X|\\*`),o("XRANGEPLAIN",`[v=\\s]*(${a[r.XRANGEIDENTIFIER]})(?:\\.(${a[r.XRANGEIDENTIFIER]})(?:\\.(${a[r.XRANGEIDENTIFIER]})(?:${a[r.PRERELEASE]})?${a[r.BUILD]}?)?)?`),o("XRANGEPLAINLOOSE",`[v=\\s]*(${a[r.XRANGEIDENTIFIERLOOSE]})(?:\\.(${a[r.XRANGEIDENTIFIERLOOSE]})(?:\\.(${a[r.XRANGEIDENTIFIERLOOSE]})(?:${a[r.PRERELEASELOOSE]})?${a[r.BUILD]}?)?)?`),o("XRANGE",`^${a[r.GTLT]}\\s*${a[r.XRANGEPLAIN]}$`),o("XRANGELOOSE",`^${a[r.GTLT]}\\s*${a[r.XRANGEPLAINLOOSE]}$`),o("COERCE",`(^|[^\\d])(\\d{1,${i}})(?:\\.(\\d{1,${i}}))?(?:\\.(\\d{1,${i}}))?(?:$|[^\\d])`),o("COERCERTL",a[r.COERCE],!0),o("LONETILDE","(?:~>?)"),o("TILDETRIM",`(\\s*)${a[r.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",o("TILDE",`^${a[r.LONETILDE]}${a[r.XRANGEPLAIN]}$`),o("TILDELOOSE",`^${a[r.LONETILDE]}${a[r.XRANGEPLAINLOOSE]}$`),o("LONECARET","(?:\\^)"),o("CARETTRIM",`(\\s*)${a[r.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",o("CARET",`^${a[r.LONECARET]}${a[r.XRANGEPLAIN]}$`),o("CARETLOOSE",`^${a[r.LONECARET]}${a[r.XRANGEPLAINLOOSE]}$`),o("COMPARATORLOOSE",`^${a[r.GTLT]}\\s*(${a[r.LOOSEPLAIN]})$|^$`),o("COMPARATOR",`^${a[r.GTLT]}\\s*(${a[r.FULLPLAIN]})$|^$`),o("COMPARATORTRIM",`(\\s*)${a[r.GTLT]}\\s*(${a[r.LOOSEPLAIN]}|${a[r.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",o("HYPHENRANGE",`^\\s*(${a[r.XRANGEPLAIN]})\\s+-\\s+(${a[r.XRANGEPLAIN]})\\s*$`),o("HYPHENRANGELOOSE",`^\\s*(${a[r.XRANGEPLAINLOOSE]})\\s+-\\s+(${a[r.XRANGEPLAINLOOSE]})\\s*$`),o("STAR","(<|>)?=?\\s*\\*"),o("GTE0","^\\s*>=\\s*0.0.0\\s*$"),o("GTE0PRE","^\\s*>=\\s*0.0.0-0\\s*$")}));const A=["includePrerelease","loose","rtl"];var D=e=>e?"object"!=typeof e?{loose:!0}:A.filter((t=>e[t])).reduce(((e,t)=>(e[t]=!0,e)),{}):{};const k=/^[0-9]+$/,K=(e,t)=>{const i=k.test(e),s=k.test(t);return i&&s&&(e=+e,t=+t),e===t?0:i&&!s?-1:s&&!i?1:e<t?-1:1};var H={compareIdentifiers:K,rcompareIdentifiers:(e,t)=>K(t,e)};const{MAX_LENGTH:U,MAX_SAFE_INTEGER:O}=W,{re:J,t:Q}=Y,{compareIdentifiers:j}=H;class q{constructor(e,t){if(t=D(t),e instanceof q){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if("string"!=typeof e)throw new TypeError(`Invalid Version: ${e}`);if(e.length>U)throw new TypeError(`version is longer than ${U} characters`);B("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;const i=e.trim().match(t.loose?J[Q.LOOSE]:J[Q.FULL]);if(!i)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+i[1],this.minor=+i[2],this.patch=+i[3],this.major>O||this.major<0)throw new TypeError("Invalid major version");if(this.minor>O||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>O||this.patch<0)throw new TypeError("Invalid patch version");i[4]?this.prerelease=i[4].split(".").map((e=>{if(/^[0-9]+$/.test(e)){const t=+e;if(t>=0&&t<O)return t}return e})):this.prerelease=[],this.build=i[5]?i[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(B("SemVer.compare",this.version,this.options,e),!(e instanceof q)){if("string"==typeof e&&e===this.version)return 0;e=new q(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof q||(e=new q(e,this.options)),j(this.major,e.major)||j(this.minor,e.minor)||j(this.patch,e.patch)}comparePre(e){if(e instanceof q||(e=new q(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{const i=this.prerelease[t],s=e.prerelease[t];if(B("prerelease compare",t,i,s),void 0===i&&void 0===s)return 0;if(void 0===s)return 1;if(void 0===i)return-1;if(i!==s)return j(i,s)}while(++t)}compareBuild(e){e instanceof q||(e=new q(e,this.options));let t=0;do{const i=this.build[t],s=e.build[t];if(B("prerelease compare",t,i,s),void 0===i&&void 0===s)return 0;if(void 0===s)return 1;if(void 0===i)return-1;if(i!==s)return j(i,s)}while(++t)}inc(e,t){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t),this.inc("pre",t);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t),this.inc("pre",t);break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":if(0===this.prerelease.length)this.prerelease=[0];else{let e=this.prerelease.length;for(;--e>=0;)"number"==typeof this.prerelease[e]&&(this.prerelease[e]++,e=-2);-1===e&&this.prerelease.push(0)}t&&(this.prerelease[0]===t?isNaN(this.prerelease[1])&&(this.prerelease=[t,0]):this.prerelease=[t,0]);break;default:throw new Error(`invalid increment argument: ${e}`)}return this.format(),this.raw=this.version,this}}var $=q;const{MAX_LENGTH:ee}=W,{re:te,t:ie}=Y;var se=(e,t)=>{if(t=D(t),e instanceof $)return e;if("string"!=typeof e)return null;if(e.length>ee)return null;if(!(t.loose?te[ie.LOOSE]:te[ie.FULL]).test(e))return null;try{return new $(e,t)}catch(e){return null}};var ae=(e,t)=>{const i=se(e,t);return i?i.version:null};var re=(e,t)=>{const i=se(e.trim().replace(/^[=v]+/,""),t);return i?i.version:null};var ne=(e,t,i,s)=>{"string"==typeof i&&(s=i,i=void 0);try{return new $(e,i).inc(t,s).version}catch(e){return null}};var oe=(e,t,i)=>new $(e,i).compare(new $(t,i));var le=(e,t,i)=>0===oe(e,t,i);var he=(e,t)=>{if(le(e,t))return null;{const i=se(e),s=se(t),a=i.prerelease.length||s.prerelease.length,r=a?"pre":"",n=a?"prerelease":"";for(const e in i)if(("major"===e||"minor"===e||"patch"===e)&&i[e]!==s[e])return r+e;return n}};var de=(e,t)=>new $(e,t).major;var ce=(e,t)=>new $(e,t).minor;var ue=(e,t)=>new $(e,t).patch;var me=(e,t)=>{const i=se(e,t);return i&&i.prerelease.length?i.prerelease:null};var ge=(e,t,i)=>oe(t,e,i);var _e=(e,t)=>oe(e,t,!0);var fe=(e,t,i)=>{const s=new $(e,i),a=new $(t,i);return s.compare(a)||s.compareBuild(a)};var pe=(e,t)=>e.sort(((e,i)=>fe(e,i,t)));var be=(e,t)=>e.sort(((e,i)=>fe(i,e,t)));var ye=(e,t,i)=>oe(e,t,i)>0;var Ge=(e,t,i)=>oe(e,t,i)<0;var Xe=(e,t,i)=>0!==oe(e,t,i);var xe=(e,t,i)=>oe(e,t,i)>=0;var Ie=(e,t,i)=>oe(e,t,i)<=0;var Ve=(e,t,i,s)=>{switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof i&&(i=i.version),e===i;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof i&&(i=i.version),e!==i;case"":case"=":case"==":return le(e,i,s);case"!=":return Xe(e,i,s);case">":return ye(e,i,s);case">=":return xe(e,i,s);case"<":return Ge(e,i,s);case"<=":return Ie(e,i,s);default:throw new TypeError(`Invalid operator: ${t}`)}};const{re:ve,t:Re}=Y;var we=(e,t)=>{if(e instanceof $)return e;if("number"==typeof e&&(e=String(e)),"string"!=typeof e)return null;let i=null;if((t=t||{}).rtl){let t;for(;(t=ve[Re.COERCERTL].exec(e))&&(!i||i.index+i[0].length!==e.length);)i&&t.index+t[0].length===i.index+i[0].length||(i=t),ve[Re.COERCERTL].lastIndex=t.index+t[1].length+t[2].length;ve[Re.COERCERTL].lastIndex=-1}else i=e.match(ve[Re.COERCE]);return null===i?null:se(`${i[2]}.${i[3]||"0"}.${i[4]||"0"}`,t)},Me=Te;function Te(e){var t=this;if(t instanceof Te||(t=new Te),t.tail=null,t.head=null,t.length=0,e&&"function"==typeof e.forEach)e.forEach((function(e){t.push(e)}));else if(arguments.length>0)for(var i=0,s=arguments.length;i<s;i++)t.push(arguments[i]);return t}function Le(e,t,i){var s=t===e.head?new Ce(i,null,t,e):new Ce(i,t,t.next,e);return null===s.next&&(e.tail=s),null===s.prev&&(e.head=s),e.length++,s}function Se(e,t){e.tail=new Ce(t,e.tail,null,e),e.head||(e.head=e.tail),e.length++}function Ze(e,t){e.head=new Ce(t,null,e.head,e),e.tail||(e.tail=e.head),e.length++}function Ce(e,t,i,s){if(!(this instanceof Ce))return new Ce(e,t,i,s);this.list=s,this.value=e,t?(t.next=this,this.prev=t):this.prev=null,i?(i.prev=this,this.next=i):this.next=null}Te.Node=Ce,Te.create=Te,Te.prototype.removeNode=function(e){if(e.list!==this)throw new Error("removing node which does not belong to this list");var t=e.next,i=e.prev;return t&&(t.prev=i),i&&(i.next=t),e===this.head&&(this.head=t),e===this.tail&&(this.tail=i),e.list.length--,e.next=null,e.prev=null,e.list=null,t},Te.prototype.unshiftNode=function(e){if(e!==this.head){e.list&&e.list.removeNode(e);var t=this.head;e.list=this,e.next=t,t&&(t.prev=e),this.head=e,this.tail||(this.tail=e),this.length++}},Te.prototype.pushNode=function(e){if(e!==this.tail){e.list&&e.list.removeNode(e);var t=this.tail;e.list=this,e.prev=t,t&&(t.next=e),this.tail=e,this.head||(this.head=e),this.length++}},Te.prototype.push=function(){for(var e=0,t=arguments.length;e<t;e++)Se(this,arguments[e]);return this.length},Te.prototype.unshift=function(){for(var e=0,t=arguments.length;e<t;e++)Ze(this,arguments[e]);return this.length},Te.prototype.pop=function(){if(this.tail){var e=this.tail.value;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,e}},Te.prototype.shift=function(){if(this.head){var e=this.head.value;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,e}},Te.prototype.forEach=function(e,t){t=t||this;for(var i=this.head,s=0;null!==i;s++)e.call(t,i.value,s,this),i=i.next},Te.prototype.forEachReverse=function(e,t){t=t||this;for(var i=this.tail,s=this.length-1;null!==i;s--)e.call(t,i.value,s,this),i=i.prev},Te.prototype.get=function(e){for(var t=0,i=this.head;null!==i&&t<e;t++)i=i.next;if(t===e&&null!==i)return i.value},Te.prototype.getReverse=function(e){for(var t=0,i=this.tail;null!==i&&t<e;t++)i=i.prev;if(t===e&&null!==i)return i.value},Te.prototype.map=function(e,t){t=t||this;for(var i=new Te,s=this.head;null!==s;)i.push(e.call(t,s.value,this)),s=s.next;return i},Te.prototype.mapReverse=function(e,t){t=t||this;for(var i=new Te,s=this.tail;null!==s;)i.push(e.call(t,s.value,this)),s=s.prev;return i},Te.prototype.reduce=function(e,t){var i,s=this.head;if(arguments.length>1)i=t;else{if(!this.head)throw new TypeError("Reduce of empty list with no initial value");s=this.head.next,i=this.head.value}for(var a=0;null!==s;a++)i=e(i,s.value,a),s=s.next;return i},Te.prototype.reduceReverse=function(e,t){var i,s=this.tail;if(arguments.length>1)i=t;else{if(!this.tail)throw new TypeError("Reduce of empty list with no initial value");s=this.tail.prev,i=this.tail.value}for(var a=this.length-1;null!==s;a--)i=e(i,s.value,a),s=s.prev;return i},Te.prototype.toArray=function(){for(var e=new Array(this.length),t=0,i=this.head;null!==i;t++)e[t]=i.value,i=i.next;return e},Te.prototype.toArrayReverse=function(){for(var e=new Array(this.length),t=0,i=this.tail;null!==i;t++)e[t]=i.value,i=i.prev;return e},Te.prototype.slice=function(e,t){(t=t||this.length)<0&&(t+=this.length),(e=e||0)<0&&(e+=this.length);var i=new Te;if(t<e||t<0)return i;e<0&&(e=0),t>this.length&&(t=this.length);for(var s=0,a=this.head;null!==a&&s<e;s++)a=a.next;for(;null!==a&&s<t;s++,a=a.next)i.push(a.value);return i},Te.prototype.sliceReverse=function(e,t){(t=t||this.length)<0&&(t+=this.length),(e=e||0)<0&&(e+=this.length);var i=new Te;if(t<e||t<0)return i;e<0&&(e=0),t>this.length&&(t=this.length);for(var s=this.length,a=this.tail;null!==a&&s>t;s--)a=a.prev;for(;null!==a&&s>e;s--,a=a.prev)i.push(a.value);return i},Te.prototype.splice=function(e,t,...i){e>this.length&&(e=this.length-1),e<0&&(e=this.length+e);for(var s=0,a=this.head;null!==a&&s<e;s++)a=a.next;var r=[];for(s=0;a&&s<t;s++)r.push(a.value),a=this.removeNode(a);null===a&&(a=this.tail),a!==this.head&&a!==this.tail&&(a=a.prev);for(s=0;s<i.length;s++)a=Le(this,a,i[s]);return r},Te.prototype.reverse=function(){for(var e=this.head,t=this.tail,i=e;null!==i;i=i.prev){var s=i.prev;i.prev=i.next,i.next=s}return this.head=t,this.tail=e,this};try{!function(e){e.prototype[Symbol.iterator]=function*(){for(let e=this.head;e;e=e.next)yield e.value}}(Te)}catch(e){}const Fe=Symbol("max"),Ee=Symbol("length"),ze=Symbol("lengthCalculator"),Ne=Symbol("allowStale"),Pe=Symbol("maxAge"),We=Symbol("dispose"),Be=Symbol("noDisposeOnSet"),Ye=Symbol("lruList"),Ae=Symbol("cache"),De=Symbol("updateAgeOnGet"),ke=()=>1;const Ke=(e,t,i)=>{const s=e[Ae].get(t);if(s){const t=s.value;if(He(e,t)){if(Oe(e,s),!e[Ne])return}else i&&(e[De]&&(s.value.now=Date.now()),e[Ye].unshiftNode(s));return t.value}},He=(e,t)=>{if(!t||!t.maxAge&&!e[Pe])return!1;const i=Date.now()-t.now;return t.maxAge?i>t.maxAge:e[Pe]&&i>e[Pe]},Ue=e=>{if(e[Ee]>e[Fe])for(let t=e[Ye].tail;e[Ee]>e[Fe]&&null!==t;){const i=t.prev;Oe(e,t),t=i}},Oe=(e,t)=>{if(t){const i=t.value;e[We]&&e[We](i.key,i.value),e[Ee]-=i.length,e[Ae].delete(i.key),e[Ye].removeNode(t)}};class Je{constructor(e,t,i,s,a){this.key=e,this.value=t,this.length=i,this.now=s,this.maxAge=a||0}}const Qe=(e,t,i,s)=>{let a=i.value;He(e,a)&&(Oe(e,i),e[Ne]||(a=void 0)),a&&t.call(s,a.value,a.key,e)};var je=class{constructor(e){if("number"==typeof e&&(e={max:e}),e||(e={}),e.max&&("number"!=typeof e.max||e.max<0))throw new TypeError("max must be a non-negative number");this[Fe]=e.max||1/0;const t=e.length||ke;if(this[ze]="function"!=typeof t?ke:t,this[Ne]=e.stale||!1,e.maxAge&&"number"!=typeof e.maxAge)throw new TypeError("maxAge must be a number");this[Pe]=e.maxAge||0,this[We]=e.dispose,this[Be]=e.noDisposeOnSet||!1,this[De]=e.updateAgeOnGet||!1,this.reset()}set max(e){if("number"!=typeof e||e<0)throw new TypeError("max must be a non-negative number");this[Fe]=e||1/0,Ue(this)}get max(){return this[Fe]}set allowStale(e){this[Ne]=!!e}get allowStale(){return this[Ne]}set maxAge(e){if("number"!=typeof e)throw new TypeError("maxAge must be a non-negative number");this[Pe]=e,Ue(this)}get maxAge(){return this[Pe]}set lengthCalculator(e){"function"!=typeof e&&(e=ke),e!==this[ze]&&(this[ze]=e,this[Ee]=0,this[Ye].forEach((e=>{e.length=this[ze](e.value,e.key),this[Ee]+=e.length}))),Ue(this)}get lengthCalculator(){return this[ze]}get length(){return this[Ee]}get itemCount(){return this[Ye].length}rforEach(e,t){t=t||this;for(let i=this[Ye].tail;null!==i;){const s=i.prev;Qe(this,e,i,t),i=s}}forEach(e,t){t=t||this;for(let i=this[Ye].head;null!==i;){const s=i.next;Qe(this,e,i,t),i=s}}keys(){return this[Ye].toArray().map((e=>e.key))}values(){return this[Ye].toArray().map((e=>e.value))}reset(){this[We]&&this[Ye]&&this[Ye].length&&this[Ye].forEach((e=>this[We](e.key,e.value))),this[Ae]=new Map,this[Ye]=new Me,this[Ee]=0}dump(){return this[Ye].map((e=>!He(this,e)&&{k:e.key,v:e.value,e:e.now+(e.maxAge||0)})).toArray().filter((e=>e))}dumpLru(){return this[Ye]}set(e,t,i){if((i=i||this[Pe])&&"number"!=typeof i)throw new TypeError("maxAge must be a number");const s=i?Date.now():0,a=this[ze](t,e);if(this[Ae].has(e)){if(a>this[Fe])return Oe(this,this[Ae].get(e)),!1;const r=this[Ae].get(e).value;return this[We]&&(this[Be]||this[We](e,r.value)),r.now=s,r.maxAge=i,r.value=t,this[Ee]+=a-r.length,r.length=a,this.get(e),Ue(this),!0}const r=new Je(e,t,a,s,i);return r.length>this[Fe]?(this[We]&&this[We](e,t),!1):(this[Ee]+=r.length,this[Ye].unshift(r),this[Ae].set(e,this[Ye].head),Ue(this),!0)}has(e){if(!this[Ae].has(e))return!1;const t=this[Ae].get(e).value;return!He(this,t)}get(e){return Ke(this,e,!0)}peek(e){return Ke(this,e,!1)}pop(){const e=this[Ye].tail;return e?(Oe(this,e),e.value):null}del(e){Oe(this,this[Ae].get(e))}load(e){this.reset();const t=Date.now();for(let i=e.length-1;i>=0;i--){const s=e[i],a=s.e||0;if(0===a)this.set(s.k,s.v);else{const e=a-t;e>0&&this.set(s.k,s.v,e)}}}prune(){this[Ae].forEach(((e,t)=>Ke(this,t,!1)))}};class qe{constructor(e,t){if(t=D(t),e instanceof qe)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new qe(e.raw,t);if(e instanceof Vt)return this.raw=e.value,this.set=[[e]],this.format(),this;if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e,this.set=e.split(/\s*\|\|\s*/).map((e=>this.parseRange(e.trim()))).filter((e=>e.length)),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${e}`);if(this.set.length>1){const e=this.set[0];if(this.set=this.set.filter((e=>!ot(e[0]))),0===this.set.length)this.set=[e];else if(this.set.length>1)for(const e of this.set)if(1===e.length&&lt(e[0])){this.set=[e];break}}this.format()}format(){return this.range=this.set.map((e=>e.join(" ").trim())).join("||").trim(),this.range}toString(){return this.range}parseRange(e){e=e.trim();const t=`parseRange:${Object.keys(this.options).join(",")}:${e}`,i=et.get(t);if(i)return i;const s=this.options.loose,a=s?tt[it.HYPHENRANGELOOSE]:tt[it.HYPHENRANGE];e=e.replace(a,Gt(this.options.includePrerelease)),B("hyphen replace",e),e=e.replace(tt[it.COMPARATORTRIM],st),B("comparator trim",e,tt[it.COMPARATORTRIM]),e=(e=(e=e.replace(tt[it.TILDETRIM],rt)).replace(tt[it.CARETTRIM],nt)).split(/\s+/).join(" ");const r=s?tt[it.COMPARATORLOOSE]:tt[it.COMPARATOR],n=e.split(" ").map((e=>dt(e,this.options))).join(" ").split(/\s+/).map((e=>yt(e,this.options))).filter(this.options.loose?e=>!!e.match(r):()=>!0).map((e=>new Vt(e,this.options)));n.length;const o=new Map;for(const e of n){if(ot(e))return[e];o.set(e.value,e)}o.size>1&&o.has("")&&o.delete("");const l=[...o.values()];return et.set(t,l),l}intersects(e,t){if(!(e instanceof qe))throw new TypeError("a Range is required");return this.set.some((i=>ht(i,t)&&e.set.some((e=>ht(e,t)&&i.every((i=>e.every((e=>i.intersects(e,t)))))))))}test(e){if(!e)return!1;if("string"==typeof e)try{e=new $(e,this.options)}catch(e){return!1}for(let t=0;t<this.set.length;t++)if(Xt(this.set[t],e,this.options))return!0;return!1}}var $e=qe;const et=new je({max:1e3}),{re:tt,t:it,comparatorTrimReplace:st,tildeTrimReplace:rt,caretTrimReplace:nt}=Y,ot=e=>"<0.0.0-0"===e.value,lt=e=>""===e.value,ht=(e,t)=>{let i=!0;const s=e.slice();let a=s.pop();for(;i&&s.length;)i=s.every((e=>a.intersects(e,t))),a=s.pop();return i},dt=(e,t)=>(B("comp",e,t),e=gt(e,t),B("caret",e),e=ut(e,t),B("tildes",e),e=ft(e,t),B("xrange",e),e=bt(e,t),B("stars",e),e),ct=e=>!e||"x"===e.toLowerCase()||"*"===e,ut=(e,t)=>e.trim().split(/\s+/).map((e=>mt(e,t))).join(" "),mt=(e,t)=>{const i=t.loose?tt[it.TILDELOOSE]:tt[it.TILDE];return e.replace(i,((t,i,s,a,r)=>{let n;return B("tilde",e,t,i,s,a,r),ct(i)?n="":ct(s)?n=`>=${i}.0.0 <${+i+1}.0.0-0`:ct(a)?n=`>=${i}.${s}.0 <${i}.${+s+1}.0-0`:r?(B("replaceTilde pr",r),n=`>=${i}.${s}.${a}-${r} <${i}.${+s+1}.0-0`):n=`>=${i}.${s}.${a} <${i}.${+s+1}.0-0`,B("tilde return",n),n}))},gt=(e,t)=>e.trim().split(/\s+/).map((e=>_t(e,t))).join(" "),_t=(e,t)=>{B("caret",e,t);const i=t.loose?tt[it.CARETLOOSE]:tt[it.CARET],s=t.includePrerelease?"-0":"";return e.replace(i,((t,i,a,r,n)=>{let o;return B("caret",e,t,i,a,r,n),ct(i)?o="":ct(a)?o=`>=${i}.0.0${s} <${+i+1}.0.0-0`:ct(r)?o="0"===i?`>=${i}.${a}.0${s} <${i}.${+a+1}.0-0`:`>=${i}.${a}.0${s} <${+i+1}.0.0-0`:n?(B("replaceCaret pr",n),o="0"===i?"0"===a?`>=${i}.${a}.${r}-${n} <${i}.${a}.${+r+1}-0`:`>=${i}.${a}.${r}-${n} <${i}.${+a+1}.0-0`:`>=${i}.${a}.${r}-${n} <${+i+1}.0.0-0`):(B("no pr"),o="0"===i?"0"===a?`>=${i}.${a}.${r}${s} <${i}.${a}.${+r+1}-0`:`>=${i}.${a}.${r}${s} <${i}.${+a+1}.0-0`:`>=${i}.${a}.${r} <${+i+1}.0.0-0`),B("caret return",o),o}))},ft=(e,t)=>(B("replaceXRanges",e,t),e.split(/\s+/).map((e=>pt(e,t))).join(" ")),pt=(e,t)=>{e=e.trim();const i=t.loose?tt[it.XRANGELOOSE]:tt[it.XRANGE];return e.replace(i,((i,s,a,r,n,o)=>{B("xRange",e,i,s,a,r,n,o);const l=ct(a),h=l||ct(r),d=h||ct(n),c=d;return"="===s&&c&&(s=""),o=t.includePrerelease?"-0":"",l?i=">"===s||"<"===s?"<0.0.0-0":"*":s&&c?(h&&(r=0),n=0,">"===s?(s=">=",h?(a=+a+1,r=0,n=0):(r=+r+1,n=0)):"<="===s&&(s="<",h?a=+a+1:r=+r+1),"<"===s&&(o="-0"),i=`${s+a}.${r}.${n}${o}`):h?i=`>=${a}.0.0${o} <${+a+1}.0.0-0`:d&&(i=`>=${a}.${r}.0${o} <${a}.${+r+1}.0-0`),B("xRange return",i),i}))},bt=(e,t)=>(B("replaceStars",e,t),e.trim().replace(tt[it.STAR],"")),yt=(e,t)=>(B("replaceGTE0",e,t),e.trim().replace(tt[t.includePrerelease?it.GTE0PRE:it.GTE0],"")),Gt=e=>(t,i,s,a,r,n,o,l,h,d,c,u,m)=>`${i=ct(s)?"":ct(a)?`>=${s}.0.0${e?"-0":""}`:ct(r)?`>=${s}.${a}.0${e?"-0":""}`:n?`>=${i}`:`>=${i}${e?"-0":""}`} ${l=ct(h)?"":ct(d)?`<${+h+1}.0.0-0`:ct(c)?`<${h}.${+d+1}.0-0`:u?`<=${h}.${d}.${c}-${u}`:e?`<${h}.${d}.${+c+1}-0`:`<=${l}`}`.trim(),Xt=(e,t,i)=>{for(let i=0;i<e.length;i++)if(!e[i].test(t))return!1;if(t.prerelease.length&&!i.includePrerelease){for(let i=0;i<e.length;i++)if(B(e[i].semver),e[i].semver!==Vt.ANY&&e[i].semver.prerelease.length>0){const s=e[i].semver;if(s.major===t.major&&s.minor===t.minor&&s.patch===t.patch)return!0}return!1}return!0},xt=Symbol("SemVer ANY");class It{static get ANY(){return xt}constructor(e,t){if(t=D(t),e instanceof It){if(e.loose===!!t.loose)return e;e=e.value}B("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.semver===xt?this.value="":this.value=this.operator+this.semver.version,B("comp",this)}parse(e){const t=this.options.loose?vt[Rt.COMPARATORLOOSE]:vt[Rt.COMPARATOR],i=e.match(t);if(!i)throw new TypeError(`Invalid comparator: ${e}`);this.operator=void 0!==i[1]?i[1]:"","="===this.operator&&(this.operator=""),i[2]?this.semver=new $(i[2],this.options.loose):this.semver=xt}toString(){return this.value}test(e){if(B("Comparator.test",e,this.options.loose),this.semver===xt||e===xt)return!0;if("string"==typeof e)try{e=new $(e,this.options)}catch(e){return!1}return Ve(e,this.operator,this.semver,this.options)}intersects(e,t){if(!(e instanceof It))throw new TypeError("a Comparator is required");if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),""===this.operator)return""===this.value||new $e(e.value,t).test(this.value);if(""===e.operator)return""===e.value||new $e(this.value,t).test(e.semver);const i=!(">="!==this.operator&&">"!==this.operator||">="!==e.operator&&">"!==e.operator),s=!("<="!==this.operator&&"<"!==this.operator||"<="!==e.operator&&"<"!==e.operator),a=this.semver.version===e.semver.version,r=!(">="!==this.operator&&"<="!==this.operator||">="!==e.operator&&"<="!==e.operator),n=Ve(this.semver,"<",e.semver,t)&&(">="===this.operator||">"===this.operator)&&("<="===e.operator||"<"===e.operator),o=Ve(this.semver,">",e.semver,t)&&("<="===this.operator||"<"===this.operator)&&(">="===e.operator||">"===e.operator);return i||s||a&&r||n||o}}var Vt=It;const{re:vt,t:Rt}=Y;var wt=(e,t,i)=>{try{t=new $e(t,i)}catch(e){return!1}return t.test(e)};var Mt=(e,t)=>new $e(e,t).set.map((e=>e.map((e=>e.value)).join(" ").trim().split(" ")));var Tt=(e,t,i)=>{let s=null,a=null,r=null;try{r=new $e(t,i)}catch(e){return null}return e.forEach((e=>{r.test(e)&&(s&&-1!==a.compare(e)||(s=e,a=new $(s,i)))})),s};var Lt=(e,t,i)=>{let s=null,a=null,r=null;try{r=new $e(t,i)}catch(e){return null}return e.forEach((e=>{r.test(e)&&(s&&1!==a.compare(e)||(s=e,a=new $(s,i)))})),s};var St=(e,t)=>{e=new $e(e,t);let i=new $("0.0.0");if(e.test(i))return i;if(i=new $("0.0.0-0"),e.test(i))return i;i=null;for(let t=0;t<e.set.length;++t){const s=e.set[t];let a=null;s.forEach((e=>{const t=new $(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":a&&!ye(t,a)||(a=t);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${e.operator}`)}})),!a||i&&!ye(i,a)||(i=a)}return i&&e.test(i)?i:null};var Zt=(e,t)=>{try{return new $e(e,t).range||"*"}catch(e){return null}};const{ANY:Ct}=Vt;var Ft=(e,t,i,s)=>{let a,r,n,o,l;switch(e=new $(e,s),t=new $e(t,s),i){case">":a=ye,r=Ie,n=Ge,o=">",l=">=";break;case"<":a=Ge,r=xe,n=ye,o="<",l="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(wt(e,t,s))return!1;for(let i=0;i<t.set.length;++i){const h=t.set[i];let d=null,c=null;if(h.forEach((e=>{e.semver===Ct&&(e=new Vt(">=0.0.0")),d=d||e,c=c||e,a(e.semver,d.semver,s)?d=e:n(e.semver,c.semver,s)&&(c=e)})),d.operator===o||d.operator===l)return!1;if((!c.operator||c.operator===o)&&r(e,c.semver))return!1;if(c.operator===l&&n(e,c.semver))return!1}return!0};var Et=(e,t,i)=>Ft(e,t,">",i);var zt=(e,t,i)=>Ft(e,t,"<",i);var Nt=(e,t,i)=>(e=new $e(e,i),t=new $e(t,i),e.intersects(t));const{ANY:Pt}=Vt,Wt=(e,t,i)=>{if(e===t)return!0;if(1===e.length&&e[0].semver===Pt){if(1===t.length&&t[0].semver===Pt)return!0;e=i.includePrerelease?[new Vt(">=0.0.0-0")]:[new Vt(">=0.0.0")]}if(1===t.length&&t[0].semver===Pt){if(i.includePrerelease)return!0;t=[new Vt(">=0.0.0")]}const s=new Set;let a,r,n,o,l,h,d;for(const t of e)">"===t.operator||">="===t.operator?a=Bt(a,t,i):"<"===t.operator||"<="===t.operator?r=Yt(r,t,i):s.add(t.semver);if(s.size>1)return null;if(a&&r){if(n=oe(a.semver,r.semver,i),n>0)return null;if(0===n&&(">="!==a.operator||"<="!==r.operator))return null}for(const e of s){if(a&&!wt(e,String(a),i))return null;if(r&&!wt(e,String(r),i))return null;for(const s of t)if(!wt(e,String(s),i))return!1;return!0}let c=!(!r||i.includePrerelease||!r.semver.prerelease.length)&&r.semver,u=!(!a||i.includePrerelease||!a.semver.prerelease.length)&&a.semver;c&&1===c.prerelease.length&&"<"===r.operator&&0===c.prerelease[0]&&(c=!1);for(const e of t){if(d=d||">"===e.operator||">="===e.operator,h=h||"<"===e.operator||"<="===e.operator,a)if(u&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===u.major&&e.semver.minor===u.minor&&e.semver.patch===u.patch&&(u=!1),">"===e.operator||">="===e.operator){if(o=Bt(a,e,i),o===e&&o!==a)return!1}else if(">="===a.operator&&!wt(a.semver,String(e),i))return!1;if(r)if(c&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===c.major&&e.semver.minor===c.minor&&e.semver.patch===c.patch&&(c=!1),"<"===e.operator||"<="===e.operator){if(l=Yt(r,e,i),l===e&&l!==r)return!1}else if("<="===r.operator&&!wt(r.semver,String(e),i))return!1;if(!e.operator&&(r||a)&&0!==n)return!1}return!(a&&h&&!r&&0!==n)&&(!(r&&d&&!a&&0!==n)&&(!u&&!c))},Bt=(e,t,i)=>{if(!e)return t;const s=oe(e.semver,t.semver,i);return s>0?e:s<0||">"===t.operator&&">="===e.operator?t:e},Yt=(e,t,i)=>{if(!e)return t;const s=oe(e.semver,t.semver,i);return s<0?e:s>0||"<"===t.operator&&"<="===e.operator?t:e};var At=(e,t,i={})=>{if(e===t)return!0;e=new $e(e,i),t=new $e(t,i);let s=!1;e:for(const a of e.set){for(const e of t.set){const t=Wt(a,e,i);if(s=s||null!==t,t)continue e}if(s)return!1}return!0},Dt={re:Y.re,src:Y.src,tokens:Y.t,SEMVER_SPEC_VERSION:W.SEMVER_SPEC_VERSION,SemVer:$,compareIdentifiers:H.compareIdentifiers,rcompareIdentifiers:H.rcompareIdentifiers,parse:se,valid:ae,clean:re,inc:ne,diff:he,major:de,minor:ce,patch:ue,prerelease:me,compare:oe,rcompare:ge,compareLoose:_e,compareBuild:fe,sort:pe,rsort:be,gt:ye,lt:Ge,eq:le,neq:Xe,gte:xe,lte:Ie,cmp:Ve,coerce:we,Comparator:Vt,Range:$e,satisfies:wt,toComparators:Mt,maxSatisfying:Tt,minSatisfying:Lt,minVersion:St,validRange:Zt,outside:Ft,gtr:Et,ltr:zt,intersects:Nt,simplifyRange:(e,t,i)=>{const s=[];let a=null,r=null;const n=e.sort(((e,t)=>oe(e,t,i)));for(const e of n){wt(e,t,i)?(r=e,a||(a=e)):(r&&s.push([a,r]),r=null,a=null)}a&&s.push([a,null]);const o=[];for(const[e,t]of s)e===t?o.push(e):t||e!==n[0]?t?e===n[0]?o.push(`<=${t}`):o.push(`${e} - ${t}`):o.push(`>=${e}`):o.push("*");const l=o.join(" || "),h="string"==typeof t.raw?t.raw:String(t);return l.length<h.length?l:t},subset:At};const kt="/dist/",Kt=()=>"undefined"!=typeof window&&void 0!==window.document,Ht=()=>Kt()&&window.navigator.userAgent.includes("jsdom"),Ut={baseUrl:(()=>{if(Kt()&&!Ht()){const e=document.currentScript.src;return e.substring(0,e.lastIndexOf(kt))+kt}return"https://cdn.jsdelivr.net/npm/@zeainc/zea-engine/dist/"})(),isBrowser:Kt(),isJsDom:Ht(),isNodeJs:"object"==typeof module&&"object"==typeof module.exports};let Ot=0;class Jt{constructor(){this.listeners={},this.__id=++Ot}getId(){return this.__id}on(e,t){if(!t)throw new Error("Missing listener.");this.listeners[e]||(this.listeners[e]=[]);const i=this.listeners[e];if(i.includes(t))throw new Error(`Listener "${t.name}" already connected to event "${e}".`);const s=i.length;return i[s]=t,s}once(e,t){const i=s=>{t(s),this.off(e,i)};this.on(e,i)}off(e,t){if(!t)throw new Error("Missing callback function (listener).");if("number"==typeof t)return console.warn("Deprecated. Un-register using the original listener instead."),void this.removeListenerById(e,t);const i=this.listeners[e]||[],s=[];if(i.forEach(((e,i)=>{e===t&&s.push(i)})),0==s.length)throw new Error(`Listener "${t.name}" is not connected to "${e}" event`);for(const e of s)i[e]=void 0}addListener(e,t){return console.warn("Deprecated. Use #on instead."),this.on(e,t)}removeListener(e,t){console.warn("Deprecated. Use #off instead."),this.off(e,t)}removeListenerById(e,t){console.warn("Deprecated. Use #off, passing the listener itself instead of the id.");const i=this.listeners[e];if(i){if(!i[t])throw new Error("Invalid ID");i[t]=void 0}else console.warn("callback :"+t+" was not connected to this signal:"+e)}emit(e,t){(this.listeners[e]||[]).forEach((e=>{e&&e(t)}))}}class Qt extends Jt{constructor(e=0,t=0){super(),this.root={x:0,y:0,w:e,h:t}}fit(e){if(0==e.length)return;let t=!1;this.root.w<e[0].w&&(this.root.w=e[0].w,t=!0),this.root.h<e[0].h&&(this.root.h=e[0].h,t=!0),t&&this.emit("resized",{width:this.root.w,height:this.root.h});e.forEach((e=>{e.fit=this.__addBlock(e)}))}__addBlock(e){const t=this.findNode(this.root,e.w,e.h);return t?this.splitNode(t,e.w,e.h):this.growNode(e.w,e.h)}addBlock(e){let t=!1;this.root.w<e.w&&(this.root.w=e.w,t=!0),this.root.h<e.h&&(this.root.h=e.h,t=!0),t&&this.emit("resized",{width:this.root.w,height:this.root.h});const i=this.findNode(this.root,e.w,e.h);return i?this.splitNode(i,e.w,e.h):this.growNode(e.w,e.h)}findNode(e,t,i){return e.used?this.findNode(e.right,t,i)||this.findNode(e.down,t,i):t<=e.w&&i<=e.h?e:null}splitNode(e,t,i){return e.used=!0,e.down={x:e.x,y:e.y+i,w:e.w,h:e.h-i},e.right={x:e.x+t,y:e.y,w:e.w-t,h:i},e}growNode(e,t){const i=e<=this.root.w,s=t<=this.root.h,a=s&&this.root.h>=this.root.w+e,r=i&&this.root.w>=this.root.h+t;return a?this.growRight(e,t):r?this.growDown(e,t):s?this.growRight(e,t):i?this.growDown(e,t):null}growRight(e,t){this.root={used:!0,x:0,y:0,w:this.root.w+e,h:this.root.h,down:this.root,right:{x:this.root.w,y:0,w:e,h:this.root.h}};const i=this.findNode(this.root,e,t);let s;return i&&(s=this.splitNode(i,e,t)),this.emit("resized",{width:this.root.w,height:this.root.h}),s}growDown(e,t){this.root={used:!0,x:0,y:0,w:this.root.w,h:this.root.h+t,down:{x:0,y:this.root.h,w:this.root.w,h:t},right:this.root};const i=this.findNode(this.root,e,t);let s;return i&&(s=this.splitNode(i,e,t)),this.emit("resized",{width:this.root.w,height:this.root.h}),s}}class jt{static radToDeg(e){return e/(Math.PI/180)}static degToRad(e){return e*(Math.PI/180)}static isNumeric(e){return!isNaN(parseFloat(e))&&isFinite(e)}static randomInt(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e}static lerp(e,t,i){return e+i*(t-e)}static clamp(e,t,i){return Math.min(Math.max(e,t),i)}static nearestPow2(e){return Math.pow(2,Math.round(Math.log(e)/Math.log(2)))}static nearestPow10(e){return Math.pow(10,Math.round(Math.log10(e)/Math.log10(10)))}static nextPow2(e){if(0==this.fract(Math.log2(e)))return e;let t=0;for(;e>0;)t++,e>>=1;return 1<<t}static fract(e){return 0==e?0:e<0?e>-1?-e:-e%Math.floor(-e):e<1?e:e%Math.floor(e)}static remap(e,t,i,s,a){return s+(e-t)/(i-t)*(a-s)}static smoothStep(e,t,i){const s=this.clamp((i-e)/(t-e),0,1);return s*s*(3-2*s)}static linStep(e,t,i){return this.clamp((i-e)/(t-e),0,1)}static decode16BitFloatFrom2xUInt8(e){const t=e[0],i=(120&t)>>3;let s=0==i?0:2048;const a=s+((7&t)<<8)+e[1];s=0==i?1:0;return(128&t?1:-1)*a*Math.pow(2,i+s-16)}static encode16BitFloatInto2xUInt8(e){const t=new Uint8Array(2),i=e>=0?128:0;e=Math.abs(e);let s,a=15,r=1024;for(let t=15;t>0;t--)e<r&&(r/=2,a--);s=0==a?e/r/2:(e-r)/r;const n=Math.round(2048*s),o=n/256,l=n-256*o;return t[0]=i+8*a+o,t[1]=l,e>=2048&&(t[0]=255),t}static encode16BitFloat(e){const t=new Float32Array(1);t[0]=e;return(e=>{let t=e>>16&32768,i=e>>12&2047;const s=e>>23&255;return s<103?t:s>142?(t|=31744,t|=(255==s?0:1)&&8388607&e,t):s<113?(i|=2048,t|=(i>>114-s)+(i>>113-s&1),t):(t|=s-112<<10|i>>1,t+=1&i,t)})(new Int32Array(t.buffer)[0])}static decode16BitFloat(e){const t=(32768&e)>>15,i=(31744&e)>>10,s=1023&e;return 0==i?(t?-1:1)*Math.pow(2,-14)*(s/Math.pow(2,10)):31==i?s?NaN:1/0*(t?-1:1):(t?-1:1)*Math.pow(2,i-15)*(1+s/Math.pow(2,10))}static convertFloat32ArrayToUInt16Array(e){const t=new Uint16Array(e.length),i=new Int32Array(e.buffer),s=e=>{let t=e>>16&32768,i=e>>12&2047;const s=e>>23&255;return s<103?t:s>142?(t|=31744,t|=(255==s?0:1)&&8388607&e,t):s<113?(i|=2048,t|=(i>>114-s)+(i>>113-s&1),t):(t|=s-112<<10|i>>1,t+=1&i,t)};for(let a=0;a<e.length;a++)t[a]=s(i[a]);return t}}class qt{constructor(e=0,t=0){this.start=e,this.size=t}}class $t extends Jt{constructor(){super(),this.freeList=[],this.allocations=[],this.allocationsMap={},this.allocatedSpace=0,this.reservedSpace=0,this.freeSpace=0}getAllocation(e){return this.allocations[this.allocationsMap[e]]}allocate(e,t){if(null!=this.allocationsMap[e]){const i=this.allocationsMap[e],s=this.allocations[i];if(t==s.size)return s;if(t<s.size){const e=s.size-t;return this.addBlock(i+1,new qt(s.start+t,e)),this.freeBlock(i+1),s.size=t,s}{const a=i+1;if(this.freeList.includes(a)&&s.size+this.allocations[a].size>=t){const e=this.allocations[a];if(s.size+e.size==t)return s.size+=e.size,this.freeSpace-=e.size,this.freeList.splice(this.freeList.indexOf(a),1),this.removeBlock(a),s;{const i=t-s.size;return s.size+=i,this.freeSpace-=i,e.start+=i,e.size-=i,s}}delete this.allocationsMap[e],s.start+s.size==this.allocatedSpace?(this.removeBlock(i),this.allocatedSpace-=s.size):this.freeBlock(i)}}let i=-1;for(let e=0;e<this.freeList.length;e++){const s=this.freeList[e],a=this.allocations[s];if(a.size==t){i=s;break}a.size>t&&(i=s)}if(-1!=i){const s=this.allocations[i];if(this.freeSpace-=s.size,this.freeList.splice(this.freeList.indexOf(i),1),s.size>t){const e=s.size-t;this.addBlock(i+1,new qt(s.start+t,e)),this.freeBlock(i+1),this.freeList.sort(((e,t)=>this.allocations[e].size<this.allocations[t].size)),this.allocations[i].size=t}this.allocationsMap[e]=i}else{const i=this.allocatedSpace,s=this.allocations.length;this.allocatedSpace+=t;const a=jt.nextPow2(this.allocatedSpace);a!=this.reservedSpace&&(this.reservedSpace=a,this.emit("resized",{reservedSpace:this.reservedSpace})),this.allocations.push(new qt(i,t)),this.allocationsMap[e]=s}return this.allocations[this.allocationsMap[e]]}addBlock(e,t){this.allocations.splice(e,0,t);for(const t in this.allocationsMap)this.allocationsMap[t]>=e&&this.allocationsMap[t]++;for(let t=0;t<this.freeList.length;t++)this.freeList[t]>=e&&this.freeList[t]++}removeBlock(e){this.allocations.splice(e,1);for(const t in this.allocationsMap)this.allocationsMap[t]>e&&this.allocationsMap[t]--;for(let t=0;t<this.freeList.length;t++)this.freeList[t]>e&&this.freeList[t]--}freeBlock(e){const t=this.allocations[e];this.freeSpace+=t.size;const i=e-1;if(this.freeList.includes(i)){return this.allocations[i].size+=t.size,void this.removeBlock(e)}const s=e+1;if(this.freeList.includes(s)){const i=this.allocations[s];return i.start-=t.size,i.size+=t.size,void this.removeBlock(e)}this.freeList.push(e)}deallocate(e){const t=this.allocationsMap[e];if(null==t)throw new Error(`allocation ${e} does not exist.`);this.freeBlock(t),delete this.allocationsMap[e]}getFragmentation(){return this.freeSpace/this.allocatedSpace}defragment(){}verifyConsistency(){if(Object.keys(this.allocationsMap).length+this.freeList.length!=this.allocations.length)throw new Error("number of blocks does not match the number of allocations");for(const e in this.allocationsMap){const t=this.allocationsMap[e];if(this.freeList.includes(t))throw new Error("block of used memory is also on the free list")}let e=0;for(let t=0;t<this.allocations.length;t++){const i=this.allocations[t];if(i.start!=e)throw"blocks of memory are not sequential";e+=i.size}if(e!=this.allocatedSpace)throw`allocated size: ${this.allocatedSpace}  does not match allocated blocks: ${e}`;if(this.reservedSpace<this.allocatedSpace)throw`reserved space: ${this.reservedSpace} is less than allocated space: ${this.allocatedSpace}`}}class ei{static replaceAll(e,t,i){return e.replace(new RegExp(t,"g"),i)}static stringifyJSONWithFixedPrecision(e,t=0,i=5){return JSON.stringify(e,((e,t)=>t&&t.toFixed?Number(t.toFixed(i)):t),t)}static hashStr(e){let t,i,s,a=0;if(0===e.length)return a;for(t=0,s=e.length;t<s;t++)i=e.charCodeAt(t),a=(a<<5)-a+i,a|=0;return Math.abs(a)}}const ti={mouse:"mouse",touch:"touch",xr:"xr"};var ii=Object.freeze({__proto__:null,Env:Ut,GrowingPacker:Qt,EventEmitter:Jt,Allocator1D:$t,StringFunctions:ei,UInt8:0,SInt8:1,SInt16:3,UInt16:2,SInt32:5,UInt32:4,Float32:6,MathFunctions:jt,POINTER_TYPES:ti});const si=function(){if(!window.navigator)return{isMobileDevice:!1,isIOSDevice:!1,browserName:"Node",webGLSupported:!1,gpuDesc:null,deviceCategory:"High"};const e=null!=(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Pixel/i)||navigator.userAgent.match(/Windows Phone/i)),t=function(){const e=navigator.userAgent;let t,i,s,a=navigator.appName,r=""+parseFloat(navigator.appVersion),n=parseInt(navigator.appVersion,10);return navigator.brave?(a="Brave",i=e.indexOf("Chrome"),r=e.substring(i+7,e.indexOf(" ",i+7))):-1!=(i=e.indexOf("Opera"))?(a="Opera",r=e.substring(i+6),-1!=(i=e.indexOf("Version"))&&(r=e.substring(i+8))):-1!=(i=e.indexOf("MSIE"))?(a="Microsoft Internet Explorer",r=e.substring(i+5)):-1!=(i=e.indexOf("Edge"))?(a="Edge",r=e.substring(i+4)):-1!=(i=e.indexOf("Chrome"))?(a="Chrome",r=e.substring(i+7,e.indexOf(" ",i+7))):-1!=(i=e.indexOf("Safari"))?(a="Safari",r=e.substring(i+7),-1!=(i=e.indexOf("Version"))&&(r=e.substring(i+8))):-1!=(i=e.indexOf("Firefox"))?(a="Firefox",r=e.substring(i+8)):(t=e.lastIndexOf(" ")+1)<(i=e.lastIndexOf("/"))&&(a=e.substring(t,i),r=e.substring(i+1),a.toLowerCase()==a.toUpperCase()&&(a=navigator.appName)),-1!=(s=r.indexOf(";"))&&(r=r.substring(0,s)),-1!=(s=r.indexOf(" "))&&(r=r.substring(0,s)),n=parseInt(""+r,10),isNaN(n)&&(r=""+parseFloat(navigator.appVersion),n=parseInt(navigator.appVersion,10)),{browserName:a,fullVersion:r,majorVersion:n,appName:navigator.appName,userAgent:navigator.userAgent}}(),i=function(){let e,t;try{e=document.createElement("canvas").getContext("webgl")}catch(e){}if(!e)return;try{t=document.createElement("canvas").getContext("webgl2")}catch(e){}const i=e.getExtension("WEBGL_debug_renderer_info");if(!i)return console.warn("Unable to determine GPU Info:"),{vendor:"Unknown",renderer:"Unknown",gpuVendor:"Unknown",maxTextureSize:"Unknown",supportsWebGL2:null!=t};const s=e.getParameter(i.UNMASKED_VENDOR_WEBGL),a=e.getParameter(i.UNMASKED_RENDERER_WEBGL),r=e.getParameter(e.MAX_TEXTURE_SIZE);let n;return a.match(/NVIDIA/i)?n="NVidia":a.match(/AMD/i)||a.match(/Radeon/i)?n="AMD":a.match(/Intel/i)?n="Intel":a.match(/Mali/i)?n="ARM":a.match(/Apple/i)?n="Apple":a.match(/Adreno/i)?n="Adreno":a.match(/Google Swiftshader/i)?n="Google":console.warn("Unable to determine GPU vendor:",a),{vendor:s,renderer:a,gpuVendor:n,maxTextureSize:r,supportsWebGL2:null!=t}}();let s="Low";if(i)if(e)s="Low";else{const e=i.renderer.replace(/[()]/g,"").split(" ");if("NVidia"==i.gpuVendor){const t=e.indexOf("GTX");if(-1!=t){const i=e[t+1];if(i.endsWith("M")){s=parseInt(i.substring(0,i.length-2))>=900?"Medium":"Low"}else{s=parseInt(i)>=1030?"High":"Medium"}}else s=e.includes("RTX")||e.includes("TITAN")||e.includes("Quadro")?"High":"Low"}else if("AMD"==i.gpuVendor){const t=e.indexOf("Radeon");if(-1!=t){const i=e.indexOf("RX");if(-1!=i)if("Vega"==e[i+1])s="High";else{const t=e[i+1];let a;t.endsWith("X")?(a=parseInt(t.substring(0,t.length-2)),s="High"):a=parseInt(t),s=a>=480?"High":"Medium"}else if("Pro"==e[t+1]){s=parseInt(e[i+1])>=450?"Medium":"Low"}else if("Sky"==e[t+1]){s=parseInt(e[i+1])>=700?"Medium":"Low"}else s="Low"}else s=e.includes("FirePro")||e.includes("Quadro")?"High":"Low"}else("Adreno"==i.gpuVendor||"Intel"==i.gpuVendor||"Google"==i.gpuVendor)&&(s="Low")}return{isMobileDevice:e,isIOSDevice:null!=(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)),browserName:t.browserName,fullVersion:t.fullVersion,majorVersion:t.majorVersion,appName:t.appName,userAgent:t.userAgent,webGLSupported:null!=i,gpuDesc:i,deviceCategory:s}}();window.ZeaSystemDesc||(window.ZeaSystemDesc=si);let ai={},ri={},ni=[];const oi={register:(e,t)=>{if(ai[e])throw new Error(`There's a class registered with '${e}' name`);ai[e]={blueprint:t,callbacks:[]};const i=ni.length;ni.push(t),ri[i]=e},getBlueprint:e=>{if(ai[e])return ai[e].blueprint;throw new Error(`${e} blueprint is not registered`)},getBlueprintName:e=>{let t=e,i=e;"object"==typeof e&&(t=e.constructor,i=t.name);const s=ni.indexOf(t);if(s>=0&&ri[s])return ri[s];throw new Error(`${i} blueprint is not registered`)},constructClass:(e,...t)=>{const i=ai[e];if(!i)throw new Error(`${e} blueprint is not registered`);return new i.blueprint(...t)},flush:()=>{ai={},ri={},ni=[]}};oi.register("UInt8",0),oi.register("SInt8",1),oi.register("UInt16",2),oi.register("SInt16",3),oi.register("UInt32",4),oi.register("SInt32",5),oi.register("Float32",6);class li{isValid(){for(const e of this.__data)if(e==1/0||isNaN(e))return!1;return!0}static createFromFloat32Buffer(e,t){throw new Error("Not yet implemented for this type:"+this.constructor.name)}static createFromBuffer(e,t){throw new Error("Not yet implemented for this type:"+this.constructor.name)}static numElements(){throw new Error("Not yet implemented for this type:"+this.constructor.name)}asArray(){return this.__data}toString(){return ei.stringifyJSONWithFixedPrecision(this.toJSON())}toJSON(){throw new Error("Not yet implemented for this type:"+this.constructor.name)}}class hi extends li{constructor(e=0,t=0){if(super(),e instanceof Float32Array||e instanceof Uint32Array||e instanceof Int32Array)this.__data=e;else if(e instanceof ArrayBuffer){console.warn("deprecated, please use new Vec4(new Float32Array(buffer, byteOffset, 4))");const i=e,s=t;this.__data=new Float32Array(i,s,2)}else null!=e&&"object"==typeof e?(this.__data=new Float32Array(2),this.fromJSON(e)):(this.__data=new Float32Array(2),this.__data[0]=e,this.__data[1]=t)}get x(){return this.__data[0]}set x(e){this.__data[0]=e}get y(){return this.__data[1]}set y(e){this.__data[1]=e}set(e,t){this.__data[0]=e,this.__data[1]=t}setFromOther(e){this.x=e.x,this.y=e.y}equal(e){return console.warn("Deprecated. Use #isEqual instead."),this.isEqual(e)}isEqual(e){return this.x==e.x&&this.y==e.y}notEquals(e){return console.warn("Deprecated. Use #notEqual instead."),this.notEqual(e)}notEqual(e){return this.x!=e.x&&this.y!=e.y}approxEqual(e,t=Number.EPSILON){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t}add(e){return new hi(this.x+e.x,this.y+e.y)}addInPlace(e){this.x+=e.x,this.y+=e.y}subtract(e){return new hi(this.x-e.x,this.y-e.y)}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}scale(e){return new hi(this.x*e,this.y*e)}scaleInPlace(e){this.x*=e,this.y*=e}invert(){return new hi(1/this.x,1/this.y)}invertInPlace(){return this.x=1/this.x,this.y=1/this.y,this}multiply(e){return new hi(this.x*e.x,this.y*e.y)}multiplyInPlace(e){this.x*=e.x,this.y*=e.y}lengthSquared(){const e=this.__data[0],t=this.__data[1];return e*e+t*t}length(){return Math.sqrt(this.lengthSquared())}distanceTo(e){const t=this.__data[0]-e.x,i=this.__data[1]-e.y;return Math.sqrt(t*t+i*i)}normalize(){const e=this.__data[0],t=this.__data[1];let i=e*e+t*t;return i<Number.EPSILON?new hi:(i=1/Math.sqrt(i),new hi(e*i,t*i))}normalizeInPlace(){const e=this.__data[0],t=this.__data[1];let i=e*e+t*t;i<Number.EPSILON||(i=1/Math.sqrt(i),this.set(e*i,t*i))}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}angleTo(e){const t=this.normalize().dot(e.normalize());return t>1?0:t<-1?Math.PI:Math.acos(t)}signedAngleTo(e){const t=this.angleTo(e);return this.cross(e)<0?-t:t}rotate(e){const t=Math.cos(e),i=Math.sin(e);return new hi(this.x*t-this.y*i,this.x*i+this.y*t)}lerp(e,t){const i=this.x,s=this.y;return new hi(i+t*(e.x-i),s+t*(e.y-s))}setRandomDir(e=1){const t=2*Math.random()*Math.PI;return this.__data[0]=Math.cos(t)*zScale,this.__data[1]=Math.sin(t)*zScale,this}setRandom(e=1){return this.__data[0]=Math.random()*e,this.__data[1]=Math.random()*e,this}clone(){return new hi(this.__data[0],this.__data[1])}asArray(){return this.__data}static create(...e){return new hi(...e)}static createFromFloat32Buffer(e,t=0){return console.warn("Deprecated, use #createFromBuffer instead"),this.createFromBuffer(e,4*t)}static createFromBuffer(e,t){return new hi(new Float32Array(e,t,2))}static createFromFloat32Array(e){return new hi(e)}static numElements(){return 2}toJSON(){return{x:this.x,y:this.y}}fromJSON(e){this.x=e.x,this.y=e.y}readBinary(e){this.x=e.loadFloat32(),this.y=e.loadFloat32()}}oi.register("Vec2",hi);class di extends li{constructor(e=0,t=0,i=0){if(super(),e instanceof Float32Array||e instanceof Uint32Array)this.__data=e;else if(e instanceof ArrayBuffer){console.warn("deprecated, please use new Vec3(new Float32Array(buffer, byteOffset, 3))");const i=e,s=t;this.__data=new Float32Array(i,s,3)}else null!=e&&"object"==typeof e?(this.__data=new Float32Array(3),this.fromJSON(e)):(this.__data=new Float32Array(3),this.__data[0]=e,this.__data[1]=t,this.__data[2]=i)}get x(){return this.__data[0]}set x(e){this.__data[0]=e}get y(){return this.__data[1]}set y(e){this.__data[1]=e}get z(){return this.__data[2]}set z(e){this.__data[2]=e}get xy(){return new hi(this.__data[0],this.__data[1])}get yz(){return new hi(this.__data[1],this.__data[2])}set(e,t,i){this.x=e,this.y=void 0!==t?t:e,this.z=void 0!==i?i:e}setDataArray(e){this.__data=e}setFromOther(e){this.x=e.x,this.y=e.y,this.z=e.z}isNull(){return Math.abs(this.x)<Number.EPSILON&&Math.abs(this.y)<Number.EPSILON&&Math.abs(this.z)<Number.EPSILON}is111(){return Math.abs(1-this.x)<Number.EPSILON&&Math.abs(1-this.y)<Number.EPSILON&&Math.abs(1-this.z)<Number.EPSILON}equal(e){return console.warn("Deprecated. Use #isEqual instead."),this.isEqual(e)}isEqual(e){return this.x==e.x&&this.y==e.y&&this.z==e.z}notEquals(e){return console.warn("Deprecated. Use #notEqual instead."),this.notEqual(e)}notEqual(e){return this.x!=e.x&&this.y!=e.y&&this.z!=e.z}approxEqual(e,t=Number.EPSILON){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t}add(e){return new di(this.x+e.x,this.y+e.y,this.z+e.z)}addInPlace(e){this.x+=e.x,this.y+=e.y,this.z+=e.z}subtract(e){return new di(this.x-e.x,this.y-e.y,this.z-e.z)}subtractInPlace(e){this.x-=e.x,this.y-=e.y,this.z-=e.z}multiply(e){return new di(this.x*e.x,this.y*e.y,this.z*e.z)}multiplyInPlace(e){this.x*=e.x,this.y*=e.y,this.z*=e.z}divide(e){return new di(this.x/e.x,this.y/e.y,this.z/e.z)}divideInPlace(e){this.x/=e.x,this.y/=e.y,this.z/=e.z}scale(e){return new di(this.x*e,this.y*e,this.z*e)}scaleInPlace(e){this.x*=e,this.y*=e,this.z*=e}negate(){return new di(-this.x,-this.y,-this.z)}inverse(){return new di(1/this.x,1/this.y,1/this.z)}lengthSquared(){const e=this.__data[0],t=this.__data[1],i=this.__data[2];return e*e+t*t+i*i}length(){return Math.sqrt(this.lengthSquared())}distanceTo(e){const t=this.__data[0]-e.x,i=this.__data[1]-e.y,s=this.__data[2]-e.z;return Math.sqrt(t*t+i*i+s*s)}normalize(){let e=this.__data[0]*this.__data[0]+this.__data[1]*this.__data[1]+this.__data[2]*this.__data[2];return e<Number.EPSILON?new di:(e=1/Math.sqrt(e),new di(this.__data[0]*e,this.__data[1]*e,this.__data[2]*e))}normalizeInPlace(){let e=this.__data[0]*this.__data[0]+this.__data[1]*this.__data[1]+this.__data[2]*this.__data[2];if(e<Number.EPSILON)return;e=Math.sqrt(e);const t=1/e;return this.__data[0]*=t,this.__data[1]*=t,this.__data[2]*=t,e}resize(e){const t=this.__data[0]*this.__data[0]+this.__data[1]*this.__data[1]+this.__data[2]*this.__data[2];if(t<Number.EPSILON)return;const i=e/Math.sqrt(t);return new di(this.__data[0]*i,this.__data[1]*i,this.__data[2]*i)}resizeInPlace(e){const t=this.__data[0]*this.__data[0]+this.__data[1]*this.__data[1]+this.__data[2]*this.__data[2];if(t<Number.EPSILON)return;const i=e/Math.sqrt(t);this.__data[0]*=i,this.__data[1]*=i,this.__data[2]*=i}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}cross(e){const t=this.x,i=this.y,s=this.z,a=e.x,r=e.y,n=e.z;return new di(i*n-s*r,s*a-t*n,t*r-i*a)}angleTo(e){const t=this.dot(e);return t>1?0:Math.acos(t)}lerp(e,t){const i=this.x,s=this.y,a=this.z;return new di(i+t*(e.x-i),s+t*(e.y-s),a+t*(e.z-a))}abs(){return new di(Math.abs(this.x),Math.abs(this.y),Math.abs(this.z))}setRandomDir(e=1){const t=2*Math.random()*Math.PI,i=2*Math.random()-1,s=Math.sqrt(1-i*i)*e;return this.__data[0]=Math.cos(t)*s,this.__data[1]=Math.sin(t)*s,this.__data[2]=i*e,this}setRandom(e=1){return this.__data[0]=(Math.random()-.5)*e,this.__data[1]=(Math.random()-.5)*e,this.__data[2]=(Math.random()-.5)*e,this}clone(){return new di(this.__data[0],this.__data[1],this.__data[2])}asArray(){return this.__data}static create(...e){return new di(...e)}static createFromJSON(e){const t=new di;return t.fromJSON(e),t}static createFromFloat32Buffer(e,t=0){return console.warn("Deprecated, use #createFromBuffer instead"),this.createFromBuffer(e,4*t)}static createFromBuffer(e,t){return new di(new Float32Array(e,t,3))}static createFromFloat32Array(e){return new di(e)}static numElements(){return 3}toJSON(){return{x:this.x,y:this.y,z:this.z}}fromJSON(e){this.x=e.x,this.y=e.y,this.z=e.z}readBinary(e){this.x=e.loadFloat32(),this.y=e.loadFloat32(),this.z=e.loadFloat32()}}oi.register("Vec3",di);class ci extends li{constructor(e=0,t=0,i=0,s=0){if(super(),e instanceof Float32Array||e instanceof Uint32Array)this.__data=e;else if(e instanceof ArrayBuffer){console.warn("deprecated, please use new Vec4(new Float32Array(buffer, byteOffset, 4))");const i=e,s=t;this.__data=new Float32Array(i,s,4)}else null!=e&&"object"==typeof e?(this.__data=new Float32Array(4),this.fromJSON(e)):(this.__data=new Float32Array(4),this.__data[0]=e,this.__data[1]=t,this.__data[2]=i,this.__data[3]=s)}get x(){return this.__data[0]}set x(e){this.__data[0]=e}get y(){return this.__data[1]}set y(e){this.__data[1]=e}get z(){return this.__data[2]}set z(e){this.__data[2]=e}get t(){return this.__data[3]}set t(e){this.__data[3]=e}get w(){return this.__data[3]}set w(e){this.__data[3]=e}get xyz(){return new di(this.__data[0],this.__data[1],this.__data[2])}set(e,t,i,s){this.x=e,this.y=t,this.z=i,this.t=s}setFromOther(e){this.x=e.x,this.y=e.y,this.z=e.z,this.t=e.t}equal(e){return console.warn("Deprecated. Use #isEqual instead."),this.isEqual(e)}isEqual(e){return this.x==e.x&&this.y==e.y&&this.z==e.z&&this.t==e.t}notEquals(e){return console.warn("Deprecated. Use #notEqual instead."),this.notEqual(e)}notEqual(e){return this.x!=e.x&&this.y!=e.y&&this.z!=e.z&&this.t!=e.t}approxEqual(e,t=Number.EPSILON){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.t-e.t)<t}add(e){return new ci(this.x+e.x,this.y+e.y,this.z+e.z,this.t+e.t)}addInPlace(e){this.x+=e.x,this.y+=e.y,this.z+=e.z,this.t+=e.t}subtract(e){return new ci(this.x-e.x,this.y-e.y,this.z-e.z,this.t-e.t)}subtractInPlace(e){this.x-=e.x,this.y-=e.y,this.z-=e.z,this.t-=e.t}multiply(e){return new ci(this.x*e.x,this.y*e.y,this.z*e.z,this.t*e.t)}multiplyInPlace(e){this.x*=e.x,this.y*=e.y,this.z*=e.z,this.t*=e.t}divide(e){return new ci(this.x/e.x,this.y/e.y,this.z/e.z,this.t/e.t)}divideInPlace(e){this.x/=e.x,this.y/=e.y,this.z/=e.z,this.t/=e.t}scale(e){return new ci(this.x*e,this.y*e,this.z*e,this.t*e)}scaleInPlace(e){this.set(this.x*e,this.y*e,this.z*e,this.t*e)}length(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],s=this.__data[2];return Math.sqrt(e*e+t*t+i*i+s*s)}lengthSquared(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],s=this.__data[3];return e*e+t*t+i*i+s*s}normalize(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],s=this.__data[3];let a=e*e+t*t+i*i+s*s;return a<Number.EPSILON?new ci:(a=1/Math.sqrt(a),new ci(e*a,t*a,i*a))}normalizeInPlace(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],s=this.__data[3];let a=e*e+t*t+i*i+s*s;a<Number.EPSILON||(a=1/Math.sqrt(a),this.set(e*a,t*a,i*a,s*a))}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.t*b.t}cross(e){const t=this.x,i=this.y,s=this.z,a=this.t,r=e.x,n=e.y,o=e.z,l=e.t;return new ci(i*o-s*n,s*l-a*o,a*r-t*l,t*n-i*r)}angleTo(e){const t=this.normalize(),i=e.normalize(),s=t.dot(i);return s>1?0:Math.acos(s)}lerp(e,t){const i=this.x,s=this.y,a=this.z;return at=this.t,new ci(i+t*(e.x-i),s+t*(e.y-s),a+t*(e.z-a),at+t*(e.t-at))}random(e=1){const t=2*glMatrix.RANDOM()*Math.PI,i=2*glMatrix.RANDOM()-1,s=Math.sqrt(1-i*i)*e;return out[0]=Math.cos(t)*s,out[1]=Math.sin(t)*s,out[2]=i*e,out}clone(){return new ci(this.__data[0],this.__data[1],this.__data[2],this.__data[3])}toVec3(){return new di(this.__data[0],this.__data[1],this.__data[2])}asArray(){return this.__data}static create(...e){return new di(...e)}static createFromFloat32Buffer(e,t=0){return console.warn("Deprecated, use #createFromBuffer instead"),new ci(new Float32Array(e,4*t,4))}static createFromBuffer(e,t){return new ci(new Float32Array(e,t,4))}static numElements(){return 4}toJSON(){return{x:this.x,y:this.y,z:this.z,t:this.t}}fromJSON(e){this.x=e.x,this.y=e.y,this.z=e.z,this.t=e.t}readBinary(e){this.x=e.loadFloat32(),this.y=e.loadFloat32(),this.z=e.loadFloat32(),this.t=e.loadFloat32()}}oi.register("Vec4",ci);class ui extends li{constructor(e=0,t=0,i=0,s=255){super(),e instanceof Uint8Array?this.__data=e:(this.__data=new Uint8Array(4),"string"==typeof e?e.startsWith("#")?this.setFromHex(e):this.setFromCSSColorName(e):(this.__data[0]=e,this.__data[1]=t,this.__data[2]=i,this.__data[3]=s))}get r(){return this.__data[0]}set r(e){this.__data[0]=e}get g(){return this.__data[1]}set g(e){this.__data[1]=e}get b(){return this.__data[2]}set b(e){this.__data[2]=e}get a(){return this.__data[3]}set a(e){this.__data[3]=e}set(e,t,i,s=255){this.r=e,this.g=t,this.b=i,this.a=s}setFromOther(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a}setFromArray(e){this.r=e[0],this.g=e[1],this.b=e[2],this.a=4==e.length?e[3]:1}setFromHex(e){const t=function(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}(e);t?this.set(t.r,t.g,t.b):console.warn("Invalid hex code:"+e)}setFromCSSColorName(e){e.startsWith("#")?this.setFromHex(e):this.setFromHex((e=>{const t={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};return void 0!==t[e.toLowerCase()]&&t[e.toLowerCase()]})(e))}toHex(){function e(e){const t=e.toString(16);return 1==t.length?"0"+t:t}return"#"+e(this.r)+e(this.g)+e(this.b)}equal(e){return console.warn("Deprecated. Use #isEqual instead."),this.isEqual(e)}isEqual(e){return this.r==e.r&&this.g==e.g&&this.b==e.b&&this.a==e.a}notEquals(e){return this.r!=e.r&&this.g!=e.g&&this.b!=e.b&&this.a!=e.a}approxEqual(e,t=Number.EPSILON){return Math.abs(this.r-e.r)<t&&Math.abs(this.g-e.g)<t&&Math.abs(this.b-e.b)<t&&Math.abs(this.a-e.a)<t}add(e){return new ui(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}subtract(e){return new ui(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}scale(e){return new ui(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){this.r*=e,this.g*=e,this.b*=e,this.a*=e}applyGamma(e){this.set(Math.pow(this.r,e),Math.pow(this.g,e),Math.pow(this.b,e),this.a)}toLinear(e=2.2){return new ui(Math.pow(this.r,e),Math.pow(this.g,e),Math.pow(this.b,e),this.a)}toGamma(e=2.2){return new ui(Math.pow(this.r,1/e),Math.pow(this.g,1/e),Math.pow(this.b,1/e),this.a)}luminance(){return.2126*this.r+.7152*this.g+.0722*this.b}lerp(e,t){const i=this.r,s=this.g,a=this.b,r=this.a;return new ui(i+t*(e.r-i),s+t*(e.g-s),a+t*(e.b-a),r+t*(e.a-r))}static random(e=0,t=!1){return e>0?new ui(e+Math.random()*(1-e),e+Math.random()*(1-e),e+Math.random()*(1-e),t?e+Math.random()*(1-e):1):e<0?new ui(Math.random()*(1+e),Math.random()*(1+e),Math.random()*(1+e),t?Math.random()*(1+e):1):new ui(Math.random(),Math.random(),Math.random(),t?Math.random():1)}clone(){return new ui(this.__data[0],this.__data[1],this.__data[2],this.__data[3])}asArray(){return this.__data}as3ComponentArray(){return[this.__data[0],this.__data[1],this.__data[2]]}static create(...e){return new ui(...e)}static createFromFloat32Buffer(e,t=0){return console.warn("Deprecated, use #createFromBuffer instead"),this.createFromBuffer(e,4*t)}static createFromBuffer(e,t){return new ui(new Uint8Array(e,t,4))}static numElements(){return 4}toJSON(){return{r:this.r,g:this.g,b:this.b,a:this.a}}fromJSON(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a}toCSSString(){return"rgba("+Math.round(255*this.r)+", "+Math.round(255*this.g)+", "+Math.round(255*this.b)+", "+this.a+")"}}oi.register("RGBA",ui);class mi extends li{constructor(e=0,t=0,i=0,s=1){if(super(),e instanceof Float32Array)this.__data=e;else if(e instanceof ArrayBuffer){console.warn("deprecated, please use new Vec4(new Float32Array(buffer, byteOffset, 4))");const i=e,s=t;this.__data=new Float32Array(i,s,4)}else this.__data=new Float32Array(4),"string"==typeof e?e.startsWith("#")?this.setFromHex(e):this.setFromCSSColorName(e):(this.__data[0]=e,this.__data[1]=t,this.__data[2]=i,this.__data[3]=s)}get r(){return this.__data[0]}set r(e){this.__data[0]=e}get g(){return this.__data[1]}set g(e){this.__data[1]=e}get b(){return this.__data[2]}set b(e){this.__data[2]=e}get a(){return this.__data[3]}set a(e){this.__data[3]=e}set(e,t,i,s=1){this.r=e,this.g=t,this.b=i,this.a=s}setFromOther(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a}setFromHex(e){const t=function(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}(e);t?this.set(t.r/255,t.g/255,t.b/255):console.warn("Invalid hex code:"+e)}setFromCSSColorName(e){e.startsWith("#")?this.setFromHex(e):this.setFromHex((e=>{const t={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};return void 0!==t[e.toLowerCase()]&&t[e.toLowerCase()]})(e))}toHex(){const e=e=>{const t=Math.round(255*e).toString(16);return 1==t.length?"0"+t:t};return`#${e(this.r)}${e(this.g)}${e(this.b)}`}equal(e){return console.warn("Deprecated. Use #isEqual instead."),this.isEqual(e)}isEqual(e){return this.r==e.r&&this.g==e.g&&this.b==e.b&&this.a==e.a}notEquals(e){return this.r!=e.r&&this.g!=e.g&&this.b!=e.b&&this.a!=e.a}approxEqual(e,t=Number.EPSILON){return Math.abs(this.r-e.r)<t&&Math.abs(this.g-e.g)<t&&Math.abs(this.b-e.b)<t&&Math.abs(this.a-e.a)<t}add(e){return new mi(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}addInPlace(e){this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a}subtract(e){return new mi(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}scale(e){return new mi(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){this.r*=e,this.g*=e,this.b*=e,this.a*=e}applyGamma(e){this.set(Math.pow(this.r,e),Math.pow(this.g,e),Math.pow(this.b,e),this.a)}toLinear(e=2.2){return new mi(Math.pow(this.r,e),Math.pow(this.g,e),Math.pow(this.b,e),this.a)}toGamma(e=2.2){return new mi(Math.pow(this.r,1/e),Math.pow(this.g,1/e),Math.pow(this.b,1/e),this.a)}luminance(){return.2126*this.r+.7152*this.g+.0722*this.b}lerp(e,t){const i=this.r,s=this.g,a=this.b,r=this.a;return new mi(i+t*(e.r-i),s+t*(e.g-s),a+t*(e.b-a),r+t*(e.a-r))}static random(e=0,t=!1){return e>0?new mi(e+Math.random()*(1-e),e+Math.random()*(1-e),e+Math.random()*(1-e),t?e+Math.random()*(1-e):1):e<0?new mi(Math.random()*(1+e),Math.random()*(1+e),Math.random()*(1+e),t?Math.random()*(1+e):1):new mi(Math.random(),Math.random(),Math.random(),t?Math.random():1)}clone(){return new mi(this.__data[0],this.__data[1],this.__data[2],this.__data[3])}asArray(){return this.__data}static create(...e){return new mi(...e)}static createFromFloat32Buffer(e,t=0){return console.warn("Deprecated, use #createFromBuffer instead"),this.createFromBuffer(e,4*t)}static createFromBuffer(e,t){return new mi(new Float32Array(e,t,4))}static numElements(){return 4}toJSON(){return{r:this.r,g:this.g,b:this.b,a:this.a}}fromJSON(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a}readBinary(e){this.r=e.loadFloat32(),this.g=e.loadFloat32(),this.b=e.loadFloat32(),this.a=e.loadFloat32()}}oi.register("Color",mi);class gi extends li{constructor(e=0,t=0,i=0,s=0){if(super(),isNaN(s))switch(s){case"XYZ":this.order=0;break;case"YZX":this.order=1;break;case"ZXY":this.order=2;break;case"XZY":this.order=3;break;case"ZYX":this.order=4;break;case"YXZ":this.order=5;break;default:throw new Error("Invalid Euler Angles Order:"+s)}else this.order=s;if(e instanceof ArrayBuffer){const i=e,s=t;this.__data=new Float32Array(i,s,4)}else this.__data=new Float32Array(3),this.__data[0]=e,this.__data[1]=t,this.__data[2]=i}get x(){return this.__data[0]}set x(e){this.__data[0]=e}get y(){return this.__data[1]}set y(e){this.__data[1]=e}get z(){return this.__data[2]}set z(e){this.__data[2]=e}set(e,t,i){this.__data[0]=e,this.__data[1]=t,this.__data[2]=i}}oi.register("EulerAngles",gi);class _i extends li{constructor(e=1,t=0,i=0,s=0,a=1,r=0,n=0,o=0,l=1){if(super(),e instanceof di&&t instanceof di&&i instanceof di)this.__data=new Float32Array(9),this.set(e.x,e.y,e.z,t.x,t.y,t.z,i.x,i.y,i.z);else if(e instanceof Float32Array||e instanceof Uint32Array)this.__data=e;else if(e instanceof ArrayBuffer){console.warn("Deprecated, please use new Vec3(new Float32Array(buffer, byteOffset, 9))");const i=e,s=t;this.__data=new Float32Array(i,s,9)}else this.__data=new Float32Array(9),this.set(e,t,i,s,a,r,n,o,l)}get m00(){return this.__data[0]}set m00(e){this.__data[0]=e}get m01(){return this.__data[1]}set m01(e){this.__data[1]=e}get m02(){return this.__data[2]}set m02(e){this.__data[2]=e}get m10(){return this.__data[3]}set m10(e){this.__data[3]=e}get m11(){return this.__data[4]}set m11(e){this.__data[4]=e}get m12(){return this.__data[5]}set m12(e){this.__data[5]=e}get m20(){return this.__data[6]}set m20(e){this.__data[6]=e}get m21(){return this.__data[7]}set m21(e){this.__data[7]=e}get m22(){return this.__data[8]}set m22(e){this.__data[8]=e}get xAxis(){return di.createFromBuffer(this.__data.buffer,0)}set xAxis(e){this.xAxis.set(e.x,e.y,e.z)}get yAxis(){return di.createFromBuffer(this.__data.buffer,12)}set yAxis(e){this.yAxis.set(e.x,e.y,e.z)}get zAxis(){return di.createFromBuffer(this.__data.buffer,24)}set zAxis(e){this.zAxis.set(e.x,e.y,e.z)}set(e=1,t=0,i=0,s=0,a=1,r=0,n=0,o=0,l=1){this.__data[0]=e,this.__data[1]=t,this.__data[2]=i,this.__data[3]=s,this.__data[4]=a,this.__data[5]=r,this.__data[6]=n,this.__data[7]=o,this.__data[8]=l}setIdentity(){this.set()}setFromMat(e){this.__data[0]=e.m00,this.__data[1]=e.m01,this.__data[2]=e.m02,this.__data[3]=e.m10,this.__data[4]=e.m11,this.__data[5]=e.m12,this.__data[6]=e.m20,this.__data[7]=e.m21,this.__data[8]=e.m22}setFromDirectionAndUpvector(e,t){const i=e,s=i.length();if(s<Number.EPSILON)return void this.setIdentity();i.scaleInPlace(1/s);const a=t.cross(i),r=a.length();r>Number.EPSILON&&a.scaleInPlace(1/r);const n=i.cross(a),o=n.length();o>Number.EPSILON&&n.scaleInPlace(1/o),this.set(a.x,a.y,a.z,n.x,n.y,n.z,i.x,i.y,i.z)}inverse(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],s=this.__data[3],a=this.__data[4],r=this.__data[5],n=this.__data[6],o=this.__data[7],l=this.__data[8],h=l*a-r*o,d=-l*s+r*n,c=o*s-a*n,u=e*h+t*d+i*c;return u?(u=1/u,new _i(h*u,(-l*t+i*o)*u,(r*t-i*a)*u,d*u,(l*e-i*n)*u,(-r*e+i*s)*u,c*u,(-o*e+t*n)*u,(a*e-t*s)*u)):(console.warn("Unable to invert Mat3"),null)}invertInPlace(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],s=this.__data[3],a=this.__data[4],r=this.__data[5],n=this.__data[6],o=this.__data[7],l=this.__data[8],h=l*a-r*o,d=-l*s+r*n,c=o*s-a*n,u=e*h+t*d+i*c;return u?(u=1/u,this.set(h*u,(-l*t+i*o)*u,(r*t-i*a)*u,d*u,(l*e-i*n)*u,(-r*e+i*s)*u,c*u,(-o*e+t*n)*u,(a*e-t*s)*u),!0):(console.warn("Unable to invert Mat3"),!1)}transpose(){return _i(this.__data[0],this.__data[3],this.__data[6],this.__data[1],this.__data[4],this.__data[7],this.__data[2],this.__data[5],this.__data[8])}transposeInPlace(){const e=this.__data[1],t=this.__data[2],i=this.__data[5];this.__data[1]=this.__data[3],this.__data[2]=this.__data[6],this.__data[3]=e,this.__data[5]=this.__data[7],this.__data[6]=t,this.__data[7]=i}transformVec3(e){return new di(this.__data[0]*e.x+this.__data[1]*e.y+this.__data[2]*e.z,this.__data[3]*e.x+this.__data[4]*e.y+this.__data[5]*e.z,this.__data[6]*e.x+this.__data[7]*e.y+this.__data[8]*e.z)}clone(){return new _i(this.__data[0],this.__data[1],this.__data[2],this.__data[3],this.__data[4],this.__data[5],this.__data[6],this.__data[7],this.__data[8],this.__data[9])}static create(...e){return new _i(...e)}static createFromFloat32Buffer(e,t=0){return console.warn("Deprecated, use #createFromBuffer instead"),this.createFromBuffer(e,4*t)}static createFromBuffer(e,t){return new _i(new Float32Array(e,t,9))}readBinary(e){this.__data=e.loadFloat32Array(9)}toJSON(){return this.__data}fromJSON(e){this.__data=new Float32Array(e)}toString(){return this.toJSON().toString()}}oi.register("Mat3",_i);class fi extends li{constructor(e=1,t=0,i=0,s=0,a=0,r=1,n=0,o=0,l=0,h=0,d=1,c=0,u=0,m=0,g=0,_=1){if(super(),e instanceof Float32Array)this.__data=e;else if(e instanceof ArrayBuffer){const i=e,s=t;this.__data=new Float32Array(i,s,16)}else this.__data=new Float32Array(16),this.set(e,t,i,s,a,r,n,o,l,h,d,c,u,m,g,_)}get m00(){return this.__data[0]}set m00(e){this.__data[0]=e}get m01(){return this.__data[1]}set m01(e){this.__data[1]=e}get m02(){return this.__data[2]}set m02(e){this.__data[2]=e}get m03(){return this.__data[3]}set m03(e){this.__data[3]=e}get m10(){return this.__data[4]}set m10(e){this.__data[4]=e}get m11(){return this.__data[5]}set m11(e){this.__data[5]=e}get m12(){return this.__data[6]}set m12(e){this.__data[6]=e}get m13(){return this.__data[7]}set m13(e){this.__data[7]=e}get m20(){return this.__data[8]}set m20(e){this.__data[8]=e}get m21(){return this.__data[9]}set m21(e){this.__data[9]=e}get m22(){return this.__data[10]}set m22(e){this.__data[10]=e}get m23(){return this.__data[11]}set m23(e){this.__data[11]=e}get m30(){return this.__data[12]}set m30(e){this.__data[12]=e}get m31(){return this.__data[13]}set m31(e){this.__data[13]=e}get m32(){return this.__data[14]}set m32(e){this.__data[14]=e}get m33(){return this.__data[15]}set m33(e){this.__data[15]=e}get xAxis(){return di.createFromBuffer(this.__data.buffer,0)}set xAxis(e){this.xAxis.set(e.x,e.y,e.z)}get yAxis(){return di.createFromBuffer(this.__data.buffer,16)}set yAxis(e){this.yAxis.set(e.x,e.y,e.z)}get zAxis(){return di.createFromBuffer(this.__data.buffer,32)}set zAxis(e){this.zAxis.set(e.x,e.y,e.z)}get translation(){return di.createFromBuffer(this.__data.buffer,48)}set translation(e){this.translation.set(e.x,e.y,e.z)}set(e=1,t=0,i=0,s=0,a=0,r=1,n=0,o=0,l=0,h=0,d=1,c=0,u=0,m=0,g=0,_=1){this.__data[0]=e,this.__data[1]=t,this.__data[2]=i,this.__data[3]=s,this.__data[4]=a,this.__data[5]=r,this.__data[6]=n,this.__data[7]=o,this.__data[8]=l,this.__data[9]=h,this.__data[10]=d,this.__data[11]=c,this.__data[12]=u,this.__data[13]=m,this.__data[14]=g,this.__data[15]=_}setIdentity(){this.set()}setDataArray(e){this.__data=e}setFromMat4(e){this.__data[0]=e.m00,this.__data[1]=e.m01,this.__data[2]=e.m02,this.__data[3]=e.m03,this.__data[4]=e.m10,this.__data[5]=e.m11,this.__data[6]=e.m12,this.__data[7]=e.m13,this.__data[8]=e.m20,this.__data[9]=e.m21,this.__data[10]=e.m22,this.__data[11]=e.m23,this.__data[12]=e.m30,this.__data[13]=e.m31,this.__data[14]=e.m32,this.__data[15]=e.m33}toMat3(){return new _i(this.__data[0],this.__data[1],this.__data[2],this.__data[4],this.__data[5],this.__data[6],this.__data[8],this.__data[9],this.__data[10])}transposeInPlace(){const e=this.__data[1],t=this.__data[2],i=this.__data[3],s=this.__data[6],a=this.__data[7],r=this.__data[11];this.__data[1]=this.__data[4],this.__data[2]=this.__data[8],this.__data[3]=this.__data[12],this.__data[4]=e,this.__data[6]=this.__data[9],this.__data[7]=this.__data[13],this.__data[8]=t,this.__data[9]=s,this.__data[11]=this.__data[14],this.__data[12]=i,this.__data[13]=a,this.__data[14]=r}transpose(){return new fi(this.__data[0],this.__data[4],this.__data[8],this.__data[12],this.__data[1],this.__data[5],this.__data[9],this.__data[13],this.__data[2],this.__data[6],this.__data[10],this.__data[14],this.__data[3],this.__data[7],this.__data[11],this.__data[15])}inverse(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],s=this.__data[3],a=this.__data[4],r=this.__data[5],n=this.__data[6],o=this.__data[7],l=this.__data[8],h=this.__data[9],d=this.__data[10],c=this.__data[11],u=this.__data[12],m=this.__data[13],g=this.__data[14],_=this.__data[15],f=e*r-t*a,p=e*n-i*a,b=e*o-s*a,y=t*n-i*r,G=t*o-s*r,X=i*o-s*n,x=l*m-h*u,I=l*g-d*u,V=l*_-c*u,v=h*g-d*m,R=h*_-c*m,w=d*_-c*g;let M=f*w-p*R+b*v+y*V-G*I+X*x;return M?(M=1/M,new fi((r*w-n*R+o*v)*M,(i*R-t*w-s*v)*M,(m*X-g*G+_*y)*M,(d*G-h*X-c*y)*M,(n*V-a*w-o*I)*M,(e*w-i*V+s*I)*M,(g*b-u*X-_*p)*M,(l*X-d*b+c*p)*M,(a*R-r*V+o*x)*M,(t*V-e*R-s*x)*M,(u*G-m*b+_*f)*M,(h*b-l*G-c*f)*M,(r*I-a*v-n*x)*M,(e*v-t*I+i*x)*M,(m*p-u*y-g*f)*M,(l*y-h*p+d*f)*M)):(console.warn("Unable to invert Mat4"),null)}invertInPlace(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],s=this.__data[3],a=this.__data[4],r=this.__data[5],n=this.__data[6],o=this.__data[7],l=this.__data[8],h=this.__data[9],d=this.__data[10],c=this.__data[11],u=this.__data[12],m=this.__data[13],g=this.__data[14],_=this.__data[15],f=e*r-t*a,p=e*n-i*a,b=e*o-s*a,y=t*n-i*r,G=t*o-s*r,X=i*o-s*n,x=l*m-h*u,I=l*g-d*u,V=l*_-c*u,v=h*g-d*m,R=h*_-c*m,w=d*_-c*g;let M=f*w-p*R+b*v+y*V-G*I+X*x;return M?(M=1/M,this.set((r*w-n*R+o*v)*M,(i*R-t*w-s*v)*M,(m*X-g*G+_*y)*M,(d*G-h*X-c*y)*M,(n*V-a*w-o*I)*M,(e*w-i*V+s*I)*M,(g*b-u*X-_*p)*M,(l*X-d*b+c*p)*M,(a*R-r*V+o*x)*M,(t*V-e*R-s*x)*M,(u*G-m*b+_*f)*M,(h*b-l*G-c*f)*M,(r*I-a*v-n*x)*M,(e*v-t*I+i*x)*M,(m*p-u*y-g*f)*M,(l*y-h*p+d*f)*M),!0):(console.warn("Unable to invert Mat4"),!1)}multiply(e){const t=this.__data[0],i=this.__data[1],s=this.__data[2],a=this.__data[3],r=this.__data[4],n=this.__data[5],o=this.__data[6],l=this.__data[7],h=this.__data[8],d=this.__data[9],c=this.__data[10],u=this.__data[11],m=this.__data[12],g=this.__data[13],_=this.__data[14],f=this.__data[15],p=e.asArray();let b=p[0],y=p[1],G=p[2],X=p[3];const x=new fi;return x.m00=b*t+y*r+G*h+X*m,x.m01=b*i+y*n+G*d+X*g,x.m02=b*s+y*o+G*c+X*_,x.m03=b*a+y*l+G*u+X*f,b=p[4],y=p[5],G=p[6],X=p[7],x.m10=b*t+y*r+G*h+X*m,x.m11=b*i+y*n+G*d+X*g,x.m12=b*s+y*o+G*c+X*_,x.m13=b*a+y*l+G*u+X*f,b=p[8],y=p[9],G=p[10],X=p[11],x.m20=b*t+y*r+G*h+X*m,x.m21=b*i+y*n+G*d+X*g,x.m22=b*s+y*o+G*c+X*_,x.m23=b*a+y*l+G*u+X*f,b=p[12],y=p[13],G=p[14],X=p[15],x.m30=b*t+y*r+G*h+X*m,x.m31=b*i+y*n+G*d+X*g,x.m32=b*s+y*o+G*c+X*_,x.m33=b*a+y*l+G*u+X*f,x}multiplyInPlace(e){const t=this.asArray(),i=t[0],s=t[1],a=t[2],r=t[3],n=t[4],o=t[5],l=t[6],h=t[7],d=t[8],c=t[9],u=t[10],m=t[11],g=t[12],_=t[13],f=t[14],p=t[15],b=e.asArray();let y=b[0],G=b[1],X=b[2],x=b[3];return this.m00=y*i+G*n+X*d+x*g,this.m01=y*s+G*o+X*c+x*_,this.m02=y*a+G*l+X*u+x*f,this.m03=y*r+G*h+X*m+x*p,y=b[4],G=b[5],X=b[6],x=b[7],this.m10=y*i+G*n+X*d+x*g,this.m11=y*s+G*o+X*c+x*_,this.m12=y*a+G*l+X*u+x*f,this.m13=y*r+G*h+X*m+x*p,y=b[8],G=b[9],X=b[10],x=b[11],this.m20=y*i+G*n+X*d+x*g,this.m21=y*s+G*o+X*c+x*_,this.m22=y*a+G*l+X*u+x*f,this.m23=y*r+G*h+X*m+x*p,y=b[12],G=b[13],X=b[14],x=b[15],this.m30=y*i+G*n+X*d+x*g,this.m31=y*s+G*o+X*c+x*_,this.m32=y*a+G*l+X*u+x*f,this.m33=y*r+G*h+X*m+x*p,this}postMultiplyInPlace(e){const t=e.asArray(),i=t[0],s=t[1],a=t[2],r=t[3],n=t[4],o=t[5],l=t[6],h=t[7],d=t[8],c=t[9],u=t[10],m=t[11],g=t[12],_=t[13],f=t[14],p=t[15],b=this.asArray();let y=b[0],G=b[1],X=b[2],x=b[3];return this.m00=y*i+G*n+X*d+x*g,this.m01=y*s+G*o+X*c+x*_,this.m02=y*a+G*l+X*u+x*f,this.m03=y*r+G*h+X*m+x*p,y=b[4],G=b[5],X=b[6],x=b[7],this.m10=y*i+G*n+X*d+x*g,this.m11=y*s+G*o+X*c+x*_,this.m12=y*a+G*l+X*u+x*f,this.m13=y*r+G*h+X*m+x*p,y=b[8],G=b[9],X=b[10],x=b[11],this.m20=y*i+G*n+X*d+x*g,this.m21=y*s+G*o+X*c+x*_,this.m22=y*a+G*l+X*u+x*f,this.m23=y*r+G*h+X*m+x*p,y=b[12],G=b[13],X=b[14],x=b[15],this.m30=y*i+G*n+X*d+x*g,this.m31=y*s+G*o+X*c+x*_,this.m32=y*a+G*l+X*u+x*f,this.m33=y*r+G*h+X*m+x*p,this}translateInPlace(e){const t=this.__data,i=e.x,s=e.y,a=e.z;return t[12]=t[0]*i+t[4]*s+t[8]*a+t[12],t[13]=t[1]*i+t[5]*s+t[9]*a+t[13],t[14]=t[2]*i+t[6]*s+t[10]*a+t[14],t[15]=t[3]*i+t[7]*s+t[11]*a+t[15],this}setLookAt(e,t,i){const s=e.subtract(t),a=s.length();if(a<Number.EPSILON)return void this.setIdentity();s.scaleInPlace(1/a);const r=i.cross(s),n=r.length();n>Number.EPSILON&&r.scaleInPlace(1/n);const o=s.cross(r),l=o.length();l>Number.EPSILON&&o.scaleInPlace(1/l),this.set(r.x,r.y,r.z,0,o.x,o.y,o.z,0,s.x,s.y,s.z,0,e.x,e.y,e.z,1)}setRotation(e,t){const i=e.length();if(Math.abs(i)<Number.EPSILON)return null;const s=e.x/i,a=e.y/i,r=e.z/i,n=Math.sin(t),o=Math.cos(t),l=1-o,h=this.__data;return h[0]=s*s*l+o,h[1]=a*s*l+r*n,h[2]=r*s*l-a*n,h[3]=0,h[4]=s*a*l-r*n,h[5]=a*a*l+o,h[6]=r*a*l+s*n,h[7]=0,h[8]=s*r*l+a*n,h[9]=a*r*l-s*n,h[10]=r*r*l+o,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,this}setXRotation(e){const t=Math.sin(e),i=Math.cos(e),s=this.__data;return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=i,s[6]=t,s[7]=0,s[8]=0,s[9]=-t,s[10]=i,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,this}setYRotation(e){const t=Math.sin(e),i=Math.cos(e),s=this.__data;return s[0]=i,s[1]=0,s[2]=-t,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=t,s[9]=0,s[10]=i,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,this}setZRotation(e){const t=Math.sin(e),i=Math.cos(e),s=this.__data;return s[0]=i,s[1]=t,s[2]=0,s[3]=0,s[4]=-t,s[5]=i,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,this}transformVec4(e){const t=this.__data,i=e.x,s=e.y,a=e.z,r=e.t;return new Vec4(t[0]*i+t[4]*s+t[8]*a+t[12]*r,t[1]*i+t[5]*s+t[9]*a+t[13]*r,t[2]*i+t[6]*s+t[10]*a+t[14]*r,t[3]*i+t[7]*s+t[11]*a+t[15]*r)}transformVec3(e){const t=this.__data,i=e.x,s=e.y,a=e.z;return new di(t[0]*i+t[4]*s+t[8]*a+t[12],t[1]*i+t[5]*s+t[9]*a+t[13],t[2]*i+t[6]*s+t[10]*a+t[14])}rotateVec3(e){const t=this.__data,i=e.x,s=e.y,a=e.z;return new di(t[0]*i+t[4]*s+t[8]*a,t[1]*i+t[5]*s+t[9]*a,t[2]*i+t[6]*s+t[10]*a)}setPerspectiveMatrix(e,t,i,s){const a=Math.tan(.5*Math.PI-.5*e),r=1/(i-s);this.set(a/t,0,0,0,0,a,0,0,0,0,(i+s)*r,-1,0,0,i*s*r*2,0)}setOrthographicMatrix(e,t,i,s,a,r){const n=1/(e-t),o=1/(i-s),l=1/(a-r);this.set(-2*n,0,0,0,0,-2*o,0,0,0,0,2*l,0,(e+t)*n,(s+i)*o,(r+a)*l,1)}setScale(e,t,i){e instanceof di?this.set(e.x,0,0,0,0,e.y,0,0,0,0,e.z,0,0,0,0,1):this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1)}setFromMat3x4Array(e){this.set(e[0],e[1],e[2],0,e[3],e[4],e[5],0,e[6],e[7],e[8],0,e[9],e[10],e[11],1)}static createFromFloat32Buffer(e,t=0){return console.warn("Deprecated, use #createFromBuffer instead"),this.createFromBuffer(e,4*t)}static createFromBuffer(e,t){return new fi(new Float32Array(e,t,16))}clone(){return new fi(this.__data[0],this.__data[1],this.__data[2],this.__data[3],this.__data[4],this.__data[5],this.__data[6],this.__data[7],this.__data[8],this.__data[9],this.__data[10],this.__data[11],this.__data[12],this.__data[13],this.__data[14],this.__data[15])}static create(...e){return new fi(...e)}toJSON(){return this.__data}fromJSON(e){e instanceof Array?this.__data=new Float32Array(e):e instanceof Object&&(this.__data=new Float32Array(Object.values(e)))}readBinary(e){this.__data=e.loadFloat32Array(16)}}oi.register("Mat4",fi);class pi extends li{constructor(e=0,t=0,i=0,s=1){if(super(),e instanceof Float32Array)this.__data=e;else if(e instanceof ArrayBuffer){console.warn("deprecated, please use new Vec4(new Float32Array(buffer, byteOffset, 4))");const i=e,s=t;this.__data=new Float32Array(i,s,4)}else if(this.__data=new Float32Array(4),"object"==typeof e){this.__data[0]=0,this.__data[1]=0,this.__data[2]=0,this.__data[3]=1;for(const t in e)Array.isArray(e[t])?this[t].call(this,...e[t]):this[t].call(this,e[t])}else this.__data[0]=e,this.__data[1]=t,this.__data[2]=i,this.__data[3]=s}get x(){return this.__data[0]}set x(e){this.__data[0]=e}get y(){return this.__data[1]}set y(e){this.__data[1]=e}get z(){return this.__data[2]}set z(e){this.__data[2]=e}get w(){return this.__data[3]}set w(e){this.__data[3]=e}set(e,t,i,s){this.__data[0]=e,this.__data[1]=t,this.__data[2]=i,this.__data[3]=s}setDataArray(e){this.__data=e}setFromOther(e){this.__data[0]=e.x,this.__data[1]=e.y,this.__data[2]=e.z,this.__data[3]=e.w}setFromEulerAngles(e){const t=new di;switch(e.order){case 0:t.set(e.x,-e.y,e.z);break;case 1:t.set(e.y,-e.z,e.x);break;case 2:t.set(e.z,-e.x,e.y);break;case 3:t.set(e.x,e.z,e.y);break;case 4:t.set(e.z,e.y,e.x);break;case 5:t.set(e.y,e.x,e.z);break;default:throw new Error("Invalid EulerAngles order:",e.order)}const i=.5*t.x,s=.5*t.y,a=.5*t.z,r=Math.cos(i),n=Math.cos(s),o=Math.cos(a),l=Math.sin(i),h=Math.sin(s),d=Math.sin(a),c=r*o,u=r*d,m=l*o,g=l*d,_=n*m-h*u,f=n*g+h*c,p=n*u-h*m;switch(this.w=n*c+h*g,e.order){case 0:this.x=_,this.y=-f,this.z=p;break;case 1:this.x=p,this.y=_,this.z=-f;break;case 2:this.x=-f,this.y=p,this.z=_;break;case 3:this.x=_,this.y=p,this.z=f;break;case 4:this.x=p,this.y=f,this.z=_;break;case 5:this.x=f,this.y=_,this.z=p;break;default:throw new Error("Invalid EulerAngles order:",e.order)}}toEulerAngles(e){const t=new di;switch(e){case 0:t.set(this.z,this.x,this.y);break;case 1:t.set(this.x,this.y,this.z);break;case 2:t.set(this.y,this.z,this.x);break;case 3:t.set(this.y,-this.x,this.z);break;case 4:t.set(this.x,-this.z,this.y);break;case 5:t.set(this.z,-this.y,this.x);break;default:throw new Error("Invalid rotation order:"+e)}const i=new di,s=t.x*t.y+t.z*this.w;if(s>.49999)i.y=2*Math.atan2(t.x,this.w),i.z=.5*Math.PI,i.x=0;else if(s<-.49999)i.y=-2*Math.atan2(t.x,this.w),i.z=-.5*Math.PI,i.x=0;else{const e=t.x*t.x,a=t.y*t.y,r=t.z*t.z;i.y=Math.atan2(2*t.y*this.w-2*t.x*t.z,1-2*a-2*r),i.z=Math.asin(2*s),i.x=Math.atan2(2*t.x*this.w-2*t.y*t.z,1-2*e-2*r)}switch(e){case 0:return new gi(i.y,i.z,i.x,e);case 1:return new gi(i.x,i.y,i.z,e);case 2:return new gi(i.z,i.x,i.y,e);case 3:return new gi(-i.y,i.x,i.z,e);case 4:return new gi(i.x,i.z,-i.y,e);case 5:return new gi(i.z,-i.y,i.x,e)}}setFromAxisAndAngle(e,t){const i=t/2,s=e.normalize().scale(Math.sin(i));this.set(s.x,s.y,s.z,Math.cos(i))}setFromDirectionAndUpvector(e,t){const i=new _i;i.setFromDirectionAndUpvector(e,t),this.setFromMat3(i)}setFrom2Vectors(e,t){const i=e.cross(t),s=e.dot(t),a=Math.sqrt(2*(1+s));this.set(i.x/a,i.y/a,i.z/a,a/2),this.normalizeInPlace()}setFromMat3(e){const t=e.__data[0]+e.__data[4]+e.__data[8];let i;if(t>0)i=Math.sqrt(t+1),this.__data[3]=.5*i,i=.5/i,this.__data[0]=(e.__data[5]-e.__data[7])*i,this.__data[1]=(e.__data[6]-e.__data[2])*i,this.__data[2]=(e.__data[1]-e.__data[3])*i;else{let t=0;e.__data[4]>e.__data[0]&&(t=1),e.__data[8]>e.__data[3*t+t]&&(t=2);const s=(t+1)%3,a=(t+2)%3;i=Math.sqrt(e.__data[3*t+t]-e.__data[3*s+s]-e.__data[3*a+a]+1),this.__data[t]=.5*i,i=.5/i,this.__data[3]=(e.__data[3*s+a]-e.__data[3*a+s])*i,this.__data[s]=(e.__data[3*s+t]+e.__data[3*t+s])*i,this.__data[a]=(e.__data[3*a+t]+e.__data[3*t+a])*i}this.normalizeInPlace()}setFromMat4(e){const t=e.__data[0]+e.__data[5]+e.__data[10];let i;if(t>0)i=Math.sqrt(t+1),this.__data[3]=.5*i,i=.5/i,this.__data[0]=(e.__data[6]-e.__data[9])*i,this.__data[1]=(e.__data[8]-e.__data[2])*i,this.__data[2]=(e.__data[1]-e.__data[4])*i;else{let t=0;e.__data[5]>e.__data[0]&&(t=1),e.__data[10]>e.__data[4*t+t]&&(t=2);const s=(t+1)%3,a=(t+2)%3;i=Math.sqrt(e.__data[4*t+t]-e.__data[4*s+s]-e.__data[4*a+a]+1),this.__data[t]=.5*i,i=.5/i,this.__data[3]=(e.__data[4*s+a]-e.__data[4*a+s])*i,this.__data[s]=(e.__data[4*s+t]+e.__data[4*t+s])*i,this.__data[a]=(e.__data[4*a+t]+e.__data[4*t+a])*i}this.normalizeInPlace()}isIdentity(){return this.getAngle()<Number.EPSILON}getAngle(){return 2*Math.acos(this.w)}equal(e){return console.warn("Deprecated. Use #isEqual instead."),this.isEqual(e)}isEqual(e){return this.x==e.x&&this.y==e.y&&this.z==e.z&&this.w==e.w}notEquals(e){return this.x!=e.x&&this.y!=e.y&&this.z!=e.z&&this.w!=e.w}approxEqual(e,t=Number.EPSILON){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}add(e){return new pi(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addInPlace(e){this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w}subtract(e){return new pi(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}scale(e){return new pi(this.x*e,this.y*e,this.z*e,this.w*e)}scaleInPlace(e){this.x*=e,this.y*=e,this.z*=e,this.w*=e}length(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],s=this.__data[3];return Math.sqrt(e*e+t*t+i*i+s*s)}lengthSquared(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],s=this.__data[3];return e*e+t*t+i*i+s*s}normalize(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],s=this.__data[3];let a=e*e+t*t+i*i+s*s;return a<Number.EPSILON?new pi:(a=1/Math.sqrt(a),new pi(e*a,t*a,i*a,s*a))}normalizeInPlace(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],s=this.__data[3];let a=e*e+t*t+i*i+s*s;a<Number.EPSILON||(a=1/Math.sqrt(a),this.set(e*a,t*a,i*a,s*a))}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}cross(e){const t=this.x,i=this.y,s=this.z,a=this.w,r=e.x,n=e.y,o=e.z,l=e.w;return new pi(i*o-s*n,s*l-a*o,a*r-t*l,t*n-i*r)}conjugate(){return new pi(-this.x,-this.y,-this.z,this.w)}inverse(){return this.conjugate()}alignWith(e){this.dot(e)<0&&this.set(-this.x,-this.y,-this.z,-this.w)}multiply(e){const t=this.__data[0],i=this.__data[1],s=this.__data[2],a=this.__data[3],r=e.__data[0],n=e.__data[1],o=e.__data[2],l=e.__data[3];return new pi(t*l+a*r+i*o-s*n,i*l+a*n+s*r-t*o,s*l+a*o+t*n-i*r,a*l-t*r-i*n-s*o)}multiplyInPlace(e){const t=this.__data[0],i=this.__data[1],s=this.__data[2],a=this.__data[3],r=e.__data[0],n=e.__data[1],o=e.__data[2],l=e.__data[3];this.set(t*l+a*r+i*o-s*n,i*l+a*n+s*r-t*o,s*l+a*o+t*n-i*r,a*l-t*r-i*n-s*o)}rotateVec3(e){const t=new pi(e.x,e.y,e.z,0),i=this.multiply(t).multiply(this.conjugate());return new di(i.x,i.y,i.z)}rotateX(e){e*=.5;const t=this.x,i=this.y,s=this.z,a=this.w,r=Math.sin(e),n=Math.cos(e);this.x=t*n+a*r,this.y=i*n+s*r,this.z=s*n-i*r,this.w=a*n-t*r}rotateY(e){e*=.5;const t=this.x,i=this.y,s=this.z,a=this.w,r=Math.sin(e),n=Math.cos(e);this.x=t*n-s*r,this.y=i*n+a*r,this.z=s*n+t*r,this.w=a*n-i*r}rotateZ(e){e*=.5;const t=this.x,i=this.y,s=this.z,a=this.w,r=Math.sin(e),n=Math.cos(e);this.x=t*n+i*r,this.y=i*n-t*r,this.z=s*n+a*r,this.w=a*n-s*r}toMat3(){const e=this.x,t=this.y,i=this.z,s=this.w,a=e+e,r=t+t,n=i+i,o=e*a,l=t*a,h=t*r,d=i*a,c=i*r,u=i*n,m=s*a,g=s*r,_=s*n,f=new _i;return f.__data[0]=1-h-u,f.__data[3]=l-_,f.__data[6]=d+g,f.__data[1]=l+_,f.__data[4]=1-o-u,f.__data[7]=c-m,f.__data[2]=d-g,f.__data[5]=c+m,f.__data[8]=1-o-h,f}getXaxis(){const e=this.x*this.y,t=this.x*this.z,i=this.y*this.y,s=this.y*this.w,a=this.z*this.z,r=this.z*this.w;return new di(1-2*(a+i),2*(e+r),2*(t-s))}getYaxis(){const e=this.x*this.x,t=this.x*this.y,i=this.x*this.w,s=this.y*this.z,a=this.z*this.z,r=this.z*this.w;return new di(2*(t-r),1-2*(a+e),2*(s+i))}getZaxis(){const e=this.x*this.x,t=this.x*this.z,i=this.x*this.w,s=this.y*this.y,a=this.y*this.z,r=this.y*this.w;return new di,new di(2*(r+t),2*(a-i),1-2*(s+e))}mirror(e){switch(e){case 0:return new pi(this.z,this.w,this.x,this.y);case 1:return new pi(-this.w,this.z,this.y,-this.x);case 2:return new pi(this.x,this.y,this.z,-this.w)}}toMat4(){const e=this.x,t=this.y,i=this.z,s=this.w,a=e+e,r=t+t,n=i+i,o=e*a,l=t*a,h=t*r,d=i*a,c=i*r,u=i*n,m=s*a,g=s*r,_=s*n,f=new fi;return f.__data[0]=1-h-u,f.__data[4]=l-_,f.__data[8]=d+g,f.__data[1]=l+_,f.__data[5]=1-o-u,f.__data[9]=c-m,f.__data[2]=d-g,f.__data[6]=c+m,f.__data[10]=1-o-h,f}lerp(e,t){const i=new pi(this.x+t*(e.x-this.x),this.y+t*(e.y-this.y),this.z+t*(e.z-this.z),this.w+t*(e.w-this.w));return i.normalizeInPlace(),i}slerp(e,t){const i=this.dot(e),s=t/2,a=Math.acos(i);a<0&&(a=-a);const r=Math.sin(a),n=Math.sin(s*a),o=Math.sin((1-s)*a)/r,l=n/r,h=new pi(o*this.x+l*e.x,o*this.y+l*e.y,o*this.z+l*e.z,o*this.w+l*e.w);return h.normalizeInPlace(),h}static create(...e){return new pi(...e)}static createFromFloat32Buffer(e,t=0){return console.warn("Deprecated, use #createFromBuffer instead"),this.createFromBuffer(e,4*t)}static createFromBuffer(e,t){return new pi(new Float32Array(e,t,4))}static numElements(){return 4}clone(){return new pi(this.__data[0],this.__data[1],this.__data[2],this.__data[3])}toJSON(){return{x:this.x,y:this.y,z:this.z,w:this.w}}fromJSON(e){this.__data[0]=e.x,this.__data[1]=e.y,this.__data[2]=e.z,this.__data[3]=e.w,this.normalizeInPlace()}readBinary(e){this.x=e.loadFloat32(),this.y=e.loadFloat32(),this.z=e.loadFloat32(),this.w=e.loadFloat32()}}oi.register("Quat",pi);class bi{constructor(e,t){this.start=e instanceof di?e:new di,this.dir=t instanceof di?t:new di}closestPoint(e){const t=e.subtract(this.start).dot(this.dir);if(t<Number.EPSILON)return 0;const i=this.dir.dot(this.dir);return i<Number.EPSILON?0:t/i}closestPointOnLineSegment(e,t){const i=this.dir,s=t.subtract(e),a=s.length();s.normalizeInPlace();const r=this.start.subtract(e),n=i.dot(i),o=i.dot(s),l=s.dot(s),h=i.dot(r),d=s.dot(r);if(0==n&&0==l)return[this.start.distanceTo(e),0];if(0==n)return[0,0];if(0==l)return[this.closestPoint(e),0];const c=n*l-o*o;let u,m;return c<.001?(u=0,m=o>l?h/o:d/l):(u=(o*d-l*h)/c,m=(n*d-o*h)/c),[u,jt.clamp(m/a,0,1)]}pointAtDist(e){return this.start.add(this.dir.scale(e))}intersectRayVector(e){const t=this.dir,i=e.dir,s=this.start.subtract(e.start),a=t.dot(t),r=t.dot(i),n=i.dot(i),o=t.dot(s),l=i.dot(s);if(0==a&&0==n)return[0,this.start.distanceTo(e.start)];if(0==a)return[e.closestPoint(this.start),0];if(0==n)return[1,this.closestPoint(e.start)];const h=a*n-r*r;let d,c;return h<.001?(d=0,c=r>n?o/r:l/n):(d=(r*l-n*o)/h,c=(a*l-r*o)/h),[d,c]}intersectRayPlane(e){const t=this.start.subtract(e.start),i=e.dir.dot(this.dir),s=-e.dir.dot(t);if(Math.abs(i)<Number.PRECISION)return-1;const a=s/i;return a<-Number.PRECISION?-1:a}intersectRayBox3(e,t=0){const i=new di(1/this.dir.x,1/this.dir.y,1/this.dir.z),s=[];s[0]=i.x<0,s[1]=i.y<0,s[2]=i.z<0;const a=[];if(t>0){const i=e.diagonal();i.normalizeInPlace(),i.scaleInPlace(t),a[0]=e.p0.subtract(i),a[1]=e.p1.add(i)}else a[0]=e.p0,a[1]=e.p1;let r=(a[s[0]].x-this.start.x)*i.x,n=(a[1-s[0]].x-this.start.x)*i.x;const o=(a[s[1]].y-this.start.y)*i.y,l=(a[1-s[1]].y-this.start.y)*i.y;if(r>l||o>n)return!1;o>r&&(r=o),l<n&&(n=l);const h=(a[s[2]].z-this.start.z)*i.z,d=(a[1-s[2]].z-this.start.z)*i.z;return!(r>d||h>n)&&(h>r&&(r=h),d<n&&(n=d),!0)}clone(){return new bi(this.start.clone(),this.dir.clone())}static create(...e){return new bi(...e)}toJSON(){return{start:this.start,dir:this.dir}}fromJSON(e){this.start.fromJSON(e.start),this.dir.fromJSON(e.dir)}toString(){return ei.stringifyJSONWithFixedPrecision(this.toJSON())}}oi.register("Ray",bi),new di(1,1,1);class yi{constructor(e,t,i){if(e instanceof Float32Array)this.setFromFloat32Array(e);else{if(e instanceof di)this.tr=e;else{if(e instanceof pi&&null==t&&null==i)return this.tr=new di,this.ori=e,void(this.sc=new di(1,1,1));this.tr=new di}this.ori=t instanceof pi?t:new pi,this.sc=i instanceof di?i:new di(1,1,1)}}set(e,t,i){this.tr=e,this.ori=t,i instanceof di&&(this.sc=i)}setFromOther(e){this.tr=e.tr,this.ori=e.ori,this.sc=e.sc}isIdentity(){return this.tr.isNull()&&this.ori.isIdentity()&&this.sc.is111()}isEqual(e){return this.tr.isEqual(e.tr)&&this.ori.isEqual(e.ori)&&this.sc.isEqual(e.sc)}approxEqual(e,t=Number.EPSILON){return(!e.tr||this.tr.approxEqual(e.tr,t))&&(!e.ori||this.ori.approxEqual(e.ori,t))&&(!e.sc||this.sc.approxEqual(e.sc,t))}setLookAt(e,t,i){const s=e.subtract(t);if(s.length()<Number.EPSILON)throw new Error("Invalid dir");this.ori.setFromDirectionAndUpvector(s,i),this.tr=e}multiply(e){let t=this.sc;this.sc.x==this.sc.y&&this.sc.x==this.sc.z||(t=e.ori.rotateVec3(this.sc),Math.sign(t.x)!=Math.sign(this.sc.x)&&(t.x=-t.x),Math.sign(t.y)!=Math.sign(this.sc.y)&&(t.y=-t.y),Math.sign(t.z)!=Math.sign(this.sc.z)&&(t.z=-t.z));return new yi(this.tr.add(this.ori.rotateVec3(t.multiply(e.tr))),this.ori.multiply(e.ori),t.multiply(e.sc))}inverse(){const e=new yi;return e.ori=this.ori.inverse(),this.sc.x!=this.sc.y||this.sc.x!=this.sc.z?(e.sc=e.ori.rotateVec3(this.sc),Math.sign(e.sc.x)!=Math.sign(this.sc.x)&&(e.sc.x=-e.sc.x),Math.sign(e.sc.y)!=Math.sign(this.sc.y)&&(e.sc.y=-e.sc.y),Math.sign(e.sc.z)!=Math.sign(this.sc.z)&&(e.sc.z=-e.sc.z)):e.sc=this.sc.inverse(),e.tr=e.ori.rotateVec3(this.tr.negate().multiply(e.sc)),e}transformVec3(e){return this.tr.add(this.ori.rotateVec3(this.sc.multiply(e)))}toMat4(){const e=new fi(this.sc.x,0,0,0,0,this.sc.y,0,0,0,0,this.sc.z,0,0,0,0,1),t=this.ori.toMat4(),i=new fi;return i.translation=this.tr,i.multiply(t).multiply(e)}fromMat4(e){this.setFromMat4(e)}setFromMat4(e){this.tr=e.translation,this.ori.setFromMat4(e)}setFromFloat32Array(e){if(7==e.length)return this.tr=new di(e.buffer,e.byteOffset),this.ori=new pi(e.buffer,e.byteOffset+12),void(this.sc=new di(1,1,1));if(8!=e.length)return 10==e.length?(this.tr=new di(e.buffer,e.byteOffset),this.ori=new pi(e.buffer,e.byteOffset+12),void(this.sc=new di(e.buffer,e.byteOffset+21))):void 0;{this.tr=new di(e.buffer,e.byteOffset),this.ori=new pi(e.buffer,e.byteOffset+12);const t=e[7];this.sc=new di(t,t,t)}}clone(){return new yi(this.tr.clone(),this.ori.clone(),this.sc.clone())}static create(...e){return new yi(...e)}toJSON(){const e={tr:this.tr.toJSON(),ori:this.ori.toJSON()};return this.sc.is111()||(e.sc=this.sc.toJSON()),e}fromJSON(e){this.tr.fromJSON(e.tr),this.ori.fromJSON(e.ori),e.sc&&this.sc.fromJSON(e.sc)}readBinary(e){this.tr.readBinary(e),this.ori.readBinary(e),this.sc.readBinary(e)}toString(){return ei.stringifyJSONWithFixedPrecision(this.toJSON())}}oi.register("Xfo",yi);class Gi{constructor(e,t){this.p0=e instanceof hi?e:new hi(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),this.p1=t instanceof hi?t:new hi(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)}set(e,t){this.p0=e,this.p1=t}reset(){this.p0.x=Number.POSITIVE_INFINITY,this.p1.x=Number.NEGATIVE_INFINITY,this.p0.y=Number.POSITIVE_INFINITY,this.p1.y=Number.NEGATIVE_INFINITY}isValid(){return this.p0.x!=Number.POSITIVE_INFINITY&&this.p1.x!=Number.NEGATIVE_INFINITY&&this.p0.y!=Number.POSITIVE_INFINITY&&this.p1.y!=Number.NEGATIVE_INFINITY}addPoint(e){(this.p0.x==Number.POSITIVE_INFINITY||e.x<this.p0.x)&&(this.p0.x=e.x),(this.p0.y==Number.POSITIVE_INFINITY||e.y<this.p0.y)&&(this.p0.y=e.y),(this.p1.y==Number.NEGATIVE_INFINITY||e.x>this.p1.x)&&(this.p1.x=e.x),(this.p1.y==Number.NEGATIVE_INFINITY||e.y>this.p1.y)&&(this.p1.y=e.y)}size(){return this.p1.distanceTo(this.p0)}diagonal(){return this.p1.subtract(this.p0)}center(){const e=this.p1.subtract(this.p0);return e.scaleInPlace(.5),e.addInPlace(this.p0),e}static create(...e){return new Gi(...e)}toJSON(){return{p0:this.p0.toJSON(),p1:this.p1.toJSON()}}toString(){return ei.stringifyJSONWithFixedPrecision(this.toJSON())}}oi.register("Box2",Gi);class Xi extends li{constructor(e,t=0){super(),this.pos=e instanceof di?e:new di,this.radius=t}clone(){return new Sphere(this.pos.clone(),this.radius)}intersectsBox(e){return e.intersectsSphere(this)}toJSON(){return{pos:this.pos.toJSON(),radius:this.radius}}toString(){return ei.stringifyJSONWithFixedPrecision(this.toJSON())}static create(...e){return new Sphere(...e)}}oi.register("SphereType",Xi);class xi{constructor(e,t){e instanceof Float32Array?this.setFromFloat32Array(e):(this.p0=e instanceof di?e:new di(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),this.p1=t instanceof di?t:new di(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY))}get min(){return this.p0}get max(){return this.p1}set(e,t){this.p0=e,this.p1=t}reset(){this.p0.x=Number.POSITIVE_INFINITY,this.p0.y=Number.POSITIVE_INFINITY,this.p0.z=Number.POSITIVE_INFINITY,this.p1.x=Number.NEGATIVE_INFINITY,this.p1.y=Number.NEGATIVE_INFINITY,this.p1.z=Number.NEGATIVE_INFINITY}isValid(){return this.p0.x!=Number.POSITIVE_INFINITY&&this.p1.x!=Number.NEGATIVE_INFINITY&&this.p0.y!=Number.POSITIVE_INFINITY&&this.p1.y!=Number.NEGATIVE_INFINITY&&this.p0.z!=Number.POSITIVE_INFINITY&&this.p1.z!=Number.NEGATIVE_INFINITY}addPoint(e){e.x!=Number.POSITIVE_INFINITY&&e.x!=Number.NEGATIVE_INFINITY&&(e.x<this.p0.x&&(this.p0.x=e.x),e.x>this.p1.x&&(this.p1.x=e.x)),e.y!=Number.POSITIVE_INFINITY&&e.y!=Number.NEGATIVE_INFINITY&&(e.y<this.p0.y&&(this.p0.y=e.y),e.y>this.p1.y&&(this.p1.y=e.y)),e.z!=Number.POSITIVE_INFINITY&&e.z!=Number.NEGATIVE_INFINITY&&(e.z<this.p0.z&&(this.p0.z=e.z),e.z>this.p1.z&&(this.p1.z=e.z))}addBox3(e,t){t?(this.addPoint(t.transformVec3(e.p0)),this.addPoint(t.transformVec3(new di(e.p0.x,e.p0.y,e.p1.z))),this.addPoint(t.transformVec3(new di(e.p0.x,e.p1.y,e.p0.z))),this.addPoint(t.transformVec3(new di(e.p1.x,e.p0.y,e.p0.z))),this.addPoint(t.transformVec3(new di(e.p0.x,e.p1.y,e.p1.z))),this.addPoint(t.transformVec3(new di(e.p1.x,e.p0.y,e.p1.z))),this.addPoint(t.transformVec3(new di(e.p1.x,e.p1.y,e.p0.z))),this.addPoint(t.transformVec3(e.p1))):(this.addPoint(e.p0),this.addPoint(e.p1))}size(){return this.p1.distanceTo(this.p0)}diagonal(){return this.p1.subtract(this.p0)}center(){const e=this.p1.subtract(this.p0);return e.scaleInPlace(.5),e.addInPlace(this.p0),e}toMat4(){const e=this.p1.x-this.p0.x,t=this.p1.y-this.p0.y,i=this.p1.z-this.p0.z;return new fi(e,0,0,0,0,t,0,0,0,0,i,0,this.p0.x,this.p0.y,this.p0.z,1)}getBoundingSphere(){return new Xi(this.center(),.5*this.diagonal().length())}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}intersectsSphere(e){return closestPoint.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,i;return e.normal.x>0?(t=e.normal.x*this.min.x,i=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,i=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,i+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,i+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,i+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,i+=e.normal.z*this.min.z),t<=-e.constant&&i>=-e.constant}clone(){return new xi(this.p0.clone(),this.p1.clone())}static create(...e){return new xi(...e)}static sizeInBytes(){return 24}toJSON(){return{p0:this.p0.toJSON(),p1:this.p1.toJSON()}}fromJSON(e){const t={x:jt.isNumeric(e.p0.x)?e.p0.x:Number.POSITIVE_INFINITY,y:jt.isNumeric(e.p0.y)?e.p0.y:Number.POSITIVE_INFINITY,z:jt.isNumeric(e.p0.z)?e.p0.z:Number.POSITIVE_INFINITY},i={x:jt.isNumeric(e.p1.x)?e.p1.x:Number.NEGATIVE_INFINITY,y:jt.isNumeric(e.p1.y)?e.p1.y:Number.NEGATIVE_INFINITY,z:jt.isNumeric(e.p1.z)?e.p1.z:Number.NEGATIVE_INFINITY};this.p0.fromJSON(t),this.p1.fromJSON(i)}setFromFloat32Array(e){this.p0=new di(e.buffer,e.byteOffset),this.p1=new di(e.buffer,e.byteOffset+12)}toString(){return ei.stringifyJSONWithFixedPrecision(this.toJSON())}}oi.register("Box3",xi);class Ii extends li{constructor(e,t=0){super(),this.normal=e instanceof di?e:new di,this.w=t}set(e,t,i,s){this.normal.set(e,t,i),this.w=s}divideScalar(e){this.normal.scaleInPlace(1/e),this.w/=e}distanceToPoint(e){return e.dot(this.normal)+this.w}normalizeInPlace(){const e=1/this.normal.length();this.normal.scaleInPlace(e),this.w*=e}clone(){return new Plane(this.normal.clone(),this.w)}static create(...e){return new Plane(...e)}toJSON(){return{normal:this.normal.toJSON(),w:this.w}}toString(){return ei.stringifyJSONWithFixedPrecision(this.toJSON())}}oi.register("PlaneType",Ii);class Vi{constructor(e,t,i,s,a,r){this.planes=[e||new Ii,t||new Ii,i||new Ii,s||new Ii,a||new Ii,r||new Ii]}setFromMatrix(e){const t=e,i=this.planes;i[0].set(t.m03-t.m00,t.m13-t.m10,t.m23-t.m20,t.m33-t.m30),i[1].set(t.m03+t.m00,t.m13+t.m10,t.m23+t.m20,t.m33+t.m30),i[2].set(t.m03+t.m01,t.m13+t.m11,t.m23+t.m21,t.m33+t.m31),i[3].set(t.m03-t.m01,t.m13-t.m11,t.m23-t.m21,t.m33-t.m31),i[4].set(t.m03-t.m02,t.m13-t.m12,t.m23-t.m22,t.m33-t.m32),i[5].set(t.m03+t.m02,t.m13+t.m12,t.m23+t.m22,t.m33+t.m32),i.forEach((e=>e.normalizeInPlace()))}intersectsBox(e){const t=new di,i=this.planes,{min:s,max:a}=e;for(let e=0;e<6;e++){const r=i[e];if(t.x=r.normal.x>0?a.x:s.x,t.y=r.normal.y>0?a.y:s.y,t.z=r.normal.z>0?a.z:s.z,r.distanceToPoint(t)<0)return!1}return!0}toJSON(){return{p0:this.p0.toJSON(),p1:this.p1.toJSON(),p2:this.p2.toJSON(),p3:this.p3.toJSON(),p4:this.p4.toJSON(),p5:this.p5.toJSON()}}fromJSON(e){this.p0.fromJSON(e.p0),this.p1.fromJSON(e.p1),this.p2.fromJSON(e.p2),this.p3.fromJSON(e.p3),this.p4.fromJSON(e.p4),this.p5.fromJSON(e.p5)}toString(){return ei.stringifyJSONWithFixedPrecision(this.toJSON())}}oi.register("Frustum",Vi);var vi=Object.freeze({__proto__:null,AttrValue:li,Vec2:hi,Vec3:di,Vec4:ci,RGBA:ui,Color:mi,EulerAngles:gi,Quat:pi,Ray:bi,Mat3:_i,Mat4:fi,Xfo:yi,Box2:Gi,Box3:xi,Frustum:Vi,PlaneType:Ii,SphereType:Xi});let Ri=0;class wi extends Jt{constructor(){if(super(),"RefCounted"==this.constructor.name)throw new Error("RefCounted should not be instantiated directly.");this.__id=++Ri,this.__refs=[],this.__destroyed=!1}getId(){return this.__id}numRefs(){return this.__refs.length}addRef(e){if(!e)throw new Error("Error in RefCounted.addRef: Must provide a referer");return this.__refs.push(e),!0}removeRef(e){if(!e)throw new Error("Error in RefCounted.removeRef: Must provide a referer");const t=this.__refs.indexOf(e);if(-1==t)throw new Error("Error in RefCounted.removeRef: referer not found in refs list.");this.__refs.splice(t,1),0==this.__refs.length&&this.destroy()}getRefer(e){return this.__refs[e]}getRefIndex(e){return this.__refs.indexOf(e)}isDestroyed(){return this.__destroyed}destroy(){this.__destroyed=!0,this.emit("destructing",{})}}class Mi extends Jt{constructor(){super(),this.__params=[],this.__paramMapping={},this.deprecatedParamMapping={},this.__paramEventHandlers={}}numParameters(){return console.warn("Deprecated. Use #getNumParameters instead."),this.getNumParameters()}getNumParameters(){return this.__params.length}getParameters(){return this.__params}getParameterIndex(e){return this.__paramMapping[e]}getParameterByIndex(e){return this.__params[e]}hasParameter(e){return e in this.__paramMapping}addParameterDeprecationMapping(e,t){this.deprecatedParamMapping[e]=t}getParameter(e){let t=this.__paramMapping[e];if(null==t){const i=this.deprecatedParamMapping[e];if(!i)return null;console.warn(`Parameter name ${e} is now deprecated. Please use ${i} instead.`),t=this.__paramMapping[i]}return this.__params[t]}__parameterValueChanged(e){this.emit("parameterValueChanged",e)}addParameter(e){return this.insertParameter(e,this.__params.length)}insertParameter(e,t){const i=e.getName();null!=this.__paramMapping[i]&&(console.warn("Replacing Parameter:"+i),this.removeParameter(i)),e.setOwner(this);const s=t=>{const i={param:e};for(const e in t)i[e]=t[e];this.__parameterValueChanged(i)};e.on("valueChanged",s),this.__paramEventHandlers[i]=s,this.__params.splice(t,0,e);for(let e=t;e<this.__params.length;e++)this.__paramMapping[this.__params[e].getName()]=e;return this.emit("parameterAdded",{name:i}),e}removeParameter(e){if(null==this.__paramMapping[e])throw new Error("Unable to remove Parameter:"+e);const t=this.__paramMapping[e];this.__params[this.__paramMapping[e]].off("valueChanged",this.__paramEventHandlers[e]),this.__params.splice(t,1),delete this.__paramMapping[e];for(let e=t;e<this.__params.length;e++)this.__paramMapping[this.__params[e].getName()]=e;this.emit("parameterRemoved",{name:e})}replaceParameter(e){const t=e.getName();if(null==this.__paramMapping[t])throw new Error("Unable to replace Parameter:"+paramName);const i=this.__paramMapping[t];return this.removeParameter(t),this.insertParameter(e,i),e}toJSON(e){const t={},i={};let s=0;for(const t of this.__params){const a=t.toJSON(e);a&&(i[t.getName()]=a,s++)}return s>0&&(t.params=i),t}fromJSON(e,t){if(e.params)for(const i in e.params){const s=e.params[i],a=this.getParameter(i);a?s.paramPath?t.resolvePath(s.paramPath,(e=>{this.replaceParameter(e)}),(e=>{console.warn("Unable to resolve shared parameter:"+s.paramPath)})):a.fromJSON(s,t):console.warn("Param not found:"+i)}}readBinary(e,t){if(t.versions["zea-engine"].compare([0,0,3])>=0){const i=e.loadUInt32();for(let s=0;s<i;s++){const i=e.loadStr(),s=e.loadStr();let a=this.getParameter(s);if(!a){if(a=oi.constructClass(i,s),!a){console.error("Unable to construct prop:"+s+" of type:"+i);continue}this.addParameter(a)}a.readBinary(e,t)}}}toString(){return JSON.stringify(this.toJSON(),null,2)}copyFrom(e,t){let i=e.getNumParameters();for(;i--;){const s=e.getParameterByIndex(i),a=this.getParameter(s.getName());a?a.loadValue(s.getValue()):this.addParameter(s.clone(t))}}}class Ti{constructor(e,t=0,i=!0){this.__data=e,this.__byteOffset=t,this.__dataView=new DataView(this.__data),this.__isMobileDevice=i,this.utf8decoder=new TextDecoder}get isMobileDevice(){return this.__isMobileDevice}get data(){return this.__data}get byteLength(){return this.__dataView.byteLength}get remainingByteLength(){return this.__dataView.byteLength-this.__byteOffset}pos(){return this.__byteOffset}seek(e){this.__byteOffset=e}advance(e){this.__byteOffset+=e}loadUInt8(){const e=this.__dataView.getUint8(this.__byteOffset);return this.__byteOffset+=1,e}loadUInt16(){const e=this.__dataView.getUint16(this.__byteOffset,!0);return this.__byteOffset+=2,e}loadUInt32(){const e=this.__dataView.getUint32(this.__byteOffset,!0);return this.__byteOffset+=4,e}loadSInt32(){const e=this.__dataView.getInt32(this.__byteOffset,!0);return this.__byteOffset+=4,e}loadFloat16(){const e=this.loadUInt16();return jt.decode16BitFloat(e)}loadUFloat16(){const e=this.loadFloat16();return e<0?2048-e:e}loadFloat16From2xUInt8(){const e=this.__dataView.getFloat16(this.__byteOffset,!0);return this.__byteOffset+=2,e}loadUInt32From2xUFloat16(){return this.loadUFloat16()+4096*this.loadUFloat16()}loadSInt32From2xFloat16(){return this.loadFloat16()+2048*this.loadFloat16()}loadFloat32(){const e=this.__dataView.getFloat32(this.__byteOffset,!0);return this.__byteOffset+=4,e}loadUInt8Array(e,t=!1){null==e&&(e=this.loadUInt32());const i=new Uint8Array(this.__data,this.__byteOffset,e);return this.__byteOffset+=e,this.__byteOffset,i}loadUInt16Array(e,t=!1){if(null==e&&(e=this.loadUInt32()),0==e)return new Uint16Array;let i;if(this.readPad(2),this.__isMobileDevice){i=new Uint16Array(e);for(let t=0;t<e;t++)i[t]=this.__dataView.getUint16(this.__byteOffset,!0),this.__byteOffset+=2}else i=new Uint16Array(this.__data,this.__byteOffset,e),this.__byteOffset+=2*e;return i}loadUInt32Array(e,t=!1){if(null==e&&(e=this.loadUInt32()),0==e)return new Uint32Array;let i;if(this.readPad(4),this.__isMobileDevice){i=new Uint32Array(e);for(let t=0;t<e;t++)i[t]=this.__dataView.getUint32(this.__byteOffset,!0),this.__byteOffset+=4}else i=new Uint32Array(this.__data,this.__byteOffset,e),this.__byteOffset+=4*e;return i}loadFloat32Array(e,t=!1){if(null==e&&(e=this.loadUInt32()),0==e)return new Float32Array;let i;if(this.readPad(4),this.__isMobileDevice){i=new Float32Array(e);for(let t=0;t<e;t++)i[t]=this.__dataView.getFloat32(this.__byteOffset,!0),this.__byteOffset+=4}else i=new Float32Array(this.__data,this.__byteOffset,e),this.__byteOffset+=4*e;return i}loadStr(){const e=this.loadUInt32(),t=new Uint8Array(this.__data,this.__byteOffset,e);return this.__byteOffset+=e,this.utf8decoder.decode(t)}loadStrArray(){const e=this.loadUInt32(),t=[];for(let i=0;i<e;i++)t[i]=this.loadStr();return t}loadSInt32Vec2(){const e=this.loadSInt32(),t=this.loadSInt32();return new hi(e,t)}loadUInt32Vec2(){const e=this.loadUInt32(),t=this.loadUInt32();return new hi(e,t)}loadFloat16Vec2(){const e=this.loadFloat16(),t=this.loadFloat16();return new hi(e,t)}loadFloat32Vec2(){const e=this.loadFloat32(),t=this.loadFloat32();return new hi(e,t)}loadFloat16Vec3(){const e=this.loadFloat16(),t=this.loadFloat16(),i=this.loadFloat16();return new di(e,t,i)}loadFloat32Vec3(){const e=this.loadFloat32(),t=this.loadFloat32(),i=this.loadFloat32();return new di(e,t,i)}loadFloat16Quat(){const e=this.loadFloat16(),t=this.loadFloat16(),i=this.loadFloat16(),s=this.loadFloat16();return new pi(e,t,i,s)}loadFloat32Quat(){const e=this.loadFloat32(),t=this.loadFloat32(),i=this.loadFloat32(),s=this.loadFloat32();return new pi(e,t,i,s)}loadRGBFloat32Color(){const e=this.loadFloat32(),t=this.loadFloat32(),i=this.loadFloat32();return new mi(e,t,i)}loadRGBAFloat32Color(){const e=this.loadFloat32(),t=this.loadFloat32(),i=this.loadFloat32(),s=this.loadFloat32();return new mi(e,t,i,s)}loadRGBUInt8Color(){const e=this.loadUInt8(),t=this.loadUInt8(),i=this.loadUInt8();return new mi(e/255,t/255,i/255)}loadRGBAUInt8Color(){const e=this.loadUInt8(),t=this.loadUInt8(),i=this.loadUInt8(),s=this.loadUInt8();return new mi(e/255,t/255,i/255,s/255)}loadBox2(){return new Gi(this.loadFloat32Vec2(),this.loadFloat32Vec2())}loadBox3(){return new xi(this.loadFloat32Vec3(),this.loadFloat32Vec3())}readPad(e){const t=this.__byteOffset%e;0!=t&&(this.__byteOffset+=e-t)}}let Li=0;class Si extends Mi{constructor(e){super(),this.__name=e||"",this.__path=[this.__name],this.__ownerItem=void 0,this.__selectable=!0,this.__selected=!1,this.__metaData={},Li++}static getNumBaseItems(){return Li}getName(){return this.__name}setName(e){if(this.__name!=e){const t=this.__name;this.__name=e,this.__updatePath(),this.emit("nameChanged",{newName:e,oldName:t})}}__updatePath(){null==this.__ownerItem?this.__path=[this.__name]:this.__path=[...this.__ownerItem.getPath(),this.__name]}getPath(){return this.__path}resolvePath(e,t=0){if(0==t&&("."!=e[0]&&e[0]!=this.__name||t++),t==e.length)return this;if(">"==e[t]&&t==e.length-1)return this.getParameter(e[t+1]);const i=this.getParameter(e[t]);if(i)return i;throw new Error("Invalid path:"+e+"["+t+"] member not found")}getOwner(){return this.__ownerItem}setOwner(e){this.__ownerItem!==e&&(this.__ownerItem=e,this.__updatePath())}getSelectable(){return this.__selectable}setSelectable(e){return this.__selectable!=e&&(this.__selectable=e,!0)}isSelected(){return this.__selected}getSelected(){return this.__selected}setSelected(e){this.__selected=e,this.emit("selectedChanged",{selected:this.__selected})}getMetadata(e){return this.__metaData[e]}hasMetadata(e){return e in this.__metaData}setMetadata(e,t){this.__metaData[e]=t}deleteMetadata(e){delete this.__metaData[e]}toJSON(e){const t=super.toJSON(e);return t.name=this.__name,t.type=oi.getBlueprintName(this),t}fromJSON(e,t){e.name&&(this.__name=e.name),super.fromJSON(e,t)}readBinary(e,t){e.loadStr(),this.setName(e.loadStr()),super.readBinary(e,t)}clone(e){throw new Error(this.constructor.name+" does not implement its clone method")}copyFrom(e,t){super.copyFrom(e,t),this.setName(e.getName())}}const Zi=function(e){return e.substring(0,e.lastIndexOf("/"))+"/"},Ci=function(e,t,i,s,a){try{const a=new XMLHttpRequest;a.responseType=t,a.addEventListener("timeout",(function(t){throw new Error("The request for "+e+" timed out.")})),a.addEventListener("error",(function(t){throw new Error("The request for "+e+": xhr.readyState:"+a.readyState)})),a.addEventListener("abort",(function(t){throw new Error("The request for "+e+": xhr.readyState:"+a.readyState)})),a.addEventListener("loadend",(function(e){200==a.status?i(a):s(a.statusText)})),a.open("GET",e,!0),a.send()}catch(e){s(e)}},Fi=function(e,t,i,s){Ci(e,"text",(e=>{t(e.responseText)}),(t=>{if(null==i)throw new Error("Unable to XHR File:"+e);i(t)}))},Ei=function(e,t,i,s){Ci(e,"json",(e=>{t(e.response,e)}),(t=>{if(null==i)throw new Error("Unable to XHR File:"+e);i(t)}))},zi=function(e,t,i,s){Ci(e,"document",(e=>{t(e.responseXML)}),(t=>{if(null==i)throw new Error("Unable to XHR File:"+e);i(t)}))},Ni=function(e,t,i,s){Ci(e,"arraybuffer",(e=>{t(e.response)}),(t=>{if(null==i)throw new Error("Unable to XHR File:"+e);i(t)}))},Pi={OP_WRITE:0,OP_READ_WRITE:1};class Wi extends Jt{constructor(e,t,i){super(),this.__name=e,this.__value=t,this.__dataType=i||void 0,this.__boundOps=[],this.__dirtyOpIndex=0,this.__cleaning=!1,this.getName=this.getName.bind(this),this.setName=this.setName.bind(this),this.getValue=this.getValue.bind(this),this.setValue=this.setValue.bind(this)}clone(){return new Wi(this.__name,this.__value,this.__dataType)}getName(){return this.__name}setName(e){if(e===this.__name)return this;const t=this.__name;this.__name=e,this.emit("nameChanged",{newName:this.__name,prevName:t})}getOwner(){return this.ownerItem}setOwner(e){this.ownerItem=e}getPath(){return this.ownerItem&&this.ownerItem.getName?[...this.ownerItem.getPath(),this.__name]:[this.__name]}getDataType(){return this.__dataType}bindOperatorOutput(e,t=-1){-1==t&&(t=this.__boundOps.length),this.__boundOps.splice(t,0,e);for(let e=t;e<this.__boundOps.length;e++)this.__boundOps[e].setParamBindIndex(e);return this.__findFirstOP_WRITE(),this.setDirty(t)||this.emit("valueChanged",{mode:0}),t}unbindOperator(e){const t=e.getParamBindIndex();this.__boundOps.splice(t,1);for(let e=t;e<this.__boundOps.length;e++)this.__boundOps[e].setParamBindIndex(e);return this.__findFirstOP_WRITE(),this.setDirty(Math.max(0,t-1)),t}__findFirstOP_WRITE(){if(this.__firstOP_WRITE=this.__boundOps.length,this.__boundOps.length>0)for(this.__firstOP_WRITE--;this.__firstOP_WRITE>0&&this.__boundOps[this.__firstOP_WRITE].getMode()!=Pi.OP_WRITE;this.__firstOP_WRITE--);}setDirty(e){if(e<this.__dirtyOpIndex){let t=this.__firstOP_WRITE;if(t<=e){for(this.__dirtyOpIndex=t,t++;t<this.__boundOps.length;t++)t!=e&&this.__boundOps[t].getOperator().setDirty();return this.emit("valueChanged",{mode:0}),!0}}return!1}isDirty(){return this.__dirtyOpIndex<this.__boundOps.length}getDirtyBindingIndex(){return this.__dirtyOpIndex}setCleanFromOp(e,t){if(t!=this.__dirtyOpIndex)if(t<this.__dirtyOpIndex)console.log("Parameter is cleaned when it was already clean to that point in the stack:",this.getPath());else if(this.__boundOps[t].getMode()!=Pi.OP_WRITE){const e=oi.getBlueprintName(this),i=this.__boundOps[t].getOperator(),s=oi.getBlueprintName(i);throw new Error(`Parameter: ${e} with name: ${this.getName()} is not cleaning all outputs during evaluation of op: ${s} with name: ${i.getName()}`)}this.__value=e,this.__dirtyOpIndex=t+1}getValueFromOp(e){return this.__dirtyOpIndex<e&&this._clean(e),this.__value}_clean(e){if(this.__cleaning)throw new Error(`Cycle detected when cleaning: ${this.getPath()}. Operators need to be rebound to fix errors`);for(this.__cleaning=!0;this.__dirtyOpIndex<e;){const e=this.__dirtyOpIndex;if(this.__boundOps[this.__dirtyOpIndex].getOperator().evaluate(),e==this.__dirtyOpIndex){const e=this.__boundOps[this.__dirtyOpIndex].getOperator(),t=oi.getBlueprintName(e);console.warn(`Operator: ${t} with name: ${e.getName()} is not cleaning its outputs during evaluation`),this.__dirtyOpIndex++}}this.__cleaning=!1}getValue(e){return null!=e&&console.warn("WARNING in Parameter.setValue: 'mode' is deprecated."),this.__dirtyOpIndex<this.__boundOps.length&&this._clean(this.__boundOps.length),this.__value}setValue(e){if(null==e)throw"undefined was passed into the set value for param:"+this.getName();if(this.__boundOps.length>0)for(let t=this.__boundOps.length-1;t>=0;t--){const i=this.__boundOps[t];if(e=i.backPropagateValue(e),0==i.getMode())return}(e.fromJSON||this.__value!=e)&&(this.__value=e,this.emit("valueChanged",{}))}loadValue(e){this.__value=e}toJSON(e){return this.__value.toJSON?{value:this.__value.toJSON(e)}:{value:this.__value}}fromJSON(e,t){null!=e.value?(e.value.type&&null==this.__value&&(this.__value=oi.constructClass(e.value.type)),null!=this.__value&&this.__value.fromJSON?this.__value.fromJSON(e.value,t):this.__value=e.value,this.emit("valueChanged",{})):console.warn("Invalid Parameter JSON")}readBinary(e,t){console.warn(`TODO: Parameter: ${this.constructor.name} with name: ${this.__name} does not implement readBinary`)}clone(){const e=this.__value;e.clone&&(e=e.clone());return new Wi(this.__name,e,this.__dataType)}}class Bi extends Wi{constructor(e,t=0,i,s){super(e,t,"Number"),i&&!Array.isArray(i)&&console.error("Range value must be an array of 2 numbers."),this.__range=i,this.__step=s}getRange(){return this.__range}setRange(e){this.__range=e}getStep(){return this.__step}setStep(e){this.__step=e}toJSON(e){const t=super.toJSON(e);return this.__range&&(t.range=this.__range),this.__step&&(t.step=this.__step),t}fromJSON(e,t){super.fromJSON(e,t),e.range&&(this.__range=e.range),e.step&&(this.__step=e.step)}readBinary(e,t){this.__value=e.loadFloat32()}clone(){return new Bi(this.__name,this.__value,this.__range,this.__step)}}oi.register("NumberParameter",Bi),oi.register("Property_SInt32",Bi),oi.register("Property_UInt32",Bi),oi.register("Property_Float32",Bi);class Yi extends Bi{constructor(e,t,i){super(e,t,[0,i.length],1),this.choices=i}getChoices(){return this.choices}setValue(e){"string"==typeof e?super.setValue(this.choices.indexOf(e)):super.setValue(e)}}oi.register("MultiChoiceParameter",Yi);class Ai extends Wi{constructor(e,t){super(e,t,"Boolean")}readBinary(e,t){this.__value=0!=e.loadUInt8()}clone(){return new Ai(this.__name,this.__value)}}oi.register("BooleanParameter",Ai);class Di extends Wi{constructor(e,t,i){super(e,t||new hi,"Vec2"),this.__range=i}getRange(){return this.__range}__setRange(e){this.__range=e,this.emit("rangeChanged",{range:e})}readBinary(e,t){this.__value.readBinary(e)}clone(){return new Di(this.__name,this.__value.clone())}}oi.register("Vec2Parameter",Di);class ki extends Wi{constructor(e,t,i){super(e,t||new di,"Vec3")}readBinary(e,t){this.__value.readBinary(e)}clone(){return new ki(this.__name,this.__value.clone())}}oi.register("Vec3Parameter",ki);class Ki extends Wi{constructor(e,t){super(e,t||new ci,"Vec4")}readBinary(e,t){this.__value.readBinary(e)}clone(){return new Ki(this.__name,this.__value.clone())}}oi.register("Vec4Parameter",Ki);class Hi extends Wi{constructor(e,t){super(e,t||new mi,"Color")}readBinary(e,t){const i=e.loadRGBAFloat32Color();i.applyGamma(2.2),this.__value=i}clone(){return new Hi(this.__name,this.__value.clone())}}oi.register("ColorParameter",Hi);class Ui extends Wi{constructor(e,t){super(e,t||new pi,"Quat")}readBinary(e,t){this.__value.readBinary(e)}clone(){return new Ui(this.__name,this.__value.clone())}}oi.register("QuatParameter",Ui);class Oi extends Wi{constructor(e,t){super(e,t||new _i,"Mat3")}readBinary(e,t){this.__value.readBinary(e)}clone(){return new Oi(this.__name,this.__value.clone())}}oi.register("Mat3Parameter",Oi);class Ji extends Wi{constructor(e,t){super(e,t||new fi,"Mat4")}readBinary(e,t){this.__value.readBinary(e)}clone(){return new Ji(this.__name,this.__value.clone())}}oi.register("Mat4Parameter",Ji);class Qi extends Wi{constructor(e,t){super(e,t||new yi,"Xfo")}readBinary(e,t){this.__value.readBinary(e)}clone(){return new Qi(this.__name,this.__value.clone())}}oi.register("XfoParameter",Qi);class ji extends Wi{constructor(e,t){super(e,t,"BaseImage")}toJSON(e){const t=super.toJSON(e);return this.__value&&(t.imageType=oi.getBlueprintName(this.__value)),t}fromJSON(e,t){return e.imageType&&(this.__value=oi.constructClass(e.imageType)),super.fromJSON(e,t)}clone(){return new ji(this.__name,this.__value)}}oi.register("ImageParameter",ji);class qi extends Wi{constructor(e,t=""){super(e,t,"String"),this.multiLine=!1}setMultiLine(e){this.multiLine=e}getMultiLine(){return this.multiLine}readBinary(e,t){this.__value=e.loadStr()}clone(){return new qi(this.__name,this.__value)}}oi.register("StringParameter",qi),oi.register("Property_String",qi);class $i extends qi{constructor(e,t=""){super(e,t,"String"),this.lang="js"}setLanguage(e){this.lang=e}getLanguage(){return this.lang}clone(){return new $i(this.__name,this.__value)}}oi.register("CodeParameter",$i);class es extends Wi{constructor(e,t){super(e,[]),this.__dataType=t}__filter(e){return!0}getCount(){return this.__value.length}getElement(e){return this.__value[e]}setElement(e,t){this.__value[e]=t,this.emit("valueChanged",{})}addElement(e){if(null==e)e=new this.__dataType;else if(!this.__filter(e))return;return this.__value.push(e),this.emit("elementAdded",{elem:e,index:this.__value.length-1}),this.emit("valueChanged",{}),e}removeElement(e){const t=this.__value[e];this.__value.splice(e,1),this.emit("elementRemoved",{elem:t,index:e}),this.emit("valueChanged",{})}insertElement(e,t){this.__filter(t)&&(this.__value.splice(e,0,t),this.emit("elementAdded",{elem:t,index:e}),this.emit("valueChanged",{}))}toJSON(e){const t=[];for(const i of this.__value)"string"==typeof this.__dataType?t.push(i):t.push(i.toJSON(e));return{items:t}}fromJSON(e,t){if(null!=e.items){this.__value=[];for(let i=0;i<e.items.length;i++){let s;"string"==typeof this.__dataType?s=e.items[i]:(console.log(this.__dataType),s=new this.__dataType,s.fromJSON(e.items[i],t)),this.__value.push(s),this.emit("elementAdded",{elem:s,index:this.__value.length-1})}this.emit("valueChanged",{mode:0})}else console.warn("Invalid Parameter JSON")}clone(){const e=this.__value.slice(0),t=new es(this.__name,this.__dataType);return t.setValue(e),t}destroy(){for(let e=0;e<this.__value.length;e++)this.__value[e]instanceof Wi&&this.__value[e].destroy(),this.removeElement(e)}}oi.register("ListParameter",es);class ts extends Wi{constructor(e){super(e,{},"Struct"),this.__members=[]}_addMember(e){return this.__value[e.getName()]=e.getValue(),e.on("valueChanged",(()=>{this.__value[e.getName()]=e.getValue()})),this.__members.push(e),this.emit("valueChanged",{}),e}getParameter(e){for(const t of this.__members)if(t.getName()==e)return t}getMember(e){return this.getParameter(e)}getMemberNames(){const e=[];for(let t=0;t<this.__members.length;t++){const i=this.__members[t];null!=i&&(e[t]=i.getName())}return e}toJSON(e){const t=[];for(const i of this.__members)t.push(i.toJSON(e));return{members:t}}fromJSON(e,t){if(null!=e.members)for(let i=0;i<e.members.length;i++)e.members[i]&&this.__members[i].fromJSON(e.members[i],t);else console.warn("Invalid Parameter JSON")}destroy(){super.destroy();for(const e of this.__members)e.destroy()}}oi.register("StructParameter",ts);class is extends Wi{constructor(e,t){super(e,void 0,"TreeItem"),this.__filterFn=t,this.__emitTreeItemGlobalXfoChanged=this.__emitTreeItemGlobalXfoChanged.bind(this)}__emitTreeItemGlobalXfoChanged(e){this.emit("treeItemGlobalXfoChanged",e)}setOwner(e){this.__owner=e}getOwner(){return this.__owner}setFilterFn(){this.__filterFn=filterFn}getFilterFn(){return this.__filterFn}setValue(e){if(this.__filterFn&&!this.__filterFn(e))return!1;this.__value!==e&&(this.__value&&this.__value.off("globalXfoChanged",this.__emitTreeItemGlobalXfoChanged),this.__value=e,this.__value&&this.__value.on("globalXfoChanged",this.__emitTreeItemGlobalXfoChanged),this.emit("valueChanged",{}))}toJSON(e){return{value:e.makeRelative(this.__value.getPath())}}fromJSON(e,t){null!=e.value?t.resolvePath(e.value,(e=>{this.setValue(e)}),(()=>{console.warn("Unable to resolve tree item parameter value:"+pj.paramPath)})):console.warn("Invalid Parameter JSON")}clone(){return new is(this.__name,this.__filterFn)}destroy(){this.__value&&this.__value.off("globalXfoChanged",this.__emitTreeItemGlobalXfoChanged)}}oi.register("TreeItemParameter",is);class ss extends Wi{constructor(e,t){super(e,void 0,"BaseItem"),this.__items=new Set,this.__filterFn=t}setFilterFn(e){this.__filterFn=e}getFilterFn(){return this.__filterFn}getItem(e){return Array.from(this.__items)[e]}addItem(e,t=!0){if(this.__filterFn&&!this.__filterFn(e))return console.warn("ItemSet __filterFn rejecting item:",e.getPath()),!1;this.__items.add(e);const i=Array.from(this.__items).indexOf(e);return this.emit("itemAdded",{item:e,index:i}),t&&this.emit("valueChanged",{}),i}addItems(e,t=!0){e.forEach((e=>this.addItem(e,!1))),t&&this.emit("valueChanged",{})}removeItem(e,t=!0){const i=Array.from(this.__items)[e];return this.__items.delete(i),this.emit("itemRemoved",{item:i,index:e}),t&&this.emit("valueChanged",{}),i}setItems(e,t=!0){for(let t=this.__items.length-1;t>=0;t--){const i=this.__items[t];e.has(i)||this.removeItem(i,!1)}for(const t of e)this.__items.has(t)||this.addItem(t,!1);t&&this.emit("valueChanged",{})}clearItems(e=!0){this.__items.clear(),e&&this.emit("valueChanged",{})}getNumItems(){return Array.from(this.__items).length}getValue(){return this.__items}toJSON(e){return{}}fromJSON(e,t){}clone(){return new ss(this.__name,this.__filterFn)}}class as extends Wi{constructor(e,t){super(e,void 0,"Geometry"),this.__emitBoundingBoxDirtied=this.__emitBoundingBoxDirtied.bind(this),this.setValue(t)}__emitBoundingBoxDirtied(e){this.emit("boundingBoxChanged",e)}setValue(e){this.__value!==e&&(this.__value&&this.__value.off("boundingBoxChanged",this.__emitBoundingBoxDirtied),this.__value=e,this.__value&&this.__value.on("boundingBoxChanged",this.__emitBoundingBoxDirtied),this.emit("valueChanged",{}))}loadValue(e){this.__value&&this.__value.off("boundingBoxChanged",this.__emitBoundingBoxDirtied),this.__value=e,this.__value&&this.__value.on("boundingBoxChanged",this.__emitBoundingBoxDirtied)}toJSON(e){return super.toJSON(e)}fromJSON(e,t){return super.fromJSON(e,t)}clone(){return new as(this.__name,this.__value)}destroy(){this.__value&&this.__value.off("boundingBoxChanged",this.__emitBoundingBoxDirtied)}}oi.register("GeometryParameter",as);class rs extends Jt{constructor(e){super(),this.__name=e,this._param=void 0,this._paramValueChanged=this._paramValueChanged.bind(this)}getName(){return this.__name}setOperator(e){this._op=e}getOperator(){return this._op}isConnected(){return null!=this._param}getParam(){return this._param}_paramValueChanged(e){this._op&&this._op.setDirty(this.__name)}setParam(e){this._param&&this._param.off("valueChanged",this._paramValueChanged),this._param=e,this._param&&this._param.on("valueChanged",this._paramValueChanged),this.emit("paramSet",{param:this._param})}getValue(){if(this._param)return this._param.getValue()}setValue(e){this._param&&this._param.setValue(e)}toJSON(e){const t=this._param?this._param.getPath():"";return{name:this.__name,paramPath:e&&e.makeRelative?e.makeRelative(t):t}}fromJSON(e,t){e.paramPath&&t.resolvePath(e.paramPath,(e=>{this.setParam(e)}),(t=>{console.warn("OperatorInput: '"+this.getName()+"'. Unable to connect to:"+e.paramPath)}))}detach(){this._param&&this._param.off("valueChanged",this._paramValueChanged)}reattach(){this.detached=!1,this._param&&this._param.on("valueChanged",this._paramValueChanged)}}class ns extends Jt{constructor(e,t=Pi.OP_WRITE){super(),this.__name=e,this._mode=t,this._param=void 0,this._paramBindIndex=-1,this.detached=!1}getName(){return this.__name}setOperator(e){this._op=e}getOperator(){return this._op}getMode(){return this._mode}isConnected(){return null!=this._param}getParam(){return this._param}setParam(e,t=-1){this._param&&this._param.unbindOperator(this),this._param=e,this._param&&(this._paramBindIndex=this._param.bindOperatorOutput(this,t)),this.emit("paramSet",{param:this._param})}getParamBindIndex(){return this._paramBindIndex}setParamBindIndex(e){this._paramBindIndex=e}setDirty(){this._param&&this._param.setDirty(this._paramBindIndex)}getValue(){if(this._param)return this._param.getValueFromOp(this._paramBindIndex);throw new Error("Cannot call getValue on OperatorOutput that is not connected:",this.__name)}backPropagateValue(e){return this._param&&(e=this._op.backPropagateValue(e,this)),e}setClean(e){this._param&&this._param.setCleanFromOp(e,this._paramBindIndex)}toJSON(e){const t=this._param?this._param.getPath():"";return{name:this.__name,paramPath:e&&e.makeRelative?e.makeRelative(t):t,paramBindIndex:this._paramBindIndex}}fromJSON(e,t){e.paramPath&&t.resolvePath(e.paramPath,(t=>{this.setParam(t,e.paramBindIndex)}),(t=>{console.warn("OperatorOutput: '"+this.getName()+"'. Unable to connect to:"+e.paramPath)}))}detach(){this.detached=!0,this._paramBindIndex=this._param?this._param.unbindOperator(this):-1}reattach(){this.detached=!1,this._param&&(this._paramBindIndex=this._param.bindOperatorOutput(this,this._paramBindIndex))}rebind(){this._param&&(this._param.unbindOperator(this),this._paramBindIndex=this._param.bindOperatorOutput(this))}}class os extends Si{constructor(e){super(e),this.__inputs=new Map,this.__outputs=new Map}setDirty(){this.__outputs.forEach((e=>e.setDirty()))}__parameterValueChanged(e){super.__parameterValueChanged(e),this.setDirty()}addInput(e){if("string"==typeof e)e=new rs(e);else if(!(e instanceof rs))throw new Error("addInput only accepts string or OperatorInput");return e.setOperator(this),this.__inputs.set(e.getName(),e),this.setDirty(),e}removeInput(e){if("string"==typeof e&&(e=this.getInput(e)),!(e instanceof rs))throw new Error("removeInput only accepts string or OperatorInput");e.getParam()&&e.setParam(null),this.__inputs.delete(e.getName())}getNumInputs(){return this.__inputs.size}getInputByIndex(e){return Array.from(this.__inputs.values())[e]}getInput(e){return this.__inputs.get(e)}addOutput(e){if("string"==typeof e)e=new ns(e);else if(!(e instanceof ns))throw new Error("addOutput only accepts string or OperatorOutput");if(e.setOperator(this),this.getOutput(e.getName()))throw new Error(`Operator output already exists ${e.getName()}`);return this.__outputs.set(e.getName(),e),this.setDirty(),e}removeOutput(e){if("string"==typeof e&&(e=this.getOutput(e)),!(e instanceof ns))throw new Error("removeOutput only accepts string or OperatorInput");e.getParam()&&e.setParam(null),this.__outputs.delete(e.getName())}getNumOutputs(){return this.__outputs.size}getOutputByIndex(e){return Array.from(this.__outputs.values())[e]}getOutput(e){return this.__outputs.get(e)}evaluate(){throw new Error("Not yet implemented")}backPropagateValue(e){return e}toJSON(e){const t=super.toJSON(e);t.type=oi.getBlueprintName(this);const i=[];this.__inputs.forEach((t=>{i.push(t.toJSON(e))})),t.inputs=i;const s=[];return this.__outputs.forEach((t=>{s.push(t.toJSON(e))})),t.outputs=s,t}fromJSON(e,t){super.fromJSON(e,t),e.inputs&&e.inputs.forEach(((e,i)=>{let s;e.name?(s=this.getInput(e.name),s||(s=this.addInput(e.name))):s=this.getInputByIndex(i),s.fromJSON(e,t)})),e.outputs&&e.outputs.forEach(((e,i)=>{let s;e.name?(s=this.getOutput(e.name),s||(s=this.addOutput(e.name))):s=this.getOutputByIndex(i),s.fromJSON(e,t)}))}detach(){this.__inputs.forEach((e=>e.detach())),this.__outputs.forEach((e=>e.detach()))}reattach(){this.__inputs.forEach((e=>e.reattach())),this.__outputs.forEach((e=>e.reattach()))}rebind(){this.__outputs.forEach((e=>e.rebind()))}}class ls extends os{constructor(e,t){super("CalcGlobalXfoOperator"),this.addInput(new rs("ParentGlobal")),this.addInput(new rs("LocalXfo")).setParam(t),this.addOutput(new ns("GlobalXfo")).setParam(e)}backPropagateValue(e){const t=this.getInput("LocalXfo").getParam(),i=this.getInput("ParentGlobal");if(i.isConnected()){const s=i.getValue();t.setValue(s.inverse().multiply(e))}else t.setValue(e)}evaluate(){const e=this.getInput("LocalXfo").getValue(),t=this.getInput("ParentGlobal"),i=this.getOutput("GlobalXfo");if(t.isConnected()){const s=t.getValue();i.setClean(s.multiply(e),this)}else i.setClean(e,this)}}class hs extends Wi{constructor(e,t){super(e,new xi,"Box3"),this.treeItem=t,this.dirty=!0}setDirty(){this.dirty=!0,this.emit("valueChanged")}getValue(){return this.dirty&&(this.__value=this.treeItem._cleanBoundingBox(this.__value)),this.__value}}let ds=new mi("#03E3AC");ds.a=.1;let cs=ds.lerp(new mi("white"),.5);cs.a=.1;class us extends Si{constructor(e){super(e),this.__visibleCounter=1,this.__visible=!0,this.__highlightMapping={},this.__highlights=[],this.__childItems=[],this.__childItemsEventHandlers=[],this.__childItemsMapping={},this.onPointerDown=this.onPointerDown.bind(this),this.onPointerUp=this.onPointerUp.bind(this),this.onPointerMove=this.onPointerMove.bind(this),this.onPointerEnter=this.onPointerEnter.bind(this),this.onPointerLeave=this.onPointerLeave.bind(this),this.__visibleParam=this.addParameter(new Ai("Visible",!0)),this.__localXfoParam=this.addParameter(new Qi("LocalXfo",new yi)),this.__globalXfoParam=this.addParameter(new Qi("GlobalXfo",new yi)),this.__boundingBoxParam=this.addParameter(new hs("BoundingBox",this)),this._setBoundingBoxDirty=this._setBoundingBoxDirty.bind(this),this._childNameChanged=this._childNameChanged.bind(this),this.globalXfoOp=new ls(this.__globalXfoParam,this.__localXfoParam),this.__globalXfoParam.on("valueChanged",(e=>{this._setBoundingBoxDirty(),this.emit("globalXfoChanged",e)})),this.__visibleParam.on("valueChanged",(()=>{this.__visibleCounter+=this.__visibleParam.getValue()?1:-1,this.__updateVisibility()})),this.on("selectedChanged",(()=>{this.__selected?this.addHighlight("selected",ds,!0):this.removeHighlight("selected",!0)}))}static getSelectionOutlineColor(){return ds}static setSelectionOutlineColor(e){ds=e}static getBranchSelectionOutlineColor(){return cs}static setBranchSelectionOutlineColor(e){cs=e}setOwner(e){if(this.__ownerItem){this.__ownerItem.isVisible()||this.__visibleCounter++;const e=this.__ownerItem.getChildIndex(this);e>=0&&this.__ownerItem.__unbindChild(e,this)}super.setOwner(e),this.__ownerItem?(this.setSelectable(this.__ownerItem.getSelectable(),!0),this.__ownerItem.isVisible()||this.__visibleCounter--,this.globalXfoOp.getInput("ParentGlobal").setParam(this.__ownerItem.getParameter("GlobalXfo"))):this.globalXfoOp.getInput("ParentGlobal").setParam(null),this.__updateVisibility()}__updatePath(){super.__updatePath();for(const e of this.__childItems)e&&e.__updatePath()}getParentItem(){return this.getOwner()}setParentItem(e){this.setOwner(e)}getLocalXfo(){return console.warn("Deprecated. use \"getParameter('LocalXfo').getValue()\""),this.__localXfoParam.getValue()}setLocalXfo(e){console.warn("Deprecated. use \"getParameter('LocalXfo').setValue(xfo)\""),this.__localXfoParam.setValue(e)}getGlobalXfo(){return console.warn("Deprecated. use \"getParameter('GlobalXfo').getValue()\""),this.__globalXfoParam.getValue()}setGlobalXfo(e){console.warn("Deprecated. use \"getParameter('GlobalXfo').setValue(xfo)\""),this.__globalXfoParam.setValue(e)}getVisible(){return console.warn("Deprecated. Use #isVisible"),this.isVisible()}isVisible(){return this.__visibleCounter>0}setVisible(e){this.__visibleParam.setValue(e)}propagateVisibility(e){this.__visibleCounter+=e,this.__updateVisibility()}__updateVisibility(){const e=this.__visibleCounter>0;if(e!=this.__visible){this.__visible=e;for(const e of this.__childItems)e instanceof us&&e.propagateVisibility(this.__visible?1:-1);return this.emit("visibilityChanged",{visible:e}),!0}return!1}addHighlight(e,t,i=!1){if(e in this.__highlightMapping)if(this.__highlights[this.__highlights.length-1]!=e){const i=this.__highlights.indexOf(e);this.__highlights.splice(i,1),this.__highlights.push(e),this.emit("highlightChanged",{name:e,color:t})}else this.__highlightMapping[e].isEqual(t)||(this.__highlightMapping[e]=t,this.emit("highlightChanged",{name:e,color:t}));else this.__highlights.push(e),this.__highlightMapping[e]=t,this.emit("highlightChanged",{name:e,color:t});i&&this.__childItems.forEach((s=>{s instanceof us&&s.addHighlight(e,t,i)}))}removeHighlight(e,t=!1){if(e in this.__highlightMapping)if(this.__highlights[this.__highlights.length-1]==e)if(this.__highlights.pop(),delete this.__highlightMapping[e],this.__highlights.length>0){const e=this.__highlights[this.__highlights.length-1],t=this.__highlightMapping[e];this.emit("highlightChanged",{name:e,color:t})}else this.emit("highlightChanged",{});else{const t=this.__highlights.indexOf(e);this.__highlights.splice(t,1),delete this.__highlightMapping[e]}t&&this.__childItems.forEach((i=>{i instanceof us&&i.removeHighlight(e,t)}))}getHighlight(){if(this.__highlights.length>0)return this.__highlightMapping[this.__highlights[this.__highlights.length-1]]}isHighlighted(){return this.__highlights.length>0}get boundingBox(){return console.warn("getter is deprecated. Please use 'getBoundingBox'"),this.getBoundingBox()}getBoundingBox(){return console.warn("getter is deprecated. Please use 'getParameter('BoundingBox').getValue()'"),this.__boundingBoxParam.getValue()}_cleanBoundingBox(e){return e.reset(),this.__childItems.forEach((t=>{t instanceof us&&t.isVisible()&&e.addBox3(t.getParameter("BoundingBox").getValue())})),e}_childBBoxChanged(){this._setBoundingBoxDirty()}_setBoundingBoxDirty(){this.__boundingBoxParam&&this.__boundingBoxParam.setDirty()}getChildren(){return this.__childItems}numChildren(){return console.warn("Deprecated. Use #getNumChildren"),this.__childItems.length}getNumChildren(){return this.__childItems.length}generateUniqueName(e){if(!(e in this.__childItemsMapping))return e;let t=1;e.length>4&&!Number.isNaN(parseInt(e.substring(e.length-4)))?t=parseInt(e.substr(e.length-4)):e.length>3&&!Number.isNaN(parseInt(e.substring(e.length-3)))?t=parseInt(e.substr(e.length-3)):e.length>2&&!Number.isNaN(parseInt(e.substring(e.length-2)))&&(t=parseInt(e.substr(e.length-2)));const i=[];for(const e of this.__childItems)e&&i.push(e.getName());let s=e;for(;;){let a=""+t;for(;a.length<2;)a="0"+a;if(s=e+a,!i.includes(s))break;t++}return s}__updateMapping(e){for(let t=e;t<this.__childItems.length;t++)this.__childItemsMapping[this.__childItems[t].getName()]=t}_childNameChanged(e){const t=this.__childItemsMapping[e.oldName];delete this.__childItemsMapping[e.oldName],this.__childItemsMapping[e.newName]=t}insertChild(e,t,i=!1,s=!0){if(e.getName()in this.__childItemsMapping){if(!s)throw new Error("Item '"+e.getName()+"' is already a child of :"+this.getPath());e.setName(this.generateUniqueName(e.getName()))}if(!(e instanceof Si))throw new Error("Object is is not a tree item :"+e.constructor.name);let a;if(e.on("nameChanged",this._childNameChanged),e instanceof us){if(i){const t=this.getParameter("GlobalXfo").getValue(),i=e.getParameter("GlobalXfo").getValue();a=t.inverse().multiply(i)}e.on("boundingChanged",this._setBoundingBoxDirty),e.on("visibilityChanged",this._setBoundingBoxDirty)}return this.__childItems.splice(t,0,e),this.__childItemsMapping[e.getName()]=t,this.__updateMapping(t),e.setOwner(this),e instanceof us&&(i&&e.getParameter("LocalXfo").setValue(a),this._setBoundingBoxDirty(),this.__highlights.forEach((t=>{const i=this.__highlightMapping[t];e.addHighlight(t,i,!0)}))),this.emit("childAdded",{childItem:e,index:t}),e}addChild(e,t=!0,i=!0){const s=this.__childItems.length;return this.insertChild(e,s,t,i),e}getChild(e){return this.__childItems[e]}getChildByName(e){const t=this.__childItemsMapping[e];return null!=t?this.__childItems[t]:null}getChildNames(){const e=[];for(let t=0;t<this.__childItems.length;t++){const i=this.__childItems[t];null!=i&&(e[t]=i.getName())}return e}__unbindChild(e,t){t.off("nameChanged",this._childNameChanged),t instanceof us&&(t.off("boundingChanged",this._setBoundingBoxDirty),t.off("visibilityChanged",this._setBoundingBoxDirty)),this.__childItems.splice(e,1),this.__childItemsEventHandlers.splice(e,1),delete this.__childItemsMapping[t.getName()],this.__updateMapping(e),t instanceof us&&this._setBoundingBoxDirty(),this.emit("childRemoved",{childItem:t,index:e})}removeChild(e){const t=this.__childItems[e];t&&(this.__unbindChild(e,t),t.setOwner(void 0))}removeChildByName(e){const t=this.__childItemsMapping[e];return null!=t?this.removeChild(t):null}removeChildByHandle(e){const t=this.__childItems.indexOf(e);if(-1==t)throw new Error("Error in removeChildByHandle. Child not found:"+e.getName());this.removeChild(t)}removeAllChildren(){let e=this.__childItems.length;for(;e--;)this.removeChild(e);this._setBoundingBoxDirty()}getChildIndex(e){return this.__childItems.indexOf(e)}indexOfChild(e){return console.warn("Deprecated Use #getChildIndex"),this.getChildIndex(e)}resolvePath(e,t=0){if("string"==typeof e&&(e=e.split("/")),0==t)if("."==e[0]||e[0]==this.__name)t++;else if(".."==e[0])return this.__ownerItem.resolvePath(e,t+1);if(t==e.length)return this;const i=e[t],s=this.getChildByName(i);if(null==s){const i=this.getParameter(e[t]);if(i)return i;throw new Error(`Unable to resolve path : [${e.toString()}] after: ${this.getName()} \nNo child or parameter called : "${e[t]}"`)}return s.resolvePath(e,t+1)}traverse(e,t=!0){const i=(e,t)=>{const i=e.getChildren();for(const e of i)e&&s(e,t+1)},s=(t,s)=>{if(0==e(t,s))return!1;t instanceof us&&i(t,s)};t?s(this,1):i(this,0)}onPointerDown(e){this.emit("pointerDown",e),e.propagating&&this.__ownerItem&&this.__ownerItem.onPointerDown(e)}onPointerUp(e){this.emit("pointerUp",e),e.propagating&&this.__ownerItem&&this.__ownerItem.onPointerUp(e)}onPointerMove(e){this.emit("pointerMove",e),e.propagating&&this.__ownerItem&&this.__ownerItem.onPointerMove(e)}onPointerEnter(e){this.emit("pointerEnter",e),e.propagating&&this.__ownerItem&&this.__ownerItem.onPointerEnter(e)}onPointerLeave(e){this.emit("pointerLeave",e),e.propagating&&this.__ownerItem&&this.__ownerItem.onPointerLeave(e)}onWheel(e){e.propagating&&this.__ownerItem&&this.__ownerItem.onWheel(e)}toJSON(e){const t=super.toJSON(e),i={};for(const t of this.__childItems)if(t){const s=t.toJSON(e);s&&(i[t.getName()]=s)}return Object.keys(i).length>0&&(t?t.children=i:t={name:this.__name,children:i}),t}fromJSON(e,t){if(super.fromJSON(e,t),t&&!Number.isNaN(t.numTreeItems)&&t.numTreeItems++,null!=e.children){const i=e.children;if(Array.isArray(i))for(const e of i){let i=this.getChildByName(e.name);i?i.fromJSON(e,t):e.type&&(i=oi.constructClass(e.type),i&&(i.fromJSON(e,t),this.addChild(i,!1,!1)))}else for(const e in i){const s=i[e];let a=this.getChildByName(e);a?a.fromJSON(s,t):s.type&&(a=oi.constructClass(s.type),a&&(a.fromJSON(s,t),this.addChild(a,!1,!1)))}}}readBinary(e,t){super.readBinary(e,t),t.numTreeItems++;const i=e.loadUInt8();if(4&i){const t=new yi;t.tr=e.loadFloat32Vec3(),t.ori=e.loadFloat32Quat(),t.sc.set(e.loadFloat32()),this.__localXfoParam.loadValue(t)}8&i&&this.__boundingBoxParam.loadValue(new xi(e.loadFloat32Vec3(),e.loadFloat32Vec3()));const s=e.loadUInt32();if(s>0){const i=e.loadUInt32Array(s);for(let a=0;a<s;a++)try{e.seek(i[a]);const s=e.loadStr(),r=oi.constructClass(s);if(!r){const t=e.loadStr();console.warn("Unable to construct child:"+t+" of type:"+s);continue}e.seek(i[a]),r.readBinary(e,t),this.addChild(r,!1,!1)}catch(e){console.warn("Error loading tree item: ",e)}}}clone(e){const t=new us;return t.copyFrom(this,e),t}copyFrom(e,t){super.copyFrom(e,t),e.getChildren().forEach((e=>{e&&this.addChild(e.clone(t),!1,!1)}))}}oi.register("TreeItem",us);const ms=new class extends Jt{constructor(){super(),this.__adapter=void 0,this.__totalWork=0,this.__doneWork=0,this.baseUrl=Ut.baseUrl,this.plugins={},this.systemUrls={},this.systemUrls["ZeaEngine/Vive.vla"]=this.baseUrl+"public-resources/Vive.vla",this.systemUrls["ZeaEngine/Oculus.vla"]=this.baseUrl+"public-resources/Oculus.vla",this.__commonResources={}}setAdapter(e){this.__adapter=e}getAdapter(){return this.__adapter}registerPlugin(e){P("Resource loader plugin registered: %s",e.getType()),e.init(this),this.plugins[e.getType()]=e}resolveFileId(e){return this.__adapter?this.__adapter.resolveFileId(e):e}resolveFilename(e){return this.__adapter?this.__adapter.resolveFilename(e):e.includes("/")?e.split("/")[1]:e}resolveURL(e){return this.__adapter?this.__adapter.resolveURL(e):this.systemUrls[e]?this.systemUrls[e]:e}loadURL(e,t,i,s=!0){return console.warn('Deprecated. Use "#loadUrl".'),this.loadUrl(e,t,i,s)}loadUrl(e,t,i,s=!0){console.warn("deprecated use #loadArchive"),this.loadArchive(t).then((e=>{i(e)}))}loadArchive(e){return console.warn("Deprecated. Use \"#loadFile('archive', url)\"."),this.loadFile("archive",e)}loadJSON(e){return console.warn("Deprecated. Use \"#loadFile('json', url)\"."),this.loadFile("json",e)}loadText(e){return console.warn("Deprecated. Use \"#loadFile('text', url)\"."),this.loadFile("text",e)}loadFile(e,t){const i=this.plugins[e];if(!i)throw new Error(`There's no plugin registered for the type of file "${e}". Did you add the plugins script? See: https://docs.zea.live/zea-engine/#/adding-default-plugins`);this.incrementWorkload();const s=i.loadFile(t);return s.then((()=>{this.incrementWorkDone(),this.emit("loaded",{url:t})}),(()=>{this.incrementWorkDone()})),s}getCommonResource(e){return this.__commonResources[e]}setCommonResource(e,t){this.__commonResources[e]=t}loadCommonAssetResource(e){return getCommonResource(e)}addWork(e,t){this.incrementWorkload(t)}addWorkDone(e,t){this.incrementWorkDone(t)}incrementWorkload(e=1){this.__totalWork+=e;const t=this.__doneWork/this.__totalWork*100;this.emit("progressIncremented",{percent:t})}incrementWorkDone(e=1){this.__doneWork+=e;const t=this.__doneWork/this.__totalWork*100;if(this.emit("progressIncremented",{percent:t}),this.__doneWork>this.__totalWork)throw new Error("Mismatch between work loaded and work done.")}};class gs{constructor(e){if(e){const t=e.split("-"),i=t[0].split(".");this.major=parseInt(i[0]),this.minor=parseInt(i[1]),this.patch=parseInt(i[2]),2==t.length&&(this.branch=t[1])}else this.major=0,this.minor=0,this.patch=0}compare(e){const t=[this.major,this.minor,this.patch];for(let i=0;i<3;i++)if(t[i]!==e[i])return t[i]-e[i];return 0}equals(e){return console.log("Version#equals method is deprecated, use 'compare' instead "),!(this.patch==e[2]&&this.minor==e[1]&&this.major==e[0])}lessThan(e){return console.log("Version#lessThan method is deprecated, use 'compare' instead "),!(this.major>=e[0]||this.minor>=e[1]||this.patch>=e[2])}greaterThan(e){return console.log("Version#greaterThan method is deprecated, use 'compare' instead "),this.major>e[0]||this.minor>e[1]||this.patch>e[2]}greaterOrEqualThan(e){return console.log("Version#greaterOrEqualThan method is deprecated, use 'compare' instead "),!(this.major<e[0])&&(this.major>e[0]||!(this.minor<e[1])&&(this.minor>e[1]||!(this.patch<e[2])))}}class _s{constructor(e=0){this.__data=new ArrayBuffer(e),this.__byteOffset=0,this.__reserved=e,this.__dataView=new DataView(this.__data)}pos(){return this.__byteOffset}seek(e){this.__byteOffset=e}seekEnd(){this.__byteOffset=this.__reserved}getBuffer(){if(this.__data.byteLength==this.__byteOffset)return this.__data;return new Uint8Array(this.__data).slice(0,this.__byteOffset).buffer}__grow(){const e=2*(this.__reserved>0?this.__reserved:1),t=new ArrayBuffer(e),i=new Uint8Array(t),s=new Uint8Array(this.__data);i.set(s),this.__data=t,this.__dataView=new DataView(this.__data),this.__reserved=e}__reserve(e){this.__byteOffset+e>this.__reserved&&this.__grow()}__offset(e){this.__byteOffset+=e,this.__byteOffset>this.__reserved&&this.__grow()}writeUInt8(e){this.__reserve(1),this.__dataView.setUint8(this.__byteOffset,e),this.__offset(1)}writeUInt16(e){this.__reserve(2),this.__dataView.setUint16(this.__byteOffset,e,!0),this.__offset(2)}writeUInt32(e){this.__reserve(4),this.__dataView.setUint32(this.__byteOffset,e,!0),this.__offset(4)}writeSInt32(e){this.__reserve(4),this.__dataView.setInt32(this.__byteOffset,e,!0),this.__offset(4)}writeFloat16(e){const t=jt.encode16BitFloat(e);this.writeUInt16(t)}writeFloat32(e){this.__reserve(4),this.__dataView.setFloat32(this.__byteOffset,e,!0),this.__offset(4)}writeUInt8Array(e,t=!0){const i=e.size?e.size:e.length;this.__reserve(i+(t?4:0)),t&&this.writeUInt32(i);for(let t=0;t<i;t++)this.writeUInt8(e[t])}writeUInt16Array(e,t=!0){const i=e.size?e.size:e.length;this.__reserve(2*i+(t?4:0)),t&&this.writeUInt32(i);for(let t=0;t<i;t++)this.writeUInt16(e[t])}writeUInt32Array(e,t=!0){const i=e.size?e.size:e.length;this.__reserve(4*i+(t?4:0)),t&&this.writeUInt32(i);for(let t=0;t<i;t++)this.writeUInt32(e[t])}writeFloat32Array(e,t=!0){const i=e.size?e.size:e.length;this.__reserve(4*i+(t?4:0)),t&&this.writeUInt32(i);for(let t=0;t<i;t++)this.writeFloat32(e[t])}writeStr(e,t=!0){const i=e.length;this.__reserve(4*i+(t?4:0)),t&&this.writeUInt32(i);for(let t=0;t<i;t++)this.writeFloat32(e.charCodeAt(t))}writeSInt32Vec2(e){this.writeSInt32(e.x),this.writeSInt32(e.y)}writeUInt32Vec2(e){this.writeUInt32(e.x),this.writeUInt32(e.y)}writeFloat16Vec2(e){this.writeFloat16(e.x),this.writeFloat16(e.y)}writeFloat32Vec2(e){this.writeFloat32(e.x),this.writeFloat32(e.y)}writeFloat16Vec3(e){this.writeFloat16(e.x),this.writeFloat16(e.y),this.writeFloat16(e.z)}writeFloat32Vec3(e){this.writeFloat32(e.x),this.writeFloat32(e.y),this.writeFloat32(e.z)}writeFloat16Quat(e){this.writeFloat16(e.x),this.writeFloat16(e.y),this.writeFloat16(e.z),this.writeFloat16(e.w)}writeFloat32Quat(e){this.writeFloat32(e.x),this.writeFloat32(e.y),this.writeFloat32(e.z),this.writeFloat32(e.w)}writeRGBFloat32Color(e){this.writeFloat32(e.r),this.writeFloat32(e.g),this.writeFloat32(e.b)}writeRGBAFloat32Color(e){this.writeFloat32(e.r),this.writeFloat32(e.g),this.writeFloat32(e.b),this.writeFloat32(e.a)}writeRGBUInt8Color(e){this.writeUInt8(e.r),this.writeUInt8(e.g),this.writeUInt8(e.b)}writeRGBAUInt8Color(e){this.writeUInt8(e.r),this.writeUInt8(e.g),this.writeUInt8(e.b),this.writeUInt8(e.a)}writeBox2(e){this.writeFloat32Vec2(e.p0),this.writeFloat32Vec2(e.p1)}writeBox3(e){this.writeFloat32Vec3(e.p0),this.writeFloat32Vec3(e.p1)}writePadd(e){const t=e-this.__byteOffset;this.__reserve(t),this.__offset(t)}writeAlignment(e){const t=this.__byteOffset%e;0!=t&&(this.__reserve(e-t),this.__offset(e-t))}}class fs extends Wi{constructor(e){super(e,"","FilePath")}getFilepath(){return this.__value?ms.getFilepath(this.__value):""}setFilepath(e){this.setValue(ms.resolveFileId(e))}getFilename(){return ms.resolveFilename(this.__value)}getExt(){const e=this.getFilename(),t=e.lastIndexOf(".");if(-1!=t)return e.substring(t).toLowerCase()}getStem(){const e=this.getFilename();if(e){const t=e.split(".");return 2==t.length?t[0]:e}}getFileDesc(){return this.getFile()}getFile(){return{id:this.__value,url:this.getUrl(),name:this.getFilename()}}setUrl(e,t){this.setValue(ms.resolveFileId(e))}getUrl(){return ms.resolveURL(this.__value)}setValue(e){if(!e)throw new Error("Invalid value for setValue.");e!=this.__value&&(this.__value=e,this.emit("valueChanged",{}))}toJSON(e){return{value:this.__value}}fromJSON(e,t){e.value&&(this.__value=e.value)}clone(){const e=new fs(this.__name);return e.setValue(this.getValue()),e}}oi.register("FilePathParameter",fs);class ps extends Si{constructor(e){super(e),this.width=0,this.height=0,this.format="RGB",this.type="UNSIGNED_BYTE",this.wrapS="CLAMP_TO_EDGE",this.wrapT="CLAMP_TO_EDGE",this.minFilter="LINEAR",this.magFilter="LINEAR",this.on("parameterValueChanged",(e=>{this.emit("updated")})),this.loaded=!1}isLoaded(){return!0}getParams(){return{type:this.type,format:this.format,width:this.width,height:this.height,wrapS:this.wrapS,wrapT:this.wrapT,minFilter:this.minFilter,magFilter:this.magFilter}}}class bs extends Bi{constructor(e,t,i,s){super(e,t,i,s)}getImage(){return this.__image}setImage(e){const t=()=>{this.emit("textureDisconnected",{})};e?(null!=this.__image&&this.__image!==e&&t(),this.__image=e,this.emit("textureConnected",{}),this.emit("valueChanged",{mode:0})):null!=this.__image&&(t(),this.__image=void 0,this.emit("textureDisconnected",{}))}setValue(e){e instanceof ps?this.setImage(e):super.setValue(e)}readBinary(e,t){super.readBinary(e,t);const i=e.loadStr();""!=i&&(console.log("Load Texture"),this.setImage(t.materialLibrary.getImage(i)))}clone(){return new bs(this.__name,this.__value,this.__range,this.__step)}}oi.register("MaterialFloatParam",bs);class ys extends Hi{constructor(e,t){super(e,t),this.__imageUpdated=this.__imageUpdated.bind(this)}getImage(){return this.__image}__imageUpdated(){this.emit("valueChanged",{})}setImage(e){const t=()=>{this.__image.off("updated",this.__imageUpdated),this.__image=null,this.emit("textureDisconnected",{})};e?(null!=this.__image&&this.__image!==e&&t(),this.__image=e,this.__image.on("updated",this.__imageUpdated),this.emit("textureConnected",{}),this.emit("valueChanged")):null!=this.__image&&(t(),this.__image=void 0,this.emit("textureDisconnected"))}setValue(e){e instanceof ps?this.setImage(e):super.setValue(e)}readBinary(e,t){super.readBinary(e,t);const i=e.loadStr();""!=i&&this.setImage(t.materialLibrary.getImage(i))}clone(){return new ys(this.__name,this.__value.clone())}}oi.register("MaterialColorParam",ys);const Gs=(e,t,i,s)=>"boolean"==typeof t||!1===t||!0===t?new Wi(e,t,"Boolean"):"string"==typeof t?new Wi(e,t,"String"):jt.isNumeric(t)?s?new bs(e,t,i):new Bi(e,t,i):t instanceof hi?new Di(e,t):t instanceof di?new ki(e,t):t instanceof mi?s?new ys(e,t):new Hi(e,t):new Wi(e,t);class Xs extends Si{constructor(e,t){super(e),this.visibleInGeomDataBuffer=!0,this.__isTransparent=!1,this.__isTextured=!1,t&&this.setShaderName(t)}getShaderName(){return this.__shaderName}setShaderName(e){if(this.__shaderName==e)return;const t=oi.getBlueprint(e);if(!t)throw new Error("Error setting Shader. Shader not found:"+e);const i=t.getParamDeclarations(),s={};for(const e of i){let t=this.getParameter(e.name);t||(t=this.addParameter(Gs(e.name,e.defaultValue,e.range,0!=e.texturable))),s[e.name]=!0}for(const e of this.__params)s[e.getName()]||this.removeParameter(e.getName());this.__shaderName=e,this.__checkTransparency({}),this.emit("shaderNameChanged",{shaderName:e})}removeAllTextures(){for(const e of this.__params)e.getImage&&e.getImage()&&e.setImage(void 0)}getParamTextures(){const e={};for(const t of this.__params)t.getImage&&t.getImage()&&(e[t.getName()]=t.getImage());return e}isTransparent(){return this.__isTransparent}__checkTransparency(e){let t=!1;try{oi.getBlueprint(this.__shaderName).isTransparent()&&(t=!0)}catch(e){}if(!t){const e=this.getParameter("Opacity");if(e&&(e.getValue()<.99||e.getImage&&e.getImage()))t=!0;else{const e=this.getParameter("BaseColor");e&&(e.getImage&&e.getImage()&&"RGBA"==e.getImage().format||e.getValue().a<1)&&(t=!0)}}t!=this.__isTransparent&&(this.__isTransparent=t,this.emit("transparencyChanged",{isTransparent:t}))}isTextured(){return this.__isTextured}__checkTextures(e){const{param:t}=e||{};let i=!1;for(const e of this.__params)if(e.getImage&&e.getImage()){i=!0;break}i!=this.__isTextured&&(this.__isTextured=i,this.emit("texturedChanged",{isTextured:i,param:t}))}__parameterValueChanged(e){this.__checkTransparency(e),this.__checkTextures(e),super.__parameterValueChanged(e)}getShaderClass(){return oi.getBlueprint(this.getShaderName())}modifyParams(e,t){t&&this.setShaderName(t);for(const t in e){const i=this.getParameter(t);i&&(e[t]instanceof Wi?this.replaceParameter(e[t]):i.setValue(e[t]))}}toJSON(e){const t=super.toJSON(e);return t.shader=this.__shaderName,t}fromJSON(e,t={}){e.shader?(this.setShaderName(e.shader),super.fromJSON(e,t)):console.warn("Invalid Material JSON")}readBinary(e,t){let i=e.loadStr();if("StandardMaterial"==i&&(i="StandardSurfaceShader"),"TransparentMaterial"==i&&(i="TransparentSurfaceShader"),this.setShaderName(i),t.versions["zea-engine"].compare([0,0,3])<0){this.setName(e.loadStr());const i=e.loadUInt32();for(let a=0;a<i;a++){const i=(s=e.loadStr()).charAt(0).toUpperCase()+s.slice(1);let a;"MaterialColorParam"==e.loadStr()?(a=e.loadRGBAFloat32Color(),a.applyGamma(2.2)):a=e.loadFloat32();const r=e.loadStr();let n=this.getParameter(i);n?n.setValue(a):n=this.addParameter(Gs(i,a)),""!=r&&n.setImage&&(t.materialLibrary.hasImage(r)?n.setImage(t.materialLibrary.getImage(r)):console.warn("Missing Texture:"+r))}}else super.readBinary(e,t);var s;this.__checkTransparency(),this.__checkTextures()}clone(e){const t=new Xs;return t.copyFrom(this,e),t}copyFrom(e,t){this.setShaderName(e.getShaderName()),super.copyFrom(e,t)}}oi.register("Material",Xs);class xs extends Wi{constructor(e,t){super(e,void 0,"Material"),this.__valueParameterValueChanged=this.__valueParameterValueChanged.bind(this),this.setValue(t)}__valueParameterValueChanged(e){this.emit("valueParameterValueChanged",e)}setValue(e){this.__value!==e&&(this.__value&&this.__value.off("parameterValueChanged",this.__valueParameterValueChanged),this.__value=e,this.__value&&this.__value.on("parameterValueChanged",this.__valueParameterValueChanged),this.emit("valueChanged",{}))}loadValue(e){this.__value=e,this.__value&&this.__value.on("parameterValueChanged",this.__valueParameterValueChanged)}loadValue(e){this.__value&&this.__value.off("parameterValueChanged",this.__valueParameterValueChanged),this.__value=e,this.__value&&this.__value.on("parameterValueChanged",this.__valueParameterValueChanged)}toJSON(e){let t;return this.__value&&(t={value:e&&e.onlyPath?this.__value.getPath():this.__value.toJSON(e)}),t}fromJSON(e,t){if(null!=e.value)if(e.value instanceof Array||e.value instanceof String){if(t&&t.assetItem){const i=t.assetItem.getMaterialLibrary().getMaterial(e.value instanceof array?e.value[1]:e.value);i&&this.loadValue(i)}}else{const i=new Xs;i.fromJSON(e.value,t),this.loadValue(i)}else console.warn("Invalid Parameter JSON")}clone(){return new xs(this.__name,this.__value)}destroy(){this.__value&&this.__value.off("parameterValueChanged",this.__valueParameterValueChanged)}}oi.register("MaterialParameter",xs);class Is{constructor(e,t,i){if(this.__dataType=e,this.normalized=!1,null!=e.numElements)this.__dimension=this.__dataType.numElements();else switch(e){case 6:case 4:case 5:this.__dimension=1;break;default:throw new Error("Invalid data type for attribute:"+e)}var s;this.__defaultElementValue=null!=i?i:Number.MAX_VALUE,(s=t)&&void 0!==s.byteLength?this.__data=t:(this.__data=new Float32Array(t*this.__dimension),this.initRange(0))}resize(e){const t=this.__data.length,i=e*this.__dimension;if(i>t){const e=new Float32Array(i);e.set(this.__data),this.__data=e,this.initRange(t)}else i<t&&(this.__data=this.__data.slice(0,i))}initRange(e){for(let t=e;t<this.__data.length;t++)this.__data[t]=this.__defaultElementValue}getCount(){return this.__data.length/this.__dimension}get length(){return this.__data.length/this.__dimension}get dataType(){return this.__dataType}get data(){return this.__data}set data(e){this.__data=e}get numElements(){return this.__dimension}getFloat32Value(e){return this.__data[e]}setFloat32Value(e,t){this.__data[e]=t}getValueRef(e){const t=this.__dimension;if(e>=this.__data.length/t)throw new Error("Invalid vertex index:"+e+". Num Vertices:"+this.__data.length/3);return this.__dataType.createFromBuffer(this.__data.buffer,e*t*4)}setValue(e,t){const i=this.__dimension;if(e>=this.__data.length/i)throw new Error("Invalid vertex index:"+e+". Num Vertices:"+this.__data.length/3);this.__dataType.createFromBuffer(this.__data.buffer,e*i*4).setFromOther(t)}toJSON(e){return{data:Array.from(this.__data),dataType:oi.getBlueprintName(this.__dataType),defaultValue:this.__defaultElementValue,length:this.__data.length/this.__dimension}}fromJSON(e){const t=e.data.map((e=>jt.isNumeric(e)?e:Number.POSITIVE_INFINITY));this.__data=Float32Array.from(t)}toString(){return JSON.stringify(this.toJSON(),null,2)}}class Vs extends Is{constructor(e,t,i,s){super(t,i,s),this.__geom=e,this.__splits={},this.__splitValues=[]}resize(e){super.resize(e),this.__splits={},this.__splitValues=[]}getFaceVertexValueRef(e,t){const i=this.__geom.getFaceVertexIndex(e,t);return i in this.__splits&&e in this.__splits[i]?this.__splitValues[this.__splits[i][e]]:this.getValueRef(i)}setFaceVertexValue(e,t,i){const s=this.__geom.getFaceVertexIndex(e,t);this.setFaceVertexValue_ByVertexIndex(e,s,i)}setFaceVertexValue_ByVertexIndex(e,t,i){const s=this.getValueRef(t);if(s.isValid())if(s.approxEqual(i));else{if(t in this.__splits){const s=this.__splits[t];for(const t in s){const a=s[t];if(this.__splitValues[a].approxEqual(i))return void(s[e]=a)}if(e in this.__splits[t]){return void this.__splitValues[this.__splits[t][e]].setFromOther(i)}}else this.__splits[t]={};this.__splits[t][e]=this.__splitValues.length,this.__splitValues.push(i)}else s.setFromOther(i)}setSplitVertexValue(e,t,i){if(e in this.__splits||(this.__splits[e]={}),t in this.__splits[e]){if(this.__splitValues[this.__splits[e][t]].approxEqual(i))return;console.warn("Face Vertex Already Split with different value")}this.__splits[e][t]=this.__splitValues.length,this.__splitValues.push(i)}setSplitVertexValues(e,t,i){e in this.__splits||(this.__splits[e]={});const s=this.__splitValues.length;this.__splitValues.push(i);for(const i of t)this.__splits[e][i]=s}getSplits(){return this.__splits}getSplitCount(){let e=0;for(const t in this.__splits)e+=Object.keys(this.__splits[t]).length;return e}generateSplitValues(e,t){if(0==t)return this.__data;const i=this.length,s=this.length+t,a=this.__dataType.numElements?this.__dataType.numElements():1,r=new Float32Array(s*a);for(let e=0;e<this.__data.length;e++)r[e]=this.__data[e];for(const t in e){const s=e[t];for(const e in s){const n=i+s[e];if(t in this.__splits&&e in this.__splits[t]){const i=this.__splits[t][e];6==this.__dataType?r[n*a]=this.__splitValues[i]:this.__dataType.createFromBuffer(r.buffer,n*a*4).setFromOther(this.__splitValues[i])}else{const e=parseInt(t);for(let t=0;t<a;t++)e*a+t>this.__data.length&&console.log("Error remapping src:"+e*a+t),n*a+t>r.length&&console.log("Error remapping tgt:"+n*a+t),r[n*a+t]=this.__data[e*a+t]}}}return r}toJSON(e){const t=super.toJSON(e);return t.splits=this.__splits,t.splitValues=this.__splitValues,t}fromJSON(e,t){if(super.fromJSON(e,t),this.__splits=e.splits||{},this.__splitValues=[],e.splitValues)for(const t of e.splitValues){const e=new this.__dataType;e.fromJSON(t),this.__splitValues.push(e)}}loadSplitValues(e){const t=e.loadUInt32Array();if(0==t.length)return;let i=0,s=0;for(;;){const e=t[i++],a=t[i++],r={};for(let e=0;e<a;e++){const e=t[i++],a=t[i++];r[e]=a,a>=s&&(s=a+1)}if(this.__splits[e]=r,i>=t.length)break}const a=this.__numFloat32Elements,r=e.loadFloat32Array(s*a);this.__splitValues=[];for(let e=0;e<s;e++){const t=this.__dataType.createFromFloat32Array(r.slice(e*a,e*a+a));this.__splitValues.push(t)}}}class vs extends Mi{constructor(){super(),this.__numVertices=0,this.__boundingBox=new xi,this.__boundingBoxDirty=!0,this.__vertexAttributes=new Map,this.__metaData=new Map,this.addVertexAttribute("positions",di,0)}clear(){this.setNumVertices(0)}setDebugName(e){this.__name=e}addVertexAttribute(e,t,i){const s=this.getVertexAttribute("positions");let a;var r;return a=(r=i)&&void 0!==r.byteLength?new Is(t,i):new Is(t,null!=s?s.length:0,i),this.__vertexAttributes.set(e,a),a}hasVertexAttribute(e){return this.__vertexAttributes.has(e)}getVertexAttribute(e){return this.__vertexAttributes.get(e)}getVertexAttributes(){const e={};for(const[t,i]of this.__vertexAttributes.entries())e[t]=i;return e}get vertices(){return console.warn("deprecated use #getVertexAttribute('positions')"),this.__vertexAttributes.get("positions")}numVertices(){return this.__numVertices}getNumVertices(){return this.__numVertices}setNumVertices(e){this.__numVertices=e,this.__vertexAttributes.forEach((e=>e.resize(this.__numVertices))),this.setBoundingBoxDirty()}getVertex(e){return console.warn("deprecated use #getVertexAttribute('positions').getValueRef()"),di.createFromBuffer(this.vertices.data.buffer,3*e*4)}setVertex(e,t){return console.warn("deprecated use #getVertexAttribute('positions').getValueRef().setFromOther(value)"),di.createFromBuffer(this.vertices.data.buffer,3*e*4).setFromOther(t)}moveVertices(e){console.warn("deprecated use #getVertexAttribute('positions').getValueRef()");const t=this.vertices;for(let i=0;i<t.length;i++)t.getValueRef(i).addInPlace(e);this.setBoundingBoxDirty()}transformVertices(e){console.warn("deprecated, please transform the vertices manually");const t=this.__vertexAttributes.get("positions");for(let i=0;i<t.length;i++){const s=t.getValueRef(i),a=e.transformVec3(s);s.set(a.x,a.y,a.z)}this.setBoundingBoxDirty()}get boundingBox(){return console.warn("deprecated, please use #getBoundingBox()"),this.__boundingBoxDirty&&this.updateBoundingBox(),this.__boundingBox}getBoundingBox(){return this.__boundingBoxDirty&&this.updateBoundingBox(),this.__boundingBox}setBoundingBoxDirty(){this.__boundingBoxDirty||(this.__boundingBoxDirty=!0,this.emit("boundingBoxChanged",{}))}updateBoundingBox(){const e=this.getVertexAttribute("positions"),t=new xi,i=e.length;for(let s=0;s<i;s++)t.addPoint(e.getValueRef(s));this.__boundingBox=t,this.__boundingBoxDirty=!1}getMetadata(e){return this.__metaData.get(e)}hasMetadata(e){return this.__metaData.has(e)}setMetadata(e,t){this.__metaData.set(e,t)}deleteMetadata(e){this.__metaData.delete(e)}genBuffers(e){const t={};for(const[e,i]of this.__vertexAttributes)t[e]={values:i.data,count:i.length,dataType:i.dataType,normalized:i.normalized};return{numVertices:this.numVertices(),attrBuffers:t}}loadBaseGeomBinary(e){this.name=e.loadStr();const t=e.loadUInt8();this.debugColor=e.loadRGBFloat32Color();const i=e.loadUInt32();this.__boundingBox.set(e.loadFloat32Vec3(),e.loadFloat32Vec3()),this.setNumVertices(i);const s=this.getVertexAttribute("positions");let a,r;2&t&&(a=this.getVertexAttribute("normals"),a||(a=this.addVertexAttribute("normals",di,0))),4&t&&(r=this.getVertexAttribute("texCoords"),r||(r=this.addVertexAttribute("texCoords",hi,0)));const n=(e,t,i,a)=>{for(let r=e[0];r<e[1];r++){const e=new di(a[3*r+0]/255,a[3*r+1]/255,a[3*r+2]/255);e.multiplyInPlace(i),e.addInPlace(t),s.setValue(r,e)}},o=(e,t,i,s)=>{i.isNull()&&i.set(1,1,1);for(let r=e[0];r<e[1];r++){const e=new di(s[3*r+0]/255,s[3*r+1]/255,s[3*r+2]/255);e.multiplyInPlace(i),e.addInPlace(t),e.normalizeInPlace(),a.setValue(r,e)}},l=(e,t,i,s)=>{for(let a=e[0];a<e[1];a++){const e=new hi(s[2*a+0]/255,s[2*a+1]/255);e.multiplyInPlace(i),e.addInPlace(t),r.setValue(a,e)}},h=e.loadUInt32();if(1==h){{const t=this.__boundingBox,s=e.loadUInt8Array(3*i);n([0,i],t.p0,t.diagonal(),s)}if(a){const t=new xi(e.loadFloat32Vec3(),e.loadFloat32Vec3()),s=e.loadUInt8Array(3*i);o([0,i],t.p0,t.diagonal(),s),a.loadSplitValues(e)}if(r){const t=new Gi(e.loadFloat32Vec2(),e.loadFloat32Vec2()),s=e.loadUInt8Array(2*i);l([0,i],t.p0,t.diagonal(),s),r.loadSplitValues(e)}}else{const t=[];let s=0;for(let i=0;i<h;i++){const i=e.loadUInt32(),n={range:[s,s+i],bbox:new xi(e.loadFloat32Vec3(),e.loadFloat32Vec3())};a&&(n.normalsRange=new xi(e.loadFloat32Vec3(),e.loadFloat32Vec3())),r&&(n.texCoordsRange=new Gi(e.loadFloat32Vec2(),e.loadFloat32Vec2())),t.push(n),s+=i}const d=e.loadUInt8Array(3*i);let c,u;a&&(c=e.loadUInt8Array(3*i)),r&&(u=e.loadUInt8Array(2*i));for(let e=0;e<h;e++){{const i=t[e].bbox;n(t[e].range,i.p0,i.diagonal(),d)}if(a){const i=t[e].normalsRange;o(t[e].range,i.p0,i.diagonal(),c)}if(r){const i=t[e].texCoordsRange;l(t[e].range,i.p0,i.diagonal(),u)}}a&&a.loadSplitValues(e),r&&r.loadSplitValues(e)}}toJSON(e){let t=super.toJSON(e);t||(t={}),t.type=oi.getBlueprintName(this),e&&e.skipTopology||(t.numVertices=this.__numVertices||0);const i={};for(const[t,s]of this.__vertexAttributes.entries())e&&"skipAttributes"in e&&e.skipAttributes.includes(t)||(i[t]=s.toJSON(e));return t.vertexAttributes=i,t}fromJSON(e,t){if(this.clear(),super.fromJSON(e,t),e.numVertices&&this.setNumVertices(e.numVertices),e.vertexAttributes)for(const t in e.vertexAttributes){let i=this.__vertexAttributes.get(t);const s=e.vertexAttributes[t];if(!i){const e=oi.getBlueprint(s.dataType);i=new Vs(this,e,0,s.defaultScalarValue),this.__vertexAttributes.set(t,i)}i.fromJSON(s)}this.emit("geomDataTopologyChanged")}toString(){return JSON.stringify(this.toJSON(),null,2)}}class Rs extends vs{constructor(){super()}clear(){this.setNumVertices(0),this.emit("geomDataTopologyChanged")}loadBin(e){this.name=e.loadStr();const t=e.loadUInt32();this.__boundingBox.set(e.loadFloat32Vec3(),e.loadFloat32Vec3()),this.setNumVertices(t);const i=this.getVertexAttribute("positions");if(t<256){const s=this.__boundingBox.toMat4(),a=e.loadUInt8Array(3*t);for(let e=0;e<t;e++){const t=new Vec3(a[3*e+0]/255,a[3*e+1]/255,a[3*e+2]/255);i.setValue(e,s.transformVec3(t))}}else{const s=e.loadUInt32(),a=[];for(let t=0;t<s;t++){const t=e.loadUInt32Vec2(),i=e.loadFloat32Vec3(),s=e.loadFloat32Vec3();a.push({range:t,bbox:new Box3(i,s)})}const r=e.loadUInt8Array(3*t);for(let e=0;e<s;e++){const t=a[e].bbox.toMat4();for(let s=a[e].range.x;s<a[e].range.y;s++){const e=new Vec3(r[3*s+0]/255,r[3*s+1]/255,r[3*s+2]/255);i.setValue(s,t.transformVec3(e))}}}}readBinary(e,t){super.loadBaseGeomBinary(e),this.emit("geomDataChanged",{})}}oi.register("Points",Rs);class ws extends vs{constructor(){super(),this.__indices=new Uint32Array}clear(){super.clear(),this.setNumSegments(0),this.emit("geomDataTopologyChanged")}getIndices(){return this.__indices}getNumSegments(){return this.__indices.length/2}setNumSegments(e){if(e>this.getNumSegments()){const t=new Uint32Array(2*e);t.set(this.__indices),this.__indices=t}else this.__indices=this.__indices.slice(0,2*e)}setSegmentVertexIndices(e,t,i){if(e>=this.__indices.length/2)throw new Error("Invalid line index: "+e+". Num Segments: "+this.__indices.length/2);this.__indices[2*e+0]=t,this.__indices[2*e+1]=i}setSegment(e,t,i){console.warn("deprecated use #setSegmentVertexIndices"),this.setSegmentVertexIndices(e,t,i)}getSegmentVertexIndex(e,t){if(e<this.getNumSegments())return this.__indices[2*e+t]}genBuffers(){const e=super.genBuffers();let t;return t=e.numVertices<Math.pow(2,8)?new Uint8Array(this.__indices):e.numVertices<Math.pow(2,16)?new Uint16Array(this.__indices):this.__indices,e.indices=t,e}readBinary(e,t){super.loadBaseGeomBinary(e),this.setNumSegments(e.loadUInt32());const i=e.loadUInt8();1==i?this.__indices=e.loadUInt8Array():2==i?this.__indices=e.loadUInt16Array():4==i&&(this.__indices=e.loadUInt32Array()),this.emit("geomDataChanged",{})}toJSON(e){const t=super.toJSON(e);return e&&e.skipTopology||(t.indices=Array.from(this.__indices)),t}fromJSON(e,t){super.fromJSON(e,t),e.indices&&(this.__indices=Uint32Array.from(e.indices))}}oi.register("Lines",ws);class Ms extends vs{constructor(){super(),this.__faceCounts=[],this.__faceVertexIndices=new Uint32Array,this.__faceAttributes=new Map,this.__edgeAttributes=new Map,this.__logTopologyWarnings=!1,this.edgeVerts=void 0,this.vertexEdges=void 0,this.numEdges=0,this.edgeAngles=new Float32Array,this.edgeVecs=[]}init(){}clear(){super.clear(),this.edgeVerts=void 0,this.vertexEdges=void 0,this.numEdges=0,this.edgeAngles=new Float32Array,this.emit("geomDataTopologyChanged")}getFaceCounts(){return this.__faceCounts}getNumFaces(){return 0==this.__faceCounts.length?0:this.__faceCounts.reduce(((e,t)=>e+t))}setFaceCounts(e){let t=0,i=0,s=3;for(const a of e)t+=a,i+=a*s,s++;if(0==this.getNumFaces())this.__faceVertexIndices=new Uint32Array(i);else{const t=new Uint32Array(i);let a=0,r=0;i=0,s=3,e.forEach(((e,i)=>{const n=a+Math.min(e,this.__faceCounts[i])*s;t.set(this.__faceVertexIndices.slice(a,n),r),a+=this.__faceCounts[i]*s,r+=e*s,s++})),this.__faceVertexIndices=t}this.__faceCounts=e,this.__faceAttributes.forEach((e=>{e.resize(t)}))}getFaceVertexCount(e){let t=0,i=0;return this.__faceCounts.some(((s,a)=>{if(t+=s,t>e)return i=a+3,!0})),i}getFaceVertexOffset(e){let t=0,i=0;return this.__faceCounts.some(((s,a)=>{if(t+s>e)return i+=(e-t)*(a+3),!0;t+=s,i+=s*(a+3)})),i}setFaceVertexIndices(e,t){2!=arguments.length&&(console.warn("deprecated interface. Please pass vertexIndices as an array"),t=Array.prototype.slice.call(arguments,1));const i=this.getFaceVertexCount(e);if(t.length!=i)throw new Error(`Invalid indices for face:${e} vertexIndices:${t}. Expected ${i} indices`);const s=this.getFaceVertexOffset(e);this.__faceVertexIndices.set(t,s)}addFace(e){const t=[...this.__faceCounts];if(t.length<=e.length-3){for(let i=t.length;i<e.length-3;i++)t[i]=0;t[e.length-3]=1}else t[e.length-3]++;this.setFaceCounts(t);let i=0,s=0;return this.__faceCounts.some(((t,a)=>{if(a+3==e.length)return i+=t-1,s+=(t-1)*(a+3),!0;i+=t,s+=t*(a+3)})),this.__faceVertexIndices.set(e,s),i}getFaceVertexIndices(e){const t=[],i=this.getFaceVertexOffset(e),s=this.getFaceVertexCount(e);for(let e=0;e<s;e++)t.push(this.__faceVertexIndices[i+e]);return t}getFaceVertexIndex(e,t){const i=this.getFaceVertexOffset(e);return this.__faceVertexIndices[i+t]}addVertexAttribute(e,t,i){const s=this.getVertexAttribute("positions"),a=new Vs(this,t,null!=s?s.length:0,i);return this.__vertexAttributes.set(e,a),a}addFaceAttribute(e,t,i){const s=new Is(t,null!=i?i:this.getNumFaces());return this.__faceAttributes.set(e,s),s}hasFaceAttribute(e){return this.__faceAttributes.has(e)}getFaceAttribute(e){return this.__faceAttributes.get(e)}addEdgeAttribute(e,t,i){const s=new Is(t,null!=i?i:this.getNumEdges());return this.__edgeAttributes.set(e,s),s}hasEdgeAttribute(e){return this.__edgeAttributes.has(e)}getEdgeAttribute(e){return this.__edgeAttributes.get(e)}genTopologyInfo(){const e={};this.vertexEdges=[],this.edgeFaces=[],this.edgeVerts=[],this.faceEdges=[],this.numEdges=0;const t=this.getVertexAttribute("positions"),i=(i,s)=>{let a=i,r=s;if(r<a){const e=a;a=r,r=e}const n=a+">"+r;if(n in e)return e[n];const o=t.getValueRef(a),l=t.getValueRef(r).subtract(o),h={edgeIndex:this.edgeFaces.length/2,edgeVec:l};return e[n]=h,this.edgeFaces.push(-1),this.edgeFaces.push(-1),this.edgeVerts.push(a),this.edgeVerts.push(r),this.numEdges++,h},s=(e,t,s)=>{const a=i(e,t).edgeIndex;if(t<e){const e=2*a+0;this.__logTopologyWarnings&&-1!=this.edgeFaces[e]&&console.warn("Edge poly 0 already set. Mesh is non-manifold."),this.edgeFaces[e]=s}else{const e=2*a+1;this.__logTopologyWarnings&&-1!=this.edgeFaces[e]&&console.warn("Edge poly 1 already set. Mesh is non-manifold."),this.edgeFaces[e]=s}s in this.faceEdges||(this.faceEdges[s]=[]),this.faceEdges[s].push(a),null==this.vertexEdges[e]&&(this.vertexEdges[e]=new Set),null==this.vertexEdges[t]&&(this.vertexEdges[t]=new Set),this.vertexEdges[e].add(a),this.vertexEdges[t].add(a)},a=this.getNumFaces();for(let e=0;e<a;e++){const t=this.getFaceVertexIndices(e);for(let i=0;i<t.length;i++){s(t[i],t[(i+1)%t.length],e)}}}computeFaceNormals(){const e=this.getVertexAttribute("positions"),t=this.addFaceAttribute("normals",di),i=this.getNumFaces();for(let s=0;s<i;s++){const i=this.getFaceVertexIndices(s),a=e.getValueRef(i[0]);let r=e.getValueRef(i[1]);const n=new di;for(let t=2;t<i.length;t++){const s=e.getValueRef(i[t]),o=r.subtract(a),l=s.subtract(a);n.addInPlace(l.cross(o).normalize()),r=s}n.lengthSquared()<Number.EPSILON||t.setValue(s,n.normalize())}}calculateEdgeAngles(){null==this.vertexEdges&&this.genTopologyInfo(),this.computeFaceNormals();const e=this.getVertexAttribute("positions"),t=this.getFaceAttribute("normals");this.edgeVecs=[],this.edgeAngles=new Float32Array(this.numEdges);for(let i=0;i<this.edgeFaces.length;i+=2){const s=this.edgeVerts[i],a=this.edgeVerts[i+1],r=e.getValueRef(a).subtract(e.getValueRef(s));r.normalizeInPlace(),this.edgeVecs.push(r);const n=this.edgeFaces[i],o=this.edgeFaces[i+1];if(-1==n||-1==o){this.edgeAngles[i/2]=2*Math.PI;continue}const l=t.getValueRef(n),h=t.getValueRef(o);this.edgeAngles[i/2]=l.angleTo(h)}}computeVertexNormals(e=1){this.calculateEdgeAngles();const t=this.getFaceAttribute("normals"),i=this.addVertexAttribute("normals",di),s=t.data.buffer,a=e=>di.createFromBuffer(s,3*e*4),r=i.data,n=(e,t)=>{r[3*e+0]=t.x,r[3*e+1]=t.y,r[3*e+2]=t.z},o=(e,t)=>{let i,s;const a=this.faceEdges[e];for(const e of a)(this.edgeVerts[2*e]==t||this.edgeVerts[2*e+1]==t)&&(i?s=this.edgeVecs[e]:i=this.edgeVecs[e]);return[i,s]};for(let t=0;t<this.vertexEdges.length;t++){if(null==this.vertexEdges[t])continue;const s=this.vertexEdges[t],r=[],l=e=>{let t=!1;for(const i of r)if(t=i.includes(e),t)break;t||r.push([e])};for(const t of s){const i=this.edgeFaces[2*t],s=this.edgeFaces[2*t+1];if(-1!=i&&-1!=s&&this.edgeAngles[t]<e){let e=-1,t=-1;for(let a=0;a<r.length;a++)-1==e&&r[a].includes(i)&&(e=a),-1==t&&r[a].includes(s)&&(t=a);-1==e&&-1==t?r.push([i,s]):-1!=e&&-1!=t?e!=t&&(r[e]=r[e].concat(r[t]),r.splice(t,1)):(-1==e&&r[t].push(i),-1==t&&r[e].push(s))}else-1!=i&&l(i),-1!=s&&l(s)}r.sort(((e,t)=>e.length<t.length?1:e.length>t.length?-1:0));let h=!0;for(const e of r){const s=new di;for(const i of e){const e=o(i,t),r=e[0].angleTo(e[1]);s.addInPlace(a(i).scale(r))}s.normalizeInPlace(),h?(n(t,s),h=!1):i.setSplitVertexValues(t,e,s)}}return i}computeHardEdgesIndices(e=1){this.edgeVerts||this.calculateEdgeAngles();const t=[],i=e=>{t.push(this.edgeVerts[e]),t.push(this.edgeVerts[e+1])};for(let t=0;t<this.edgeAngles.length;t++)this.edgeAngles[t]>e&&i(2*t);return Uint32Array.from(t)}getWireframeIndices(){return console.warn("@todo-review - This returns nothing"),indices}genBuffers(e){const t={};let i=0;for(const[,e]of this.__vertexAttributes){const s=e.getSplits();for(const e in s){e in t||(t[e]={});const a=s[e];for(const s in a){const a=parseInt(s);a in t[e]||(t[e][a]=i,i++)}}}const s=this.getVertexAttribute("positions").length,a=s+i;let r;e&&0==e.includeIndices||(r=this.generateTriangulatedIndices(a,s,t));const n={};for(const[e,s]of this.__vertexAttributes){let a;a=0==i?s.data:s.generateSplitValues(t,i);const r=s.numElements,o=a.length/r;n[e]={values:a,count:o,dimension:r,normalized:"normals"==e,dataType:s.dataType}}const o={numVertices:this.numVertices(),numRenderVerts:a,indices:r,attrBuffers:n};if(e&&e.includeVertexNeighbors){null==this.vertexEdges&&this.genTopologyInfo();let e=0;for(let t=0;t<this.vertexEdges.length;t++)this.vertexEdges[t]&&(e+=this.vertexEdges[t].size);const t=new Uint32Array(2*this.vertexEdges.length+e),i=e=>{for(let t=0;t<e.length;t++){const i=e[t];for(let s=0;s<t;s++){const a=e[s];if(-1!=i[0]&&i[0]==a[1]){t!=s+1&&(e.splice(t,1),e.splice(s+1,0,i));break}if(-1!=i[1]&&i[1]==a[0]){e.splice(t,1),e.splice(s,0,i);break}}}},s=e=>{if(!(-1!=e[0][0]&&-1!=e[e.length-1][1]||-1==e[0][0]&&-1==e[e.length-1][1]))throw new Error("If fan starts with -1, it must also end with -1");for(let t=0;t<e.length;t++){const i=e[t];if((-1==i[0]||-1==i[1])&&0!=t&&t!=e.length-1)throw new Error("-1 only allowed at the beginning and end of a fan.");if(-1!=i[0]){let s=t-1;if(s<0&&(s+=e.length),i[0]!=e[s][1])throw new Error("Faces are not sequential")}if(-1!=i[1]){const s=(t+1)%e.length;if(i[1]!=e[s][0])throw new Error("Faces are not sequential")}}};let a=2*this.vertexEdges.length;for(let e=0;e<this.vertexEdges.length;e++){if(null==this.vertexEdges[e])continue;const r=this.vertexEdges[e],n=[];for(const t of r){const i=this.edgeVerts[2*t],s=this.edgeVerts[2*t+1];let a,r=this.edgeFaces[2*t],o=this.edgeFaces[2*t+1];if(i==e)a=s;else{if(s!=e)throw new Error("Invalid topology");{a=i;const e=r;r=o,o=e}}n.push([r,o,a])}i(n),s(n);let o=0;(-1!=n[0][0]||-1!=n[n.length-1][1])&&(o+=1),t[2*e]=a,t[2*e+1]=r.size+(o<<8);for(const e of n)t[a]=e[2],a++}o.vertexNeighbors=t}return o}computeNumTriangles(){let e=3,t=0;for(const i of this.__faceCounts)t+=i*(e-2),e++;return t}generateTriangulatedIndices(e,t,i){const s=this.computeNumTriangles();let a;a=e<Math.pow(2,8)?new Uint8Array(3*s):e<Math.pow(2,16)?new Uint16Array(3*s):new Uint32Array(3*s);let r=0;const n=function(e,s){e in i&&s in i[e]&&(e=t+i[e][s]),a[r]=e,r++},o=this.getNumFaces();for(let e=0;e<o;e++){const t=this.getFaceVertexIndices(e);for(let i=0;i<t.length;i++)i>=3&&(n(t[0],e),n(t[i-1],e)),n(t[i],e)}return a}readBinary(e,t){super.loadBaseGeomBinary(e),this.setFaceCounts(e.loadUInt32Array());const i=this.getNumFaces(),s=e.loadUInt8Array(i),a=e.loadSInt32Vec2(),r=e.loadUInt8();let n;1==r?n=e.loadUInt8Array():2==r?n=e.loadUInt16Array():4==r&&(n=e.loadUInt32Array());let o=3,l=0;const h=this.__faceCounts.map(((e,t)=>{const i=l;return l+=e*o,o++,i}));let d=0,c=0;const u=[];for(let e=0;e<i;e++){const t=s[e],i=h[t],r=t+3;u[e]=i;for(let t=0;t<r;t++){const s=i+t,r=n[d+t]+a.x;if(0==e)this.__faceVertexIndices[s]=r;else{let i=u[e-1];i+=t<c?t:c-1,this.__faceVertexIndices[s]=this.__faceVertexIndices[i]+r}}d+=r,h[t]+=r,c=r}this.hasVertexAttribute("normals")||this.computeVertexNormals(),this.emit("geomDataChanged",{})}toJSON(e){const t=super.toJSON(e);return e&&e.skipTopology||(t.faceCounts=Array.from(this.__faceCounts),t.faceVertexIndices=Array.from(this.__faceVertexIndices)),t}fromJSON(e,t){super.fromJSON(e,t),e.faceCounts&&(this.__faceCounts=e.faceCounts),e.faceVertexIndices&&(this.__faceVertexIndices=Uint32Array.from(e.faceVertexIndices))}}oi.register("Mesh",Ms);class Ts extends Jt{constructor(e){if(super(),this.name=e.name,this.__buffers=e.geomBuffers,this.__buffers.attrBuffers)for(const e in this.__buffers.attrBuffers){const t=this.__buffers.attrBuffers[e],i=oi.getBlueprint(t.dataType);t.dataType=i}this.boundingBox=new xi,this.boundingBox.p0.__data=e.bbox.p0.__data,this.boundingBox.p1.__data=e.bbox.p1.__data,this.__metaData=new Map}getNumVertices(){return this.__buffers.numVertices}getBoundingBox(){return this.boundingBox}genBuffers(){return this.__buffers}getMetadata(e){return this.__metaData.get(e)}hasMetadata(e){return this.__metaData.has(e)}setMetadata(e,t){this.__metaData.set(e,t)}deleteMetadata(e){this.__metaData.delete(e)}}class Ls extends Ts{constructor(e){super(e)}}class Ss extends Ts{constructor(e){super(e)}}class Zs extends Ts{constructor(e){super(e)}}class Cs extends Rs{constructor(){super(),this.dirtyTopology=!0,this.dirtyVertices=!0,this.topologyParams=[]}clear(){this.dirtyTopology=!0,this.dirtyVertices=!0,super.clear()}rebuild(){}resize(){}__parameterValueChanged(e){this.setBoundingBoxDirty(),this.topologyParams.includes(e.param.getName())?(this.dirtyTopology=!0,this.emit("geomDataTopologyChanged")):(this.dirtyVertices=!0,this.setBoundingBoxDirty(),this.emit("geomDataChanged")),super.__parameterValueChanged(e)}update(){this.dirtyTopology?(this.rebuild(),this.dirtyTopology=!1,this.dirtyVertices=!1):this.dirtyVertices&&(this.resize(),this.dirtyVertices=!1)}getBoundingBox(){return this.update(),super.getBoundingBox()}getNumVertices(){return this.update(),super.getNumVertices()}genBuffers(e){return this.update(),super.genBuffers(e)}toJSON(e){e||(e={}),e.skipTopology=!0,e.skipAttributes=["positions","normals","texCoords"];const t=super.toJSON(e);return e.skipTopology=!1,e.skipAttributes=[],t}}class Fs extends ws{constructor(){super(),this.dirtyTopology=!0,this.dirtyVertices=!0,this.topologyParams=[]}clear(){this.dirtyTopology=!0,this.dirtyVertices=!0,super.clear()}rebuild(){}resize(){}__parameterValueChanged(e){this.setBoundingBoxDirty(),this.topologyParams.includes(e.param.getName())?(this.dirtyTopology=!0,this.emit("geomDataTopologyChanged")):(this.dirtyVertices=!0,this.setBoundingBoxDirty(),this.emit("geomDataChanged")),super.__parameterValueChanged(e)}update(){this.dirtyTopology?(this.rebuild(),this.dirtyTopology=!1,this.dirtyVertices=!1):this.dirtyVertices&&(this.resize(),this.dirtyVertices=!1)}getBoundingBox(){return this.update(),super.getBoundingBox()}getNumVertices(){return this.update(),super.getNumVertices()}genBuffers(e){return this.update(),super.genBuffers(e)}toJSON(e){e||(e={}),e.skipTopology=!0,e.skipAttributes=["positions","normals","texCoords"];const t=super.toJSON(e);return e.skipTopology=!1,e.skipAttributes=[],t}fromJSON(e,t){super.fromJSON(e,t)}}class Es extends Ms{constructor(){super(),this.dirtyTopology=!0,this.dirtyVertices=!0,this.topologyParams=[]}clear(){this.dirtyTopology=!0,this.dirtyVertices=!0,super.clear()}rebuild(){}resize(){}__parameterValueChanged(e){this.setBoundingBoxDirty(),this.topologyParams.includes(e.param.getName())?(this.dirtyTopology=!0,this.emit("geomDataTopologyChanged")):(this.dirtyVertices=!0,this.setBoundingBoxDirty(),this.emit("geomDataChanged")),super.__parameterValueChanged(e)}update(){this.dirtyTopology?(this.vertexEdges=void 0,this.rebuild(),this.dirtyTopology=!1,this.dirtyVertices=!1):this.dirtyVertices&&(this.resize(),this.dirtyVertices=!1)}getBoundingBox(){return this.update(),super.getBoundingBox()}getNumVertices(){return this.update(),super.getNumVertices()}genBuffers(e){return this.update(),super.genBuffers(e)}toJSON(e){e||(e={}),e.skipTopology=!0,e.skipAttributes=["positions","normals","texCoords"];const t=super.toJSON(e);return e.skipTopology=!1,e.skipAttributes=[],t}}class zs extends Cs{constructor(e=1,t=1,i=1,s=1,a=!1){if(super(),isNaN(e)||isNaN(t)||isNaN(i)||isNaN(s))throw new Error("Invalid geom args");this.__x=this.addParameter(new Bi("X",e)),this.__y=this.addParameter(new Bi("Y",t)),this.__xDivisions=this.addParameter(new Bi("XDivisions",i)),this.__yDivisions=this.addParameter(new Bi("YDivisions",s)),a&&this.addVertexAttribute("texCoords",hi),this.topologyParams.push("XDivisions"),this.topologyParams.push("YDivisions")}rebuild(){const e=this.__xDivisions.getValue(),t=this.__yDivisions.getValue();this.setNumVertices(e*t);const i=this.getVertexAttribute("texCoords");if(i)for(let s=0;s<t;s++){const a=s/(t-1);for(let t=0;t<e;t++){const r=t/(e-1);i.getValueRef(s*e+t).set(r,a)}}this.resize()}resize(){const e=this.__x.getValue(),t=this.__y.getValue(),i=this.__xDivisions.getValue(),s=this.__yDivisions.getValue(),a=this.getVertexAttribute("positions");for(let r=0;r<s;r++){const n=(r/(s-1)-.5)*t;for(let t=0;t<i;t++){const s=(t/(i-1)-.5)*e;a.getValueRef(r*i+t).set(s,n,0)}}}}oi.register("PointGrid",zs);class Ns extends Fs{constructor(e=1,t=1){if(super(),isNaN(e)||isNaN(t))throw new Error("Invalid geom args");this.__x=this.addParameter(new Bi("X",e)),this.__y=this.addParameter(new Bi("Y",t))}rebuild(){this.setNumVertices(4),this.setNumSegments(4),this.setSegmentVertexIndices(0,0,1),this.setSegmentVertexIndices(1,1,2),this.setSegmentVertexIndices(2,2,3),this.setSegmentVertexIndices(3,3,0),this.resize()}resize(){const e=this.__x.getValue(),t=this.__y.getValue(),i=this.getVertexAttribute("positions");i.getValueRef(0).set(-.5*e,-.5*t,0),i.getValueRef(1).set(.5*e,-.5*t,0),i.getValueRef(2).set(.5*e,.5*t,0),i.getValueRef(3).set(-.5*e,.5*t,0)}}oi.register("Rect",Ns);class Ps extends Fs{constructor(e=1,t=32,i=2*Math.PI){if(super(),isNaN(e)||isNaN(t))throw new Error("Invalid geom args");this.__radius=this.addParameter(new Bi("Radius",e)),this.__angle=this.addParameter(new Bi("Angle",i)),this.__numSegments=this.addParameter(new Bi("NumSegments",t>=3?t:3,[3,200],1)),this.topologyParams.push("NumSegments")}rebuild(){const e=this.__numSegments.getValue();this.setNumVertices(e);const t=this.__angle.getValue()<2*Math.PI;t?this.setNumSegments(e-1):this.setNumSegments(e);for(let i=0;i<(t?e-1:e);i++)this.setSegmentVertexIndices(i,i,(i+1)%e);this.resize()}resize(){const e=this.__radius.getValue(),t=this.__numSegments.getValue(),i=this.__angle.getValue()/t,s=this.getVertexAttribute("positions");for(let a=0;a<t;a++)s.getValueRef(a).set(Math.cos(i*a)*e,Math.sin(i*a)*e,0)}}oi.register("Circle",Ps);class Ws extends Fs{constructor(e=1){if(super(),isNaN(e))throw new Error("Invalid geom args");this.__sizeParam=this.addParameter(new Bi("Size",e))}rebuild(){this.setNumVertices(6),this.setNumSegments(3),this.setSegmentVertexIndices(0,0,1),this.setSegmentVertexIndices(1,2,3),this.setSegmentVertexIndices(2,4,5),this.resize()}resize(){const e=this.__sizeParam.getValue(),t=this.getVertexAttribute("positions");t.getValueRef(0).set(-.5*e,0,0),t.getValueRef(1).set(.5*e,0,0),t.getValueRef(2).set(0,.5*e,0),t.getValueRef(3).set(0,-.5*e,0),t.getValueRef(4).set(0,0,.5*e),t.getValueRef(5).set(0,0,-.5*e)}}oi.register("Cross",Ws);class Bs extends Fs{constructor(e=1,t=1,i=1,s=!1){super(),this.__x=this.addParameter(new Bi("X",e)),this.__y=this.addParameter(new Bi("Y",t)),this.__z=this.addParameter(new Bi("Z",i)),this.__baseZAtZero=this.addParameter(new Bi("BaseZAtZero",s))}rebuild(){this.setNumVertices(8),this.setNumSegments(12),this.setSegmentVertexIndices(0,0,1),this.setSegmentVertexIndices(1,1,2),this.setSegmentVertexIndices(2,2,3),this.setSegmentVertexIndices(3,3,0),this.setSegmentVertexIndices(4,4,5),this.setSegmentVertexIndices(5,5,6),this.setSegmentVertexIndices(6,6,7),this.setSegmentVertexIndices(7,7,4),this.setSegmentVertexIndices(8,0,4),this.setSegmentVertexIndices(9,1,5),this.setSegmentVertexIndices(10,2,6),this.setSegmentVertexIndices(11,3,7),this.resize()}resize(){const e=this.__x.getValue(),t=this.__y.getValue(),i=this.__z.getValue(),s=this.__baseZAtZero.getValue(),a=this.getVertexAttribute("positions");let r=.5;s&&(r=1),a.getValueRef(0).set(.5*e,-.5*t,r*i),a.getValueRef(1).set(.5*e,.5*t,r*i),a.getValueRef(2).set(-.5*e,.5*t,r*i),a.getValueRef(3).set(-.5*e,-.5*t,r*i),r=-.5,s&&(r=0),a.getValueRef(4).set(.5*e,-.5*t,r*i),a.getValueRef(5).set(.5*e,.5*t,r*i),a.getValueRef(6).set(-.5*e,.5*t,r*i),a.getValueRef(7).set(-.5*e,-.5*t,r*i)}}oi.register("LinesCuboid",Bs);class Ys extends Fs{constructor(e=1,t=1,i=10,s=10,a=!1){if(super(),isNaN(e)||isNaN(t)||isNaN(i)||isNaN(s))throw new Error("Invalid geom args");this.__xParam=this.addParameter(new Bi("X",e)),this.__yParam=this.addParameter(new Bi("Y",t)),this.__xDivisionsParam=this.addParameter(new Bi("XDivisions",i)),this.__yDivisionsParam=this.addParameter(new Bi("YDivisions",s)),this.__skipCenterLinesParam=this.addParameter(new Ai("SkipCenterLines",a)),this.topologyParams.push("XDivisions"),this.topologyParams.push("YDivisions"),this.topologyParams.push("SkipCenterLines")}rebuild(){const e=this.__xDivisionsParam.getValue(),t=this.__yDivisionsParam.getValue(),i=this.__skipCenterLinesParam.getValue()&&e%2==0&&t%2==0;this.setNumVertices(2*(e+t+2-(i?1:0))),this.setNumSegments(e+t+2-(i?1:0));let s=0;for(let t=0;t<=e;t++){if(i&&t==e/2)continue;const a=2*s,r=2*s+1;this.setSegmentVertexIndices(s,a,r),s++}for(let a=0;a<=t;a++){if(i&&a==e/2)continue;const t=2*s,r=2*s+1;this.setSegmentVertexIndices(s,t,r),s++}this.resize()}resize(){const e=this.getVertexAttribute("positions"),t=this.__xDivisionsParam.getValue(),i=this.__yDivisionsParam.getValue(),s=this.__xParam.getValue(),a=this.__yParam.getValue(),r=this.__skipCenterLinesParam.getValue()&&t%2==0&&i%2==0;let n=0;for(let i=0;i<=t;i++){if(r&&i==t/2)continue;const o=2*n,l=2*n+1,h=(i/t-.5)*s;e.getValueRef(o).set(h,-.5*a,0),e.getValueRef(l).set(h,.5*a,0),n++}for(let o=0;o<=i;o++){if(r&&o==t/2)continue;const l=2*n,h=2*n+1,d=(o/i-.5)*a;e.getValueRef(l).set(-.5*s,d,0),e.getValueRef(h).set(.5*s,d,0),n++}}}oi.register("Grid",Ys);class As extends Es{constructor(e=.5,t=1,i=32,s=!0,a=!0,r=!0){if(super(),isNaN(e)||isNaN(t)||isNaN(i))throw new Error("Invalid geom args");this.__radiusParam=this.addParameter(new Bi("Radius",e)),this.__heightParam=this.addParameter(new Bi("Height",t)),this.__detailParam=this.addParameter(new Bi("Detail",i>=3?i:3,[3,200],1)),this.__capParam=this.addParameter(new Ai("Cap",s)),a&&this.addVertexAttribute("normals",di),r&&this.addVertexAttribute("texCoords",hi),this.topologyParams.push("Detail"),this.topologyParams.push("Cap")}rebuild(){const e=this.__detailParam.getValue(),t=this.__radiusParam.getValue(),i=this.__heightParam.getValue(),s=this.__capParam.getValue();let a=e+1;s&&(a+=1),this.setNumVertices(a);const r=e,n=e+1,o=this.getVertexAttribute("positions");o.getValueRef(r).set(0,0,i);for(let i=0;i<e;i++){const s=-i/e*2*Math.PI;o.getValueRef(i).set(t*Math.cos(s),t*Math.sin(s),0)}s&&o.getValueRef(n).set(0,0,0),this.setFaceCounts([e+(s?e:0)]);for(let t=0;t<e;t++){const i=(t+1)%e;this.setFaceVertexIndices(t,[i,t,r])}if(s)for(let t=0;t<e;t++){const i=(t+1)%e;this.setFaceVertexIndices(e+t,[t,i,n])}const l=this.getVertexAttribute("texCoords");if(l){let t=0;for(let i=0;i<e;i++)l.setFaceVertexValue(t,0,new hi((i+1)/e,0)),l.setFaceVertexValue(t,1,new hi(i/e,0)),l.setFaceVertexValue(t,2,new hi((i+.5)/e,1));if(s)for(let i=0;i<e;i++)l.setFaceVertexValue(t,0,new hi(i/e,0)),l.setFaceVertexValue(t,1,new hi((i+1)/e,0)),l.setFaceVertexValue(t,2,new hi((i+.5)/e,1)),t++}this.resize()}resize(){const e=this.__detailParam.getValue(),t=this.__radiusParam.getValue(),i=this.__heightParam.getValue();this.__capParam.getValue();const s=e,a=e+1,r=this.getVertexAttribute("positions");r.getValueRef(s).set(0,0,i);for(let i=0;i<e;i++){const s=-i/e*2*Math.PI;r.getValueRef(i).set(t*Math.cos(s),t*Math.sin(s),0)}this.__cap&&r.getValueRef(a).set(0,0,0);this.getVertexAttribute("normals")&&this.computeVertexNormals()}}oi.register("Cone",As);class Ds extends Es{constructor(e=1,t=1,i=1,s=!1){if(super(),isNaN(e)||isNaN(t)||isNaN(i))throw new Error("Invalid geom args");this.__xParam=this.addParameter(new Bi("X",e)),this.__yParam=this.addParameter(new Bi("Y",t)),this.__zParam=this.addParameter(new Bi("Z",i)),this.__baseZAtZeroParam=this.addParameter(new Ai("BaseZAtZero",s)),this.setFaceCounts([0,6]),this.setFaceVertexIndices(0,[0,1,2,3]),this.setFaceVertexIndices(1,[7,6,5,4]),this.setFaceVertexIndices(2,[1,0,4,5]),this.setFaceVertexIndices(3,[3,2,6,7]),this.setFaceVertexIndices(4,[0,3,7,4]),this.setFaceVertexIndices(5,[2,1,5,6]),this.setNumVertices(8),this.addVertexAttribute("texCoords",hi),this.addVertexAttribute("normals",di)}setSize(e,t,i){this.__xParam.setValue(e),this.__yParam.setValue(t),this.__zParam.setValue(i)}setBaseSize(e,t){this.__xParam.setValue(e),this.__yParam.setValue(t)}rebuild(){const e=this.getVertexAttribute("normals");for(let t=0;t<6;t++){let i;switch(t){case 0:i=new di(0,0,1);break;case 1:i=new di(0,0,-1);break;case 2:i=new di(1,0,0);break;case 3:i=new di(-1,0,0);break;case 4:i=new di(0,-1,0);break;case 5:i=new di(0,1,0)}e.setFaceVertexValue(t,0,i),e.setFaceVertexValue(t,1,i),e.setFaceVertexValue(t,2,i),e.setFaceVertexValue(t,3,i)}const t=this.getVertexAttribute("texCoords");for(let e=0;e<6;e++)t.setFaceVertexValue(e,0,new hi(0,0)),t.setFaceVertexValue(e,1,new hi(1,0)),t.setFaceVertexValue(e,2,new hi(1,1)),t.setFaceVertexValue(e,3,new hi(0,1));this.resize()}resize(){const e=this.__xParam.getValue(),t=this.__yParam.getValue(),i=this.__zParam.getValue(),s=this.__baseZAtZeroParam.getValue();let a=.5;const r=this.getVertexAttribute("positions");s&&(a=1),r.getValueRef(0).set(.5*e,-.5*t,a*i),r.getValueRef(1).set(.5*e,.5*t,a*i),r.getValueRef(2).set(-.5*e,.5*t,a*i),r.getValueRef(3).set(-.5*e,-.5*t,a*i),a=-.5,s&&(a=0),r.getValueRef(4).set(.5*e,-.5*t,a*i),r.getValueRef(5).set(.5*e,.5*t,a*i),r.getValueRef(6).set(-.5*e,.5*t,a*i),r.getValueRef(7).set(-.5*e,-.5*t,a*i)}}oi.register("Cuboid",Ds);class ks extends Es{constructor(e=.5,t=1,i=32,s=2,a=!0,r=!1){if(super(),isNaN(e)||isNaN(t)||isNaN(i)||isNaN(s))throw new Error("Invalid geom args");this.__radiusParam=this.addParameter(new Bi("Radius",e)),this.__heightParam=this.addParameter(new Bi("Height",t)),this.__sidesParam=this.addParameter(new Bi("Sides",i>=3?i:3,[3,200],1)),this.__loopsParam=this.addParameter(new Bi("Loops",s>=2?s:2,[1,200],1)),this.__capsParam=this.addParameter(new Ai("Caps",a)),this.__baseZAtZeroParam=this.addParameter(new Ai("BaseZAtZero",r)),this.addVertexAttribute("texCoords",hi),this.addVertexAttribute("normals",di),this.topologyParams.push("Sides"),this.topologyParams.push("Loops"),this.topologyParams.push("Caps")}rebuild(){const e=this.__sidesParam.getValue(),t=this.__loopsParam.getValue(),i=this.__capsParam.getValue();let s=e*t;i&&(s+=2),this.setNumVertices(s),i?this.setFaceCounts([2*e,e]):this.setFaceCounts([0,e]);let a=0;if(i){for(let t=0;t<e;t++){const i=s-1,r=t,n=(t+1)%e;this.setFaceVertexIndices(a++,[i,r,n])}for(let i=0;i<e;i++){const r=e*(t-1)+i,n=s-2,o=e*(t-1)+(i+1)%e;this.setFaceVertexIndices(a++,[r,n,o])}}for(let i=0;i<t-1;i++)for(let t=0;t<e;t++){const s=e*i+(t+1)%e,r=e*i+t,n=e*(i+1)+t,o=e*(i+1)+(t+1)%e;this.setFaceVertexIndices(a++,[s,r,n,o])}const r=this.getVertexAttribute("normals");if(a=0,i){const t=new di(0,0,-1);for(let i=0;i<e;i++)r.setFaceVertexValue(a,0,t),r.setFaceVertexValue(a,1,t),r.setFaceVertexValue(a,2,t),a++;t.set(0,0,1);for(let i=0;i<e;i++)r.setFaceVertexValue(a,0,t),r.setFaceVertexValue(a,1,t),r.setFaceVertexValue(a,2,t),a++}for(let i=0;i<t-1;i++)for(let t=0;t<e;t++){let i=t/e*2*Math.PI;const s=new di(Math.sin(i),Math.cos(i),0);r.setFaceVertexValue(a,0,s),r.setFaceVertexValue(a,1,s),i=(t+1)/e*2*Math.PI;const n=new di(Math.sin(i),Math.cos(i),0);r.setFaceVertexValue(a,2,n),r.setFaceVertexValue(a,3,n),a++}const n=this.getVertexAttribute("texCoords");if(a=0,i){for(let t=0;t<e;t++)n.setFaceVertexValue(a,0,new hi(t/e,0)),n.setFaceVertexValue(a,1,new hi((t+1)/e,0)),n.setFaceVertexValue(a,2,new hi((t+.5)/e,1)),a++;for(let t=0;t<e;t++)n.setFaceVertexValue(a,0,new hi(t/e,0)),n.setFaceVertexValue(a,1,new hi((t+1)/e,0)),n.setFaceVertexValue(a,2,new hi((t+.5)/e,1)),a++}for(let t=0;t<e;t++)n.setFaceVertexValue(a,0,new hi((t+1)/e,0)),n.setFaceVertexValue(a,2,new hi((t+1)/e,1)),n.setFaceVertexValue(a,1,new hi(t/e,0)),n.setFaceVertexValue(a,3,new hi(t/e,1)),a++;this.resize()}resize(){const e=this.__sidesParam.getValue(),t=this.__loopsParam.getValue(),i=this.__radiusParam.getValue(),s=this.__heightParam.getValue(),a=this.__capsParam.getValue(),r=this.__baseZAtZeroParam.getValue();let n=e*t;a&&(n+=2);let o=0,l=.5;r&&(l=0);const h=this.getVertexAttribute("positions");for(let a=0;a<t;a++){const r=a/(t-1)*s-s*l;for(let t=0;t<e;t++){const s=t/e*2*Math.PI;h.getValueRef(o).set(Math.sin(s)*i,Math.cos(s)*i,r),o++}}a&&(h.getValueRef(n-1).set(0,0,s*(r?0:-.5)),h.getValueRef(n-2).set(0,0,s*(r?1:.5))),this.computeVertexNormals()}}oi.register("Cylinder",ks);class Ks extends Es{constructor(e=.5,t=32){if(super(),isNaN(e)||isNaN(t))throw new Error("Invalid geom args");this.__radiusParam=this.addParameter(new Bi("Radius",e)),this.__sidesParam=this.addParameter(new Bi("Sides",t>=3?t:3,[3,200],1)),this.addVertexAttribute("texCoords",hi),this.addVertexAttribute("normals",di),this.topologyParams.push("Sides")}rebuild(){const e=this.__sidesParam.getValue();this.setNumVertices(e+1),this.setFaceCounts([e]);this.getVertexAttribute("positions").getValueRef(0).set(0,0,0);for(let t=0;t<e;t++){const i=t%e+1,s=(t+1)%e+1;this.setFaceVertexIndices(t,[0,i,s])}const t=this.getVertexAttribute("normals"),i=new di(0,0,1);t.setValue(0,i);for(let s=0;s<e;s++)t.setValue(s+1,i);const s=this.getVertexAttribute("texCoords");s.getValueRef(0).set(.5,.5);for(let t=0;t<e;t++){const i=t/e*-2*Math.PI;s.getValueRef(t+1).set(.5*Math.sin(i)+.5,.5*Math.cos(i)+.5)}this.resize()}resize(){const e=this.__sidesParam.getValue(),t=this.__radiusParam.getValue(),i=this.getVertexAttribute("positions");for(let s=0;s<e;s++){const a=s/e*-2*Math.PI;i.getValueRef(s+1).set(Math.sin(a)*t,Math.cos(a)*t,0)}}}oi.register("Disc",Ks);class Hs extends Es{constructor(e=1,t=1,i=1,s=1,a=!0,r=!0){if(super(),isNaN(e)||isNaN(t)||isNaN(i)||isNaN(s))throw new Error("Invalid geom args");this.__sizeXParam=this.addParameter(new Bi("SizeX",e)),this.__sizeYParam=this.addParameter(new Bi("SizeY",t)),this.__detailXParam=this.addParameter(new Bi("DetailX",i)),this.__detailYParam=this.addParameter(new Bi("DetailY",s)),a&&this.addVertexAttribute("normals",di),r&&this.addVertexAttribute("texCoords",hi),this.topologyParams.push("DetailX"),this.topologyParams.push("DetailY")}rebuild(){const e=this.__detailXParam.getValue(),t=this.__detailYParam.getValue();this.setNumVertices((e+1)*(t+1)),this.setFaceCounts([0,e*t]);let i=0;for(let s=0;s<t;s++)for(let t=0;t<e;t++){const a=(e+1)*(s+1)+(t+1),r=(e+1)*(s+1)+t,n=(e+1)*s+t,o=(e+1)*s+(t+1);this.setFaceVertexIndices(i,[a,r,n,o]),i+=1}let s=0;const a=this.getVertexAttribute("normals");if(a)for(let i=0;i<=t;i++)for(let t=0;t<=e;t++)a.getValueRef(s).set(0,0,1),s++;s=0;const r=this.getVertexAttribute("texCoords");if(r)for(let i=0;i<=t;i++){const a=i/t;for(let t=0;t<=e;t++){const i=t/e;r.getValueRef(s).set(i,a),s++}}this.resize()}resize(){const e=this.__sizeXParam.getValue(),t=this.__sizeYParam.getValue(),i=this.__detailXParam.getValue(),s=this.__detailYParam.getValue(),a=this.getVertexAttribute("positions");let r=0;for(let n=0;n<=s;n++){const o=(n/s-.5)*t;for(let t=0;t<=i;t++){const s=(t/i-.5)*e;a.getValueRef(r).set(s,o,0),r++}}}}oi.register("Plane",Hs);class Us extends Es{constructor(e=1,t=12,i=12,s=!0,a=!0){if(super(),isNaN(e)||isNaN(t)||isNaN(i))throw new Error("Invalid geom args");this.__radiusParam=this.addParameter(new Bi("Radius",e)),this.__sidesParam=this.addParameter(new Bi("Sides",t>=3?t:3,[3,200],1)),this.__loopsParam=this.addParameter(new Bi("Loops",i>=3?i:3,[3,200],1)),s&&this.addVertexAttribute("normals",di),a&&this.addVertexAttribute("texCoords",hi),this.topologyParams.push("Sides"),this.topologyParams.push("Loops")}rebuild(){const e=this.__radiusParam.getValue(),t=this.__sidesParam.getValue(),i=this.__loopsParam.getValue(),s=2+t*i,a=2*t,r=t*i;this.setNumVertices(s),this.setFaceCounts([a,r]),console.log("rebuild");const n=this.getVertexAttribute("positions"),o=this.getVertexAttribute("normals"),l=new di(0,0,1);let h=0;n.getValueRef(h).set(0,0,e),o&&o.getValueRef(h).set(0,0,1),h++;for(let s=0;s<i;s++){const a=(s+1)/(i+1)*Math.PI;for(let i=0;i<t;i++){const s=-i/t*2*Math.PI;l.set(Math.sin(a)*Math.cos(s),Math.sin(a)*Math.sin(s),Math.cos(a)),n.getValueRef(h).setFromOther(l.scale(e)),o&&o.getValueRef(h).setFromOther(l),h++}}n.getValueRef(h).set(0,0,-e),o&&o.getValueRef(h).set(0,0,-1),h++;const d=this.getVertexAttribute("texCoords");let c=0;for(let e=0;e<t;e++){const s=0,a=(e+1)%t+1,r=e+1;if(this.setFaceVertexIndices(c,[s,a,r]),d){const s=new hi(.5,0),a=new hi((e+1)/(t-1),1/(i+1)),r=new hi(e/(t-1),1/(i+1));d.setFaceVertexValue(c,0,s),d.setFaceVertexValue(c,1,a),d.setFaceVertexValue(c,2,r)}c++}for(let e=0;e<t;e++){const a=s-1,r=t*(i-1)+(e+1)%t+1,n=t*(i-1)+e+1;if(this.setFaceVertexIndices(c,[a,n,r]),d){const s=new hi(.5,1),a=new hi((e+1)/(t-1),1-1/(i+1)),r=new hi(e/(t-1),1-1/(i+1));d.setFaceVertexValue(c,0,s),d.setFaceVertexValue(c,1,a),d.setFaceVertexValue(c,2,r)}c++}for(let e=0;e<i-1;e++)for(let s=0;s<t;s++){const a=t*e+s+1,r=t*e+(s+1)%t+1,n=t*(e+1)+(s+1)%t+1,o=t*(e+1)+s+1;this.setFaceVertexIndices(c,[a,r,n,o]),d&&(d.setFaceVertexValue(c,0,new hi(s/t,(e+1)/i)),d.setFaceVertexValue(c,1,new hi((s+1)/t,(e+1)/i)),d.setFaceVertexValue(c,2,new hi((s+1)/t,(e+2)/i)),d.setFaceVertexValue(c,3,new hi(s/t,(e+2)/i))),c++}}resize(){const e=this.__radiusParam.getValue(),t=this.__sidesParam.getValue(),i=this.__loopsParam.getValue(),s=this.getVertexAttribute("positions"),a=this.getVertexAttribute("normals");let r=0;const n=new di(0,0,1);s.getValueRef(r).set(0,0,e),a&&a.getValueRef(r).set(0,0,1),r++;for(let o=0;o<i;o++){const l=(o+1)/(i+1)*Math.PI;for(let i=0;i<t;i++){const o=i/t*2*Math.PI;n.set(Math.sin(l)*Math.cos(o),Math.sin(l)*Math.sin(o),Math.cos(l)),s.getValueRef(r).setFromOther(n.scale(e)),a&&a.getValueRef(r).setFromOther(n),r++}}s.getValueRef(r).set(0,0,-e),a&&a.getValueRef(r).set(0,0,-1),r++}}oi.register("Sphere",Us);class Os extends Es{constructor(e=.5,t=3,i=32,s=2*Math.PI){if(super(),isNaN(e)||isNaN(t)||isNaN(i))throw new Error("Invalid geom args");this.__innerRadiusParam=this.addParameter(new Bi("InnerRadius",e)),this.__outerRadiusParam=this.addParameter(new Bi("OuterRadius",t)),this.__detailParam=this.addParameter(new Bi("Detail",i>=3?i:3,[3,200],1)),this.__arcAngleParam=this.addParameter(new Bi("ArcAngle",s)),this.addVertexAttribute("texCoords",hi),this.addVertexAttribute("normals",di),this.topologyParams.push("Detail"),this.topologyParams.push("ArcAngle")}rebuild(){const e=this.__arcAngleParam.getValue()<2*Math.PI,t=this.__detailParam.getValue(),i=t,s=2*t+(e?1:0),a=i*s;this.setNumVertices(a),this.setFaceCounts([0,i*s]);const r=this.getVertexAttribute("texCoords");let n=0;for(let t=0;t<(e?s-1:s);t++)for(let e=0;e<i;e++){const a=(t+1)%s,o=(e+1)%i,l=i*t+e,h=i*t+o,d=i*a+o,c=i*a+e;this.setFaceVertexIndices(n,[l,h,d,c]),r.setFaceVertexValue(n,0,new hi(t/s,e/s)),r.setFaceVertexValue(n,1,new hi(t/s,(e+1)/s)),r.setFaceVertexValue(n,2,new hi((t+1)/s,(e+1)/s)),r.setFaceVertexValue(n,3,new hi((t+1)/s,e/s)),n++}this.resize()}resize(){const e=this.__innerRadiusParam.getValue(),t=this.__outerRadiusParam.getValue(),i=this.__arcAngleParam.getValue(),s=this.__detailParam.getValue(),a=i<2*Math.PI,r=s,n=2*s+(a?1:0),o=this.getVertexAttribute("positions"),l=this.getVertexAttribute("normals");let h=0;for(let s=0;s<n;s++){const d=-s/(a?n-1:n)*i,c=Math.cos(d),u=Math.sin(d);for(let i=0;i<r;i++){const s=i/r*2*Math.PI,a=Math.sin(s),n=Math.cos(s),d=t+n*e;o.getValueRef(h).set(c*d,u*d,e*a),l.getValueRef(h).set(c*n,u*n,a),h++}}}}oi.register("Torus",Os);class Js extends ps{constructor(e){super(),null==e&&(e=this.constructor.name),this.__name=e,this.format="RGBA",this.type="UNSIGNED_BYTE",this.__loaded=!1,this.width=1,this.height=1}isLoaded(){return this.__loaded}getName(){return this.__name}isStream(){return!1}setData(e,t,i){this.width=e,this.height=t,this.__data=i,this.__loaded?this.emit("updated",{}):(this.__loaded=!0,this.emit("loaded",{}))}getParams(){const e=super.getParams();return e.data=this.__data,e}}oi.register("DataImage2D",Js),oi.register("DataImage",Js);const Qs={};class js extends ps{constructor(e,t="",i={}){t.constructor==Object&&(i=t),null!=e&&e.includes(".")&&(console.warn("Deprecated signature. Please provide a name and filepath to the image constructor"),e=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."))),super(e,i),this.type="UNSIGNED_BYTE",this.__crossOrigin="anonymous",this.__loaded=!1;const s=this.addParameter(new fs("FilePath"));s.on("valueChanged",(()=>{if(this.loaded=!1,""==this.getName()){const e=s.getStem(),t=e.substring(e.length-1);isNaN(t)?this.setName(e):this.setName(e.substring(0,e.length-1))}if(s.getValue()){const e=s.getUrl();this.load(e)}})),t&&""!=t&&s.setFilepath(t)}static __imageDataLibrary(){return Qs}setCrossOrigin(e){this.__crossOrigin=e}load(e,t="RGB"){return new Promise(((i,s)=>{if(!t){const i=e.lastIndexOf(".");if(-1!=i){".png"==e.substring(i).toLowerCase()&&(t="RGBA")}}let a;this.format=t,this.__loaded=!1;const r=()=>{this.getDOMElement=()=>a,this.url=e,this.width=a.width,this.height=a.height,this.__data=a,this.__loaded=!0,this.emit("loaded",{}),i()},n=js.__imageDataLibrary();e in n?(a=n[e],a.complete?r():a.addEventListener("load",r)):(a=new Image,a.crossOrigin=this.__crossOrigin,a.src=e,a.addEventListener("load",r),n[e]=a)}))}setImageURL(e,t="RGB"){this.load(e,t)}isLoaded(){return this.__loaded}getParams(){const e=super.getParams();return this.__loaded&&(e.data=this.__data),e}toJSON(e){}fromJSON(e,t){}readBinary(e,t){this.setName(e.loadStr());let i=e.loadStr();if("string"==typeof i&&""!=i){if(t.lod>=0){const e=i.lastIndexOf(".");if(-1!=e){const s=i.substring(0,e)+t.lod+i.substring(e);ms.resolveFilepath(s)&&(i=s)}}this.getParameter("FilePath").setFilepath(i)}}}class qs extends js{constructor(e,t={}){console.warn("FileImage2D is becoming deprecated in favor of simple FileImage"),super(e,t)}}oi.register("FileImage2D",js),oi.register("FileImage",js);class $s extends js{constructor(e,t,i){super(e,t,i)}}oi.register("LDRImage",$s);class ea extends js{constructor(e,t,i){super(e,t,i),this.format="RGB",this.type="UNSIGNED_BYTE",this.addParameter(new Ai("Mute",!1)),this.addParameter(new Ai("Loop",!0)),this.addParameter(new Bi("Gain",2)).setRange([0,5]),this.addParameter(new Ai("SpatializeAudio",!0)),this.addParameter(new Bi("refDistance",2)),this.addParameter(new Bi("maxDistance",1e4)),this.addParameter(new Bi("rolloffFactor",1)),this.addParameter(new Bi("coneInnerAngle",360)),this.addParameter(new Bi("coneOuterAngle",0)),this.addParameter(new Bi("coneOuterGain",1))}load(e,t="RGB"){return new Promise(((t,i)=>{ms.incrementWorkload(1);const s=document.createElement("video");s.style.display="none",s.preload="auto",s.crossOrigin="anonymous",this.getAudioSource=()=>s,document.body.appendChild(s),s.addEventListener("loadedmetadata",(()=>{const e=this.getParameter("Mute");s.muted=e.getValue(),e.on("valueChanged",(()=>{s.muted=e.getValue()}));const i=this.getParameter("Loop");s.loop=i.getValue(),i.on("valueChanged",(()=>{s.loop=i.getValue()})),this.width=s.videoHeight,this.height=s.videoWidth,this.__data=s,this.__loaded=!0,ms.incrementWorkDone(1),this.emit("loaded",{}),t();let a=0;const r=()=>{if(s.paused||s.ended)return;const e=Math.floor(29.97*s.currentTime);a!=e&&(this.emit("updated",{}),a=e),setTimeout(r,20)};r()}),!1),s.src=e;const a=s.play();void 0!==a&&a.then((e=>{console.log("Autoplay started!")})).catch((()=>{console.log("Autoplay was prevented.")}))}))}}function ta(e){this.data=e,this.pos=0}function ia(e){this.stream=new ta(e),this.output={}}oi.register("LDRVideo",ea),ta.prototype.readByte=function(){return this.data[this.pos++]},ta.prototype.peekByte=function(){return this.data[this.pos]},ta.prototype.readBytes=function(e){for(var t=new Array(e),i=0;i<e;i++)t[i]=this.readByte();return t},ta.prototype.peekBytes=function(e){for(var t=new Array(e),i=0;i<e;i++)t[i]=this.data[this.pos+i];return t},ta.prototype.readString=function(e){for(var t="",i=0;i<e;i++)t+=String.fromCharCode(this.readByte());return t},ta.prototype.readBitArray=function(){for(var e=[],t=this.readByte(),i=7;i>=0;i--)e.push(!!(t&1<<i));return e},ta.prototype.readUnsigned=function(e){var t=this.readBytes(2);return e?(t[1]<<8)+t[0]:(t[0]<<8)+t[1]},ia.prototype.parse=function(e){return this.parseParts(this.output,e),this.output},ia.prototype.parseParts=function(e,t){for(var i=0;i<t.length;i++){var s=t[i];this.parsePart(e,s)}},ia.prototype.parsePart=function(e,t){var i,s=t.label;if(!t.requires||t.requires(this.stream,this.output,e))if(t.loop){for(var a=[];t.loop(this.stream);){var r={};this.parseParts(r,t.parts),a.push(r)}e[s]=a}else t.parts?(i={},this.parseParts(i,t.parts),e[s]=i):t.parser?(i=t.parser(this.stream,this.output,e),t.skip||(e[s]=i)):t.bits&&(e[s]=this.parseBits(t.bits))},ia.prototype.parseBits=function(e){var t={},i=this.stream.readBitArray();for(var s in e){var a=e[s];a.length?t[s]=i.slice(a.index,a.index+a.length).reduce((function(e,t){return 2*e+t}),0):t[s]=i[a.index]}return t};var sa=function(){return function(e){return e.readByte()}},aa=function(e){return function(t){return t.readBytes(e)}},ra=function(e){return function(t){return t.readString(e)}},na=function(e){return function(t){return t.readUnsigned(e)}},oa=function(e,t){return function(i,s,a){for(var r=t(i,s,a),n=new Array(r),o=0;o<r;o++)n[o]=i.readBytes(e);return n}},la={label:"blocks",parser:function(e){for(var t=[],i=e.readByte();0!==i;i=e.readByte())t=t.concat(e.readBytes(i));return t}},ha={label:"gce",requires:function(e){var t=e.peekBytes(2);return 33===t[0]&&249===t[1]},parts:[{label:"codes",parser:aa(2),skip:!0},{label:"byteSize",parser:sa()},{label:"extras",bits:{future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}}},{label:"delay",parser:na(!0)},{label:"transparentColorIndex",parser:sa()},{label:"terminator",parser:sa(),skip:!0}]},da={label:"image",requires:function(e){return 44===e.peekByte()},parts:[{label:"code",parser:sa(),skip:!0},{label:"descriptor",parts:[{label:"left",parser:na(!0)},{label:"top",parser:na(!0)},{label:"width",parser:na(!0)},{label:"height",parser:na(!0)},{label:"lct",bits:{exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}}}]},{label:"lct",requires:function(e,t,i){return i.descriptor.lct.exists},parser:oa(3,(function(e,t,i){return Math.pow(2,i.descriptor.lct.size+1)}))},{label:"data",parts:[{label:"minCodeSize",parser:sa()},la]}]},ca={label:"text",requires:function(e){var t=e.peekBytes(2);return 33===t[0]&&1===t[1]},parts:[{label:"codes",parser:aa(2),skip:!0},{label:"blockSize",parser:sa()},{label:"preData",parser:function(e,t,i){return e.readBytes(i.text.blockSize)}},la]},ua={label:"frames",parts:[ha,{label:"application",requires:function(e,t,i){var s=e.peekBytes(2);return 33===s[0]&&255===s[1]},parts:[{label:"codes",parser:aa(2),skip:!0},{label:"blockSize",parser:sa()},{label:"id",parser:function(e,t,i){return e.readString(i.blockSize)}},la]},{label:"comment",requires:function(e,t,i){var s=e.peekBytes(2);return 33===s[0]&&254===s[1]},parts:[{label:"codes",parser:aa(2),skip:!0},la]},da,ca],loop:function(e){var t=e.peekByte();return 33===t||44===t}},ma=[{label:"header",parts:[{label:"signature",parser:ra(3)},{label:"version",parser:ra(3)}]},{label:"lsd",parts:[{label:"width",parser:na(!0)},{label:"height",parser:na(!0)},{label:"gct",bits:{exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}}},{label:"backgroundColorIndex",parser:sa()},{label:"pixelAspectRatio",parser:sa()}]},{label:"gct",requires:function(e,t){return t.lsd.gct.exists},parser:oa(3,(function(e,t){return Math.pow(2,t.lsd.gct.size+1)}))},ua];function ga(e){var t=new ia(new Uint8Array(e));this.raw=t.parse(ma),this.raw.hasImages=!1;for(var i=0;i<this.raw.frames.length;i++)if(this.raw.frames[i].image){this.raw.hasImages=!0;break}}ga.prototype.decompressFrame=function(e,t){if(e>=this.raw.frames.length)return null;var i=this.raw.frames[e];if(i.image){var s=i.image.descriptor.width*i.image.descriptor.height,a=function(e,t,i){var s,a,r,n,o,l,h,d,c,u,m,g,_,f,p,b,y=4096,G=-1,X=i,x=new Array(i),I=new Array(y),V=new Array(y),v=new Array(y+1);for(o=(a=1<<(g=e))+1,s=a+2,h=G,r=(1<<(n=g+1))-1,c=0;c<a;c++)I[c]=0,V[c]=c;for(m=d=_=f=b=p=0,u=0;u<X;){if(0===f){if(d<n){m+=t[p]<<d,d+=8,p++;continue}if(c=m&r,m>>=n,d-=n,c>s||c==o)break;if(c==a){r=(1<<(n=g+1))-1,s=a+2,h=G;continue}if(h==G){v[f++]=V[c],h=c,_=c;continue}for(l=c,c==s&&(v[f++]=_,c=h);c>a;)v[f++]=V[c],c=I[c];_=255&V[c],v[f++]=_,s<y&&(I[s]=h,V[s]=_,0==(++s&r)&&s<y&&(n++,r+=s)),h=l}f--,x[b++]=v[f],u++}for(u=b;u<X;u++)x[u]=0;return x}(i.image.data.minCodeSize,i.image.data.blocks,s);i.image.descriptor.lct.interlaced&&(a=function(e,t){for(var i=new Array(e.length),s=e.length/t,a=function(s,a){var r=e.slice(a*t,(a+1)*t);i.splice.apply(i,[s*t,t].concat(r))},r=[0,4,2,1],n=[8,8,4,2],o=0,l=0;l<4;l++)for(var h=r[l];h<s;h+=n[l])a(h,o),o++;return i}(a,i.image.descriptor.width));var r={pixels:a,dims:{top:i.image.descriptor.top,left:i.image.descriptor.left,width:i.image.descriptor.width,height:i.image.descriptor.height}};return i.image.descriptor.lct&&i.image.descriptor.lct.exists?r.colorTable=i.image.lct:r.colorTable=this.raw.gct,i.gce&&(r.delay=10*(i.gce.delay||10),r.disposalType=i.gce.extras.disposal,i.gce.extras.transparentColorGiven&&(r.transparentIndex=i.gce.transparentColorIndex)),t&&(r.patch=function(e){for(var t=e.pixels.length,i=new Uint8ClampedArray(4*t),s=0;s<t;s++){var a=4*s,r=e.pixels[s],n=e.colorTable[r];i[a]=n[0],i[a+1]=n[1],i[a+2]=n[2],i[a+3]=r!==e.transparentIndex?255:0}return i}(r)),r}return null},ga.prototype.decompressFrames=function(e){for(var t=[],i=0;i<this.raw.frames.length;i++){this.raw.frames[i].image&&t.push(this.decompressFrame(i,e))}return t};class _a extends js{constructor(e,t="",i={}){super(e,t,i),this.format="RGBA",this.type="UNSIGNED_BYTE",this.__streamAtlas=!0,this.addParameter(new Ki("StreamAtlasDesc")),this.addParameter(new Bi("StreamAtlasIndex",0));const s=this.getParameter("StreamAtlasIndex");let a;s.setRange([0,1]);let r=0;const n=e=>{s.setValue(r),a&&setTimeout((()=>n(e)),this.getFrameDelay(r)),r=(r+1)%e};this.play=()=>{this.__resourcePromise.then((()=>{a=!0;const e=s.getRange()[1];n(e)}))},this.stop=()=>{a=!1}}getFrameDelay(e){return 10*this.__unpackedData.frameDelays[e]}load(e,t="RGB"){const i=js.__imageDataLibrary();return e in i?(this.__resourcePromise=i[e],this.__resourcePromise):(this.__resourcePromise=new Promise(((t,i)=>{ms.incrementWorkload(1),Ni(e,(i=>{console.warn("Unpacking Gif client side:"+e);const s=performance.now(),a=new ga(i).decompressFrames(!0),r=Math.sqrt(a.length),n=[r,r];jt.fract(r)>0&&(n[0]=Math.floor(n[0]+1),jt.fract(r)>.5?n[1]=Math.floor(n[1]+1):n[1]=Math.floor(n[1]));const o=a[0].dims.width,l=a[0].dims.height,h=document.createElement("canvas"),d=h.getContext("2d"),c=document.createElement("canvas"),u=c.getContext("2d");c.width=o,c.height=l;const m=document.createElement("canvas"),g=m.getContext("2d");let _;m.width=n[0]*o,m.height=n[1]*l;const f=[],p=(e,t)=>{const i=e.dims;f.push(e.delay/10),_&&i.width==_.width&&i.height==_.height||(h.width=i.width,h.height=i.height,_=d.createImageData(i.width,i.height)),_.data.set(e.patch),d.putImageData(_,0,0),2==e.disposalType&&u.clearRect(0,0,c.width,c.height),u.drawImage(h,i.left,i.top),g.drawImage(c,t%n[0]*o,Math.floor(t/n[0])*l)};for(let e=0;e<a.length;e++)p(a[e],e);ms.incrementWorkDone(1);const b=g.getImageData(0,0,m.width,m.height),y=performance.now()-s;console.log(`Decode GIF '${e}' time:`+y),t({width:m.width,height:m.height,atlasSize:n,frameRange:[0,a.length],frameDelays:f,imageData:b})}),(t=>{const s="Unable to Load URL:"+t+":"+e;console.warn(s),i(s)}))})),i[e]=this.__resourcePromise,this.__resourcePromise.then((e=>{this.width=e.width,this.height=e.height,this.getParameter("StreamAtlasDesc").setValue(new ci(e.atlasSize[0],e.atlasSize[1],0,0)),this.getParameter("StreamAtlasIndex").setRange(e.frameRange),this.__unpackedData=e,this.__data=e.imageData,this.__loaded=!0,this.emit("loaded",{})})),this.__resourcePromise)}}oi.register("GIFImage",_a);class fa extends ps{constructor(e,t={}){let i;null!=e&&e.includes(".")&&(i=e,e=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."))),super(e,t),this.__loaded=!1,this.__exposure=1,this.__ambientLightFactor=0,this.__hdrTint=new mi(1,1,1,1),this.__stream="stream"in t&&t.stream,this.type="FLOAT";const s=this.addParameter(new fs("FilePath"));s.on("valueChanged",(()=>{if(this.loaded=!1,""==this.getName()){const e=s.getStem(),t=e.substring(e.length-1);isNaN(t)?this.setName(e):this.setName(e.substring(0,e.length-1))}const e=s.getValue(),t=s.getFile();this.__loadVLH(e,t)})),i&&this.getParameter("FilePath").setFilepath(i)}getDOMElement(){return this.__domElement}getResourcePath(){return this.getParameter("FilePath").getValue()}__decodeData(e){const t=e.ldr,i=e.cdm,s=new Blob([t.buffer]),a=new Image;a.onload=()=>{this.width=a.width,this.height=a.height,this.__data={ldr:a,cdm:i},this.__loaded?this.emit("updated",{}):(this.__loaded=!0,this.emit("loaded",{}))},a.src=URL.createObjectURL(s)}__loadVLH(e,t){this.type="FLOAT",ms.loadFile("archive",t.url).then((e=>{if(!e.ldr||!e.cdm)for(const t in e)t.endsWith(".jpg")?(e.ldr=e[t],delete e[t]):t.endsWith(".bin")&&(e.cdm=e[t],delete e[t]);this.__decodeData(e)}))}isStream(){return!1}isLoaded(){return this.__loaded}getParams(){const e=super.getParams();return this.__loaded&&(e.data=this.__data,e.exposure=this.__exposure),e}setHDRTint(e){this.__hdrTint=e}getHDRTint(){return this.__hdrTint}toJSON(e){}fromJSON(e,t){}readBinary(e,t){this.setName(e.loadStr());const i=e.loadStr();if("string"==typeof i&&""!=i){if(t.lod>=0){const e=i.lastIndexOf(".");if(-1!=e){const s=i.substring(0,e)+t.lod+i.substring(e);ms.resourceAvailable(s)&&(i=s)}}this.getParameter("FilePath").setValue(i)}}}oi.register("VLHImage",fa);class pa extends fa{constructor(e,t={}){super(e,t),this.addParameter(new Ai("HeadLightMode",!1)),this.utf8decoder=new TextDecoder,this.shCoeffs=[]}__decodeData(e){super.__decodeData(e);const t=e.samples;if(t&&(this.luminanceData=JSON.parse(this.utf8decoder.decode(t)),this.luminanceData.shCoeffs))for(let e=0;e<9;e++)this.shCoeffs[e]=new mi(this.luminanceData.shCoeffs[3*e+0],this.luminanceData.shCoeffs[3*e+1],this.luminanceData.shCoeffs[3*e+2])}dirToLuminance(e){const t=e.x,i=e.y,s=e.z,a=this.shCoeffs[0].scale(.886227);return a.addInPlace(this.shCoeffs[1].scale(1.023328*i)),a.addInPlace(this.shCoeffs[2].scale(1.023328*s)),a.addInPlace(this.shCoeffs[3].scale(1.023328*t)),a.addInPlace(this.shCoeffs[4].scale(.858086*t*i)),a.addInPlace(this.shCoeffs[5].scale(.858086*i*s)),a.addInPlace(this.shCoeffs[6].scale(.743125*s*s-.247708)),a.addInPlace(this.shCoeffs[7].scale(.858086*t*s)),a.addInPlace(this.shCoeffs[8].scale(.429043*(t*t-i*i))),a.luminance()}}oi.register("EnvMap",pa);const ba=new class extends Jt{constructor(){super(),this.__labelLibraries={},this.__language=function(){if(!window.navigator)return"en";const e=new URLSearchParams(window.location.search);if(e.has("lang"))return e.get("lang");const t=window.navigator,i=["language","browserLanguage","systemLanguage","userLanguage"];let s,a;const r=e=>e.startsWith("en")?"En":e.startsWith("es")?"Es":e.startsWith("fr")?"Fr":e.startsWith("gb")||e.startsWith("de")?"Gb":e;if(Array.isArray(t.languages))for(s=0;s<t.languages.length;s++)if(a=t.languages[s],a&&a.length)return r(a);for(s=0;s<i.length;s++)if(a=t[i[s]],a&&a.length)return r(a);return null}(),this.__foundLabelLibraries={}}loadLibrary(e,t){const i=e.substring(0,e.lastIndexOf("."));this.__foundLabelLibraries[i]=t,e.endsWith(".labels")?Fi(t,(e=>{this.__labelLibraries[i]=JSON.parse(e),this.emit("labelLibraryLoaded",{library:i})})):e.endsWith(".xlsx")&&window.navigator&&window.XLSX&&Ni(t,(e=>{const t=new Uint8Array(e),s=XLSX.read(t,{type:"array"}),a={};s.SheetNames.forEach((function(e){XLSX.utils.sheet_to_row_object_array(s.Sheets[e]).forEach((function(e){const t=e.Identifier;delete e.Identifier,a[t]=e}))})),this.__labelLibraries[i]=a,this.emit("labelLibraryLoaded",{library:i})}))}isLibraryFound(e){return e in this.__foundLabelLibraries}isLibraryLoaded(e){return e in this.__labelLibraries}getLabelText(e,t){const i=this.__labelLibraries[e];if(!i)throw new Error("LabelLibrary: '"+e+"' not found in LabelManager. Found: ["+Object.keys(this.__labelLibraries)+"]");const s=i[t];if(!s)throw new Error("Label: '"+t+"' not found in LabelLibrary: '"+e+"'. Found: ["+Object.keys(i)+"]");const a=s[this.__language];if(!a){if(s.En)return s.En;throw new Error("labelText: '"+language+"' not found in Label. Found: ["+Object.keys(s)+"]")}return a}setLabelText(e,t,i){let s=this.__labelLibraries[e];s||(s={},this.__labelLibraries[e]=s);let a=s[t];a||(a={},s[t]=a),a[this.__language]=i}setLanguage(e){this.__language=e}};class ya extends Js{constructor(e,t){super(e),this.__canvasElem=document.createElement("canvas");const i=this.addParameter(new qi("Library"));this.addParameter(new qi("Text","")),this.addParameter(new Hi("FontColor",new mi(0,0,0))),this.addParameter(new Bi("Margin",11)),this.addParameter(new Bi("BorderWidth",2)),this.addParameter(new Bi("BorderRadius",11)),this.addParameter(new Ai("Outline",!1)),this.addParameter(new Ai("OutlineColor",new mi(0,0,0))),this.addParameter(new Ai("Background",!0)),this.addParameter(new Hi("BackgroundColor",new mi("#FBC02D"))),this.addParameter(new Ai("FillBackground",!0)),this.addParameter(new Ai("StrokeBackgroundOutline",!0)),this.addParameter(new Bi("FontSize",22)),this.addParameter(new qi("Font","Helvetica"));this.on("nameChanged",(()=>{this.loadLabelData()})),t&&i.setValue(t),this.__requestedReRender=!1,this.__needsRender=!1,this.loadLabelData()}__parameterValueChanged(e){super.__parameterValueChanged(e),this.__requestedReRender||(this.__requestedReRender=!0,this.loadLabelData())}loadLabelData(){Promise.all([(()=>new Promise((e=>{const t=this.getParameter("Library").getValue();if(""==t)return void e();if(!ba.isLibraryFound(t))return console.warn("Label Library not found:",t),void e();const i=()=>{try{const e=this.getName(),i=ba.getLabelText(t,e);this.getParameter("Text").setValue(i)}catch(e){console.warn(e)}e()};ba.isLibraryLoaded(t)?i():ba.on("labelLibraryLoaded",(e=>{e.library==t&&i()}))})))(),(()=>new Promise((e=>{if(null!=document.fonts){const t=this.getParameter("Font").getValue(),i=this.getParameter("FontSize").getValue();document.fonts.load(i+'px "'+t+'"').then((()=>{e()}))}else e()})))()]).then((()=>{this.__requestedReRender=!1,this.__needsRender=!0,this.__loaded?this.emit("updated",{}):(this.__loaded=!0,this.emit("loaded",{}))}))}renderLabelToImage(){const e=this.__canvasElem.getContext("2d",{alpha:!0});let t=this.getParameter("Text").getValue();""==t&&(t=this.getName());const i=this.getParameter("Font").getValue(),s=this.getParameter("FontColor").getValue(),a=this.getParameter("FontSize").getValue(),r=this.getParameter("Margin").getValue(),n=this.getParameter("BorderWidth").getValue(),o=this.getParameter("BorderRadius").getValue(),l=this.getParameter("Outline").getValue(),h=this.getParameter("OutlineColor").getValue(),d=this.getParameter("Background").getValue(),c=this.getParameter("BackgroundColor").getValue(),u=this.getParameter("FillBackground").getValue(),m=this.getParameter("StrokeBackgroundOutline").getValue(),g=r+n,_=t.split("\n");e.font=a+'px "'+i+'"';let f=0;_.forEach((t=>{f=Math.max(e.measureText(t).width,f)}));const p=a;this.width=Math.ceil(f+2*g),this.height=Math.ceil(p*_.length+2*g),e.canvas.width=this.width,e.canvas.height=this.height,this.__canvasElem.width=this.width,this.__canvasElem.height=this.height,e.fillStyle="rgba(0, 0, 0, 0.0)",e.fillRect(0,0,this.width,this.height),d&&(e.fillStyle=c.toHex(),e.strokeStyle=h.toHex(),function(e,t,i,s,a,r,n,o,l){if(void 0===o&&(o=!0),void 0===r&&(r=5),"number"==typeof r)r={tl:r,tr:r,br:r,bl:r};else{const e={tl:0,tr:0,br:0,bl:0};for(const t in e)r[t]=r[t]||e[t]}e.beginPath(),e.moveTo(t+r.tl,i),e.lineTo(t+s-r.tr,i),e.quadraticCurveTo(t+s,i,t+s,i+r.tr),e.lineTo(t+s,i+a-r.br),e.quadraticCurveTo(t+s,i+a,t+s-r.br,i+a),e.lineTo(t+r.bl,i+a),e.quadraticCurveTo(t,i+a,t,i+a-r.bl),e.lineTo(t,i+r.tl),e.quadraticCurveTo(t,i,t+r.tl,i),e.closePath(),n&&e.fill(),o&&(e.lineWidth=l,e.stroke())}(e,n,n,this.width-2*n,this.height-2*n,o,u,m,n)),e.font=a+'px "'+i+'"',e.textAlign="left",e.fillStyle=s.toHex(),e.textBaseline="hanging",_.forEach(((t,i)=>{e.fillText(t,g,g+i*p)})),l&&(e.strokeStyle=h.toHex(),e.lineWidth=1.5,e.strokeText(t,g,g)),this.__data=e.getImageData(0,0,this.width,this.height),this.__needsRender=!1,this.emit("labelRendered",{width:this.width,height:this.height,data:this.__data})}getParams(){return this.__needsRender&&this.renderLabelToImage(),super.getParams()}toJSON(e){return super.toJSON(e)}fromJSON(e,t){super.fromJSON(e,t),this.__getLabelText()}}oi.register("Label",ya);class Ga extends ps{constructor(){super(),this.__loaded=!1}connectWebcam(e,t,i=!1){const s={width:e,height:t,frameRate:{ideal:60,max:60}};s.facingMode=i?{exact:"environment"}:{facingMode:"user"};const a=document.createElement("video");a.style.display="none",a.preload="auto",a.crossOrigin="anonymous",document.body.appendChild(a),navigator.mediaDevices.getUserMedia({audio:!1,video:s}).then((e=>{a.srcObject=e,a.onloadedmetadata=e=>{a.play(),this.width=a.videoWidth,this.height=a.videoHeight,console.log("Webcam:["+this.width+", "+this.height+"]"),this.__data=a,this.__loaded=!0,this.emit("loaded",{});let t=0;const i=()=>{if(a.paused||a.ended)return;const e=Math.floor(60*a.currentTime);t!=e&&(this.emit("updated",{}),t=e),setTimeout(i,20)};i()}})).catch((function(e){}))}setVideoStream(e){this.__loaded=!1,this.width=e.videoWidth,this.height=e.videoHeight,this.start(),this.__data=e,this.__loaded=!0,this.emit("loaded",{})}stop(){clearInterval(this.__intervalId)}start(){this.__intervalId=setInterval((()=>{this.emit("updated",{})}),20)}isLoaded(){return this.__loaded}getParams(){return{type:this.type,format:this.format,width:this.width,height:this.height,data:this.__data,flipY:this.getParameter("FlipY").getValue()}}}oi.register("VideoStreamImage2D",Ga);class Xa extends us{constructor(e){super(e)}setSrcTree(e,t){this.__srcTree=e;if(0==this.__srcTree.getNumChildren()){const e=this.__srcTree.clone(t);e.getParameter("LocalXfo").loadValue(new yi),this.addChild(e,!1)}else{this.__srcTree.getChildren().forEach((e=>{const i=e.clone(t);this.addChild(i,!1)}))}}getSrcTree(){return this.__srcTree}readBinary(e,t={}){super.readBinary(e,t);const i=e.loadStrArray();try{t.resolvePath(i,(e=>{this.setSrcTree(e,t)}))}catch(e){console.warn(`Error loading InstanceItem: ${this.getPath()}: `+e.message)}}toJSON(e={}){return super.toJSON(e)}fromJSON(e,t={},i){}}oi.register("InstanceItem",Xa);class xa extends us{constructor(e){super(e),this.overlay=!1,this.__cutAway=!1,this.__cutAwayVector=new di(1,0,0),this.__cutAwayDist=0,this.__layers=[]}setOverlay(e){this.overlay=e}isOverlay(){return this.overlay}addLayer(e){this.__layers.push(e)}getLayers(){return this.__layers}isCutawayEnabled(){return this.__cutAway}setCutawayEnabled(e){this.__cutAway=e,this.emit("cutAwayChanged",{})}getCutVector(){return this.__cutAwayVector}setCutVector(e){this.__cutAwayVector=e,this.emit("cutAwayChanged",{})}getCutDist(){return this.__cutAwayDist}setCutDist(e){this.__cutAwayDist=e,this.emit("cutAwayChanged",{})}readBinary(e,t){if(super.readBinary(e,t),t.versions["zea-engine"].compare([0,0,4])>=0){const i=e.loadStr();let s=t.assetItem.getMaterialLibrary().getMaterial(i,!1);if(s||(s=new Xs(i,"SimpleSurfaceShader"),s.getParameter("BaseColor").loadValue(mi.random(.25)),t.assetItem.getMaterialLibrary().addMaterial(s)),this.getParameter("Material").loadValue(s),this.__layers=e.loadStrArray(),this.__layers.length>0)for(const e of this.__layers)t.addGeomToLayer(this,e)}}}let Ia=!1;class Va extends os{constructor(e,t,i){super("CalcGeomMatOperator"),this.addInput(new rs("GlobalXfo")).setParam(e),this.addInput(new rs("GeomOffsetXfo")).setParam(t),this.addOutput(new ns("GeomMat")).setParam(i)}evaluate(){const e=this.getInput("GlobalXfo").getValue(),t=this.getInput("GeomOffsetXfo").getValue(),i=this.getOutput("GeomMat"),s=e.toMat4(),a=t.toMat4();i.setClean(s.multiply(a))}}class va extends xa{constructor(e,t,i,s){super(e),this.__geomParam=this.addParameter(new as("Geometry")),this._setBoundingBoxDirty=this._setBoundingBoxDirty.bind(this),this.__geomParam.on("valueChanged",this._setBoundingBoxDirty),this.__geomParam.on("boundingBoxChanged",this._setBoundingBoxDirty),this.__materialParam=this.addParameter(new xs("Material")),this.addParameterDeprecationMapping("material","Material"),this.__geomOffsetXfoParam=this.addParameter(new Qi("GeomOffsetXfo")),this.__geomMatParam=this.addParameter(new Ji("GeomMat")),this.geomIndex=-1,this.assetItem=null,this.calcGeomMatOperator=new Va(this.__globalXfoParam,this.__geomOffsetXfoParam,this.__geomMatParam),t&&this.getParameter("Geometry").loadValue(t),i&&this.getParameter("Material").loadValue(i),s&&this.getParameter("LocalXfo").setValue(s)}getGeometry(){return console.warn("deprecated. please use 'getParameter('Geometry').getValue"),this.__geomParam.getValue()}setGeometry(e){console.warn("deprecated. please use 'getParameter('Geometry').setValue"),this.__geomParam.setValue(e)}getGeom(){return console.warn("deprecated. please use 'getParameter('Geometry').getValue"),this.__geomParam.getValue()}setGeom(e){return console.warn("setGeom is deprecated. Please use 'getParameter('Geometry').setValue'"),this.__geomParam.setValue(e)}getMaterial(){return console.warn("deprecated. please use 'getParameter('Material').getValue"),this.__materialParam.getValue()}setMaterial(e){console.warn("deprecated. please use 'getParameter('Material').setValue"),this.__materialParam.setValue(e)}_cleanBoundingBox(e){e=super._cleanBoundingBox(e);const t=this.__geomParam.getValue();if(t)if(t instanceof Ts&&Ia){const i=t.__buffers.attrBuffers.positions.values,s=e=>{const t=3*e;return new di(i.subarray(t,t+3))},a=this.getGeomMat4();for(let i=0;i<t.getNumVertices();i++)e.addPoint(a.transformVec3(s(i)))}else e.addBox3(t.getBoundingBox(),this.getGeomMat4());else this.geomBBox&&e.addBox3(this.geomBBox,this.getGeomMat4());return e}getGeomOffsetXfo(){return this.__geomOffsetXfoParam.getValue()}setGeomOffsetXfo(e){this.__geomOffsetXfoParam.setValue(e)}getGeomMat4(){return this.__geomMatParam.getValue()}toJSON(e){return super.toJSON(e)}fromJSON(e,t){super.fromJSON(e,t),t.numGeomItems++}readBinary(e,t){super.readBinary(e,t),t.numGeomItems++;const i=e.loadUInt8(),s=e.loadUInt32(),a=t.assetItem.getGeometryLibrary();this.geomIndex=s,this.assetItem=t.assetItem;const r=a.getGeom(s);if(r)this.getParameter("Geometry").loadValue(r);else{const e=t=>{const{range:i}=t;if(s>=i[0]&&s<i[1]){const t=a.getGeom(s);t?this.getParameter("Geometry").setValue(t):console.warn("Geom not loaded:",this.getName()),a.off("rangeLoaded",e)}};a.on("rangeLoaded",e)}if(4&i&&this.__geomOffsetXfoParam.setValue(new yi(e.loadFloat32Vec3(),e.loadFloat32Quat(),e.loadFloat32Vec3())),t.versions["zea-engine"].compare([0,0,4])<0){if(i&8){const i=t.assetItem.getMaterialLibrary(),s=e.loadStr();let a=i.getMaterial(s);a||(console.warn("Geom :'"+this.name+"' Material not found:"+s),a=i.getMaterial("Default")),this.getParameter("Material").loadValue(a)}else this.getParameter("Material").loadValue(t.assetItem.getMaterialLibrary().getMaterial("Default"))}t.versions["zea-engine"].compare([3,0,0])<0?e.loadFloat32Vec2():this.geomBBox=new xi(e.loadFloat32Vec3(),e.loadFloat32Vec3())}toString(){return JSON.stringify(this.toJSON(),null,2)}clone(e){const t=new va;return t.copyFrom(this,e),t}copyFrom(e,t){if(super.copyFrom(e,t),!e.getParameter("Geometry").getValue()&&-1!=e.geomIndex){const t=e.assetItem.getGeometryLibrary();this.assetItem=e.assetItem,this.geomIndex=e.geomIndex;const i=e=>{const{range:s}=e;if(this.geomIndex>=s[0]&&this.geomIndex<s[1]){const e=t.getGeom(this.geomIndex);e?this.getParameter("Geometry").setValue(e):console.warn("Geom not loaded:",this.getName()),t.off("rangeLoaded",i)}};t.on("rangeLoaded",i)}this.__geomMatParam.setDirty(this.__cleanGeomMat)}static setCalculatePreciseBoundingBoxes(e){Ia=e}}oi.register("GeomItem",va);class Ra extends us{constructor(e){super(e),this.searchRoot=null,this.__itemsParam=this.addParameter(new ss("Items",(e=>e instanceof us))),this.__itemsParam.on("itemAdded",(e=>{this.__bindItem(e.item,e.index)})),this.__itemsParam.on("itemRemoved",(e=>{this.__unbindItem(e.item,e.index)}))}setSearchRoot(e){this.searchRoot=e}setOwner(e){this.searchRoot&&this.searchRoot!=this.getOwner()||(this.searchRoot=e),super.setOwner(e)}setPaths(e){if(this.clearItems(!1),this.getOwner(),null==this.searchRoot)return void console.warn("BaseGroup does not have an owner and so cannot resolve paths:",this.getName());const t=[];e.forEach((e=>{const i=this.searchRoot.resolvePath(e);i?t.push(i):console.warn("Path does not resolve to an Item:",e," group:",this.getName())})),this.setItems(t)}resolveItems(e){this.setPaths(e)}__bindItem(e,t){e instanceof us&&(e.on("pointerDown",this.onPointerDown),e.on("pointerUp",this.onPointerUp),e.on("pointerMove",this.onPointerMove),e.on("pointerEnter",this.onPointerEnter),e.on("pointerLeave",this.onPointerLeave))}__unbindItem(e,t){e instanceof us&&(e.off("pointerDown",this.onPointerDown),e.off("pointerUp",this.onPointerUp),e.off("pointerMove",this.onPointerMove),e.off("pointerEnter",this.onPointerEnter),e.off("pointerLeave",this.onPointerLeave))}addItem(e,t=!0){e?this.__itemsParam.addItem(e,t):console.warn("Error adding item to group. Item is null")}removeItem(e,t=!0){this.__itemsParam.removeItem(e,t)}clearItems(e=!0){const t=Array.from(this.__itemsParam.getValue());for(let e=t.length-1;e>=0;e--)this.__unbindItem(t[e],e);this.__itemsParam.clearItems(e)}getItems(){return this.__itemsParam.getValue()}setItems(e){this.clearItems(!1),this.__itemsParam.setItems(e)}onPointerDown(e){super.onPointerDown(e)}onPointerUp(e){super.onPointerUp(e)}onPointerMove(e){super.onPointerMove(e)}toJSON(e){const t=super.toJSON(e),i=Array.from(this.__itemsParam.getValue()),s=[];return i.forEach((t=>{const i=t.getPath();s.push(e?e.makeRelative(i):i)})),t.treeItems=s,t}fromJSON(e,t){if(super.fromJSON(e,t),!e.treeItems)return void console.warn("Invalid Parameter JSON");if(!t)throw new Error("Unable to load JSON on a BaseGroup without a load context");let i=e.treeItems.length;const s=e=>{t.resolvePath(e,(e=>{this.addItem(e),i--,0==i&&this.__loadDone()}),(t=>{console.warn("BaseGroup: '"+this.getName()+"'. Unable to load item:"+e)}))};for(const t of e.treeItems)s(t)}__loadDone(){}copyFrom(e,t){super.copyFrom(e,t)}}class wa extends Ra{constructor(e){super(e),this.__highlightedParam=this.addParameter(new Ai("Highlighted",!1)),this.__highlightedParam.on("valueChanged",(()=>{this.__updateHighlight()})),this.__updateHighlight=this.__updateHighlight.bind(this);this.addParameter(new Hi("HighlightColor",new mi(.5,.5,1))).on("valueChanged",this.__updateHighlight);this.addParameter(new Bi("HighlightFill",0,[0,1])).on("valueChanged",this.__updateHighlight)}__updateVisibility(){if(super.__updateVisibility()){const e=this.isVisible();return Array.from(this.__itemsParam.getValue()).forEach((t=>{t instanceof us&&t.propagateVisibility(e?1:-1)})),!0}return!1}__updateHighlight(){new Promise((e=>{let t,i=!1;(this.getParameter("Highlighted").getValue()||this.isSelected())&&(i=!0,t=this.getParameter("HighlightColor").getValue(),t.a=this.getParameter("HighlightFill").getValue());const s="groupItemHighlight"+this.getId();Array.from(this.__itemsParam.getValue()).forEach((e=>{e instanceof us&&(i?e.addHighlight(s,t,!0):e.removeHighlight(s,!0))})),e()}))}setSelected(e){super.setSelected(e),this.__updateHighlight()}__bindItem(e,t){if(super.__bindItem(e,t),e instanceof us){if(e instanceof us&&this.getParameter("Highlighted").getValue()){const t=this.getParameter("HighlightColor").getValue();t.a=this.getParameter("HighlightFill").getValue(),e.addHighlight("groupItemHighlight"+this.getId(),t,!0)}this.isVisible()||e.propagateVisibility(-1),e instanceof us&&e.getParameter("BoundingBox").on("valueChanged",this._setBoundingBoxDirty)}}__unbindItem(e,t){super.__unbindItem(e,t),e instanceof us&&(this.getParameter("Highlighted").getValue()&&e.removeHighlight("groupItemHighlight"+this.getId(),!0),this.isVisible()||e.propagateVisibility(1),e.traverse((e=>{e instanceof xa&&e.setCutawayEnabled(!1)}),!0),e instanceof us&&e.getParameter("BoundingBox").off("valueChanged",this._setBoundingBoxDirty))}clone(e){const t=new wa;return t.copyFrom(this,e),t}}oi.register("SelectionSet",wa);var Ma=null;try{var Ta="undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads");Ma=Ta.Worker}catch(e){}function La(e,t,i){var s=void 0===t?null:t,a=function(e,t){return Buffer.from(e,"base64").toString(t?"utf16":"utf8")}(e,void 0!==i&&i),r=a.indexOf("\n",10)+1,n=a.substring(r)+(s?"//# sourceMappingURL="+s:"");return function(e){return new Ma(n,Object.assign({},e,{eval:!0}))}}function Sa(e,t,i){var s=void 0===t?null:t,a=function(e,t){var i=atob(e);if(t){for(var s=new Uint8Array(i.length),a=0,r=i.length;a<r;++a)s[a]=i.charCodeAt(a);return String.fromCharCode.apply(null,new Uint16Array(s.buffer))}return i}(e,void 0!==i&&i),r=a.indexOf("\n",10)+1,n=a.substring(r)+(s?"//# sourceMappingURL="+s:""),o=new Blob([n],{type:"application/javascript"});return URL.createObjectURL(o)}var Za="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);function Ca(e,t,i){return Za?La(e,t,i):function(e,t,i){var s;return function(a){return s=s||Sa(e,t,i),new Worker(s,a)}}(e,t,i)}var Fa=Ca("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwohZnVuY3Rpb24oKXsidXNlIHN0cmljdCI7Y2xhc3MgdHtzdGF0aWMgcmVwbGFjZUFsbCh0LGUscyl7cmV0dXJuIHQucmVwbGFjZShuZXcgUmVnRXhwKGUsImciKSxzKX1zdGF0aWMgc3RyaW5naWZ5SlNPTldpdGhGaXhlZFByZWNpc2lvbih0LGU9MCxzPTUpe3JldHVybiBKU09OLnN0cmluZ2lmeSh0LCgodCxlKT0+ZSYmZS50b0ZpeGVkP051bWJlcihlLnRvRml4ZWQocykpOmUpLGUpfXN0YXRpYyBoYXNoU3RyKHQpe2xldCBlLHMsYSxpPTA7aWYoMD09PXQubGVuZ3RoKXJldHVybiBpO2ZvcihlPTAsYT10Lmxlbmd0aDtlPGE7ZSsrKXM9dC5jaGFyQ29kZUF0KGUpLGk9KGk8PDUpLWkrcyxpfD0wO3JldHVybiBNYXRoLmFicyhpKX19Y2xhc3MgZXtpc1ZhbGlkKCl7Zm9yKGNvbnN0IHQgb2YgdGhpcy5fX2RhdGEpaWYodD09MS8wfHxpc05hTih0KSlyZXR1cm4hMTtyZXR1cm4hMH1zdGF0aWMgY3JlYXRlRnJvbUZsb2F0MzJCdWZmZXIodCxlKXt0aHJvdyBuZXcgRXJyb3IoIk5vdCB5ZXQgaW1wbGVtZW50ZWQgZm9yIHRoaXMgdHlwZToiK3RoaXMuY29uc3RydWN0b3IubmFtZSl9c3RhdGljIGNyZWF0ZUZyb21CdWZmZXIodCxlKXt0aHJvdyBuZXcgRXJyb3IoIk5vdCB5ZXQgaW1wbGVtZW50ZWQgZm9yIHRoaXMgdHlwZToiK3RoaXMuY29uc3RydWN0b3IubmFtZSl9c3RhdGljIG51bUVsZW1lbnRzKCl7dGhyb3cgbmV3IEVycm9yKCJOb3QgeWV0IGltcGxlbWVudGVkIGZvciB0aGlzIHR5cGU6Iit0aGlzLmNvbnN0cnVjdG9yLm5hbWUpfWFzQXJyYXkoKXtyZXR1cm4gdGhpcy5fX2RhdGF9dG9TdHJpbmcoKXtyZXR1cm4gdC5zdHJpbmdpZnlKU09OV2l0aEZpeGVkUHJlY2lzaW9uKHRoaXMudG9KU09OKCkpfXRvSlNPTigpe3Rocm93IG5ldyBFcnJvcigiTm90IHlldCBpbXBsZW1lbnRlZCBmb3IgdGhpcyB0eXBlOiIrdGhpcy5jb25zdHJ1Y3Rvci5uYW1lKX19Y2xhc3Mgc3tzdGF0aWMgcmFkVG9EZWcodCl7cmV0dXJuIHQvKE1hdGguUEkvMTgwKX1zdGF0aWMgZGVnVG9SYWQodCl7cmV0dXJuIHQqKE1hdGguUEkvMTgwKX1zdGF0aWMgaXNOdW1lcmljKHQpe3JldHVybiFpc05hTihwYXJzZUZsb2F0KHQpKSYmaXNGaW5pdGUodCl9c3RhdGljIHJhbmRvbUludCh0LGUpe3JldHVybiB0PU1hdGguY2VpbCh0KSxlPU1hdGguZmxvb3IoZSksTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpKihlLXQpKSt0fXN0YXRpYyBsZXJwKHQsZSxzKXtyZXR1cm4gdCtzKihlLXQpfXN0YXRpYyBjbGFtcCh0LGUscyl7cmV0dXJuIE1hdGgubWluKE1hdGgubWF4KHQsZSkscyl9c3RhdGljIG5lYXJlc3RQb3cyKHQpe3JldHVybiBNYXRoLnBvdygyLE1hdGgucm91bmQoTWF0aC5sb2codCkvTWF0aC5sb2coMikpKX1zdGF0aWMgbmVhcmVzdFBvdzEwKHQpe3JldHVybiBNYXRoLnBvdygxMCxNYXRoLnJvdW5kKE1hdGgubG9nMTAodCkvTWF0aC5sb2cxMCgxMCkpKX1zdGF0aWMgbmV4dFBvdzIodCl7aWYoMD09dGhpcy5mcmFjdChNYXRoLmxvZzIodCkpKXJldHVybiB0O2xldCBlPTA7Zm9yKDt0PjA7KWUrKyx0Pj49MTtyZXR1cm4gMTw8ZX1zdGF0aWMgZnJhY3QodCl7cmV0dXJuIDA9PXQ/MDp0PDA/dD4tMT8tdDotdCVNYXRoLmZsb29yKC10KTp0PDE/dDp0JU1hdGguZmxvb3IodCl9c3RhdGljIHJlbWFwKHQsZSxzLGEsaSl7cmV0dXJuIGErKHQtZSkvKHMtZSkqKGktYSl9c3RhdGljIHNtb290aFN0ZXAodCxlLHMpe2NvbnN0IGE9dGhpcy5jbGFtcCgocy10KS8oZS10KSwwLDEpO3JldHVybiBhKmEqKDMtMiphKX1zdGF0aWMgbGluU3RlcCh0LGUscyl7cmV0dXJuIHRoaXMuY2xhbXAoKHMtdCkvKGUtdCksMCwxKX1zdGF0aWMgZGVjb2RlMTZCaXRGbG9hdEZyb20yeFVJbnQ4KHQpe2NvbnN0IGU9dFswXSxzPSgxMjAmZSk+PjM7bGV0IGE9MD09cz8wOjIwNDg7Y29uc3QgaT1hKygoNyZlKTw8OCkrdFsxXTthPTA9PXM/MTowO3JldHVybigxMjgmZT8xOi0xKSppKk1hdGgucG93KDIscythLTE2KX1zdGF0aWMgZW5jb2RlMTZCaXRGbG9hdEludG8yeFVJbnQ4KHQpe2NvbnN0IGU9bmV3IFVpbnQ4QXJyYXkoMikscz10Pj0wPzEyODowO3Q9TWF0aC5hYnModCk7bGV0IGEsaT0xNSxyPTEwMjQ7Zm9yKGxldCBlPTE1O2U+MDtlLS0pdDxyJiYoci89MixpLS0pO2E9MD09aT90L3IvMjoodC1yKS9yO2NvbnN0IG49TWF0aC5yb3VuZCgyMDQ4KmEpLGg9bi8yNTYsbz1uLTI1NipoO3JldHVybiBlWzBdPXMrOCppK2gsZVsxXT1vLHQ+PTIwNDgmJihlWzBdPTI1NSksZX1zdGF0aWMgZW5jb2RlMTZCaXRGbG9hdCh0KXtjb25zdCBlPW5ldyBGbG9hdDMyQXJyYXkoMSk7ZVswXT10O3JldHVybih0PT57bGV0IGU9dD4+MTYmMzI3Njgscz10Pj4xMiYyMDQ3O2NvbnN0IGE9dD4+MjMmMjU1O3JldHVybiBhPDEwMz9lOmE+MTQyPyhlfD0zMTc0NCxlfD0oMjU1PT1hPzA6MSkmJjgzODg2MDcmdCxlKTphPDExMz8oc3w9MjA0OCxlfD0ocz4+MTE0LWEpKyhzPj4xMTMtYSYxKSxlKTooZXw9YS0xMTI8PDEwfHM+PjEsZSs9MSZzLGUpfSkobmV3IEludDMyQXJyYXkoZS5idWZmZXIpWzBdKX1zdGF0aWMgZGVjb2RlMTZCaXRGbG9hdCh0KXtjb25zdCBlPSgzMjc2OCZ0KT4+MTUscz0oMzE3NDQmdCk+PjEwLGE9MTAyMyZ0O3JldHVybiAwPT1zPyhlPy0xOjEpKk1hdGgucG93KDIsLTE0KSooYS9NYXRoLnBvdygyLDEwKSk6MzE9PXM/YT9OYU46MS8wKihlPy0xOjEpOihlPy0xOjEpKk1hdGgucG93KDIscy0xNSkqKDErYS9NYXRoLnBvdygyLDEwKSl9c3RhdGljIGNvbnZlcnRGbG9hdDMyQXJyYXlUb1VJbnQxNkFycmF5KHQpe2NvbnN0IGU9bmV3IFVpbnQxNkFycmF5KHQubGVuZ3RoKSxzPW5ldyBJbnQzMkFycmF5KHQuYnVmZmVyKSxhPXQ9PntsZXQgZT10Pj4xNiYzMjc2OCxzPXQ+PjEyJjIwNDc7Y29uc3QgYT10Pj4yMyYyNTU7cmV0dXJuIGE8MTAzP2U6YT4xNDI/KGV8PTMxNzQ0LGV8PSgyNTU9PWE/MDoxKSYmODM4ODYwNyZ0LGUpOmE8MTEzPyhzfD0yMDQ4LGV8PShzPj4xMTQtYSkrKHM+PjExMy1hJjEpLGUpOihlfD1hLTExMjw8MTB8cz4+MSxlKz0xJnMsZSl9O2ZvcihsZXQgaT0wO2k8dC5sZW5ndGg7aSsrKWVbaV09YShzW2ldKTtyZXR1cm4gZX19bGV0IGE9e30saT17fSxyPVtdO2NvbnN0IG49KHQsZSk9PntpZihhW3RdKXRocm93IG5ldyBFcnJvcihgVGhlcmUncyBhIGNsYXNzIHJlZ2lzdGVyZWQgd2l0aCAnJHt0fScgbmFtZWApO2FbdF09e2JsdWVwcmludDplLGNhbGxiYWNrczpbXX07Y29uc3Qgcz1yLmxlbmd0aDtyLnB1c2goZSksaVtzXT10fSxoPXQ9PntpZihhW3RdKXJldHVybiBhW3RdLmJsdWVwcmludDt0aHJvdyBuZXcgRXJyb3IoYCR7dH0gYmx1ZXByaW50IGlzIG5vdCByZWdpc3RlcmVkYCl9LG89dD0+e2xldCBlPXQscz10OyJvYmplY3QiPT10eXBlb2YgdCYmKGU9dC5jb25zdHJ1Y3RvcixzPWUubmFtZSk7Y29uc3QgYT1yLmluZGV4T2YoZSk7aWYoYT49MCYmaVthXSlyZXR1cm4gaVthXTt0aHJvdyBuZXcgRXJyb3IoYCR7c30gYmx1ZXByaW50IGlzIG5vdCByZWdpc3RlcmVkYCl9LF89KHQsLi4uZSk9Pntjb25zdCBzPWFbdF07aWYoIXMpdGhyb3cgbmV3IEVycm9yKGAke3R9IGJsdWVwcmludCBpcyBub3QgcmVnaXN0ZXJlZGApO3JldHVybiBuZXcgcy5ibHVlcHJpbnQoLi4uZSl9O24oIlVJbnQ4IiwwKSxuKCJTSW50OCIsMSksbigiVUludDE2IiwyKSxuKCJTSW50MTYiLDMpLG4oIlVJbnQzMiIsNCksbigiU0ludDMyIiw1KSxuKCJGbG9hdDMyIiw2KTtjbGFzcyBkIGV4dGVuZHMgZXtjb25zdHJ1Y3Rvcih0PTAsZT0wKXtpZihzdXBlcigpLHQgaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXl8fHQgaW5zdGFuY2VvZiBVaW50MzJBcnJheXx8dCBpbnN0YW5jZW9mIEludDMyQXJyYXkpdGhpcy5fX2RhdGE9dDtlbHNlIGlmKHQgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcil7Y29uc29sZS53YXJuKCJkZXByZWNhdGVkLCBwbGVhc2UgdXNlIG5ldyBWZWM0KG5ldyBGbG9hdDMyQXJyYXkoYnVmZmVyLCBieXRlT2Zmc2V0LCA0KSkiKTtjb25zdCBzPXQsYT1lO3RoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkocyxhLDIpfWVsc2UgbnVsbCE9dCYmIm9iamVjdCI9PXR5cGVvZiB0Pyh0aGlzLl9fZGF0YT1uZXcgRmxvYXQzMkFycmF5KDIpLHRoaXMuZnJvbUpTT04odCkpOih0aGlzLl9fZGF0YT1uZXcgRmxvYXQzMkFycmF5KDIpLHRoaXMuX19kYXRhWzBdPXQsdGhpcy5fX2RhdGFbMV09ZSl9Z2V0IHgoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMF19c2V0IHgodCl7dGhpcy5fX2RhdGFbMF09dH1nZXQgeSgpe3JldHVybiB0aGlzLl9fZGF0YVsxXX1zZXQgeSh0KXt0aGlzLl9fZGF0YVsxXT10fXNldCh0LGUpe3RoaXMuX19kYXRhWzBdPXQsdGhpcy5fX2RhdGFbMV09ZX1zZXRGcm9tT3RoZXIodCl7dGhpcy54PXQueCx0aGlzLnk9dC55fWVxdWFsKHQpe3JldHVybiBjb25zb2xlLndhcm4oIkRlcHJlY2F0ZWQuIFVzZSAjaXNFcXVhbCBpbnN0ZWFkLiIpLHRoaXMuaXNFcXVhbCh0KX1pc0VxdWFsKHQpe3JldHVybiB0aGlzLng9PXQueCYmdGhpcy55PT10Lnl9bm90RXF1YWxzKHQpe3JldHVybiBjb25zb2xlLndhcm4oIkRlcHJlY2F0ZWQuIFVzZSAjbm90RXF1YWwgaW5zdGVhZC4iKSx0aGlzLm5vdEVxdWFsKHQpfW5vdEVxdWFsKHQpe3JldHVybiB0aGlzLnghPXQueCYmdGhpcy55IT10Lnl9YXBwcm94RXF1YWwodCxlPU51bWJlci5FUFNJTE9OKXtyZXR1cm4gTWF0aC5hYnModGhpcy54LXQueCk8ZSYmTWF0aC5hYnModGhpcy55LXQueSk8ZX1hZGQodCl7cmV0dXJuIG5ldyBkKHRoaXMueCt0LngsdGhpcy55K3QueSl9YWRkSW5QbGFjZSh0KXt0aGlzLngrPXQueCx0aGlzLnkrPXQueX1zdWJ0cmFjdCh0KXtyZXR1cm4gbmV3IGQodGhpcy54LXQueCx0aGlzLnktdC55KX1zdWJ0cmFjdEluUGxhY2UodCl7cmV0dXJuIHRoaXMueC09dC54LHRoaXMueS09dC55LHRoaXN9c2NhbGUodCl7cmV0dXJuIG5ldyBkKHRoaXMueCp0LHRoaXMueSp0KX1zY2FsZUluUGxhY2UodCl7dGhpcy54Kj10LHRoaXMueSo9dH1pbnZlcnQoKXtyZXR1cm4gbmV3IGQoMS90aGlzLngsMS90aGlzLnkpfWludmVydEluUGxhY2UoKXtyZXR1cm4gdGhpcy54PTEvdGhpcy54LHRoaXMueT0xL3RoaXMueSx0aGlzfW11bHRpcGx5KHQpe3JldHVybiBuZXcgZCh0aGlzLngqdC54LHRoaXMueSp0LnkpfW11bHRpcGx5SW5QbGFjZSh0KXt0aGlzLngqPXQueCx0aGlzLnkqPXQueX1sZW5ndGhTcXVhcmVkKCl7Y29uc3QgdD10aGlzLl9fZGF0YVswXSxlPXRoaXMuX19kYXRhWzFdO3JldHVybiB0KnQrZSplfWxlbmd0aCgpe3JldHVybiBNYXRoLnNxcnQodGhpcy5sZW5ndGhTcXVhcmVkKCkpfWRpc3RhbmNlVG8odCl7Y29uc3QgZT10aGlzLl9fZGF0YVswXS10Lngscz10aGlzLl9fZGF0YVsxXS10Lnk7cmV0dXJuIE1hdGguc3FydChlKmUrcypzKX1ub3JtYWxpemUoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV07bGV0IHM9dCp0K2UqZTtyZXR1cm4gczxOdW1iZXIuRVBTSUxPTj9uZXcgZDoocz0xL01hdGguc3FydChzKSxuZXcgZCh0KnMsZSpzKSl9bm9ybWFsaXplSW5QbGFjZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXTtsZXQgcz10KnQrZSplO3M8TnVtYmVyLkVQU0lMT058fChzPTEvTWF0aC5zcXJ0KHMpLHRoaXMuc2V0KHQqcyxlKnMpKX1kb3QodCl7cmV0dXJuIHRoaXMueCp0LngrdGhpcy55KnQueX1jcm9zcyh0KXtyZXR1cm4gdGhpcy54KnQueS10aGlzLnkqdC54fWFuZ2xlVG8odCl7Y29uc3QgZT10aGlzLm5vcm1hbGl6ZSgpLmRvdCh0Lm5vcm1hbGl6ZSgpKTtyZXR1cm4gZT4xPzA6ZTwtMT9NYXRoLlBJOk1hdGguYWNvcyhlKX1zaWduZWRBbmdsZVRvKHQpe2NvbnN0IGU9dGhpcy5hbmdsZVRvKHQpO3JldHVybiB0aGlzLmNyb3NzKHQpPDA/LWU6ZX1yb3RhdGUodCl7Y29uc3QgZT1NYXRoLmNvcyh0KSxzPU1hdGguc2luKHQpO3JldHVybiBuZXcgZCh0aGlzLngqZS10aGlzLnkqcyx0aGlzLngqcyt0aGlzLnkqZSl9bGVycCh0LGUpe2NvbnN0IHM9dGhpcy54LGE9dGhpcy55O3JldHVybiBuZXcgZChzK2UqKHQueC1zKSxhK2UqKHQueS1hKSl9c2V0UmFuZG9tRGlyKHQ9MSl7Y29uc3QgZT0yKk1hdGgucmFuZG9tKCkqTWF0aC5QSTtyZXR1cm4gdGhpcy5fX2RhdGFbMF09TWF0aC5jb3MoZSkqelNjYWxlLHRoaXMuX19kYXRhWzFdPU1hdGguc2luKGUpKnpTY2FsZSx0aGlzfXNldFJhbmRvbSh0PTEpe3JldHVybiB0aGlzLl9fZGF0YVswXT1NYXRoLnJhbmRvbSgpKnQsdGhpcy5fX2RhdGFbMV09TWF0aC5yYW5kb20oKSp0LHRoaXN9Y2xvbmUoKXtyZXR1cm4gbmV3IGQodGhpcy5fX2RhdGFbMF0sdGhpcy5fX2RhdGFbMV0pfWFzQXJyYXkoKXtyZXR1cm4gdGhpcy5fX2RhdGF9c3RhdGljIGNyZWF0ZSguLi50KXtyZXR1cm4gbmV3IGQoLi4udCl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZT0wKXtyZXR1cm4gY29uc29sZS53YXJuKCJEZXByZWNhdGVkLCB1c2UgI2NyZWF0ZUZyb21CdWZmZXIgaW5zdGVhZCIpLHRoaXMuY3JlYXRlRnJvbUJ1ZmZlcih0LDQqZSl9c3RhdGljIGNyZWF0ZUZyb21CdWZmZXIodCxlKXtyZXR1cm4gbmV3IGQobmV3IEZsb2F0MzJBcnJheSh0LGUsMikpfXN0YXRpYyBjcmVhdGVGcm9tRmxvYXQzMkFycmF5KHQpe3JldHVybiBuZXcgZCh0KX1zdGF0aWMgbnVtRWxlbWVudHMoKXtyZXR1cm4gMn10b0pTT04oKXtyZXR1cm57eDp0aGlzLngseTp0aGlzLnl9fWZyb21KU09OKHQpe3RoaXMueD10LngsdGhpcy55PXQueX1yZWFkQmluYXJ5KHQpe3RoaXMueD10LmxvYWRGbG9hdDMyKCksdGhpcy55PXQubG9hZEZsb2F0MzIoKX19bigiVmVjMiIsZCk7Y2xhc3MgbCBleHRlbmRzIGV7Y29uc3RydWN0b3IodD0wLGU9MCxzPTApe2lmKHN1cGVyKCksdCBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheXx8dCBpbnN0YW5jZW9mIFVpbnQzMkFycmF5KXRoaXMuX19kYXRhPXQ7ZWxzZSBpZih0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnNvbGUud2FybigiZGVwcmVjYXRlZCwgcGxlYXNlIHVzZSBuZXcgVmVjMyhuZXcgRmxvYXQzMkFycmF5KGJ1ZmZlciwgYnl0ZU9mZnNldCwgMykpIik7Y29uc3Qgcz10LGE9ZTt0aGlzLl9fZGF0YT1uZXcgRmxvYXQzMkFycmF5KHMsYSwzKX1lbHNlIG51bGwhPXQmJiJvYmplY3QiPT10eXBlb2YgdD8odGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheSgzKSx0aGlzLmZyb21KU09OKHQpKToodGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheSgzKSx0aGlzLl9fZGF0YVswXT10LHRoaXMuX19kYXRhWzFdPWUsdGhpcy5fX2RhdGFbMl09cyl9Z2V0IHgoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMF19c2V0IHgodCl7dGhpcy5fX2RhdGFbMF09dH1nZXQgeSgpe3JldHVybiB0aGlzLl9fZGF0YVsxXX1zZXQgeSh0KXt0aGlzLl9fZGF0YVsxXT10fWdldCB6KCl7cmV0dXJuIHRoaXMuX19kYXRhWzJdfXNldCB6KHQpe3RoaXMuX19kYXRhWzJdPXR9Z2V0IHh5KCl7cmV0dXJuIG5ldyBkKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdKX1nZXQgeXooKXtyZXR1cm4gbmV3IGQodGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbMl0pfXNldCh0LGUscyl7dGhpcy54PXQsdGhpcy55PXZvaWQgMCE9PWU/ZTp0LHRoaXMuej12b2lkIDAhPT1zP3M6dH1zZXREYXRhQXJyYXkodCl7dGhpcy5fX2RhdGE9dH1zZXRGcm9tT3RoZXIodCl7dGhpcy54PXQueCx0aGlzLnk9dC55LHRoaXMuej10Lnp9aXNOdWxsKCl7cmV0dXJuIE1hdGguYWJzKHRoaXMueCk8TnVtYmVyLkVQU0lMT04mJk1hdGguYWJzKHRoaXMueSk8TnVtYmVyLkVQU0lMT04mJk1hdGguYWJzKHRoaXMueik8TnVtYmVyLkVQU0lMT059aXMxMTEoKXtyZXR1cm4gTWF0aC5hYnMoMS10aGlzLngpPE51bWJlci5FUFNJTE9OJiZNYXRoLmFicygxLXRoaXMueSk8TnVtYmVyLkVQU0lMT04mJk1hdGguYWJzKDEtdGhpcy56KTxOdW1iZXIuRVBTSUxPTn1lcXVhbCh0KXtyZXR1cm4gY29uc29sZS53YXJuKCJEZXByZWNhdGVkLiBVc2UgI2lzRXF1YWwgaW5zdGVhZC4iKSx0aGlzLmlzRXF1YWwodCl9aXNFcXVhbCh0KXtyZXR1cm4gdGhpcy54PT10LngmJnRoaXMueT09dC55JiZ0aGlzLno9PXQuen1ub3RFcXVhbHModCl7cmV0dXJuIGNvbnNvbGUud2FybigiRGVwcmVjYXRlZC4gVXNlICNub3RFcXVhbCBpbnN0ZWFkLiIpLHRoaXMubm90RXF1YWwodCl9bm90RXF1YWwodCl7cmV0dXJuIHRoaXMueCE9dC54JiZ0aGlzLnkhPXQueSYmdGhpcy56IT10Lnp9YXBwcm94RXF1YWwodCxlPU51bWJlci5FUFNJTE9OKXtyZXR1cm4gTWF0aC5hYnModGhpcy54LXQueCk8ZSYmTWF0aC5hYnModGhpcy55LXQueSk8ZSYmTWF0aC5hYnModGhpcy56LXQueik8ZX1hZGQodCl7cmV0dXJuIG5ldyBsKHRoaXMueCt0LngsdGhpcy55K3QueSx0aGlzLnordC56KX1hZGRJblBsYWNlKHQpe3RoaXMueCs9dC54LHRoaXMueSs9dC55LHRoaXMueis9dC56fXN1YnRyYWN0KHQpe3JldHVybiBuZXcgbCh0aGlzLngtdC54LHRoaXMueS10LnksdGhpcy56LXQueil9c3VidHJhY3RJblBsYWNlKHQpe3RoaXMueC09dC54LHRoaXMueS09dC55LHRoaXMuei09dC56fW11bHRpcGx5KHQpe3JldHVybiBuZXcgbCh0aGlzLngqdC54LHRoaXMueSp0LnksdGhpcy56KnQueil9bXVsdGlwbHlJblBsYWNlKHQpe3RoaXMueCo9dC54LHRoaXMueSo9dC55LHRoaXMueio9dC56fWRpdmlkZSh0KXtyZXR1cm4gbmV3IGwodGhpcy54L3QueCx0aGlzLnkvdC55LHRoaXMuei90LnopfWRpdmlkZUluUGxhY2UodCl7dGhpcy54Lz10LngsdGhpcy55Lz10LnksdGhpcy56Lz10Lnp9c2NhbGUodCl7cmV0dXJuIG5ldyBsKHRoaXMueCp0LHRoaXMueSp0LHRoaXMueip0KX1zY2FsZUluUGxhY2UodCl7dGhpcy54Kj10LHRoaXMueSo9dCx0aGlzLnoqPXR9bmVnYXRlKCl7cmV0dXJuIG5ldyBsKC10aGlzLngsLXRoaXMueSwtdGhpcy56KX1pbnZlcnNlKCl7cmV0dXJuIG5ldyBsKDEvdGhpcy54LDEvdGhpcy55LDEvdGhpcy56KX1sZW5ndGhTcXVhcmVkKCl7Y29uc3QgdD10aGlzLl9fZGF0YVswXSxlPXRoaXMuX19kYXRhWzFdLHM9dGhpcy5fX2RhdGFbMl07cmV0dXJuIHQqdCtlKmUrcypzfWxlbmd0aCgpe3JldHVybiBNYXRoLnNxcnQodGhpcy5sZW5ndGhTcXVhcmVkKCkpfWRpc3RhbmNlVG8odCl7Y29uc3QgZT10aGlzLl9fZGF0YVswXS10Lngscz10aGlzLl9fZGF0YVsxXS10LnksYT10aGlzLl9fZGF0YVsyXS10Lno7cmV0dXJuIE1hdGguc3FydChlKmUrcypzK2EqYSl9bm9ybWFsaXplKCl7bGV0IHQ9dGhpcy5fX2RhdGFbMF0qdGhpcy5fX2RhdGFbMF0rdGhpcy5fX2RhdGFbMV0qdGhpcy5fX2RhdGFbMV0rdGhpcy5fX2RhdGFbMl0qdGhpcy5fX2RhdGFbMl07cmV0dXJuIHQ8TnVtYmVyLkVQU0lMT04/bmV3IGw6KHQ9MS9NYXRoLnNxcnQodCksbmV3IGwodGhpcy5fX2RhdGFbMF0qdCx0aGlzLl9fZGF0YVsxXSp0LHRoaXMuX19kYXRhWzJdKnQpKX1ub3JtYWxpemVJblBsYWNlKCl7bGV0IHQ9dGhpcy5fX2RhdGFbMF0qdGhpcy5fX2RhdGFbMF0rdGhpcy5fX2RhdGFbMV0qdGhpcy5fX2RhdGFbMV0rdGhpcy5fX2RhdGFbMl0qdGhpcy5fX2RhdGFbMl07aWYodDxOdW1iZXIuRVBTSUxPTilyZXR1cm47dD1NYXRoLnNxcnQodCk7Y29uc3QgZT0xL3Q7cmV0dXJuIHRoaXMuX19kYXRhWzBdKj1lLHRoaXMuX19kYXRhWzFdKj1lLHRoaXMuX19kYXRhWzJdKj1lLHR9cmVzaXplKHQpe2NvbnN0IGU9dGhpcy5fX2RhdGFbMF0qdGhpcy5fX2RhdGFbMF0rdGhpcy5fX2RhdGFbMV0qdGhpcy5fX2RhdGFbMV0rdGhpcy5fX2RhdGFbMl0qdGhpcy5fX2RhdGFbMl07aWYoZTxOdW1iZXIuRVBTSUxPTilyZXR1cm47Y29uc3Qgcz10L01hdGguc3FydChlKTtyZXR1cm4gbmV3IGwodGhpcy5fX2RhdGFbMF0qcyx0aGlzLl9fZGF0YVsxXSpzLHRoaXMuX19kYXRhWzJdKnMpfXJlc2l6ZUluUGxhY2UodCl7Y29uc3QgZT10aGlzLl9fZGF0YVswXSp0aGlzLl9fZGF0YVswXSt0aGlzLl9fZGF0YVsxXSp0aGlzLl9fZGF0YVsxXSt0aGlzLl9fZGF0YVsyXSp0aGlzLl9fZGF0YVsyXTtpZihlPE51bWJlci5FUFNJTE9OKXJldHVybjtjb25zdCBzPXQvTWF0aC5zcXJ0KGUpO3RoaXMuX19kYXRhWzBdKj1zLHRoaXMuX19kYXRhWzFdKj1zLHRoaXMuX19kYXRhWzJdKj1zfWRvdCh0KXtyZXR1cm4gdGhpcy54KnQueCt0aGlzLnkqdC55K3RoaXMueip0Lnp9Y3Jvc3ModCl7Y29uc3QgZT10aGlzLngscz10aGlzLnksYT10aGlzLnosaT10Lngscj10Lnksbj10Lno7cmV0dXJuIG5ldyBsKHMqbi1hKnIsYSppLWUqbixlKnItcyppKX1hbmdsZVRvKHQpe2NvbnN0IGU9dGhpcy5kb3QodCk7cmV0dXJuIGU+MT8wOk1hdGguYWNvcyhlKX1sZXJwKHQsZSl7Y29uc3Qgcz10aGlzLngsYT10aGlzLnksaT10aGlzLno7cmV0dXJuIG5ldyBsKHMrZSoodC54LXMpLGErZSoodC55LWEpLGkrZSoodC56LWkpKX1hYnMoKXtyZXR1cm4gbmV3IGwoTWF0aC5hYnModGhpcy54KSxNYXRoLmFicyh0aGlzLnkpLE1hdGguYWJzKHRoaXMueikpfXNldFJhbmRvbURpcih0PTEpe2NvbnN0IGU9MipNYXRoLnJhbmRvbSgpKk1hdGguUEkscz0yKk1hdGgucmFuZG9tKCktMSxhPU1hdGguc3FydCgxLXMqcykqdDtyZXR1cm4gdGhpcy5fX2RhdGFbMF09TWF0aC5jb3MoZSkqYSx0aGlzLl9fZGF0YVsxXT1NYXRoLnNpbihlKSphLHRoaXMuX19kYXRhWzJdPXMqdCx0aGlzfXNldFJhbmRvbSh0PTEpe3JldHVybiB0aGlzLl9fZGF0YVswXT0oTWF0aC5yYW5kb20oKS0uNSkqdCx0aGlzLl9fZGF0YVsxXT0oTWF0aC5yYW5kb20oKS0uNSkqdCx0aGlzLl9fZGF0YVsyXT0oTWF0aC5yYW5kb20oKS0uNSkqdCx0aGlzfWNsb25lKCl7cmV0dXJuIG5ldyBsKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdKX1hc0FycmF5KCl7cmV0dXJuIHRoaXMuX19kYXRhfXN0YXRpYyBjcmVhdGUoLi4udCl7cmV0dXJuIG5ldyBsKC4uLnQpfXN0YXRpYyBjcmVhdGVGcm9tSlNPTih0KXtjb25zdCBlPW5ldyBsO3JldHVybiBlLmZyb21KU09OKHQpLGV9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZT0wKXtyZXR1cm4gY29uc29sZS53YXJuKCJEZXByZWNhdGVkLCB1c2UgI2NyZWF0ZUZyb21CdWZmZXIgaW5zdGVhZCIpLHRoaXMuY3JlYXRlRnJvbUJ1ZmZlcih0LDQqZSl9c3RhdGljIGNyZWF0ZUZyb21CdWZmZXIodCxlKXtyZXR1cm4gbmV3IGwobmV3IEZsb2F0MzJBcnJheSh0LGUsMykpfXN0YXRpYyBjcmVhdGVGcm9tRmxvYXQzMkFycmF5KHQpe3JldHVybiBuZXcgbCh0KX1zdGF0aWMgbnVtRWxlbWVudHMoKXtyZXR1cm4gM310b0pTT04oKXtyZXR1cm57eDp0aGlzLngseTp0aGlzLnksejp0aGlzLnp9fWZyb21KU09OKHQpe3RoaXMueD10LngsdGhpcy55PXQueSx0aGlzLno9dC56fXJlYWRCaW5hcnkodCl7dGhpcy54PXQubG9hZEZsb2F0MzIoKSx0aGlzLnk9dC5sb2FkRmxvYXQzMigpLHRoaXMuej10LmxvYWRGbG9hdDMyKCl9fW4oIlZlYzMiLGwpO2NsYXNzIGMgZXh0ZW5kcyBle2NvbnN0cnVjdG9yKHQ9MCxlPTAscz0wLGE9MCl7aWYoc3VwZXIoKSx0IGluc3RhbmNlb2YgRmxvYXQzMkFycmF5fHx0IGluc3RhbmNlb2YgVWludDMyQXJyYXkpdGhpcy5fX2RhdGE9dDtlbHNlIGlmKHQgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcil7Y29uc29sZS53YXJuKCJkZXByZWNhdGVkLCBwbGVhc2UgdXNlIG5ldyBWZWM0KG5ldyBGbG9hdDMyQXJyYXkoYnVmZmVyLCBieXRlT2Zmc2V0LCA0KSkiKTtjb25zdCBzPXQsYT1lO3RoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkocyxhLDQpfWVsc2UgbnVsbCE9dCYmIm9iamVjdCI9PXR5cGVvZiB0Pyh0aGlzLl9fZGF0YT1uZXcgRmxvYXQzMkFycmF5KDQpLHRoaXMuZnJvbUpTT04odCkpOih0aGlzLl9fZGF0YT1uZXcgRmxvYXQzMkFycmF5KDQpLHRoaXMuX19kYXRhWzBdPXQsdGhpcy5fX2RhdGFbMV09ZSx0aGlzLl9fZGF0YVsyXT1zLHRoaXMuX19kYXRhWzNdPWEpfWdldCB4KCl7cmV0dXJuIHRoaXMuX19kYXRhWzBdfXNldCB4KHQpe3RoaXMuX19kYXRhWzBdPXR9Z2V0IHkoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMV19c2V0IHkodCl7dGhpcy5fX2RhdGFbMV09dH1nZXQgeigpe3JldHVybiB0aGlzLl9fZGF0YVsyXX1zZXQgeih0KXt0aGlzLl9fZGF0YVsyXT10fWdldCB0KCl7cmV0dXJuIHRoaXMuX19kYXRhWzNdfXNldCB0KHQpe3RoaXMuX19kYXRhWzNdPXR9Z2V0IHcoKXtyZXR1cm4gdGhpcy5fX2RhdGFbM119c2V0IHcodCl7dGhpcy5fX2RhdGFbM109dH1nZXQgeHl6KCl7cmV0dXJuIG5ldyBsKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdKX1zZXQodCxlLHMsYSl7dGhpcy54PXQsdGhpcy55PWUsdGhpcy56PXMsdGhpcy50PWF9c2V0RnJvbU90aGVyKHQpe3RoaXMueD10LngsdGhpcy55PXQueSx0aGlzLno9dC56LHRoaXMudD10LnR9ZXF1YWwodCl7cmV0dXJuIGNvbnNvbGUud2FybigiRGVwcmVjYXRlZC4gVXNlICNpc0VxdWFsIGluc3RlYWQuIiksdGhpcy5pc0VxdWFsKHQpfWlzRXF1YWwodCl7cmV0dXJuIHRoaXMueD09dC54JiZ0aGlzLnk9PXQueSYmdGhpcy56PT10LnomJnRoaXMudD09dC50fW5vdEVxdWFscyh0KXtyZXR1cm4gY29uc29sZS53YXJuKCJEZXByZWNhdGVkLiBVc2UgI25vdEVxdWFsIGluc3RlYWQuIiksdGhpcy5ub3RFcXVhbCh0KX1ub3RFcXVhbCh0KXtyZXR1cm4gdGhpcy54IT10LngmJnRoaXMueSE9dC55JiZ0aGlzLnohPXQueiYmdGhpcy50IT10LnR9YXBwcm94RXF1YWwodCxlPU51bWJlci5FUFNJTE9OKXtyZXR1cm4gTWF0aC5hYnModGhpcy54LXQueCk8ZSYmTWF0aC5hYnModGhpcy55LXQueSk8ZSYmTWF0aC5hYnModGhpcy56LXQueik8ZSYmTWF0aC5hYnModGhpcy50LXQudCk8ZX1hZGQodCl7cmV0dXJuIG5ldyBjKHRoaXMueCt0LngsdGhpcy55K3QueSx0aGlzLnordC56LHRoaXMudCt0LnQpfWFkZEluUGxhY2UodCl7dGhpcy54Kz10LngsdGhpcy55Kz10LnksdGhpcy56Kz10LnosdGhpcy50Kz10LnR9c3VidHJhY3QodCl7cmV0dXJuIG5ldyBjKHRoaXMueC10LngsdGhpcy55LXQueSx0aGlzLnotdC56LHRoaXMudC10LnQpfXN1YnRyYWN0SW5QbGFjZSh0KXt0aGlzLngtPXQueCx0aGlzLnktPXQueSx0aGlzLnotPXQueix0aGlzLnQtPXQudH1tdWx0aXBseSh0KXtyZXR1cm4gbmV3IGModGhpcy54KnQueCx0aGlzLnkqdC55LHRoaXMueip0LnosdGhpcy50KnQudCl9bXVsdGlwbHlJblBsYWNlKHQpe3RoaXMueCo9dC54LHRoaXMueSo9dC55LHRoaXMueio9dC56LHRoaXMudCo9dC50fWRpdmlkZSh0KXtyZXR1cm4gbmV3IGModGhpcy54L3QueCx0aGlzLnkvdC55LHRoaXMuei90LnosdGhpcy50L3QudCl9ZGl2aWRlSW5QbGFjZSh0KXt0aGlzLngvPXQueCx0aGlzLnkvPXQueSx0aGlzLnovPXQueix0aGlzLnQvPXQudH1zY2FsZSh0KXtyZXR1cm4gbmV3IGModGhpcy54KnQsdGhpcy55KnQsdGhpcy56KnQsdGhpcy50KnQpfXNjYWxlSW5QbGFjZSh0KXt0aGlzLnNldCh0aGlzLngqdCx0aGlzLnkqdCx0aGlzLnoqdCx0aGlzLnQqdCl9bGVuZ3RoKCl7Y29uc3QgdD10aGlzLl9fZGF0YVswXSxlPXRoaXMuX19kYXRhWzFdLHM9dGhpcy5fX2RhdGFbMl0sYT10aGlzLl9fZGF0YVsyXTtyZXR1cm4gTWF0aC5zcXJ0KHQqdCtlKmUrcypzK2EqYSl9bGVuZ3RoU3F1YXJlZCgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM107cmV0dXJuIHQqdCtlKmUrcypzK2EqYX1ub3JtYWxpemUoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV0scz10aGlzLl9fZGF0YVsyXSxhPXRoaXMuX19kYXRhWzNdO2xldCBpPXQqdCtlKmUrcypzK2EqYTtyZXR1cm4gaTxOdW1iZXIuRVBTSUxPTj9uZXcgYzooaT0xL01hdGguc3FydChpKSxuZXcgYyh0KmksZSppLHMqaSkpfW5vcm1hbGl6ZUluUGxhY2UoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV0scz10aGlzLl9fZGF0YVsyXSxhPXRoaXMuX19kYXRhWzNdO2xldCBpPXQqdCtlKmUrcypzK2EqYTtpPE51bWJlci5FUFNJTE9OfHwoaT0xL01hdGguc3FydChpKSx0aGlzLnNldCh0KmksZSppLHMqaSxhKmkpKX1kb3QodCl7cmV0dXJuIHRoaXMueCp0LngrdGhpcy55KnQueSt0aGlzLnoqdC56K3RoaXMudCpiLnR9Y3Jvc3ModCl7Y29uc3QgZT10aGlzLngscz10aGlzLnksYT10aGlzLnosaT10aGlzLnQscj10Lngsbj10LnksaD10Lnosbz10LnQ7cmV0dXJuIG5ldyBjKHMqaC1hKm4sYSpvLWkqaCxpKnItZSpvLGUqbi1zKnIpfWFuZ2xlVG8odCl7Y29uc3QgZT10aGlzLm5vcm1hbGl6ZSgpLHM9dC5ub3JtYWxpemUoKSxhPWUuZG90KHMpO3JldHVybiBhPjE/MDpNYXRoLmFjb3MoYSl9bGVycCh0LGUpe2NvbnN0IHM9dGhpcy54LGE9dGhpcy55LGk9dGhpcy56O3JldHVybiBhdD10aGlzLnQsbmV3IGMocytlKih0LngtcyksYStlKih0LnktYSksaStlKih0LnotaSksYXQrZSoodC50LWF0KSl9cmFuZG9tKHQ9MSl7Y29uc3QgZT0yKmdsTWF0cml4LlJBTkRPTSgpKk1hdGguUEkscz0yKmdsTWF0cml4LlJBTkRPTSgpLTEsYT1NYXRoLnNxcnQoMS1zKnMpKnQ7cmV0dXJuIG91dFswXT1NYXRoLmNvcyhlKSphLG91dFsxXT1NYXRoLnNpbihlKSphLG91dFsyXT1zKnQsb3V0fWNsb25lKCl7cmV0dXJuIG5ldyBjKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdLHRoaXMuX19kYXRhWzNdKX10b1ZlYzMoKXtyZXR1cm4gbmV3IGwodGhpcy5fX2RhdGFbMF0sdGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbMl0pfWFzQXJyYXkoKXtyZXR1cm4gdGhpcy5fX2RhdGF9c3RhdGljIGNyZWF0ZSguLi50KXtyZXR1cm4gbmV3IGwoLi4udCl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZT0wKXtyZXR1cm4gY29uc29sZS53YXJuKCJEZXByZWNhdGVkLCB1c2UgI2NyZWF0ZUZyb21CdWZmZXIgaW5zdGVhZCIpLG5ldyBjKG5ldyBGbG9hdDMyQXJyYXkodCw0KmUsNCkpfXN0YXRpYyBjcmVhdGVGcm9tQnVmZmVyKHQsZSl7cmV0dXJuIG5ldyBjKG5ldyBGbG9hdDMyQXJyYXkodCxlLDQpKX1zdGF0aWMgbnVtRWxlbWVudHMoKXtyZXR1cm4gNH10b0pTT04oKXtyZXR1cm57eDp0aGlzLngseTp0aGlzLnksejp0aGlzLnosdDp0aGlzLnR9fWZyb21KU09OKHQpe3RoaXMueD10LngsdGhpcy55PXQueSx0aGlzLno9dC56LHRoaXMudD10LnR9cmVhZEJpbmFyeSh0KXt0aGlzLng9dC5sb2FkRmxvYXQzMigpLHRoaXMueT10LmxvYWRGbG9hdDMyKCksdGhpcy56PXQubG9hZEZsb2F0MzIoKSx0aGlzLnQ9dC5sb2FkRmxvYXQzMigpfX1uKCJWZWM0IixjKTtjbGFzcyB1IGV4dGVuZHMgZXtjb25zdHJ1Y3Rvcih0PTAsZT0wLHM9MCxhPTI1NSl7c3VwZXIoKSx0IGluc3RhbmNlb2YgVWludDhBcnJheT90aGlzLl9fZGF0YT10Oih0aGlzLl9fZGF0YT1uZXcgVWludDhBcnJheSg0KSwic3RyaW5nIj09dHlwZW9mIHQ/dC5zdGFydHNXaXRoKCIjIik/dGhpcy5zZXRGcm9tSGV4KHQpOnRoaXMuc2V0RnJvbUNTU0NvbG9yTmFtZSh0KToodGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lLHRoaXMuX19kYXRhWzJdPXMsdGhpcy5fX2RhdGFbM109YSkpfWdldCByKCl7cmV0dXJuIHRoaXMuX19kYXRhWzBdfXNldCByKHQpe3RoaXMuX19kYXRhWzBdPXR9Z2V0IGcoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMV19c2V0IGcodCl7dGhpcy5fX2RhdGFbMV09dH1nZXQgYigpe3JldHVybiB0aGlzLl9fZGF0YVsyXX1zZXQgYih0KXt0aGlzLl9fZGF0YVsyXT10fWdldCBhKCl7cmV0dXJuIHRoaXMuX19kYXRhWzNdfXNldCBhKHQpe3RoaXMuX19kYXRhWzNdPXR9c2V0KHQsZSxzLGE9MjU1KXt0aGlzLnI9dCx0aGlzLmc9ZSx0aGlzLmI9cyx0aGlzLmE9YX1zZXRGcm9tT3RoZXIodCl7dGhpcy5yPXQucix0aGlzLmc9dC5nLHRoaXMuYj10LmIsdGhpcy5hPXQuYX1zZXRGcm9tQXJyYXkodCl7dGhpcy5yPXRbMF0sdGhpcy5nPXRbMV0sdGhpcy5iPXRbMl0sdGhpcy5hPTQ9PXQubGVuZ3RoP3RbM106MX1zZXRGcm9tSGV4KHQpe2NvbnN0IGU9ZnVuY3Rpb24odCl7Y29uc3QgZT0vXiM/KFthLWZcZF17Mn0pKFthLWZcZF17Mn0pKFthLWZcZF17Mn0pJC9pLmV4ZWModCk7cmV0dXJuIGU/e3I6cGFyc2VJbnQoZVsxXSwxNiksZzpwYXJzZUludChlWzJdLDE2KSxiOnBhcnNlSW50KGVbM10sMTYpfTpudWxsfSh0KTtlP3RoaXMuc2V0KGUucixlLmcsZS5iKTpjb25zb2xlLndhcm4oIkludmFsaWQgaGV4IGNvZGU6Iit0KX1zZXRGcm9tQ1NTQ29sb3JOYW1lKHQpe3Quc3RhcnRzV2l0aCgiIyIpP3RoaXMuc2V0RnJvbUhleCh0KTp0aGlzLnNldEZyb21IZXgoKHQ9Pntjb25zdCBlPXthbGljZWJsdWU6IiNmMGY4ZmYiLGFudGlxdWV3aGl0ZToiI2ZhZWJkNyIsYXF1YToiIzAwZmZmZiIsYXF1YW1hcmluZToiIzdmZmZkNCIsYXp1cmU6IiNmMGZmZmYiLGJlaWdlOiIjZjVmNWRjIixiaXNxdWU6IiNmZmU0YzQiLGJsYWNrOiIjMDAwMDAwIixibGFuY2hlZGFsbW9uZDoiI2ZmZWJjZCIsYmx1ZToiIzAwMDBmZiIsYmx1ZXZpb2xldDoiIzhhMmJlMiIsYnJvd246IiNhNTJhMmEiLGJ1cmx5d29vZDoiI2RlYjg4NyIsY2FkZXRibHVlOiIjNWY5ZWEwIixjaGFydHJldXNlOiIjN2ZmZjAwIixjaG9jb2xhdGU6IiNkMjY5MWUiLGNvcmFsOiIjZmY3ZjUwIixjb3JuZmxvd2VyYmx1ZToiIzY0OTVlZCIsY29ybnNpbGs6IiNmZmY4ZGMiLGNyaW1zb246IiNkYzE0M2MiLGN5YW46IiMwMGZmZmYiLGRhcmtibHVlOiIjMDAwMDhiIixkYXJrY3lhbjoiIzAwOGI4YiIsZGFya2dvbGRlbnJvZDoiI2I4ODYwYiIsZGFya2dyYXk6IiNhOWE5YTkiLGRhcmtncmVlbjoiIzAwNjQwMCIsZGFya2toYWtpOiIjYmRiNzZiIixkYXJrbWFnZW50YToiIzhiMDA4YiIsZGFya29saXZlZ3JlZW46IiM1NTZiMmYiLGRhcmtvcmFuZ2U6IiNmZjhjMDAiLGRhcmtvcmNoaWQ6IiM5OTMyY2MiLGRhcmtyZWQ6IiM4YjAwMDAiLGRhcmtzYWxtb246IiNlOTk2N2EiLGRhcmtzZWFncmVlbjoiIzhmYmM4ZiIsZGFya3NsYXRlYmx1ZToiIzQ4M2Q4YiIsZGFya3NsYXRlZ3JheToiIzJmNGY0ZiIsZGFya3R1cnF1b2lzZToiIzAwY2VkMSIsZGFya3Zpb2xldDoiIzk0MDBkMyIsZGVlcHBpbms6IiNmZjE0OTMiLGRlZXBza3libHVlOiIjMDBiZmZmIixkaW1ncmF5OiIjNjk2OTY5Iixkb2RnZXJibHVlOiIjMWU5MGZmIixmaXJlYnJpY2s6IiNiMjIyMjIiLGZsb3JhbHdoaXRlOiIjZmZmYWYwIixmb3Jlc3RncmVlbjoiIzIyOGIyMiIsZnVjaHNpYToiI2ZmMDBmZiIsZ2FpbnNib3JvOiIjZGNkY2RjIixnaG9zdHdoaXRlOiIjZjhmOGZmIixnb2xkOiIjZmZkNzAwIixnb2xkZW5yb2Q6IiNkYWE1MjAiLGdyYXk6IiM4MDgwODAiLGdyZWVuOiIjMDA4MDAwIixncmVlbnllbGxvdzoiI2FkZmYyZiIsaG9uZXlkZXc6IiNmMGZmZjAiLGhvdHBpbms6IiNmZjY5YjQiLCJpbmRpYW5yZWQgIjoiI2NkNWM1YyIsaW5kaWdvOiIjNGIwMDgyIixpdm9yeToiI2ZmZmZmMCIsa2hha2k6IiNmMGU2OGMiLGxhdmVuZGVyOiIjZTZlNmZhIixsYXZlbmRlcmJsdXNoOiIjZmZmMGY1IixsYXduZ3JlZW46IiM3Y2ZjMDAiLGxlbW9uY2hpZmZvbjoiI2ZmZmFjZCIsbGlnaHRibHVlOiIjYWRkOGU2IixsaWdodGNvcmFsOiIjZjA4MDgwIixsaWdodGN5YW46IiNlMGZmZmYiLGxpZ2h0Z29sZGVucm9keWVsbG93OiIjZmFmYWQyIixsaWdodGdyZXk6IiNkM2QzZDMiLGxpZ2h0Z3JlZW46IiM5MGVlOTAiLGxpZ2h0cGluazoiI2ZmYjZjMSIsbGlnaHRzYWxtb246IiNmZmEwN2EiLGxpZ2h0c2VhZ3JlZW46IiMyMGIyYWEiLGxpZ2h0c2t5Ymx1ZToiIzg3Y2VmYSIsbGlnaHRzbGF0ZWdyYXk6IiM3Nzg4OTkiLGxpZ2h0c3RlZWxibHVlOiIjYjBjNGRlIixsaWdodHllbGxvdzoiI2ZmZmZlMCIsbGltZToiIzAwZmYwMCIsbGltZWdyZWVuOiIjMzJjZDMyIixsaW5lbjoiI2ZhZjBlNiIsbWFnZW50YToiI2ZmMDBmZiIsbWFyb29uOiIjODAwMDAwIixtZWRpdW1hcXVhbWFyaW5lOiIjNjZjZGFhIixtZWRpdW1ibHVlOiIjMDAwMGNkIixtZWRpdW1vcmNoaWQ6IiNiYTU1ZDMiLG1lZGl1bXB1cnBsZToiIzkzNzBkOCIsbWVkaXVtc2VhZ3JlZW46IiMzY2IzNzEiLG1lZGl1bXNsYXRlYmx1ZToiIzdiNjhlZSIsbWVkaXVtc3ByaW5nZ3JlZW46IiMwMGZhOWEiLG1lZGl1bXR1cnF1b2lzZToiIzQ4ZDFjYyIsbWVkaXVtdmlvbGV0cmVkOiIjYzcxNTg1IixtaWRuaWdodGJsdWU6IiMxOTE5NzAiLG1pbnRjcmVhbToiI2Y1ZmZmYSIsbWlzdHlyb3NlOiIjZmZlNGUxIixtb2NjYXNpbjoiI2ZmZTRiNSIsbmF2YWpvd2hpdGU6IiNmZmRlYWQiLG5hdnk6IiMwMDAwODAiLG9sZGxhY2U6IiNmZGY1ZTYiLG9saXZlOiIjODA4MDAwIixvbGl2ZWRyYWI6IiM2YjhlMjMiLG9yYW5nZToiI2ZmYTUwMCIsb3JhbmdlcmVkOiIjZmY0NTAwIixvcmNoaWQ6IiNkYTcwZDYiLHBhbGVnb2xkZW5yb2Q6IiNlZWU4YWEiLHBhbGVncmVlbjoiIzk4ZmI5OCIscGFsZXR1cnF1b2lzZToiI2FmZWVlZSIscGFsZXZpb2xldHJlZDoiI2Q4NzA5MyIscGFwYXlhd2hpcDoiI2ZmZWZkNSIscGVhY2hwdWZmOiIjZmZkYWI5IixwZXJ1OiIjY2Q4NTNmIixwaW5rOiIjZmZjMGNiIixwbHVtOiIjZGRhMGRkIixwb3dkZXJibHVlOiIjYjBlMGU2IixwdXJwbGU6IiM4MDAwODAiLHJlYmVjY2FwdXJwbGU6IiM2NjMzOTkiLHJlZDoiI2ZmMDAwMCIscm9zeWJyb3duOiIjYmM4ZjhmIixyb3lhbGJsdWU6IiM0MTY5ZTEiLHNhZGRsZWJyb3duOiIjOGI0NTEzIixzYWxtb246IiNmYTgwNzIiLHNhbmR5YnJvd246IiNmNGE0NjAiLHNlYWdyZWVuOiIjMmU4YjU3IixzZWFzaGVsbDoiI2ZmZjVlZSIsc2llbm5hOiIjYTA1MjJkIixzaWx2ZXI6IiNjMGMwYzAiLHNreWJsdWU6IiM4N2NlZWIiLHNsYXRlYmx1ZToiIzZhNWFjZCIsc2xhdGVncmF5OiIjNzA4MDkwIixzbm93OiIjZmZmYWZhIixzcHJpbmdncmVlbjoiIzAwZmY3ZiIsc3RlZWxibHVlOiIjNDY4MmI0Iix0YW46IiNkMmI0OGMiLHRlYWw6IiMwMDgwODAiLHRoaXN0bGU6IiNkOGJmZDgiLHRvbWF0bzoiI2ZmNjM0NyIsdHVycXVvaXNlOiIjNDBlMGQwIix2aW9sZXQ6IiNlZTgyZWUiLHdoZWF0OiIjZjVkZWIzIix3aGl0ZToiI2ZmZmZmZiIsd2hpdGVzbW9rZToiI2Y1ZjVmNSIseWVsbG93OiIjZmZmZjAwIix5ZWxsb3dncmVlbjoiIzlhY2QzMiJ9O3JldHVybiB2b2lkIDAhPT1lW3QudG9Mb3dlckNhc2UoKV0mJmVbdC50b0xvd2VyQ2FzZSgpXX0pKHQpKX10b0hleCgpe2Z1bmN0aW9uIHQodCl7Y29uc3QgZT10LnRvU3RyaW5nKDE2KTtyZXR1cm4gMT09ZS5sZW5ndGg/IjAiK2U6ZX1yZXR1cm4iIyIrdCh0aGlzLnIpK3QodGhpcy5nKSt0KHRoaXMuYil9ZXF1YWwodCl7cmV0dXJuIGNvbnNvbGUud2FybigiRGVwcmVjYXRlZC4gVXNlICNpc0VxdWFsIGluc3RlYWQuIiksdGhpcy5pc0VxdWFsKHQpfWlzRXF1YWwodCl7cmV0dXJuIHRoaXMucj09dC5yJiZ0aGlzLmc9PXQuZyYmdGhpcy5iPT10LmImJnRoaXMuYT09dC5hfW5vdEVxdWFscyh0KXtyZXR1cm4gdGhpcy5yIT10LnImJnRoaXMuZyE9dC5nJiZ0aGlzLmIhPXQuYiYmdGhpcy5hIT10LmF9YXBwcm94RXF1YWwodCxlPU51bWJlci5FUFNJTE9OKXtyZXR1cm4gTWF0aC5hYnModGhpcy5yLXQucik8ZSYmTWF0aC5hYnModGhpcy5nLXQuZyk8ZSYmTWF0aC5hYnModGhpcy5iLXQuYik8ZSYmTWF0aC5hYnModGhpcy5hLXQuYSk8ZX1hZGQodCl7cmV0dXJuIG5ldyB1KHRoaXMucit0LnIsdGhpcy5nK3QuZyx0aGlzLmIrdC5iLHRoaXMuYSt0LmEpfXN1YnRyYWN0KHQpe3JldHVybiBuZXcgdSh0aGlzLnItdC5yLHRoaXMuZy10LmcsdGhpcy5iLXQuYix0aGlzLmEtdC5hKX1zY2FsZSh0KXtyZXR1cm4gbmV3IHUodGhpcy5yKnQsdGhpcy5nKnQsdGhpcy5iKnQsdGhpcy5hKnQpfXNjYWxlSW5QbGFjZSh0KXt0aGlzLnIqPXQsdGhpcy5nKj10LHRoaXMuYio9dCx0aGlzLmEqPXR9YXBwbHlHYW1tYSh0KXt0aGlzLnNldChNYXRoLnBvdyh0aGlzLnIsdCksTWF0aC5wb3codGhpcy5nLHQpLE1hdGgucG93KHRoaXMuYix0KSx0aGlzLmEpfXRvTGluZWFyKHQ9Mi4yKXtyZXR1cm4gbmV3IHUoTWF0aC5wb3codGhpcy5yLHQpLE1hdGgucG93KHRoaXMuZyx0KSxNYXRoLnBvdyh0aGlzLmIsdCksdGhpcy5hKX10b0dhbW1hKHQ9Mi4yKXtyZXR1cm4gbmV3IHUoTWF0aC5wb3codGhpcy5yLDEvdCksTWF0aC5wb3codGhpcy5nLDEvdCksTWF0aC5wb3codGhpcy5iLDEvdCksdGhpcy5hKX1sdW1pbmFuY2UoKXtyZXR1cm4uMjEyNip0aGlzLnIrLjcxNTIqdGhpcy5nKy4wNzIyKnRoaXMuYn1sZXJwKHQsZSl7Y29uc3Qgcz10aGlzLnIsYT10aGlzLmcsaT10aGlzLmIscj10aGlzLmE7cmV0dXJuIG5ldyB1KHMrZSoodC5yLXMpLGErZSoodC5nLWEpLGkrZSoodC5iLWkpLHIrZSoodC5hLXIpKX1zdGF0aWMgcmFuZG9tKHQ9MCxlPSExKXtyZXR1cm4gdD4wP25ldyB1KHQrTWF0aC5yYW5kb20oKSooMS10KSx0K01hdGgucmFuZG9tKCkqKDEtdCksdCtNYXRoLnJhbmRvbSgpKigxLXQpLGU/dCtNYXRoLnJhbmRvbSgpKigxLXQpOjEpOnQ8MD9uZXcgdShNYXRoLnJhbmRvbSgpKigxK3QpLE1hdGgucmFuZG9tKCkqKDErdCksTWF0aC5yYW5kb20oKSooMSt0KSxlP01hdGgucmFuZG9tKCkqKDErdCk6MSk6bmV3IHUoTWF0aC5yYW5kb20oKSxNYXRoLnJhbmRvbSgpLE1hdGgucmFuZG9tKCksZT9NYXRoLnJhbmRvbSgpOjEpfWNsb25lKCl7cmV0dXJuIG5ldyB1KHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdLHRoaXMuX19kYXRhWzNdKX1hc0FycmF5KCl7cmV0dXJuIHRoaXMuX19kYXRhfWFzM0NvbXBvbmVudEFycmF5KCl7cmV0dXJuW3RoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdXX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgdSguLi50KX1zdGF0aWMgY3JlYXRlRnJvbUZsb2F0MzJCdWZmZXIodCxlPTApe3JldHVybiBjb25zb2xlLndhcm4oIkRlcHJlY2F0ZWQsIHVzZSAjY3JlYXRlRnJvbUJ1ZmZlciBpbnN0ZWFkIiksdGhpcy5jcmVhdGVGcm9tQnVmZmVyKHQsNCplKX1zdGF0aWMgY3JlYXRlRnJvbUJ1ZmZlcih0LGUpe3JldHVybiBuZXcgdShuZXcgVWludDhBcnJheSh0LGUsNCkpfXN0YXRpYyBudW1FbGVtZW50cygpe3JldHVybiA0fXRvSlNPTigpe3JldHVybntyOnRoaXMucixnOnRoaXMuZyxiOnRoaXMuYixhOnRoaXMuYX19ZnJvbUpTT04odCl7dGhpcy5yPXQucix0aGlzLmc9dC5nLHRoaXMuYj10LmIsdGhpcy5hPXQuYX10b0NTU1N0cmluZygpe3JldHVybiJyZ2JhKCIrTWF0aC5yb3VuZCgyNTUqdGhpcy5yKSsiLCAiK01hdGgucm91bmQoMjU1KnRoaXMuZykrIiwgIitNYXRoLnJvdW5kKDI1NSp0aGlzLmIpKyIsICIrdGhpcy5hKyIpIn19bigiUkdCQSIsdSk7Y2xhc3MgZiBleHRlbmRzIGV7Y29uc3RydWN0b3IodD0wLGU9MCxzPTAsYT0xKXtpZihzdXBlcigpLHQgaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXkpdGhpcy5fX2RhdGE9dDtlbHNlIGlmKHQgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcil7Y29uc29sZS53YXJuKCJkZXByZWNhdGVkLCBwbGVhc2UgdXNlIG5ldyBWZWM0KG5ldyBGbG9hdDMyQXJyYXkoYnVmZmVyLCBieXRlT2Zmc2V0LCA0KSkiKTtjb25zdCBzPXQsYT1lO3RoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkocyxhLDQpfWVsc2UgdGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheSg0KSwic3RyaW5nIj09dHlwZW9mIHQ/dC5zdGFydHNXaXRoKCIjIik/dGhpcy5zZXRGcm9tSGV4KHQpOnRoaXMuc2V0RnJvbUNTU0NvbG9yTmFtZSh0KToodGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lLHRoaXMuX19kYXRhWzJdPXMsdGhpcy5fX2RhdGFbM109YSl9Z2V0IHIoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMF19c2V0IHIodCl7dGhpcy5fX2RhdGFbMF09dH1nZXQgZygpe3JldHVybiB0aGlzLl9fZGF0YVsxXX1zZXQgZyh0KXt0aGlzLl9fZGF0YVsxXT10fWdldCBiKCl7cmV0dXJuIHRoaXMuX19kYXRhWzJdfXNldCBiKHQpe3RoaXMuX19kYXRhWzJdPXR9Z2V0IGEoKXtyZXR1cm4gdGhpcy5fX2RhdGFbM119c2V0IGEodCl7dGhpcy5fX2RhdGFbM109dH1zZXQodCxlLHMsYT0xKXt0aGlzLnI9dCx0aGlzLmc9ZSx0aGlzLmI9cyx0aGlzLmE9YX1zZXRGcm9tT3RoZXIodCl7dGhpcy5yPXQucix0aGlzLmc9dC5nLHRoaXMuYj10LmIsdGhpcy5hPXQuYX1zZXRGcm9tSGV4KHQpe2NvbnN0IGU9ZnVuY3Rpb24odCl7Y29uc3QgZT0vXiM/KFthLWZcZF17Mn0pKFthLWZcZF17Mn0pKFthLWZcZF17Mn0pJC9pLmV4ZWModCk7cmV0dXJuIGU/e3I6cGFyc2VJbnQoZVsxXSwxNiksZzpwYXJzZUludChlWzJdLDE2KSxiOnBhcnNlSW50KGVbM10sMTYpfTpudWxsfSh0KTtlP3RoaXMuc2V0KGUuci8yNTUsZS5nLzI1NSxlLmIvMjU1KTpjb25zb2xlLndhcm4oIkludmFsaWQgaGV4IGNvZGU6Iit0KX1zZXRGcm9tQ1NTQ29sb3JOYW1lKHQpe3Quc3RhcnRzV2l0aCgiIyIpP3RoaXMuc2V0RnJvbUhleCh0KTp0aGlzLnNldEZyb21IZXgoKHQ9Pntjb25zdCBlPXthbGljZWJsdWU6IiNmMGY4ZmYiLGFudGlxdWV3aGl0ZToiI2ZhZWJkNyIsYXF1YToiIzAwZmZmZiIsYXF1YW1hcmluZToiIzdmZmZkNCIsYXp1cmU6IiNmMGZmZmYiLGJlaWdlOiIjZjVmNWRjIixiaXNxdWU6IiNmZmU0YzQiLGJsYWNrOiIjMDAwMDAwIixibGFuY2hlZGFsbW9uZDoiI2ZmZWJjZCIsYmx1ZToiIzAwMDBmZiIsYmx1ZXZpb2xldDoiIzhhMmJlMiIsYnJvd246IiNhNTJhMmEiLGJ1cmx5d29vZDoiI2RlYjg4NyIsY2FkZXRibHVlOiIjNWY5ZWEwIixjaGFydHJldXNlOiIjN2ZmZjAwIixjaG9jb2xhdGU6IiNkMjY5MWUiLGNvcmFsOiIjZmY3ZjUwIixjb3JuZmxvd2VyYmx1ZToiIzY0OTVlZCIsY29ybnNpbGs6IiNmZmY4ZGMiLGNyaW1zb246IiNkYzE0M2MiLGN5YW46IiMwMGZmZmYiLGRhcmtibHVlOiIjMDAwMDhiIixkYXJrY3lhbjoiIzAwOGI4YiIsZGFya2dvbGRlbnJvZDoiI2I4ODYwYiIsZGFya2dyYXk6IiNhOWE5YTkiLGRhcmtncmVlbjoiIzAwNjQwMCIsZGFya2toYWtpOiIjYmRiNzZiIixkYXJrbWFnZW50YToiIzhiMDA4YiIsZGFya29saXZlZ3JlZW46IiM1NTZiMmYiLGRhcmtvcmFuZ2U6IiNmZjhjMDAiLGRhcmtvcmNoaWQ6IiM5OTMyY2MiLGRhcmtyZWQ6IiM4YjAwMDAiLGRhcmtzYWxtb246IiNlOTk2N2EiLGRhcmtzZWFncmVlbjoiIzhmYmM4ZiIsZGFya3NsYXRlYmx1ZToiIzQ4M2Q4YiIsZGFya3NsYXRlZ3JheToiIzJmNGY0ZiIsZGFya3R1cnF1b2lzZToiIzAwY2VkMSIsZGFya3Zpb2xldDoiIzk0MDBkMyIsZGVlcHBpbms6IiNmZjE0OTMiLGRlZXBza3libHVlOiIjMDBiZmZmIixkaW1ncmF5OiIjNjk2OTY5Iixkb2RnZXJibHVlOiIjMWU5MGZmIixmaXJlYnJpY2s6IiNiMjIyMjIiLGZsb3JhbHdoaXRlOiIjZmZmYWYwIixmb3Jlc3RncmVlbjoiIzIyOGIyMiIsZnVjaHNpYToiI2ZmMDBmZiIsZ2FpbnNib3JvOiIjZGNkY2RjIixnaG9zdHdoaXRlOiIjZjhmOGZmIixnb2xkOiIjZmZkNzAwIixnb2xkZW5yb2Q6IiNkYWE1MjAiLGdyYXk6IiM4MDgwODAiLGdyZWVuOiIjMDA4MDAwIixncmVlbnllbGxvdzoiI2FkZmYyZiIsaG9uZXlkZXc6IiNmMGZmZjAiLGhvdHBpbms6IiNmZjY5YjQiLCJpbmRpYW5yZWQgIjoiI2NkNWM1YyIsaW5kaWdvOiIjNGIwMDgyIixpdm9yeToiI2ZmZmZmMCIsa2hha2k6IiNmMGU2OGMiLGxhdmVuZGVyOiIjZTZlNmZhIixsYXZlbmRlcmJsdXNoOiIjZmZmMGY1IixsYXduZ3JlZW46IiM3Y2ZjMDAiLGxlbW9uY2hpZmZvbjoiI2ZmZmFjZCIsbGlnaHRibHVlOiIjYWRkOGU2IixsaWdodGNvcmFsOiIjZjA4MDgwIixsaWdodGN5YW46IiNlMGZmZmYiLGxpZ2h0Z29sZGVucm9keWVsbG93OiIjZmFmYWQyIixsaWdodGdyZXk6IiNkM2QzZDMiLGxpZ2h0Z3JlZW46IiM5MGVlOTAiLGxpZ2h0cGluazoiI2ZmYjZjMSIsbGlnaHRzYWxtb246IiNmZmEwN2EiLGxpZ2h0c2VhZ3JlZW46IiMyMGIyYWEiLGxpZ2h0c2t5Ymx1ZToiIzg3Y2VmYSIsbGlnaHRzbGF0ZWdyYXk6IiM3Nzg4OTkiLGxpZ2h0c3RlZWxibHVlOiIjYjBjNGRlIixsaWdodHllbGxvdzoiI2ZmZmZlMCIsbGltZToiIzAwZmYwMCIsbGltZWdyZWVuOiIjMzJjZDMyIixsaW5lbjoiI2ZhZjBlNiIsbWFnZW50YToiI2ZmMDBmZiIsbWFyb29uOiIjODAwMDAwIixtZWRpdW1hcXVhbWFyaW5lOiIjNjZjZGFhIixtZWRpdW1ibHVlOiIjMDAwMGNkIixtZWRpdW1vcmNoaWQ6IiNiYTU1ZDMiLG1lZGl1bXB1cnBsZToiIzkzNzBkOCIsbWVkaXVtc2VhZ3JlZW46IiMzY2IzNzEiLG1lZGl1bXNsYXRlYmx1ZToiIzdiNjhlZSIsbWVkaXVtc3ByaW5nZ3JlZW46IiMwMGZhOWEiLG1lZGl1bXR1cnF1b2lzZToiIzQ4ZDFjYyIsbWVkaXVtdmlvbGV0cmVkOiIjYzcxNTg1IixtaWRuaWdodGJsdWU6IiMxOTE5NzAiLG1pbnRjcmVhbToiI2Y1ZmZmYSIsbWlzdHlyb3NlOiIjZmZlNGUxIixtb2NjYXNpbjoiI2ZmZTRiNSIsbmF2YWpvd2hpdGU6IiNmZmRlYWQiLG5hdnk6IiMwMDAwODAiLG9sZGxhY2U6IiNmZGY1ZTYiLG9saXZlOiIjODA4MDAwIixvbGl2ZWRyYWI6IiM2YjhlMjMiLG9yYW5nZToiI2ZmYTUwMCIsb3JhbmdlcmVkOiIjZmY0NTAwIixvcmNoaWQ6IiNkYTcwZDYiLHBhbGVnb2xkZW5yb2Q6IiNlZWU4YWEiLHBhbGVncmVlbjoiIzk4ZmI5OCIscGFsZXR1cnF1b2lzZToiI2FmZWVlZSIscGFsZXZpb2xldHJlZDoiI2Q4NzA5MyIscGFwYXlhd2hpcDoiI2ZmZWZkNSIscGVhY2hwdWZmOiIjZmZkYWI5IixwZXJ1OiIjY2Q4NTNmIixwaW5rOiIjZmZjMGNiIixwbHVtOiIjZGRhMGRkIixwb3dkZXJibHVlOiIjYjBlMGU2IixwdXJwbGU6IiM4MDAwODAiLHJlYmVjY2FwdXJwbGU6IiM2NjMzOTkiLHJlZDoiI2ZmMDAwMCIscm9zeWJyb3duOiIjYmM4ZjhmIixyb3lhbGJsdWU6IiM0MTY5ZTEiLHNhZGRsZWJyb3duOiIjOGI0NTEzIixzYWxtb246IiNmYTgwNzIiLHNhbmR5YnJvd246IiNmNGE0NjAiLHNlYWdyZWVuOiIjMmU4YjU3IixzZWFzaGVsbDoiI2ZmZjVlZSIsc2llbm5hOiIjYTA1MjJkIixzaWx2ZXI6IiNjMGMwYzAiLHNreWJsdWU6IiM4N2NlZWIiLHNsYXRlYmx1ZToiIzZhNWFjZCIsc2xhdGVncmF5OiIjNzA4MDkwIixzbm93OiIjZmZmYWZhIixzcHJpbmdncmVlbjoiIzAwZmY3ZiIsc3RlZWxibHVlOiIjNDY4MmI0Iix0YW46IiNkMmI0OGMiLHRlYWw6IiMwMDgwODAiLHRoaXN0bGU6IiNkOGJmZDgiLHRvbWF0bzoiI2ZmNjM0NyIsdHVycXVvaXNlOiIjNDBlMGQwIix2aW9sZXQ6IiNlZTgyZWUiLHdoZWF0OiIjZjVkZWIzIix3aGl0ZToiI2ZmZmZmZiIsd2hpdGVzbW9rZToiI2Y1ZjVmNSIseWVsbG93OiIjZmZmZjAwIix5ZWxsb3dncmVlbjoiIzlhY2QzMiJ9O3JldHVybiB2b2lkIDAhPT1lW3QudG9Mb3dlckNhc2UoKV0mJmVbdC50b0xvd2VyQ2FzZSgpXX0pKHQpKX10b0hleCgpe2NvbnN0IHQ9dD0+e2NvbnN0IGU9TWF0aC5yb3VuZCgyNTUqdCkudG9TdHJpbmcoMTYpO3JldHVybiAxPT1lLmxlbmd0aD8iMCIrZTplfTtyZXR1cm5gIyR7dCh0aGlzLnIpfSR7dCh0aGlzLmcpfSR7dCh0aGlzLmIpfWB9ZXF1YWwodCl7cmV0dXJuIGNvbnNvbGUud2FybigiRGVwcmVjYXRlZC4gVXNlICNpc0VxdWFsIGluc3RlYWQuIiksdGhpcy5pc0VxdWFsKHQpfWlzRXF1YWwodCl7cmV0dXJuIHRoaXMucj09dC5yJiZ0aGlzLmc9PXQuZyYmdGhpcy5iPT10LmImJnRoaXMuYT09dC5hfW5vdEVxdWFscyh0KXtyZXR1cm4gdGhpcy5yIT10LnImJnRoaXMuZyE9dC5nJiZ0aGlzLmIhPXQuYiYmdGhpcy5hIT10LmF9YXBwcm94RXF1YWwodCxlPU51bWJlci5FUFNJTE9OKXtyZXR1cm4gTWF0aC5hYnModGhpcy5yLXQucik8ZSYmTWF0aC5hYnModGhpcy5nLXQuZyk8ZSYmTWF0aC5hYnModGhpcy5iLXQuYik8ZSYmTWF0aC5hYnModGhpcy5hLXQuYSk8ZX1hZGQodCl7cmV0dXJuIG5ldyBmKHRoaXMucit0LnIsdGhpcy5nK3QuZyx0aGlzLmIrdC5iLHRoaXMuYSt0LmEpfWFkZEluUGxhY2UodCl7dGhpcy5yKz10LnIsdGhpcy5nKz10LmcsdGhpcy5iKz10LmIsdGhpcy5hKz10LmF9c3VidHJhY3QodCl7cmV0dXJuIG5ldyBmKHRoaXMuci10LnIsdGhpcy5nLXQuZyx0aGlzLmItdC5iLHRoaXMuYS10LmEpfXNjYWxlKHQpe3JldHVybiBuZXcgZih0aGlzLnIqdCx0aGlzLmcqdCx0aGlzLmIqdCx0aGlzLmEqdCl9c2NhbGVJblBsYWNlKHQpe3RoaXMucio9dCx0aGlzLmcqPXQsdGhpcy5iKj10LHRoaXMuYSo9dH1hcHBseUdhbW1hKHQpe3RoaXMuc2V0KE1hdGgucG93KHRoaXMucix0KSxNYXRoLnBvdyh0aGlzLmcsdCksTWF0aC5wb3codGhpcy5iLHQpLHRoaXMuYSl9dG9MaW5lYXIodD0yLjIpe3JldHVybiBuZXcgZihNYXRoLnBvdyh0aGlzLnIsdCksTWF0aC5wb3codGhpcy5nLHQpLE1hdGgucG93KHRoaXMuYix0KSx0aGlzLmEpfXRvR2FtbWEodD0yLjIpe3JldHVybiBuZXcgZihNYXRoLnBvdyh0aGlzLnIsMS90KSxNYXRoLnBvdyh0aGlzLmcsMS90KSxNYXRoLnBvdyh0aGlzLmIsMS90KSx0aGlzLmEpfWx1bWluYW5jZSgpe3JldHVybi4yMTI2KnRoaXMucisuNzE1Mip0aGlzLmcrLjA3MjIqdGhpcy5ifWxlcnAodCxlKXtjb25zdCBzPXRoaXMucixhPXRoaXMuZyxpPXRoaXMuYixyPXRoaXMuYTtyZXR1cm4gbmV3IGYocytlKih0LnItcyksYStlKih0LmctYSksaStlKih0LmItaSkscitlKih0LmEtcikpfXN0YXRpYyByYW5kb20odD0wLGU9ITEpe3JldHVybiB0PjA/bmV3IGYodCtNYXRoLnJhbmRvbSgpKigxLXQpLHQrTWF0aC5yYW5kb20oKSooMS10KSx0K01hdGgucmFuZG9tKCkqKDEtdCksZT90K01hdGgucmFuZG9tKCkqKDEtdCk6MSk6dDwwP25ldyBmKE1hdGgucmFuZG9tKCkqKDErdCksTWF0aC5yYW5kb20oKSooMSt0KSxNYXRoLnJhbmRvbSgpKigxK3QpLGU/TWF0aC5yYW5kb20oKSooMSt0KToxKTpuZXcgZihNYXRoLnJhbmRvbSgpLE1hdGgucmFuZG9tKCksTWF0aC5yYW5kb20oKSxlP01hdGgucmFuZG9tKCk6MSl9Y2xvbmUoKXtyZXR1cm4gbmV3IGYodGhpcy5fX2RhdGFbMF0sdGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbMl0sdGhpcy5fX2RhdGFbM10pfWFzQXJyYXkoKXtyZXR1cm4gdGhpcy5fX2RhdGF9c3RhdGljIGNyZWF0ZSguLi50KXtyZXR1cm4gbmV3IGYoLi4udCl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZT0wKXtyZXR1cm4gY29uc29sZS53YXJuKCJEZXByZWNhdGVkLCB1c2UgI2NyZWF0ZUZyb21CdWZmZXIgaW5zdGVhZCIpLHRoaXMuY3JlYXRlRnJvbUJ1ZmZlcih0LDQqZSl9c3RhdGljIGNyZWF0ZUZyb21CdWZmZXIodCxlKXtyZXR1cm4gbmV3IGYobmV3IEZsb2F0MzJBcnJheSh0LGUsNCkpfXN0YXRpYyBudW1FbGVtZW50cygpe3JldHVybiA0fXRvSlNPTigpe3JldHVybntyOnRoaXMucixnOnRoaXMuZyxiOnRoaXMuYixhOnRoaXMuYX19ZnJvbUpTT04odCl7dGhpcy5yPXQucix0aGlzLmc9dC5nLHRoaXMuYj10LmIsdGhpcy5hPXQuYX1yZWFkQmluYXJ5KHQpe3RoaXMucj10LmxvYWRGbG9hdDMyKCksdGhpcy5nPXQubG9hZEZsb2F0MzIoKSx0aGlzLmI9dC5sb2FkRmxvYXQzMigpLHRoaXMuYT10LmxvYWRGbG9hdDMyKCl9fW4oIkNvbG9yIixmKTtjbGFzcyBtIGV4dGVuZHMgZXtjb25zdHJ1Y3Rvcih0PTAsZT0wLHM9MCxhPTApe2lmKHN1cGVyKCksaXNOYU4oYSkpc3dpdGNoKGEpe2Nhc2UiWFlaIjp0aGlzLm9yZGVyPTA7YnJlYWs7Y2FzZSJZWlgiOnRoaXMub3JkZXI9MTticmVhaztjYXNlIlpYWSI6dGhpcy5vcmRlcj0yO2JyZWFrO2Nhc2UiWFpZIjp0aGlzLm9yZGVyPTM7YnJlYWs7Y2FzZSJaWVgiOnRoaXMub3JkZXI9NDticmVhaztjYXNlIllYWiI6dGhpcy5vcmRlcj01O2JyZWFrO2RlZmF1bHQ6dGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIEV1bGVyIEFuZ2xlcyBPcmRlcjoiK2EpfWVsc2UgdGhpcy5vcmRlcj1hO2lmKHQgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcil7Y29uc3Qgcz10LGE9ZTt0aGlzLl9fZGF0YT1uZXcgRmxvYXQzMkFycmF5KHMsYSw0KX1lbHNlIHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoMyksdGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lLHRoaXMuX19kYXRhWzJdPXN9Z2V0IHgoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMF19c2V0IHgodCl7dGhpcy5fX2RhdGFbMF09dH1nZXQgeSgpe3JldHVybiB0aGlzLl9fZGF0YVsxXX1zZXQgeSh0KXt0aGlzLl9fZGF0YVsxXT10fWdldCB6KCl7cmV0dXJuIHRoaXMuX19kYXRhWzJdfXNldCB6KHQpe3RoaXMuX19kYXRhWzJdPXR9c2V0KHQsZSxzKXt0aGlzLl9fZGF0YVswXT10LHRoaXMuX19kYXRhWzFdPWUsdGhpcy5fX2RhdGFbMl09c319bigiRXVsZXJBbmdsZXMiLG0pO2NsYXNzIGcgZXh0ZW5kcyBle2NvbnN0cnVjdG9yKHQ9MSxlPTAscz0wLGE9MCxpPTEscj0wLG49MCxoPTAsbz0xKXtpZihzdXBlcigpLHQgaW5zdGFuY2VvZiBsJiZlIGluc3RhbmNlb2YgbCYmcyBpbnN0YW5jZW9mIGwpdGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheSg5KSx0aGlzLnNldCh0LngsdC55LHQueixlLngsZS55LGUueixzLngscy55LHMueik7ZWxzZSBpZih0IGluc3RhbmNlb2YgRmxvYXQzMkFycmF5fHx0IGluc3RhbmNlb2YgVWludDMyQXJyYXkpdGhpcy5fX2RhdGE9dDtlbHNlIGlmKHQgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcil7Y29uc29sZS53YXJuKCJEZXByZWNhdGVkLCBwbGVhc2UgdXNlIG5ldyBWZWMzKG5ldyBGbG9hdDMyQXJyYXkoYnVmZmVyLCBieXRlT2Zmc2V0LCA5KSkiKTtjb25zdCBzPXQsYT1lO3RoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkocyxhLDkpfWVsc2UgdGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheSg5KSx0aGlzLnNldCh0LGUscyxhLGkscixuLGgsbyl9Z2V0IG0wMCgpe3JldHVybiB0aGlzLl9fZGF0YVswXX1zZXQgbTAwKHQpe3RoaXMuX19kYXRhWzBdPXR9Z2V0IG0wMSgpe3JldHVybiB0aGlzLl9fZGF0YVsxXX1zZXQgbTAxKHQpe3RoaXMuX19kYXRhWzFdPXR9Z2V0IG0wMigpe3JldHVybiB0aGlzLl9fZGF0YVsyXX1zZXQgbTAyKHQpe3RoaXMuX19kYXRhWzJdPXR9Z2V0IG0xMCgpe3JldHVybiB0aGlzLl9fZGF0YVszXX1zZXQgbTEwKHQpe3RoaXMuX19kYXRhWzNdPXR9Z2V0IG0xMSgpe3JldHVybiB0aGlzLl9fZGF0YVs0XX1zZXQgbTExKHQpe3RoaXMuX19kYXRhWzRdPXR9Z2V0IG0xMigpe3JldHVybiB0aGlzLl9fZGF0YVs1XX1zZXQgbTEyKHQpe3RoaXMuX19kYXRhWzVdPXR9Z2V0IG0yMCgpe3JldHVybiB0aGlzLl9fZGF0YVs2XX1zZXQgbTIwKHQpe3RoaXMuX19kYXRhWzZdPXR9Z2V0IG0yMSgpe3JldHVybiB0aGlzLl9fZGF0YVs3XX1zZXQgbTIxKHQpe3RoaXMuX19kYXRhWzddPXR9Z2V0IG0yMigpe3JldHVybiB0aGlzLl9fZGF0YVs4XX1zZXQgbTIyKHQpe3RoaXMuX19kYXRhWzhdPXR9Z2V0IHhBeGlzKCl7cmV0dXJuIGwuY3JlYXRlRnJvbUJ1ZmZlcih0aGlzLl9fZGF0YS5idWZmZXIsMCl9c2V0IHhBeGlzKHQpe3RoaXMueEF4aXMuc2V0KHQueCx0LnksdC56KX1nZXQgeUF4aXMoKXtyZXR1cm4gbC5jcmVhdGVGcm9tQnVmZmVyKHRoaXMuX19kYXRhLmJ1ZmZlciwxMil9c2V0IHlBeGlzKHQpe3RoaXMueUF4aXMuc2V0KHQueCx0LnksdC56KX1nZXQgekF4aXMoKXtyZXR1cm4gbC5jcmVhdGVGcm9tQnVmZmVyKHRoaXMuX19kYXRhLmJ1ZmZlciwyNCl9c2V0IHpBeGlzKHQpe3RoaXMuekF4aXMuc2V0KHQueCx0LnksdC56KX1zZXQodD0xLGU9MCxzPTAsYT0wLGk9MSxyPTAsbj0wLGg9MCxvPTEpe3RoaXMuX19kYXRhWzBdPXQsdGhpcy5fX2RhdGFbMV09ZSx0aGlzLl9fZGF0YVsyXT1zLHRoaXMuX19kYXRhWzNdPWEsdGhpcy5fX2RhdGFbNF09aSx0aGlzLl9fZGF0YVs1XT1yLHRoaXMuX19kYXRhWzZdPW4sdGhpcy5fX2RhdGFbN109aCx0aGlzLl9fZGF0YVs4XT1vfXNldElkZW50aXR5KCl7dGhpcy5zZXQoKX1zZXRGcm9tTWF0KHQpe3RoaXMuX19kYXRhWzBdPXQubTAwLHRoaXMuX19kYXRhWzFdPXQubTAxLHRoaXMuX19kYXRhWzJdPXQubTAyLHRoaXMuX19kYXRhWzNdPXQubTEwLHRoaXMuX19kYXRhWzRdPXQubTExLHRoaXMuX19kYXRhWzVdPXQubTEyLHRoaXMuX19kYXRhWzZdPXQubTIwLHRoaXMuX19kYXRhWzddPXQubTIxLHRoaXMuX19kYXRhWzhdPXQubTIyfXNldEZyb21EaXJlY3Rpb25BbmRVcHZlY3Rvcih0LGUpe2NvbnN0IHM9dCxhPXMubGVuZ3RoKCk7aWYoYTxOdW1iZXIuRVBTSUxPTilyZXR1cm4gdm9pZCB0aGlzLnNldElkZW50aXR5KCk7cy5zY2FsZUluUGxhY2UoMS9hKTtjb25zdCBpPWUuY3Jvc3Mocykscj1pLmxlbmd0aCgpO3I+TnVtYmVyLkVQU0lMT04mJmkuc2NhbGVJblBsYWNlKDEvcik7Y29uc3Qgbj1zLmNyb3NzKGkpLGg9bi5sZW5ndGgoKTtoPk51bWJlci5FUFNJTE9OJiZuLnNjYWxlSW5QbGFjZSgxL2gpLHRoaXMuc2V0KGkueCxpLnksaS56LG4ueCxuLnksbi56LHMueCxzLnkscy56KX1pbnZlcnNlKCl7Y29uc3QgdD10aGlzLl9fZGF0YVswXSxlPXRoaXMuX19kYXRhWzFdLHM9dGhpcy5fX2RhdGFbMl0sYT10aGlzLl9fZGF0YVszXSxpPXRoaXMuX19kYXRhWzRdLHI9dGhpcy5fX2RhdGFbNV0sbj10aGlzLl9fZGF0YVs2XSxoPXRoaXMuX19kYXRhWzddLG89dGhpcy5fX2RhdGFbOF0sXz1vKmktcipoLGQ9LW8qYStyKm4sbD1oKmEtaSpuLGM9dCpfK2UqZCtzKmw7cmV0dXJuIGM/KGM9MS9jLG5ldyBnKF8qYywoLW8qZStzKmgpKmMsKHIqZS1zKmkpKmMsZCpjLChvKnQtcypuKSpjLCgtcip0K3MqYSkqYyxsKmMsKC1oKnQrZSpuKSpjLChpKnQtZSphKSpjKSk6KGNvbnNvbGUud2FybigiVW5hYmxlIHRvIGludmVydCBNYXQzIiksbnVsbCl9aW52ZXJ0SW5QbGFjZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM10saT10aGlzLl9fZGF0YVs0XSxyPXRoaXMuX19kYXRhWzVdLG49dGhpcy5fX2RhdGFbNl0saD10aGlzLl9fZGF0YVs3XSxvPXRoaXMuX19kYXRhWzhdLF89byppLXIqaCxkPS1vKmErcipuLGw9aCphLWkqbixjPXQqXytlKmQrcypsO3JldHVybiBjPyhjPTEvYyx0aGlzLnNldChfKmMsKC1vKmUrcypoKSpjLChyKmUtcyppKSpjLGQqYywobyp0LXMqbikqYywoLXIqdCtzKmEpKmMsbCpjLCgtaCp0K2UqbikqYywoaSp0LWUqYSkqYyksITApOihjb25zb2xlLndhcm4oIlVuYWJsZSB0byBpbnZlcnQgTWF0MyIpLCExKX10cmFuc3Bvc2UoKXtyZXR1cm4gZyh0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVszXSx0aGlzLl9fZGF0YVs2XSx0aGlzLl9fZGF0YVsxXSx0aGlzLl9fZGF0YVs0XSx0aGlzLl9fZGF0YVs3XSx0aGlzLl9fZGF0YVsyXSx0aGlzLl9fZGF0YVs1XSx0aGlzLl9fZGF0YVs4XSl9dHJhbnNwb3NlSW5QbGFjZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMV0sZT10aGlzLl9fZGF0YVsyXSxzPXRoaXMuX19kYXRhWzVdO3RoaXMuX19kYXRhWzFdPXRoaXMuX19kYXRhWzNdLHRoaXMuX19kYXRhWzJdPXRoaXMuX19kYXRhWzZdLHRoaXMuX19kYXRhWzNdPXQsdGhpcy5fX2RhdGFbNV09dGhpcy5fX2RhdGFbN10sdGhpcy5fX2RhdGFbNl09ZSx0aGlzLl9fZGF0YVs3XT1zfXRyYW5zZm9ybVZlYzModCl7cmV0dXJuIG5ldyBsKHRoaXMuX19kYXRhWzBdKnQueCt0aGlzLl9fZGF0YVsxXSp0LnkrdGhpcy5fX2RhdGFbMl0qdC56LHRoaXMuX19kYXRhWzNdKnQueCt0aGlzLl9fZGF0YVs0XSp0LnkrdGhpcy5fX2RhdGFbNV0qdC56LHRoaXMuX19kYXRhWzZdKnQueCt0aGlzLl9fZGF0YVs3XSp0LnkrdGhpcy5fX2RhdGFbOF0qdC56KX1jbG9uZSgpe3JldHVybiBuZXcgZyh0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVsxXSx0aGlzLl9fZGF0YVsyXSx0aGlzLl9fZGF0YVszXSx0aGlzLl9fZGF0YVs0XSx0aGlzLl9fZGF0YVs1XSx0aGlzLl9fZGF0YVs2XSx0aGlzLl9fZGF0YVs3XSx0aGlzLl9fZGF0YVs4XSx0aGlzLl9fZGF0YVs5XSl9c3RhdGljIGNyZWF0ZSguLi50KXtyZXR1cm4gbmV3IGcoLi4udCl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZT0wKXtyZXR1cm4gY29uc29sZS53YXJuKCJEZXByZWNhdGVkLCB1c2UgI2NyZWF0ZUZyb21CdWZmZXIgaW5zdGVhZCIpLHRoaXMuY3JlYXRlRnJvbUJ1ZmZlcih0LDQqZSl9c3RhdGljIGNyZWF0ZUZyb21CdWZmZXIodCxlKXtyZXR1cm4gbmV3IGcobmV3IEZsb2F0MzJBcnJheSh0LGUsOSkpfXJlYWRCaW5hcnkodCl7dGhpcy5fX2RhdGE9dC5sb2FkRmxvYXQzMkFycmF5KDkpfXRvSlNPTigpe3JldHVybiB0aGlzLl9fZGF0YX1mcm9tSlNPTih0KXt0aGlzLl9fZGF0YT1uZXcgRmxvYXQzMkFycmF5KHQpfXRvU3RyaW5nKCl7cmV0dXJuIHRoaXMudG9KU09OKCkudG9TdHJpbmcoKX19bigiTWF0MyIsZyk7Y2xhc3MgeSBleHRlbmRzIGV7Y29uc3RydWN0b3IodD0xLGU9MCxzPTAsYT0wLGk9MCxyPTEsbj0wLGg9MCxvPTAsXz0wLGQ9MSxsPTAsYz0wLHU9MCxmPTAsbT0xKXtpZihzdXBlcigpLHQgaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXkpdGhpcy5fX2RhdGE9dDtlbHNlIGlmKHQgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcil7Y29uc3Qgcz10LGE9ZTt0aGlzLl9fZGF0YT1uZXcgRmxvYXQzMkFycmF5KHMsYSwxNil9ZWxzZSB0aGlzLl9fZGF0YT1uZXcgRmxvYXQzMkFycmF5KDE2KSx0aGlzLnNldCh0LGUscyxhLGkscixuLGgsbyxfLGQsbCxjLHUsZixtKX1nZXQgbTAwKCl7cmV0dXJuIHRoaXMuX19kYXRhWzBdfXNldCBtMDAodCl7dGhpcy5fX2RhdGFbMF09dH1nZXQgbTAxKCl7cmV0dXJuIHRoaXMuX19kYXRhWzFdfXNldCBtMDEodCl7dGhpcy5fX2RhdGFbMV09dH1nZXQgbTAyKCl7cmV0dXJuIHRoaXMuX19kYXRhWzJdfXNldCBtMDIodCl7dGhpcy5fX2RhdGFbMl09dH1nZXQgbTAzKCl7cmV0dXJuIHRoaXMuX19kYXRhWzNdfXNldCBtMDModCl7dGhpcy5fX2RhdGFbM109dH1nZXQgbTEwKCl7cmV0dXJuIHRoaXMuX19kYXRhWzRdfXNldCBtMTAodCl7dGhpcy5fX2RhdGFbNF09dH1nZXQgbTExKCl7cmV0dXJuIHRoaXMuX19kYXRhWzVdfXNldCBtMTEodCl7dGhpcy5fX2RhdGFbNV09dH1nZXQgbTEyKCl7cmV0dXJuIHRoaXMuX19kYXRhWzZdfXNldCBtMTIodCl7dGhpcy5fX2RhdGFbNl09dH1nZXQgbTEzKCl7cmV0dXJuIHRoaXMuX19kYXRhWzddfXNldCBtMTModCl7dGhpcy5fX2RhdGFbN109dH1nZXQgbTIwKCl7cmV0dXJuIHRoaXMuX19kYXRhWzhdfXNldCBtMjAodCl7dGhpcy5fX2RhdGFbOF09dH1nZXQgbTIxKCl7cmV0dXJuIHRoaXMuX19kYXRhWzldfXNldCBtMjEodCl7dGhpcy5fX2RhdGFbOV09dH1nZXQgbTIyKCl7cmV0dXJuIHRoaXMuX19kYXRhWzEwXX1zZXQgbTIyKHQpe3RoaXMuX19kYXRhWzEwXT10fWdldCBtMjMoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMTFdfXNldCBtMjModCl7dGhpcy5fX2RhdGFbMTFdPXR9Z2V0IG0zMCgpe3JldHVybiB0aGlzLl9fZGF0YVsxMl19c2V0IG0zMCh0KXt0aGlzLl9fZGF0YVsxMl09dH1nZXQgbTMxKCl7cmV0dXJuIHRoaXMuX19kYXRhWzEzXX1zZXQgbTMxKHQpe3RoaXMuX19kYXRhWzEzXT10fWdldCBtMzIoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMTRdfXNldCBtMzIodCl7dGhpcy5fX2RhdGFbMTRdPXR9Z2V0IG0zMygpe3JldHVybiB0aGlzLl9fZGF0YVsxNV19c2V0IG0zMyh0KXt0aGlzLl9fZGF0YVsxNV09dH1nZXQgeEF4aXMoKXtyZXR1cm4gbC5jcmVhdGVGcm9tQnVmZmVyKHRoaXMuX19kYXRhLmJ1ZmZlciwwKX1zZXQgeEF4aXModCl7dGhpcy54QXhpcy5zZXQodC54LHQueSx0LnopfWdldCB5QXhpcygpe3JldHVybiBsLmNyZWF0ZUZyb21CdWZmZXIodGhpcy5fX2RhdGEuYnVmZmVyLDE2KX1zZXQgeUF4aXModCl7dGhpcy55QXhpcy5zZXQodC54LHQueSx0LnopfWdldCB6QXhpcygpe3JldHVybiBsLmNyZWF0ZUZyb21CdWZmZXIodGhpcy5fX2RhdGEuYnVmZmVyLDMyKX1zZXQgekF4aXModCl7dGhpcy56QXhpcy5zZXQodC54LHQueSx0LnopfWdldCB0cmFuc2xhdGlvbigpe3JldHVybiBsLmNyZWF0ZUZyb21CdWZmZXIodGhpcy5fX2RhdGEuYnVmZmVyLDQ4KX1zZXQgdHJhbnNsYXRpb24odCl7dGhpcy50cmFuc2xhdGlvbi5zZXQodC54LHQueSx0LnopfXNldCh0PTEsZT0wLHM9MCxhPTAsaT0wLHI9MSxuPTAsaD0wLG89MCxfPTAsZD0xLGw9MCxjPTAsdT0wLGY9MCxtPTEpe3RoaXMuX19kYXRhWzBdPXQsdGhpcy5fX2RhdGFbMV09ZSx0aGlzLl9fZGF0YVsyXT1zLHRoaXMuX19kYXRhWzNdPWEsdGhpcy5fX2RhdGFbNF09aSx0aGlzLl9fZGF0YVs1XT1yLHRoaXMuX19kYXRhWzZdPW4sdGhpcy5fX2RhdGFbN109aCx0aGlzLl9fZGF0YVs4XT1vLHRoaXMuX19kYXRhWzldPV8sdGhpcy5fX2RhdGFbMTBdPWQsdGhpcy5fX2RhdGFbMTFdPWwsdGhpcy5fX2RhdGFbMTJdPWMsdGhpcy5fX2RhdGFbMTNdPXUsdGhpcy5fX2RhdGFbMTRdPWYsdGhpcy5fX2RhdGFbMTVdPW19c2V0SWRlbnRpdHkoKXt0aGlzLnNldCgpfXNldERhdGFBcnJheSh0KXt0aGlzLl9fZGF0YT10fXNldEZyb21NYXQ0KHQpe3RoaXMuX19kYXRhWzBdPXQubTAwLHRoaXMuX19kYXRhWzFdPXQubTAxLHRoaXMuX19kYXRhWzJdPXQubTAyLHRoaXMuX19kYXRhWzNdPXQubTAzLHRoaXMuX19kYXRhWzRdPXQubTEwLHRoaXMuX19kYXRhWzVdPXQubTExLHRoaXMuX19kYXRhWzZdPXQubTEyLHRoaXMuX19kYXRhWzddPXQubTEzLHRoaXMuX19kYXRhWzhdPXQubTIwLHRoaXMuX19kYXRhWzldPXQubTIxLHRoaXMuX19kYXRhWzEwXT10Lm0yMix0aGlzLl9fZGF0YVsxMV09dC5tMjMsdGhpcy5fX2RhdGFbMTJdPXQubTMwLHRoaXMuX19kYXRhWzEzXT10Lm0zMSx0aGlzLl9fZGF0YVsxNF09dC5tMzIsdGhpcy5fX2RhdGFbMTVdPXQubTMzfXRvTWF0Mygpe3JldHVybiBuZXcgZyh0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVsxXSx0aGlzLl9fZGF0YVsyXSx0aGlzLl9fZGF0YVs0XSx0aGlzLl9fZGF0YVs1XSx0aGlzLl9fZGF0YVs2XSx0aGlzLl9fZGF0YVs4XSx0aGlzLl9fZGF0YVs5XSx0aGlzLl9fZGF0YVsxMF0pfXRyYW5zcG9zZUluUGxhY2UoKXtjb25zdCB0PXRoaXMuX19kYXRhWzFdLGU9dGhpcy5fX2RhdGFbMl0scz10aGlzLl9fZGF0YVszXSxhPXRoaXMuX19kYXRhWzZdLGk9dGhpcy5fX2RhdGFbN10scj10aGlzLl9fZGF0YVsxMV07dGhpcy5fX2RhdGFbMV09dGhpcy5fX2RhdGFbNF0sdGhpcy5fX2RhdGFbMl09dGhpcy5fX2RhdGFbOF0sdGhpcy5fX2RhdGFbM109dGhpcy5fX2RhdGFbMTJdLHRoaXMuX19kYXRhWzRdPXQsdGhpcy5fX2RhdGFbNl09dGhpcy5fX2RhdGFbOV0sdGhpcy5fX2RhdGFbN109dGhpcy5fX2RhdGFbMTNdLHRoaXMuX19kYXRhWzhdPWUsdGhpcy5fX2RhdGFbOV09YSx0aGlzLl9fZGF0YVsxMV09dGhpcy5fX2RhdGFbMTRdLHRoaXMuX19kYXRhWzEyXT1zLHRoaXMuX19kYXRhWzEzXT1pLHRoaXMuX19kYXRhWzE0XT1yfXRyYW5zcG9zZSgpe3JldHVybiBuZXcgeSh0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVs0XSx0aGlzLl9fZGF0YVs4XSx0aGlzLl9fZGF0YVsxMl0sdGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbNV0sdGhpcy5fX2RhdGFbOV0sdGhpcy5fX2RhdGFbMTNdLHRoaXMuX19kYXRhWzJdLHRoaXMuX19kYXRhWzZdLHRoaXMuX19kYXRhWzEwXSx0aGlzLl9fZGF0YVsxNF0sdGhpcy5fX2RhdGFbM10sdGhpcy5fX2RhdGFbN10sdGhpcy5fX2RhdGFbMTFdLHRoaXMuX19kYXRhWzE1XSl9aW52ZXJzZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM10saT10aGlzLl9fZGF0YVs0XSxyPXRoaXMuX19kYXRhWzVdLG49dGhpcy5fX2RhdGFbNl0saD10aGlzLl9fZGF0YVs3XSxvPXRoaXMuX19kYXRhWzhdLF89dGhpcy5fX2RhdGFbOV0sZD10aGlzLl9fZGF0YVsxMF0sbD10aGlzLl9fZGF0YVsxMV0sYz10aGlzLl9fZGF0YVsxMl0sdT10aGlzLl9fZGF0YVsxM10sZj10aGlzLl9fZGF0YVsxNF0sbT10aGlzLl9fZGF0YVsxNV0sZz10KnItZSppLHA9dCpuLXMqaSx4PXQqaC1hKmksYj1lKm4tcypyLHc9ZSpoLWEqcixJPXMqaC1hKm4sTj1vKnUtXypjLEY9bypmLWQqYyxWPW8qbS1sKmMsej1fKmYtZCp1LEE9XyptLWwqdSxNPWQqbS1sKmY7bGV0IEU9ZypNLXAqQSt4KnorYipWLXcqRitJKk47cmV0dXJuIEU/KEU9MS9FLG5ldyB5KChyKk0tbipBK2gqeikqRSwocypBLWUqTS1hKnopKkUsKHUqSS1mKncrbSpiKSpFLChkKnctXypJLWwqYikqRSwobipWLWkqTS1oKkYpKkUsKHQqTS1zKlYrYSpGKSpFLChmKngtYypJLW0qcCkqRSwobypJLWQqeCtsKnApKkUsKGkqQS1yKlYraCpOKSpFLChlKlYtdCpBLWEqTikqRSwoYyp3LXUqeCttKmcpKkUsKF8qeC1vKnctbCpnKSpFLChyKkYtaSp6LW4qTikqRSwodCp6LWUqRitzKk4pKkUsKHUqcC1jKmItZipnKSpFLChvKmItXypwK2QqZykqRSkpOihjb25zb2xlLndhcm4oIlVuYWJsZSB0byBpbnZlcnQgTWF0NCIpLG51bGwpfWludmVydEluUGxhY2UoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV0scz10aGlzLl9fZGF0YVsyXSxhPXRoaXMuX19kYXRhWzNdLGk9dGhpcy5fX2RhdGFbNF0scj10aGlzLl9fZGF0YVs1XSxuPXRoaXMuX19kYXRhWzZdLGg9dGhpcy5fX2RhdGFbN10sbz10aGlzLl9fZGF0YVs4XSxfPXRoaXMuX19kYXRhWzldLGQ9dGhpcy5fX2RhdGFbMTBdLGw9dGhpcy5fX2RhdGFbMTFdLGM9dGhpcy5fX2RhdGFbMTJdLHU9dGhpcy5fX2RhdGFbMTNdLGY9dGhpcy5fX2RhdGFbMTRdLG09dGhpcy5fX2RhdGFbMTVdLGc9dCpyLWUqaSx5PXQqbi1zKmkscD10KmgtYSppLHg9ZSpuLXMqcixiPWUqaC1hKnIsdz1zKmgtYSpuLEk9byp1LV8qYyxOPW8qZi1kKmMsRj1vKm0tbCpjLFY9XypmLWQqdSx6PV8qbS1sKnUsQT1kKm0tbCpmO2xldCBNPWcqQS15KnorcCpWK3gqRi1iKk4rdypJO3JldHVybiBNPyhNPTEvTSx0aGlzLnNldCgocipBLW4qeitoKlYpKk0sKHMqei1lKkEtYSpWKSpNLCh1KnctZipiK20qeCkqTSwoZCpiLV8qdy1sKngpKk0sKG4qRi1pKkEtaCpOKSpNLCh0KkEtcypGK2EqTikqTSwoZipwLWMqdy1tKnkpKk0sKG8qdy1kKnArbCp5KSpNLChpKnotcipGK2gqSSkqTSwoZSpGLXQqei1hKkkpKk0sKGMqYi11KnArbSpnKSpNLChfKnAtbypiLWwqZykqTSwocipOLWkqVi1uKkkpKk0sKHQqVi1lKk4rcypJKSpNLCh1KnktYyp4LWYqZykqTSwobyp4LV8qeStkKmcpKk0pLCEwKTooY29uc29sZS53YXJuKCJVbmFibGUgdG8gaW52ZXJ0IE1hdDQiKSwhMSl9bXVsdGlwbHkodCl7Y29uc3QgZT10aGlzLl9fZGF0YVswXSxzPXRoaXMuX19kYXRhWzFdLGE9dGhpcy5fX2RhdGFbMl0saT10aGlzLl9fZGF0YVszXSxyPXRoaXMuX19kYXRhWzRdLG49dGhpcy5fX2RhdGFbNV0saD10aGlzLl9fZGF0YVs2XSxvPXRoaXMuX19kYXRhWzddLF89dGhpcy5fX2RhdGFbOF0sZD10aGlzLl9fZGF0YVs5XSxsPXRoaXMuX19kYXRhWzEwXSxjPXRoaXMuX19kYXRhWzExXSx1PXRoaXMuX19kYXRhWzEyXSxmPXRoaXMuX19kYXRhWzEzXSxtPXRoaXMuX19kYXRhWzE0XSxnPXRoaXMuX19kYXRhWzE1XSxwPXQuYXNBcnJheSgpO2xldCB4PXBbMF0sYj1wWzFdLHc9cFsyXSxJPXBbM107Y29uc3QgTj1uZXcgeTtyZXR1cm4gTi5tMDA9eCplK2Iqcit3Kl8rSSp1LE4ubTAxPXgqcytiKm4rdypkK0kqZixOLm0wMj14KmErYipoK3cqbCtJKm0sTi5tMDM9eCppK2Iqbyt3KmMrSSpnLHg9cFs0XSxiPXBbNV0sdz1wWzZdLEk9cFs3XSxOLm0xMD14KmUrYipyK3cqXytJKnUsTi5tMTE9eCpzK2Iqbit3KmQrSSpmLE4ubTEyPXgqYStiKmgrdypsK0kqbSxOLm0xMz14KmkrYipvK3cqYytJKmcseD1wWzhdLGI9cFs5XSx3PXBbMTBdLEk9cFsxMV0sTi5tMjA9eCplK2Iqcit3Kl8rSSp1LE4ubTIxPXgqcytiKm4rdypkK0kqZixOLm0yMj14KmErYipoK3cqbCtJKm0sTi5tMjM9eCppK2Iqbyt3KmMrSSpnLHg9cFsxMl0sYj1wWzEzXSx3PXBbMTRdLEk9cFsxNV0sTi5tMzA9eCplK2Iqcit3Kl8rSSp1LE4ubTMxPXgqcytiKm4rdypkK0kqZixOLm0zMj14KmErYipoK3cqbCtJKm0sTi5tMzM9eCppK2Iqbyt3KmMrSSpnLE59bXVsdGlwbHlJblBsYWNlKHQpe2NvbnN0IGU9dGhpcy5hc0FycmF5KCkscz1lWzBdLGE9ZVsxXSxpPWVbMl0scj1lWzNdLG49ZVs0XSxoPWVbNV0sbz1lWzZdLF89ZVs3XSxkPWVbOF0sbD1lWzldLGM9ZVsxMF0sdT1lWzExXSxmPWVbMTJdLG09ZVsxM10sZz1lWzE0XSx5PWVbMTVdLHA9dC5hc0FycmF5KCk7bGV0IHg9cFswXSxiPXBbMV0sdz1wWzJdLEk9cFszXTtyZXR1cm4gdGhpcy5tMDA9eCpzK2Iqbit3KmQrSSpmLHRoaXMubTAxPXgqYStiKmgrdypsK0kqbSx0aGlzLm0wMj14KmkrYipvK3cqYytJKmcsdGhpcy5tMDM9eCpyK2IqXyt3KnUrSSp5LHg9cFs0XSxiPXBbNV0sdz1wWzZdLEk9cFs3XSx0aGlzLm0xMD14KnMrYipuK3cqZCtJKmYsdGhpcy5tMTE9eCphK2IqaCt3KmwrSSptLHRoaXMubTEyPXgqaStiKm8rdypjK0kqZyx0aGlzLm0xMz14KnIrYipfK3cqdStJKnkseD1wWzhdLGI9cFs5XSx3PXBbMTBdLEk9cFsxMV0sdGhpcy5tMjA9eCpzK2Iqbit3KmQrSSpmLHRoaXMubTIxPXgqYStiKmgrdypsK0kqbSx0aGlzLm0yMj14KmkrYipvK3cqYytJKmcsdGhpcy5tMjM9eCpyK2IqXyt3KnUrSSp5LHg9cFsxMl0sYj1wWzEzXSx3PXBbMTRdLEk9cFsxNV0sdGhpcy5tMzA9eCpzK2Iqbit3KmQrSSpmLHRoaXMubTMxPXgqYStiKmgrdypsK0kqbSx0aGlzLm0zMj14KmkrYipvK3cqYytJKmcsdGhpcy5tMzM9eCpyK2IqXyt3KnUrSSp5LHRoaXN9cG9zdE11bHRpcGx5SW5QbGFjZSh0KXtjb25zdCBlPXQuYXNBcnJheSgpLHM9ZVswXSxhPWVbMV0saT1lWzJdLHI9ZVszXSxuPWVbNF0saD1lWzVdLG89ZVs2XSxfPWVbN10sZD1lWzhdLGw9ZVs5XSxjPWVbMTBdLHU9ZVsxMV0sZj1lWzEyXSxtPWVbMTNdLGc9ZVsxNF0seT1lWzE1XSxwPXRoaXMuYXNBcnJheSgpO2xldCB4PXBbMF0sYj1wWzFdLHc9cFsyXSxJPXBbM107cmV0dXJuIHRoaXMubTAwPXgqcytiKm4rdypkK0kqZix0aGlzLm0wMT14KmErYipoK3cqbCtJKm0sdGhpcy5tMDI9eCppK2Iqbyt3KmMrSSpnLHRoaXMubTAzPXgqcitiKl8rdyp1K0kqeSx4PXBbNF0sYj1wWzVdLHc9cFs2XSxJPXBbN10sdGhpcy5tMTA9eCpzK2Iqbit3KmQrSSpmLHRoaXMubTExPXgqYStiKmgrdypsK0kqbSx0aGlzLm0xMj14KmkrYipvK3cqYytJKmcsdGhpcy5tMTM9eCpyK2IqXyt3KnUrSSp5LHg9cFs4XSxiPXBbOV0sdz1wWzEwXSxJPXBbMTFdLHRoaXMubTIwPXgqcytiKm4rdypkK0kqZix0aGlzLm0yMT14KmErYipoK3cqbCtJKm0sdGhpcy5tMjI9eCppK2Iqbyt3KmMrSSpnLHRoaXMubTIzPXgqcitiKl8rdyp1K0kqeSx4PXBbMTJdLGI9cFsxM10sdz1wWzE0XSxJPXBbMTVdLHRoaXMubTMwPXgqcytiKm4rdypkK0kqZix0aGlzLm0zMT14KmErYipoK3cqbCtJKm0sdGhpcy5tMzI9eCppK2Iqbyt3KmMrSSpnLHRoaXMubTMzPXgqcitiKl8rdyp1K0kqeSx0aGlzfXRyYW5zbGF0ZUluUGxhY2UodCl7Y29uc3QgZT10aGlzLl9fZGF0YSxzPXQueCxhPXQueSxpPXQuejtyZXR1cm4gZVsxMl09ZVswXSpzK2VbNF0qYStlWzhdKmkrZVsxMl0sZVsxM109ZVsxXSpzK2VbNV0qYStlWzldKmkrZVsxM10sZVsxNF09ZVsyXSpzK2VbNl0qYStlWzEwXSppK2VbMTRdLGVbMTVdPWVbM10qcytlWzddKmErZVsxMV0qaStlWzE1XSx0aGlzfXNldExvb2tBdCh0LGUscyl7Y29uc3QgYT10LnN1YnRyYWN0KGUpLGk9YS5sZW5ndGgoKTtpZihpPE51bWJlci5FUFNJTE9OKXJldHVybiB2b2lkIHRoaXMuc2V0SWRlbnRpdHkoKTthLnNjYWxlSW5QbGFjZSgxL2kpO2NvbnN0IHI9cy5jcm9zcyhhKSxuPXIubGVuZ3RoKCk7bj5OdW1iZXIuRVBTSUxPTiYmci5zY2FsZUluUGxhY2UoMS9uKTtjb25zdCBoPWEuY3Jvc3Mociksbz1oLmxlbmd0aCgpO28+TnVtYmVyLkVQU0lMT04mJmguc2NhbGVJblBsYWNlKDEvbyksdGhpcy5zZXQoci54LHIueSxyLnosMCxoLngsaC55LGgueiwwLGEueCxhLnksYS56LDAsdC54LHQueSx0LnosMSl9c2V0Um90YXRpb24odCxlKXtjb25zdCBzPXQubGVuZ3RoKCk7aWYoTWF0aC5hYnMocyk8TnVtYmVyLkVQU0lMT04pcmV0dXJuIG51bGw7Y29uc3QgYT10LngvcyxpPXQueS9zLHI9dC56L3Msbj1NYXRoLnNpbihlKSxoPU1hdGguY29zKGUpLG89MS1oLF89dGhpcy5fX2RhdGE7cmV0dXJuIF9bMF09YSphKm8raCxfWzFdPWkqYSpvK3IqbixfWzJdPXIqYSpvLWkqbixfWzNdPTAsX1s0XT1hKmkqby1yKm4sX1s1XT1pKmkqbytoLF9bNl09cippKm8rYSpuLF9bN109MCxfWzhdPWEqcipvK2kqbixfWzldPWkqcipvLWEqbixfWzEwXT1yKnIqbytoLF9bMTFdPTAsX1sxMl09MCxfWzEzXT0wLF9bMTRdPTAsX1sxNV09MSx0aGlzfXNldFhSb3RhdGlvbih0KXtjb25zdCBlPU1hdGguc2luKHQpLHM9TWF0aC5jb3ModCksYT10aGlzLl9fZGF0YTtyZXR1cm4gYVswXT0xLGFbMV09MCxhWzJdPTAsYVszXT0wLGFbNF09MCxhWzVdPXMsYVs2XT1lLGFbN109MCxhWzhdPTAsYVs5XT0tZSxhWzEwXT1zLGFbMTFdPTAsYVsxMl09MCxhWzEzXT0wLGFbMTRdPTAsYVsxNV09MSx0aGlzfXNldFlSb3RhdGlvbih0KXtjb25zdCBlPU1hdGguc2luKHQpLHM9TWF0aC5jb3ModCksYT10aGlzLl9fZGF0YTtyZXR1cm4gYVswXT1zLGFbMV09MCxhWzJdPS1lLGFbM109MCxhWzRdPTAsYVs1XT0xLGFbNl09MCxhWzddPTAsYVs4XT1lLGFbOV09MCxhWzEwXT1zLGFbMTFdPTAsYVsxMl09MCxhWzEzXT0wLGFbMTRdPTAsYVsxNV09MSx0aGlzfXNldFpSb3RhdGlvbih0KXtjb25zdCBlPU1hdGguc2luKHQpLHM9TWF0aC5jb3ModCksYT10aGlzLl9fZGF0YTtyZXR1cm4gYVswXT1zLGFbMV09ZSxhWzJdPTAsYVszXT0wLGFbNF09LWUsYVs1XT1zLGFbNl09MCxhWzddPTAsYVs4XT0wLGFbOV09MCxhWzEwXT0xLGFbMTFdPTAsYVsxMl09MCxhWzEzXT0wLGFbMTRdPTAsYVsxNV09MSx0aGlzfXRyYW5zZm9ybVZlYzQodCl7Y29uc3QgZT10aGlzLl9fZGF0YSxzPXQueCxhPXQueSxpPXQueixyPXQudDtyZXR1cm4gbmV3IFZlYzQoZVswXSpzK2VbNF0qYStlWzhdKmkrZVsxMl0qcixlWzFdKnMrZVs1XSphK2VbOV0qaStlWzEzXSpyLGVbMl0qcytlWzZdKmErZVsxMF0qaStlWzE0XSpyLGVbM10qcytlWzddKmErZVsxMV0qaStlWzE1XSpyKX10cmFuc2Zvcm1WZWMzKHQpe2NvbnN0IGU9dGhpcy5fX2RhdGEscz10LngsYT10LnksaT10Lno7cmV0dXJuIG5ldyBsKGVbMF0qcytlWzRdKmErZVs4XSppK2VbMTJdLGVbMV0qcytlWzVdKmErZVs5XSppK2VbMTNdLGVbMl0qcytlWzZdKmErZVsxMF0qaStlWzE0XSl9cm90YXRlVmVjMyh0KXtjb25zdCBlPXRoaXMuX19kYXRhLHM9dC54LGE9dC55LGk9dC56O3JldHVybiBuZXcgbChlWzBdKnMrZVs0XSphK2VbOF0qaSxlWzFdKnMrZVs1XSphK2VbOV0qaSxlWzJdKnMrZVs2XSphK2VbMTBdKmkpfXNldFBlcnNwZWN0aXZlTWF0cml4KHQsZSxzLGEpe2NvbnN0IGk9TWF0aC50YW4oLjUqTWF0aC5QSS0uNSp0KSxyPTEvKHMtYSk7dGhpcy5zZXQoaS9lLDAsMCwwLDAsaSwwLDAsMCwwLChzK2EpKnIsLTEsMCwwLHMqYSpyKjIsMCl9c2V0T3J0aG9ncmFwaGljTWF0cml4KHQsZSxzLGEsaSxyKXtjb25zdCBuPTEvKHQtZSksaD0xLyhzLWEpLG89MS8oaS1yKTt0aGlzLnNldCgtMipuLDAsMCwwLDAsLTIqaCwwLDAsMCwwLDIqbywwLCh0K2UpKm4sKGErcykqaCwocitpKSpvLDEpfXNldFNjYWxlKHQsZSxzKXt0IGluc3RhbmNlb2YgbD90aGlzLnNldCh0LngsMCwwLDAsMCx0LnksMCwwLDAsMCx0LnosMCwwLDAsMCwxKTp0aGlzLnNldCh0LDAsMCwwLDAsZSwwLDAsMCwwLHMsMCwwLDAsMCwxKX1zZXRGcm9tTWF0M3g0QXJyYXkodCl7dGhpcy5zZXQodFswXSx0WzFdLHRbMl0sMCx0WzNdLHRbNF0sdFs1XSwwLHRbNl0sdFs3XSx0WzhdLDAsdFs5XSx0WzEwXSx0WzExXSwxKX1zdGF0aWMgY3JlYXRlRnJvbUZsb2F0MzJCdWZmZXIodCxlPTApe3JldHVybiBjb25zb2xlLndhcm4oIkRlcHJlY2F0ZWQsIHVzZSAjY3JlYXRlRnJvbUJ1ZmZlciBpbnN0ZWFkIiksdGhpcy5jcmVhdGVGcm9tQnVmZmVyKHQsNCplKX1zdGF0aWMgY3JlYXRlRnJvbUJ1ZmZlcih0LGUpe3JldHVybiBuZXcgeShuZXcgRmxvYXQzMkFycmF5KHQsZSwxNikpfWNsb25lKCl7cmV0dXJuIG5ldyB5KHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdLHRoaXMuX19kYXRhWzNdLHRoaXMuX19kYXRhWzRdLHRoaXMuX19kYXRhWzVdLHRoaXMuX19kYXRhWzZdLHRoaXMuX19kYXRhWzddLHRoaXMuX19kYXRhWzhdLHRoaXMuX19kYXRhWzldLHRoaXMuX19kYXRhWzEwXSx0aGlzLl9fZGF0YVsxMV0sdGhpcy5fX2RhdGFbMTJdLHRoaXMuX19kYXRhWzEzXSx0aGlzLl9fZGF0YVsxNF0sdGhpcy5fX2RhdGFbMTVdKX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgeSguLi50KX10b0pTT04oKXtyZXR1cm4gdGhpcy5fX2RhdGF9ZnJvbUpTT04odCl7dCBpbnN0YW5jZW9mIEFycmF5P3RoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkodCk6dCBpbnN0YW5jZW9mIE9iamVjdCYmKHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoT2JqZWN0LnZhbHVlcyh0KSkpfXJlYWRCaW5hcnkodCl7dGhpcy5fX2RhdGE9dC5sb2FkRmxvYXQzMkFycmF5KDE2KX19bigiTWF0NCIseSk7Y2xhc3MgcCBleHRlbmRzIGV7Y29uc3RydWN0b3IodD0wLGU9MCxzPTAsYT0xKXtpZihzdXBlcigpLHQgaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXkpdGhpcy5fX2RhdGE9dDtlbHNlIGlmKHQgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcil7Y29uc29sZS53YXJuKCJkZXByZWNhdGVkLCBwbGVhc2UgdXNlIG5ldyBWZWM0KG5ldyBGbG9hdDMyQXJyYXkoYnVmZmVyLCBieXRlT2Zmc2V0LCA0KSkiKTtjb25zdCBzPXQsYT1lO3RoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkocyxhLDQpfWVsc2UgaWYodGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheSg0KSwib2JqZWN0Ij09dHlwZW9mIHQpe3RoaXMuX19kYXRhWzBdPTAsdGhpcy5fX2RhdGFbMV09MCx0aGlzLl9fZGF0YVsyXT0wLHRoaXMuX19kYXRhWzNdPTE7Zm9yKGNvbnN0IGUgaW4gdClBcnJheS5pc0FycmF5KHRbZV0pP3RoaXNbZV0uY2FsbCh0aGlzLC4uLnRbZV0pOnRoaXNbZV0uY2FsbCh0aGlzLHRbZV0pfWVsc2UgdGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lLHRoaXMuX19kYXRhWzJdPXMsdGhpcy5fX2RhdGFbM109YX1nZXQgeCgpe3JldHVybiB0aGlzLl9fZGF0YVswXX1zZXQgeCh0KXt0aGlzLl9fZGF0YVswXT10fWdldCB5KCl7cmV0dXJuIHRoaXMuX19kYXRhWzFdfXNldCB5KHQpe3RoaXMuX19kYXRhWzFdPXR9Z2V0IHooKXtyZXR1cm4gdGhpcy5fX2RhdGFbMl19c2V0IHoodCl7dGhpcy5fX2RhdGFbMl09dH1nZXQgdygpe3JldHVybiB0aGlzLl9fZGF0YVszXX1zZXQgdyh0KXt0aGlzLl9fZGF0YVszXT10fXNldCh0LGUscyxhKXt0aGlzLl9fZGF0YVswXT10LHRoaXMuX19kYXRhWzFdPWUsdGhpcy5fX2RhdGFbMl09cyx0aGlzLl9fZGF0YVszXT1hfXNldERhdGFBcnJheSh0KXt0aGlzLl9fZGF0YT10fXNldEZyb21PdGhlcih0KXt0aGlzLl9fZGF0YVswXT10LngsdGhpcy5fX2RhdGFbMV09dC55LHRoaXMuX19kYXRhWzJdPXQueix0aGlzLl9fZGF0YVszXT10Lnd9c2V0RnJvbUV1bGVyQW5nbGVzKHQpe2NvbnN0IGU9bmV3IGw7c3dpdGNoKHQub3JkZXIpe2Nhc2UgMDplLnNldCh0LngsLXQueSx0LnopO2JyZWFrO2Nhc2UgMTplLnNldCh0LnksLXQueix0LngpO2JyZWFrO2Nhc2UgMjplLnNldCh0LnosLXQueCx0LnkpO2JyZWFrO2Nhc2UgMzplLnNldCh0LngsdC56LHQueSk7YnJlYWs7Y2FzZSA0OmUuc2V0KHQueix0LnksdC54KTticmVhaztjYXNlIDU6ZS5zZXQodC55LHQueCx0LnopO2JyZWFrO2RlZmF1bHQ6dGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIEV1bGVyQW5nbGVzIG9yZGVyOiIsdC5vcmRlcil9Y29uc3Qgcz0uNSplLngsYT0uNSplLnksaT0uNSplLnoscj1NYXRoLmNvcyhzKSxuPU1hdGguY29zKGEpLGg9TWF0aC5jb3MoaSksbz1NYXRoLnNpbihzKSxfPU1hdGguc2luKGEpLGQ9TWF0aC5zaW4oaSksYz1yKmgsdT1yKmQsZj1vKmgsbT1vKmQsZz1uKmYtXyp1LHk9biptK18qYyxwPW4qdS1fKmY7c3dpdGNoKHRoaXMudz1uKmMrXyptLHQub3JkZXIpe2Nhc2UgMDp0aGlzLng9Zyx0aGlzLnk9LXksdGhpcy56PXA7YnJlYWs7Y2FzZSAxOnRoaXMueD1wLHRoaXMueT1nLHRoaXMuej0teTticmVhaztjYXNlIDI6dGhpcy54PS15LHRoaXMueT1wLHRoaXMuej1nO2JyZWFrO2Nhc2UgMzp0aGlzLng9Zyx0aGlzLnk9cCx0aGlzLno9eTticmVhaztjYXNlIDQ6dGhpcy54PXAsdGhpcy55PXksdGhpcy56PWc7YnJlYWs7Y2FzZSA1OnRoaXMueD15LHRoaXMueT1nLHRoaXMuej1wO2JyZWFrO2RlZmF1bHQ6dGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIEV1bGVyQW5nbGVzIG9yZGVyOiIsdC5vcmRlcil9fXRvRXVsZXJBbmdsZXModCl7Y29uc3QgZT1uZXcgbDtzd2l0Y2godCl7Y2FzZSAwOmUuc2V0KHRoaXMueix0aGlzLngsdGhpcy55KTticmVhaztjYXNlIDE6ZS5zZXQodGhpcy54LHRoaXMueSx0aGlzLnopO2JyZWFrO2Nhc2UgMjplLnNldCh0aGlzLnksdGhpcy56LHRoaXMueCk7YnJlYWs7Y2FzZSAzOmUuc2V0KHRoaXMueSwtdGhpcy54LHRoaXMueik7YnJlYWs7Y2FzZSA0OmUuc2V0KHRoaXMueCwtdGhpcy56LHRoaXMueSk7YnJlYWs7Y2FzZSA1OmUuc2V0KHRoaXMueiwtdGhpcy55LHRoaXMueCk7YnJlYWs7ZGVmYXVsdDp0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgcm90YXRpb24gb3JkZXI6Iit0KX1jb25zdCBzPW5ldyBsLGE9ZS54KmUueStlLnoqdGhpcy53O2lmKGE+LjQ5OTk5KXMueT0yKk1hdGguYXRhbjIoZS54LHRoaXMudykscy56PS41Kk1hdGguUEkscy54PTA7ZWxzZSBpZihhPC0uNDk5OTkpcy55PS0yKk1hdGguYXRhbjIoZS54LHRoaXMudykscy56PS0uNSpNYXRoLlBJLHMueD0wO2Vsc2V7Y29uc3QgdD1lLngqZS54LGk9ZS55KmUueSxyPWUueiplLno7cy55PU1hdGguYXRhbjIoMiplLnkqdGhpcy53LTIqZS54KmUueiwxLTIqaS0yKnIpLHMuej1NYXRoLmFzaW4oMiphKSxzLng9TWF0aC5hdGFuMigyKmUueCp0aGlzLnctMiplLnkqZS56LDEtMip0LTIqcil9c3dpdGNoKHQpe2Nhc2UgMDpyZXR1cm4gbmV3IG0ocy55LHMueixzLngsdCk7Y2FzZSAxOnJldHVybiBuZXcgbShzLngscy55LHMueix0KTtjYXNlIDI6cmV0dXJuIG5ldyBtKHMueixzLngscy55LHQpO2Nhc2UgMzpyZXR1cm4gbmV3IG0oLXMueSxzLngscy56LHQpO2Nhc2UgNDpyZXR1cm4gbmV3IG0ocy54LHMueiwtcy55LHQpO2Nhc2UgNTpyZXR1cm4gbmV3IG0ocy56LC1zLnkscy54LHQpfX1zZXRGcm9tQXhpc0FuZEFuZ2xlKHQsZSl7Y29uc3Qgcz1lLzIsYT10Lm5vcm1hbGl6ZSgpLnNjYWxlKE1hdGguc2luKHMpKTt0aGlzLnNldChhLngsYS55LGEueixNYXRoLmNvcyhzKSl9c2V0RnJvbURpcmVjdGlvbkFuZFVwdmVjdG9yKHQsZSl7Y29uc3Qgcz1uZXcgZztzLnNldEZyb21EaXJlY3Rpb25BbmRVcHZlY3Rvcih0LGUpLHRoaXMuc2V0RnJvbU1hdDMocyl9c2V0RnJvbTJWZWN0b3JzKHQsZSl7Y29uc3Qgcz10LmNyb3NzKGUpLGE9dC5kb3QoZSksaT1NYXRoLnNxcnQoMiooMSthKSk7dGhpcy5zZXQocy54L2kscy55L2kscy56L2ksaS8yKSx0aGlzLm5vcm1hbGl6ZUluUGxhY2UoKX1zZXRGcm9tTWF0Myh0KXtjb25zdCBlPXQuX19kYXRhWzBdK3QuX19kYXRhWzRdK3QuX19kYXRhWzhdO2xldCBzO2lmKGU+MClzPU1hdGguc3FydChlKzEpLHRoaXMuX19kYXRhWzNdPS41KnMscz0uNS9zLHRoaXMuX19kYXRhWzBdPSh0Ll9fZGF0YVs1XS10Ll9fZGF0YVs3XSkqcyx0aGlzLl9fZGF0YVsxXT0odC5fX2RhdGFbNl0tdC5fX2RhdGFbMl0pKnMsdGhpcy5fX2RhdGFbMl09KHQuX19kYXRhWzFdLXQuX19kYXRhWzNdKSpzO2Vsc2V7bGV0IGU9MDt0Ll9fZGF0YVs0XT50Ll9fZGF0YVswXSYmKGU9MSksdC5fX2RhdGFbOF0+dC5fX2RhdGFbMyplK2VdJiYoZT0yKTtjb25zdCBhPShlKzEpJTMsaT0oZSsyKSUzO3M9TWF0aC5zcXJ0KHQuX19kYXRhWzMqZStlXS10Ll9fZGF0YVszKmErYV0tdC5fX2RhdGFbMyppK2ldKzEpLHRoaXMuX19kYXRhW2VdPS41KnMscz0uNS9zLHRoaXMuX19kYXRhWzNdPSh0Ll9fZGF0YVszKmEraV0tdC5fX2RhdGFbMyppK2FdKSpzLHRoaXMuX19kYXRhW2FdPSh0Ll9fZGF0YVszKmErZV0rdC5fX2RhdGFbMyplK2FdKSpzLHRoaXMuX19kYXRhW2ldPSh0Ll9fZGF0YVszKmkrZV0rdC5fX2RhdGFbMyplK2ldKSpzfXRoaXMubm9ybWFsaXplSW5QbGFjZSgpfXNldEZyb21NYXQ0KHQpe2NvbnN0IGU9dC5fX2RhdGFbMF0rdC5fX2RhdGFbNV0rdC5fX2RhdGFbMTBdO2xldCBzO2lmKGU+MClzPU1hdGguc3FydChlKzEpLHRoaXMuX19kYXRhWzNdPS41KnMscz0uNS9zLHRoaXMuX19kYXRhWzBdPSh0Ll9fZGF0YVs2XS10Ll9fZGF0YVs5XSkqcyx0aGlzLl9fZGF0YVsxXT0odC5fX2RhdGFbOF0tdC5fX2RhdGFbMl0pKnMsdGhpcy5fX2RhdGFbMl09KHQuX19kYXRhWzFdLXQuX19kYXRhWzRdKSpzO2Vsc2V7bGV0IGU9MDt0Ll9fZGF0YVs1XT50Ll9fZGF0YVswXSYmKGU9MSksdC5fX2RhdGFbMTBdPnQuX19kYXRhWzQqZStlXSYmKGU9Mik7Y29uc3QgYT0oZSsxKSUzLGk9KGUrMiklMztzPU1hdGguc3FydCh0Ll9fZGF0YVs0KmUrZV0tdC5fX2RhdGFbNCphK2FdLXQuX19kYXRhWzQqaStpXSsxKSx0aGlzLl9fZGF0YVtlXT0uNSpzLHM9LjUvcyx0aGlzLl9fZGF0YVszXT0odC5fX2RhdGFbNCphK2ldLXQuX19kYXRhWzQqaSthXSkqcyx0aGlzLl9fZGF0YVthXT0odC5fX2RhdGFbNCphK2VdK3QuX19kYXRhWzQqZSthXSkqcyx0aGlzLl9fZGF0YVtpXT0odC5fX2RhdGFbNCppK2VdK3QuX19kYXRhWzQqZStpXSkqc310aGlzLm5vcm1hbGl6ZUluUGxhY2UoKX1pc0lkZW50aXR5KCl7cmV0dXJuIHRoaXMuZ2V0QW5nbGUoKTxOdW1iZXIuRVBTSUxPTn1nZXRBbmdsZSgpe3JldHVybiAyKk1hdGguYWNvcyh0aGlzLncpfWVxdWFsKHQpe3JldHVybiBjb25zb2xlLndhcm4oIkRlcHJlY2F0ZWQuIFVzZSAjaXNFcXVhbCBpbnN0ZWFkLiIpLHRoaXMuaXNFcXVhbCh0KX1pc0VxdWFsKHQpe3JldHVybiB0aGlzLng9PXQueCYmdGhpcy55PT10LnkmJnRoaXMuej09dC56JiZ0aGlzLnc9PXQud31ub3RFcXVhbHModCl7cmV0dXJuIHRoaXMueCE9dC54JiZ0aGlzLnkhPXQueSYmdGhpcy56IT10LnomJnRoaXMudyE9dC53fWFwcHJveEVxdWFsKHQsZT1OdW1iZXIuRVBTSUxPTil7cmV0dXJuIE1hdGguYWJzKHRoaXMueC10LngpPGUmJk1hdGguYWJzKHRoaXMueS10LnkpPGUmJk1hdGguYWJzKHRoaXMuei10LnopPGUmJk1hdGguYWJzKHRoaXMudy10LncpPGV9YWRkKHQpe3JldHVybiBuZXcgcCh0aGlzLngrdC54LHRoaXMueSt0LnksdGhpcy56K3Queix0aGlzLncrdC53KX1hZGRJblBsYWNlKHQpe3RoaXMueCs9dC54LHRoaXMueSs9dC55LHRoaXMueis9dC56LHRoaXMudys9dC53fXN1YnRyYWN0KHQpe3JldHVybiBuZXcgcCh0aGlzLngtdC54LHRoaXMueS10LnksdGhpcy56LXQueix0aGlzLnctdC53KX1zY2FsZSh0KXtyZXR1cm4gbmV3IHAodGhpcy54KnQsdGhpcy55KnQsdGhpcy56KnQsdGhpcy53KnQpfXNjYWxlSW5QbGFjZSh0KXt0aGlzLngqPXQsdGhpcy55Kj10LHRoaXMueio9dCx0aGlzLncqPXR9bGVuZ3RoKCl7Y29uc3QgdD10aGlzLl9fZGF0YVswXSxlPXRoaXMuX19kYXRhWzFdLHM9dGhpcy5fX2RhdGFbMl0sYT10aGlzLl9fZGF0YVszXTtyZXR1cm4gTWF0aC5zcXJ0KHQqdCtlKmUrcypzK2EqYSl9bGVuZ3RoU3F1YXJlZCgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM107cmV0dXJuIHQqdCtlKmUrcypzK2EqYX1ub3JtYWxpemUoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV0scz10aGlzLl9fZGF0YVsyXSxhPXRoaXMuX19kYXRhWzNdO2xldCBpPXQqdCtlKmUrcypzK2EqYTtyZXR1cm4gaTxOdW1iZXIuRVBTSUxPTj9uZXcgcDooaT0xL01hdGguc3FydChpKSxuZXcgcCh0KmksZSppLHMqaSxhKmkpKX1ub3JtYWxpemVJblBsYWNlKCl7Y29uc3QgdD10aGlzLl9fZGF0YVswXSxlPXRoaXMuX19kYXRhWzFdLHM9dGhpcy5fX2RhdGFbMl0sYT10aGlzLl9fZGF0YVszXTtsZXQgaT10KnQrZSplK3MqcythKmE7aTxOdW1iZXIuRVBTSUxPTnx8KGk9MS9NYXRoLnNxcnQoaSksdGhpcy5zZXQodCppLGUqaSxzKmksYSppKSl9ZG90KHQpe3JldHVybiB0aGlzLngqdC54K3RoaXMueSp0LnkrdGhpcy56KnQueit0aGlzLncqdC53fWNyb3NzKHQpe2NvbnN0IGU9dGhpcy54LHM9dGhpcy55LGE9dGhpcy56LGk9dGhpcy53LHI9dC54LG49dC55LGg9dC56LG89dC53O3JldHVybiBuZXcgcChzKmgtYSpuLGEqby1pKmgsaSpyLWUqbyxlKm4tcypyKX1jb25qdWdhdGUoKXtyZXR1cm4gbmV3IHAoLXRoaXMueCwtdGhpcy55LC10aGlzLnosdGhpcy53KX1pbnZlcnNlKCl7cmV0dXJuIHRoaXMuY29uanVnYXRlKCl9YWxpZ25XaXRoKHQpe3RoaXMuZG90KHQpPDAmJnRoaXMuc2V0KC10aGlzLngsLXRoaXMueSwtdGhpcy56LC10aGlzLncpfW11bHRpcGx5KHQpe2NvbnN0IGU9dGhpcy5fX2RhdGFbMF0scz10aGlzLl9fZGF0YVsxXSxhPXRoaXMuX19kYXRhWzJdLGk9dGhpcy5fX2RhdGFbM10scj10Ll9fZGF0YVswXSxuPXQuX19kYXRhWzFdLGg9dC5fX2RhdGFbMl0sbz10Ll9fZGF0YVszXTtyZXR1cm4gbmV3IHAoZSpvK2kqcitzKmgtYSpuLHMqbytpKm4rYSpyLWUqaCxhKm8raSpoK2Uqbi1zKnIsaSpvLWUqci1zKm4tYSpoKX1tdWx0aXBseUluUGxhY2UodCl7Y29uc3QgZT10aGlzLl9fZGF0YVswXSxzPXRoaXMuX19kYXRhWzFdLGE9dGhpcy5fX2RhdGFbMl0saT10aGlzLl9fZGF0YVszXSxyPXQuX19kYXRhWzBdLG49dC5fX2RhdGFbMV0saD10Ll9fZGF0YVsyXSxvPXQuX19kYXRhWzNdO3RoaXMuc2V0KGUqbytpKnIrcypoLWEqbixzKm8raSpuK2Eqci1lKmgsYSpvK2kqaCtlKm4tcypyLGkqby1lKnItcypuLWEqaCl9cm90YXRlVmVjMyh0KXtjb25zdCBlPW5ldyBwKHQueCx0LnksdC56LDApLHM9dGhpcy5tdWx0aXBseShlKS5tdWx0aXBseSh0aGlzLmNvbmp1Z2F0ZSgpKTtyZXR1cm4gbmV3IGwocy54LHMueSxzLnopfXJvdGF0ZVgodCl7dCo9LjU7Y29uc3QgZT10aGlzLngscz10aGlzLnksYT10aGlzLnosaT10aGlzLncscj1NYXRoLnNpbih0KSxuPU1hdGguY29zKHQpO3RoaXMueD1lKm4raSpyLHRoaXMueT1zKm4rYSpyLHRoaXMuej1hKm4tcypyLHRoaXMudz1pKm4tZSpyfXJvdGF0ZVkodCl7dCo9LjU7Y29uc3QgZT10aGlzLngscz10aGlzLnksYT10aGlzLnosaT10aGlzLncscj1NYXRoLnNpbih0KSxuPU1hdGguY29zKHQpO3RoaXMueD1lKm4tYSpyLHRoaXMueT1zKm4raSpyLHRoaXMuej1hKm4rZSpyLHRoaXMudz1pKm4tcypyfXJvdGF0ZVoodCl7dCo9LjU7Y29uc3QgZT10aGlzLngscz10aGlzLnksYT10aGlzLnosaT10aGlzLncscj1NYXRoLnNpbih0KSxuPU1hdGguY29zKHQpO3RoaXMueD1lKm4rcypyLHRoaXMueT1zKm4tZSpyLHRoaXMuej1hKm4raSpyLHRoaXMudz1pKm4tYSpyfXRvTWF0Mygpe2NvbnN0IHQ9dGhpcy54LGU9dGhpcy55LHM9dGhpcy56LGE9dGhpcy53LGk9dCt0LHI9ZStlLG49cytzLGg9dCppLG89ZSppLF89ZSpyLGQ9cyppLGw9cypyLGM9cypuLHU9YSppLGY9YSpyLG09YSpuLHk9bmV3IGc7cmV0dXJuIHkuX19kYXRhWzBdPTEtXy1jLHkuX19kYXRhWzNdPW8tbSx5Ll9fZGF0YVs2XT1kK2YseS5fX2RhdGFbMV09byttLHkuX19kYXRhWzRdPTEtaC1jLHkuX19kYXRhWzddPWwtdSx5Ll9fZGF0YVsyXT1kLWYseS5fX2RhdGFbNV09bCt1LHkuX19kYXRhWzhdPTEtaC1fLHl9Z2V0WGF4aXMoKXtjb25zdCB0PXRoaXMueCp0aGlzLnksZT10aGlzLngqdGhpcy56LHM9dGhpcy55KnRoaXMueSxhPXRoaXMueSp0aGlzLncsaT10aGlzLnoqdGhpcy56LHI9dGhpcy56KnRoaXMudztyZXR1cm4gbmV3IGwoMS0yKihpK3MpLDIqKHQrciksMiooZS1hKSl9Z2V0WWF4aXMoKXtjb25zdCB0PXRoaXMueCp0aGlzLngsZT10aGlzLngqdGhpcy55LHM9dGhpcy54KnRoaXMudyxhPXRoaXMueSp0aGlzLnosaT10aGlzLnoqdGhpcy56LHI9dGhpcy56KnRoaXMudztyZXR1cm4gbmV3IGwoMiooZS1yKSwxLTIqKGkrdCksMiooYStzKSl9Z2V0WmF4aXMoKXtjb25zdCB0PXRoaXMueCp0aGlzLngsZT10aGlzLngqdGhpcy56LHM9dGhpcy54KnRoaXMudyxhPXRoaXMueSp0aGlzLnksaT10aGlzLnkqdGhpcy56LHI9dGhpcy55KnRoaXMudztyZXR1cm4gbmV3IGwsbmV3IGwoMioocitlKSwyKihpLXMpLDEtMiooYSt0KSl9bWlycm9yKHQpe3N3aXRjaCh0KXtjYXNlIDA6cmV0dXJuIG5ldyBwKHRoaXMueix0aGlzLncsdGhpcy54LHRoaXMueSk7Y2FzZSAxOnJldHVybiBuZXcgcCgtdGhpcy53LHRoaXMueix0aGlzLnksLXRoaXMueCk7Y2FzZSAyOnJldHVybiBuZXcgcCh0aGlzLngsdGhpcy55LHRoaXMueiwtdGhpcy53KX19dG9NYXQ0KCl7Y29uc3QgdD10aGlzLngsZT10aGlzLnkscz10aGlzLnosYT10aGlzLncsaT10K3Qscj1lK2Usbj1zK3MsaD10Kmksbz1lKmksXz1lKnIsZD1zKmksbD1zKnIsYz1zKm4sdT1hKmksZj1hKnIsbT1hKm4sZz1uZXcgeTtyZXR1cm4gZy5fX2RhdGFbMF09MS1fLWMsZy5fX2RhdGFbNF09by1tLGcuX19kYXRhWzhdPWQrZixnLl9fZGF0YVsxXT1vK20sZy5fX2RhdGFbNV09MS1oLWMsZy5fX2RhdGFbOV09bC11LGcuX19kYXRhWzJdPWQtZixnLl9fZGF0YVs2XT1sK3UsZy5fX2RhdGFbMTBdPTEtaC1fLGd9bGVycCh0LGUpe2NvbnN0IHM9bmV3IHAodGhpcy54K2UqKHQueC10aGlzLngpLHRoaXMueStlKih0LnktdGhpcy55KSx0aGlzLnorZSoodC56LXRoaXMueiksdGhpcy53K2UqKHQudy10aGlzLncpKTtyZXR1cm4gcy5ub3JtYWxpemVJblBsYWNlKCksc31zbGVycCh0LGUpe2NvbnN0IHM9dGhpcy5kb3QodCksYT1lLzIsaT1NYXRoLmFjb3Mocyk7aTwwJiYoaT0taSk7Y29uc3Qgcj1NYXRoLnNpbihpKSxuPU1hdGguc2luKGEqaSksaD1NYXRoLnNpbigoMS1hKSppKS9yLG89bi9yLF89bmV3IHAoaCp0aGlzLngrbyp0LngsaCp0aGlzLnkrbyp0LnksaCp0aGlzLnorbyp0LnosaCp0aGlzLncrbyp0LncpO3JldHVybiBfLm5vcm1hbGl6ZUluUGxhY2UoKSxffXN0YXRpYyBjcmVhdGUoLi4udCl7cmV0dXJuIG5ldyBwKC4uLnQpfXN0YXRpYyBjcmVhdGVGcm9tRmxvYXQzMkJ1ZmZlcih0LGU9MCl7cmV0dXJuIGNvbnNvbGUud2FybigiRGVwcmVjYXRlZCwgdXNlICNjcmVhdGVGcm9tQnVmZmVyIGluc3RlYWQiKSx0aGlzLmNyZWF0ZUZyb21CdWZmZXIodCw0KmUpfXN0YXRpYyBjcmVhdGVGcm9tQnVmZmVyKHQsZSl7cmV0dXJuIG5ldyBwKG5ldyBGbG9hdDMyQXJyYXkodCxlLDQpKX1zdGF0aWMgbnVtRWxlbWVudHMoKXtyZXR1cm4gNH1jbG9uZSgpe3JldHVybiBuZXcgcCh0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVsxXSx0aGlzLl9fZGF0YVsyXSx0aGlzLl9fZGF0YVszXSl9dG9KU09OKCl7cmV0dXJue3g6dGhpcy54LHk6dGhpcy55LHo6dGhpcy56LHc6dGhpcy53fX1mcm9tSlNPTih0KXt0aGlzLl9fZGF0YVswXT10LngsdGhpcy5fX2RhdGFbMV09dC55LHRoaXMuX19kYXRhWzJdPXQueix0aGlzLl9fZGF0YVszXT10LncsdGhpcy5ub3JtYWxpemVJblBsYWNlKCl9cmVhZEJpbmFyeSh0KXt0aGlzLng9dC5sb2FkRmxvYXQzMigpLHRoaXMueT10LmxvYWRGbG9hdDMyKCksdGhpcy56PXQubG9hZEZsb2F0MzIoKSx0aGlzLnc9dC5sb2FkRmxvYXQzMigpfX1uKCJRdWF0IixwKTtjbGFzcyB4e2NvbnN0cnVjdG9yKHQsZSl7dGhpcy5zdGFydD10IGluc3RhbmNlb2YgbD90Om5ldyBsLHRoaXMuZGlyPWUgaW5zdGFuY2VvZiBsP2U6bmV3IGx9Y2xvc2VzdFBvaW50KHQpe2NvbnN0IGU9dC5zdWJ0cmFjdCh0aGlzLnN0YXJ0KS5kb3QodGhpcy5kaXIpO2lmKGU8TnVtYmVyLkVQU0lMT04pcmV0dXJuIDA7Y29uc3Qgcz10aGlzLmRpci5kb3QodGhpcy5kaXIpO3JldHVybiBzPE51bWJlci5FUFNJTE9OPzA6ZS9zfWNsb3Nlc3RQb2ludE9uTGluZVNlZ21lbnQodCxlKXtjb25zdCBhPXRoaXMuZGlyLGk9ZS5zdWJ0cmFjdCh0KSxyPWkubGVuZ3RoKCk7aS5ub3JtYWxpemVJblBsYWNlKCk7Y29uc3Qgbj10aGlzLnN0YXJ0LnN1YnRyYWN0KHQpLGg9YS5kb3QoYSksbz1hLmRvdChpKSxfPWkuZG90KGkpLGQ9YS5kb3QobiksbD1pLmRvdChuKTtpZigwPT1oJiYwPT1fKXJldHVyblt0aGlzLnN0YXJ0LmRpc3RhbmNlVG8odCksMF07aWYoMD09aClyZXR1cm5bMCwwXTtpZigwPT1fKXJldHVyblt0aGlzLmNsb3Nlc3RQb2ludCh0KSwwXTtjb25zdCBjPWgqXy1vKm87bGV0IHUsZjtyZXR1cm4gYzwuMDAxPyh1PTAsZj1vPl8/ZC9vOmwvXyk6KHU9KG8qbC1fKmQpL2MsZj0oaCpsLW8qZCkvYyksW3Uscy5jbGFtcChmL3IsMCwxKV19cG9pbnRBdERpc3QodCl7cmV0dXJuIHRoaXMuc3RhcnQuYWRkKHRoaXMuZGlyLnNjYWxlKHQpKX1pbnRlcnNlY3RSYXlWZWN0b3IodCl7Y29uc3QgZT10aGlzLmRpcixzPXQuZGlyLGE9dGhpcy5zdGFydC5zdWJ0cmFjdCh0LnN0YXJ0KSxpPWUuZG90KGUpLHI9ZS5kb3Qocyksbj1zLmRvdChzKSxoPWUuZG90KGEpLG89cy5kb3QoYSk7aWYoMD09aSYmMD09bilyZXR1cm5bMCx0aGlzLnN0YXJ0LmRpc3RhbmNlVG8odC5zdGFydCldO2lmKDA9PWkpcmV0dXJuW3QuY2xvc2VzdFBvaW50KHRoaXMuc3RhcnQpLDBdO2lmKDA9PW4pcmV0dXJuWzEsdGhpcy5jbG9zZXN0UG9pbnQodC5zdGFydCldO2NvbnN0IF89aSpuLXIqcjtsZXQgZCxsO3JldHVybiBfPC4wMDE/KGQ9MCxsPXI+bj9oL3I6by9uKTooZD0ocipvLW4qaCkvXyxsPShpKm8tcipoKS9fKSxbZCxsXX1pbnRlcnNlY3RSYXlQbGFuZSh0KXtjb25zdCBlPXRoaXMuc3RhcnQuc3VidHJhY3QodC5zdGFydCkscz10LmRpci5kb3QodGhpcy5kaXIpLGE9LXQuZGlyLmRvdChlKTtpZihNYXRoLmFicyhzKTxOdW1iZXIuUFJFQ0lTSU9OKXJldHVybi0xO2NvbnN0IGk9YS9zO3JldHVybiBpPC1OdW1iZXIuUFJFQ0lTSU9OPy0xOml9aW50ZXJzZWN0UmF5Qm94Myh0LGU9MCl7Y29uc3Qgcz1uZXcgbCgxL3RoaXMuZGlyLngsMS90aGlzLmRpci55LDEvdGhpcy5kaXIueiksYT1bXTthWzBdPXMueDwwLGFbMV09cy55PDAsYVsyXT1zLno8MDtjb25zdCBpPVtdO2lmKGU+MCl7Y29uc3Qgcz10LmRpYWdvbmFsKCk7cy5ub3JtYWxpemVJblBsYWNlKCkscy5zY2FsZUluUGxhY2UoZSksaVswXT10LnAwLnN1YnRyYWN0KHMpLGlbMV09dC5wMS5hZGQocyl9ZWxzZSBpWzBdPXQucDAsaVsxXT10LnAxO2xldCByPShpW2FbMF1dLngtdGhpcy5zdGFydC54KSpzLngsbj0oaVsxLWFbMF1dLngtdGhpcy5zdGFydC54KSpzLng7Y29uc3QgaD0oaVthWzFdXS55LXRoaXMuc3RhcnQueSkqcy55LG89KGlbMS1hWzFdXS55LXRoaXMuc3RhcnQueSkqcy55O2lmKHI+b3x8aD5uKXJldHVybiExO2g+ciYmKHI9aCksbzxuJiYobj1vKTtjb25zdCBfPShpW2FbMl1dLnotdGhpcy5zdGFydC56KSpzLnosZD0oaVsxLWFbMl1dLnotdGhpcy5zdGFydC56KSpzLno7cmV0dXJuIShyPmR8fF8+bikmJihfPnImJihyPV8pLGQ8biYmKG49ZCksITApfWNsb25lKCl7cmV0dXJuIG5ldyB4KHRoaXMuc3RhcnQuY2xvbmUoKSx0aGlzLmRpci5jbG9uZSgpKX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgeCguLi50KX10b0pTT04oKXtyZXR1cm57c3RhcnQ6dGhpcy5zdGFydCxkaXI6dGhpcy5kaXJ9fWZyb21KU09OKHQpe3RoaXMuc3RhcnQuZnJvbUpTT04odC5zdGFydCksdGhpcy5kaXIuZnJvbUpTT04odC5kaXIpfXRvU3RyaW5nKCl7cmV0dXJuIHQuc3RyaW5naWZ5SlNPTldpdGhGaXhlZFByZWNpc2lvbih0aGlzLnRvSlNPTigpKX19bigiUmF5Iix4KSxuZXcgbCgxLDEsMSk7Y2xhc3Mgd3tjb25zdHJ1Y3Rvcih0LGUscyl7aWYodCBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSl0aGlzLnNldEZyb21GbG9hdDMyQXJyYXkodCk7ZWxzZXtpZih0IGluc3RhbmNlb2YgbCl0aGlzLnRyPXQ7ZWxzZXtpZih0IGluc3RhbmNlb2YgcCYmbnVsbD09ZSYmbnVsbD09cylyZXR1cm4gdGhpcy50cj1uZXcgbCx0aGlzLm9yaT10LHZvaWQodGhpcy5zYz1uZXcgbCgxLDEsMSkpO3RoaXMudHI9bmV3IGx9dGhpcy5vcmk9ZSBpbnN0YW5jZW9mIHA/ZTpuZXcgcCx0aGlzLnNjPXMgaW5zdGFuY2VvZiBsP3M6bmV3IGwoMSwxLDEpfX1zZXQodCxlLHMpe3RoaXMudHI9dCx0aGlzLm9yaT1lLHMgaW5zdGFuY2VvZiBsJiYodGhpcy5zYz1zKX1zZXRGcm9tT3RoZXIodCl7dGhpcy50cj10LnRyLHRoaXMub3JpPXQub3JpLHRoaXMuc2M9dC5zY31pc0lkZW50aXR5KCl7cmV0dXJuIHRoaXMudHIuaXNOdWxsKCkmJnRoaXMub3JpLmlzSWRlbnRpdHkoKSYmdGhpcy5zYy5pczExMSgpfWlzRXF1YWwodCl7cmV0dXJuIHRoaXMudHIuaXNFcXVhbCh0LnRyKSYmdGhpcy5vcmkuaXNFcXVhbCh0Lm9yaSkmJnRoaXMuc2MuaXNFcXVhbCh0LnNjKX1hcHByb3hFcXVhbCh0LGU9TnVtYmVyLkVQU0lMT04pe3JldHVybighdC50cnx8dGhpcy50ci5hcHByb3hFcXVhbCh0LnRyLGUpKSYmKCF0Lm9yaXx8dGhpcy5vcmkuYXBwcm94RXF1YWwodC5vcmksZSkpJiYoIXQuc2N8fHRoaXMuc2MuYXBwcm94RXF1YWwodC5zYyxlKSl9c2V0TG9va0F0KHQsZSxzKXtjb25zdCBhPXQuc3VidHJhY3QoZSk7aWYoYS5sZW5ndGgoKTxOdW1iZXIuRVBTSUxPTil0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgZGlyIik7dGhpcy5vcmkuc2V0RnJvbURpcmVjdGlvbkFuZFVwdmVjdG9yKGEscyksdGhpcy50cj10fW11bHRpcGx5KHQpe2xldCBlPXRoaXMuc2M7dGhpcy5zYy54PT10aGlzLnNjLnkmJnRoaXMuc2MueD09dGhpcy5zYy56fHwoZT10Lm9yaS5yb3RhdGVWZWMzKHRoaXMuc2MpLE1hdGguc2lnbihlLngpIT1NYXRoLnNpZ24odGhpcy5zYy54KSYmKGUueD0tZS54KSxNYXRoLnNpZ24oZS55KSE9TWF0aC5zaWduKHRoaXMuc2MueSkmJihlLnk9LWUueSksTWF0aC5zaWduKGUueikhPU1hdGguc2lnbih0aGlzLnNjLnopJiYoZS56PS1lLnopKTtyZXR1cm4gbmV3IHcodGhpcy50ci5hZGQodGhpcy5vcmkucm90YXRlVmVjMyhlLm11bHRpcGx5KHQudHIpKSksdGhpcy5vcmkubXVsdGlwbHkodC5vcmkpLGUubXVsdGlwbHkodC5zYykpfWludmVyc2UoKXtjb25zdCB0PW5ldyB3O3JldHVybiB0Lm9yaT10aGlzLm9yaS5pbnZlcnNlKCksdGhpcy5zYy54IT10aGlzLnNjLnl8fHRoaXMuc2MueCE9dGhpcy5zYy56Pyh0LnNjPXQub3JpLnJvdGF0ZVZlYzModGhpcy5zYyksTWF0aC5zaWduKHQuc2MueCkhPU1hdGguc2lnbih0aGlzLnNjLngpJiYodC5zYy54PS10LnNjLngpLE1hdGguc2lnbih0LnNjLnkpIT1NYXRoLnNpZ24odGhpcy5zYy55KSYmKHQuc2MueT0tdC5zYy55KSxNYXRoLnNpZ24odC5zYy56KSE9TWF0aC5zaWduKHRoaXMuc2MueikmJih0LnNjLno9LXQuc2MueikpOnQuc2M9dGhpcy5zYy5pbnZlcnNlKCksdC50cj10Lm9yaS5yb3RhdGVWZWMzKHRoaXMudHIubmVnYXRlKCkubXVsdGlwbHkodC5zYykpLHR9dHJhbnNmb3JtVmVjMyh0KXtyZXR1cm4gdGhpcy50ci5hZGQodGhpcy5vcmkucm90YXRlVmVjMyh0aGlzLnNjLm11bHRpcGx5KHQpKSl9dG9NYXQ0KCl7Y29uc3QgdD1uZXcgeSh0aGlzLnNjLngsMCwwLDAsMCx0aGlzLnNjLnksMCwwLDAsMCx0aGlzLnNjLnosMCwwLDAsMCwxKSxlPXRoaXMub3JpLnRvTWF0NCgpLHM9bmV3IHk7cmV0dXJuIHMudHJhbnNsYXRpb249dGhpcy50cixzLm11bHRpcGx5KGUpLm11bHRpcGx5KHQpfWZyb21NYXQ0KHQpe3RoaXMuc2V0RnJvbU1hdDQodCl9c2V0RnJvbU1hdDQodCl7dGhpcy50cj10LnRyYW5zbGF0aW9uLHRoaXMub3JpLnNldEZyb21NYXQ0KHQpfXNldEZyb21GbG9hdDMyQXJyYXkodCl7aWYoNz09dC5sZW5ndGgpcmV0dXJuIHRoaXMudHI9bmV3IGwodC5idWZmZXIsdC5ieXRlT2Zmc2V0KSx0aGlzLm9yaT1uZXcgcCh0LmJ1ZmZlcix0LmJ5dGVPZmZzZXQrMTIpLHZvaWQodGhpcy5zYz1uZXcgbCgxLDEsMSkpO2lmKDghPXQubGVuZ3RoKXJldHVybiAxMD09dC5sZW5ndGg/KHRoaXMudHI9bmV3IGwodC5idWZmZXIsdC5ieXRlT2Zmc2V0KSx0aGlzLm9yaT1uZXcgcCh0LmJ1ZmZlcix0LmJ5dGVPZmZzZXQrMTIpLHZvaWQodGhpcy5zYz1uZXcgbCh0LmJ1ZmZlcix0LmJ5dGVPZmZzZXQrMjEpKSk6dm9pZCAwO3t0aGlzLnRyPW5ldyBsKHQuYnVmZmVyLHQuYnl0ZU9mZnNldCksdGhpcy5vcmk9bmV3IHAodC5idWZmZXIsdC5ieXRlT2Zmc2V0KzEyKTtjb25zdCBlPXRbN107dGhpcy5zYz1uZXcgbChlLGUsZSl9fWNsb25lKCl7cmV0dXJuIG5ldyB3KHRoaXMudHIuY2xvbmUoKSx0aGlzLm9yaS5jbG9uZSgpLHRoaXMuc2MuY2xvbmUoKSl9c3RhdGljIGNyZWF0ZSguLi50KXtyZXR1cm4gbmV3IHcoLi4udCl9dG9KU09OKCl7Y29uc3QgdD17dHI6dGhpcy50ci50b0pTT04oKSxvcmk6dGhpcy5vcmkudG9KU09OKCl9O3JldHVybiB0aGlzLnNjLmlzMTExKCl8fCh0LnNjPXRoaXMuc2MudG9KU09OKCkpLHR9ZnJvbUpTT04odCl7dGhpcy50ci5mcm9tSlNPTih0LnRyKSx0aGlzLm9yaS5mcm9tSlNPTih0Lm9yaSksdC5zYyYmdGhpcy5zYy5mcm9tSlNPTih0LnNjKX1yZWFkQmluYXJ5KHQpe3RoaXMudHIucmVhZEJpbmFyeSh0KSx0aGlzLm9yaS5yZWFkQmluYXJ5KHQpLHRoaXMuc2MucmVhZEJpbmFyeSh0KX10b1N0cmluZygpe3JldHVybiB0LnN0cmluZ2lmeUpTT05XaXRoRml4ZWRQcmVjaXNpb24odGhpcy50b0pTT04oKSl9fW4oIlhmbyIsdyk7Y2xhc3MgSXtjb25zdHJ1Y3Rvcih0LGUpe3RoaXMucDA9dCBpbnN0YW5jZW9mIGQ/dDpuZXcgZChOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZKSx0aGlzLnAxPWUgaW5zdGFuY2VvZiBkP2U6bmV3IGQoTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLE51bWJlci5ORUdBVElWRV9JTkZJTklUWSl9c2V0KHQsZSl7dGhpcy5wMD10LHRoaXMucDE9ZX1yZXNldCgpe3RoaXMucDAueD1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksdGhpcy5wMS54PU51bWJlci5ORUdBVElWRV9JTkZJTklUWSx0aGlzLnAwLnk9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLHRoaXMucDEueT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFl9aXNWYWxpZCgpe3JldHVybiB0aGlzLnAwLnghPU51bWJlci5QT1NJVElWRV9JTkZJTklUWSYmdGhpcy5wMS54IT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkmJnRoaXMucDAueSE9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZJiZ0aGlzLnAxLnkhPU51bWJlci5ORUdBVElWRV9JTkZJTklUWX1hZGRQb2ludCh0KXsodGhpcy5wMC54PT1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFl8fHQueDx0aGlzLnAwLngpJiYodGhpcy5wMC54PXQueCksKHRoaXMucDAueT09TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZfHx0Lnk8dGhpcy5wMC55KSYmKHRoaXMucDAueT10LnkpLCh0aGlzLnAxLnk9PU51bWJlci5ORUdBVElWRV9JTkZJTklUWXx8dC54PnRoaXMucDEueCkmJih0aGlzLnAxLng9dC54KSwodGhpcy5wMS55PT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFl8fHQueT50aGlzLnAxLnkpJiYodGhpcy5wMS55PXQueSl9c2l6ZSgpe3JldHVybiB0aGlzLnAxLmRpc3RhbmNlVG8odGhpcy5wMCl9ZGlhZ29uYWwoKXtyZXR1cm4gdGhpcy5wMS5zdWJ0cmFjdCh0aGlzLnAwKX1jZW50ZXIoKXtjb25zdCB0PXRoaXMucDEuc3VidHJhY3QodGhpcy5wMCk7cmV0dXJuIHQuc2NhbGVJblBsYWNlKC41KSx0LmFkZEluUGxhY2UodGhpcy5wMCksdH1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgSSguLi50KX10b0pTT04oKXtyZXR1cm57cDA6dGhpcy5wMC50b0pTT04oKSxwMTp0aGlzLnAxLnRvSlNPTigpfX10b1N0cmluZygpe3JldHVybiB0LnN0cmluZ2lmeUpTT05XaXRoRml4ZWRQcmVjaXNpb24odGhpcy50b0pTT04oKSl9fW4oIkJveDIiLEkpO2NsYXNzIE4gZXh0ZW5kcyBle2NvbnN0cnVjdG9yKHQsZT0wKXtzdXBlcigpLHRoaXMucG9zPXQgaW5zdGFuY2VvZiBsP3Q6bmV3IGwsdGhpcy5yYWRpdXM9ZX1jbG9uZSgpe3JldHVybiBuZXcgU3BoZXJlKHRoaXMucG9zLmNsb25lKCksdGhpcy5yYWRpdXMpfWludGVyc2VjdHNCb3godCl7cmV0dXJuIHQuaW50ZXJzZWN0c1NwaGVyZSh0aGlzKX10b0pTT04oKXtyZXR1cm57cG9zOnRoaXMucG9zLnRvSlNPTigpLHJhZGl1czp0aGlzLnJhZGl1c319dG9TdHJpbmcoKXtyZXR1cm4gdC5zdHJpbmdpZnlKU09OV2l0aEZpeGVkUHJlY2lzaW9uKHRoaXMudG9KU09OKCkpfXN0YXRpYyBjcmVhdGUoLi4udCl7cmV0dXJuIG5ldyBTcGhlcmUoLi4udCl9fW4oIlNwaGVyZVR5cGUiLE4pO2NsYXNzIEZ7Y29uc3RydWN0b3IodCxlKXt0IGluc3RhbmNlb2YgRmxvYXQzMkFycmF5P3RoaXMuc2V0RnJvbUZsb2F0MzJBcnJheSh0KToodGhpcy5wMD10IGluc3RhbmNlb2YgbD90Om5ldyBsKE51bWJlci5QT1NJVElWRV9JTkZJTklUWSxOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZKSx0aGlzLnAxPWUgaW5zdGFuY2VvZiBsP2U6bmV3IGwoTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLE51bWJlci5ORUdBVElWRV9JTkZJTklUWSxOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkpKX1nZXQgbWluKCl7cmV0dXJuIHRoaXMucDB9Z2V0IG1heCgpe3JldHVybiB0aGlzLnAxfXNldCh0LGUpe3RoaXMucDA9dCx0aGlzLnAxPWV9cmVzZXQoKXt0aGlzLnAwLng9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLHRoaXMucDAueT1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksdGhpcy5wMC56PU51bWJlci5QT1NJVElWRV9JTkZJTklUWSx0aGlzLnAxLng9TnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLHRoaXMucDEueT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFksdGhpcy5wMS56PU51bWJlci5ORUdBVElWRV9JTkZJTklUWX1pc1ZhbGlkKCl7cmV0dXJuIHRoaXMucDAueCE9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZJiZ0aGlzLnAxLnghPU51bWJlci5ORUdBVElWRV9JTkZJTklUWSYmdGhpcy5wMC55IT1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFkmJnRoaXMucDEueSE9TnVtYmVyLk5FR0FUSVZFX0lORklOSVRZJiZ0aGlzLnAwLnohPU51bWJlci5QT1NJVElWRV9JTkZJTklUWSYmdGhpcy5wMS56IT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFl9YWRkUG9pbnQodCl7dC54IT1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFkmJnQueCE9TnVtYmVyLk5FR0FUSVZFX0lORklOSVRZJiYodC54PHRoaXMucDAueCYmKHRoaXMucDAueD10LngpLHQueD50aGlzLnAxLngmJih0aGlzLnAxLng9dC54KSksdC55IT1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFkmJnQueSE9TnVtYmVyLk5FR0FUSVZFX0lORklOSVRZJiYodC55PHRoaXMucDAueSYmKHRoaXMucDAueT10LnkpLHQueT50aGlzLnAxLnkmJih0aGlzLnAxLnk9dC55KSksdC56IT1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFkmJnQueiE9TnVtYmVyLk5FR0FUSVZFX0lORklOSVRZJiYodC56PHRoaXMucDAueiYmKHRoaXMucDAuej10LnopLHQuej50aGlzLnAxLnomJih0aGlzLnAxLno9dC56KSl9YWRkQm94Myh0LGUpe2U/KHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKHQucDApKSx0aGlzLmFkZFBvaW50KGUudHJhbnNmb3JtVmVjMyhuZXcgbCh0LnAwLngsdC5wMC55LHQucDEueikpKSx0aGlzLmFkZFBvaW50KGUudHJhbnNmb3JtVmVjMyhuZXcgbCh0LnAwLngsdC5wMS55LHQucDAueikpKSx0aGlzLmFkZFBvaW50KGUudHJhbnNmb3JtVmVjMyhuZXcgbCh0LnAxLngsdC5wMC55LHQucDAueikpKSx0aGlzLmFkZFBvaW50KGUudHJhbnNmb3JtVmVjMyhuZXcgbCh0LnAwLngsdC5wMS55LHQucDEueikpKSx0aGlzLmFkZFBvaW50KGUudHJhbnNmb3JtVmVjMyhuZXcgbCh0LnAxLngsdC5wMC55LHQucDEueikpKSx0aGlzLmFkZFBvaW50KGUudHJhbnNmb3JtVmVjMyhuZXcgbCh0LnAxLngsdC5wMS55LHQucDAueikpKSx0aGlzLmFkZFBvaW50KGUudHJhbnNmb3JtVmVjMyh0LnAxKSkpOih0aGlzLmFkZFBvaW50KHQucDApLHRoaXMuYWRkUG9pbnQodC5wMSkpfXNpemUoKXtyZXR1cm4gdGhpcy5wMS5kaXN0YW5jZVRvKHRoaXMucDApfWRpYWdvbmFsKCl7cmV0dXJuIHRoaXMucDEuc3VidHJhY3QodGhpcy5wMCl9Y2VudGVyKCl7Y29uc3QgdD10aGlzLnAxLnN1YnRyYWN0KHRoaXMucDApO3JldHVybiB0LnNjYWxlSW5QbGFjZSguNSksdC5hZGRJblBsYWNlKHRoaXMucDApLHR9dG9NYXQ0KCl7Y29uc3QgdD10aGlzLnAxLngtdGhpcy5wMC54LGU9dGhpcy5wMS55LXRoaXMucDAueSxzPXRoaXMucDEuei10aGlzLnAwLno7cmV0dXJuIG5ldyB5KHQsMCwwLDAsMCxlLDAsMCwwLDAscywwLHRoaXMucDAueCx0aGlzLnAwLnksdGhpcy5wMC56LDEpfWdldEJvdW5kaW5nU3BoZXJlKCl7cmV0dXJuIG5ldyBOKHRoaXMuY2VudGVyKCksLjUqdGhpcy5kaWFnb25hbCgpLmxlbmd0aCgpKX1pbnRlcnNlY3RzQm94KHQpe3JldHVybiEodC5tYXgueDx0aGlzLm1pbi54fHx0Lm1pbi54PnRoaXMubWF4Lnh8fHQubWF4Lnk8dGhpcy5taW4ueXx8dC5taW4ueT50aGlzLm1heC55fHx0Lm1heC56PHRoaXMubWluLnp8fHQubWluLno+dGhpcy5tYXgueil9aW50ZXJzZWN0c1NwaGVyZSh0KXtyZXR1cm4gY2xvc2VzdFBvaW50LmRpc3RhbmNlVG9TcXVhcmVkKHQuY2VudGVyKTw9dC5yYWRpdXMqdC5yYWRpdXN9aW50ZXJzZWN0c1BsYW5lKHQpe2xldCBlLHM7cmV0dXJuIHQubm9ybWFsLng+MD8oZT10Lm5vcm1hbC54KnRoaXMubWluLngscz10Lm5vcm1hbC54KnRoaXMubWF4LngpOihlPXQubm9ybWFsLngqdGhpcy5tYXgueCxzPXQubm9ybWFsLngqdGhpcy5taW4ueCksdC5ub3JtYWwueT4wPyhlKz10Lm5vcm1hbC55KnRoaXMubWluLnkscys9dC5ub3JtYWwueSp0aGlzLm1heC55KTooZSs9dC5ub3JtYWwueSp0aGlzLm1heC55LHMrPXQubm9ybWFsLnkqdGhpcy5taW4ueSksdC5ub3JtYWwuej4wPyhlKz10Lm5vcm1hbC56KnRoaXMubWluLnoscys9dC5ub3JtYWwueip0aGlzLm1heC56KTooZSs9dC5ub3JtYWwueip0aGlzLm1heC56LHMrPXQubm9ybWFsLnoqdGhpcy5taW4ueiksZTw9LXQuY29uc3RhbnQmJnM+PS10LmNvbnN0YW50fWNsb25lKCl7cmV0dXJuIG5ldyBGKHRoaXMucDAuY2xvbmUoKSx0aGlzLnAxLmNsb25lKCkpfXN0YXRpYyBjcmVhdGUoLi4udCl7cmV0dXJuIG5ldyBGKC4uLnQpfXN0YXRpYyBzaXplSW5CeXRlcygpe3JldHVybiAyNH10b0pTT04oKXtyZXR1cm57cDA6dGhpcy5wMC50b0pTT04oKSxwMTp0aGlzLnAxLnRvSlNPTigpfX1mcm9tSlNPTih0KXtjb25zdCBlPXt4OnMuaXNOdW1lcmljKHQucDAueCk/dC5wMC54Ok51bWJlci5QT1NJVElWRV9JTkZJTklUWSx5OnMuaXNOdW1lcmljKHQucDAueSk/dC5wMC55Ok51bWJlci5QT1NJVElWRV9JTkZJTklUWSx6OnMuaXNOdW1lcmljKHQucDAueik/dC5wMC56Ok51bWJlci5QT1NJVElWRV9JTkZJTklUWX0sYT17eDpzLmlzTnVtZXJpYyh0LnAxLngpP3QucDEueDpOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkseTpzLmlzTnVtZXJpYyh0LnAxLnkpP3QucDEueTpOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFksejpzLmlzTnVtZXJpYyh0LnAxLnopP3QucDEuejpOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFl9O3RoaXMucDAuZnJvbUpTT04oZSksdGhpcy5wMS5mcm9tSlNPTihhKX1zZXRGcm9tRmxvYXQzMkFycmF5KHQpe3RoaXMucDA9bmV3IGwodC5idWZmZXIsdC5ieXRlT2Zmc2V0KSx0aGlzLnAxPW5ldyBsKHQuYnVmZmVyLHQuYnl0ZU9mZnNldCsxMil9dG9TdHJpbmcoKXtyZXR1cm4gdC5zdHJpbmdpZnlKU09OV2l0aEZpeGVkUHJlY2lzaW9uKHRoaXMudG9KU09OKCkpfX1uKCJCb3gzIixGKTtjbGFzcyBWIGV4dGVuZHMgZXtjb25zdHJ1Y3Rvcih0LGU9MCl7c3VwZXIoKSx0aGlzLm5vcm1hbD10IGluc3RhbmNlb2YgbD90Om5ldyBsLHRoaXMudz1lfXNldCh0LGUscyxhKXt0aGlzLm5vcm1hbC5zZXQodCxlLHMpLHRoaXMudz1hfWRpdmlkZVNjYWxhcih0KXt0aGlzLm5vcm1hbC5zY2FsZUluUGxhY2UoMS90KSx0aGlzLncvPXR9ZGlzdGFuY2VUb1BvaW50KHQpe3JldHVybiB0LmRvdCh0aGlzLm5vcm1hbCkrdGhpcy53fW5vcm1hbGl6ZUluUGxhY2UoKXtjb25zdCB0PTEvdGhpcy5ub3JtYWwubGVuZ3RoKCk7dGhpcy5ub3JtYWwuc2NhbGVJblBsYWNlKHQpLHRoaXMudyo9dH1jbG9uZSgpe3JldHVybiBuZXcgUGxhbmUodGhpcy5ub3JtYWwuY2xvbmUoKSx0aGlzLncpfXN0YXRpYyBjcmVhdGUoLi4udCl7cmV0dXJuIG5ldyBQbGFuZSguLi50KX10b0pTT04oKXtyZXR1cm57bm9ybWFsOnRoaXMubm9ybWFsLnRvSlNPTigpLHc6dGhpcy53fX10b1N0cmluZygpe3JldHVybiB0LnN0cmluZ2lmeUpTT05XaXRoRml4ZWRQcmVjaXNpb24odGhpcy50b0pTT04oKSl9fW4oIlBsYW5lVHlwZSIsVik7bigiRnJ1c3R1bSIsY2xhc3N7Y29uc3RydWN0b3IodCxlLHMsYSxpLHIpe3RoaXMucGxhbmVzPVt0fHxuZXcgVixlfHxuZXcgVixzfHxuZXcgVixhfHxuZXcgVixpfHxuZXcgVixyfHxuZXcgVl19c2V0RnJvbU1hdHJpeCh0KXtjb25zdCBlPXQscz10aGlzLnBsYW5lcztzWzBdLnNldChlLm0wMy1lLm0wMCxlLm0xMy1lLm0xMCxlLm0yMy1lLm0yMCxlLm0zMy1lLm0zMCksc1sxXS5zZXQoZS5tMDMrZS5tMDAsZS5tMTMrZS5tMTAsZS5tMjMrZS5tMjAsZS5tMzMrZS5tMzApLHNbMl0uc2V0KGUubTAzK2UubTAxLGUubTEzK2UubTExLGUubTIzK2UubTIxLGUubTMzK2UubTMxKSxzWzNdLnNldChlLm0wMy1lLm0wMSxlLm0xMy1lLm0xMSxlLm0yMy1lLm0yMSxlLm0zMy1lLm0zMSksc1s0XS5zZXQoZS5tMDMtZS5tMDIsZS5tMTMtZS5tMTIsZS5tMjMtZS5tMjIsZS5tMzMtZS5tMzIpLHNbNV0uc2V0KGUubTAzK2UubTAyLGUubTEzK2UubTEyLGUubTIzK2UubTIyLGUubTMzK2UubTMyKSxzLmZvckVhY2goKHQ9PnQubm9ybWFsaXplSW5QbGFjZSgpKSl9aW50ZXJzZWN0c0JveCh0KXtjb25zdCBlPW5ldyBsLHM9dGhpcy5wbGFuZXMse21pbjphLG1heDppfT10O2ZvcihsZXQgdD0wO3Q8Njt0Kyspe2NvbnN0IHI9c1t0XTtpZihlLng9ci5ub3JtYWwueD4wP2kueDphLngsZS55PXIubm9ybWFsLnk+MD9pLnk6YS55LGUuej1yLm5vcm1hbC56PjA/aS56OmEueixyLmRpc3RhbmNlVG9Qb2ludChlKTwwKXJldHVybiExfXJldHVybiEwfXRvSlNPTigpe3JldHVybntwMDp0aGlzLnAwLnRvSlNPTigpLHAxOnRoaXMucDEudG9KU09OKCkscDI6dGhpcy5wMi50b0pTT04oKSxwMzp0aGlzLnAzLnRvSlNPTigpLHA0OnRoaXMucDQudG9KU09OKCkscDU6dGhpcy5wNS50b0pTT04oKX19ZnJvbUpTT04odCl7dGhpcy5wMC5mcm9tSlNPTih0LnAwKSx0aGlzLnAxLmZyb21KU09OKHQucDEpLHRoaXMucDIuZnJvbUpTT04odC5wMiksdGhpcy5wMy5mcm9tSlNPTih0LnAzKSx0aGlzLnA0LmZyb21KU09OKHQucDQpLHRoaXMucDUuZnJvbUpTT04odC5wNSl9dG9TdHJpbmcoKXtyZXR1cm4gdC5zdHJpbmdpZnlKU09OV2l0aEZpeGVkUHJlY2lzaW9uKHRoaXMudG9KU09OKCkpfX0pO2xldCB6PTA7Y2xhc3MgQXtjb25zdHJ1Y3Rvcih0LGUscyl7aWYodGhpcy5fX2RhdGFUeXBlPXQsdGhpcy5ub3JtYWxpemVkPSExLG51bGwhPXQubnVtRWxlbWVudHMpdGhpcy5fX2RpbWVuc2lvbj10aGlzLl9fZGF0YVR5cGUubnVtRWxlbWVudHMoKTtlbHNlIHN3aXRjaCh0KXtjYXNlIDY6Y2FzZSA0OmNhc2UgNTp0aGlzLl9fZGltZW5zaW9uPTE7YnJlYWs7ZGVmYXVsdDp0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgZGF0YSB0eXBlIGZvciBhdHRyaWJ1dGU6Iit0KX12YXIgYTt0aGlzLl9fZGVmYXVsdEVsZW1lbnRWYWx1ZT1udWxsIT1zP3M6TnVtYmVyLk1BWF9WQUxVRSwoYT1lKSYmdm9pZCAwIT09YS5ieXRlTGVuZ3RoP3RoaXMuX19kYXRhPWU6KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoZSp0aGlzLl9fZGltZW5zaW9uKSx0aGlzLmluaXRSYW5nZSgwKSl9cmVzaXplKHQpe2NvbnN0IGU9dGhpcy5fX2RhdGEubGVuZ3RoLHM9dCp0aGlzLl9fZGltZW5zaW9uO2lmKHM+ZSl7Y29uc3QgdD1uZXcgRmxvYXQzMkFycmF5KHMpO3Quc2V0KHRoaXMuX19kYXRhKSx0aGlzLl9fZGF0YT10LHRoaXMuaW5pdFJhbmdlKGUpfWVsc2UgczxlJiYodGhpcy5fX2RhdGE9dGhpcy5fX2RhdGEuc2xpY2UoMCxzKSl9aW5pdFJhbmdlKHQpe2ZvcihsZXQgZT10O2U8dGhpcy5fX2RhdGEubGVuZ3RoO2UrKyl0aGlzLl9fZGF0YVtlXT10aGlzLl9fZGVmYXVsdEVsZW1lbnRWYWx1ZX1nZXRDb3VudCgpe3JldHVybiB0aGlzLl9fZGF0YS5sZW5ndGgvdGhpcy5fX2RpbWVuc2lvbn1nZXQgbGVuZ3RoKCl7cmV0dXJuIHRoaXMuX19kYXRhLmxlbmd0aC90aGlzLl9fZGltZW5zaW9ufWdldCBkYXRhVHlwZSgpe3JldHVybiB0aGlzLl9fZGF0YVR5cGV9Z2V0IGRhdGEoKXtyZXR1cm4gdGhpcy5fX2RhdGF9c2V0IGRhdGEodCl7dGhpcy5fX2RhdGE9dH1nZXQgbnVtRWxlbWVudHMoKXtyZXR1cm4gdGhpcy5fX2RpbWVuc2lvbn1nZXRGbG9hdDMyVmFsdWUodCl7cmV0dXJuIHRoaXMuX19kYXRhW3RdfXNldEZsb2F0MzJWYWx1ZSh0LGUpe3RoaXMuX19kYXRhW3RdPWV9Z2V0VmFsdWVSZWYodCl7Y29uc3QgZT10aGlzLl9fZGltZW5zaW9uO2lmKHQ+PXRoaXMuX19kYXRhLmxlbmd0aC9lKXRocm93IG5ldyBFcnJvcigiSW52YWxpZCB2ZXJ0ZXggaW5kZXg6Iit0KyIuIE51bSBWZXJ0aWNlczoiK3RoaXMuX19kYXRhLmxlbmd0aC8zKTtyZXR1cm4gdGhpcy5fX2RhdGFUeXBlLmNyZWF0ZUZyb21CdWZmZXIodGhpcy5fX2RhdGEuYnVmZmVyLHQqZSo0KX1zZXRWYWx1ZSh0LGUpe2NvbnN0IHM9dGhpcy5fX2RpbWVuc2lvbjtpZih0Pj10aGlzLl9fZGF0YS5sZW5ndGgvcyl0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgdmVydGV4IGluZGV4OiIrdCsiLiBOdW0gVmVydGljZXM6Iit0aGlzLl9fZGF0YS5sZW5ndGgvMyk7dGhpcy5fX2RhdGFUeXBlLmNyZWF0ZUZyb21CdWZmZXIodGhpcy5fX2RhdGEuYnVmZmVyLHQqcyo0KS5zZXRGcm9tT3RoZXIoZSl9dG9KU09OKHQpe3JldHVybntkYXRhOkFycmF5LmZyb20odGhpcy5fX2RhdGEpLGRhdGFUeXBlOm8odGhpcy5fX2RhdGFUeXBlKSxkZWZhdWx0VmFsdWU6dGhpcy5fX2RlZmF1bHRFbGVtZW50VmFsdWUsbGVuZ3RoOnRoaXMuX19kYXRhLmxlbmd0aC90aGlzLl9fZGltZW5zaW9ufX1mcm9tSlNPTih0KXtjb25zdCBlPXQuZGF0YS5tYXAoKHQ9PnMuaXNOdW1lcmljKHQpP3Q6TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZKSk7dGhpcy5fX2RhdGE9RmxvYXQzMkFycmF5LmZyb20oZSl9dG9TdHJpbmcoKXtyZXR1cm4gSlNPTi5zdHJpbmdpZnkodGhpcy50b0pTT04oKSxudWxsLDIpfX1jbGFzcyBNIGV4dGVuZHMgQXtjb25zdHJ1Y3Rvcih0LGUscyxhKXtzdXBlcihlLHMsYSksdGhpcy5fX2dlb209dCx0aGlzLl9fc3BsaXRzPXt9LHRoaXMuX19zcGxpdFZhbHVlcz1bXX1yZXNpemUodCl7c3VwZXIucmVzaXplKHQpLHRoaXMuX19zcGxpdHM9e30sdGhpcy5fX3NwbGl0VmFsdWVzPVtdfWdldEZhY2VWZXJ0ZXhWYWx1ZVJlZih0LGUpe2NvbnN0IHM9dGhpcy5fX2dlb20uZ2V0RmFjZVZlcnRleEluZGV4KHQsZSk7cmV0dXJuIHMgaW4gdGhpcy5fX3NwbGl0cyYmdCBpbiB0aGlzLl9fc3BsaXRzW3NdP3RoaXMuX19zcGxpdFZhbHVlc1t0aGlzLl9fc3BsaXRzW3NdW3RdXTp0aGlzLmdldFZhbHVlUmVmKHMpfXNldEZhY2VWZXJ0ZXhWYWx1ZSh0LGUscyl7Y29uc3QgYT10aGlzLl9fZ2VvbS5nZXRGYWNlVmVydGV4SW5kZXgodCxlKTt0aGlzLnNldEZhY2VWZXJ0ZXhWYWx1ZV9CeVZlcnRleEluZGV4KHQsYSxzKX1zZXRGYWNlVmVydGV4VmFsdWVfQnlWZXJ0ZXhJbmRleCh0LGUscyl7Y29uc3QgYT10aGlzLmdldFZhbHVlUmVmKGUpO2lmKGEuaXNWYWxpZCgpKWlmKGEuYXBwcm94RXF1YWwocykpO2Vsc2V7aWYoZSBpbiB0aGlzLl9fc3BsaXRzKXtjb25zdCBhPXRoaXMuX19zcGxpdHNbZV07Zm9yKGNvbnN0IGUgaW4gYSl7Y29uc3QgaT1hW2VdO2lmKHRoaXMuX19zcGxpdFZhbHVlc1tpXS5hcHByb3hFcXVhbChzKSlyZXR1cm4gdm9pZChhW3RdPWkpfWlmKHQgaW4gdGhpcy5fX3NwbGl0c1tlXSl7cmV0dXJuIHZvaWQgdGhpcy5fX3NwbGl0VmFsdWVzW3RoaXMuX19zcGxpdHNbZV1bdF1dLnNldEZyb21PdGhlcihzKX19ZWxzZSB0aGlzLl9fc3BsaXRzW2VdPXt9O3RoaXMuX19zcGxpdHNbZV1bdF09dGhpcy5fX3NwbGl0VmFsdWVzLmxlbmd0aCx0aGlzLl9fc3BsaXRWYWx1ZXMucHVzaChzKX1lbHNlIGEuc2V0RnJvbU90aGVyKHMpfXNldFNwbGl0VmVydGV4VmFsdWUodCxlLHMpe2lmKHQgaW4gdGhpcy5fX3NwbGl0c3x8KHRoaXMuX19zcGxpdHNbdF09e30pLGUgaW4gdGhpcy5fX3NwbGl0c1t0XSl7aWYodGhpcy5fX3NwbGl0VmFsdWVzW3RoaXMuX19zcGxpdHNbdF1bZV1dLmFwcHJveEVxdWFsKHMpKXJldHVybjtjb25zb2xlLndhcm4oIkZhY2UgVmVydGV4IEFscmVhZHkgU3BsaXQgd2l0aCBkaWZmZXJlbnQgdmFsdWUiKX10aGlzLl9fc3BsaXRzW3RdW2VdPXRoaXMuX19zcGxpdFZhbHVlcy5sZW5ndGgsdGhpcy5fX3NwbGl0VmFsdWVzLnB1c2gocyl9c2V0U3BsaXRWZXJ0ZXhWYWx1ZXModCxlLHMpe3QgaW4gdGhpcy5fX3NwbGl0c3x8KHRoaXMuX19zcGxpdHNbdF09e30pO2NvbnN0IGE9dGhpcy5fX3NwbGl0VmFsdWVzLmxlbmd0aDt0aGlzLl9fc3BsaXRWYWx1ZXMucHVzaChzKTtmb3IoY29uc3QgcyBvZiBlKXRoaXMuX19zcGxpdHNbdF1bc109YX1nZXRTcGxpdHMoKXtyZXR1cm4gdGhpcy5fX3NwbGl0c31nZXRTcGxpdENvdW50KCl7bGV0IHQ9MDtmb3IoY29uc3QgZSBpbiB0aGlzLl9fc3BsaXRzKXQrPU9iamVjdC5rZXlzKHRoaXMuX19zcGxpdHNbZV0pLmxlbmd0aDtyZXR1cm4gdH1nZW5lcmF0ZVNwbGl0VmFsdWVzKHQsZSl7aWYoMD09ZSlyZXR1cm4gdGhpcy5fX2RhdGE7Y29uc3Qgcz10aGlzLmxlbmd0aCxhPXRoaXMubGVuZ3RoK2UsaT10aGlzLl9fZGF0YVR5cGUubnVtRWxlbWVudHM/dGhpcy5fX2RhdGFUeXBlLm51bUVsZW1lbnRzKCk6MSxyPW5ldyBGbG9hdDMyQXJyYXkoYSppKTtmb3IobGV0IHQ9MDt0PHRoaXMuX19kYXRhLmxlbmd0aDt0Kyspclt0XT10aGlzLl9fZGF0YVt0XTtmb3IoY29uc3QgZSBpbiB0KXtjb25zdCBhPXRbZV07Zm9yKGNvbnN0IHQgaW4gYSl7Y29uc3Qgbj1zK2FbdF07aWYoZSBpbiB0aGlzLl9fc3BsaXRzJiZ0IGluIHRoaXMuX19zcGxpdHNbZV0pe2NvbnN0IHM9dGhpcy5fX3NwbGl0c1tlXVt0XTs2PT10aGlzLl9fZGF0YVR5cGU/cltuKmldPXRoaXMuX19zcGxpdFZhbHVlc1tzXTp0aGlzLl9fZGF0YVR5cGUuY3JlYXRlRnJvbUJ1ZmZlcihyLmJ1ZmZlcixuKmkqNCkuc2V0RnJvbU90aGVyKHRoaXMuX19zcGxpdFZhbHVlc1tzXSl9ZWxzZXtjb25zdCB0PXBhcnNlSW50KGUpO2ZvcihsZXQgZT0wO2U8aTtlKyspdCppK2U+dGhpcy5fX2RhdGEubGVuZ3RoJiZjb25zb2xlLmxvZygiRXJyb3IgcmVtYXBwaW5nIHNyYzoiK3QqaStlKSxuKmkrZT5yLmxlbmd0aCYmY29uc29sZS5sb2coIkVycm9yIHJlbWFwcGluZyB0Z3Q6IituKmkrZSkscltuKmkrZV09dGhpcy5fX2RhdGFbdCppK2VdfX19cmV0dXJuIHJ9dG9KU09OKHQpe2NvbnN0IGU9c3VwZXIudG9KU09OKHQpO3JldHVybiBlLnNwbGl0cz10aGlzLl9fc3BsaXRzLGUuc3BsaXRWYWx1ZXM9dGhpcy5fX3NwbGl0VmFsdWVzLGV9ZnJvbUpTT04odCxlKXtpZihzdXBlci5mcm9tSlNPTih0LGUpLHRoaXMuX19zcGxpdHM9dC5zcGxpdHN8fHt9LHRoaXMuX19zcGxpdFZhbHVlcz1bXSx0LnNwbGl0VmFsdWVzKWZvcihjb25zdCBlIG9mIHQuc3BsaXRWYWx1ZXMpe2NvbnN0IHQ9bmV3IHRoaXMuX19kYXRhVHlwZTt0LmZyb21KU09OKGUpLHRoaXMuX19zcGxpdFZhbHVlcy5wdXNoKHQpfX1sb2FkU3BsaXRWYWx1ZXModCl7Y29uc3QgZT10LmxvYWRVSW50MzJBcnJheSgpO2lmKDA9PWUubGVuZ3RoKXJldHVybjtsZXQgcz0wLGE9MDtmb3IoOzspe2NvbnN0IHQ9ZVtzKytdLGk9ZVtzKytdLHI9e307Zm9yKGxldCB0PTA7dDxpO3QrKyl7Y29uc3QgdD1lW3MrK10saT1lW3MrK107clt0XT1pLGk+PWEmJihhPWkrMSl9aWYodGhpcy5fX3NwbGl0c1t0XT1yLHM+PWUubGVuZ3RoKWJyZWFrfWNvbnN0IGk9dGhpcy5fX251bUZsb2F0MzJFbGVtZW50cyxyPXQubG9hZEZsb2F0MzJBcnJheShhKmkpO3RoaXMuX19zcGxpdFZhbHVlcz1bXTtmb3IobGV0IHQ9MDt0PGE7dCsrKXtjb25zdCBlPXRoaXMuX19kYXRhVHlwZS5jcmVhdGVGcm9tRmxvYXQzMkFycmF5KHIuc2xpY2UodCppLHQqaStpKSk7dGhpcy5fX3NwbGl0VmFsdWVzLnB1c2goZSl9fX1jbGFzcyBFIGV4dGVuZHMgY2xhc3MgZXh0ZW5kcyBjbGFzc3tjb25zdHJ1Y3Rvcigpe3RoaXMubGlzdGVuZXJzPXt9LHRoaXMuX19pZD0rK3p9Z2V0SWQoKXtyZXR1cm4gdGhpcy5fX2lkfW9uKHQsZSl7aWYoIWUpdGhyb3cgbmV3IEVycm9yKCJNaXNzaW5nIGxpc3RlbmVyLiIpO3RoaXMubGlzdGVuZXJzW3RdfHwodGhpcy5saXN0ZW5lcnNbdF09W10pO2NvbnN0IHM9dGhpcy5saXN0ZW5lcnNbdF07aWYocy5pbmNsdWRlcyhlKSl0aHJvdyBuZXcgRXJyb3IoYExpc3RlbmVyICIke2UubmFtZX0iIGFscmVhZHkgY29ubmVjdGVkIHRvIGV2ZW50ICIke3R9Ii5gKTtjb25zdCBhPXMubGVuZ3RoO3JldHVybiBzW2FdPWUsYX1vbmNlKHQsZSl7Y29uc3Qgcz1hPT57ZShhKSx0aGlzLm9mZih0LHMpfTt0aGlzLm9uKHQscyl9b2ZmKHQsZSl7aWYoIWUpdGhyb3cgbmV3IEVycm9yKCJNaXNzaW5nIGNhbGxiYWNrIGZ1bmN0aW9uIChsaXN0ZW5lcikuIik7aWYoIm51bWJlciI9PXR5cGVvZiBlKXJldHVybiBjb25zb2xlLndhcm4oIkRlcHJlY2F0ZWQuIFVuLXJlZ2lzdGVyIHVzaW5nIHRoZSBvcmlnaW5hbCBsaXN0ZW5lciBpbnN0ZWFkLiIpLHZvaWQgdGhpcy5yZW1vdmVMaXN0ZW5lckJ5SWQodCxlKTtjb25zdCBzPXRoaXMubGlzdGVuZXJzW3RdfHxbXSxhPVtdO2lmKHMuZm9yRWFjaCgoKHQscyk9Pnt0PT09ZSYmYS5wdXNoKHMpfSkpLDA9PWEubGVuZ3RoKXRocm93IG5ldyBFcnJvcihgTGlzdGVuZXIgIiR7ZS5uYW1lfSIgaXMgbm90IGNvbm5lY3RlZCB0byAiJHt0fSIgZXZlbnRgKTtmb3IoY29uc3QgdCBvZiBhKXNbdF09dm9pZCAwfWFkZExpc3RlbmVyKHQsZSl7cmV0dXJuIGNvbnNvbGUud2FybigiRGVwcmVjYXRlZC4gVXNlICNvbiBpbnN0ZWFkLiIpLHRoaXMub24odCxlKX1yZW1vdmVMaXN0ZW5lcih0LGUpe2NvbnNvbGUud2FybigiRGVwcmVjYXRlZC4gVXNlICNvZmYgaW5zdGVhZC4iKSx0aGlzLm9mZih0LGUpfXJlbW92ZUxpc3RlbmVyQnlJZCh0LGUpe2NvbnNvbGUud2FybigiRGVwcmVjYXRlZC4gVXNlICNvZmYsIHBhc3NpbmcgdGhlIGxpc3RlbmVyIGl0c2VsZiBpbnN0ZWFkIG9mIHRoZSBpZC4iKTtjb25zdCBzPXRoaXMubGlzdGVuZXJzW3RdO2lmKHMpe2lmKCFzW2VdKXRocm93IG5ldyBFcnJvcigiSW52YWxpZCBJRCIpO3NbZV09dm9pZCAwfWVsc2UgY29uc29sZS53YXJuKCJjYWxsYmFjayA6IitlKyIgd2FzIG5vdCBjb25uZWN0ZWQgdG8gdGhpcyBzaWduYWw6Iit0KX1lbWl0KHQsZSl7KHRoaXMubGlzdGVuZXJzW3RdfHxbXSkuZm9yRWFjaCgodD0+e3QmJnQoZSl9KSl9fXtjb25zdHJ1Y3Rvcigpe3N1cGVyKCksdGhpcy5fX3BhcmFtcz1bXSx0aGlzLl9fcGFyYW1NYXBwaW5nPXt9LHRoaXMuZGVwcmVjYXRlZFBhcmFtTWFwcGluZz17fSx0aGlzLl9fcGFyYW1FdmVudEhhbmRsZXJzPXt9fW51bVBhcmFtZXRlcnMoKXtyZXR1cm4gY29uc29sZS53YXJuKCJEZXByZWNhdGVkLiBVc2UgI2dldE51bVBhcmFtZXRlcnMgaW5zdGVhZC4iKSx0aGlzLmdldE51bVBhcmFtZXRlcnMoKX1nZXROdW1QYXJhbWV0ZXJzKCl7cmV0dXJuIHRoaXMuX19wYXJhbXMubGVuZ3RofWdldFBhcmFtZXRlcnMoKXtyZXR1cm4gdGhpcy5fX3BhcmFtc31nZXRQYXJhbWV0ZXJJbmRleCh0KXtyZXR1cm4gdGhpcy5fX3BhcmFtTWFwcGluZ1t0XX1nZXRQYXJhbWV0ZXJCeUluZGV4KHQpe3JldHVybiB0aGlzLl9fcGFyYW1zW3RdfWhhc1BhcmFtZXRlcih0KXtyZXR1cm4gdCBpbiB0aGlzLl9fcGFyYW1NYXBwaW5nfWFkZFBhcmFtZXRlckRlcHJlY2F0aW9uTWFwcGluZyh0LGUpe3RoaXMuZGVwcmVjYXRlZFBhcmFtTWFwcGluZ1t0XT1lfWdldFBhcmFtZXRlcih0KXtsZXQgZT10aGlzLl9fcGFyYW1NYXBwaW5nW3RdO2lmKG51bGw9PWUpe2NvbnN0IHM9dGhpcy5kZXByZWNhdGVkUGFyYW1NYXBwaW5nW3RdO2lmKCFzKXJldHVybiBudWxsO2NvbnNvbGUud2FybihgUGFyYW1ldGVyIG5hbWUgJHt0fSBpcyBub3cgZGVwcmVjYXRlZC4gUGxlYXNlIHVzZSAke3N9IGluc3RlYWQuYCksZT10aGlzLl9fcGFyYW1NYXBwaW5nW3NdfXJldHVybiB0aGlzLl9fcGFyYW1zW2VdfV9fcGFyYW1ldGVyVmFsdWVDaGFuZ2VkKHQpe3RoaXMuZW1pdCgicGFyYW1ldGVyVmFsdWVDaGFuZ2VkIix0KX1hZGRQYXJhbWV0ZXIodCl7cmV0dXJuIHRoaXMuaW5zZXJ0UGFyYW1ldGVyKHQsdGhpcy5fX3BhcmFtcy5sZW5ndGgpfWluc2VydFBhcmFtZXRlcih0LGUpe2NvbnN0IHM9dC5nZXROYW1lKCk7bnVsbCE9dGhpcy5fX3BhcmFtTWFwcGluZ1tzXSYmKGNvbnNvbGUud2FybigiUmVwbGFjaW5nIFBhcmFtZXRlcjoiK3MpLHRoaXMucmVtb3ZlUGFyYW1ldGVyKHMpKSx0LnNldE93bmVyKHRoaXMpO2NvbnN0IGE9ZT0+e2NvbnN0IHM9e3BhcmFtOnR9O2Zvcihjb25zdCB0IGluIGUpc1t0XT1lW3RdO3RoaXMuX19wYXJhbWV0ZXJWYWx1ZUNoYW5nZWQocyl9O3Qub24oInZhbHVlQ2hhbmdlZCIsYSksdGhpcy5fX3BhcmFtRXZlbnRIYW5kbGVyc1tzXT1hLHRoaXMuX19wYXJhbXMuc3BsaWNlKGUsMCx0KTtmb3IobGV0IHQ9ZTt0PHRoaXMuX19wYXJhbXMubGVuZ3RoO3QrKyl0aGlzLl9fcGFyYW1NYXBwaW5nW3RoaXMuX19wYXJhbXNbdF0uZ2V0TmFtZSgpXT10O3JldHVybiB0aGlzLmVtaXQoInBhcmFtZXRlckFkZGVkIix7bmFtZTpzfSksdH1yZW1vdmVQYXJhbWV0ZXIodCl7aWYobnVsbD09dGhpcy5fX3BhcmFtTWFwcGluZ1t0XSl0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byByZW1vdmUgUGFyYW1ldGVyOiIrdCk7Y29uc3QgZT10aGlzLl9fcGFyYW1NYXBwaW5nW3RdO3RoaXMuX19wYXJhbXNbdGhpcy5fX3BhcmFtTWFwcGluZ1t0XV0ub2ZmKCJ2YWx1ZUNoYW5nZWQiLHRoaXMuX19wYXJhbUV2ZW50SGFuZGxlcnNbdF0pLHRoaXMuX19wYXJhbXMuc3BsaWNlKGUsMSksZGVsZXRlIHRoaXMuX19wYXJhbU1hcHBpbmdbdF07Zm9yKGxldCB0PWU7dDx0aGlzLl9fcGFyYW1zLmxlbmd0aDt0KyspdGhpcy5fX3BhcmFtTWFwcGluZ1t0aGlzLl9fcGFyYW1zW3RdLmdldE5hbWUoKV09dDt0aGlzLmVtaXQoInBhcmFtZXRlclJlbW92ZWQiLHtuYW1lOnR9KX1yZXBsYWNlUGFyYW1ldGVyKHQpe2NvbnN0IGU9dC5nZXROYW1lKCk7aWYobnVsbD09dGhpcy5fX3BhcmFtTWFwcGluZ1tlXSl0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byByZXBsYWNlIFBhcmFtZXRlcjoiK3BhcmFtTmFtZSk7Y29uc3Qgcz10aGlzLl9fcGFyYW1NYXBwaW5nW2VdO3JldHVybiB0aGlzLnJlbW92ZVBhcmFtZXRlcihlKSx0aGlzLmluc2VydFBhcmFtZXRlcih0LHMpLHR9dG9KU09OKHQpe2NvbnN0IGU9e30scz17fTtsZXQgYT0wO2Zvcihjb25zdCBlIG9mIHRoaXMuX19wYXJhbXMpe2NvbnN0IGk9ZS50b0pTT04odCk7aSYmKHNbZS5nZXROYW1lKCldPWksYSsrKX1yZXR1cm4gYT4wJiYoZS5wYXJhbXM9cyksZX1mcm9tSlNPTih0LGUpe2lmKHQucGFyYW1zKWZvcihjb25zdCBzIGluIHQucGFyYW1zKXtjb25zdCBhPXQucGFyYW1zW3NdLGk9dGhpcy5nZXRQYXJhbWV0ZXIocyk7aT9hLnBhcmFtUGF0aD9lLnJlc29sdmVQYXRoKGEucGFyYW1QYXRoLCh0PT57dGhpcy5yZXBsYWNlUGFyYW1ldGVyKHQpfSksKHQ9Pntjb25zb2xlLndhcm4oIlVuYWJsZSB0byByZXNvbHZlIHNoYXJlZCBwYXJhbWV0ZXI6IithLnBhcmFtUGF0aCl9KSk6aS5mcm9tSlNPTihhLGUpOmNvbnNvbGUud2FybigiUGFyYW0gbm90IGZvdW5kOiIrcyl9fXJlYWRCaW5hcnkodCxlKXtpZihlLnZlcnNpb25zWyJ6ZWEtZW5naW5lIl0uY29tcGFyZShbMCwwLDNdKT49MCl7Y29uc3Qgcz10LmxvYWRVSW50MzIoKTtmb3IobGV0IGE9MDthPHM7YSsrKXtjb25zdCBzPXQubG9hZFN0cigpLGE9dC5sb2FkU3RyKCk7bGV0IGk9dGhpcy5nZXRQYXJhbWV0ZXIoYSk7aWYoIWkpe2lmKGk9XyhzLGEpLCFpKXtjb25zb2xlLmVycm9yKCJVbmFibGUgdG8gY29uc3RydWN0IHByb3A6IithKyIgb2YgdHlwZToiK3MpO2NvbnRpbnVlfXRoaXMuYWRkUGFyYW1ldGVyKGkpfWkucmVhZEJpbmFyeSh0LGUpfX19dG9TdHJpbmcoKXtyZXR1cm4gSlNPTi5zdHJpbmdpZnkodGhpcy50b0pTT04oKSxudWxsLDIpfWNvcHlGcm9tKHQsZSl7bGV0IHM9dC5nZXROdW1QYXJhbWV0ZXJzKCk7Zm9yKDtzLS07KXtjb25zdCBhPXQuZ2V0UGFyYW1ldGVyQnlJbmRleChzKSxpPXRoaXMuZ2V0UGFyYW1ldGVyKGEuZ2V0TmFtZSgpKTtpP2kubG9hZFZhbHVlKGEuZ2V0VmFsdWUoKSk6dGhpcy5hZGRQYXJhbWV0ZXIoYS5jbG9uZShlKSl9fX17Y29uc3RydWN0b3IoKXtzdXBlcigpLHRoaXMuX19udW1WZXJ0aWNlcz0wLHRoaXMuX19ib3VuZGluZ0JveD1uZXcgRix0aGlzLl9fYm91bmRpbmdCb3hEaXJ0eT0hMCx0aGlzLl9fdmVydGV4QXR0cmlidXRlcz1uZXcgTWFwLHRoaXMuX19tZXRhRGF0YT1uZXcgTWFwLHRoaXMuYWRkVmVydGV4QXR0cmlidXRlKCJwb3NpdGlvbnMiLGwsMCl9Y2xlYXIoKXt0aGlzLnNldE51bVZlcnRpY2VzKDApfXNldERlYnVnTmFtZSh0KXt0aGlzLl9fbmFtZT10fWFkZFZlcnRleEF0dHJpYnV0ZSh0LGUscyl7Y29uc3QgYT10aGlzLmdldFZlcnRleEF0dHJpYnV0ZSgicG9zaXRpb25zIik7bGV0IGk7dmFyIHI7cmV0dXJuIGk9KHI9cykmJnZvaWQgMCE9PXIuYnl0ZUxlbmd0aD9uZXcgQShlLHMpOm5ldyBBKGUsbnVsbCE9YT9hLmxlbmd0aDowLHMpLHRoaXMuX192ZXJ0ZXhBdHRyaWJ1dGVzLnNldCh0LGkpLGl9aGFzVmVydGV4QXR0cmlidXRlKHQpe3JldHVybiB0aGlzLl9fdmVydGV4QXR0cmlidXRlcy5oYXModCl9Z2V0VmVydGV4QXR0cmlidXRlKHQpe3JldHVybiB0aGlzLl9fdmVydGV4QXR0cmlidXRlcy5nZXQodCl9Z2V0VmVydGV4QXR0cmlidXRlcygpe2NvbnN0IHQ9e307Zm9yKGNvbnN0W2Usc11vZiB0aGlzLl9fdmVydGV4QXR0cmlidXRlcy5lbnRyaWVzKCkpdFtlXT1zO3JldHVybiB0fWdldCB2ZXJ0aWNlcygpe3JldHVybiBjb25zb2xlLndhcm4oImRlcHJlY2F0ZWQgdXNlICNnZXRWZXJ0ZXhBdHRyaWJ1dGUoJ3Bvc2l0aW9ucycpIiksdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMuZ2V0KCJwb3NpdGlvbnMiKX1udW1WZXJ0aWNlcygpe3JldHVybiB0aGlzLl9fbnVtVmVydGljZXN9Z2V0TnVtVmVydGljZXMoKXtyZXR1cm4gdGhpcy5fX251bVZlcnRpY2VzfXNldE51bVZlcnRpY2VzKHQpe3RoaXMuX19udW1WZXJ0aWNlcz10LHRoaXMuX192ZXJ0ZXhBdHRyaWJ1dGVzLmZvckVhY2goKHQ9PnQucmVzaXplKHRoaXMuX19udW1WZXJ0aWNlcykpKSx0aGlzLnNldEJvdW5kaW5nQm94RGlydHkoKX1nZXRWZXJ0ZXgodCl7cmV0dXJuIGNvbnNvbGUud2FybigiZGVwcmVjYXRlZCB1c2UgI2dldFZlcnRleEF0dHJpYnV0ZSgncG9zaXRpb25zJykuZ2V0VmFsdWVSZWYoKSIpLGwuY3JlYXRlRnJvbUJ1ZmZlcih0aGlzLnZlcnRpY2VzLmRhdGEuYnVmZmVyLDMqdCo0KX1zZXRWZXJ0ZXgodCxlKXtyZXR1cm4gY29uc29sZS53YXJuKCJkZXByZWNhdGVkIHVzZSAjZ2V0VmVydGV4QXR0cmlidXRlKCdwb3NpdGlvbnMnKS5nZXRWYWx1ZVJlZigpLnNldEZyb21PdGhlcih2YWx1ZSkiKSxsLmNyZWF0ZUZyb21CdWZmZXIodGhpcy52ZXJ0aWNlcy5kYXRhLmJ1ZmZlciwzKnQqNCkuc2V0RnJvbU90aGVyKGUpfW1vdmVWZXJ0aWNlcyh0KXtjb25zb2xlLndhcm4oImRlcHJlY2F0ZWQgdXNlICNnZXRWZXJ0ZXhBdHRyaWJ1dGUoJ3Bvc2l0aW9ucycpLmdldFZhbHVlUmVmKCkiKTtjb25zdCBlPXRoaXMudmVydGljZXM7Zm9yKGxldCBzPTA7czxlLmxlbmd0aDtzKyspZS5nZXRWYWx1ZVJlZihzKS5hZGRJblBsYWNlKHQpO3RoaXMuc2V0Qm91bmRpbmdCb3hEaXJ0eSgpfXRyYW5zZm9ybVZlcnRpY2VzKHQpe2NvbnNvbGUud2FybigiZGVwcmVjYXRlZCwgcGxlYXNlIHRyYW5zZm9ybSB0aGUgdmVydGljZXMgbWFudWFsbHkiKTtjb25zdCBlPXRoaXMuX192ZXJ0ZXhBdHRyaWJ1dGVzLmdldCgicG9zaXRpb25zIik7Zm9yKGxldCBzPTA7czxlLmxlbmd0aDtzKyspe2NvbnN0IGE9ZS5nZXRWYWx1ZVJlZihzKSxpPXQudHJhbnNmb3JtVmVjMyhhKTthLnNldChpLngsaS55LGkueil9dGhpcy5zZXRCb3VuZGluZ0JveERpcnR5KCl9Z2V0IGJvdW5kaW5nQm94KCl7cmV0dXJuIGNvbnNvbGUud2FybigiZGVwcmVjYXRlZCwgcGxlYXNlIHVzZSAjZ2V0Qm91bmRpbmdCb3goKSIpLHRoaXMuX19ib3VuZGluZ0JveERpcnR5JiZ0aGlzLnVwZGF0ZUJvdW5kaW5nQm94KCksdGhpcy5fX2JvdW5kaW5nQm94fWdldEJvdW5kaW5nQm94KCl7cmV0dXJuIHRoaXMuX19ib3VuZGluZ0JveERpcnR5JiZ0aGlzLnVwZGF0ZUJvdW5kaW5nQm94KCksdGhpcy5fX2JvdW5kaW5nQm94fXNldEJvdW5kaW5nQm94RGlydHkoKXt0aGlzLl9fYm91bmRpbmdCb3hEaXJ0eXx8KHRoaXMuX19ib3VuZGluZ0JveERpcnR5PSEwLHRoaXMuZW1pdCgiYm91bmRpbmdCb3hDaGFuZ2VkIix7fSkpfXVwZGF0ZUJvdW5kaW5nQm94KCl7Y29uc3QgdD10aGlzLmdldFZlcnRleEF0dHJpYnV0ZSgicG9zaXRpb25zIiksZT1uZXcgRixzPXQubGVuZ3RoO2ZvcihsZXQgYT0wO2E8czthKyspZS5hZGRQb2ludCh0LmdldFZhbHVlUmVmKGEpKTt0aGlzLl9fYm91bmRpbmdCb3g9ZSx0aGlzLl9fYm91bmRpbmdCb3hEaXJ0eT0hMX1nZXRNZXRhZGF0YSh0KXtyZXR1cm4gdGhpcy5fX21ldGFEYXRhLmdldCh0KX1oYXNNZXRhZGF0YSh0KXtyZXR1cm4gdGhpcy5fX21ldGFEYXRhLmhhcyh0KX1zZXRNZXRhZGF0YSh0LGUpe3RoaXMuX19tZXRhRGF0YS5zZXQodCxlKX1kZWxldGVNZXRhZGF0YSh0KXt0aGlzLl9fbWV0YURhdGEuZGVsZXRlKHQpfWdlbkJ1ZmZlcnModCl7Y29uc3QgZT17fTtmb3IoY29uc3RbdCxzXW9mIHRoaXMuX192ZXJ0ZXhBdHRyaWJ1dGVzKWVbdF09e3ZhbHVlczpzLmRhdGEsY291bnQ6cy5sZW5ndGgsZGF0YVR5cGU6cy5kYXRhVHlwZSxub3JtYWxpemVkOnMubm9ybWFsaXplZH07cmV0dXJue251bVZlcnRpY2VzOnRoaXMubnVtVmVydGljZXMoKSxhdHRyQnVmZmVyczplfX1sb2FkQmFzZUdlb21CaW5hcnkodCl7dGhpcy5uYW1lPXQubG9hZFN0cigpO2NvbnN0IGU9dC5sb2FkVUludDgoKTt0aGlzLmRlYnVnQ29sb3I9dC5sb2FkUkdCRmxvYXQzMkNvbG9yKCk7Y29uc3Qgcz10LmxvYWRVSW50MzIoKTt0aGlzLl9fYm91bmRpbmdCb3guc2V0KHQubG9hZEZsb2F0MzJWZWMzKCksdC5sb2FkRmxvYXQzMlZlYzMoKSksdGhpcy5zZXROdW1WZXJ0aWNlcyhzKTtjb25zdCBhPXRoaXMuZ2V0VmVydGV4QXR0cmlidXRlKCJwb3NpdGlvbnMiKTtsZXQgaSxyOzImZSYmKGk9dGhpcy5nZXRWZXJ0ZXhBdHRyaWJ1dGUoIm5vcm1hbHMiKSxpfHwoaT10aGlzLmFkZFZlcnRleEF0dHJpYnV0ZSgibm9ybWFscyIsbCwwKSkpLDQmZSYmKHI9dGhpcy5nZXRWZXJ0ZXhBdHRyaWJ1dGUoInRleENvb3JkcyIpLHJ8fChyPXRoaXMuYWRkVmVydGV4QXR0cmlidXRlKCJ0ZXhDb29yZHMiLGQsMCkpKTtjb25zdCBuPSh0LGUscyxpKT0+e2ZvcihsZXQgcj10WzBdO3I8dFsxXTtyKyspe2NvbnN0IHQ9bmV3IGwoaVszKnIrMF0vMjU1LGlbMypyKzFdLzI1NSxpWzMqcisyXS8yNTUpO3QubXVsdGlwbHlJblBsYWNlKHMpLHQuYWRkSW5QbGFjZShlKSxhLnNldFZhbHVlKHIsdCl9fSxoPSh0LGUscyxhKT0+e3MuaXNOdWxsKCkmJnMuc2V0KDEsMSwxKTtmb3IobGV0IHI9dFswXTtyPHRbMV07cisrKXtjb25zdCB0PW5ldyBsKGFbMypyKzBdLzI1NSxhWzMqcisxXS8yNTUsYVszKnIrMl0vMjU1KTt0Lm11bHRpcGx5SW5QbGFjZShzKSx0LmFkZEluUGxhY2UoZSksdC5ub3JtYWxpemVJblBsYWNlKCksaS5zZXRWYWx1ZShyLHQpfX0sbz0odCxlLHMsYSk9Pntmb3IobGV0IGk9dFswXTtpPHRbMV07aSsrKXtjb25zdCB0PW5ldyBkKGFbMippKzBdLzI1NSxhWzIqaSsxXS8yNTUpO3QubXVsdGlwbHlJblBsYWNlKHMpLHQuYWRkSW5QbGFjZShlKSxyLnNldFZhbHVlKGksdCl9fSxfPXQubG9hZFVJbnQzMigpO2lmKDE9PV8pe3tjb25zdCBlPXRoaXMuX19ib3VuZGluZ0JveCxhPXQubG9hZFVJbnQ4QXJyYXkoMypzKTtuKFswLHNdLGUucDAsZS5kaWFnb25hbCgpLGEpfWlmKGkpe2NvbnN0IGU9bmV3IEYodC5sb2FkRmxvYXQzMlZlYzMoKSx0LmxvYWRGbG9hdDMyVmVjMygpKSxhPXQubG9hZFVJbnQ4QXJyYXkoMypzKTtoKFswLHNdLGUucDAsZS5kaWFnb25hbCgpLGEpLGkubG9hZFNwbGl0VmFsdWVzKHQpfWlmKHIpe2NvbnN0IGU9bmV3IEkodC5sb2FkRmxvYXQzMlZlYzIoKSx0LmxvYWRGbG9hdDMyVmVjMigpKSxhPXQubG9hZFVJbnQ4QXJyYXkoMipzKTtvKFswLHNdLGUucDAsZS5kaWFnb25hbCgpLGEpLHIubG9hZFNwbGl0VmFsdWVzKHQpfX1lbHNle2NvbnN0IGU9W107bGV0IGE9MDtmb3IobGV0IHM9MDtzPF87cysrKXtjb25zdCBzPXQubG9hZFVJbnQzMigpLG49e3JhbmdlOlthLGErc10sYmJveDpuZXcgRih0LmxvYWRGbG9hdDMyVmVjMygpLHQubG9hZEZsb2F0MzJWZWMzKCkpfTtpJiYobi5ub3JtYWxzUmFuZ2U9bmV3IEYodC5sb2FkRmxvYXQzMlZlYzMoKSx0LmxvYWRGbG9hdDMyVmVjMygpKSksciYmKG4udGV4Q29vcmRzUmFuZ2U9bmV3IEkodC5sb2FkRmxvYXQzMlZlYzIoKSx0LmxvYWRGbG9hdDMyVmVjMigpKSksZS5wdXNoKG4pLGErPXN9Y29uc3QgZD10LmxvYWRVSW50OEFycmF5KDMqcyk7bGV0IGwsYztpJiYobD10LmxvYWRVSW50OEFycmF5KDMqcykpLHImJihjPXQubG9hZFVJbnQ4QXJyYXkoMipzKSk7Zm9yKGxldCB0PTA7dDxfO3QrKyl7e2NvbnN0IHM9ZVt0XS5iYm94O24oZVt0XS5yYW5nZSxzLnAwLHMuZGlhZ29uYWwoKSxkKX1pZihpKXtjb25zdCBzPWVbdF0ubm9ybWFsc1JhbmdlO2goZVt0XS5yYW5nZSxzLnAwLHMuZGlhZ29uYWwoKSxsKX1pZihyKXtjb25zdCBzPWVbdF0udGV4Q29vcmRzUmFuZ2U7byhlW3RdLnJhbmdlLHMucDAscy5kaWFnb25hbCgpLGMpfX1pJiZpLmxvYWRTcGxpdFZhbHVlcyh0KSxyJiZyLmxvYWRTcGxpdFZhbHVlcyh0KX19dG9KU09OKHQpe2xldCBlPXN1cGVyLnRvSlNPTih0KTtlfHwoZT17fSksZS50eXBlPW8odGhpcyksdCYmdC5za2lwVG9wb2xvZ3l8fChlLm51bVZlcnRpY2VzPXRoaXMuX19udW1WZXJ0aWNlc3x8MCk7Y29uc3Qgcz17fTtmb3IoY29uc3RbZSxhXW9mIHRoaXMuX192ZXJ0ZXhBdHRyaWJ1dGVzLmVudHJpZXMoKSl0JiYic2tpcEF0dHJpYnV0ZXMiaW4gdCYmdC5za2lwQXR0cmlidXRlcy5pbmNsdWRlcyhlKXx8KHNbZV09YS50b0pTT04odCkpO3JldHVybiBlLnZlcnRleEF0dHJpYnV0ZXM9cyxlfWZyb21KU09OKHQsZSl7aWYodGhpcy5jbGVhcigpLHN1cGVyLmZyb21KU09OKHQsZSksdC5udW1WZXJ0aWNlcyYmdGhpcy5zZXROdW1WZXJ0aWNlcyh0Lm51bVZlcnRpY2VzKSx0LnZlcnRleEF0dHJpYnV0ZXMpZm9yKGNvbnN0IGUgaW4gdC52ZXJ0ZXhBdHRyaWJ1dGVzKXtsZXQgcz10aGlzLl9fdmVydGV4QXR0cmlidXRlcy5nZXQoZSk7Y29uc3QgYT10LnZlcnRleEF0dHJpYnV0ZXNbZV07aWYoIXMpe2NvbnN0IHQ9aChhLmRhdGFUeXBlKTtzPW5ldyBNKHRoaXMsdCwwLGEuZGVmYXVsdFNjYWxhclZhbHVlKSx0aGlzLl9fdmVydGV4QXR0cmlidXRlcy5zZXQoZSxzKX1zLmZyb21KU09OKGEpfXRoaXMuZW1pdCgiZ2VvbURhdGFUb3BvbG9neUNoYW5nZWQiKX10b1N0cmluZygpe3JldHVybiBKU09OLnN0cmluZ2lmeSh0aGlzLnRvSlNPTigpLG51bGwsMil9fWNsYXNzIFMgZXh0ZW5kcyBFe2NvbnN0cnVjdG9yKCl7c3VwZXIoKX1jbGVhcigpe3RoaXMuc2V0TnVtVmVydGljZXMoMCksdGhpcy5lbWl0KCJnZW9tRGF0YVRvcG9sb2d5Q2hhbmdlZCIpfWxvYWRCaW4odCl7dGhpcy5uYW1lPXQubG9hZFN0cigpO2NvbnN0IGU9dC5sb2FkVUludDMyKCk7dGhpcy5fX2JvdW5kaW5nQm94LnNldCh0LmxvYWRGbG9hdDMyVmVjMygpLHQubG9hZEZsb2F0MzJWZWMzKCkpLHRoaXMuc2V0TnVtVmVydGljZXMoZSk7Y29uc3Qgcz10aGlzLmdldFZlcnRleEF0dHJpYnV0ZSgicG9zaXRpb25zIik7aWYoZTwyNTYpe2NvbnN0IGE9dGhpcy5fX2JvdW5kaW5nQm94LnRvTWF0NCgpLGk9dC5sb2FkVUludDhBcnJheSgzKmUpO2ZvcihsZXQgdD0wO3Q8ZTt0Kyspe2NvbnN0IGU9bmV3IFZlYzMoaVszKnQrMF0vMjU1LGlbMyp0KzFdLzI1NSxpWzMqdCsyXS8yNTUpO3Muc2V0VmFsdWUodCxhLnRyYW5zZm9ybVZlYzMoZSkpfX1lbHNle2NvbnN0IGE9dC5sb2FkVUludDMyKCksaT1bXTtmb3IobGV0IGU9MDtlPGE7ZSsrKXtjb25zdCBlPXQubG9hZFVJbnQzMlZlYzIoKSxzPXQubG9hZEZsb2F0MzJWZWMzKCksYT10LmxvYWRGbG9hdDMyVmVjMygpO2kucHVzaCh7cmFuZ2U6ZSxiYm94Om5ldyBCb3gzKHMsYSl9KX1jb25zdCByPXQubG9hZFVJbnQ4QXJyYXkoMyplKTtmb3IobGV0IHQ9MDt0PGE7dCsrKXtjb25zdCBlPWlbdF0uYmJveC50b01hdDQoKTtmb3IobGV0IGE9aVt0XS5yYW5nZS54O2E8aVt0XS5yYW5nZS55O2ErKyl7Y29uc3QgdD1uZXcgVmVjMyhyWzMqYSswXS8yNTUsclszKmErMV0vMjU1LHJbMyphKzJdLzI1NSk7cy5zZXRWYWx1ZShhLGUudHJhbnNmb3JtVmVjMyh0KSl9fX19cmVhZEJpbmFyeSh0LGUpe3N1cGVyLmxvYWRCYXNlR2VvbUJpbmFyeSh0KSx0aGlzLmVtaXQoImdlb21EYXRhQ2hhbmdlZCIse30pfX1uKCJQb2ludHMiLFMpO2NsYXNzIE8gZXh0ZW5kcyBFe2NvbnN0cnVjdG9yKCl7c3VwZXIoKSx0aGlzLl9faW5kaWNlcz1uZXcgVWludDMyQXJyYXl9Y2xlYXIoKXtzdXBlci5jbGVhcigpLHRoaXMuc2V0TnVtU2VnbWVudHMoMCksdGhpcy5lbWl0KCJnZW9tRGF0YVRvcG9sb2d5Q2hhbmdlZCIpfWdldEluZGljZXMoKXtyZXR1cm4gdGhpcy5fX2luZGljZXN9Z2V0TnVtU2VnbWVudHMoKXtyZXR1cm4gdGhpcy5fX2luZGljZXMubGVuZ3RoLzJ9c2V0TnVtU2VnbWVudHModCl7aWYodD50aGlzLmdldE51bVNlZ21lbnRzKCkpe2NvbnN0IGU9bmV3IFVpbnQzMkFycmF5KDIqdCk7ZS5zZXQodGhpcy5fX2luZGljZXMpLHRoaXMuX19pbmRpY2VzPWV9ZWxzZSB0aGlzLl9faW5kaWNlcz10aGlzLl9faW5kaWNlcy5zbGljZSgwLDIqdCl9c2V0U2VnbWVudFZlcnRleEluZGljZXModCxlLHMpe2lmKHQ+PXRoaXMuX19pbmRpY2VzLmxlbmd0aC8yKXRocm93IG5ldyBFcnJvcigiSW52YWxpZCBsaW5lIGluZGV4OiAiK3QrIi4gTnVtIFNlZ21lbnRzOiAiK3RoaXMuX19pbmRpY2VzLmxlbmd0aC8yKTt0aGlzLl9faW5kaWNlc1syKnQrMF09ZSx0aGlzLl9faW5kaWNlc1syKnQrMV09c31zZXRTZWdtZW50KHQsZSxzKXtjb25zb2xlLndhcm4oImRlcHJlY2F0ZWQgdXNlICNzZXRTZWdtZW50VmVydGV4SW5kaWNlcyIpLHRoaXMuc2V0U2VnbWVudFZlcnRleEluZGljZXModCxlLHMpfWdldFNlZ21lbnRWZXJ0ZXhJbmRleCh0LGUpe2lmKHQ8dGhpcy5nZXROdW1TZWdtZW50cygpKXJldHVybiB0aGlzLl9faW5kaWNlc1syKnQrZV19Z2VuQnVmZmVycygpe2NvbnN0IHQ9c3VwZXIuZ2VuQnVmZmVycygpO2xldCBlO3JldHVybiBlPXQubnVtVmVydGljZXM8TWF0aC5wb3coMiw4KT9uZXcgVWludDhBcnJheSh0aGlzLl9faW5kaWNlcyk6dC5udW1WZXJ0aWNlczxNYXRoLnBvdygyLDE2KT9uZXcgVWludDE2QXJyYXkodGhpcy5fX2luZGljZXMpOnRoaXMuX19pbmRpY2VzLHQuaW5kaWNlcz1lLHR9cmVhZEJpbmFyeSh0LGUpe3N1cGVyLmxvYWRCYXNlR2VvbUJpbmFyeSh0KSx0aGlzLnNldE51bVNlZ21lbnRzKHQubG9hZFVJbnQzMigpKTtjb25zdCBzPXQubG9hZFVJbnQ4KCk7MT09cz90aGlzLl9faW5kaWNlcz10LmxvYWRVSW50OEFycmF5KCk6Mj09cz90aGlzLl9faW5kaWNlcz10LmxvYWRVSW50MTZBcnJheSgpOjQ9PXMmJih0aGlzLl9faW5kaWNlcz10LmxvYWRVSW50MzJBcnJheSgpKSx0aGlzLmVtaXQoImdlb21EYXRhQ2hhbmdlZCIse30pfXRvSlNPTih0KXtjb25zdCBlPXN1cGVyLnRvSlNPTih0KTtyZXR1cm4gdCYmdC5za2lwVG9wb2xvZ3l8fChlLmluZGljZXM9QXJyYXkuZnJvbSh0aGlzLl9faW5kaWNlcykpLGV9ZnJvbUpTT04odCxlKXtzdXBlci5mcm9tSlNPTih0LGUpLHQuaW5kaWNlcyYmKHRoaXMuX19pbmRpY2VzPVVpbnQzMkFycmF5LmZyb20odC5pbmRpY2VzKSl9fW4oIkxpbmVzIixPKTtjbGFzcyBQIGV4dGVuZHMgRXtjb25zdHJ1Y3Rvcigpe3N1cGVyKCksdGhpcy5fX2ZhY2VDb3VudHM9W10sdGhpcy5fX2ZhY2VWZXJ0ZXhJbmRpY2VzPW5ldyBVaW50MzJBcnJheSx0aGlzLl9fZmFjZUF0dHJpYnV0ZXM9bmV3IE1hcCx0aGlzLl9fZWRnZUF0dHJpYnV0ZXM9bmV3IE1hcCx0aGlzLl9fbG9nVG9wb2xvZ3lXYXJuaW5ncz0hMSx0aGlzLmVkZ2VWZXJ0cz12b2lkIDAsdGhpcy52ZXJ0ZXhFZGdlcz12b2lkIDAsdGhpcy5udW1FZGdlcz0wLHRoaXMuZWRnZUFuZ2xlcz1uZXcgRmxvYXQzMkFycmF5LHRoaXMuZWRnZVZlY3M9W119aW5pdCgpe31jbGVhcigpe3N1cGVyLmNsZWFyKCksdGhpcy5lZGdlVmVydHM9dm9pZCAwLHRoaXMudmVydGV4RWRnZXM9dm9pZCAwLHRoaXMubnVtRWRnZXM9MCx0aGlzLmVkZ2VBbmdsZXM9bmV3IEZsb2F0MzJBcnJheSx0aGlzLmVtaXQoImdlb21EYXRhVG9wb2xvZ3lDaGFuZ2VkIil9Z2V0RmFjZUNvdW50cygpe3JldHVybiB0aGlzLl9fZmFjZUNvdW50c31nZXROdW1GYWNlcygpe3JldHVybiAwPT10aGlzLl9fZmFjZUNvdW50cy5sZW5ndGg/MDp0aGlzLl9fZmFjZUNvdW50cy5yZWR1Y2UoKCh0LGUpPT50K2UpKX1zZXRGYWNlQ291bnRzKHQpe2xldCBlPTAscz0wLGE9Mztmb3IoY29uc3QgaSBvZiB0KWUrPWkscys9aSphLGErKztpZigwPT10aGlzLmdldE51bUZhY2VzKCkpdGhpcy5fX2ZhY2VWZXJ0ZXhJbmRpY2VzPW5ldyBVaW50MzJBcnJheShzKTtlbHNle2NvbnN0IGU9bmV3IFVpbnQzMkFycmF5KHMpO2xldCBpPTAscj0wO3M9MCxhPTMsdC5mb3JFYWNoKCgodCxzKT0+e2NvbnN0IG49aStNYXRoLm1pbih0LHRoaXMuX19mYWNlQ291bnRzW3NdKSphO2Uuc2V0KHRoaXMuX19mYWNlVmVydGV4SW5kaWNlcy5zbGljZShpLG4pLHIpLGkrPXRoaXMuX19mYWNlQ291bnRzW3NdKmEscis9dCphLGErK30pKSx0aGlzLl9fZmFjZVZlcnRleEluZGljZXM9ZX10aGlzLl9fZmFjZUNvdW50cz10LHRoaXMuX19mYWNlQXR0cmlidXRlcy5mb3JFYWNoKCh0PT57dC5yZXNpemUoZSl9KSl9Z2V0RmFjZVZlcnRleENvdW50KHQpe2xldCBlPTAscz0wO3JldHVybiB0aGlzLl9fZmFjZUNvdW50cy5zb21lKCgoYSxpKT0+e2lmKGUrPWEsZT50KXJldHVybiBzPWkrMywhMH0pKSxzfWdldEZhY2VWZXJ0ZXhPZmZzZXQodCl7bGV0IGU9MCxzPTA7cmV0dXJuIHRoaXMuX19mYWNlQ291bnRzLnNvbWUoKChhLGkpPT57aWYoZSthPnQpcmV0dXJuIHMrPSh0LWUpKihpKzMpLCEwO2UrPWEscys9YSooaSszKX0pKSxzfXNldEZhY2VWZXJ0ZXhJbmRpY2VzKHQsZSl7MiE9YXJndW1lbnRzLmxlbmd0aCYmKGNvbnNvbGUud2FybigiZGVwcmVjYXRlZCBpbnRlcmZhY2UuIFBsZWFzZSBwYXNzIHZlcnRleEluZGljZXMgYXMgYW4gYXJyYXkiKSxlPUFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywxKSk7Y29uc3Qgcz10aGlzLmdldEZhY2VWZXJ0ZXhDb3VudCh0KTtpZihlLmxlbmd0aCE9cyl0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgaW5kaWNlcyBmb3IgZmFjZToke3R9IHZlcnRleEluZGljZXM6JHtlfS4gRXhwZWN0ZWQgJHtzfSBpbmRpY2VzYCk7Y29uc3QgYT10aGlzLmdldEZhY2VWZXJ0ZXhPZmZzZXQodCk7dGhpcy5fX2ZhY2VWZXJ0ZXhJbmRpY2VzLnNldChlLGEpfWFkZEZhY2UodCl7Y29uc3QgZT1bLi4udGhpcy5fX2ZhY2VDb3VudHNdO2lmKGUubGVuZ3RoPD10Lmxlbmd0aC0zKXtmb3IobGV0IHM9ZS5sZW5ndGg7czx0Lmxlbmd0aC0zO3MrKyllW3NdPTA7ZVt0Lmxlbmd0aC0zXT0xfWVsc2UgZVt0Lmxlbmd0aC0zXSsrO3RoaXMuc2V0RmFjZUNvdW50cyhlKTtsZXQgcz0wLGE9MDtyZXR1cm4gdGhpcy5fX2ZhY2VDb3VudHMuc29tZSgoKGUsaSk9PntpZihpKzM9PXQubGVuZ3RoKXJldHVybiBzKz1lLTEsYSs9KGUtMSkqKGkrMyksITA7cys9ZSxhKz1lKihpKzMpfSkpLHRoaXMuX19mYWNlVmVydGV4SW5kaWNlcy5zZXQodCxhKSxzfWdldEZhY2VWZXJ0ZXhJbmRpY2VzKHQpe2NvbnN0IGU9W10scz10aGlzLmdldEZhY2VWZXJ0ZXhPZmZzZXQodCksYT10aGlzLmdldEZhY2VWZXJ0ZXhDb3VudCh0KTtmb3IobGV0IHQ9MDt0PGE7dCsrKWUucHVzaCh0aGlzLl9fZmFjZVZlcnRleEluZGljZXNbcyt0XSk7cmV0dXJuIGV9Z2V0RmFjZVZlcnRleEluZGV4KHQsZSl7Y29uc3Qgcz10aGlzLmdldEZhY2VWZXJ0ZXhPZmZzZXQodCk7cmV0dXJuIHRoaXMuX19mYWNlVmVydGV4SW5kaWNlc1tzK2VdfWFkZFZlcnRleEF0dHJpYnV0ZSh0LGUscyl7Y29uc3QgYT10aGlzLmdldFZlcnRleEF0dHJpYnV0ZSgicG9zaXRpb25zIiksaT1uZXcgTSh0aGlzLGUsbnVsbCE9YT9hLmxlbmd0aDowLHMpO3JldHVybiB0aGlzLl9fdmVydGV4QXR0cmlidXRlcy5zZXQodCxpKSxpfWFkZEZhY2VBdHRyaWJ1dGUodCxlLHMpe2NvbnN0IGE9bmV3IEEoZSxudWxsIT1zP3M6dGhpcy5nZXROdW1GYWNlcygpKTtyZXR1cm4gdGhpcy5fX2ZhY2VBdHRyaWJ1dGVzLnNldCh0LGEpLGF9aGFzRmFjZUF0dHJpYnV0ZSh0KXtyZXR1cm4gdGhpcy5fX2ZhY2VBdHRyaWJ1dGVzLmhhcyh0KX1nZXRGYWNlQXR0cmlidXRlKHQpe3JldHVybiB0aGlzLl9fZmFjZUF0dHJpYnV0ZXMuZ2V0KHQpfWFkZEVkZ2VBdHRyaWJ1dGUodCxlLHMpe2NvbnN0IGE9bmV3IEEoZSxudWxsIT1zP3M6dGhpcy5nZXROdW1FZGdlcygpKTtyZXR1cm4gdGhpcy5fX2VkZ2VBdHRyaWJ1dGVzLnNldCh0LGEpLGF9aGFzRWRnZUF0dHJpYnV0ZSh0KXtyZXR1cm4gdGhpcy5fX2VkZ2VBdHRyaWJ1dGVzLmhhcyh0KX1nZXRFZGdlQXR0cmlidXRlKHQpe3JldHVybiB0aGlzLl9fZWRnZUF0dHJpYnV0ZXMuZ2V0KHQpfWdlblRvcG9sb2d5SW5mbygpe2NvbnN0IHQ9e307dGhpcy52ZXJ0ZXhFZGdlcz1bXSx0aGlzLmVkZ2VGYWNlcz1bXSx0aGlzLmVkZ2VWZXJ0cz1bXSx0aGlzLmZhY2VFZGdlcz1bXSx0aGlzLm51bUVkZ2VzPTA7Y29uc3QgZT10aGlzLmdldFZlcnRleEF0dHJpYnV0ZSgicG9zaXRpb25zIikscz0ocyxhKT0+e2xldCBpPXMscj1hO2lmKHI8aSl7Y29uc3QgdD1pO2k9cixyPXR9Y29uc3Qgbj1pKyI+IityO2lmKG4gaW4gdClyZXR1cm4gdFtuXTtjb25zdCBoPWUuZ2V0VmFsdWVSZWYoaSksbz1lLmdldFZhbHVlUmVmKHIpLnN1YnRyYWN0KGgpLF89e2VkZ2VJbmRleDp0aGlzLmVkZ2VGYWNlcy5sZW5ndGgvMixlZGdlVmVjOm99O3JldHVybiB0W25dPV8sdGhpcy5lZGdlRmFjZXMucHVzaCgtMSksdGhpcy5lZGdlRmFjZXMucHVzaCgtMSksdGhpcy5lZGdlVmVydHMucHVzaChpKSx0aGlzLmVkZ2VWZXJ0cy5wdXNoKHIpLHRoaXMubnVtRWRnZXMrKyxffSxhPSh0LGUsYSk9Pntjb25zdCBpPXModCxlKS5lZGdlSW5kZXg7aWYoZTx0KXtjb25zdCB0PTIqaSswO3RoaXMuX19sb2dUb3BvbG9neVdhcm5pbmdzJiYtMSE9dGhpcy5lZGdlRmFjZXNbdF0mJmNvbnNvbGUud2FybigiRWRnZSBwb2x5IDAgYWxyZWFkeSBzZXQuIE1lc2ggaXMgbm9uLW1hbmlmb2xkLiIpLHRoaXMuZWRnZUZhY2VzW3RdPWF9ZWxzZXtjb25zdCB0PTIqaSsxO3RoaXMuX19sb2dUb3BvbG9neVdhcm5pbmdzJiYtMSE9dGhpcy5lZGdlRmFjZXNbdF0mJmNvbnNvbGUud2FybigiRWRnZSBwb2x5IDEgYWxyZWFkeSBzZXQuIE1lc2ggaXMgbm9uLW1hbmlmb2xkLiIpLHRoaXMuZWRnZUZhY2VzW3RdPWF9YSBpbiB0aGlzLmZhY2VFZGdlc3x8KHRoaXMuZmFjZUVkZ2VzW2FdPVtdKSx0aGlzLmZhY2VFZGdlc1thXS5wdXNoKGkpLG51bGw9PXRoaXMudmVydGV4RWRnZXNbdF0mJih0aGlzLnZlcnRleEVkZ2VzW3RdPW5ldyBTZXQpLG51bGw9PXRoaXMudmVydGV4RWRnZXNbZV0mJih0aGlzLnZlcnRleEVkZ2VzW2VdPW5ldyBTZXQpLHRoaXMudmVydGV4RWRnZXNbdF0uYWRkKGkpLHRoaXMudmVydGV4RWRnZXNbZV0uYWRkKGkpfSxpPXRoaXMuZ2V0TnVtRmFjZXMoKTtmb3IobGV0IHQ9MDt0PGk7dCsrKXtjb25zdCBlPXRoaXMuZ2V0RmFjZVZlcnRleEluZGljZXModCk7Zm9yKGxldCBzPTA7czxlLmxlbmd0aDtzKyspe2EoZVtzXSxlWyhzKzEpJWUubGVuZ3RoXSx0KX19fWNvbXB1dGVGYWNlTm9ybWFscygpe2NvbnN0IHQ9dGhpcy5nZXRWZXJ0ZXhBdHRyaWJ1dGUoInBvc2l0aW9ucyIpLGU9dGhpcy5hZGRGYWNlQXR0cmlidXRlKCJub3JtYWxzIixsKSxzPXRoaXMuZ2V0TnVtRmFjZXMoKTtmb3IobGV0IGE9MDthPHM7YSsrKXtjb25zdCBzPXRoaXMuZ2V0RmFjZVZlcnRleEluZGljZXMoYSksaT10LmdldFZhbHVlUmVmKHNbMF0pO2xldCByPXQuZ2V0VmFsdWVSZWYoc1sxXSk7Y29uc3Qgbj1uZXcgbDtmb3IobGV0IGU9MjtlPHMubGVuZ3RoO2UrKyl7Y29uc3QgYT10LmdldFZhbHVlUmVmKHNbZV0pLGg9ci5zdWJ0cmFjdChpKSxvPWEuc3VidHJhY3QoaSk7bi5hZGRJblBsYWNlKG8uY3Jvc3MoaCkubm9ybWFsaXplKCkpLHI9YX1uLmxlbmd0aFNxdWFyZWQoKTxOdW1iZXIuRVBTSUxPTnx8ZS5zZXRWYWx1ZShhLG4ubm9ybWFsaXplKCkpfX1jYWxjdWxhdGVFZGdlQW5nbGVzKCl7bnVsbD09dGhpcy52ZXJ0ZXhFZGdlcyYmdGhpcy5nZW5Ub3BvbG9neUluZm8oKSx0aGlzLmNvbXB1dGVGYWNlTm9ybWFscygpO2NvbnN0IHQ9dGhpcy5nZXRWZXJ0ZXhBdHRyaWJ1dGUoInBvc2l0aW9ucyIpLGU9dGhpcy5nZXRGYWNlQXR0cmlidXRlKCJub3JtYWxzIik7dGhpcy5lZGdlVmVjcz1bXSx0aGlzLmVkZ2VBbmdsZXM9bmV3IEZsb2F0MzJBcnJheSh0aGlzLm51bUVkZ2VzKTtmb3IobGV0IHM9MDtzPHRoaXMuZWRnZUZhY2VzLmxlbmd0aDtzKz0yKXtjb25zdCBhPXRoaXMuZWRnZVZlcnRzW3NdLGk9dGhpcy5lZGdlVmVydHNbcysxXSxyPXQuZ2V0VmFsdWVSZWYoaSkuc3VidHJhY3QodC5nZXRWYWx1ZVJlZihhKSk7ci5ub3JtYWxpemVJblBsYWNlKCksdGhpcy5lZGdlVmVjcy5wdXNoKHIpO2NvbnN0IG49dGhpcy5lZGdlRmFjZXNbc10saD10aGlzLmVkZ2VGYWNlc1tzKzFdO2lmKC0xPT1ufHwtMT09aCl7dGhpcy5lZGdlQW5nbGVzW3MvMl09MipNYXRoLlBJO2NvbnRpbnVlfWNvbnN0IG89ZS5nZXRWYWx1ZVJlZihuKSxfPWUuZ2V0VmFsdWVSZWYoaCk7dGhpcy5lZGdlQW5nbGVzW3MvMl09by5hbmdsZVRvKF8pfX1jb21wdXRlVmVydGV4Tm9ybWFscyh0PTEpe3RoaXMuY2FsY3VsYXRlRWRnZUFuZ2xlcygpO2NvbnN0IGU9dGhpcy5nZXRGYWNlQXR0cmlidXRlKCJub3JtYWxzIikscz10aGlzLmFkZFZlcnRleEF0dHJpYnV0ZSgibm9ybWFscyIsbCksYT1lLmRhdGEuYnVmZmVyLGk9cy5kYXRhLHI9KHQsZSk9PntpWzMqdCswXT1lLngsaVszKnQrMV09ZS55LGlbMyp0KzJdPWUuen0sbj0odCxlKT0+e2xldCBzLGE7Y29uc3QgaT10aGlzLmZhY2VFZGdlc1t0XTtmb3IoY29uc3QgdCBvZiBpKSh0aGlzLmVkZ2VWZXJ0c1syKnRdPT1lfHx0aGlzLmVkZ2VWZXJ0c1syKnQrMV09PWUpJiYocz9hPXRoaXMuZWRnZVZlY3NbdF06cz10aGlzLmVkZ2VWZWNzW3RdKTtyZXR1cm5bcyxhXX07Zm9yKGxldCBlPTA7ZTx0aGlzLnZlcnRleEVkZ2VzLmxlbmd0aDtlKyspe2lmKG51bGw9PXRoaXMudmVydGV4RWRnZXNbZV0pY29udGludWU7Y29uc3QgaT10aGlzLnZlcnRleEVkZ2VzW2VdLG89W10sXz10PT57bGV0IGU9ITE7Zm9yKGNvbnN0IHMgb2YgbylpZihlPXMuaW5jbHVkZXModCksZSlicmVhaztlfHxvLnB1c2goW3RdKX07Zm9yKGNvbnN0IGUgb2YgaSl7Y29uc3Qgcz10aGlzLmVkZ2VGYWNlc1syKmVdLGE9dGhpcy5lZGdlRmFjZXNbMiplKzFdO2lmKC0xIT1zJiYtMSE9YSYmdGhpcy5lZGdlQW5nbGVzW2VdPHQpe2xldCB0PS0xLGU9LTE7Zm9yKGxldCBpPTA7aTxvLmxlbmd0aDtpKyspLTE9PXQmJm9baV0uaW5jbHVkZXMocykmJih0PWkpLC0xPT1lJiZvW2ldLmluY2x1ZGVzKGEpJiYoZT1pKTstMT09dCYmLTE9PWU/by5wdXNoKFtzLGFdKTotMSE9dCYmLTEhPWU/dCE9ZSYmKG9bdF09b1t0XS5jb25jYXQob1tlXSksby5zcGxpY2UoZSwxKSk6KC0xPT10JiZvW2VdLnB1c2gocyksLTE9PWUmJm9bdF0ucHVzaChhKSl9ZWxzZS0xIT1zJiZfKHMpLC0xIT1hJiZfKGEpfW8uc29ydCgoKHQsZSk9PnQubGVuZ3RoPGUubGVuZ3RoPzE6dC5sZW5ndGg+ZS5sZW5ndGg/LTE6MCkpO2xldCBkPSEwO2Zvcihjb25zdCB0IG9mIG8pe2NvbnN0IGk9bmV3IGw7Zm9yKGNvbnN0IHMgb2YgdCl7Y29uc3QgdD1uKHMsZSkscj10WzBdLmFuZ2xlVG8odFsxXSk7aS5hZGRJblBsYWNlKChoPXMsbC5jcmVhdGVGcm9tQnVmZmVyKGEsMypoKjQpKS5zY2FsZShyKSl9aS5ub3JtYWxpemVJblBsYWNlKCksZD8ocihlLGkpLGQ9ITEpOnMuc2V0U3BsaXRWZXJ0ZXhWYWx1ZXMoZSx0LGkpfX12YXIgaDtyZXR1cm4gc31jb21wdXRlSGFyZEVkZ2VzSW5kaWNlcyh0PTEpe3RoaXMuZWRnZVZlcnRzfHx0aGlzLmNhbGN1bGF0ZUVkZ2VBbmdsZXMoKTtjb25zdCBlPVtdLHM9dD0+e2UucHVzaCh0aGlzLmVkZ2VWZXJ0c1t0XSksZS5wdXNoKHRoaXMuZWRnZVZlcnRzW3QrMV0pfTtmb3IobGV0IGU9MDtlPHRoaXMuZWRnZUFuZ2xlcy5sZW5ndGg7ZSsrKXRoaXMuZWRnZUFuZ2xlc1tlXT50JiZzKDIqZSk7cmV0dXJuIFVpbnQzMkFycmF5LmZyb20oZSl9Z2V0V2lyZWZyYW1lSW5kaWNlcygpe3JldHVybiBjb25zb2xlLndhcm4oIkB0b2RvLXJldmlldyAtIFRoaXMgcmV0dXJucyBub3RoaW5nIiksaW5kaWNlc31nZW5CdWZmZXJzKHQpe2NvbnN0IGU9e307bGV0IHM9MDtmb3IoY29uc3RbLHRdb2YgdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMpe2NvbnN0IGE9dC5nZXRTcGxpdHMoKTtmb3IoY29uc3QgdCBpbiBhKXt0IGluIGV8fChlW3RdPXt9KTtjb25zdCBpPWFbdF07Zm9yKGNvbnN0IGEgaW4gaSl7Y29uc3QgaT1wYXJzZUludChhKTtpIGluIGVbdF18fChlW3RdW2ldPXMscysrKX19fWNvbnN0IGE9dGhpcy5nZXRWZXJ0ZXhBdHRyaWJ1dGUoInBvc2l0aW9ucyIpLmxlbmd0aCxpPWErcztsZXQgcjt0JiYwPT10LmluY2x1ZGVJbmRpY2VzfHwocj10aGlzLmdlbmVyYXRlVHJpYW5ndWxhdGVkSW5kaWNlcyhpLGEsZSkpO2NvbnN0IG49e307Zm9yKGNvbnN0W3QsYV1vZiB0aGlzLl9fdmVydGV4QXR0cmlidXRlcyl7bGV0IGk7aT0wPT1zP2EuZGF0YTphLmdlbmVyYXRlU3BsaXRWYWx1ZXMoZSxzKTtjb25zdCByPWEubnVtRWxlbWVudHMsaD1pLmxlbmd0aC9yO25bdF09e3ZhbHVlczppLGNvdW50OmgsZGltZW5zaW9uOnIsbm9ybWFsaXplZDoibm9ybWFscyI9PXQsZGF0YVR5cGU6YS5kYXRhVHlwZX19Y29uc3QgaD17bnVtVmVydGljZXM6dGhpcy5udW1WZXJ0aWNlcygpLG51bVJlbmRlclZlcnRzOmksaW5kaWNlczpyLGF0dHJCdWZmZXJzOm59O2lmKHQmJnQuaW5jbHVkZVZlcnRleE5laWdoYm9ycyl7bnVsbD09dGhpcy52ZXJ0ZXhFZGdlcyYmdGhpcy5nZW5Ub3BvbG9neUluZm8oKTtsZXQgdD0wO2ZvcihsZXQgZT0wO2U8dGhpcy52ZXJ0ZXhFZGdlcy5sZW5ndGg7ZSsrKXRoaXMudmVydGV4RWRnZXNbZV0mJih0Kz10aGlzLnZlcnRleEVkZ2VzW2VdLnNpemUpO2NvbnN0IGU9bmV3IFVpbnQzMkFycmF5KDIqdGhpcy52ZXJ0ZXhFZGdlcy5sZW5ndGgrdCkscz10PT57Zm9yKGxldCBlPTA7ZTx0Lmxlbmd0aDtlKyspe2NvbnN0IHM9dFtlXTtmb3IobGV0IGE9MDthPGU7YSsrKXtjb25zdCBpPXRbYV07aWYoLTEhPXNbMF0mJnNbMF09PWlbMV0pe2UhPWErMSYmKHQuc3BsaWNlKGUsMSksdC5zcGxpY2UoYSsxLDAscykpO2JyZWFrfWlmKC0xIT1zWzFdJiZzWzFdPT1pWzBdKXt0LnNwbGljZShlLDEpLHQuc3BsaWNlKGEsMCxzKTticmVha319fX0sYT10PT57aWYoISgtMSE9dFswXVswXSYmLTEhPXRbdC5sZW5ndGgtMV1bMV18fC0xPT10WzBdWzBdJiYtMT09dFt0Lmxlbmd0aC0xXVsxXSkpdGhyb3cgbmV3IEVycm9yKCJJZiBmYW4gc3RhcnRzIHdpdGggLTEsIGl0IG11c3QgYWxzbyBlbmQgd2l0aCAtMSIpO2ZvcihsZXQgZT0wO2U8dC5sZW5ndGg7ZSsrKXtjb25zdCBzPXRbZV07aWYoKC0xPT1zWzBdfHwtMT09c1sxXSkmJjAhPWUmJmUhPXQubGVuZ3RoLTEpdGhyb3cgbmV3IEVycm9yKCItMSBvbmx5IGFsbG93ZWQgYXQgdGhlIGJlZ2lubmluZyBhbmQgZW5kIG9mIGEgZmFuLiIpO2lmKC0xIT1zWzBdKXtsZXQgYT1lLTE7aWYoYTwwJiYoYSs9dC5sZW5ndGgpLHNbMF0hPXRbYV1bMV0pdGhyb3cgbmV3IEVycm9yKCJGYWNlcyBhcmUgbm90IHNlcXVlbnRpYWwiKX1pZigtMSE9c1sxXSl7Y29uc3QgYT0oZSsxKSV0Lmxlbmd0aDtpZihzWzFdIT10W2FdWzBdKXRocm93IG5ldyBFcnJvcigiRmFjZXMgYXJlIG5vdCBzZXF1ZW50aWFsIil9fX07bGV0IGk9Mip0aGlzLnZlcnRleEVkZ2VzLmxlbmd0aDtmb3IobGV0IHQ9MDt0PHRoaXMudmVydGV4RWRnZXMubGVuZ3RoO3QrKyl7aWYobnVsbD09dGhpcy52ZXJ0ZXhFZGdlc1t0XSljb250aW51ZTtjb25zdCByPXRoaXMudmVydGV4RWRnZXNbdF0sbj1bXTtmb3IoY29uc3QgZSBvZiByKXtjb25zdCBzPXRoaXMuZWRnZVZlcnRzWzIqZV0sYT10aGlzLmVkZ2VWZXJ0c1syKmUrMV07bGV0IGkscj10aGlzLmVkZ2VGYWNlc1syKmVdLGg9dGhpcy5lZGdlRmFjZXNbMiplKzFdO2lmKHM9PXQpaT1hO2Vsc2V7aWYoYSE9dCl0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgdG9wb2xvZ3kiKTt7aT1zO2NvbnN0IHQ9cjtyPWgsaD10fX1uLnB1c2goW3IsaCxpXSl9cyhuKSxhKG4pO2xldCBoPTA7KC0xIT1uWzBdWzBdfHwtMSE9bltuLmxlbmd0aC0xXVsxXSkmJihoKz0xKSxlWzIqdF09aSxlWzIqdCsxXT1yLnNpemUrKGg8PDgpO2Zvcihjb25zdCB0IG9mIG4pZVtpXT10WzJdLGkrK31oLnZlcnRleE5laWdoYm9ycz1lfXJldHVybiBofWNvbXB1dGVOdW1UcmlhbmdsZXMoKXtsZXQgdD0zLGU9MDtmb3IoY29uc3QgcyBvZiB0aGlzLl9fZmFjZUNvdW50cyllKz1zKih0LTIpLHQrKztyZXR1cm4gZX1nZW5lcmF0ZVRyaWFuZ3VsYXRlZEluZGljZXModCxlLHMpe2NvbnN0IGE9dGhpcy5jb21wdXRlTnVtVHJpYW5nbGVzKCk7bGV0IGk7aT10PE1hdGgucG93KDIsOCk/bmV3IFVpbnQ4QXJyYXkoMyphKTp0PE1hdGgucG93KDIsMTYpP25ldyBVaW50MTZBcnJheSgzKmEpOm5ldyBVaW50MzJBcnJheSgzKmEpO2xldCByPTA7Y29uc3Qgbj1mdW5jdGlvbih0LGEpe3QgaW4gcyYmYSBpbiBzW3RdJiYodD1lK3NbdF1bYV0pLGlbcl09dCxyKyt9LGg9dGhpcy5nZXROdW1GYWNlcygpO2ZvcihsZXQgdD0wO3Q8aDt0Kyspe2NvbnN0IGU9dGhpcy5nZXRGYWNlVmVydGV4SW5kaWNlcyh0KTtmb3IobGV0IHM9MDtzPGUubGVuZ3RoO3MrKylzPj0zJiYobihlWzBdLHQpLG4oZVtzLTFdLHQpKSxuKGVbc10sdCl9cmV0dXJuIGl9cmVhZEJpbmFyeSh0LGUpe3N1cGVyLmxvYWRCYXNlR2VvbUJpbmFyeSh0KSx0aGlzLnNldEZhY2VDb3VudHModC5sb2FkVUludDMyQXJyYXkoKSk7Y29uc3Qgcz10aGlzLmdldE51bUZhY2VzKCksYT10LmxvYWRVSW50OEFycmF5KHMpLGk9dC5sb2FkU0ludDMyVmVjMigpLHI9dC5sb2FkVUludDgoKTtsZXQgbjsxPT1yP249dC5sb2FkVUludDhBcnJheSgpOjI9PXI/bj10LmxvYWRVSW50MTZBcnJheSgpOjQ9PXImJihuPXQubG9hZFVJbnQzMkFycmF5KCkpO2xldCBoPTMsbz0wO2NvbnN0IF89dGhpcy5fX2ZhY2VDb3VudHMubWFwKCgodCxlKT0+e2NvbnN0IHM9bztyZXR1cm4gbys9dCpoLGgrKyxzfSkpO2xldCBkPTAsbD0wO2NvbnN0IGM9W107Zm9yKGxldCB0PTA7dDxzO3QrKyl7Y29uc3QgZT1hW3RdLHM9X1tlXSxyPWUrMztjW3RdPXM7Zm9yKGxldCBlPTA7ZTxyO2UrKyl7Y29uc3QgYT1zK2Uscj1uW2QrZV0raS54O2lmKDA9PXQpdGhpcy5fX2ZhY2VWZXJ0ZXhJbmRpY2VzW2FdPXI7ZWxzZXtsZXQgcz1jW3QtMV07cys9ZTxsP2U6bC0xLHRoaXMuX19mYWNlVmVydGV4SW5kaWNlc1thXT10aGlzLl9fZmFjZVZlcnRleEluZGljZXNbc10rcn19ZCs9cixfW2VdKz1yLGw9cn10aGlzLmhhc1ZlcnRleEF0dHJpYnV0ZSgibm9ybWFscyIpfHx0aGlzLmNvbXB1dGVWZXJ0ZXhOb3JtYWxzKCksdGhpcy5lbWl0KCJnZW9tRGF0YUNoYW5nZWQiLHt9KX10b0pTT04odCl7Y29uc3QgZT1zdXBlci50b0pTT04odCk7cmV0dXJuIHQmJnQuc2tpcFRvcG9sb2d5fHwoZS5mYWNlQ291bnRzPUFycmF5LmZyb20odGhpcy5fX2ZhY2VDb3VudHMpLGUuZmFjZVZlcnRleEluZGljZXM9QXJyYXkuZnJvbSh0aGlzLl9fZmFjZVZlcnRleEluZGljZXMpKSxlfWZyb21KU09OKHQsZSl7c3VwZXIuZnJvbUpTT04odCxlKSx0LmZhY2VDb3VudHMmJih0aGlzLl9fZmFjZUNvdW50cz10LmZhY2VDb3VudHMpLHQuZmFjZVZlcnRleEluZGljZXMmJih0aGlzLl9fZmFjZVZlcnRleEluZGljZXM9VWludDMyQXJyYXkuZnJvbSh0LmZhY2VWZXJ0ZXhJbmRpY2VzKSl9fW4oIk1lc2giLFApO2NsYXNzIHZ7Y29uc3RydWN0b3IodCxlPTAscz0hMCl7dGhpcy5fX2RhdGE9dCx0aGlzLl9fYnl0ZU9mZnNldD1lLHRoaXMuX19kYXRhVmlldz1uZXcgRGF0YVZpZXcodGhpcy5fX2RhdGEpLHRoaXMuX19pc01vYmlsZURldmljZT1zLHRoaXMudXRmOGRlY29kZXI9bmV3IFRleHREZWNvZGVyfWdldCBpc01vYmlsZURldmljZSgpe3JldHVybiB0aGlzLl9faXNNb2JpbGVEZXZpY2V9Z2V0IGRhdGEoKXtyZXR1cm4gdGhpcy5fX2RhdGF9Z2V0IGJ5dGVMZW5ndGgoKXtyZXR1cm4gdGhpcy5fX2RhdGFWaWV3LmJ5dGVMZW5ndGh9Z2V0IHJlbWFpbmluZ0J5dGVMZW5ndGgoKXtyZXR1cm4gdGhpcy5fX2RhdGFWaWV3LmJ5dGVMZW5ndGgtdGhpcy5fX2J5dGVPZmZzZXR9cG9zKCl7cmV0dXJuIHRoaXMuX19ieXRlT2Zmc2V0fXNlZWsodCl7dGhpcy5fX2J5dGVPZmZzZXQ9dH1hZHZhbmNlKHQpe3RoaXMuX19ieXRlT2Zmc2V0Kz10fWxvYWRVSW50OCgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFWaWV3LmdldFVpbnQ4KHRoaXMuX19ieXRlT2Zmc2V0KTtyZXR1cm4gdGhpcy5fX2J5dGVPZmZzZXQrPTEsdH1sb2FkVUludDE2KCl7Y29uc3QgdD10aGlzLl9fZGF0YVZpZXcuZ2V0VWludDE2KHRoaXMuX19ieXRlT2Zmc2V0LCEwKTtyZXR1cm4gdGhpcy5fX2J5dGVPZmZzZXQrPTIsdH1sb2FkVUludDMyKCl7Y29uc3QgdD10aGlzLl9fZGF0YVZpZXcuZ2V0VWludDMyKHRoaXMuX19ieXRlT2Zmc2V0LCEwKTtyZXR1cm4gdGhpcy5fX2J5dGVPZmZzZXQrPTQsdH1sb2FkU0ludDMyKCl7Y29uc3QgdD10aGlzLl9fZGF0YVZpZXcuZ2V0SW50MzIodGhpcy5fX2J5dGVPZmZzZXQsITApO3JldHVybiB0aGlzLl9fYnl0ZU9mZnNldCs9NCx0fWxvYWRGbG9hdDE2KCl7Y29uc3QgdD10aGlzLmxvYWRVSW50MTYoKTtyZXR1cm4gcy5kZWNvZGUxNkJpdEZsb2F0KHQpfWxvYWRVRmxvYXQxNigpe2NvbnN0IHQ9dGhpcy5sb2FkRmxvYXQxNigpO3JldHVybiB0PDA/MjA0OC10OnR9bG9hZEZsb2F0MTZGcm9tMnhVSW50OCgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFWaWV3LmdldEZsb2F0MTYodGhpcy5fX2J5dGVPZmZzZXQsITApO3JldHVybiB0aGlzLl9fYnl0ZU9mZnNldCs9Mix0fWxvYWRVSW50MzJGcm9tMnhVRmxvYXQxNigpe3JldHVybiB0aGlzLmxvYWRVRmxvYXQxNigpKzQwOTYqdGhpcy5sb2FkVUZsb2F0MTYoKX1sb2FkU0ludDMyRnJvbTJ4RmxvYXQxNigpe3JldHVybiB0aGlzLmxvYWRGbG9hdDE2KCkrMjA0OCp0aGlzLmxvYWRGbG9hdDE2KCl9bG9hZEZsb2F0MzIoKXtjb25zdCB0PXRoaXMuX19kYXRhVmlldy5nZXRGbG9hdDMyKHRoaXMuX19ieXRlT2Zmc2V0LCEwKTtyZXR1cm4gdGhpcy5fX2J5dGVPZmZzZXQrPTQsdH1sb2FkVUludDhBcnJheSh0LGU9ITEpe251bGw9PXQmJih0PXRoaXMubG9hZFVJbnQzMigpKTtjb25zdCBzPW5ldyBVaW50OEFycmF5KHRoaXMuX19kYXRhLHRoaXMuX19ieXRlT2Zmc2V0LHQpO3JldHVybiB0aGlzLl9fYnl0ZU9mZnNldCs9dCx0aGlzLl9fYnl0ZU9mZnNldCxzfWxvYWRVSW50MTZBcnJheSh0LGU9ITEpe2lmKG51bGw9PXQmJih0PXRoaXMubG9hZFVJbnQzMigpKSwwPT10KXJldHVybiBuZXcgVWludDE2QXJyYXk7bGV0IHM7aWYodGhpcy5yZWFkUGFkKDIpLHRoaXMuX19pc01vYmlsZURldmljZSl7cz1uZXcgVWludDE2QXJyYXkodCk7Zm9yKGxldCBlPTA7ZTx0O2UrKylzW2VdPXRoaXMuX19kYXRhVmlldy5nZXRVaW50MTYodGhpcy5fX2J5dGVPZmZzZXQsITApLHRoaXMuX19ieXRlT2Zmc2V0Kz0yfWVsc2Ugcz1uZXcgVWludDE2QXJyYXkodGhpcy5fX2RhdGEsdGhpcy5fX2J5dGVPZmZzZXQsdCksdGhpcy5fX2J5dGVPZmZzZXQrPTIqdDtyZXR1cm4gc31sb2FkVUludDMyQXJyYXkodCxlPSExKXtpZihudWxsPT10JiYodD10aGlzLmxvYWRVSW50MzIoKSksMD09dClyZXR1cm4gbmV3IFVpbnQzMkFycmF5O2xldCBzO2lmKHRoaXMucmVhZFBhZCg0KSx0aGlzLl9faXNNb2JpbGVEZXZpY2Upe3M9bmV3IFVpbnQzMkFycmF5KHQpO2ZvcihsZXQgZT0wO2U8dDtlKyspc1tlXT10aGlzLl9fZGF0YVZpZXcuZ2V0VWludDMyKHRoaXMuX19ieXRlT2Zmc2V0LCEwKSx0aGlzLl9fYnl0ZU9mZnNldCs9NH1lbHNlIHM9bmV3IFVpbnQzMkFycmF5KHRoaXMuX19kYXRhLHRoaXMuX19ieXRlT2Zmc2V0LHQpLHRoaXMuX19ieXRlT2Zmc2V0Kz00KnQ7cmV0dXJuIHN9bG9hZEZsb2F0MzJBcnJheSh0LGU9ITEpe2lmKG51bGw9PXQmJih0PXRoaXMubG9hZFVJbnQzMigpKSwwPT10KXJldHVybiBuZXcgRmxvYXQzMkFycmF5O2xldCBzO2lmKHRoaXMucmVhZFBhZCg0KSx0aGlzLl9faXNNb2JpbGVEZXZpY2Upe3M9bmV3IEZsb2F0MzJBcnJheSh0KTtmb3IobGV0IGU9MDtlPHQ7ZSsrKXNbZV09dGhpcy5fX2RhdGFWaWV3LmdldEZsb2F0MzIodGhpcy5fX2J5dGVPZmZzZXQsITApLHRoaXMuX19ieXRlT2Zmc2V0Kz00fWVsc2Ugcz1uZXcgRmxvYXQzMkFycmF5KHRoaXMuX19kYXRhLHRoaXMuX19ieXRlT2Zmc2V0LHQpLHRoaXMuX19ieXRlT2Zmc2V0Kz00KnQ7cmV0dXJuIHN9bG9hZFN0cigpe2NvbnN0IHQ9dGhpcy5sb2FkVUludDMyKCksZT1uZXcgVWludDhBcnJheSh0aGlzLl9fZGF0YSx0aGlzLl9fYnl0ZU9mZnNldCx0KTtyZXR1cm4gdGhpcy5fX2J5dGVPZmZzZXQrPXQsdGhpcy51dGY4ZGVjb2Rlci5kZWNvZGUoZSl9bG9hZFN0ckFycmF5KCl7Y29uc3QgdD10aGlzLmxvYWRVSW50MzIoKSxlPVtdO2ZvcihsZXQgcz0wO3M8dDtzKyspZVtzXT10aGlzLmxvYWRTdHIoKTtyZXR1cm4gZX1sb2FkU0ludDMyVmVjMigpe2NvbnN0IHQ9dGhpcy5sb2FkU0ludDMyKCksZT10aGlzLmxvYWRTSW50MzIoKTtyZXR1cm4gbmV3IGQodCxlKX1sb2FkVUludDMyVmVjMigpe2NvbnN0IHQ9dGhpcy5sb2FkVUludDMyKCksZT10aGlzLmxvYWRVSW50MzIoKTtyZXR1cm4gbmV3IGQodCxlKX1sb2FkRmxvYXQxNlZlYzIoKXtjb25zdCB0PXRoaXMubG9hZEZsb2F0MTYoKSxlPXRoaXMubG9hZEZsb2F0MTYoKTtyZXR1cm4gbmV3IGQodCxlKX1sb2FkRmxvYXQzMlZlYzIoKXtjb25zdCB0PXRoaXMubG9hZEZsb2F0MzIoKSxlPXRoaXMubG9hZEZsb2F0MzIoKTtyZXR1cm4gbmV3IGQodCxlKX1sb2FkRmxvYXQxNlZlYzMoKXtjb25zdCB0PXRoaXMubG9hZEZsb2F0MTYoKSxlPXRoaXMubG9hZEZsb2F0MTYoKSxzPXRoaXMubG9hZEZsb2F0MTYoKTtyZXR1cm4gbmV3IGwodCxlLHMpfWxvYWRGbG9hdDMyVmVjMygpe2NvbnN0IHQ9dGhpcy5sb2FkRmxvYXQzMigpLGU9dGhpcy5sb2FkRmxvYXQzMigpLHM9dGhpcy5sb2FkRmxvYXQzMigpO3JldHVybiBuZXcgbCh0LGUscyl9bG9hZEZsb2F0MTZRdWF0KCl7Y29uc3QgdD10aGlzLmxvYWRGbG9hdDE2KCksZT10aGlzLmxvYWRGbG9hdDE2KCkscz10aGlzLmxvYWRGbG9hdDE2KCksYT10aGlzLmxvYWRGbG9hdDE2KCk7cmV0dXJuIG5ldyBwKHQsZSxzLGEpfWxvYWRGbG9hdDMyUXVhdCgpe2NvbnN0IHQ9dGhpcy5sb2FkRmxvYXQzMigpLGU9dGhpcy5sb2FkRmxvYXQzMigpLHM9dGhpcy5sb2FkRmxvYXQzMigpLGE9dGhpcy5sb2FkRmxvYXQzMigpO3JldHVybiBuZXcgcCh0LGUscyxhKX1sb2FkUkdCRmxvYXQzMkNvbG9yKCl7Y29uc3QgdD10aGlzLmxvYWRGbG9hdDMyKCksZT10aGlzLmxvYWRGbG9hdDMyKCkscz10aGlzLmxvYWRGbG9hdDMyKCk7cmV0dXJuIG5ldyBmKHQsZSxzKX1sb2FkUkdCQUZsb2F0MzJDb2xvcigpe2NvbnN0IHQ9dGhpcy5sb2FkRmxvYXQzMigpLGU9dGhpcy5sb2FkRmxvYXQzMigpLHM9dGhpcy5sb2FkRmxvYXQzMigpLGE9dGhpcy5sb2FkRmxvYXQzMigpO3JldHVybiBuZXcgZih0LGUscyxhKX1sb2FkUkdCVUludDhDb2xvcigpe2NvbnN0IHQ9dGhpcy5sb2FkVUludDgoKSxlPXRoaXMubG9hZFVJbnQ4KCkscz10aGlzLmxvYWRVSW50OCgpO3JldHVybiBuZXcgZih0LzI1NSxlLzI1NSxzLzI1NSl9bG9hZFJHQkFVSW50OENvbG9yKCl7Y29uc3QgdD10aGlzLmxvYWRVSW50OCgpLGU9dGhpcy5sb2FkVUludDgoKSxzPXRoaXMubG9hZFVJbnQ4KCksYT10aGlzLmxvYWRVSW50OCgpO3JldHVybiBuZXcgZih0LzI1NSxlLzI1NSxzLzI1NSxhLzI1NSl9bG9hZEJveDIoKXtyZXR1cm4gbmV3IEkodGhpcy5sb2FkRmxvYXQzMlZlYzIoKSx0aGlzLmxvYWRGbG9hdDMyVmVjMigpKX1sb2FkQm94Mygpe3JldHVybiBuZXcgRih0aGlzLmxvYWRGbG9hdDMyVmVjMygpLHRoaXMubG9hZEZsb2F0MzJWZWMzKCkpfXJlYWRQYWQodCl7Y29uc3QgZT10aGlzLl9fYnl0ZU9mZnNldCV0OzAhPWUmJih0aGlzLl9fYnl0ZU9mZnNldCs9dC1lKX19Y2xhc3MgVHtjb25zdHJ1Y3Rvcih0KXtpZih0KXtjb25zdCBlPXQuc3BsaXQoIi0iKSxzPWVbMF0uc3BsaXQoIi4iKTt0aGlzLm1ham9yPXBhcnNlSW50KHNbMF0pLHRoaXMubWlub3I9cGFyc2VJbnQoc1sxXSksdGhpcy5wYXRjaD1wYXJzZUludChzWzJdKSwyPT1lLmxlbmd0aCYmKHRoaXMuYnJhbmNoPWVbMV0pfWVsc2UgdGhpcy5tYWpvcj0wLHRoaXMubWlub3I9MCx0aGlzLnBhdGNoPTB9Y29tcGFyZSh0KXtjb25zdCBlPVt0aGlzLm1ham9yLHRoaXMubWlub3IsdGhpcy5wYXRjaF07Zm9yKGxldCBzPTA7czwzO3MrKylpZihlW3NdIT09dFtzXSlyZXR1cm4gZVtzXS10W3NdO3JldHVybiAwfWVxdWFscyh0KXtyZXR1cm4gY29uc29sZS5sb2coIlZlcnNpb24jZXF1YWxzIG1ldGhvZCBpcyBkZXByZWNhdGVkLCB1c2UgJ2NvbXBhcmUnIGluc3RlYWQgIiksISh0aGlzLnBhdGNoPT10WzJdJiZ0aGlzLm1pbm9yPT10WzFdJiZ0aGlzLm1ham9yPT10WzBdKX1sZXNzVGhhbih0KXtyZXR1cm4gY29uc29sZS5sb2coIlZlcnNpb24jbGVzc1RoYW4gbWV0aG9kIGlzIGRlcHJlY2F0ZWQsIHVzZSAnY29tcGFyZScgaW5zdGVhZCAiKSwhKHRoaXMubWFqb3I+PXRbMF18fHRoaXMubWlub3I+PXRbMV18fHRoaXMucGF0Y2g+PXRbMl0pfWdyZWF0ZXJUaGFuKHQpe3JldHVybiBjb25zb2xlLmxvZygiVmVyc2lvbiNncmVhdGVyVGhhbiBtZXRob2QgaXMgZGVwcmVjYXRlZCwgdXNlICdjb21wYXJlJyBpbnN0ZWFkICIpLHRoaXMubWFqb3I+dFswXXx8dGhpcy5taW5vcj50WzFdfHx0aGlzLnBhdGNoPnRbMl19Z3JlYXRlck9yRXF1YWxUaGFuKHQpe3JldHVybiBjb25zb2xlLmxvZygiVmVyc2lvbiNncmVhdGVyT3JFcXVhbFRoYW4gbWV0aG9kIGlzIGRlcHJlY2F0ZWQsIHVzZSAnY29tcGFyZScgaW5zdGVhZCAiKSwhKHRoaXMubWFqb3I8dFswXSkmJih0aGlzLm1ham9yPnRbMF18fCEodGhpcy5taW5vcjx0WzFdKSYmKHRoaXMubWlub3I+dFsxXXx8ISh0aGlzLnBhdGNoPHRbMl0pKSl9fXNlbGYub25tZXNzYWdlPWZ1bmN0aW9uKHQpeygodCxlKT0+e2Zvcihjb25zdCBlIGluIHQuY29udGV4dC52ZXJzaW9ucyl7Y29uc3Qgcz10LmNvbnRleHQudmVyc2lvbnNbZV0sYT1uZXcgVDthLm1ham9yPXMubWFqb3IsYS5taW5vcj1zLm1pbm9yLGEucGF0Y2g9cy5wYXRjaCxhLmJyYW5jaD1zLmJyYW5jaCx0LmNvbnRleHQudmVyc2lvbnNbZV09YX1jb25zdCBzPVtdLGE9dC50b2NbdC5nZW9tc1JhbmdlWzBdXSxpPVtdO2ZvcihsZXQgZT10Lmdlb21zUmFuZ2VbMF07ZTx0Lmdlb21zUmFuZ2VbMV07ZSsrKXtjb25zdCByPW5ldyB2KHQuYnVmZmVyU2xpY2UsdC50b2NbZV0tYSx0LmlzTW9iaWxlRGV2aWNlKSxuPXIubG9hZFN0cigpLGg9ci5wb3MoKTtsZXQgXztzd2l0Y2gobil7Y2FzZSJQb2ludHMiOl89bmV3IFM7YnJlYWs7Y2FzZSJMaW5lcyI6Xz1uZXcgTzticmVhaztjYXNlIk1lc2giOl89bmV3IFA7YnJlYWs7ZGVmYXVsdDp0aHJvdyBuZXcgRXJyb3IoIlVuc3VwcG9ydGVkIEdlb20gdHlwZToiK24pfXRyeXtyLnNlZWsoaCksXy5yZWFkQmluYXJ5KHIsdC5jb250ZXh0KX1jYXRjaCh0KXtjb25zb2xlLndhcm4oIkVycm9yIGxvYWRpbmc6IitfLm5hbWUrIlxuOiIrdCkscy5wdXNoKHt9KTtjb250aW51ZX1jb25zdCBkPV8uZ2VuQnVmZmVycyh0LmdlbkJ1ZmZlcnNPcHRzKTtkLmluZGljZXMmJmkucHVzaChkLmluZGljZXMuYnVmZmVyKTtmb3IoY29uc3QgdCBpbiBkLmF0dHJCdWZmZXJzKXtjb25zdCBlPWQuYXR0ckJ1ZmZlcnNbdF0scz1vKGUuZGF0YVR5cGUpO2UuZGF0YVR5cGU9cyxpLnB1c2goZS52YWx1ZXMuYnVmZmVyKX1kLnZlcnRleE5laWdoYm9ycyYmaS5wdXNoKGQudmVydGV4TmVpZ2hib3JzLmJ1ZmZlcik7Y29uc3QgbD1fLmdldEJvdW5kaW5nQm94KCk7aS5wdXNoKGwucDAuX19kYXRhLmJ1ZmZlciksaS5wdXNoKGwucDEuX19kYXRhLmJ1ZmZlcikscy5wdXNoKHtuYW1lOl8ubmFtZSx0eXBlOm4sZ2VvbUJ1ZmZlcnM6ZCxiYm94Omx9KX1lKHtnZW9tTGlicmFyeUlkOnQuZ2VvbUxpYnJhcnlJZCxnZW9tRmlsZUlEOnQuZ2VvbUZpbGVJRCxnZW9tSW5kZXhPZmZzZXQ6dC5nZW9tSW5kZXhPZmZzZXQsZ2VvbXNSYW5nZTp0Lmdlb21zUmFuZ2UsZ2VvbURhdGFzOnN9LGkpfSkodC5kYXRhLCgodCxlKT0+e3NlbGYucG9zdE1lc3NhZ2UodCxlKX0pKX19KCk7Cgo=",null,!1);const Ea=si.isMobileDevice;let za=window.navigator.hardwareConcurrency;za||(za=Ea?4:6),za--;let Na=0;const Pa=[],Wa=[],Ba=(e,t)=>{const i=Na;if(!Pa[i]){Wa[i]={};const e=new Fa;e.onmessage=e=>{const t=e.data;Wa[i][t.geomLibraryId](t)},Pa[i]=e}Wa[i][e]=t;const s=Pa[i];return Na=(i+1)%za,s};class Ya extends Jt{constructor(){super(),this.__streamInfos={},this.__genBuffersOpts={},this.loadCount=0,this.queue=[],this.on("streamFileParsed",(e=>{if(this.loadCount--,this.loadCount<za&&this.queue.length){const{geomFileID:e,geomsData:t}=this.queue.pop();this.readBinaryBuffer(e,t.buffer,this.loadContext)}})),this.__receiveGeomDatas=this.__receiveGeomDatas.bind(this),this.clear()}clear(){this.__loadedCount=0,this.__numGeoms=-1,this.geoms=[]}isLoaded(){return this.__loadedCount==this.__numGeoms}loadGeomFile(e,t=!1){return t&&ms.incrementWorkload(1),new Promise((t=>{const i=this.basePath+e+".zgeoms";ms.loadFile("archive",i).then((i=>{const s=i[Object.keys(i)[0]],a=i=>{i.geomFileID==e&&(ms.incrementWorkDone(1),this.off("streamFileParsed",a),t())};this.on("streamFileParsed",a),this.loadCount<za?(this.loadCount++,this.readBinaryBuffer(e,s.buffer,this.loadContext)):this.queue.splice(0,0,{geomFileID:e,geomsData:s})}))}))}loadGeomFilesStream(e,t,i){const s=e.numGeomsPerFile.length;ms.incrementWorkload(s),this.__numGeoms=e.numGeoms,this.basePath=t,this.loadContext=i;for(let e=0;e<s;e++)this.loadGeomFile(e,!1)}setGenBufferOption(e,t){this.__genBuffersOpts[e]=t}setNumGeoms(e){this.__numGeoms=e}getNumGeoms(){return this.__numGeoms}getGeom(e){return e>=this.geoms.length?null:this.geoms[e]}loadArchive(e){ms.loadArchive(e).then((e=>{this.loadBin(e)}))}readBinaryBuffer(e,t,i){const s=new Ti(t,0,Ea),a=s.loadUInt32(),r=s.loadUInt32();if(this.__streamInfos[e]={total:a,done:0},0==a)return this.emit("streamFileParsed",{geomFileID:e,geomCount:0}),a;-1==this.__numGeoms&&(this.__numGeoms=a);const n=s.loadUInt32Array(a);{let o=window.navigator.hardwareConcurrency;o||(o=Ea?2:4);const l=Math.max(1,Math.floor(a/o+1));let h=0;for(;h<a;){const o=n[h];let d,c;h+l>=a?(c=[h,a],d=t.byteLength):(c=[h,h+l],d=n[c[1]]);const u=t.slice(o,d);h+=l,Ba(this.getId(),this.__receiveGeomDatas).postMessage({geomLibraryId:this.getId(),geomFileID:e,toc:n,geomIndexOffset:r,geomsRange:c,isMobileDevice:s.isMobileDevice,bufferSlice:u,genBuffersOpts:this.__genBuffersOpts,context:{versions:i.versions}},[u])}}}__receiveGeomDatas(e){const{geomLibraryId:t,geomFileID:i,geomDatas:s,geomIndexOffset:a,geomsRange:r}=e;if(t!=this.getId())throw new Error("Receiving workload for a different GeomLibrary");const n=a+r[0],o=[n,a+r[1]];for(let e=0;e<s.length;e++){const t=s[e];if(!t.type)continue;let i;switch(t.type){case"Points":i=new Ls(t);break;case"Lines":i=new Ss(t);break;case"Mesh":case"Plane":case"Sphere":case"Cone":i=new Zs(t);break;default:throw new Error("Unsupported Geom type:"+className)}this.geoms[n+e]=i}this.emit("rangeLoaded",{range:o});const l=o[1]-o[0],h=this.__streamInfos[i];h.done+=l,h.done==h.total&&this.emit("streamFileParsed",{geomFileID:i,geomCount:h.done}),this.__loadedCount+=l,this.__loadedCount==this.__numGeoms&&this.emit("loaded")}toJSON(){return{numGeoms:this.geoms.length()}}toString(){return JSON.stringify(this.toJSON(),null,2)}}class Aa extends Jt{constructor(e="MaterialLibrary"){super(),this.__name=e,this.lod=0,si.isMobileDevice&&(this.lod=1),this.clear()}clear(){this.__images={},this.__materials={Default:new Xs("Default","SimpleSurfaceShader")}}getPath(){return[this.__name]}getNumMaterials(){return Object.keys(this.__materials).length}getMaterials(){return Object.values(this.__materials)}getMaterialNames(){const e=[];for(const t in this.__materials)e.push(t);return e}hasMaterial(e){return e in this.__materials}addMaterial(e){e.setOwner(this),this.__materials[e.getName()]=e}getMaterial(e,t=!0){const i=this.__materials[e];if(!i&&t)throw new Error("Material:"+e+" not found in library:"+this.getMaterialNames());return i}hasImage(e){return e in this.__images}addImage(e){e.setOwner(this),this.__images[e.getName()]=e}getImage(e,t=!0){const i=this.__images[e];if(!i&&t)throw new Error("Image:"+e+" not found in library:"+this.getImageNames());return i}getImageNames(){const e=[];for(const t in this.__images)e.push(t);return e}load(e){const t=new XMLHttpRequest;t.open("GET",e,!0),t.ontimeout=()=>{throw new Error("The request for "+e+" timed out.")},t.onload=()=>{4===t.readyState&&(200===t.status?this.fromJSON(JSON.parse(t.responseText)):console.warn(t.statusText))},t.send(null)}toJSON(e={}){return{numMaterials:this.getNumMaterials()}}fromJSON(e,t={}){t.lod=this.lod;for(const t in e.textures){new js(t).fromJSON(e.textures[t]),this.__images[t]=texture}for(const t in e.materials){const i=new Xs(t);i.fromJSON(e.materials[t]),this.addMaterial(i)}}readBinary(e,t={}){this.name=e.loadStr(),t.lod=this.lod,t.materialLibrary=this;const i=e.loadUInt32();for(let s=0;s<i;s++){const i=e.loadStr(),s=oi.constructClass(i,void 0);s.readBinary(e,t),this.__images[s.getName()]=s}const s=e.loadUInt32();if(s>0){const i=e.loadUInt32Array(s);for(let a=0;a<s;a++){const s=new Xs("");e.seek(i[a]),s.readBinary(e,t,this.__images),this.addMaterial(s)}}this.emit("loaded",{})}toString(){return JSON.stringify(this.toJSON(),null,2)}}class Da extends us{constructor(e){super(e),this.__geomLibrary=new Ya,this.__materials=new Aa,this.loaded=!1}load(e){return Promise.reject(`This method is not implemented for this Asset Item: ${e}`)}isLoaded(){return this.loaded}getEngineDataVersion(){return this.__engineDataVersion}getGeometryLibrary(){return this.__geomLibrary}getMaterialLibrary(){return this.__materials}getUnitsConversion(){return this.__unitsScale}readBinary(e,t={}){t.assetItem=this,t.numTreeItems=0,t.numGeomItems=0,t.versions["zea-engine"]||(t.versions["zea-engine"]=new gs(e.loadStr())),this.__engineDataVersion=t.versions["zea-engine"];const i=()=>{this.__units=e.loadStr();let t=1;switch(this.__units){case"Millimeters":t=.001;break;case"Centimeters":t=.01;break;case"Meters":t=1;break;case"Kilometers":t=1e3;break;case"Inches":t=.0254;break;case"Feet":t=.3048;break;case"Miles":t=1609.34}this.__unitsScale=t;const i=this.getParameter("LocalXfo"),s=i.getValue();s.sc.scaleInPlace(t),i.setValue(s)};let s;t.versions["zea-engine"].compare([0,0,6])>0&&i();const a={};t.addGeomToLayer=(e,t)=>{if(!a[t]){s||(s=new us("Layers"),this.addChild(s,!1));const e=new wa(t);s.addChild(e,!1),a[t]=e}a[t].addItem(e)};const r=[];t.resolvePath=(e,t,i)=>{if(!e)throw new Error("Path not specified");try{const i=this.resolvePath(e);t(i)}catch(s){r.push((()=>{try{const i=this.resolvePath(e);t(i)}catch(e){if(!i)throw new Error(e.message);i()}}))}},t.addPLCB=e=>r.push(e),this.__materials.readBinary(e,t),super.readBinary(e,t),t.versions["zea-engine"].compare([0,0,5])>=0&&t.versions["zea-engine"].compare([0,0,7])<0&&i();for(const e of r)e();this.loaded=!0}toJSON(e={}){e.makeRelative=e=>{const t=this.getPath(),i=e.slice(0,t.length);for(let s=0;s<i.length-1;s++)if(i[s]!=t[s])return console.warn("Param Path is not relative to the asset. May not be able to be resolved at load time:"+e),e;const s=e.slice(t.length-1);return s[0]=".",s},e.assetItem=this;return super.toJSON(e)}fromJSON(e,t={},i){t||(t={}),t.assetItem=this,t.numTreeItems=0,t.numGeomItems=0,null==t.version&&(t.version=0),t.assetItem=this;const s=[];t.resolvePath=(e,t)=>{if(!e)throw new Error("Path not specified");const i=this.resolvePath(e);i?t(i):s.push((()=>{const i=this.resolvePath(e);i?t(i):console.warn("Path unable to be resolved:"+e)}))},t.addPLCB=e=>s.push(e),super.fromJSON(e,t);for(const e of s)e();i&&i()}clone(e){const t=new Da;return t.copyFrom(this,e),t}copyFrom(e,t){this.__geomLibrary=e.__geomLibrary,this.__materials=e.__materials,this.loaded=e.loaded,e.loaded||e.once("loaded",(i=>{const s=e.getParameter("LocalXfo").getValue(),a=this.getParameter("LocalXfo").getValue();a.sc=s.sc.clone(),this.getParameter("LocalXfo").setValue(a),e.getChildren().forEach((e=>{e&&e!=Da&&this.addChild(e.clone(t),!1,!1)})),this.loaded=!0,this.emit("loaded",i)})),super.copyFrom(e,t)}}oi.register("AssetItem",Da);class ka extends us{constructor(e,t){super(e);const i=this.addParameter(new ji("Image"));t&&i.setValue(t),this.addParameter(new Bi("PixelsPerMeter",1e3)),this.addParameter(new Bi("Alpha",1)),this.addParameter(new Hi("Color",new mi(1,1,1))),this.addParameter(new Ai("AlignedToCamera",!1)),this.addParameter(new Ai("DrawOnTop",!1)),this.addParameter(new Ai("FixedSizeOnscreen",!1)),this.addParameter(new Di("Pivot",new hi(.5,0)))}}oi.register("BillboardItem",ka);class Ka extends us{constructor(e){null==e&&(e="Camera"),super(e),this.__isOrthographicParam=this.addParameter(new Bi("isOrthographic",0)),this.__fovParam=this.addParameter(new Bi("fov",1)),this.__nearParam=this.addParameter(new Bi("near",.1)),this.__farParam=this.addParameter(new Bi("far",1e3)),this.__focalDistanceParam=this.addParameter(new Bi("focalDistance",5));const t=e=>{this.emit("projectionParamChanged",e)};this.__isOrthographicParam.on("valueChanged",t),this.__fovParam.on("valueChanged",t),this.__nearParam.on("valueChanged",t),this.__farParam.on("valueChanged",t),this.setPositionAndTarget(new di(3,3,1.75),new di(0,0,1)),this.setLensFocalLength("28mm")}getNear(){return this.__nearParam.getValue()}setNear(e){this.__nearParam.setValue(e)}getFar(){return this.__farParam.getValue()}setFar(e){this.__farParam.setValue(e)}getFov(){return this.__fovParam.getValue()}setFov(e){this.__fovParam.setValue(e)}setLensFocalLength(e){const t={"10mm":100.4,"11mm":95,"12mm":90,"14mm":81.2,"15mm":77.3,"17mm":70.4,"18mm":67.4,"19mm":64.6,"20mm":61.9,"24mm":53.1,"28mm":46.4,"30mm":43.6,"35mm":37.8,"45mm":29.9,"50mm":27,"55mm":24.6,"60mm":22.6,"70mm":19.5,"75mm":18.2,"80mm":17.1,"85mm":16.1,"90mm":15.2,"100mm":13.7,"105mm":13,"120mm":11.4,"125mm":11,"135mm":10.2,"150mm":9.1,"170mm":8.1,"180mm":7.6,"210mm":6.5,"300mm":4.6,"400mm":3.4,"500mm":2.7,"600mm":2.3,"800mm":1.7};!e in t?console.warn("Camera lense focal length not supported:"+e):this.__fovParam.setValue(jt.degToRad(t[e]))}getFocalDistance(){return this.__focalDistanceParam.getValue()}setFocalDistance(e){e<1e-4&&console.error("Never set focal distance to zero"),this.__focalDistanceParam.setValue(e),this.__nearParam.setValue(.01*e),this.__farParam.setValue(200*e)}isOrthographic(){return 1==this.__isOrthographicParam.getValue()}setIsOrthographic(e,t=0){if(this.__orthoIntervalId&&clearInterval(this.__orthoIntervalId),0==t)this.__isOrthographicParam.setValue(e);else{const i=Math.round(t/20);let s=0;const a=this.__isOrthographicParam.getValue(),r=()=>{const t=jt.lerp(a,e,s/i);this.__isOrthographicParam.setValue(t),s++,s<=i?this.__focusIntervalId=setTimeout(r,20):(this.__focusIntervalId=void 0,this.emit("movementFinished"))};r()}}setPositionAndTarget(e,t){this.setFocalDistance(e.distanceTo(t));const i=new yi;i.setLookAt(e,t,new di(0,0,1)),this.getParameter("GlobalXfo").setValue(i),this.emit("movementFinished")}getTargetPosition(){const e=this.__focalDistanceParam.getValue(),t=this.getParameter("GlobalXfo").getValue(),i=t.ori.getZaxis();return i.scaleInPlace(-e),i.addInPlace(t.tr),i}frameView(e,t){const i=new xi;for(const e of t)i.addBox3(e.getParameter("BoundingBox").getValue());if(!i.isValid())return void console.warn("Bounding box not valid.");const s=this.__focalDistanceParam.getValue(),a=this.__fovParam.getValue(),r=this.getParameter("GlobalXfo").getValue().clone(),n=r.ori.getZaxis(),o=n.scale(-s),l=r.tr.add(o),h=i.center().subtract(l);r.tr.addInPlace(h);const d=i.size()/Math.tan(a),c=d-s;r.tr.addInPlace(n.scale(c)),this.setFocalDistance(d),this.getParameter("GlobalXfo").setValue(r),this.emit("movementFinished")}updateProjectionMatrix(e,t){const i=this.__isOrthographicParam.getValue(),s=new fi;if(i>0){const e=this.__focalDistanceParam.getValue(),i=this.__fovParam.getValue(),a=this.__nearParam.getValue(),r=this.__farParam.getValue(),n=Math.sin(.5*i)*e,o=-n,l=n,h=n*-t,d=n*t;s.setOrthographicMatrix(h,d,o,l,a,r)}if(i<1){const i=this.__fovParam.getValue(),s=this.__nearParam.getValue(),a=this.__farParam.getValue();e.setPerspectiveMatrix(i,t,s,a)}1==i?e.setFromMat4(s):i>0&&e.set(jt.lerp(e.m00,s.m00,i),jt.lerp(e.m01,s.m01,i),jt.lerp(e.m02,s.m02,i),jt.lerp(e.m03,s.m03,i),jt.lerp(e.m10,s.m10,i),jt.lerp(e.m11,s.m11,i),jt.lerp(e.m12,s.m12,i),jt.lerp(e.m13,s.m13,i),jt.lerp(e.m20,s.m20,i),jt.lerp(e.m21,s.m21,i),jt.lerp(e.m22,s.m22,i),jt.lerp(e.m23,s.m23,i),jt.lerp(e.m30,s.m30,i),jt.lerp(e.m31,s.m31,i),jt.lerp(e.m32,s.m32,i),jt.lerp(e.m33,s.m33,i))}}oi.register("Camera",Ka);class Ha extends os{constructor(e,t){super(),this.addInput(new rs("GroupGlobalXfo")).setParam(e),this.addOutput(new ns("GroupTransformXfo")).setParam(t)}setBindXfo(e){this.bindXfo=e,this.invBindXfo=e.inverse(),this.setDirty()}evaluate(){const e=this.getOutput("GroupTransformXfo");if(this.invBindXfo){const t=this.getInput("GroupGlobalXfo").getValue();e.setClean(t.multiply(this.invBindXfo))}else e.setClean(new yi)}}class Ua extends os{constructor(e,t){super(),this.addInput(new rs("GroupTransformXfo")).setParam(e),this.addOutput(new ns("MemberGlobalXfo",Pi.OP_READ_WRITE)).setParam(t),this._enabled=!0}disable(){this._enabled=!1,this.setDirty()}enable(){this._enabled=!0,this.setDirty()}evaluate(){const e=this.getOutput("MemberGlobalXfo"),t=e.getValue();if(this._enabled){const i=this.getInput("GroupTransformXfo").getParam().getValue();e.setClean(i.multiply(t))}else e.setClean(t)}}const Oa={disabled:0,manual:1,first:2,average:3,globalOri:4};class Ja extends Ra{constructor(e){super(e),this.groupXfoDirty=!1,this.calculatingGroupXfo=!1,this.dirty=!1,this._bindXfoDirty=!1,this.memberXfoOps=[],this.__initialXfoModeParam=this.addParameter(new Yi("InitialXfoMode",Oa.average,["manual","first","average","global"])),this.__initialXfoModeParam.on("valueChanged",(()=>{this.calcGroupXfo()})),this.__highlightedParam=this.addParameter(new Ai("Highlighted",!1)),this.__highlightedParam.on("valueChanged",(()=>{this.__updateHighlight()})),this.__updateHighlight=this.__updateHighlight.bind(this);this.addParameter(new Hi("HighlightColor",new mi(.5,.5,1))).on("valueChanged",this.__updateHighlight);this.addParameter(new Bi("HighlightFill",0,[0,1])).on("valueChanged",this.__updateHighlight),this.__materialParam=this.addParameter(new xs("Material")),this.__materialParam.on("valueChanged",(()=>{this.__updateMaterial()})),this.__updateCutaway=this.__updateCutaway.bind(this),this.addParameter(new Ai("CutAwayEnabled",!1)).on("valueChanged",this.__updateCutaway),this.addParameter(new ki("CutPlaneNormal",new di(1,0,0))).on("valueChanged",this.__updateCutaway),this.addParameter(new Bi("CutPlaneDist",0)).on("valueChanged",this.__updateCutaway);const t=this.addParameter(new Qi("GroupTransform",new yi));this.groupTransformOp=new Ha(this.getParameter("GlobalXfo"),t)}static get INITIAL_XFO_MODES(){return Oa}__updateVisibility(){if(super.__updateVisibility()){const e=this.isVisible();return Array.from(this.__itemsParam.getValue()).forEach((t=>{t instanceof us&&t.propagateVisibility(e?1:-1)})),!0}return!1}__updateHighlight(){new Promise((e=>{let t,i=!1;(this.getParameter("Highlighted").getValue()||this.isSelected())&&(i=!0,t=this.getParameter("HighlightColor").getValue(),t.a=this.getParameter("HighlightFill").getValue());const s="groupItemHighlight"+this.getId();Array.from(this.__itemsParam.getValue()).forEach((e=>{e instanceof us&&(i?e.addHighlight(s,t,!0):e.removeHighlight(s,!0))})),e()}))}setSelected(e){super.setSelected(e),this.__updateHighlight()}calcGroupXfo(){const e=Array.from(this.__itemsParam.getValue());if(0==e.length)return new yi;this.calculatingGroupXfo=!0,this.memberXfoOps.forEach((e=>e.disable()));const t=this.__initialXfoModeParam.getValue();let i;if(t==Oa.manual)i=this.getParameter("GlobalXfo").getValue();else if(t==Oa.first)e[0]instanceof us&&(i=e[0].getParameter("GlobalXfo").getValue());else if(t==Oa.average){i=new yi,i.ori.set(0,0,0,0);let t=0;e.forEach(((e,s)=>{if(e instanceof us){const s=e.getParameter("GlobalXfo").getValue();i.tr.addInPlace(s.tr),i.ori.addInPlace(s.ori),t++}})),i.tr.scaleInPlace(1/t),i.ori.normalizeInPlace()}else{if(t!=Oa.globalOri)throw new Error("Invalid GROUP_XFO_MODES.");{i=new yi;let t=0;e.forEach(((e,s)=>{if(e instanceof us){const s=e.getParameter("GlobalXfo").getValue();i.tr.addInPlace(s.tr),t++}})),i.tr.scaleInPlace(1/t)}}this.getParameter("GlobalXfo").setValue(i),this.groupTransformOp.setBindXfo(i),this.memberXfoOps.forEach((e=>e.enable())),this.calculatingGroupXfo=!1,this.groupXfoDirty=!1}__updateMaterial(){new Promise((e=>{const t=this.getParameter("Material").getValue();Array.from(this.__itemsParam.getValue()).forEach((e=>{e.traverse((e=>{if(e instanceof us&&e.hasParameter("Material")){const i=e.getParameter("Material");if(t){const e=i.getValue();e==t||e&&"LinesShader"==e.getShaderName()||(i.__backupMaterial=e,i.loadValue(t))}else i.__backupMaterial&&i.loadValue(i.__backupMaterial)}}),!1)})),e()}))}__updateCutaway(){new Promise((e=>{const t=this.getParameter("CutAwayEnabled").getValue(),i=this.getParameter("CutPlaneNormal").getValue(),s=this.getParameter("CutPlaneDist").getValue();Array.from(this.__itemsParam.getValue()).forEach((e=>{e.traverse((e=>{e instanceof xa&&(e.setCutawayEnabled(t),e.setCutVector(i),e.setCutDist(s))}),!0)})),e()}))}setSearchRoot(e){this.searchRoot=e}setOwner(e){this.searchRoot&&this.searchRoot!=this.getOwner()||(this.searchRoot=e),super.setOwner(e)}setPaths(e){if(this.clearItems(!1),this.getOwner(),null==this.searchRoot)return void console.warn("Group does not have an owner and so cannot resolve paths:",this.getName());const t=[];e.forEach((e=>{const i=this.searchRoot.resolvePath(e);i?t.push(i):console.warn("Path does not resolve to an Item:",e," group:",this.getName())})),this.setItems(t)}resolveItems(e){this.setPaths(e)}__bindItem(e,t){if(super.__bindItem(e,t),!(e instanceof us))return;const i=this.getParameter("Material").getValue();if(i&&e.traverse((e=>{if(e instanceof us&&e.hasParameter("Material")){const t=e.getParameter("Material");if(i){const e=t.getValue();e==i||e&&"LinesShader"==e.getShaderName()||(t.__backupMaterial=e,t.loadValue(i))}}}),!0),e instanceof us&&this.getParameter("Highlighted").getValue()){const t=this.getParameter("HighlightColor").getValue();t.a=this.getParameter("HighlightFill").getValue(),e.addHighlight("groupItemHighlight"+this.getId(),t,!0)}const s=this.getParameter("CutAwayEnabled").getValue();if(s){const t=this.getParameter("CutPlaneNormal").getValue(),i=this.getParameter("CutPlaneDist").getValue();e.traverse((e=>{e instanceof xa&&(e.setCutawayEnabled(s),e.setCutVector(t),e.setCutDist(i))}),!0)}if(this.isVisible()||e.propagateVisibility(-1),e instanceof us){const i=e.getParameter("GlobalXfo"),s=new Ua(this.getParameter("GroupTransform"),i);this.memberXfoOps.splice(t,0,s),e.getParameter("BoundingBox").on("valueChanged",this._setBoundingBoxDirty),this._bindXfoDirty=!0}}__unbindItem(e,t){super.__unbindItem(e,t),e instanceof us&&(this.getParameter("Highlighted").getValue()&&e.removeHighlight("groupItemHighlight"+this.getId(),!0),this.isVisible()||e.propagateVisibility(1),e.traverse((e=>{e instanceof xa&&e.setCutawayEnabled(!1)}),!0),e instanceof us&&(this.memberXfoOps[t].detach(),this.memberXfoOps.splice(t,1),this._setBoundingBoxDirty(),e.getParameter("BoundingBox").off("valueChanged",this._setBoundingBoxDirty),this._bindXfoDirty=!0))}addItem(e,t=!0){e?(this.__itemsParam.addItem(e,t),t&&this.calcGroupXfo()):console.warn("Error adding item to group. Item is null")}removeItem(e,t=!0){this.__itemsParam.removeItem(e,t),t&&this.calcGroupXfo()}clearItems(e=!0){const t=Array.from(this.__itemsParam.getValue());for(let e=t.length-1;e>=0;e--)this.__unbindItem(t[e],e);this.memberXfoOps=[],this.__itemsParam.clearItems(e),e&&this.calcGroupXfo()}getItems(){return this.__itemsParam.getValue()}setItems(e){this.clearItems(!1),this.__itemsParam.setItems(e),this.calcGroupXfo()}_cleanBoundingBox(e){const t=super._cleanBoundingBox(e);return Array.from(this.__itemsParam.getValue()).forEach((e=>{e instanceof us&&e.isVisible()&&t.addBox3(e.getParameter("BoundingBox").getValue())})),t}onPointerDown(e){super.onPointerDown(e)}onPointerUp(e){super.onPointerUp(e)}onPointerMove(e){super.onPointerMove(e)}__loadDone(){this.calculatingGroupXfo=!0,this.calcGroupXfo(),this.calculatingGroupXfo=!1}clone(){const e=new Ja;return e.copyFrom(this),e}}oi.register("Group",Ja);const Qa={disabled:0,manual:1,first:2,average:3,globalOri:4};class ja extends Ra{constructor(e){super(e),this.calculatingGroupXfo=!1,this.memberXfoOps=[],this.__initialXfoModeParam=this.addParameter(new Yi("InitialXfoMode",Qa.average,["manual","first","average","global"])),this.__initialXfoModeParam.on("valueChanged",(()=>{this.calcGroupXfo()}));const t=this.addParameter(new Qi("GroupTransform",new yi));this.groupTransformOp=new Ha(this.getParameter("GlobalXfo"),t)}static get INITIAL_XFO_MODES(){return Qa}__updateHighlight(){new Promise((e=>{let t,i=!1;this.isSelected()&&(i=!0,t=this.getHighlight(),t.a=.2);const s="kinematicGroupItemHighlight"+this.getId();Array.from(this.__itemsParam.getValue()).forEach((e=>{e instanceof us&&(i?e.addHighlight(s,t,!0):e.removeHighlight(s,!0))})),e()}))}setSelected(e){super.setSelected(e),this.__updateHighlight()}calcGroupXfo(){const e=Array.from(this.__itemsParam.getValue());if(0==e.length)return new yi;this.calculatingGroupXfo=!0,this.memberXfoOps.forEach((e=>e.disable()));const t=this.__initialXfoModeParam.getValue();let i;if(t==Qa.manual)i=this.getParameter("GlobalXfo").getValue();else if(t==Qa.first)e[0]instanceof us&&(i=e[0].getParameter("GlobalXfo").getValue());else if(t==Qa.average){i=new yi,i.ori.set(0,0,0,0);let t=0;e.forEach(((e,s)=>{if(e instanceof us){const s=e.getParameter("GlobalXfo").getValue();i.tr.addInPlace(s.tr),i.ori.addInPlace(s.ori),t++}})),i.tr.scaleInPlace(1/t),i.ori.normalizeInPlace()}else{if(t!=Qa.globalOri)throw new Error("Invalid GROUP_XFO_MODES.");{i=new yi;let t=0;e.forEach(((e,s)=>{if(e instanceof us){const s=e.getParameter("GlobalXfo").getValue();i.tr.addInPlace(s.tr),t++}})),i.tr.scaleInPlace(1/t)}}this.getParameter("GlobalXfo").setValue(i),this.groupTransformOp.setBindXfo(i),this.memberXfoOps.forEach((e=>e.enable())),this.calculatingGroupXfo=!1}__bindItem(e,t){if(e instanceof us){if(this.isSelected()){const t=this.getHighlight();t.a=.2;const i="kinematicGroupItemHighlight"+this.getId();e.addHighlight(i,t,!0)}{const i=e.getParameter("GlobalXfo"),s=new Ua(this.getParameter("GroupTransform"),i);this.memberXfoOps.splice(t,0,s),e.getParameter("BoundingBox").on("valueChanged",this._setBoundingBoxDirty)}}}__unbindItem(e,t){if(super.__unbindItem(e,t),e instanceof us){if(this.isSelected()){const t="kinematicGroupItemHighlight"+this.getId();e.removeHighlight(t,!0)}this.memberXfoOps[t].detach(),this.memberXfoOps.splice(t,1),this._setBoundingBoxDirty(),e.getParameter("BoundingBox").off("valueChanged",this._setBoundingBoxDirty)}}addItem(e,t=!0){super.addItem(e,t),t&&this.calcGroupXfo()}removeItem(e,t=!0){super.removeItem(e,t),t&&this.calcGroupXfo()}setItems(e){super.setItems(emit),this.calcGroupXfo()}clearItems(e=!0){super.clearItems(e),this.memberXfoOps=[],e&&this.calcGroupXfo()}__loadDone(){this.calculatingGroupXfo=!0,this.calcGroupXfo(),this.calculatingGroupXfo=!1}clone(e){const t=new ja;return t.copyFrom(this,e),t}}oi.register("KinematicGroup",ja);class qa extends Ra{constructor(e){super(e),this.__materialParam=this.addParameter(new xs("Material")),this.__materialParam.on("valueChanged",(()=>{this.__updateMaterial()}))}__updateHighlight(){new Promise((e=>{let t,i=!1;this.isSelected()&&(i=!0,t=this.getHighlight(),t.a=.2);const s="kinematicGroupItemHighlight"+this.getId();Array.from(this.__itemsParam.getValue()).forEach((e=>{e instanceof us&&(i?e.addHighlight(s,t,!0):e.removeHighlight(s,!0))})),e()}))}setSelected(e){super.setSelected(e),this.__updateHighlight()}__updateMaterial(){new Promise((e=>{const t=this.getParameter("Material").getValue();Array.from(this.__itemsParam.getValue()).forEach((e=>{e.traverse((e=>{if(e instanceof us&&e.hasParameter("Material")){const i=e.getParameter("Material");if(t){const e=i.getValue();e==t||e&&"LinesShader"==e.getShaderName()||(i.__backupMaterial=e,i.setValue(t))}else i.__backupMaterial&&i.setValue(i.__backupMaterial)}}))})),e()}))}__bindItem(e,t){if(super.__bindItem(e,t),!(e instanceof us))return;if(this.isSelected()){const t=this.getHighlight();t.a=.2;const i="materialGroupItemHighlight"+this.getId();e.addHighlight(i,t,!0)}const i=this.getParameter("Material").getValue();i&&e.traverse((e=>{if(e instanceof us&&e.hasParameter("Material")){const t=e.getParameter("Material");if(i){const e=t.getValue();e==i||e&&"LinesShader"==e.getShaderName()||(t.__backupMaterial=e,t.setValue(i))}}}),!0)}__unbindItem(e,t){if(super.__unbindItem(e,t),e instanceof us&&this.isSelected()){const t="materialGroupItemHighlight"+this.getId();e.removeHighlight(t,!0)}}clone(e){const t=new qa;return t.copyFrom(this,e),t}}oi.register("MaterialGroup",qa);class $a extends os{constructor(e,t){super(),this.addInput(new rs("GroupGlobalXfo")).setParam(e),this.addOutput(new ns("CuttingPlane")).setParam(t)}evaluate(){const e=this.getOutput("CuttingPlane"),t=this.getInput("GroupGlobalXfo").getValue(),i=t.ori.getZaxis(),s=t.tr.dot(i);e.setClean(new ci(i.x,i.y,i.z,-s))}}class er extends Ra{constructor(e){super(e),this.__updateCutaway=this.__updateCutaway.bind(this),this.addParameter(new Ai("CutAwayEnabled",!1)).on("valueChanged",this.__updateCutaway),this.addParameter(new Ki("CutPlane",new ci(1,0,0))).on("valueChanged",this.__updateCutaway),this.cutPlaneOp=new $a(this.getParameter("GlobalXfo"),this.getParameter("CutPlane"));const t=new Xs("plane","FlatSurfaceShader");t.getParameter("BaseColor").setValue(new mi(1,1,1,.2)),t.visibleInGeomDataBuffer=!1,this.addChild(new va("PlaneGeom",new Hs(1,1),t));const i=new Xs("border","LinesShader");i.getParameter("BaseColor").setValue(new mi(1,0,0,1)),i.visibleInGeomDataBuffer=!1,this.addChild(new va("BorderGeom",new Ns(1,1),i))}__updateCutaway(e){new Promise((t=>{const i=this.getParameter("CutAwayEnabled").getValue(),s=this.getParameter("CutPlane").getValue(),a=s.xyz,r=s.w;e instanceof xa?(e.setCutawayEnabled(i),e.setCutVector(a),e.setCutDist(r)):Array.from(this.__itemsParam.getValue()).forEach((e=>{e.traverse((e=>{e instanceof xa&&(e.setCutawayEnabled(i),e.setCutVector(a),e.setCutDist(r))}),!0)})),t()}))}__bindItem(e,t){if(!(e instanceof us))return;this.getParameter("CutAwayEnabled").getValue()&&this.__updateCutaway(e);const i=new xi;this.getParameter("GlobalXfo").getValue().inverse(),Array.from(this.__itemsParam.getValue()).forEach((e=>{e instanceof us&&i.addBox3(e.getParameter("BoundingBox").getValue())}));{const e=i.p1.x-i.p0.x,t=i.p1.y-i.p0.y,s=new yi;s.sc.set(e,t,1),this.getChild(0).getParameter("LocalXfo").setValue(s),this.getChild(1).getParameter("LocalXfo").setValue(s)}}__unbindItem(e,t){e instanceof us&&e.traverse((e=>{e instanceof xa&&e.setCutawayEnabled(!1)}),!0)}clone(e){const t=new er;return t.copyFrom(this,e),t}}oi.register("CuttingPlane",er);class tr{constructor(e){let t;if(this.__resources={},this.__resourcesTreeEntities={},this.__resourcesTree={children:{}},this.__resourceRegisterCallbacks={},window.navigator){const e=document.getElementsByTagName("script");for(let i=0;i<e.length;i++){const s=e[i];if(s.src.includes("zea-engine")){const e=s.src.split("/");e.pop(),e.pop(),t=e.join("/");break}}t||(t="https://unpkg.com/@zeainc/zea-engine@0.1.3"),this.addResourceURL("ZeaEngine/Vive.vla",t+"/public-resources/Vive.vla"),this.addResourceURL("ZeaEngine/Oculus.vla",t+"/public-resources/Oculus.vla")}t||(t="https://unpkg.com/@zeainc/zea-engine@0.1.3"),this.addResourceURL("ZeaEngine/Vive.vla",t+"/public-resources/Vive.vla"),this.addResourceURL("ZeaEngine/Oculus.vla",t+"/public-resources/Oculus.vla"),e&&this.setResources(e)}getRootFolder(){return this.__resourcesTree}registerResourceCallback(e,t){this.__resourceRegisterCallbacks[e]=t;for(const i in this.__resources){const s=this.__resources[i];s.name.includes(e)&&t(s)}}__applyCallbacks(e){const t=e=>{for(const t in this.__resourceRegisterCallbacks)e.name.includes(t)&&this.__resourceRegisterCallbacks[t](e)};for(const i in e){const s=e[i];s.url&&t(s)}}__buildTree(e){const t=i=>{if(this.__resourcesTreeEntities[i])return;const s=e[i];s.id=i,"folder"!==s.type&&"dependency"!==s.type||(s.children={}),s.parent&&(this.__resourcesTreeEntities[s.parent]||t(s.parent));(s.parent?this.__resourcesTreeEntities[s.parent]:this.__resourcesTree).children[s.name]=s,this.__resourcesTreeEntities[i]=s};for(const i in e)t(i)}setResources(e){this.__resources=Object.assign(this.__resources,e),this.__buildTree(e),this.__applyCallbacks(e)}addResourceURL(e,t){const i=e.split("/"),s=i.pop();if(!t){let s=window.location.href.split("#")[0];s=s.split("?")[0],(s.endsWith(".html")||s.endsWith(".html"))&&(s=s.substring(0,s.lastIndexOf("/"))+"/");const a=s;if("."==i[0])i.shift();else if(".."==i[0]){item=item.substring(3);const e=a.split("/");e.pop(),e.pop(),a=e.join("/")+"/"}t=a+e}let a;const r={};for(const e of i){const t=ei.hashStr(e);t in this.__resources||(this.__resources[t]={name:e,type:"folder",parent:a},r[t]=this.__resources[t]),a=t}const n=ei.hashStr(s),o={name:s,url:t,parent:a,id:n};this.__resources[n]=o,r[n]=o,this.__buildTree(r),this.__applyCallbacks(r)}updateFile(e){const t=!(e.id in this.__resources);if(this.__resources[e.id]=e,t){console.log("New file added");const t={};t[e.id]=e,this.__buildTree(t)}this.emit("fileUpdated",{fileId:e.id})}getFilepath(e){let t=this.__resources[e];const i=[t.name];for(;t.parent;)t=this.__resources[t.parent],i.splice(0,0,t.name);return i.join("/")}resourceAvailable(e){return e.indexOf(".")>0?(console.warn("Deprecation warning for resourceAvailable. Value should be a file id, not a path."),null!=this.resolveFilepath(e)):e in this.__resources}getFile(e){return this.__resources[e]}resolveFileId(e){const t=e.split("/");"."!=t[0]&&""!=t[0]||t.shift();let i=this.__resourcesTree;for(const s of t){if(!(s in i.children))throw new Error("Unable to resolve key:"+s+" of path:"+e);i=i.children[s]}return i.id}resolveFilename(e){return this.__resources[e].name}resolveURL(e){return this.__resources[e].url}traverse(e){const t=e=>{for(const t in e.children)i(e.children[t])},i=i=>{if(0==e(i))return!1;i.children&&t(i)};t(this.__resourcesTree)}}class ir extends Si{constructor(e){super(e),this.addParameter(new Hi("BackgroundColor",new mi("#eeeeee"))),this.addParameter(new ji("EnvMap")),this.addParameter(new Ai("Display EnvMap",!1)),this.addParameter(new Bi("EnvMapLOD",0))}}class sr extends us{constructor(e=5,t=50,i=new mi("#DCDCDC")){super("GridTree");const s=new Xs("gridMaterial","LinesShader");s.getParameter("BaseColor").setValue(i),s.getParameter("Overlay").setValue(0),s.visibleInGeomDataBuffer=!1;const a=new Ys(e,e,t,t,!0);this.addChild(new va("GridItem",a,s),!1);const r=new ws;r.setNumVertices(2),r.setNumSegments(1),r.setSegmentVertexIndices(0,0,1);const n=r.getVertexAttribute("positions");n.getValueRef(0).set(-.5*e,0,0),n.getValueRef(1).set(.5*e,0,0);const o=new Xs("gridXAxisMaterial","LinesShader");o.getParameter("BaseColor").setValue(new mi(i.luminance(),0,0)),o.getParameter("Overlay").setValue(0),o.visibleInGeomDataBuffer=!1,this.addChild(new va("xAxisLine",r,o),!1);const l=new Xs("gridYAxisMaterial","LinesShader");l.getParameter("BaseColor").setValue(new mi(0,i.luminance(),0)),l.getParameter("Overlay").setValue(0),l.visibleInGeomDataBuffer=!1;const h=new va("yAxisLine",r,l),d=new yi;d.ori.setFromAxisAndAngle(new di(0,0,1),.5*Math.PI),h.setGeomOffsetXfo(d),this.addChild(h,!1),this.setSelectable(!1);const c=this._cleanBoundingBox(this.__boundingBoxParam.getValue());this.__boundingBoxParam.setValue(c)}_cleanBoundingBox(e){return e.reset(),e}}oi.register("GridTreeItem",sr);const ar=new mi("#DCDCDC");class rr{constructor(e){e&&ms.setAdapter(new tr(e)),this.settings=new ir("Scene Settings"),this.root=new us("root"),this.root.addChild(this.settings)}getSettings(){return this.settings}getRoot(){return this.root}getResourceLoader(){return ms}setEnvMap(e){this.settings.getParameter("EnvMap").setValue(e)}setupGrid(e=5,t=50,i=ar){const s=new sr(e,t,i);return this.root.addChild(s,!1),s}toJSON(e={}){e.makeRelative=e=>e;return{root:this.root.toJSON(e)}}fromJSON(e,t={}){const i=[];t.resolvePath=(e,t)=>{if(!e)throw new Error("Path not specified");const s=this.root.resolvePath(e);s?t(s):i.push((()=>{const i=this.resolvePath(e);i?t(i):console.warn("Path unable to be resolved:"+e)}))},t.addPLCB=e=>i.push(e),t.settings=this.settings,e.root&&this.root.fromJSON(e.root,t);for(const e of i)e()}}class nr extends Da{constructor(e){super(e),this.__geomLibrary.on("loaded",(()=>{this.emit("geomsLoaded",{})})),this.__fileParam=this.addParameter(new fs("FilePath")),this.addParameterDeprecationMapping("DataFilePath","FilePath"),this.__fileParam.on("valueChanged",(()=>{this.__fileParam.getValue();const e=this.__fileParam.getUrl();this.load(e)}))}readBinary(e,t){t.versions["zea-engine"]||(t.versions["zea-mesh"]=new gs(e.loadStr()));const i=e.loadUInt32();return super.readBinary(e,t),t.versions["zea-engine"].compare([2,1,0])<0&&e.loadFloat32Vec2(),this.__geomLibrary.setNumGeoms(e.loadUInt32()),i}load(e){return new Promise(((t,i)=>{const s=e.lastIndexOf("/")>-1?e.substring(0,e.lastIndexOf("/"))+"/":"",a=e.lastIndexOf("/")>-1?e.substring(e.lastIndexOf("/")+1):"",r=a.substring(0,a.lastIndexOf("."));let n=0;const o={assetItem:this,versions:{}};ms.incrementWorkload(1),this.__geomLibrary.on("loaded",(()=>{ms.incrementWorkDone(1)})),ms.loadFile("archive",e).then((e=>{let i;if(e.tree2)i=new Ti(e.tree2.buffer,0,si.isMobileDevice);else{const t=e.tree?e.tree:e[Object.keys(e)[0]];i=new Ti(t.buffer,0,si.isMobileDevice),o.versions["zea-engine"]=new gs}if(n=this.readBinary(i,o),this.loaded=!0,this.emit("loaded"),0==n&&e.geoms)this.__geomLibrary.readBinaryBuffer(a,e.geoms.buffer,o);else{const e=s+r;this.__geomLibrary.loadGeomFilesStream(e,numGeomFiles,o)}t()}),(e=>{this.emit("error",e),i(e)}))}))}fromJSON(e,t,i){t||(t={}),t.assetItem=this;const s=()=>{super.fromJSON(e,t,i),i&&i()};if(e.params&&e.params.DataFilePath){this.__datafileLoaded=s;const i=e.params.DataFilePath;delete e.params.DataFilePath,this.__fileParam.fromJSON(i,t)}else s()}}oi.register("VLAAsset",nr);class or extends Da{constructor(e){super(e),this.addParameter(new Ai("splitObjects",!1)),this.addParameter(new Ai("splitGroupsIntoObjects",!1)),this.addParameter(new Ai("loadMtlFile",!0)),this.addParameter(new Bi("unitsConversion",1)),this.addParameter(new qi("defaultShader",""));const t=this.addParameter(new fs("FilePath"));t.on("valueChanged",(()=>{this.loaded=!1;const e=t.getUrl();this.load(e)}))}load(e){return new Promise(((t,i)=>{const s=e.substring(0,e.lastIndexOf("/"))+"/",a=e.substring(e.lastIndexOf("/")+1),r=e=>{const t=e.split("\n"),i=/\s+/;let a;const r=function(e){if(3==e.length)return new mi(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]));throw new Error("Unable to parse a color from the following parts:"+e.join("_"))},n=e=>new FileImage(e[0],s+e[0]);for(let e=0;e<t.length;e++){let s=t[e].trim();if(s.startsWith("#"))continue;s.includes("#")&&(s=s.substring(0,s.indexOf("#")).trim());const o=s.split(i),l=o.shift(),h=o.join(" ");switch(l){case"newmtl":a=new Xs(h),a.setShaderName("StandardSurfaceShader"),this.__materials.addMaterial(a);break;case"Kd":a.getParameter("BaseColor").setValue(r(o));break;case"map_Kd":a.getParameter("BaseColor").setValue(n(o));break;case"Ks":const e=(parseFloat(o[0])+parseFloat(o[1])+parseFloat(o[2]))/3;a.roughness=1-e,a.getParameter("Roughness").setValue(1-e),a.getParameter("Reflectance").setValue(e);break;case"map_Ks":a.getParameter("Roughness").setValue(n(o)),a.getParameter("Reflectance").setValue(.2);break;case"d":const t=parseFloat(h);t<1&&(a.setShaderName("TransparentSurfaceShader"),a.getParameter("Opacity").setValue(t));break;case"map_d":a.getParameter("alpha").setValue(parseFloat(o));break;case"map_bump":a.getParameter("normal").setValue(n(o))}}},n=e=>new Promise((t=>{Fi(e.url,(e=>{ms.incrementWorkDone(1),r(e),ms.incrementWorkDone(1),t()}))})),o=new Array,l=new Array,h=new Array,d={},c=async e=>{const t=e.split("\n"),i=/\s+/;let r,c,u=0;const m=e=>{if(e in d){let t=1;for(;e+String(t)in d;)t++;e+=String(t)}r={verticesRemapping:{},texCoordsRemapping:{},normalsRemapping:{},vertexIndices:[],texCoordIndices:[],normalIndices:[],numVertices:0,numTexCoords:0,numNormals:0,faceCounts:[],material:c},d[e]=r,u++};m(a);const g=this.getParameter("splitGroupsIntoObjects").getValue();for(let e=0;e<t.length;e++){let a=t[e].trim();if(a.startsWith("#"))continue;a.includes("#")&&(a=a.substring(0,a.indexOf("#")).trim());const _=a.split(i),f=_.shift(),p=_.join(" ");switch(f){case"":case"s":continue;case"mtllib":if(!this.getParameter("loadMtlFile").getValue())continue;ms.incrementWorkload(2);const e=ms.resolveFilepath(s+p);e&&await n(e);break;case"o":m(p);break;case"usemtl":c=p,m(p+Object.keys(d).length);break;case"g":g&&m(p?_.join("_"):"Group"+u);break;case"v":o.push(_.map((e=>parseFloat(e))));break;case"vt":h.push(_.map((e=>parseFloat(e))));break;case"vn":l.push(_.map((e=>parseFloat(e))));break;case"f":{const e=[],t=[],i=[];for(let s=0,a=_.length;s<a;s++){const a=_[s].split("/").map((e=>parseInt(e)-1)),n=a[0];let o=r.verticesRemapping[n];if(null==o&&(o=r.numVertices,r.verticesRemapping[n]=o,r.numVertices++),e.push(o),a.length>1&&!isNaN(a[1])){const e=a[1];t.push(e)}if(a.length>2&&!isNaN(a[2])){const e=a[2];i.push(e)}}r.vertexIndices.push(e),i.length>0&&r.normalIndices.push(i),t.length>0&&r.texCoordIndices.push(t),null==r.faceCounts[e.length-3]&&(r.faceCounts[e.length-3]=[]),r.faceCounts[e.length-3]++;break}default:console.warn("Unhandled line:"+a)}}},u=()=>{for(const e in d)0!=d[e].numVertices&&m(e,d[e]);this.emit("loaded"),this.getGeometryLibrary().emit("loaded"),this.emit("geomsLoaded"),t()},m=(e,t)=>{for(let e=0;e<t.faceCounts.length;e++)null==t.faceCounts[e]&&(t.faceCounts[e]=0);const i=t.numVertices,s=new Ms(e);s.setFaceCounts(t.faceCounts),s.setNumVertices(i);const a=s.getVertexAttribute("positions"),r=this.getParameter("unitsConversion").getValue();for(const e in t.verticesRemapping){const i=t.verticesRemapping[e];a.getValueRef(i).set(o[e][0]*r,o[e][1]*r,o[e][2]*r)}let n,d;t.normalIndices.length>0&&(n=s.addVertexAttribute("normals",di)),t.texCoordIndices.length>0&&(d=s.addVertexAttribute("texCoords",hi));const c=Array(t.faceCounts.length).fill(0);for(let e=0;e<t.vertexIndices.length;e++){const i=t.vertexIndices[e];let a=0;for(let e=0;e<i.length-3;++e)t.faceCounts[e]&&(a+=t.faceCounts[e]);if(a+=c[i.length-3],c[i.length-3]++,s.setFaceVertexIndices(a,i),n){const i=t.normalIndices[e];for(let e=0;e<i.length;e++){const t=new di(l[i[e]][0],l[i[e]][1],l[i[e]][2]);n.setFaceVertexValue(a,e,t)}}if(d&&t.texCoordIndices.length==t.vertexIndices.length){const i=t.texCoordIndices[e];for(let e=0;e<i.length;e++){const t=new hi(h[i[e]][0],h[i[e]][1]);d.setFaceVertexValue(a,e,t)}}}const u=new va(e,s),m=s.getBoundingBox().center();{const e=m.negate(),t=s.getVertexAttribute("positions");for(let i=0;i<t.length;i++)t.getValueRef(i).addInPlace(e);s.setBoundingBoxDirty()}if(u.getParameter("LocalXfo").setValue(new yi(m)),null!=t.material&&this.__materials.hasMaterial(t.material))u.getParameter("Material").setValue(this.__materials.getMaterial(t.material));else{const t=this.getParameter("defaultShader").getValue(),i=new Xs(e+"mat");i.setShaderName(""!=t?t:"StandardSurfaceShader"),this.__materials.addMaterial(i),u.getParameter("Material").setValue(i)}this.addChild(u,!1)};(()=>{ms.incrementWorkload(2),Fi(e,(e=>{ms.incrementWorkDone(1),c(e).then((()=>{u(),ms.incrementWorkDone(1)}))}),(e=>{this.emit("error",e),i(e)}))})()}))}}class lr extends os{constructor(e){super(e),this.__input=this.addInput(new rs("Input"))}addRoute(e){const t=this.addOutput(new ns("Output"+this.__outputs.size));return e&&t.setParam(e),t}evaluate(){if(this.__input.isConnected()){const e=this.__input.getValue();let t=this.__outputs.size;for(;t--;){this.getOutputByIndex(t).setClean(e)}}else{let e=this.__outputs.size;for(;e--;){this.getOutputByIndex(e).setClean(0)}}}}oi.register("RouterOperator",lr);class hr extends Mi{constructor(){super(),this.__activated=!1}activateTool(){if(this.__activated)throw new Error("Tool already activate");this.__activated=!0,this.emit("activatedChanged",{activated:this.__activated})}deactivateTool(){this.__activated=!1,this.emit("activatedChanged",{activated:this.__activated})}onPointerDown(e){}onPointerMove(e){}onPointerUp(e){}onPointerDoublePress(e){}onPointerEnter(e){}onPointerLeave(e){}onWheel(e){}onKeyDown(e){}onKeyUp(e){}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onTouchCancel(e){}onDoubleTap(e){}onVRControllerButtonDown(e){}onVRControllerButtonUp(e){}onVRControllerDoubleClicked(e){}onVRPoseChanged(e){}}const dr={OPAQUE:1,TRANSPARENT:2,OVERLAY:4};class cr extends Mi{constructor(){super(),this.enabled=!0,this.passIndex=0;const e=this.addParameter(new Ai("Enabled",!0));e.on("valueChanged",(()=>this.enabled=e.getValue()))}__parameterValueChanged(e){super.__parameterValueChanged(e),this.renderer&&this.renderer.requestRedraw()}init(e,t){if(null==t)throw new Error("Missing constructor argument.");this.__gl=e.gl,this.renderer=e,this.__renderer=e,this.passIndex=t,this.__passIndex=t}setPassIndex(e){this.passIndex=e,this.__passIndex=e}getPassType(){return dr.OPAQUE}itemAddedToScene(e,t){throw Error(`${this.constructor.name} must implement itemAddedToScene and itemRemovedFromScene`)}itemRemovedFromScene(e,t){throw Error(`${this.constructor.name} must implement itemAddedToScene and itemRemovedFromScene`)}startPresenting(){}stopPresenting(){}draw(e){}drawHighlightedGeoms(e){}drawGeomData(e){}getGeomItemAndDist(e){}}const ur={pan:0,dolly:1,focussing:2,look:3,turntable:4,tumbler:5,trackball:6};class mr extends hr{constructor(e){super(),this.appData=e,this.__defaultManipulationState=ur.turntable,this.__manipulationState=this.__defaultManipulationState,this.__pointerDown=!1,this.__dragging=0,this.aimFocusOnSingleTap=!0,this.aimFocusOnDoubleTap=!1,this.enabledWASDWalkMode=!1,this.__keyboardMovement=!1,this.__keysPressed=[],this.__velocity=new di,this.__prevVelocityIntegrationTime=-1,this.__ongoingTouches={},this.__orbitRateParam=this.addParameter(new Bi("OrbitRate",si.isMobileDevice?.5:1)),this.__dollySpeedParam=this.addParameter(new Bi("DollySpeed",.02)),this.addParameter(new Ai("OrbitAroundCursor",!0)),this.__mouseWheelDollySpeedParam=this.addParameter(new Bi("MouseWheelDollySpeed",.1)),this.addParameter(new Bi("WalkSpeed",5)),this.addParameter(new Ai("WalkModeCollisionDetection",!1)),this.addParameterDeprecationMapping("orbitRate","OrbitRate"),this.addParameterDeprecationMapping("dollySpeed","DollySpeed"),this.addParameterDeprecationMapping("mouseWheelDollySpeed","MouseWheelDollySpeed")}activateTool(){super.activateTool(),this.appData&&this.appData.renderer&&(this.prevCursor=this.appData.renderer.getGLCanvas().style.cursor,this.appData.renderer.getGLCanvas().style.cursor="cursor")}deactivateTool(){super.deactivateTool(),this.appData&&this.appData.renderer&&(this.appData.renderer.getGLCanvas().style.cursor=this.appData.renderer.getGLCanvas().style.cursor)}setDefaultManipulationMode(e){if(this.__defaultManipulationState="string"==typeof e?ur[e]:e,!Object.values(ur).includes(this.__defaultManipulationState))throw new Error("Invalid Camera Manipulation Mode. Must be one of "+Object.keys(ur))}look(e,t){const{viewport:i}=e,s=i.getCamera(),a=this.__orbitRateParam.getValue(),r=s.getParameter("GlobalXfo").getValue(),n=new pi;n.rotateZ(t.x/i.getWidth()*Math.PI*a),r.ori=n.multiply(r.ori);const o=new pi;o.rotateX(t.y/i.getHeight()*Math.PI*a),r.ori.multiplyInPlace(o),s.getParameter("GlobalXfo").setValue(r)}turntable(e,t){const{viewport:i}=e,s=i.getCamera(),a=this.__orbitRateParam.getValue(),r=s.getParameter("GlobalXfo").getValue(),n=r.ori.inverse().rotateVec3(r.tr.subtract(this.__orbitTarget)),o=new pi;o.rotateZ(t.x/i.getWidth()*2*Math.PI*-a),r.ori=o.multiply(r.ori);const l=new pi;l.rotateX(t.y/i.getHeight()*Math.PI*-a),r.ori.multiplyInPlace(l),r.tr=this.__orbitTarget.add(r.ori.rotateVec3(n)),s.getParameter("GlobalXfo").setValue(r)}tumbler(e,t){const{viewport:i}=e,s=i.getCamera(),a=this.__orbitRateParam.getValue(),r=s.getParameter("GlobalXfo").getValue(),n=r.ori.getXaxis(),o=r.ori.getYaxis(),l=r.ori.getZaxis(),h=n.scale(-t.x).add(o.scale(t.y)).cross(l);h.normalizeInPlace();const d=t.length(),c=r.ori.inverse().rotateVec3(r.tr.subtract(this.__orbitTarget)),u=new pi;u.setFromAxisAndAngle(h,d/i.getWidth()*Math.PI*-a),r.ori=u.multiply(r.ori),r.tr=this.__orbitTarget.add(r.ori.rotateVec3(c)),s.getParameter("GlobalXfo").setValue(r)}trackball(e,t){const{viewport:i}=e,s=i.getCamera(),a=this.__orbitRateParam.getValue(),r=s.getParameter("GlobalXfo").getValue(),n=r.ori.getXaxis(),o=r.ori.getYaxis(),l=r.ori.getZaxis(),h=n.scale(-t.x).add(o.scale(t.y)).cross(l);h.normalizeInPlace();const d=t.length(),c=r.ori.inverse().rotateVec3(r.tr.subtract(this.__orbitTarget)),u=new pi;u.setFromAxisAndAngle(h,d/i.getWidth()*Math.PI*-a),r.ori=u.multiply(r.ori),r.tr=this.__orbitTarget.add(r.ori.rotateVec3(c)),s.getParameter("GlobalXfo").setValue(r)}pan(e,t){const{viewport:i}=e,s=i.getCamera(),a=s.getFocalDistance(),r=s.getFov(),n=new di(1,0,0),o=new di(0,1,0),l=2*a*Math.tan(.5*r),h=l*(i.getWidth()/i.getHeight()),d=new yi;d.tr=n.scale(-t.x/i.getWidth()*h),d.tr.addInPlace(o.scale(t.y/i.getHeight()*l));const c=s.getParameter("GlobalXfo").getValue();s.getParameter("GlobalXfo").setValue(c.multiply(d))}dolly(e,t){const{viewport:i}=e,s=i.getCamera(),a=t.x*this.__dollySpeedParam.getValue(),r=new yi;r.tr.set(0,0,a);const n=s.getParameter("GlobalXfo").getValue();s.getParameter("GlobalXfo").setValue(n.multiply(r))}initDrag(e){const{pointerPos:t}=e;e.setCapture(this),this.__pointerDown=!0;const{viewport:i}=e,s=i.getCamera(),a=s.getParameter("GlobalXfo").getValue(),r=this.getParameter("OrbitAroundCursor").getValue();if(null!=e.intersectionData&&r){this.__orbitTarget=e.intersectionData.intersectionPos;const t=a.tr.subtract(e.intersectionData.intersectionPos);s.setFocalDistance(t.length())}else this.__orbitTarget=a.tr.add(a.ori.getZaxis().scale(-s.getFocalDistance()));this.__prevPointerPos=t,this.__dragging=1}endDrag(e){e.getCapture()==this&&e.releaseCapture(),this.__dragging=0,this.__pointerDown=!1}aimFocus(e,t,i=-1,s=400){this.__focusIntervalId&&clearInterval(this.__focusIntervalId);const a=Math.round(s/20),r=this.__manipulationState;let n=0;const o=()=>{const s=e.getParameter("GlobalXfo").getValue(),l=e.getFocalDistance(),h=t.subtract(s.tr),d=h.normalizeInPlace(),c=s.clone();if(r==ur.turntable||r==ur.look){{const e=s.ori.getZaxis().clone();e.z=0;const t=h.negate();t.z=0;const i=new pi;i.setFrom2Vectors(e,t),c.ori=i.multiply(c.ori)}{const e=s.ori.getXaxis().clone(),t=s.ori.getZaxis().clone(),i=h.negate();i.subtractInPlace(e.scale(i.dot(e))),i.normalizeInPlace();const a=new pi;t.cross(i).dot(e)>0?a.rotateX(t.angleTo(i)):a.rotateX(-t.angleTo(i)),c.ori=c.ori.multiply(a)}{const e=c.ori.getXaxis().clone(),t=e.clone();t.z=0,t.normalizeInPlace();const i=new pi;i.setFrom2Vectors(e,t),c.ori=i.multiply(c.ori)}}else{const e=s.ori.getZaxis().clone(),t=h.negate(),i=new pi;i.setFrom2Vectors(e,t),c.ori=i.multiply(c.ori)}const u=Math.pow(n/a,2),m=s.clone();if(m.ori=s.ori.lerp(c.ori,u),i>0){const e=h.scale(d-i);m.tr.addInPlace(e.scale(u))}e.setFocalDistance(l+(d-l)*u),e.getParameter("GlobalXfo").setValue(m),n++,n<=a?this.__focusIntervalId=setTimeout(o,20):(this.__focusIntervalId=void 0,this.emit("movementFinished",{}),e.emit("movementFinished",{}))};o()}orientPointOfView(e,t,i,s=0,a=400){this.__focusIntervalId&&clearInterval(this.__focusIntervalId);const r=Math.round(a/20);let n=0;const o=()=>{const a=e.getParameter("GlobalXfo").getValue(),l=e.getTargetPosition(),h=Math.pow(n/r,2),d=t.subtract(a.tr),c=d.normalizeInPlace(),u=d.scale(c-s),m=a.tr.add(u.scale(h)),g=l.lerp(i,h);e.setPositionAndTarget(m,g),n++,n<=r?this.__focusIntervalId=setTimeout(o,20):(this.__focusIntervalId=void 0,this.emit("movementFinished"),e.emit("movementFinished"))};o()}onPointerDoublePress(e){if(e.intersectionData&&this.aimFocusOnDoubleTap){const{viewport:t}=e,i=t.getCamera(),s=i.getParameter("GlobalXfo").getValue().tr.add(e.pointerRay.dir.scale(e.intersectionData.dist));this.aimFocus(i,s),e.aimTarget=s,e.aimDistance=e.intersectionData.dist,this.emit("aimingFocus",e),i.emit("aimingFocus",e),e.stopPropagation(),e.preventDefault()}}onPointerDown(e){e.pointerType===ti.mouse?(1==this.__dragging&&this.endDrag(e),this.initDrag(e),2==e.button?this.__manipulationState=ur.pan:e.ctrlKey&&e.altKey?this.__manipulationState=ur.dolly:e.ctrlKey||2==e.button?this.__manipulationState=ur.look:this.__manipulationState=this.__defaultManipulationState):e.pointerType===ti.touch&&this._onTouchStart(e),e.stopPropagation(),e.preventDefault()}onPointerMove(e){0!=this.__dragging&&(e.pointerType===ti.mouse&&this._onMouseMove(e),e.pointerType===ti.touch&&this._onTouchMove(e),this.__dragging=2,e.stopPropagation(),e.preventDefault())}_onMouseMove(e){if(!this.__pointerDown)return;const t=e.pointerPos,i=t.subtract(this.__prevPointerPos);switch(this.__manipulationState){case ur.turntable:this.turntable(e,i);break;case ur.tumbler:this.tumbler(e,i);break;case ur.trackball:this.trackball(e,i);break;case ur.look:this.look(e,i);break;case ur.pan:this.pan(e,t.subtract(this.__prevPointerPos));break;case ur.dolly:this.dolly(e,i)}this.__prevPointerPos=t}_onTouchMove(e){const t=e.touches;if(1==t.length){const i=t[0],s=new hi(i.clientX,i.clientY),a=this.__ongoingTouches[i.identifier];if(!a)return;const r=s.subtract(a.pos);switch(this.__defaultManipulationState){case ur.look:r.scaleInPlace(6),this.look(e,r);break;case ur.turntable:this.turntable(e,r);break;case ur.tumbler:this.tumbler(e,r);break;case ur.trackball:this.trackball(e,r)}a.pos=s}else if(2==t.length){const i=t[0],s=this.__ongoingTouches[i.identifier],a=t[1],r=this.__ongoingTouches[a.identifier];if(!s||!r)return;const n=new hi(i.clientX,i.clientY),o=new hi(a.clientX,a.clientY),l=r.pos.subtract(s.pos).length()-o.subtract(n).length(),h=n.subtract(s.pos),d=o.subtract(r.pos),c=h.add(d);c.scaleInPlace(.5);const u=.002*l,{viewport:m}=e,g=m.getCamera(),_=g.getFocalDistance(),f=g.getFov(),p=new di(1,0,0),b=new di(0,1,0),y=2*_*Math.tan(.5*f),G=y*(m.getWidth()/m.getHeight()),X=new yi;X.tr=p.scale(-c.x/m.getWidth()*G),X.tr.addInPlace(b.scale(c.y/m.getHeight()*y));const x=u*_;switch(g.setFocalDistance(_+x),X.tr.z+=x,this.__defaultManipulationState){case ur.tumbler:case ur.trackball:const e=r.pos.subtract(s.pos),t=o.subtract(n);let i=e.normalize().angleTo(t.normalize());e.cross(t)<0&&(i=-i);const a=new pi;a.rotateZ(i),X.ori.multiplyInPlace(a)}const I=g.getParameter("GlobalXfo").getValue();g.getParameter("GlobalXfo").setValue(I.multiply(X)),s.pos=n,r.pos=o}}onPointerUp(e){if(1==this.__dragging){if(this.endDrag(e),e.intersectionData&&this.aimFocusOnSingleTap){const{viewport:t}=e,i=t.getCamera(),s=i.getParameter("GlobalXfo").getValue().tr.add(e.pointerRay.dir.scale(e.intersectionData.dist));this.aimFocus(i,s),e.aimTarget=s,e.aimDistance=e.intersectionData.dist,this.emit("aimingFocus",e),i.emit("aimingFocus",e)}e.stopPropagation(),e.preventDefault()}else if(2==this.__dragging){if(e.pointerType===ti.mouse)this.endDrag(e),this.emit("movementFinished",{}),e.viewport.getCamera().emit("movementFinished",{});else if(e.pointerType===ti.touch){e.preventDefault();const{changedTouches:t,touches:i}=e;for(let e=0;e<t.length;e++)this.__endTouch(t[e]);0==Object.keys(this.__ongoingTouches).length?this.endDrag(e):i.length||(this.endDrag(e),this.__ongoingTouches={})}e.stopPropagation(),e.preventDefault()}}onPointerEnter(e){}onPointerLeave(e){this.__keysPressed.length>0&&(this.__keysPressed=[],this.__velocity.set(0,0,0),this.__keyboardMovement=!1)}onWheel(e){const{viewport:t}=e,i=t.getCamera(),s=this.__mouseWheelDollySpeedParam.getValue(),a=e.shiftKey?.1:.5,r=i.getParameter("GlobalXfo").getValue();let n;if(null!=e.intersectionData){const t=r.tr.subtract(e.intersectionData.intersectionPos);n=t.normalize(),i.setFocalDistance(t.length())}else n=r.ori.getZaxis();const o=e.deltaY<0||e.wheelDelta>0||e.deltaY<0?-1:1,l=()=>{const e=i.getFocalDistance()*this.__mouseWheelMovementDist;r.tr.addInPlace(n.scale(e)),i.setFocalDistance(i.getFocalDistance()+e),i.getParameter("GlobalXfo").setValue(r),this.__mouseWheelZoomCount++,this.__mouseWheelZoomCount<6?this.__mouseWheelZoomId=setTimeout(l,10):(this.__mouseWheelZoomId=void 0,this.emit("movementFinished",{}),i.emit("movementFinished",{event:"onWheel"}))};this.__mouseWheelZoomId?(this.__mouseWheelMovementDist+=o*s*a*.5/6,this.__mouseWheelZoomCount=0):(this.__mouseWheelMovementDist=o*s*a/6,this.__mouseWheelZoomCount=0,l()),e.preventDefault(),e.stopPropagation()}integrateVelocityChange(e){const{viewport:t}=e,i=t.getCamera(),s=performance.now();if(this.__prevVelocityIntegrationTime>0){const e=(s-this.__prevVelocityIntegrationTime)/1e3,a=this.getParameter("WalkSpeed").getValue();if(a>0){const s=new yi;s.tr=this.__velocity.normalize().scale(a*e);const r=i.getParameter("GlobalXfo").getValue().multiply(s);if(this.getParameter("WalkModeCollisionDetection").getValue()){const e=1.5,i=1.5,s=.5,a=new yi(r.tr),n=new bi(r.tr,new di(0,0,-1)),o=t.getRenderer().raycastCluster(a,n,i,s,dr.OPAQUE);if(o.length>0){let t=0;o.forEach((e=>{t+=e.dist})),t/=o.length,r.tr=n.start.add(n.dir.scale(t-e))}}i.getParameter("GlobalXfo").setValue(r)}}this.__prevVelocityIntegrationTime=s}onKeyDown(e){if(!this.enabledWASDWalkMode)return;const t=e.key.toLowerCase();if(!this.__keysPressed.includes(t)){switch(t){case"w":this.__velocity.z-=1;break;case"s":this.__velocity.z+=1;break;case"a":this.__velocity.x-=1;break;case"d":this.__velocity.x+=1;break;default:return}if(e.stopPropagation(),this.__keysPressed.push(t),!this.__keyboardMovement){this.__keyboardMovement=!0,this.__prevVelocityIntegrationTime=performance.now();const t=()=>{this.integrateVelocityChange(e),this.__keyboardMovement&&window.requestAnimationFrame(t)};window.requestAnimationFrame(t)}}}onKeyUp(e){const t=e.key.toLowerCase();if(!this.__keysPressed.includes(t))return;switch(t){case"w":this.__velocity.z+=1;break;case"s":this.__velocity.z-=1;break;case"a":this.__velocity.x+=1;break;case"d":this.__velocity.x-=1;break;default:return}e.stopPropagation();const i=this.__keysPressed.indexOf(t);this.__keysPressed.splice(i,1),0==this.__keysPressed.length&&(this.__keyboardMovement=!1)}__startTouch(e){this.__ongoingTouches[e.identifier]={identifier:e.identifier,pos:new hi(e.clientX,e.clientY)}}__endTouch(e){delete this.__ongoingTouches[e.identifier]}_onTouchStart(e){const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__startTouch(t[e]);this.initDrag(e)}onTouchEnd(e){e.preventDefault(),e.stopPropagation();const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__endTouch(t[e]);0==Object.keys(this.__ongoingTouches).length&&this.endDrag(e)}onTouchCancel(e){e.preventDefault();const t=e.touches;for(let e=0;e<t.length;e++)this.__endTouch(t[e]);0==Object.keys(this.__ongoingTouches).length&&this.endDrag(e)}static get MANIPULATION_MODES(){return ur}}const gr={registerClass:(e,t)=>{console.warn("'sgFactory' is deprecated, Please use 'Registry.register'"),oi.register(e,t)},constructClass:(e,...t)=>{console.warn("'sgFactory' is deprecated, Please use 'Registry.constructClass'"),oi.constructClass(e,...t)}};var _r=Object.freeze({__proto__:null,RefCounted:wi,ParameterOwner:Mi,BaseItem:Si,getFileFolder:Zi,loadTextfile:Fi,loadJSONfile:Ei,loadXMLfile:zi,loadBinfile:Ni,resourceLoader:ms,Version:gs,BinReader:Ti,BinWriter:_s,OperatorOutputMode:Pi,Parameter:Wi,MultiChoiceParameter:Yi,BooleanParameter:Ai,NumberParameter:Bi,Vec2Parameter:Di,Vec3Parameter:ki,Vec4Parameter:Ki,ColorParameter:Hi,QuatParameter:Ui,Mat3Parameter:Oi,Mat4Parameter:Ji,XfoParameter:Qi,ImageParameter:ji,StringParameter:qi,CodeParameter:$i,ListParameter:es,StructParameter:ts,TreeItemParameter:is,ItemSetParameter:ss,GeometryParameter:as,FilePathParameter:fs,MaterialParameter:xs,MaterialFloatParam:bs,MaterialColorParam:ys,Attribute:Is,BaseGeom:vs,VertexAttribute:Vs,Points:Rs,Lines:ws,Mesh:Ms,BaseProxy:Ts,PointsProxy:Ls,LinesProxy:Ss,MeshProxy:Zs,ProceduralPoints:Cs,ProceduralLines:Fs,ProceduralMesh:Es,PointGrid:zs,Rect:Ns,Circle:Ps,Cross:Ws,LinesCuboid:Bs,Grid:Ys,Cone:As,Cuboid:Ds,Cylinder:ks,Disc:Ks,Plane:Hs,Sphere:Us,Torus:Os,DataImage:Js,FileImage:js,FileImage2D:qs,LDRImage:$s,LDRVideo:ea,GIFImage:_a,EnvMap:pa,Label:ya,VideoStreamImage2D:Ga,labelManager:ba,TreeItem:us,InstanceItem:Xa,BaseGeomItem:xa,GeomItem:va,AssetItem:Da,BillboardItem:ka,Camera:Ka,BaseGroup:Ra,Group:Ja,SelectionSet:wa,KinematicGroup:ja,MaterialGroup:qa,CuttingPlane:er,GeomLibrary:Ya,Material:Xs,BaseImage:ps,MaterialLibrary:Aa,Scene:rr,GridTreeItem:sr,VLAAsset:nr,ObjAsset:or,Operator:os,OperatorInput:rs,OperatorOutput:ns,RouterOperator:lr,BaseTool:hr,CameraManipulator:mr,sgFactory:gr});const fr=function(e,t){let i=null;if(null!=t.webglContextType)try{i=e.getContext(t.webglContextType,t),i.name=t.webglContextType}catch(e){}else{["webgl2","webgl"].some((s=>{try{i=e.getContext(s,t),i.name=s}catch(e){}if(i)return!0}))}if(i)return i.sizeInBytes=function(e){switch(e){case this.BYTE:case this.UNSIGNED_BYTE:return 1;case this.SHORT:case this.UNSIGNED_SHORT:return 2;case this.INT:case this.UNSIGNED_INT:case this.FLOAT:return 4;default:throw new Error("unknown type")}},"webgl2"==i.name?(i.floatTexturesSupported=!0,i.__ext_float_linear=i.getExtension("OES_texture_float_linear"),i.__ext_texture_half_float_linear=i.getExtension("OES_texture_half_float_linear"),i.__ext_color_buffer_float=i.getExtension("EXT_color_buffer_float")):(i.__ext_float=i.getExtension("OES_texture_float"),i.__ext_float?(i.floatTexturesSupported=!0,i.__ext_float_linear=i.getExtension("OES_texture_float_linear")):console.warn("OES_texture_float is not available"),i.__ext_half_float=i.getExtension("OES_texture_half_float"),i.__ext_half_float&&(i.HALF_FLOAT=i.__ext_half_float.HALF_FLOAT_OES,i.floatTexturesSupported=!0,i.__ext_texture_half_float_linear=i.getExtension("OES_texture_half_float_linear")),i.__ext_color_buffer_float=i.getExtension("EXT_color_buffer_float"),i.__ext_std_derivatives=i.getExtension("OES_standard_derivatives"),i.__ext_Inst=i.getExtension("ANGLE_instanced_arrays"),i.__ext_Inst&&(i.vertexAttribDivisor=i.__ext_Inst.vertexAttribDivisorANGLE.bind(i.__ext_Inst),i.drawArraysInstanced=i.__ext_Inst.drawArraysInstancedANGLE.bind(i.__ext_Inst),i.drawElementsInstanced=i.__ext_Inst.drawElementsInstancedANGLE.bind(i.__ext_Inst)),i.__ext_VAO=i.getExtension("OES_vertex_array_object"),i.__ext_VAO&&(i.createVertexArray=i.__ext_VAO.createVertexArrayOES.bind(i.__ext_VAO),i.deleteVertexArray=i.__ext_VAO.deleteVertexArrayOES.bind(i.__ext_VAO),i.bindVertexArray=i.__ext_VAO.bindVertexArrayOES.bind(i.__ext_VAO)),i.__ext_element_index_uint=i.getExtension("OES_element_index_uint"),i.__ext_WEBGL_depth_texture=i.getExtension("WEBGL_depth_texture"),i.__ext_WEBGL_depth_texture&&(i.UNSIGNED_INT_24_8=i.__ext_WEBGL_depth_texture.UNSIGNED_INT_24_8_WEBGL),i.DRAW_FRAMEBUFFER=i.FRAMEBUFFER),i.__ext_frag_depth=i.getExtension("EXT_frag_depth"),i.setupInstancedQuad=function(){const e=new Float32Array([0,1,2,3]),t=new Uint16Array([0,1,2,2,1,3]);this.__quadVertexIdsBuffer=this.createBuffer(),this.bindBuffer(this.ARRAY_BUFFER,this.__quadVertexIdsBuffer),this.bufferData(this.ARRAY_BUFFER,e,this.STATIC_DRAW),this.__quadIndexBuffer=this.createBuffer(),this.bindBuffer(this.ELEMENT_ARRAY_BUFFER,this.__quadIndexBuffer),this.bufferData(this.ELEMENT_ARRAY_BUFFER,t,this.STATIC_DRAW),this.__quadattrbuffers={vertexIDs:{buffer:this.__quadVertexIdsBuffer,dataType:6,dimension:1,count:e.length,shared:!0}}},i.drawQuad=function(){this.drawElements(this.TRIANGLES,6,this.UNSIGNED_SHORT,0)},i.setupLineSegAttrBuffers=function(){const e=new Float32Array([0,1]),t=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,t),i.bufferData(i.ARRAY_BUFFER,e,i.STATIC_DRAW),i.__linesegattrbuffers={vertexIDs:{buffer:t,dimension:1,count:e.length,shared:!0}}},i};class pr extends wi{constructor(e,t){if(super(),this.__gl=e,this.ready=!1,this.width=0,this.height=0,this.textureType=1,this.textureDesc=[0,0,0,0],this.__loaded=!1,this.__bound=!1,null!=t)if(t instanceof ps){this.__texture=t,this.__texture.setMetadata("gltexture",this);const e=()=>{const e=this.__texture.getParams(),t=e.width,i=e.height,s=e.data;this.bufferData(s,t,i)};this.__texture.on("updated",e),this.__texture.isLoaded()?this.configure(this.__texture.getParams()):this.__texture.on("loaded",(()=>{this.configure(this.__texture.getParams())}))}else this.configure(t)}isLoaded(){return this.__loaded}getTexture(){return this.__texture}getInternalFormat(){return this.__internalFormat}getType(){return this.__typeParam}getTypeID(){return this.__type}getFormat(){return this.__formatParam}getFormatID(){return this.__format}getWrap(){return this.__wrapParam}getMipMapped(){return this.__mipMapped}configure(e,t=!0){if(!("type"in e&&"format"in e&&"width"in e&&"height"in e)){if(!e.type)throw new Error("Invalid texture params. 'type' not provided");if(!e.format)throw new Error("Invalid texture params. 'format' not provided");if(!e.width)throw new Error("Invalid texture params. 'width' not provided");if(!e.height)throw new Error("Invalid texture params. 'height' not provided")}const i=this.__gl,s=e.width,a=e.height,r=e.data,n=i.getParameter(i.MAX_TEXTURE_SIZE);if(s<=0||s>n||a<=0||a>n)throw new Error("gl-texture2d: Invalid texture size. width:"+s+" height:"+a+" maxSize:"+n);const o=e.format,l=e.type;let h="minFilter"in e?e.minFilter:"filter"in e?e.filter:"LINEAR",d="magFilter"in e?e.magFilter:"filter"in e?e.filter:"LINEAR";const c="wrapS"in e?e.wrapS:"wrap"in e?e.wrap:"CLAMP_TO_EDGE",u="wrapT"in e?e.wrapT:"wrap"in e?e.wrap:"CLAMP_TO_EDGE";if("FLOAT"==l)if(this.textureType=3,"webgl2"==i.name)"LINEAR"!=h||i.__ext_float_linear||(console.warn("Floating point texture filtering not supported on this device"),h="NEAREST"),"LINEAR"!=d||i.__ext_float_linear||(console.warn("Floating point texture filtering not supported on this device"),d="NEAREST");else if(i.__ext_float)"LINEAR"!=h||i.__ext_float_linear||(console.warn("Floating point texture filtering not supported on this device"),h="NEAREST"),"LINEAR"!=d||i.__ext_float_linear||(console.warn("Floating point texture filtering not supported on this device"),d="NEAREST");else{if(!i.__ext_half_float)throw new Error("OES_texture_half_float is not available");l="HALF_FLOAT","LINEAR"!=h||i.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on this device"),h="NEAREST"),"LINEAR"!=d||i.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on this device"),d="NEAREST")}else if("HALF_FLOAT"==l)if("webgl2"==i.name);else{if(!i.supportUploadingHalfFloat&&null!=r)throw new Error("Safari does not support uploading HALF_FLOAT texture data.");if(!i.__ext_half_float)throw new Error("OES_texture_half_float is not available");if("LINEAR"!=h||i.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on this device"),h="NEAREST"),"LINEAR"!=d||i.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on this device"),d="NEAREST"),"RGB"==o)throw new Error("OES_texture_half_float only supports RGBA textures")}else if("sRGB"==l&&!i.__ext_sRGB)throw new Error("EXT_sRGB is not available");this.__formatParam=o,this.__typeParam=l,this.__minFilterParam=h,this.__magFilterParam=d,this.__wrapSParam=c,this.__wrapTParam=u,1==this.textureType&&this.__format==i.RGBA&&(this.textureType=2),this.__format=i[o],this.__internalFormat="internalFormat"in e?i[e.internalFormat]:this.__format,this.__type=i[l],"webgl2"==i.name&&("internalFormat"in e||(this.__type==i.FLOAT?this.__format==i.RED?this.__internalFormat=i.R32F:this.__format==i.RG?this.__internalFormat=i.RG32F:this.__format==i.RGB?this.__internalFormat=i.RGB32F:this.__format==i.RGBA&&(this.__internalFormat=i.RGBA32F):this.__type==i.HALF_FLOAT?this.__format==i.RED?this.__internalFormat=i.R16F:this.__format==i.RG?this.__internalFormat=i.RG16F:this.__format==i.RGB?this.__internalFormat=i.RGB16F:this.__format==i.RGBA&&(this.__internalFormat=i.RGBA16F):this.__type==i.UNSIGNED_BYTE&&(this.__format==i.RED&&(this.__internalFormat=i.R8),this.__format==i.RG&&(this.__internalFormat=i.RG8),this.__format==i.RGB?this.__internalFormat=i.RGB8:this.__format==i.RGBA&&(this.__internalFormat=i.RGBA8)))),this.__minFilter=i[h],this.__magFilter=i[d],this.__wrapS=i[c],this.__wrapT=i[u],this.__flipY="flipY"in e&&e.flipY,this.__mipMapped="mipMapped"in e&&e.mipMapped,this.invert="invert"in e&&e.invert,this.alphaFromLuminance="alphaFromLuminance"in e&&e.alphaFromLuminance,this.textureDesc[0]=s,this.textureDesc[1]=a,this.__gltex&&i.deleteTexture(this.__gltex),this.__gltex=i.createTexture(),this.__updateGLTexParams(),r?this.bufferData(r,s,a,!1,!1):this.resize(s,a,!1,!1),this.__loaded||(this.emit("ready",{}),this.__loaded=!0)}__updateGLTexParams(){const e=this.__gl;e.bindTexture(e.TEXTURE_2D,this.__gltex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,this.__minFilter),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,this.__magFilter),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,this.__wrapS),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,this.__wrapT)}bufferData(e,t=-1,i=-1,s=!0,a=!0){const r=this.__gl;if(s&&r.bindTexture(r.TEXTURE_2D,this.__gltex),null!=e){if(e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLImageElement||e instanceof HTMLVideoElement)r.texImage2D(r.TEXTURE_2D,0,this.__internalFormat,this.__format,this.__type,e),this.width=e.width,this.height=e.height;else{-1==t&&(t=this.width),-1==i&&(i=this.height);const s=t*i;let a;switch(this.__format){case r.RED:case r.RED_INTEGER:case r.ALPHA:case r.LUMINANCE:case r.LUMINANCE_ALPHA:a=1;break;case r.RG:a=2,r.pixelStorei(r.UNPACK_ALIGNMENT,2);break;case r.RGB:a=3;break;case r.RGBA:a=4}e.length!=s*a&&console.warn("Invalid data for Image width:"+t+" height:"+i+" format:"+this.__formatParam+" type:"+this.__typeParam+" Data Length:"+e.length+" Expected:"+s*a),this.__type==r.HALF_FLOAT&&e instanceof Float32Array&&(e=jt.convertFloat32ArrayToUInt16Array(e)),"webgl2"==r.name?r.texImage2D(r.TEXTURE_2D,0,this.__internalFormat,t,i,0,this.__format,this.__type,e,0):r.texImage2D(r.TEXTURE_2D,0,this.__internalFormat,t,i,0,this.__format,this.__type,e),this.width=t,this.height=i}this.__mipMapped&&r.generateMipmap(r.TEXTURE_2D)}else r.texImage2D(r.TEXTURE_2D,0,this.__internalFormat,this.width,this.height,0,this.__format,this.__type,null),this.width=t,this.height=i;a&&this.emit("updated",{})}clear(){const e=this.__gl,t=this.width*this.height;let i,s;switch(this.__format){case e.RED:case e.RED_INTEGER:case e.ALPHA:case e.LUMINANCE:case e.LUMINANCE_ALPHA:i=1;break;case e.RG:i=2;break;case e.RGB:i=3;break;case e.RGBA:i=4;break;default:throw new Error("Invalid Format")}switch(this.__type){case e.UNSIGNED_BYTE:s=new UInt8Array(t*i);break;case e.HALF_FLOAT:s=new UInt16Array(t*i);break;case e.FLOAT:s=new Float32Array(t*i);break;default:throw new Error("Invalid Type")}"webgl2"==e.name?e.texImage2D(e.TEXTURE_2D,0,this.__internalFormat,this.width,this.height,0,this.__format,this.__type,s,0):e.texImage2D(e.TEXTURE_2D,0,this.__internalFormat,this.width,this.height,0,this.__format,this.__type,s)}resize(e,t,i=!1,s=!0){const a=this.__gl;if(this.width!=e||this.height!=t){const r=a.getParameter(a.MAX_TEXTURE_SIZE);if(e<0||e>r||t<0||t>r)throw new Error("gl-texture2d: Invalid texture size. width:"+e+" height:"+t+" maxSize:"+r);if(i){const i=a.createTexture();a.bindTexture(a.TEXTURE_2D,i),a.texImage2D(a.TEXTURE_2D,0,this.__internalFormat,e,t,0,this.__format,this.__type,null);const s=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,s),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.__gltex,0),a.bindTexture(a.TEXTURE_2D,i),a.copyTexImage2D(a.TEXTURE_2D,0,this.__internalFormat,0,0,this.width,this.height,0),a.bindFramebuffer(a.FRAMEBUFFER,null),a.deleteFramebuffer(s),this.__gl.deleteTexture(this.__gltex),this.__gltex=i,this.__updateGLTexParams()}else this.width>0&&this.height,a.bindTexture(a.TEXTURE_2D,this.__gltex),a.texImage2D(a.TEXTURE_2D,0,this.__internalFormat,e,t,0,this.__format,this.__type,null);this.width=e,this.height=t,s&&this.emit("resized",{width:e,height:t})}}populate(e,t,i,s=0,a=0,r=!0){const n=this.__gl;r&&n.bindTexture(n.TEXTURE_2D,this.__gltex),n.texSubImage2D(n.TEXTURE_2D,0,s,a,t,i,this.__format,this.__type,e)}getSize(){return[this.width,this.height]}get glTex(){return this.__gltex}getTexHdl(){return this.__gltex}bind(e,t){return console.warn("'bind' is deprecated. Please use 'bindToUniform'"),this.bindToUniform(e,t)}preBind(e,t){return{textureTypeUnif:t[e.name+"Type"],textureDescUnif:t[e.name+"Desc"]}}bindToUniform(e,t,i){if(!this.__loaded)return!1;if(!this.__gltex)throw new Error("Unable to bind non-initialized or deleted texture.");const s=e.boundTextures++,a=this.__gl.TEXTURE0+s,r=this.__gl;return r.activeTexture(a),r.bindTexture(r.TEXTURE_2D,this.__gltex),r.uniform1i(t.location,s),i&&(i.textureTypeUnif&&r.uniform1i(i.textureTypeUnif.location,this.textureType),i.textureDescUnif&&this.__gl.uniform4fv(i.textureDescUnif.location,this.textureDesc)),!0}destroy(){super.destroy(),this.__texture&&this.__texture.setMetadata("gltexture",void 0),this.__gl.deleteTexture(this.__gltex),this.__gltex=void 0}}const br={bool:Boolean,int:5,uint:4,float:6,ivec2:hi,ivec3:di,ivec4:ci,vec2:hi,vec3:di,vec4:ci,color:mi,mat3:_i,mat4:fi,sampler2D:ps,samplerCube:ps};const yr=new class{constructor(){this.__shaderModules={}}hasShaderModule(e){return e in this.__shaderModules}setShaderModule(e,t){return this.parseShader(e,t)}getShaderModule(e){return this.__shaderModules[e]}getShaderModuleNames(){const e=[];for(const t in this.__shaderModules)e.push(t);return e}parseShader(e,t){const i=e=>{if(e.startsWith("..")){return s.substring(0,s.lastIndexOf("/"))+e.substring(2)}return e.startsWith(".")?s+e.substring(1):e.startsWith("/")?e.substring(1):e};ei.hashStr(e);const s=e.substring(0,e.lastIndexOf("/")),a=t.split("\n"),r={glsl:" //starting:"+e+"\n",lines:a,numLines:0,includeMetaData:[],uniforms:{},attributes:{}},n=/\s+/;for(let t=0;t<a.length;t++){let s=a[t],o=s.trim();if(o.startsWith("//")||o.startsWith("*"))r.glsl=r.glsl+s+"\n",r.numLines++;else if(o.includes("//")&&(o=o.slice(0,o.indexOf("//")).trim()),o.startsWith("<%")||o.startsWith("</%")){const o=function(e){const t=(e=(e=e.startsWith("</%")?e.slice(3):e.slice(2)).endsWith("/>")?e.slice(0,e.length-2):e.slice(0,e.length-1)).split(n),i={tag:t.shift(),attributes:{}};for(const e of t){const t=e.split("=");i.attributes[t[0]]=t[1].replace(/['"]+/g,"")}return i}(a[t].trim());switch(o.tag){case"include":{const s=i(o.attributes.file);if(!this.hasShaderModule(s))throw new Error("Error while parsing :"+e+" \nShader module not found:"+s+"\n in:"+this.getShaderModuleNames());const a=this.getShaderModule(s);ei.hashStr(o.attributes.file);let n=a.glsl;n=n.substring(n.indexOf("\n")+1),r.glsl=r.glsl+" //including:"+o.attributes.file+"\n";const l={};for(const e in o.attributes){if("file"==e)continue;const t=o.attributes[e];n=ei.replaceAll(n,e,t),l[e]=t}r.glsl=r.glsl+n,r.includeMetaData.push({src:r.numLines,tgt:t,length:a.numLines,key:s}),r.glsl=r.glsl+" //continuing:"+e+"\n",r.numLines+=a.numLines+1;for(const e in a.attributes){let t=e;for(const e in l)t=ei.replaceAll(t,e,l[e]);r.attributes[t]=a.attributes[e]}for(const e in a.uniforms){let t=e;for(const e in l)t=ei.replaceAll(t,e,l[e]);r.uniforms[t]=a.uniforms[e]}break}default:console.warn("Error while parsing :"+e+" \nUnhandled line:"+s);continue}}else{const i=(t,i)=>{if(!(t[1]in br))throw new Error("Error while parsing :"+e+" \nType not recognized:"+t[1]);const a=t[2].slice(0,t[2].length-1);r.attributes[a]={type:br[t[1]],instanced:i},"color"==t[1]&&(t[1]="vec4",s=t.join(" "))};if(o.startsWith("struct")){let e="";if(o.includes("}"))e=o.substring(o.indexOf("{")+1,o.indexOf("}")-1);else for(t++;s+=a[t]+"\n",e+=s.trim(),t++,!e.includes("}"););const i=e.substring(e.indexOf("{")+1,e.indexOf("}")-1).split(";"),r=[];for(const e of i){if(0==e.length)continue;const t=e.trim().split(n);r.push({name:t[1],type:br[t[0]]})}const l=o.split(n);br[l[1]]=r}if(o.startsWith("attribute")){i(o.split(n),!1)}if(o.startsWith("instancedattribute")){const e=o.split(n);i(e,!0),e[0]="attribute",s=e.join(" ")}else if(o.startsWith("uniform")){const t=o.split(n);let i=1;4==t.length&&(i=2);const a=t[i];if(!(a in br))throw new Error("Error while parsing :"+e+" \nType not recognized:"+t[1]);const l=t[i+1].slice(0,t[i+1].length-1);l.includes("[")?r.uniforms[l.substring(0,l.indexOf("["))]=br[a]:r.uniforms[l]=br[a],"struct"==r.uniforms[l]&&console.log(t),"color"==t[1]&&(t[1]="vec4",s=t.join(" "))}r.glsl=r.glsl+s+"\n",r.numLines++}}return this.__shaderModules[e]=r,r}};let Gr=0;class Xr extends Si{constructor(e,t){if(super(t),!e)throw new Error("gl context must be passed to shader constructor");this.__gl=e,this.__shaderStagesGLSL={},this.__shaderStages={},this.__shaderProgramHdls={},this.__gltextures={},this.__id=Gr++,this.invisibleToGeomBuffer=!1}setShaderStage(e,t){this.__shaderStagesGLSL[e]=t,this.clearProgramsCache()}getShaderStage(e){return this.__shaderStagesGLSL[e]}clearProgramsCache(){const e=this.__gl;for(const t in this.__shaderProgramHdls){const i=this.__shaderProgramHdls[t];for(const t in i.shaderHdls)e.deleteShader(i.shaderHdls[t]);e.deleteProgram(i.shaderProgramHdl)}}static isTransparent(){return!1}static isOverlay(){return!1}__compileShaderStage(e,t,i,s){const a=this.__gl;if(s||(s=a.shaderopts),s){if(s.repl)for(const t in s.repl)e=ei.replaceAll(e,t,s.repl[t]);if(s.directives){e=s.directives.join("\n")+"\n"+e}}let r;"webgl2"==a.name&&(e=ei.replaceAll(e,"attribute","in"),e="vertexShader"==i?ei.replaceAll(e,"varying","out"):ei.replaceAll(e,"varying","in"),r="#version 300 es\n",e="#version 300 es\n"+(e=ei.replaceAll(e,"texture2D","texture")));const n=a.createShader(t);if(a.shaderSource(n,e),a.compileShader(n),!a.getShaderParameter(n,a.COMPILE_STATUS)){console.log("Errors in :"+this.constructor.name);const t=a.getShaderInfoLog(n).split("\n"),s={};for(let e in t){if(t[e].startsWith("'")){t[e-1]=t[e-1]+t[e],delete t[e],e--;continue}const i=t[e].split(":");if(i.length>=2){const a=parseInt(i[2]);isNaN(a)||(s[a]?s[a].push(t[e]):s[a]=[t[e]])}}const r=[],o=e.split("\n");for(const e in s){const t=Number.parseInt(e)-1;for(let e=Math.max(0,t-4);e<t;e++)r.push((t+1+" ").padStart(" ",3)+o[e]);r.push((t+1+">").padStart(" ",3)+o[t]);for(let e=t+1;e<Math.min(o.length-1,t+5);e++)r.push((t+1+" ").padStart(" ",3)+o[e]);const i=s[e];for(const e of i)r.push(e)}throw new Error("An error occurred compiling the shader \n=================\n"+this.constructor.name+"."+i+": \n\n"+r.join("\n"))}return n}__createProgram(e){const t=this.__gl;this.__shaderCompilationAttempted=!0;const i=t.createProgram(),s={};this.__shaderStages.VERTEX_SHADER||(this.__shaderStages.VERTEX_SHADER=yr.parseShader("VERTEX_SHADER",this.__shaderStagesGLSL.VERTEX_SHADER));const a=this.__shaderStages.VERTEX_SHADER.glsl;if(null!=a){const r=this.__compileShaderStage(a,t.VERTEX_SHADER,"vertexShader",e);if(!r)return!1;t.attachShader(i,r),s[t.VERTEX_SHADER]=r}this.__shaderStages.FRAGMENT_SHADER||(this.__shaderStages.FRAGMENT_SHADER=yr.parseShader("FRAGMENT_SHADER",this.__shaderStagesGLSL.FRAGMENT_SHADER));const r=this.__shaderStages.FRAGMENT_SHADER.glsl;if(null!=r){const a=Object.assign({},t.shaderopts,e);a.frag&&(a.defines=a.frag.defines+a.defines);const n=this.__compileShaderStage(r,t.FRAGMENT_SHADER,"fragmentShader",a);if(!n)return!1;t.attachShader(i,n),s[t.FRAGMENT_SHADER]=n}if(t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS)){const e=t.getProgramInfoLog(i);if(e.includes("D3D shader compilation failed")){const e=t.getExtension("WEBGL_debug_shaders");if(e){const i=e.getTranslatedShaderSource(s[t.VERTEX_SHADER]);console.log(i)}}throw console.log("vertexShaderGLSL:"+a),console.log("fragmentShaderGLSL:"+r),new Error("Unable to link the shader program:"+this.constructor.name+"\n==================\n"+e)}const n=this.__extractAttributeAndUniformLocations(i,e);return n.shaderHdls=s,n.shaderProgramHdl=i,n}__extractAttributeAndUniformLocations(e,t){const i=this.__gl,s=this.getAttributes(),a={attrs:{},unifs:{}};for(const t in s){const r=i.getAttribLocation(e,t);if(null==r){console.warn("Shader attribute not found:"+t);continue}const n=s[t];a.attrs[t]={name:t,location:r,type:n.type,instanced:n.instanced}}const r=this.getUniforms();for(let s in r){const n=r[s];if(n instanceof Array)for(const t of n){const r=s+"."+t.name,n=i.getUniformLocation(e,r);null!=n&&(a.unifs[r]={name:r,location:n,type:t.type})}if(t&&t.repl)for(const e in t.repl)s=s.replace(e,t.repl[e]);const o=i.getUniformLocation(e,s);null!=o&&(a.unifs[s]={name:s,location:o,type:n})}return a}getAttributes(){const e={};for(const t in this.__shaderStages){const i=this.__shaderStages[t];for(const t in i.attributes)e[t]=i.attributes[t]}return e}getUniforms(){const e={};for(const t in this.__shaderStages){const i=this.__shaderStages[t];for(const t in i.uniforms)e[t]=i.uniforms[t]}return e}finalize(){}isCompiledForTarget(e){const t=e||this.getId();return null!=this.__shaderProgramHdls[t]}compileForTarget(e,t){const i=e||this.getId();let s=this.__shaderProgramHdls[i];return s||!1!==s&&(s=this.__createProgram(t),s.shaderkey=i,this.__shaderProgramHdls[i]=s),s}compile(){this.compileForTarget()}bind(e,t){const i=this.__gl;if(e.glShader!=this){const s=this.compileForTarget(t,e.shaderopts);if(!1===s)return console.warn(this.constructor.name+" is not compiled for "+t),!1;const a=s.shaderProgramHdl;i.useProgram(a),e.glShader=this,e.shaderkey=s.shaderkey,e.unifs=s.unifs,e.attrs=s.attrs,e.boundTextures=0,e.glGeom=void 0,e.bindRendererUnifs&&e.bindRendererUnifs(s.unifs)}return e.supportsInstancing=!0,!0}unbind(e){return delete e.glShader,delete e.shaderkey,delete e.unifs,delete e.attrs,!0}static getParamDeclarations(){return[]}static getGeomDataShaderName(){return null}static getSelectedShaderName(){return null}static supportsInstancing(){return!0}destroy(){const e=this.__gl;for(const t in this.__shaderProgramHdls){const i=this.__shaderProgramHdls[t];e.deleteProgram(i.shaderProgramHdl)}this.__shaderProgramHdls={}}}class xr{constructor(e,t,i=!1){!si.isIOSDevice||"FLOAT"!=t.getType()&&"HALF_FLOAT"!=t.getType()||console.error("IOS devices are unable to render to float textures."),this.__gl=e,this.__colorTexture=t,this.__createDepthTexture=i,this.__clearColor=[0,0,0,0],this.__depthTexture=void 0,this.setup=this.setup.bind(this),this.resize=this.resize.bind(this),this.__colorTexture&&this.__colorTexture.on("resized",(e=>{this.resize(this.__colorTexture.width,this.__colorTexture.height,!1)})),this.setup()}setClearColor(e){this.__clearColor=e}getWidth(){return this.__colorTexture.width}getHeight(){return this.__colorTexture.height}getSize(){return[this.__colorTexture.width,this.__colorTexture.height]}getColorTexture(){return this.__colorTexture}getDepthTextureGL(){return this.__depthTexture}get width(){return this.__colorTexture.width}get height(){return this.__colorTexture.height}get size(){return[this.__colorTexture.width,this.__colorTexture.height]}get colorTexture(){return this.__colorTexture}setColorTexture(e){this.__colorTexture=e,gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.__colorTexture.glTex,0)}get depthTextureGL(){return this.__depthTexture}setup(){const e=this.__gl;if(this.__fbo=e.createFramebuffer(),"webgl2"==e.name?e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this.__fbo):e.bindFramebuffer(e.FRAMEBUFFER,this.__fbo),this.__colorTexture&&("webgl2"==e.name?e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.__colorTexture.glTex,0):e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.__colorTexture.glTex,0)),this.__createDepthTexture)if("webgl2"==e.name||e.__ext_WEBGL_depth_texture)e.activeTexture(e.TEXTURE0),this.__depthTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.__depthTexture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),"webgl2"==e.name?(e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT24,this.width,this.height,0,e.DEPTH_COMPONENT,e.UNSIGNED_INT,null),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,this.__depthTexture,0)):(e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT,this.width,this.height,0,e.DEPTH_COMPONENT,e.UNSIGNED_INT,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,this.__depthTexture,0));else{const t=e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,t),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.width,this.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t)}this.__checkFramebuffer(),"webgl2"==e.name?e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null):e.bindFramebuffer(e.FRAMEBUFFER,null)}resize(e,t,i){const s=this.__gl;i&&this.__colorTexture.resize(e,t,!1,!1),"webgl2"==s.name?s.bindFramebuffer(s.DRAW_FRAMEBUFFER,this.__fbo):s.bindFramebuffer(s.FRAMEBUFFER,this.__fbo),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.__colorTexture.glTex,0),this.__depthTexture&&(s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.__depthTexture),"webgl2"==s.name?s.texImage2D(s.TEXTURE_2D,0,s.DEPTH_COMPONENT24,this.width,this.height,0,s.DEPTH_COMPONENT,s.UNSIGNED_INT,null):s.texImage2D(s.TEXTURE_2D,0,s.DEPTH_COMPONENT,this.width,this.height,0,s.DEPTH_COMPONENT,s.UNSIGNED_INT,null)),this.__checkFramebuffer()}__checkFramebuffer(){const e=this.__gl;let t;if(t="webgl2"==e.name?e.checkFramebufferStatus(e.DRAW_FRAMEBUFFER):e.checkFramebufferStatus(e.FRAMEBUFFER),t!==e.FRAMEBUFFER_COMPLETE)switch(e.bindTexture(e.TEXTURE_2D,null),"webgl2"==e.name?e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null):e.bindFramebuffer(e.FRAMEBUFFER,null),console.warn("Error creating Fbo width:",this.width,", height:",this.height," Texture Type:",this.__colorTexture.getType()),t){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete.");case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment.");case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error("Height and width of the attachment are not the same.");case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer.");case 36061:throw new Error("The framebuffer is unsupported");default:throw new Error("Incomplete Frambuffer")}}bindForWriting(e){e&&(this.__prevBoundFbo=e.boundRendertarget,e.boundRendertarget=this.__fbo);const t=this.__gl;"webgl2"==t.name?t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.__fbo):t.bindFramebuffer(t.FRAMEBUFFER,this.__fbo),t.viewport(0,0,this.width,this.height)}unbindForWriting(e){e&&(e.boundRendertarget=this.__prevBoundFbo);const t=this.__gl;"webgl2"==t.name?t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.__prevBoundFbo):t.bindFramebuffer(t.FRAMEBUFFER,this.__prevBoundFbo)}bind(e){this.bindForWriting(e)}unbind(e){this.unbindForWriting(e)}bindForReading(){const e=this.__gl;"webgl2"==e.name?e.bindFramebuffer(e.READ_FRAMEBUFFER,this.__fbo):e.bindFramebuffer(e.FRAMEBUFFER,this.__fbo)}unbindForReading(){const e=this.__gl;"webgl2"==e.name?e.bindFramebuffer(e.READ_FRAMEBUFFER,null):e.bindFramebuffer(e.FRAMEBUFFER,null)}clear(){const e=this.__gl;e.colorMask(!0,!0,!0,!0),e.clearColor(...this.__clearColor),this.__createDepthTexture?e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT):e.clear(e.COLOR_BUFFER_BIT)}bindAndClear(e){this.bind(e),this.clear(e)}unbind(){const e=this.__gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}destroy(){const e=this.__gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.deleteFramebuffer(this.__fbo),this.__fbo=null,this.__colorTexture.off("resized",this.resize)}}class Ir extends Jt{constructor(e,t){super(),this.__gl=e,this.textureTargets=[],this.depthTexture=null,this.textureDesc=[0,0,0,0],t&&this.configure(t)}configure(e){const t=this.__gl,i=function(e,t){if(!t.width||!t.height){if(!t.width)throw new Error("Invalid texture params. 'width' not provided");if(!t.height)throw new Error("Invalid texture params. 'height' not provided")}const i=e.getParameter(e.MAX_TEXTURE_SIZE);if(t.width<=0||t.width>i||t.height<=0||t.height>i)throw new Error("GLTextureParams: Invalid texture size. width:"+t.width+" height:"+t.height+" maxSize:"+i);const s={width:t.width,height:t.height},a=(i,a)=>{i in t?s[i]=isNaN(t[i])?e[t[i]]:t[i]:a&&(s[i]=a)};if(a("format"),a("internalFormat",s.format),a("type",e.UNSIGNED_BYTE),a("minFilter",e.LINEAR),a("magFilter",e.LINEAR),a("wrapS",e.CLAMP_TO_EDGE),a("wrapT",e.CLAMP_TO_EDGE),a("flipY",!1),a("mipMapped",!1),a("depthInternalFormat"),a("depthFormat"),a("depthType"),s.format==e.FLOAT)if("webgl2"==e.name)s.filter!=e.LINEAR||e.__ext_float_linear||(console.warn("Floating point texture filtering not supported on result device"),s.filter=e.NEAREST);else if(e.__ext_float)s.filter!=e.LINEAR||e.__ext_float_linear||(console.warn("Floating point texture filtering not supported on result device"),s.filter=e.NEAREST);else{if(!e.__ext_half_float)throw new Error("OES_texture_half_float is not available");s.format=e.HALF_FLOAT,s.filter!=e.LINEAR||e.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on result device"),s.filter=e.NEAREST)}else if(s.format==e.HALF_FLOAT)if("webgl2"==e.name);else{if(!e.__ext_half_float)throw new Error("OES_texture_half_float is not available");if(s.filter!=e.LINEAR||e.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on result device"),s.filter=e.NEAREST),s.channels==e.RGB)throw new Error("OES_texture_half_float onlysupports RGBA textures")}else if("sRGB"==s.format&&!e.__ext_sRGB)throw new Error("EXT_sRGB is not available");return null!=s.format&&"webgl2"==e.name&&s.internalFormat==s.format&&(s.type==e.FLOAT?s.format==e.RED||s.format==e.RED?s.internalFormat=e.R32F:s.format==e.RG?s.internalFormat=e.RG32F:s.format==e.RGBA&&(s.internalFormat=e.RGBA32F):s.type==e.HALF_FLOAT?s.format==e.RED?s.internalFormat=e.R16F:s.format==e.RGB?s.internalFormat=e.RGB16F:s.format==e.RGBA&&(s.internalFormat=e.RGBA16F):s.type==e.UNSIGNED_BYTE&&(s.format==e.RED&&(s.internalFormat=e.R8),s.format==e.RGB?s.internalFormat=e.RGB8:s.format==e.RGBA&&(s.internalFormat=e.RGBA8))),null!=s.depthFormat&&("webgl2"==e.name?s.depthType==e.UNSIGNED_SHORT?s.depthInternalFormat=e.DEPTH_COMPONENT16:s.depthType==e.UNSIGNED_INT&&(s.depthInternalFormat=e.UNSIGNED_INT):s.depthInternalFormat=s.depthFormat),s}(t,e);this.textureTargets.forEach((e=>{t.deleteTexture(e)})),this.textureTargets=[],this.depthTexture&&(t.deleteTexture(this.depthTexture),this.depthTexture=null),this.frameBuffer&&t.deleteFramebuffer(this.frameBuffer),this.params=i,this.type=i.type,this.format=i.format,this.internalFormat=i.internalFormat,this.filter=i.filter,this.wrap=i.wrap,this.flipY=i.flipY,this.width=i.width,this.height=i.height,this.clearColor=new mi(0,0,0,0),this.colorMask=[!0,!0,!0,!0],this.textureType=1,this.textureDesc[0]=this.width,this.textureDesc[1]=this.height;const s=null!=e.numColorChannels?e.numColorChannels:null!=i.format?1:0;for(let e=0;e<s;e++){t.activeTexture(t.TEXTURE0+1);const e=t.createTexture();t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,i.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,i.wrapT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,i.minFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,i.magFilter),t.texImage2D(t.TEXTURE_2D,0,this.internalFormat,i.width,i.height,0,this.format,this.type,null),this.textureTargets.push(e)}if(i.depthFormat){if("webgl"==t.name&&!t.__ext_WEBGL_depth_texture)throw new Error("Depth textures not support on this device");t.activeTexture(t.TEXTURE0),this.depthTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.depthTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,i.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,i.wrapT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,i.minFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,i.magFilter),t.texImage2D(t.TEXTURE_2D,0,i.depthInternalFormat,i.width,i.height,0,i.depthFormat,i.depthType,null)}if(this.frameBuffer=t.createFramebuffer(),this.bindForWriting(),this.textureTargets.length>0){if(this.textureTargets.length>1&&"webgl"==t.name&&!t.drawBuffers){t.__ext_draw_buffers=t.getExtension("WEBGL_draw_buffers"),t.drawBuffers=t.__ext_draw_buffers.drawBuffersWEBGL.bind(t.__ext_draw_buffers);for(let e=1;e<14;e++)t["COLOR_ATTACHMENT"+e]=t.__ext_draw_buffers["COLOR_ATTACHMENT"+e+"_WEBGL"];t.MAX_COLOR_ATTACHMENTS=t.__ext_draw_buffers.MAX_COLOR_ATTACHMENTS_WEBGL,t.MAX_DRAW_BUFFERS=t.__ext_draw_buffers.MAX_DRAW_BUFFERS_WEBGL}const e=[];for(let i=0;i<this.textureTargets.length;i++)t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0+i,t.TEXTURE_2D,this.textureTargets[i],0),e.push(t.COLOR_ATTACHMENT0+i);this.textureTargets.length>1&&t.drawBuffers(e)}this.depthTexture&&t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,this.depthTexture,0),this.checkFramebuffer()}checkFramebuffer(){this.bindForWriting();const e=this.__gl,t=e.checkFramebufferStatus(e.DRAW_FRAMEBUFFER);if(t!=e.FRAMEBUFFER_COMPLETE)switch(t){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete.");case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment.");case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error("Height and width of the attachment are not the same.");case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer.");case 36061:throw new Error("The framebuffer is unsupported");default:throw new Error("Incomplete Frambuffer")}this.unbindForWriting()}bindForWriting(e,t=!1){e&&(this.__prevBoundFbo=e.boundRendertarget,e.boundRendertarget=this.frameBuffer);const i=this.__gl;"webgl2"==i.name?i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this.frameBuffer):i.bindFramebuffer(i.FRAMEBUFFER,this.frameBuffer),i.viewport(0,0,this.width,this.height),t&&this.clear()}unbindForWriting(e){e&&(e.boundRendertarget=this.__prevBoundFbo);const t=this.__gl;"webgl2"==t.name?t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.__prevBoundFbo):t.bindFramebuffer(t.FRAMEBUFFER,this.__prevBoundFbo)}clear(e=!0){const t=this.__gl;t.colorMask(...this.colorMask),t.clearColor(...this.clearColor.asArray());let i=0;this.textureTargets.length>0&&(i|=t.COLOR_BUFFER_BIT),this.depthTexture&&(i|=t.DEPTH_BUFFER_BIT),t.clear(i)}bindForReading(){const e=this.__gl;"webgl2"==e.name?e.bindFramebuffer(e.READ_FRAMEBUFFER,this.frameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer)}unbindForReading(){const e=this.__gl;"webgl2"==e.name?e.bindFramebuffer(e.READ_FRAMEBUFFER,null):e.bindFramebuffer(e.FRAMEBUFFER,null)}bindColorTexture(e,t,i=0){const s=this.__gl,a=e.boundTextures++;return s.uniform1i(t.location,a),s.activeTexture(s.TEXTURE0+a),s.bindTexture(s.TEXTURE_2D,this.textureTargets[i]),!0}bindDepthTexture(e,t){const i=this.__gl,s=e.boundTextures++;return i.uniform1i(t.location,s),i.activeTexture(i.TEXTURE0+s),i.bindTexture(i.TEXTURE_2D,this.depthTexture),!0}unbind(){this.unbindForWriting()}resize(e,t,i=!1){const s=this.__gl;if(this.width!=e||this.height!=t){const a=s.getParameter(s.MAX_TEXTURE_SIZE);if(e<0||e>a||t<0||t>a)throw new Error(`GLRenderTarget: Invalid texture size. width: ${e} height: ${t} maxSize: ${a}`);i&&this.bindForReading();const r=this.params;for(let a=0;a<this.textureTargets.length;a++){const n=s.createTexture();s.bindTexture(s.TEXTURE_2D,n),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,r.wrapS),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,r.wrapT),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,r.minFilter),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,r.magFilter),s.texImage2D(s.TEXTURE_2D,0,this.internalFormat,e,t,0,this.format,this.type,null),i&&s.copyTexImage2D(s.TEXTURE_2D,0,this.internalFormat,0,0,Math.min(e,this.width),Math.min(t,this.height),0),s.deleteTexture(this.textureTargets[a]),this.textureTargets[a]=n}if(r.depthFormat){if("webgl"==s.name&&!s.__ext_WEBGL_depth_texture)throw new Error("Depth textures not support on this device");s.activeTexture(s.TEXTURE0);const a=s.createTexture();s.bindTexture(s.TEXTURE_2D,a),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,r.wrapS),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,r.wrapT),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,r.minFilter),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,r.magFilter),s.texImage2D(s.TEXTURE_2D,0,r.depthInternalFormat,e,t,0,r.depthFormat,r.depthType,null),i&&s.copyTexImage2D(s.TEXTURE_2D,0,this.internalFormat,0,0,Math.min(e,this.width),Math.min(t,this.height),0),s.deleteTexture(this.depthTexture),this.depthTexture=a}if(i&&this.unbindForReading(),this.width=e,this.height=t,this.frameBuffer&&s.deleteFramebuffer(this.frameBuffer),this.frameBuffer=s.createFramebuffer(),this.bindForWriting(),this.textureTargets.length>0){if(this.textureTargets.length>1&&"webgl"==s.name&&!s.drawBuffers){s.__ext_draw_buffers=s.getExtension("WEBGL_draw_buffers"),s.drawBuffers=s.__ext_draw_buffers.drawBuffersWEBGL.bind(s.__ext_draw_buffers);for(let e=1;e<14;e++)s["COLOR_ATTACHMENT"+e]=s.__ext_draw_buffers["COLOR_ATTACHMENT"+e+"_WEBGL"];s.MAX_COLOR_ATTACHMENTS=s.__ext_draw_buffers.MAX_COLOR_ATTACHMENTS_WEBGL,s.MAX_DRAW_BUFFERS=s.__ext_draw_buffers.MAX_DRAW_BUFFERS_WEBGL}const e=[];for(let t=0;t<this.textureTargets.length;t++)s.framebufferTexture2D(s.DRAW_FRAMEBUFFER,s.COLOR_ATTACHMENT0+t,s.TEXTURE_2D,this.textureTargets[t],0),e.push(s.COLOR_ATTACHMENT0+t);this.textureTargets.length>1&&s.drawBuffers(e)}this.depthTexture&&s.framebufferTexture2D(s.DRAW_FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.TEXTURE_2D,this.depthTexture,0),this.checkFramebuffer()}}bindToUniform(e,t,i){const s=e.boundTextures++,a=this.__gl.TEXTURE0+s,r=this.__gl;return r.activeTexture(a),r.bindTexture(r.TEXTURE_2D,this.textureTargets[0]),r.uniform1i(t.location,s),i&&(i.textureTypeUnif&&r.uniform1i(i.textureTypeUnif.location,this.textureType),i.textureDescUnif&&this.__gl.uniform4fv(i.textureDescUnif.location,this.textureDesc)),!0}destroy(){const e=this.__gl;this.textureTargets.forEach((t=>{e.deleteTexture(t)})),this.textureTargets=[],this.depthTexture&&(e.deleteTexture(this.depthTexture),this.depthTexture=null),this.frameBuffer&&e.deleteFramebuffer(this.frameBuffer)}}yr.setShaderModule("utils/quadVertexFromID.glsl","\n\nattribute float vertexIDs;\n\nvec2 getQuadVertexPositionFromID(){\n    int vertexID = int(vertexIDs);\n    if(vertexID == 0)\n        return vec2(-0.5, -0.5);\n    else if(vertexID == 1)\n        return vec2(0.5, -0.5);\n    else if(vertexID == 2)\n        return vec2(-0.5, 0.5);\n    else if(vertexID == 3)\n        return vec2(0.5, 0.5);\n    return vec2(0,0);\n}\n"),yr.setShaderModule("utils/unpackHDR.glsl","\n\nvec3 decodeHDR(const in vec3 ldrPixel, const in float cdmAlpha) {\n    float avg = (cdmAlpha * 16.0 - 8.0);\n    float scl = 1.0;\n    vec3 color;\n    color.x = (tan((ldrPixel.x-0.5)*1.5)/scl)+avg;\n    color.y = (tan((ldrPixel.y-0.5)*1.5)/scl)+avg;\n    color.z = (tan((ldrPixel.z-0.5)*1.5)/scl)+avg;\n\n    // convert from logarithmic curve to linear curve.\n    // subtract the epsilon that was added during encoding.\n    const float eps = 0.001;\n    color.x = pow(10.0, color.x) - eps;\n    color.y = pow(10.0, color.y) - eps;\n    color.z = pow(10.0, color.z) - eps;\n    return color;\n}\n\nvec3 decodeHDR(sampler2D ldrSampler, sampler2D cdmSampler, vec2 texCoord) {\n#ifdef ENABLE_ES3\n    float cdm = texture2D(cdmSampler, texCoord).r;\n#else\n    float cdm = texture2D(cdmSampler, texCoord).a;\n#endif\n    return decodeHDR(texture2D(ldrSampler, texCoord).rgb, cdm);\n}\n\n");class Vr extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n    vec2 position = getQuadVertexPositionFromID();\n    v_texCoord = position+0.5;\n    gl_Position = vec4(position*2.0, 0.0, 1.0);\n}\n'),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n\nvarying vec2 v_texCoord;\nuniform sampler2D ldrSampler;\nuniform sampler2D cdmSampler;\nuniform vec4 srcRegion; // pos, and size of the source region\n\n<%include file="utils/unpackHDR.glsl"/>\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n    vec2 srcUv = srcRegion.xy + (v_texCoord * srcRegion.zw);\n\n    fragColor = vec4(decodeHDR(ldrSampler, cdmSampler, srcUv), 1.0);\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n\n')}}const vr=(e,t)=>{let i,s,a;switch(t){case 0:i=1,s=4,a=e.UNSIGNED_BYTE;break;case 1:i=1,s=4,a=e.BYTE;break;case 2:i=1,s=4,a=e.UNSIGNED_SHORT;break;case 3:i=1,s=4,a=e.SHORT;break;case 4:i=1,s=4,a=e.UNSIGNED_INT;break;case 5:i=1,s=4,a=e.INT;break;case 6:i=1,s=4,a=e.FLOAT;break;case hi:i=2,s=4,a=e.FLOAT;break;case di:i=3,s=4,a=e.FLOAT;break;case ci:case mi:i=4,s=4,a=e.FLOAT;break;case ui:i=4,s=1,a=e.UNSIGNED_BYTE;break;default:throw"Unhandled Type"}return{dimension:i,elementSize:s,dataType:a}};class Rr{constructor(e,t,i,s){this.__gl=e,this.__shaderAttrs=t,this.__glattrbuffers=i,this.__indexBuffer=s}bind(e){const t=this.__gl;for(const e in this.__shaderAttrs){if("instancedIds"==e)continue;const i=this.__shaderAttrs[e],s=i.location;if(-1==s)continue;const a=this.__glattrbuffers[e];if(!a){t.disableVertexAttribArray(s);continue}const r=vr(t,a.dataType),n=r.dimension*r.elementSize,o=null!=a.offset?a.offset*r.dimension*r.elementSize:0,l=1==a.normalized,h=i.instanced;t.enableVertexAttribArray(s),t.bindBuffer(t.ARRAY_BUFFER,a.buffer),t.vertexAttribPointer(s,r.dimension,r.dataType,l,n,o),t.vertexAttribDivisor&&(1==h?t.vertexAttribDivisor(s,1):t.vertexAttribDivisor(s,0))}return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),!0}unbind(){const e=this.__gl;for(const t in this.__shaderAttrs){const i=this.__shaderAttrs[t],s=i.location;-1==s&&e.enableVertexAttribArray(s),i.instanced&&e.vertexAttribDivisor(s,0)}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)}destroy(){}}class wr{constructor(e,t,i,s){this.__gl=e,this.__vao=e.createVertexArray(),e.bindVertexArray(this.__vao);for(const s in t){if("instancedIds"==s)continue;const a=t[s],r=a.location;if(-1==r)continue;const n=i[s];if(!n){e.disableVertexAttribArray(r);continue}const o=vr(e,n.dataType),l=o.dimension*o.elementSize,h=null!=n.offset?n.offset*o.dimension*o.elementSize:0,d=1==n.normalized,c=a.instanced;e.enableVertexAttribArray(r),e.bindBuffer(e.ARRAY_BUFFER,n.buffer),e.vertexAttribPointer(r,o.dimension,o.dataType,d,l,h),e.vertexAttribDivisor&&(1==c?e.vertexAttribDivisor(r,1):e.vertexAttribDivisor(r,0))}this.__indexBuffer=s,this.__indexBuffer&&this.__gl.bindBuffer(this.__gl.ELEMENT_ARRAY_BUFFER,this.__indexBuffer)}bind(e){return this.__gl.bindVertexArray(this.__vao),this.__indexBuffer&&this.__gl.bindBuffer(this.__gl.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),!0}unbind(){const e=this.__gl;e.bindVertexArray(null),this.__indexBuffer&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)}destroy(){this.__gl.deleteVertexArray(this.__vao),this.__indexBuffer&&this.__gl.deleteBuffer(this.__indexBuffe)}}function Mr(e,t,i,s){return null==e.createVertexArray?new Rr(e,t,i,s):new wr(e,t,i,s)}class Tr extends pr{constructor(e,t){super(e),this.__hdrImage=t,this.__hdrImage.setMetadata("gltexture",this);const i=()=>{this.__unpackHDRImage(this.__hdrImage.getParams())};this.__hdrImage.on("updated",i),this.__hdrImage.isLoaded()?i():this.__hdrImage.on("loaded",i)}getTexture(){return this.__hdrImage}__unpackHDRImage(e){const t=this.__gl,i=e.data.ldr,s=e.data.cdm;if(this.__fbo)this.__srcLDRTex.bufferData(i),this.__srcCDMTex.bufferData(s);else{this.configure({format:"RGBA",type:"FLOAT",width:i.width,height:i.height,filter:"LINEAR",wrap:"CLAMP_TO_EDGE"}),this.__fbo=new xr(t,this),this.__fbo.setClearColor([0,0,0,0]),this.__srcLDRTex=new pr(t,{format:"RGB",type:"UNSIGNED_BYTE",width:i.width,height:i.height,filter:"NEAREST",mipMapped:!1,wrap:"CLAMP_TO_EDGE",data:i}),this.__srcCDMTex=new pr(t,{format:"webgl2"==t.name?"RED":"ALPHA",type:"UNSIGNED_BYTE",width:i.width,height:i.height,filter:"NEAREST",mipMapped:!1,wrap:"CLAMP_TO_EDGE",data:s}),this.__unpackHDRShader=new Vr(t);const e=this.__unpackHDRShader.compileForTarget("GLHDRImage");this.__shaderBinding=Mr(t,e.attrs,t.__quadattrbuffers,t.__quadIndexBuffer)}this.__fbo.bindAndClear();const a={};this.__unpackHDRShader.bind(a,"GLHDRImage"),this.__shaderBinding.bind(a);const r=a.unifs;this.__srcLDRTex.bindToUniform(a,r.ldrSampler),this.__srcCDMTex.bindToUniform(a,r.cdmSampler),t.uniform4fv(r.srcRegion.location,[0,0,1,1]),t.drawQuad(),this.__fbo.unbind(),this.emit("updated",{})}bindToUniform(e,t,i){return super.bindToUniform(e,t,i)}destroy(){super.destroy(),this.__fbo&&(this.__fbo.destroy(),this.__srcLDRTex.destroy(),this.__srcCDMTex.destroy()),this.__unpackHDRShader&&this.__unpackHDRShader.destroy(),this.__shaderBinding&&this.__shaderBinding.destroy(),this.__hdrImage.loaded.disconnectScope(this),this.__hdrImage.updated.disconnectScope(this)}}class Lr extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n  vec2 position = getQuadVertexPositionFromID();\n  v_texCoord = position+0.5;\n  gl_Position = vec4(position*2.0, 0.0, 1.0);\n}\n'),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n\nvarying vec2 v_texCoord;\n\n<%include file="math/constants.glsl"/>\n<%include file="Hammersley.glsl"/>\n<%include file="ImportanceSampleGGX.glsl"/>\n\nfloat GeometrySchlickGGX(float NdotV, float roughness)\n{\n    float a = roughness;\n    float k = (a * a) / 2.0;\n\n    float nom   = NdotV;\n    float denom = NdotV * (1.0 - k) + k;\n\n    return nom / denom;\n}\n// ----------------------------------------------------------------------------\nfloat GeometrySmith(vec3 N, vec3 V, vec3 L, float roughness)\n{\n    float NdotV = max(dot(N, V), 0.0);\n    float NdotL = max(dot(N, L), 0.0);\n    float ggx2 = GeometrySchlickGGX(NdotV, roughness);\n    float ggx1 = GeometrySchlickGGX(NdotL, roughness);\n\n    return ggx1 * ggx2;\n}\n\nvec2 IntegrateBRDF(float NdotV, float roughness)\n{\n    vec3 V;\n    V.x = sqrt(1.0 - NdotV*NdotV);\n    V.y = 0.0;\n    V.z = NdotV;\n\n    float A = 0.0;\n    float B = 0.0;\n\n    vec3 N = vec3(0.0, 0.0, 1.0);\n\n    for(uint i = 0u; i < SAMPLE_COUNT; ++i)\n    {\n        vec2 Xi = Hammersley(i, SAMPLE_COUNT);\n        vec3 H  = ImportanceSampleGGX(Xi, N, roughness);\n        vec3 L  = normalize(2.0 * dot(V, H) * H - V);\n\n        float NdotL = max(L.z, 0.0);\n        float NdotH = max(H.z, 0.0);\n        float VdotH = max(dot(V, H), 0.0);\n\n        if(NdotL > 0.0)\n        {\n            float G = GeometrySmith(N, V, L, roughness);\n            float G_Vis = (G * VdotH) / (NdotH * NdotV);\n            float Fc = pow(1.0 - VdotH, 5.0);\n\n            A += (1.0 - Fc) * G_Vis;\n            B += Fc * G_Vis;\n        }\n    }\n    A /= float(SAMPLE_COUNT);\n    B /= float(SAMPLE_COUNT);\n    return vec2(A, B);\n}\n\nout vec2 fragColor;\nvoid main(void) {\n  vec2 integratedBRDF = IntegrateBRDF(v_texCoord.x, v_texCoord.y);\n  fragColor = integratedBRDF;\n}\n\n')}}yr.setShaderModule("envmap-octahedral.glsl","\n\n#define sectorize(value) step(0.0, (value))*2.0-1.0\n#define sum(value) dot(clamp((value), 1.0, 1.0), (value))\n\n\nvec2 dirToSphOctUv(vec3 normal){\n    normal = normalize(normal);\n    vec3 aNorm = abs(normal);\n    vec3 sNorm = sectorize(normal);\n    \n    vec2 dir = aNorm.xy;\n    float orient = atan(dir.x, max(dir.y,0.0000000000000001))/HalfPI;\n\n    dir = vec2(aNorm.z, length(aNorm.xy));\n    float pitch = atan(dir.y, dir.x)/HalfPI;\n\n    vec2 uv = vec2(sNorm.x*orient, sNorm.y*(1.0-orient))*pitch;\n\n    if(normal.z < 0.0){\n        uv = sNorm.xy - abs(uv.ts)*sNorm.xy;\n    }\n    vec2 res = uv*0.5+0.5;\n    // Flip-v\n    // return res;\n    return vec2(res.x, 1.0 - res.y);\n}\n\n\nvec3 sphOctUvToDir(vec2 uv){\n    uv = uv*2.0-1.0;\n    // Flip-v\n    uv.y = -uv.y;\n    vec2 suv = sectorize(uv);\n    float sabsuv =  sum(abs(uv));\n    float pitch = sabsuv*HalfPI;\n\n    if (pitch <= 0.0) {\n        return vec3(0.0, 0.0, 1.0);\n    }\n    if (abs(pitch - PI) < 0.000001) {\n        return vec3(0.0, 0.0, -1.0);\n    }\n    if(sabsuv > 1.0){\n        uv = (1.0-abs(uv.ts))*suv;\n    }\n\n    float orient = (abs(uv.s)/sabsuv)*HalfPI;\n    float sOrient = sin(orient);\n    float cOrient = cos(orient);\n    float sPitch = sin(pitch);\n    float cPitch = cos(pitch);\n\n    return vec3(\n        sOrient*suv.s*sPitch,\n        cOrient*suv.t*sPitch,\n        cPitch\n    );\n}\n\n"),yr.setShaderModule("Hammersley.glsl","\nfloat RadicalInverse_VdC(uint bits) \n{\n  bits = (bits << 16u) | (bits >> 16u);\n  bits = ((bits & 0x55555555u) << 1u) | ((bits & 0xAAAAAAAAu) >> 1u);\n  bits = ((bits & 0x33333333u) << 2u) | ((bits & 0xCCCCCCCCu) >> 2u);\n  bits = ((bits & 0x0F0F0F0Fu) << 4u) | ((bits & 0xF0F0F0F0u) >> 4u);\n  bits = ((bits & 0x00FF00FFu) << 8u) | ((bits & 0xFF00FF00u) >> 8u);\n  return float(bits) * 2.3283064365386963e-10; // / 0x100000000\n}\n// ----------------------------------------------------------------------------\nvec2 Hammersley(uint i, uint N)\n{\n  return vec2(float(i)/float(N), RadicalInverse_VdC(i));\n} \n"),yr.setShaderModule("ImportanceSampleGGX.glsl","\nvec3 ImportanceSampleGGX(vec2 Xi, vec3 N, float roughness)\n{\n  float a = roughness*roughness;\n\n  float phi = 2.0 * PI * Xi.x;\n  float cosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a*a - 1.0) * Xi.y));\n  float sinTheta = sqrt(1.0 - cosTheta*cosTheta);\n\n  // from spherical coordinates to cartesian coordinates\n  vec3 H = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n\n  // from tangent-space vector to world-space sample vector\n  vec3 up        = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0);\n  vec3 tangent   = normalize(cross(up, N));\n  vec3 bitangent = cross(N, tangent);\n\n  vec3 sampleVec = tangent * H.x + bitangent * H.y + N * H.z;\n  return normalize(sampleVec);\n} \n      "),yr.setShaderModule("convolve-helpers.glsl",'\n\n  <%include file="Hammersley.glsl"/>\n  \n  \n  #ifdef ENVMAP_CUBE\n  \n  uniform samplerCube envMap;\n  \n  vec4 sampleEnvMap(vec3 dir) {\n    return texture(envMap, dir);\n  }\n  \n  #else \n  \n  uniform sampler2D   envMap;\n  \n  <%include file="envmap-octahedral.glsl"/>\n  \n  vec4 sampleEnvMap(vec3 dir) {\n    vec2 uv = dirToSphOctUv(dir);\n    vec4 texel = texture2D(envMap, vec2(uv.x, 1.0 - uv.y));\n    return vec4(texel.rgb/texel.a, 1.0); // TODO: Check this line. Do we need it?\n  }\n  \n  #endif \n  \n  \n  vec3 cubeFaceUvToDir(float u, float v, int faceId) {\n  \n    // normalize into [-1, 1] range\n    float n_u = 2.0 * u - 1.0;\n    float n_v = 2.0 * v - 1.0;\n  \n    vec3 dir;\n    switch (faceId)\n    {\n    case 0: //TEXTURE_CUBE_MAP_POSITIVE_X:\n      dir.x = 1.0f;\n      dir.y = n_v;\n      dir.z = -n_u;\n      break;\n    case 1: //TEXTURE_CUBE_MAP_NEGATIVE_X:\n      dir.x = -1.0f;\n      dir.y = n_v;\n      dir.z = n_u;\n      break;\n    case 3: //TEXTURE_CUBE_MAP_POSITIVE_Y:\n      dir.x = n_u;\n      dir.y = 1.0f;\n      dir.z = -n_v;\n      break;\n    case 2: //TEXTURE_CUBE_MAP_NEGATIVE_Y:\n      dir.x = n_u;\n      dir.y = -1.0f;\n      dir.z = n_v;\n      break;\n    case 4: //TEXTURE_CUBE_MAP_POSITIVE_Z:\n      dir.x = n_u;\n      dir.y = n_v;\n      dir.z = 1.0f;\n      break;\n    case 5: //TEXTURE_CUBE_MAP_NEGATIVE_Z:\n      dir.x = -n_u;\n      dir.y = n_v;\n      dir.z = -1.0f;\n      break;\n    }\n    return normalize(dir);\n  }\n  \n\n');class Sr extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n  vec2 position = getQuadVertexPositionFromID();\n  v_texCoord = position+0.5;\n  gl_Position = vec4(position*2.0, 0.0, 1.0);\n}\n'),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="convolve-helpers.glsl"/>\n\nuniform float roughness;\nuniform int faceId;\nvarying vec2 v_texCoord;\n\n\nout vec4 fragColor;\nvoid main(void) {\n\n  vec3 N = cubeFaceUvToDir(v_texCoord.x, v_texCoord.y, faceId);   \n\n  vec3 irradiance = vec3(0.0);\n\n  vec3 up        = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0);\n  vec3 tangent   = normalize(cross(up, N));\n  vec3 bitangent = cross(N, tangent);\n\n  float nrSamples = 0.0; \n  for(float phi = 0.0; phi < 2.0 * PI; phi += SAMPLE_DELTA)\n  {\n    for(float theta = 0.0; theta < 0.5 * PI; theta += SAMPLE_DELTA)\n    {\n      // spherical to cartesian (in tangent space)\n      // from spherical coordinates to cartesian coordinates\n      vec3 H = vec3(cos(phi) * sin(theta), sin(phi) * sin(theta), cos(theta));\n      // tangent space to world\n      vec3 sampleVec = tangent * H.x + bitangent * H.y + N * H.z;\n\n      irradiance += sampleEnvMap(normalize(sampleVec)).rgb * cos(theta) * sin(theta);\n      nrSamples++;\n    }\n  }\n  irradiance = PI * irradiance * (1.0 / float(nrSamples));\n\n  fragColor = vec4(irradiance, 1.0);\n}\n\n')}}class Zr extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n  vec2 position = getQuadVertexPositionFromID();\n  v_texCoord = position+0.5;\n  gl_Position = vec4(position*2.0, 0.0, 1.0);\n}\n'),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="ImportanceSampleGGX.glsl"/>\n<%include file="convolve-helpers.glsl"/>\n\nuniform float roughness;\nuniform int faceId;\nvarying vec2 v_texCoord;\n\nout vec4 fragColor;\nvoid main(void) {\n\n  vec3 N = cubeFaceUvToDir(v_texCoord.x, v_texCoord.y, faceId);   \n\n  vec3 R = N;\n  vec3 V = R;\n\n  float totalWeight = 0.0;   \n  vec3 prefilteredColor = vec3(0.0);     \n  for(uint i = 0u; i < SAMPLE_COUNT; ++i)\n  {\n    vec2 Xi = Hammersley(i, SAMPLE_COUNT);\n    vec3 H  = ImportanceSampleGGX(Xi, N, roughness);\n    vec3 L  = normalize(2.0 * dot(V, H) * H - V);\n\n    float NdotL = max(dot(N, L), 0.0);\n    if(NdotL > 0.0)\n    {\n      prefilteredColor += sampleEnvMap(L).rgb * NdotL;\n      totalWeight      += NdotL;\n    }\n  }\n  prefilteredColor = prefilteredColor / totalWeight;\n\n  fragColor = vec4(prefilteredColor, 1.0);\n}\n\n')}}class Cr extends Jt{constructor(e,t){super(),this.__gl=e,this.maxFragmentShaderTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),e.__quadVertexIdsBuffer||e.setupInstancedQuad(),this.textureType=1,this.textureDesc=[0,0,0,0],this.__convolved=!1,this.__fbos=[]}convolveProbe(e){const t=this.__gl,i={shaderopts:{directives:["#define ENABLE_ES3","#define ENABLE_FLOAT_TEXTURES"]}};"Low"==si.deviceCategory?(i.shaderopts.directives.push("#define SAMPLE_DELTA 0.1"),i.shaderopts.directives.push("#define SAMPLE_COUNT 64u")):"Medium"==si.deviceCategory?(i.shaderopts.directives.push("#define SAMPLE_DELTA 0.08"),i.shaderopts.directives.push("#define SAMPLE_COUNT 256u")):(i.shaderopts.directives.push("#define SAMPLE_DELTA 0.025"),i.shaderopts.directives.push("#define SAMPLE_COUNT 1024u")),this.brdfLUTTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.brdfLUTTexture),t.texImage2D(t.TEXTURE_2D,0,t.RG16F,512,512,0,t.RG,t.FLOAT,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR);const s=new Lr(t),a=Mr(t,s.compileForTarget("GLProbe",i.shaderopts).attrs,t.__quadattrbuffers,t.__quadIndexBuffer),r=t.createFramebuffer();t.bindFramebuffer(t.DRAW_FRAMEBUFFER,r),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.brdfLUTTexture,0),s.bind(i),a.bind(i),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.viewport(0,0,512,512),t.drawQuad(),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.deleteFramebuffer(r),s.unbind(i),s.destroy();{const s=new Sr(t),a=Mr(t,s.compileForTarget("GLProbe",i.shaderopts).attrs,t.__quadattrbuffers,t.__quadIndexBuffer);s.bind(i,"GLProbe"),a.bind(i);const r=i.unifs;e.bindToUniform(i,r.envMap);const n=64;this.irradianceCubeTex=t.createTexture(),t.bindTexture(t.TEXTURE_CUBE_MAP,this.irradianceCubeTex),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_R,t.CLAMP_TO_EDGE);for(let e=0;e<6;e++)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,t.RGBA32F,n,n,0,t.RGBA,t.FLOAT,null);const o=t.createFramebuffer();t.bindFramebuffer(t.DRAW_FRAMEBUFFER,o);for(let e=0;e<6;++e)t.uniform1i(r.faceId.location,e),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+e,this.irradianceCubeTex,0),t.viewport(0,0,n,n),t.clearColor(1,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.drawQuad();t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.deleteFramebuffer(o),t.generateMipmap(t.TEXTURE_CUBE_MAP)}{const s=new Zr(t),a=Mr(t,s.compileForTarget("GLProbe",i.shaderopts).attrs,t.__quadattrbuffers,t.__quadIndexBuffer);s.bind(i,"GLProbe"),a.bind(i);const r=i.unifs;e.bindToUniform(i,r.envMap),this.specularCubetex=t.createTexture(),t.bindTexture(t.TEXTURE_CUBE_MAP,this.specularCubetex),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_R,t.CLAMP_TO_EDGE);const n=256;for(let e=0;e<6;e++)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,t.RGBA32F,n,n,0,t.RGBA,t.FLOAT,null);t.generateMipmap(t.TEXTURE_CUBE_MAP);const o=5;for(let e=0;e<o;++e){const i=n*Math.pow(.5,e),s=n*Math.pow(.5,e),a=t.createFramebuffer();t.bindFramebuffer(t.DRAW_FRAMEBUFFER,a),t.viewport(0,0,i,s);const l=e/(o-1);t.uniform1f(r.roughness.location,l);for(let i=0;i<6;++i)t.uniform1i(r.faceId.location,i),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+i,this.specularCubetex,e),t.drawQuad();t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.deleteFramebuffer(a)}s.destroy()}this.__convolved=!0}bind(e){const t=this.__gl,{irradianceMap:i,prefilterMap:s,brdfLUT:a}=e.unifs;if(!this.__convolved)return i&&t.uniform1i(i.location,this.maxFragmentShaderTextureUnits-1),s&&t.uniform1i(s.location,this.maxFragmentShaderTextureUnits-1),!1;if(a){const i=e.boundTextures++;t.activeTexture(this.__gl.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,this.brdfLUTTexture),t.uniform1i(a.location,i)}if(i){const s=e.boundTextures++,a=this.__gl.TEXTURE0+s;t.activeTexture(a),t.bindTexture(t.TEXTURE_CUBE_MAP,this.irradianceCubeTex),t.uniform1i(i.location,s)}if(s){const i=e.boundTextures++,a=this.__gl.TEXTURE0+i;t.activeTexture(a),t.bindTexture(t.TEXTURE_CUBE_MAP,this.specularCubetex),t.uniform1i(s.location,i)}return!0}destroy(){}}yr.setShaderModule("stack-gl/inverse.glsl","\n\n\n#ifndef ENABLE_ES3\n\nfloat inverse(float m) {\n  return 1.0 / m;\n}\n\nmat2 inverse(mat2 m) {\n  return mat2(m[1][1],-m[0][1],\n             -m[1][0], m[0][0]) / (m[0][0]*m[1][1] - m[0][1]*m[1][0]);\n}\n\nmat3 inverse(mat3 m) {\n  float a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];\n  float a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];\n  float a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];\n\n  float b01 = a22 * a11 - a12 * a21;\n  float b11 = -a22 * a10 + a12 * a20;\n  float b21 = a21 * a10 - a11 * a20;\n\n  float det = a00 * b01 + a01 * b11 + a02 * b21;\n\n  return mat3(b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),\n              b11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),\n              b21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)) / det;\n}\n\nmat4 inverse(mat4 m) {\n  float\n      a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n      a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n      a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n      a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n\n      b00 = a00 * a11 - a01 * a10,\n      b01 = a00 * a12 - a02 * a10,\n      b02 = a00 * a13 - a03 * a10,\n      b03 = a01 * a12 - a02 * a11,\n      b04 = a01 * a13 - a03 * a11,\n      b05 = a02 * a13 - a03 * a12,\n      b06 = a20 * a31 - a21 * a30,\n      b07 = a20 * a32 - a22 * a30,\n      b08 = a20 * a33 - a23 * a30,\n      b09 = a21 * a32 - a22 * a31,\n      b10 = a21 * a33 - a23 * a31,\n      b11 = a22 * a33 - a23 * a32,\n\n      det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n\n  return mat4(\n      a11 * b11 - a12 * b10 + a13 * b09,\n      a02 * b10 - a01 * b11 - a03 * b09,\n      a31 * b05 - a32 * b04 + a33 * b03,\n      a22 * b04 - a21 * b05 - a23 * b03,\n      a12 * b08 - a10 * b11 - a13 * b07,\n      a00 * b11 - a02 * b08 + a03 * b07,\n      a32 * b02 - a30 * b05 - a33 * b01,\n      a20 * b05 - a22 * b02 + a23 * b01,\n      a10 * b10 - a11 * b08 + a13 * b06,\n      a01 * b08 - a00 * b10 - a03 * b06,\n      a30 * b04 - a31 * b02 + a33 * b00,\n      a21 * b02 - a20 * b04 - a23 * b00,\n      a11 * b07 - a10 * b09 - a12 * b06,\n      a00 * b09 - a01 * b07 + a02 * b06,\n      a31 * b01 - a30 * b03 - a32 * b00,\n      a20 * b03 - a21 * b01 + a22 * b00) / det;\n}\n\n#endif\n\n"),yr.setShaderModule("stack-gl/transpose.glsl","\n\n\n#ifndef ENABLE_ES3\n\nfloat transpose(float m) {\n  return m;\n}\n\nmat2 transpose(mat2 m) {\n  return mat2(m[0][0], m[1][0],\n              m[0][1], m[1][1]);\n}\n\nmat3 transpose(mat3 m) {\n  return mat3(m[0][0], m[1][0], m[2][0],\n              m[0][1], m[1][1], m[2][1],\n              m[0][2], m[1][2], m[2][2]);\n}\n\nmat4 transpose(mat4 m) {\n  return mat4(m[0][0], m[1][0], m[2][0], m[3][0],\n              m[0][1], m[1][1], m[2][1], m[3][1],\n              m[0][2], m[1][2], m[2][2], m[3][2],\n              m[0][3], m[1][3], m[2][3], m[3][3]);\n}\n\n#endif\n\n"),yr.setShaderModule("pragmatic-pbr/envmap-equirect.glsl","\n\n\nvec2 latLongUVsFromDir(vec3 dir) {\n  // Math function taken from...\n  // http://gl.ict.usc.edu/Data/HighResProbes/\n  // Note: Scaling from u=[0,2], v=[0,1] to u=[0,1], v=[0,1]\n  float phi = acos(dir.z);\n  float theta = atan(dir.x, dir.y);\n  return vec2((1.0 + theta / PI) / 2.0, phi / PI);\n}\n\n// Note: when u == 0.5 z = 1.0\nvec3 dirFromLatLongUVs(float u, float v) {\n    // http://gl.ict.usc.edu/Data/HighResProbes/\n    float theta = PI*((u * 2.0) - 1.0);\n    float phi = PI*v;\n    return vec3(sin(phi)*sin(theta), sin(phi)*cos(theta), cos(phi));\n}\n\nvec3 dirFromPolar(vec2 polar) {\n    float u = polar.x / (PI * 2.0);\n    float v = polar.y / PI;\n    return dirFromLatLongUVs(u, v);\n}\n\n"),yr.setShaderModule("pragmatic-pbr/envmap-dualfisheye.glsl","\n\n\n\nvec2 dualfisheyeUVsFromDir(vec3 dir) {\n  vec2 result;\n  float angle = 0.465;\n    if(dir.x < 0.0) {\n        result = vec2(((dir.z * -angle) + 0.5) * 0.5, (dir.y * angle) + 0.5);\n    }\n    else {\n        result = vec2( 0.5 + ((dir.z * angle) + 0.5) * 0.5, (dir.y * angle) + 0.5);\n    }\n    return result;\n}\n\n\n");class Fr extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform mat4 projectionMatrix;\nuniform mat4 viewMatrix;\n\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="stack-gl/transpose.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n  vec2 position = getQuadVertexPositionFromID() * 2.0;\n  v_texCoord = position * 0.5 + 0.5;\n\n  mat4 inverseProjection = inverse(projectionMatrix);\n  mat3 inverseModelview = transpose(mat3(viewMatrix));\n\n  // transform from the normalized device coordinates back to the view space\n  vec3 unprojected = (inverseProjection * vec4(position, 0, 1)).xyz;\n\n  // transfrom from the view space back to the world space\n  // and use it as a sampling vector\n  v_worldDir = inverseModelview * unprojected;\n\n  gl_Position = vec4(position, 0, 1);\n}\n\n'),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n\nuniform float focus;\nuniform float exposure;\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n\n\n#define ENABLE_INLINE_GAMMACORRECTION\n\n#define ENV_MAP_LATLONG 0\n#define ENV_MAP_OCT 1\n#define ENV_MAP_CUBE 2\n#define ENV_MAP_irradianceMap 8\n#define ENV_MAP_prefilterMap 3\n#define ENV_MAP_STEREO_LATLONG 4\n#define ENV_MAP_DUALFISHEYE 5\n#define ENV_MAP_SH 6\n#define ENV_MAP_BRDF_LUT 7\n\n#define ENV_MAPTYPE ENV_MAP_OCT\n\n#if (ENV_MAPTYPE == ENV_MAP_LATLONG)  \n\n<%include file="pragmatic-pbr/envmap-equirect.glsl"/>\n\nuniform sampler2D backgroundImage;\n\nvec4 sampleEnvMap(vec3 dir) {\n  vec2 uv = latLongUVsFromDir(normalize(dir));\n  vec4 texel = texture2D(backgroundImage, uv) * exposure;\n  return vec4(texel.rgb/texel.a, 1.0);\n}\n\n#elif (ENV_MAPTYPE == ENV_MAP_OCT)  \n\n<%include file="envmap-octahedral.glsl"/>\n\nuniform sampler2D   envMap;\n\nvec4 sampleEnvMap(vec3 dir) {\n  vec2 uv = dirToSphOctUv(normalize(dir));\n  if(false){\n    vec4 texel = texture2D(envMap, uv);\n    return vec4(texel.rgb/texel.a, 1.0);\n  }\n  else{\n    return texture2D(envMap, uv) * exposure;\n  }\n}\n\n#elif (ENV_MAPTYPE == ENV_MAP_CUBE)\n\nuniform samplerCube cubeMap;\n\nvec4 sampleEnvMap(vec3 dir) {\n  return texture(cubeMap, dir, 0.0);// * exposure;\n  // return textureLod(cubeMap, dir, exposure);\n}\n\n#elif (ENV_MAPTYPE == ENV_MAP_irradianceMap)\n\nuniform samplerCube irradianceMap;\n\nvec4 sampleEnvMap(vec3 dir) {\n  return textureLod(irradianceMap, dir, exposure);\n}\n\n#elif (ENV_MAPTYPE == ENV_MAP_prefilterMap)\n\nuniform samplerCube prefilterMap;\n\nvec4 sampleEnvMap(vec3 dir) {\n  return textureLod(prefilterMap, dir, exposure);\n}\n\n#elif (ENV_MAPTYPE == ENV_MAP_STEREO_LATLONG)  \n\n<%include file="pragmatic-pbr/envmap-equirect.glsl"/>\nuniform int eye;// L = 0, R = 1;\nuniform sampler2D backgroundImage;\n\nvec4 sampleEnvMap(vec3 dir) {\n  vec2 uv = latLongUVsFromDir(normalize(v_worldDir));\n  uv.y *= 0.5;\n  if(eye == 1){\n    uv.y += 0.5;\n  }\n  vec4 texel = texture2D(backgroundImage, uv) * exposure;\n  fragColor = vec4(texel.rgb/texel.a, 1.0);\n}\n\n#elif (ENV_MAPTYPE == ENV_MAP_DUALFISHEYE)\n\n<%include file="pragmatic-pbr/envmap-dualfisheye.glsl"/>\n\nvec4 sampleEnvMap(vec3 dir) {\n  vec2 uv = dualfisheyeUVsFromDir(dir);\n  return texture2D(backgroundImage, uv) * exposure;\n}\n\n#elif (ENV_MAPTYPE == ENV_MAP_SH)\n\n<%include file="SHCoeffs.glsl"/>\n\nvec4 sampleEnvMap(vec3 dir) {\n\treturn vec4(sampleSHCoeffs(dir) * exposure, 1.0);\n}\n\n#elif (ENV_MAPTYPE == ENV_MAP_BRDF_LUT)\n\nuniform sampler2D brdfLUT;\n\nvec4 sampleEnvMap(vec3 dir) {\n  return texture2D(brdfLUT, v_texCoord);\n}\n#endif\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  fragColor = sampleEnvMap(normalize(v_worldDir));\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  fragColor.rgb = toGamma(fragColor.rgb);\n#endif\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n')}}class Er extends Cr{constructor(e,t){super(e.gl,"EnvMap"),this.__renderer=e,this.__envMap=t,this.__backgroundFocus=0,this.__envMap.isLoaded()?this.init():this.__envMap.once("loaded",this.init.bind(this))}init(){const e=this.__renderer.gl;e.__quadVertexIdsBuffer||e.setupInstancedQuad(),this.__srcGLTex=new Tr(e,this.__envMap),this.__envMapShader=new Fr(e);const t=this.__envMapShader.compileForTarget("GLEnvMap");this.__envMapShaderBinding=Mr(e,t.attrs,e.__quadattrbuffers,e.__quadIndexBuffer);const i=this.__envMap.getParameter("HeadLightMode"),s=()=>{i.getValue()?this.textureDesc[3]|=1:this.textureDesc[3]&=-2};s(),i.on("valueChanged",(()=>{s(),this.emit("updated")})),this.convolveProbe(this.__srcGLTex),this.emit("updated")}getEnvMap(){return this.__envMap}getBackgroundFocus(){return this.__backgroundFocus}setBackgroundFocus(e){this.__backgroundFocus=e,this.__renderer.requestRedraw()}draw(e){if(this.__envMap.isLoaded()){const t=this.__gl;{this.__envMapShader.bind(e,"GLEnvMap");const i=e.unifs,{envMap:s,focus:a,exposure:r}=e.unifs;s&&this.__srcGLTex.bindToUniform(e,s),a&&t.uniform1f(a.location,this.__backgroundFocus),r&&t.uniform1f(r.location,e.exposure),this.__envMapShaderBinding.bind(e),t.depthMask(!1),e.bindViewports(i,(()=>{t.drawQuad()}))}}}destroy(){super.destroy(),this.__srcGLTex.destroy()}}class zr extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform vec2 pos;\nuniform vec2 size;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n    vec2 position = getQuadVertexPositionFromID();\n    v_texCoord = position+0.5;\n    gl_Position = vec4(vec2(-1.0, -1.0) + (pos * 2.0) + (v_texCoord * abs(size) * 2.0), 0.0, 1.0);\n    if(size.x < 0.0)\n        v_texCoord.x = 1.0 - v_texCoord.x;\n    if(size.y < 0.0)\n        v_texCoord.y = 1.0 - v_texCoord.y;\n}\n'),this.setShaderStage("FRAGMENT_SHADER","\nprecision highp float;\n\nuniform sampler2D image;\n\nvarying vec2 v_texCoord;\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = texture2D(image, v_texCoord);\n    fragColor = vec4(fragColor.rgb/fragColor.a, 1.0);\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n"),this.finalize()}}class Nr{constructor(e){this.__gl=e,this.__pos=[0,0],this.__size=[1,1],this.flipY=!0,this.__glshader=new zr(e),e.__quadVertexIdsBuffer||e.setupInstancedQuad();const t=this.__glshader.compileForTarget("GLScreenQuad");this.__quadBinding=Mr(e,t.attrs,e.__quadattrbuffers,e.__quadIndexBuffer),this.ready=!0}bind(e,t,i,s){const a=e.unifs;t.bindToUniform(e,e.unifs.image);const r=this.__gl;{const e=a.pos;e&&r.uniform2fv(e.location,i?i instanceof li?i.asArray():i:this.__pos)}{const e=a.size;e&&r.uniform2fv(e.location,s?s instanceof li?s.asArray():s:this.__size)}this.__quadBinding.bind(e)}bindShader(e){return this.__glshader.bind(e,"GLScreenQuad")}draw(e,t,i,s){this.bind(e,t,i,s),this.__gl.drawQuad()}destroy(){}}class Pr extends Mi{constructor(e){super(),this.__renderer=e,this.__doubleClickTimeMSParam=this.addParameter(new Bi("DoubleClickTimeMS",200)),this.__fbo=void 0,this.__ongoingPointers=[],this.__backgroundColor=new mi(.3,.3,.3,1);const t=()=>{const t=e.getScene().settings.getParameter("BackgroundColor"),i=()=>{const e=t.getValue(),i=this.__renderer.gl;e instanceof ps?"FLOAT"===e.type?(this.__backgroundTexture=e,this.__backgroundGLTexture=new Tr(i,e)):(this.__backgroundTexture=e,this.__backgroundGLTexture=new pr(i,e)):e instanceof mi?(this.__backgroundGLTexture&&(this.__backgroundGLTexture.destroy(),this.__backgroundGLTexture=void 0,this.__backgroundTexture=void 0),this.__backgroundColor=e):console.warn("Invalid background:"+e),this.emit("updated",{})};i(),t.on("valueChanged",i)};this.__renderer.getScene()?t(this.__renderer.getScene()):this.__renderer.on("sceneSet",t)}getRenderer(){return this.__renderer}getBl(){return this.__bl}setBl(e){this.__bl=e,this.resize(this.__canvasWidth,this.__canvasHeight)}getTr(){return this.__tr}setTr(e){this.__tr=e,this.resize(this.__canvasWidth,this.__canvasHeight)}getPosX(){return this.__x}getPosY(){return this.__y}getWidth(){return this.__width}getHeight(){return this.__height}getBackground(){console.warn("Deprecated Function. Please access the Scene Settings object.");return this.__renderer.getScene().settings.getParameter("BackgroundColor").getValue()}setBackground(e){console.warn("Deprecated Function. Please access the Scene Settings object.");this.__renderer.getScene().settings.getParameter("BackgroundColor").setValue(e),this.emit("updated",{})}resize(e,t){this.__canvasWidth=e,this.__canvasHeight=t,this.__width=e,this.__height=t,this.emit("resized",{width:this.__width,height:this.__height})}getManipulator(){return this.manipulator}setManipulator(e){this.manipulator!=e&&(this.manipulator&&this.manipulator.deactivateTool&&this.manipulator.deactivateTool(),this.manipulator=e,this.manipulator.activateTool&&this.manipulator.activateTool())}onPointerDown(e){console.warn("@GLBaseViewport#onPointerDown - Implement me!")}onPointerUp(e){console.warn("@GLBaseViewport#onPointerUp - Implement me!")}onPointerMove(e){console.warn("@GLBaseViewport#onPointerMove - Implement me!")}onPointerEnter(e){console.warn("@GLBaseViewport#onPointerEnter - Implement me!")}onPointerLeave(e){console.warn("@GLBaseViewport#onPointerLeave - Implement me!")}onMouseLeave(e){}onKeyDown(e){}onKeyUp(e){}_getOngoingPointerIndexById(e){return this.__ongoingPointers.findIndex((t=>t.pointerId===e))}}class Wr extends Pr{constructor(e,t,i,s){super(e),this.__name=t,this.__projectionMatrix=new fi,this.__frustumDim=new hi,this.__bl=new hi(0,0),this.__tr=new hi(1,1),this.__prevDownTime=0,this.__geomDataBuffer=void 0,this.__geomDataBufferFbo=void 0,this.debugGeomShader=!1,this.setCamera(new Ka("DefaultCamera")),this.setManipulator(new mr({renderer:e})),this.resize(i,s)}resize(e,t){this.__canvasWidth=e,this.__canvasHeight=t,this.__x=e*this.__bl.x,this.__y=e*this.__bl.y,this.__width=e*this.__tr.x-e*this.__bl.x,this.__height=t*this.__tr.y-t*this.__bl.y,this.region=[this.__x,this.__y,this.__width,this.__height],this.__camera&&this.__updateProjectionMatrix(),this.__geomDataBufferFbo&&(this.__geomDataBuffer.resize(this.__width,this.__height),this.renderGeomDataFbo()),this.emit("resized",{width:e,height:t})}getCamera(){return this.__camera}setCamera(e){this.__camera=e;const t=e.getParameter("GlobalXfo"),i=()=>{this.__cameraXfo=t.getValue(),this.__cameraMat=this.__cameraXfo.toMat4(),this.__viewMat=this.__cameraMat.inverse()};i(),t.on("valueChanged",(()=>{i(),this.invalidateGeomDataBuffer(),this.emit("updated"),this.emit("viewChanged",{interfaceType:"CameraAndPointer",viewXfo:this.__cameraXfo,focalDistance:this.__camera.getFocalDistance(),fieldOfView:this.__camera.getFov()})})),this.__camera.on("projectionParamChanged",(()=>{this.__updateProjectionMatrix(),this.emit("updated")})),this.__updateProjectionMatrix()}__updateProjectionMatrix(){const e=this.__width/this.__height;this.__camera.updateProjectionMatrix(this.__projectionMatrix,e);const t=Math.tan(this.__camera.getFov()/2)*this.__camera.getNear()*2,i=t*e;this.__frustumDim.set(i,t)}getProjectionMatrix(){return this.__projectionMatrix}getViewMatrix(){return this.__viewMat}setActive(e){activeViewport=e?this:void 0}frameView(e){this.__width>0&&this.__height>0?this.__camera.frameView(this,e):this.once("resized",(()=>this.frameView()))}calcRayFromScreenPos(e){const t=this.__canvasHeight*(1-this.__tr.y);let i=(e.x-this.__x)/this.__width,s=(e.y-t)/this.__height;i=2*i-1,s=2*s-1;const a=this.__cameraMat,r=this.__projectionMatrix.inverse();if(null==r)return null;let n,o;return this.__camera.isOrthographic()?(n=a.transformVec3(r.transformVec3(new di(i,-s,-1))),o=new di(0,0,-1)):(n=a.translation,o=r.transformVec3(new di(i,-s,-1))),o=a.rotateVec3(o).normalize(),new bi(n,o)}createGeomDataFbo(e){const t=this.__renderer.gl;this.__floatGeomBuffer=e,this.__floatGeomBuffer?this.__geomDataBuffer=new pr(t,{type:"FLOAT",format:"RGBA",filter:"NEAREST",width:this.__width<=1?1:this.__width,height:this.__height<=1?1:this.__height}):this.__geomDataBuffer=new pr(t,{type:"UNSIGNED_BYTE",format:"RGBA",filter:"NEAREST",width:this.__width<=1?1:this.__width,height:this.__height<=1?1:this.__height}),this.__geomDataBufferFbo=new xr(t,this.__geomDataBuffer,!0),this.__geomDataBufferFbo.setClearColor([0,0,0,0])}getGeomDataFbo(){return this.__geomDataBufferFbo}renderGeomDataFbo(){if(this.__geomDataBufferFbo){this.__geomDataBufferFbo.bindAndClear();const e={};this.__initRenderState(e),this.__renderer.drawSceneGeomData(e),this.__geomDataBufferInvalid=!1}}invalidateGeomDataBuffer(){this.__geomDataBufferInvalid=!0}getGeomDataAtPos(e,t){if(this.__geomDataBufferFbo){if(this.__geomDataBufferInvalid&&(this.renderGeomDataFbo(),this.__screenPos=null),e===this.__screenPos)return this.__intersectionData;this.__screenPos=e,this.__intersectionData=null;const i=this.__renderer.gl;let s,a;if(i.finish(),this.__geomDataBufferFbo.bindForReading(),i.floatGeomBuffer){if(a=new Float32Array(4),i.readPixels(e.x,this.__height-e.y,1,1,i.RGBA,i.FLOAT,a),0==a[3])return;s=63&Math.round(a[0])}else{if(a=new Uint8Array(4),i.readPixels(e.x,this.__height-e.y,1,1,i.RGBA,i.UNSIGNED_BYTE,a),i.bindFramebuffer(i.FRAMEBUFFER,null),0==a[0]&&0==a[1])return;s=Math.floor(a[1]/64)}this.__geomDataBufferFbo.unbind();const r=this.__renderer.getPass(s);if(!r)return void console.warn("Geom data buffer returns invalid pass id:",s);const n=r.getGeomItemAndDist(a);if(n){const i=n.geomItem.getParameter("Material");if(i&&!i.getValue().visibleInGeomDataBuffer)return;t||(t=this.calcRayFromScreenPos(e));const s=t.start.add(t.dir.scale(n.dist));this.__intersectionData=Object.assign({screenPos:e,pointerRay:t,intersectionPos:s,geomData:a},n)}return this.__intersectionData}}getGeomItemsInRect(e,t){if(this.__geomDataBufferFbo){const i=this.__renderer.gl;i.finish();const s=Math.round(this.__height-t.y),a=Math.round(e.x),r=Math.round(t.x-e.x),n=Math.round(t.y-e.y),o=r*n;let l;this.__geomDataBufferFbo.bindForReading(),i.floatGeomBuffer?(l=new Float32Array(4*o),i.readPixels(a,s,r,n,i.RGBA,i.FLOAT,l)):(l=new Uint8Array(4*o),i.readPixels(a,s,r,n,i.RGBA,i.UNSIGNED_BYTE,l)),i.bindFramebuffer(i.FRAMEBUFFER,null);const h=new Set;for(let e=0;e<o;e++){let t;const s=l.subarray(4*e,4*(e+1));if(i.floatGeomBuffer){if(0==s[3])continue;t=Math.round(s[0])}else{if(0==s[0]&&0==s[1])continue;t=Math.floor(s[1]/64)}const a=this.__renderer.getPass(t).getGeomItemAndDist(s);if(a){const e=a.geomItem.getParameter("Material");if(e&&!e.getValue().visibleInGeomDataBuffer)continue;h.add(a.geomItem)}}return[...h].filter((e=>{const t=e.getParameter("Material");return!(t&&!t.getValue().visibleInGeomDataBuffer)}))}}__getPointerPos(e,t){return new hi(e-this.getPosX(),t-this.getPosY())}getCapture(){return this.capturedItem}releaseCapture(){this.capturedItem=null}__preparePointerEvent(e){e.viewport=this,e.setCapture=e=>{this.capturedItem=e},e.getCapture=e=>this.capturedItem,e.releaseCapture=()=>{this.capturedItem=null}}onPointerDown(e){if(this.__preparePointerEvent(e),e.pointerType===ti.mouse)e.pointerPos=this.__getPointerPos(e.rendererX,e.rendererY),e.pointerRay=this.calcRayFromScreenPos(e.pointerPos),e.intersectionData=this.getGeomDataAtPos(e.pointerPos,e.pointerRay);else if(e.pointerType===ti.touch&&1==e.touches.length){const t=e.touches[0];e.pointerPos=this.__getPointerPos(t.rendererX,t.rendererY),e.pointerRay=this.calcRayFromScreenPos(e.pointerPos),e.intersectionData=this.getGeomDataAtPos(e.pointerPos,e.pointerRay)}const t=Date.now();if(t-this.__prevDownTime<this.__doubleClickTimeMSParam.getValue()){if(this.manipulator&&(this.manipulator.onPointerDoublePress(e),!e.propagating))return;if(this.emit("pointerDoublePressed",e),!e.propagating)return}else this.__prevDownTime=t;this.capturedItem?this.capturedItem.onPointerDown(e):null!=e.intersectionData&&(e.intersectionData.geomItem.onPointerDown(e),!e.propagating||this.capturedItem)||(this.emit("pointerDown",e),e.propagating&&!this.capturedItem&&(!this.manipulator||(this.manipulator.onPointerDown(e),e.propagating)))}onPointerUp(e){if(this.__preparePointerEvent(e),e.pointerType===ti.mouse)e.pointerPos=this.__getPointerPos(e.rendererX,e.rendererY),e.pointerRay=this.calcRayFromScreenPos(e.pointerPos),e.intersectionData=this.getGeomDataAtPos(e.pointerPos,e.pointerRay);else if(e.pointerType===ti.touch&&0==e.touches.length&&1==e.changedTouches.length){const t=e.changedTouches[0];e.pointerPos=this.__getPointerPos(t.rendererX,t.rendererY),e.pointerRay=this.calcRayFromScreenPos(e.pointerPos),e.intersectionData=this.getGeomDataAtPos(e.pointerPos,e.pointerRay)}this.capturedItem&&(this.capturedItem.onPointerUp(e),!e.propagating)||(null==e.intersectionData||(e.intersectionData.geomItem.onPointerUp(e),e.propagating))&&(this.emit("pointerUp",e),e.propagating&&(!this.manipulator||(this.manipulator.onPointerUp(e),e.propagating)))}onPointerMove(e){if(this.__preparePointerEvent(e),e.pointerType===ti.mouse){const t=this.__getPointerPos(e.rendererX,e.rendererY);e.pointerPos=t,e.pointerRay=this.calcRayFromScreenPos(t)}else if(e.pointerType===ti.touch){e.touchPos=[],e.touchRay=[];for(let t=0;t<e.touches.length;t++){const i=e.touches[t],s=this.__getPointerPos(i.rendererX,i.rendererY);e.touchPos[t]=s,e.touchRay[t]=this.calcRayFromScreenPos(s)}e.pointerPos=e.touchPos[0],e.pointerRay=e.touchRay[0]}if(!this.capturedItem||(this.capturedItem.onPointerMove(e),e.propagating)){if(e.intersectionData=this.getGeomDataAtPos(e.pointerPos,e.pointerRay),e.intersectionData){if(e.intersectionData.geomItem!=this.pointerOverItem){if(this.pointerOverItem&&(e.leftGeometry=this.pointerOverItem,this.pointerOverItem.onPointerLeave(e),e.propagating&&this.emit("pointerLeaveGeom",e)),this.pointerOverItem=e.intersectionData.geomItem,this.pointerOverItem.onPointerEnter(e),!e.propagating)return;this.emit("pointerOverGeom",e)}if(e.intersectionData.geomItem.onPointerMove(e),!e.propagating||this.capturedItem)return}else if(this.pointerOverItem){if(e.leftGeometry=this.pointerOverItem,this.pointerOverItem.onPointerLeave(e),this.pointerOverItem=null,!e.propagating)return;this.emit("pointerLeaveGeom",e)}this.emit("pointerMove",e),e.propagating&&(!this.manipulator||(this.manipulator.onPointerMove(e),e.propagating))}}onPointerEnter(e){this.__preparePointerEvent(e),this.emit("pointerEnter",e),e.propagating&&(!this.manipulator||!this.manipulator.onPointerEnter||(this.manipulator.onPointerEnter(e),e.propagating))}onPointerLeave(e){this.__preparePointerEvent(e),this.emit("pointerLeave",e),e.propagating&&(!this.manipulator||!this.manipulator.onPointerLeave||(this.manipulator.onPointerLeave(e),e.propagating))}onKeyDown(e){this.__preparePointerEvent(e),this.manipulator&&(this.manipulator.onKeyDown(e),!e.propagating)||this.emit("keyDown",e)}onKeyUp(e){this.__preparePointerEvent(e),this.manipulator&&(this.manipulator.onKeyUp(e),!e.propagating)||this.emit("keyUp",e)}onWheel(e){this.__preparePointerEvent(e),e.pointerPos=this.__getPointerPos(e.rendererX,e.rendererY),e.pointerRay=this.calcRayFromScreenPos(e.pointerPos),e.intersectionData=this.getGeomDataAtPos(e.pointerPos,e.pointerRay),(null==e.intersectionData||(e.intersectionData.geomItem.onWheel(e),e.propagating))&&(this.manipulator?this.manipulator.onWheel(e):this.emit("mouseWheel",e))}onTouchCancel(e){this.__preparePointerEvent(e),this.capturedItem?this.capturedItem.onTouchCancel(e):this.manipulator?this.manipulator.onTouchCancel(e):this.emit("touchCancel",e)}__initRenderState(e){e.viewXfo=this.__cameraXfo,e.viewScale=1,e.region=this.region,e.cameraMatrix=this.__cameraMat,e.viewport=this,e.viewports=[{region:this.region,viewMatrix:this.__viewMat,projectionMatrix:this.__projectionMatrix,viewportFrustumSize:this.__frustumDim,isOrthographic:this.__camera.isOrthographic(),fovY:this.__camera.getFov()}]}draw(){const e=this.__renderer.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(...this.region),e.clearColor(...this.__backgroundColor.asArray()),e.colorMask(!0,!0,!0,!1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);const t={};this.__initRenderState(t),this.__renderer.drawScene(t),this.debugGeomShader&&(e.screenQuad.bindShader(t),e.screenQuad.draw(t,this.__geomDataBuffer))}}class Br{constructor(e,t){this.__xrvp=e,this.__treeItem=new us("VRHead"),t.addChild(this.__treeItem),this.__mat4=new fi,this.__localXfo=new yi}setVisible(e){if(e&&!this.hmdGeomItem){const e=this.__xrvp.getAsset();if(!e)return;this.hmdGeomItem=e.getChildByName("HMD").clone({assetItem:e}),this.hmdGeomItem&&(this.hmdGeomItem.getParameter("LocalXfo").setValue(new yi(new di(0,-.035,-.03),new pi({setFromAxisAndAngle:[new di(0,1,0),Math.PI]}),new di(.001,.001,.001))),this.__treeItem.addChild(this.hmdGeomItem,!1))}this.hmdGeomItem&&this.hmdGeomItem.getParameter("Visible").setValue(e)}update(e){this.__mat4.setDataArray(e.transform.matrix),this.__localXfo.fromMat4(this.__mat4),this.__treeItem.getParameter("LocalXfo").setValue(this.__localXfo)}getTreeItem(){return this.__treeItem}getXfo(){return this.__localXfo}}class Yr{constructor(e,t,i){if(this.xrvp=e,this.__inputSource=t,this.id=i,this.__mat4=new fi,this.__xfo=new yi,this.__treeItem=new us("VRController:"+t.handedness+i),!si.isMobileDevice){this.__tip=new us("Tip");const i=new yi;if(i.tr.set(0,-.05,-.13),this.__tip.getParameter("LocalXfo").setValue(i),this.__treeItem.addChild(this.__tip,!1),e.getTreeItem().addChild(this.__treeItem),this.__activeVolumeSize=.04,"tracked-pointer"==t.targetRayMode){switch(t.profiles[0]){case"htc-vive":localStorage.setItem("ZeaEngine_XRDevice","Vive");break;case"oculus-touch":case"oculus-touch-v2":case"oculus-touch-v3":localStorage.setItem("ZeaEngine_XRDevice","Oculus")}e.loadHMDResources().then((e=>{if(!e)return;let i;if("htc-vive"==t.profiles[0])i=e.getChildByName("Controller");else switch(t.handedness){case"left":i=e.getChildByName("LeftController");break;case"right":i=e.getChildByName("RightController");break;case"none":case"left-right":case"left-right-none":i=e.getChildByName("Controller")}if(i){const t=i.clone({assetItem:e});t.getParameter("LocalXfo").setValue(new yi(new di(0,-.035,-.085),new pi({setFromAxisAndAngle:[new di(0,1,0),Math.PI]}),new di(.001,.001,.001))),this.__treeItem.addChild(t,!1)}}))}}this.tick=0}getHandedness(){return this.__inputSource.handedness}getId(){return this.id}getTreeItem(){return this.__treeItem}getTipItem(){return this.__tip}getTipXfo(){return this.__tip.getParameter("GlobalXfo").getValue()}getTouchPadValue(){return this.__touchpadValue}isButtonPressed(){return this.__buttonPressed}getControllerStageLocalXfo(){return this.__xfo}getControllerTipStageLocalXfo(){return this.__xfo.multiply(this.__tip.getParameter("LocalXfo").getValue())}updatePose(e,t,i,s){const a=t.getPose(i.gripSpace,e);if(a&&a.transform){if(this.__mat4.setDataArray(a.transform.matrix),this.__xfo.fromMat4(this.__mat4),this.__treeItem.getParameter("LocalXfo").setValue(this.__xfo),this.__geomAtTip=void 0,this.__hitTested=!1,this.tick%5==0&&!s.getCapture()){const e=this.getGeomItemAtTip();null!=e?(s.intersectionData=e,e.geomItem!=this.pointerOverItem&&(this.pointerOverItem&&this.pointerOverItem.onPointerLeave(s),this.pointerOverItem=e.geomItem,s.geomItem=e.geomItem,this.pointerOverItem.onPointerEnter(s)),e.geomItem.onPointerMove(s)):this.pointerOverItem&&(s.leftGeometry=this.pointerOverItem,this.pointerOverItem.onPointerLeave(s),this.pointerOverItem=null)}this.tick++}}getGeomItemAtTip(){if(this.__hitTested)return this.__intersectionData;this.__hitTested=!0;const e=this.xrvp.getRenderer(),t=this.__tip.getParameter("GlobalXfo").getValue(),i=this.__activeVolumeSize;return this.__intersectionData=e.raycastWithXfo(t,i,i),this.__intersectionData}}class Ar extends hr{constructor(e){super(),this.__controllerTriggersHeld=[],this.xrvp=e,this.vrControllerToolTip=new Us(.015),this.vrControllerToolTipMat=new Xs("Cross","FlatSurfaceShader"),this.vrControllerToolTipMat.getParameter("BaseColor").setValue(new mi("#03E3AC")),this.vrControllerToolTipMat.visibleInGeomDataBuffer=!1,this.addIconToController=this.addIconToController.bind(this)}addIconToController(e){const{controller:t}=e,i=new va("HandleToolTip",this.vrControllerToolTip,this.vrControllerToolTipMat);t.getTipItem().removeAllChildren(),t.getTipItem().addChild(i,!1)}activateTool(){super.activateTool();for(const e of this.xrvp.getControllers())this.addIconToController({controller:e});this.xrvp.on("controllerAdded",this.addIconToController)}deactivateTool(){super.deactivateTool();for(let e of xrvp.getControllers())e.getTipItem().removeAllChildren();this.xrvp.off("controllerAdded",this.addIconToController)}__initMoveStage(){if(1==this.__controllerTriggersHeld.length)this.__grabPos=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr.clone(),this.stageXfo__GrabStart=this.xrvp.getXfo().clone(),this.__invOri=this.stageXfo__GrabStart.ori.inverse();else if(2==this.__controllerTriggersHeld.length){const e=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,t=this.__controllerTriggersHeld[1].getControllerTipStageLocalXfo().tr;this.__grabDir=t.subtract(e),this.__grabPos=e.lerp(t,.5),this.__grabDir.y=0,this.__grabDist=this.__grabDir.length(),this.__grabDir.scaleInPlace(1/this.__grabDist),this.stageXfo__GrabStart=this.xrvp.getXfo().clone(),this.__grab_to_stage=this.__grabPos.subtract(this.stageXfo__GrabStart.tr)}}onVRControllerButtonDown(e){1==e.button&&(this.__controllerTriggersHeld.push(e.controller),this.__initMoveStage(),e.stopPropagation())}onVRControllerButtonUp(e){if(1!=e.button)return;const t=this.__controllerTriggersHeld.indexOf(e.controller);this.__controllerTriggersHeld.splice(t,1),this.__initMoveStage(),e.stopPropagation()}onVRControllerDoubleClicked(e){console.log("onVRControllerDoubleClicked:",this.__controllerTriggersHeld.length);const t=this.xrvp.getXfo().clone();t.sc.set(1,1,1),this.xrvp.setXfo(t)}onVRPoseChanged(e){if(1==this.__controllerTriggersHeld.length){const e=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,t=new yi;t.tr=this.__grabPos.subtract(e);const i=this.stageXfo__GrabStart.multiply(t);this.xrvp.setXfo(i)}else if(2==this.__controllerTriggersHeld.length){const e=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,t=this.__controllerTriggersHeld[1].getControllerTipStageLocalXfo().tr,i=e.lerp(t,.5),s=t.subtract(e);s.y=0;const a=s.length();s.scaleInPlace(1/a);const r=new yi,n=Math.max(Math.min(this.__grabDist/a,10),.1);r.sc.set(n,n,n);let o=this.__grabDir.angleTo(s);this.__grabDir.cross(s).y>0&&(o=-o),r.ori.rotateY(o);const l=r.ori.rotateVec3(this.__grabPos);r.tr.addInPlace(this.__grabPos.subtract(l));const h=this.__grabPos.scale(1-n);r.tr.addInPlace(r.ori.rotateVec3(h));const d=this.__grabPos.subtract(i).scale(n);r.tr.addInPlace(r.ori.rotateVec3(d));const c=this.stageXfo__GrabStart.multiply(r);this.xrvp.setXfo(c)}}onPointerDown(e){e.pointerType===ti.xr&&this.onVRControllerButtonDown(e)}onPointerMove(e){e.pointerType===ti.xr&&this.onVRPoseChanged(e)}onPointerUp(e){e.pointerType===ti.xr&&this.onVRControllerButtonUp(e)}onPointerDoublePress(e){e.pointerType===ti.xr&&this.onVRControllerDoubleClicked(e)}}class Dr extends Pr{constructor(e){super(e),this.getParameter("DoubleClickTimeMS").setValue(300),this.__projectionMatricesUpdated=!1,this.__far=1024,this.__near=.1,this.__stageTreeItem=new us("VRStage"),this.__stageTreeItem.setSelectable(!1),this.__stageTreeItem.setVisible(!1),this.__renderer.addTreeItem(this.__stageTreeItem),this.__vrhead=new Br(this,this.__stageTreeItem),this.controllersMap={},this.controllers=[],this.prevControllerDownTime=[],this.spectatorMode=!1,this.tick=0;const t=new yi;t.ori.setFromAxisAndAngle(new di(1,0,0),.5*Math.PI),this.setXfo(t),this.__leftViewMatrix=new fi,this.__leftProjectionMatrix=new fi,this.__rightViewMatrix=new fi,this.__rightProjectionMatrix=new fi,this.setManipulator(new Ar(this))}getAsset(){return this.__vrAsset}getTreeItem(){return this.__stageTreeItem}getVRHead(){return this.__vrhead}getXfo(){return this.__stageXfo}setXfo(e){this.__stageXfo=e,this.__stageTreeItem.getParameter("GlobalXfo").setValue(e),this.__stageMatrix=e.inverse().toMat4(),this.__stageScale=e.sc.x}getControllers(){return this.controllers}canPresent(){return this.__canPresent}isPresenting(){return this.session}setSpectatorMode(e){if(!e){const e=this.__renderer.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),e.clearColor(...this.__backgroundColor.asArray()),e.colorMask(!0,!0,!0,!0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}this.spectatorMode=e}__startSession(){const e=(t,i)=>{this.session&&(this.session.requestAnimationFrame(e),this.draw(i))};this.session.requestAnimationFrame(e)}loadHMDResources(){if(si.isMobileDevice)return Promise.resolve();let e=localStorage.getItem("ZeaEngine_XRDevice");if(e||(e="Vive",localStorage.setItem("ZeaEngine_XRDevice",e)),this.__hmd!=e)this.__hmdAssetPromise=void 0;else if(this.__hmdAssetPromise)return this.__hmdAssetPromise;return this.__hmd=e,this.__hmdAssetPromise=new Promise(((t,i)=>{{let i;switch(e){case"Vive":i="ZeaEngine/Vive.vla";break;case"Oculus":i="ZeaEngine/Oculus.vla";break;default:i="ZeaEngine/Vive.vla"}if(!ms.getCommonResource(i)){const e=new nr(i);e.getParameter("FilePath").setValue(i),ms.setCommonResource(i,e)}this.__vrAsset=ms.getCommonResource(i);const s=()=>{const e=this.__vrAsset.getMaterialLibrary(),i=e.getMaterialNames();for(const t of i){const i=e.getMaterial(t,!1);i&&(i.visibleInGeomDataBuffer=!1,i.setShaderName("SimpleSurfaceShader"))}t(this.__vrAsset)};this.__vrAsset.isLoaded()?s():this.__vrAsset.once("loaded",s)}})),this.__hmdAssetPromise}startPresenting(){return new Promise(((e,t)=>{this.spectatorMode||this.setSpectatorMode(!1);const i=this.__renderer.gl;(()=>{navigator.xr.requestSession("immersive-vr",{requiredFeatures:["local-floor"],optionalFeatures:["bounded-floor"]}).then((s=>{this.__renderer.__xrViewportPresenting=!0;const a=this.__renderer.getActiveViewport().getCamera().getParameter("GlobalXfo").getValue(),r=new yi;r.tr=a.tr.clone(),r.tr.z-=1.3;const n=a.ori.getZaxis();n.z=0,n.normalizeInPlace(),r.ori.setFromDirectionAndUpvector(n.negate(),new di(0,0,1)),this.setXfo(r),s.addEventListener("end",(e=>{this.__stageTreeItem.setVisible(!1),this.session=null,this.emit("presentingChanged",{state:!1})}));const o=e=>{console.log("creating controller:",e.handedness,e.profiles);const t=this.controllers.length,i=new Yr(this,e,t);return this.controllersMap[e.handedness]=i,this.controllers[t]=i,this.emit("controllerAdded",{controller:i}),i};s.addEventListener("selectstart",(e=>{const t=this.controllersMap[e.inputSource.handedness];t&&this.onPointerDown({button:1,controller:t})})),s.addEventListener("selectend",(e=>{const t=this.controllersMap[e.inputSource.handedness];t&&this.onPointerUp({button:1,controller:t})})),s.addEventListener("inputsourceschange",(e=>{for(const t of e.added)0!=t.profiles.length&&o(t)})),this.session=s;const l=new XRWebGLLayer(s,i);s.updateRenderState({baseLayer:l}),this.__width=l.framebufferWidth,this.__height=l.framebufferHeight,this.__renderer.resizeFbos(this.__width,this.__height),this.__region=[0,0,this.__width,this.__height];const h=t=>{this.__refSpace=t,this.__stageTreeItem.setVisible(!0),this.emit("presentingChanged",{state:!0}),this.loadHMDResources().then((()=>{this.__startSession(),e()}))};s.requestReferenceSpace(si.isMobileDevice?"local":"bounded-floor").catch((e=>{console.log("Falling back to local-floor reference space"),s.requestReferenceSpace("local-floor").then(h)})).then((e=>{h(e)})).catch((e=>{console.warn(e.message),t(new Error("Unable to start XR Session:"+e.message))}))})).catch((e=>{console.warn(e.message)}))})()}))}stopPresenting(){this.session&&this.session.end()}togglePresenting(){this.session?this.stopPresenting():this.startPresenting()}getHMDCanvasSize(){return this.__hmdCanvasSize}updateControllers(e,t){const i=this.session.inputSources;for(let s=0;s<i.length;s++){const a=i[s];if(0==a.profiles.length)return;this.controllers[s]?this.controllers[s].updatePose(this.__refSpace,e,a,t):console.warn("Missing controller")}}draw(e){const t=e.session.renderState.baseLayer,i=e.getViewerPose(this.__refSpace);if(!i)return;this.__vrhead.update(i);const s={};this.preparePointerEvent(s),this.updateControllers(e,s),this.capturedElement&&s.propagating&&this.capturedElement.onPointerMove(s),this.manipulator&&s.propagating&&this.manipulator.onPointerMove(s);const a=i.views;if(!this.__projectionMatricesUpdated){this.__projectionMatrices=[],this.__viewMatrices=[],this.__cameraMatrices=[];for(let e=0;e<a.length;e++){const t=a[e],i=new fi;i.setDataArray(t.projectionMatrix),this.__projectionMatrices[e]=i,this.__viewMatrices[e]=new fi,this.__cameraMatrices[e]=new fi}this.__projectionMatricesUpdated=!0}const r=this.__renderer.gl;r.bindFramebuffer(r.FRAMEBUFFER,t.framebuffer),r.clearColor(...this.__backgroundColor.asArray()),r.colorMask(!0,!0,!0,!0),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT);const n={boundRendertarget:t.framebuffer,region:this.__region,vrviewport:this,viewports:[]};for(let e=0;e<a.length;e++){const i=a[e];this.__viewMatrices[e].setDataArray(i.transform.inverse.matrix),this.__viewMatrices[e].multiplyInPlace(this.__stageMatrix);const s=t.getViewport(i);n.viewports.push({viewMatrix:this.__viewMatrices[e],projectionMatrix:this.__projectionMatrices[e],region:[s.x,s.y,s.width,s.height]})}n.viewXfo=this.__vrhead.getTreeItem().getParameter("GlobalXfo").getValue(),n.viewScale=1/this.__stageScale,n.cameraMatrix=n.viewXfo.toMat4(),n.region=this.__region,n.vrPresenting=!0,this.__renderer.drawScene(n);const o={interfaceType:"VR",hmd:this.__hmd,viewXfo:n.viewXfo,controllers:this.controllers,vrviewport:this};if(this.emit("viewChanged",o),this.spectatorMode&&!si.isMobileDevice&&this.tick%5==0){const e=this.__renderer.getActiveViewport();this.__vrhead.setVisible(!0),e.draw(),this.__vrhead.setVisible(!1)}this.tick++}preparePointerEvent(e){e.viewport=this,e.propagating=!0,e.pointerType=ti.xr,e.stopPropagation=()=>{e.propagating=!1},e.setCapture=e=>{this.capturedItem=e},e.getCapture=e=>this.capturedItem,e.releaseCapture=()=>{this.capturedItem=null}}onPointerDown(e){this.preparePointerEvent(e),e.intersectionData=e.controller.getGeomItemAtTip();const t=Date.now();if(t-this.prevControllerDownTime[e.controller.id]<this.__doubleClickTimeMSParam.getValue()){if(this.emit("pointerDoublePressed",e),!e.propagating)return;if(this.manipulator&&(this.manipulator.onPointerDoublePress(e),!e.propagating))return}this.prevControllerDownTime[e.controller.id]=t,this.capturedItem?this.capturedItem.onPointerDown(e):null!=e.intersectionData&&(e.intersectionData.geomItem.onPointerDown(e),!e.propagating||this.capturedItem)||(this.emit("pointerDown",e),e.propagating&&!this.capturedItem&&this.manipulator&&this.manipulator.onPointerDown(e))}onPointerUp(e){this.preparePointerEvent(e),this.capturedItem?this.capturedItem.onPointerUp(e):(e.intersectionData=e.controller.getGeomItemAtTip(),(null==e.intersectionData||(e.intersectionData.geomItem.onPointerUp(e),e.propagating))&&(this.emit("pointerUp",e),e.propagating&&(!this.manipulator||(this.manipulator.onPointerUp(e),e.propagating))))}}class kr{constructor(e,t,i,s,a){const r=i.getName();switch(this.param=i,this.unif=s,this.textureUnif=a[r+"Tex"],this.textureTypeUnif=a[r+"TexType"],this.uniform1i=e.uniform1i.bind(e),s.type){case Boolean:this.uniformXX=e.uniform1i.bind(e);break;case 4:"webgl2"==e.name?this.uniformXX=e.uniform1ui.bind(e):this.uniformXX=e.uniform1i.bind(e);break;case 5:this.uniformXX=e.uniform1i.bind(e);break;case 6:this.uniformXX=e.uniform1f.bind(e)}this.bind=this.bindValue;const n=i=>{let s=i.getMetadata("gltexture");s||(s="FLOAT"===i.type?new Tr(e,i):new pr(e,i)),this.texBinding=s.preBind(this.textureUnif,a),s.on("updated",(()=>{t.emit("updated",{})})),this.gltexture=s,this.gltexture.addRef(this),this.textureType=1,this.bind=this.bindTexture,t.emit("updated",{})};let o,l;const h=e=>{e.isLoaded()?n(e):(l=()=>{n(o)},e.on("loaded",l)),o=e},d=()=>{o.getMetadata("gltexture").removeRef(this),this.texBinding=null,this.gltexture=null,this.textureType=null,this.bind=this.bindValue,l&&o.off("loaded",l),o=null,l=null,t.emit("updated",{})};this.update=()=>{try{o||(this.val=i.getValue())}catch(e){}t.emit("updated")},i.getImage()&&h(i.getImage()),i.on("textureConnected",(()=>{h(i.getImage())})),i.on("textureDisconnected",(()=>{d()})),this.dirty=!0,i.on("valueChanged",(()=>{this.dirty=!0,t.emit("updated",{})}))}bindValue(e){this.dirty&&(this.update(),this.dirty=!1),this.unif&&this.uniformXX(this.unif.location,this.val),this.textureTypeUnif&&this.uniform1i(this.textureTypeUnif.location,0)}bindTexture(e){this.dirty&&(this.update(),this.dirty=!1),this.gltexture.bindToUniform(e,this.textureUnif,this.texBinding)}unbind(){}destroy(){}}class Kr{constructor(e,t,i,s){switch(this.param=i,this.unif=s,s.type){case hi:this.uniformXX=e.uniform2fv.bind(e);break;case di:this.uniformXX=e.uniform3fv.bind(e);break;case ci:this.uniformXX=e.uniform4fv.bind(e)}this.dirty=!0,i.on("valueChanged",(()=>{this.dirty=!0,t.emit("updated",{})}))}bind(e){this.dirty&&(this.vals=this.param.getValue().asArray(),this.dirty=!1),this.uniformXX(this.unif.location,this.vals)}unbind(){}destroy(){}}class Hr{constructor(e,t,i,s){switch(this.param=i,this.unif=s,s.type){case Mat3:this.uniformMatrixXXX=e.uniformMatrix3fv.bind(e);break;case fi:this.uniformMatrixXXX=e.uniformMatrix4fv.bind(e)}this.dirty=!0,i.on("valueChanged",(()=>{this.dirty=!0,t.emit("updated",{})}))}bind(e){this.dirty&&(this.vals=this.param.getValue().asArray(),this.dirty=!1),this.uniformMatrixXXX(this.unif.location,!1,this.val)}unbind(){}destroy(){}}class Ur{constructor(e,t,i,s,a){const r=i.getName();this.param=i,this.unif=s,this.textureUnif=a[r+"Tex"],this.textureTypeUnif=a[r+"TexType"],this.vals=[0,0,0,0],this.bind=this.bindValue;const n=i=>{let s=i.getMetadata("gltexture");s||(s="FLOAT"===i.type?new Tr(e,i):new pr(e,i)),this.texBinding=s.preBind(this.textureUnif,a),s.on("updated",(()=>{t.emit("updated",{})})),this.gltexture=s,this.gltexture.addRef(this),this.textureType=1,this.bind=this.bindTexture,t.emit("updated",{})};let o,l;const h=e=>{e.isLoaded()?n(e):(l=()=>{n(o)},e.on("loaded",l)),o=e},d=()=>{o.getMetadata("gltexture").removeRef(this),this.texBinding=null,this.gltexture=null,this.textureType=null,this.bind=this.bindValue,l&&o.off("loaded",l),o=null,l=null,t.emit("updated",{})};this.update=()=>{try{if(o);else if(this.unif){const e=i.getValue();this.vals=e.asArray()}}catch(e){}t.emit("updated")},i.getImage()&&h(i.getImage()),i.on("textureConnected",(()=>{h(i.getImage())})),i.on("textureDisconnected",(()=>{d()})),this.dirty=!0,i.on("valueChanged",(()=>{this.dirty=!0})),this.uniform1i=e.uniform1i.bind(e),this.uniform4fv=e.uniform4fv.bind(e)}bindValue(e){this.dirty&&(this.update(),this.dirty=!1),this.unif&&this.uniform4fv(this.unif.location,this.vals),this.textureTypeUnif&&this.uniform1i(this.textureTypeUnif.location,0)}bindTexture(e){this.dirty&&(this.update(),this.dirty=!1),this.gltexture.bindToUniform(e,this.textureUnif,this.texBinding)}}const Or={};class Jr{constructor(e,t,i,s){this.uniformBindings=[];const a=a=>{const r=a.getName(),n=i[r];if(null!=n)switch(n.type){case Boolean:case 4:case 5:case 6:this.uniformBindings.push(new kr(e,t,a,n,i));break;case hi:case di:case ci:this.uniformBindings.push(new Kr(e,t,a,n));break;case mi:this.uniformBindings.push(new Ur(e,t,a,n,i));break;case fi:this.uniformBindings.push(new Hr(e,t,a,n));break;default:return void console.warn("Param :"+r+" has unhandled data type:"+n.type)}else{if(i[r+"Tex"])return void this.uniformBindings.push(new Ur(e,t,a,n,i));if(s){const e=t.getMaterial().getShaderName();Or[e]||(Or[e]={}),Or[e][r]||(console.warn("Material:"+t.getMaterial().getName(),"with Shader ",e,"Param has no unif",r),Or[e][r]=!0)}}},r=t.getMaterial().getParameters();for(const e of r)a(e)}bind(e){for(const t of this.uniformBindings)t.bind(e);return!0}unbind(){for(const e of this.uniformBindings)e.unbind(renderstate)}destroy(){for(const e of this.uniformBindings)e.destroy(renderstate)}}class Qr extends Jt{constructor(e,t,i){super(),this.__gl=e,this.__material=t,this.__glshader=i,this.__shaderBindings={},t.on("parameterValueChanged",(()=>this.emit("updated")))}getMaterial(){return this.__material}getGLShader(){return this.__glshader}bind(e,t){this.__boundTexturesBeforeMaterial=e.boundTextures;let i=this.__shaderBindings[e.shaderkey];if(!i){const s=this.__gl;i=new Jr(s,this,e.unifs,t),this.__shaderBindings[e.shaderkey]=i}return i.bind(e)}unbind(e){e.boundTextures=this.__boundTexturesBeforeMaterial}}class jr extends Jt{constructor(e){super(),this.renderer=e,this.materials=[],this.materialIndices={},this.glMaterials={},this.freeIndices=[],this.dirtyIndices=new Set,this.materialsAllocator=new $t,this.materialsAllocator.on("dataReallocated",(e=>{const t=e.id;this.dirtyIndices.add(t)}))}addMaterial(e){let t=this.materialIndices[e.getId()];if(null!=t)return t;t=this.freeIndices.length?this.freeIndices.pop():this.materials.length,this.materials[t]=e,this.materialIndices[e.getId()]=t;const i=e.getShaderClass().getPackedMaterialData(e),s=this.materialsAllocator.allocate(t,i.length/4);e.setMetadata("glmaterialcoords",{x:s.start,y:s.size});return e.on("parameterValueChanged",(()=>{this.dirtyIndices.add(t),this.emit("updated")})),this.dirtyIndices.add(t),t}getGLMaterial(e){if(this.glMaterials[e.getId()])return this.glMaterials[e.getId()];const t=this.renderer.getOrCreateShader(e.getShaderName()),i=this.renderer.gl,s=new Qr(i,e,t);return s.on("updated",(()=>{this.renderer.requestRedraw()})),e.setMetadata("glMaterial",s),this.glMaterials[e.getId()]=s,s}getMaterialAllocation(e){const t=this.materialIndices[e.getId()];if(null!=t)return this.materialsAllocator.getAllocation(t)}removeMaterial(e){e.deleteMetadata("glmaterialcoords");const t=this.materials.indexOf(e);this.freeIndices.push(t),this.materialsAllocator.deallocate(t),this.materials[t]=null,delete this.materialIndices[e.getId()],this.dirtyIndices.has(t)&&this.dirtyIndices.delete(t)}uploadMaterials(e){const t=this.renderer.gl,i=jt.nextPow2(Math.ceil(Math.sqrt(this.materialsAllocator.reservedSpace))),s=e.boundTextures++;if(t.activeTexture(t.TEXTURE0+s),this.materialsTexture){if(this.materialsTexture.width<i){this.materialsTexture.resize(i,i);for(let e=0;e<this.materials.length;e++)this.materialsAllocator.getAllocation(e)&&this.dirtyIndices.add(e)}}else this.materialsTexture=new pr(t,{format:"RGBA",type:"FLOAT",width:i,height:i,filter:"NEAREST",wrap:"CLAMP_TO_EDGE",mipMapped:!1}),this.materialsTexture.clear();const a=this.materialsTexture,r=this.materialsTexture.width;t.bindTexture(t.TEXTURE_2D,a.glTex),this.dirtyIndices.forEach((e=>{const i=this.materialsAllocator.getAllocation(e),s=this.materials[e],n=s.getShaderClass().getPackedMaterialData(s),o=i.start%r,l=Math.ceil((o+i.size)/r);let h=0,d=i.size,c=o;for(let e=0;e<l;e++){let e;c+d>r?(e=r-c,c=0):e=d;const s=(i.start+h)%r,o=Math.floor((i.start+h)/r),l=n.subarray(4*h,4*(h+e));t.texSubImage2D(t.TEXTURE_2D,0,s,o,e,1,a.__format,a.__type,l),h+=e,d-=e}})),this.dirtyIndices=new Set,t.bindTexture(t.TEXTURE_2D,null),e.boundTextures--}update(e){this.dirtyItemIndices.length>0&&this.uploadGeomItems(e),e.drawItemsTexture=this.glGeomItemsTexture}bind(e){if(this.dirtyIndices.size>0&&this.uploadMaterials(e),!this.materialsTexture)return;const t=e.unifs;return t.materialsTexture&&this.materialsTexture.bindToUniform(e,t.materialsTexture),!0}}class qr extends wi{constructor(e,t){super(),this.__gl=e,this.__geom=t,this.__glattrbuffers={},this.__shaderBindings={},this.buffersDirty=!0;this.__geom.on("geomDataChanged",(e=>{this.dirtyBuffers(e)}));this.__geom.on("geomDataTopologyChanged",(e=>{this.clearBuffers(),this.dirtyBuffers(e)}))}getGeom(){return this.__geom}dirtyBuffers(e){this.genBufferOpts=e,this.buffersDirty=!0,this.emit("updated")}genBuffers(e){}updateBuffers(e){this.genBuffers(e)}bind(e){if(this.__destroyed)throw new Error("Error binding a destroyed geom");this.buffersDirty&&this.updateBuffers();let t=this.__shaderBindings[e.shaderkey];if(!t){t=Mr(this.__gl,e.attrs,this.__glattrbuffers,this.__indexBuffer),this.__shaderBindings[e.shaderkey]=t}return t.bind(e),!0}unbind(e){const t=this.__shaderBindings[e.shaderkey];t&&t.unbind(e)}draw(){throw new Error("Not implemented. Implement this method in a derived class.")}drawInstanced(e){throw new Error("Not implemented. Implement this method in a derived class.")}bindAndDraw(e){this.bind(e),this.draw(e)}clearBuffers(){const e=this.__gl;for(const t in this.__glattrbuffers){const i=this.__glattrbuffers[t];i.shared||e.deleteBuffer(i.buffer)}this.__glattrbuffers={};for(const e in this.__shaderBindings){this.__shaderBindings[e].destroy()}this.__shaderBindings={}}destroy(){this.__geom.deleteMetadata("glgeom"),this.clearBuffers(),this.__destroyed=!0,this.emit("destructing",{})}}class $r extends qr{constructor(e,t){super(e,t),this.genBuffers()}genBuffers(e){super.genBuffers(e);const t=this.__gl,i=this.__geom.genBuffers();for(const e in i.attrBuffers){const s=i.attrBuffers[e],a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,s.values,t.STATIC_DRAW),this.__glattrbuffers[e]={buffer:a,dataType:s.dataType,normalized:s.normalized}}this.__numVertices=i.numVertices,this.__vboState=2}updateBuffers(e){const t=this.__gl,i=this.__geom.genBuffers(),s=i.numVertices!=this.__numVertices;for(const e in i.attrBuffers){const a=i.attrBuffers[e],r=this.__glattrbuffers[e];s&&(t.deleteBuffer(r.buffer),r.buffer=t.createBuffer()),t.bindBuffer(t.ARRAY_BUFFER,r.buffer),t.bufferData(t.ARRAY_BUFFER,a.values,t.STATIC_DRAW)}this.__numVertices=i.numVertices}bind(e){if(e.unifs.PointSize){const t=this.__gl;let i=this.__shaderBindings[e.shaderkey];if(!i){t.__quadVertexIdsBuffer||t.setupInstancedQuad();const s=Object.assign(this.__glattrbuffers,t.__quadattrbuffers);i=Mr(t,e.attrs,s,t.__quadIndexBuffer),this.__shaderBindings[e.shaderkey]=i}return i.bind(e),!0}return super.bind(e)}draw(e){const t=this.__gl;e.unifs.PointSize?t.drawElementsInstanced(t.TRIANGLES,6,t.UNSIGNED_SHORT,0,this.__numVertices):t.drawArrays(t.POINTS,0,this.__numVertices)}drawInstanced(e){this.__gl.drawArraysInstanced(this.__gl.POINTS,0,this.__numVertices,e)}}class en extends qr{constructor(e,t){super(e,t),this.__numSegIndices=0,this.__numVertices=0,this.__fatBuffersNeedUpload=!0}dirtyBuffers(e){super.dirtyBuffers(e),this.__fatBuffersNeedUpload=!0,this.emit("updated")}clearBuffers(){const e=this.__gl;e.deleteBuffer(this.__indexBuffer),this.__indexBuffer=null,this.fatBuffers&&this.fatBuffers.positionsTexture&&(this.fatBuffers.positionsTexture&&(this.fatBuffers.positionsTexture.destroy(),this.fatBuffers.positionsTexture=null),this.fatBuffers.glattrbuffers.segmentIndices.buffer&&(e.deleteBuffer(this.fatBuffers.glattrbuffers.segmentIndices.buffer),this.fatBuffers.glattrbuffers.segmentIndices=null)),super.clearBuffers()}genFatBuffers(e){const t=this.__gl,i=this.__geom.genBuffers(),s=i.indices,a=i.numVertices!=this.__numVertices;t.__quadVertexIdsBuffer||t.setupInstancedQuad(),this.fatBuffers||(this.fatBuffers={glattrbuffers:{}},this.fatBuffers.glattrbuffers.vertexIDs=t.__quadattrbuffers.vertexIDs);const r=e.boundTextures++;t.activeTexture(this.__gl.TEXTURE0+r),this.fatBuffers.drawCount=s.length/2;const n=this.__geom.getVertexAttributes(),o=n.positions,l=n.lineThickness,h=new Float32Array(4*o.length);for(let e=0;e<o.length;e++){di.createFromBuffer(h.buffer,4*e*4).setFromOther(o.getValueRef(e)),h[4*e+3]=l?l.getFloat32Value(e):1}a&&this.fatBuffers.positionsTexture&&(this.fatBuffers.positionsTexture.destroy(),this.fatBuffers.positionsTexture=null),this.fatBuffers.positionsTexture?this.fatBuffers.positionsTexture.bufferData(h,o.length,1):this.fatBuffers.positionsTexture=new pr(t,{format:"RGBA",type:"FLOAT",width:o.length,height:1,filter:"NEAREST",wrap:"CLAMP_TO_EDGE",data:h,mipMapped:!1});const d=()=>{const e=new Float32Array(s.length);for(let t=0;t<s.length;t++){let i;i=t%2==0?t>0?s[t]==s[t-1]:s[t]==s[s.length-1]:t<s.length-1?s[t]==s[t+1]:s[t]==s[0],e[t]=(i?1:0)+2*s[t]}return e};if(this.fatBuffers.glattrbuffers.segmentIndices)(!this.genBufferOpts||this.genBufferOpts&&this.genBufferOpts.topologyChanged)&&(t.bindBuffer(t.ARRAY_BUFFER,this.fatBuffers.glattrbuffers.segmentIndices.buffer),t.bufferData(t.ARRAY_BUFFER,d(),t.STATIC_DRAW));else{const e=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,d(),t.STATIC_DRAW),this.fatBuffers.glattrbuffers.segmentIndices={buffer:e,dimension:2,dataType:hi}}this.__numSegIndices=s.length,this.__numVertices=i.numVertices,t.bindTexture(t.TEXTURE_2D,null),e.boundTextures--,this.__fatBuffersNeedUpload=!1}genBuffers(e){const t=this.__gl,i=this.__geom.genBuffers(),s=i.indices,a=i.numVertices!=this.__numVertices;this.__indexBuffer?(!this.genBufferOpts||this.genBufferOpts&&this.genBufferOpts.topologyChanged)&&(this.__numSegIndices!=s.length&&(t.deleteBuffer(this.__indexBuffer),this.__indexBuffer=t.createBuffer()),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,s,t.STATIC_DRAW),this.__numSegIndices=s.length):(this.__indexBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,s,t.STATIC_DRAW));for(const e in i.attrBuffers){const s=i.attrBuffers[e];if(this.__glattrbuffers[e]){const i=this.__glattrbuffers[e];a&&(t.deleteBuffer(i.buffer),i.buffer=t.createBuffer()),t.bindBuffer(t.ARRAY_BUFFER,i.buffer),t.bufferData(t.ARRAY_BUFFER,s.values,t.STATIC_DRAW)}else{const i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,s.values,t.STATIC_DRAW),this.__glattrbuffers[e]={buffer:i,dataType:s.dataType,normalized:s.normalized}}}this.__numSegIndices=s.length,this.__numVertices=i.numVertices,this.__buffersNeedUpload=!1,s instanceof Uint8Array&&(this.__indexDataType=this.__gl.UNSIGNED_BYTE),s instanceof Uint16Array&&(this.__indexDataType=this.__gl.UNSIGNED_SHORT),s instanceof Uint32Array&&(this.__indexDataType=this.__gl.UNSIGNED_INT)}bind(e){const t=this.__gl,i=e.unifs;if(i.LineThickness&&t.floatTexturesSupported){this.__fatBuffersNeedUpload&&this.genFatBuffers(e,!0);let s=this.__shaderBindings[e.shaderkey];return s||(s=Mr(t,e.attrs,this.fatBuffers.glattrbuffers,t.__quadIndexBuffer),this.__shaderBindings[e.shaderkey]=s),s.bind(e),i.positionsTexture&&(this.fatBuffers.positionsTexture.bindToUniform(e,i.positionsTexture),t.uniform1i(i.positionsTextureSize.location,this.fatBuffers.positionsTexture.width)),!0}return super.bind(e)}drawPoints(){this.__gl.drawArrays(this.__gl.POINTS,0,this.__geom.numVertices())}draw(e){const t=this.__gl;e.unifs.LineThickness&&t.floatTexturesSupported?t.drawElementsInstanced(t.TRIANGLES,6,t.UNSIGNED_SHORT,0,this.fatBuffers.drawCount):t.drawElements(this.__gl.LINES,this.__numSegIndices,this.__indexDataType,0)}drawInstanced(e){this.__gl.drawElementsInstanced(this.__gl.LINES,this.__numSegIndices,this.__indexDataType,0,e)}}class tn extends qr{constructor(e,t){super(e,t)}getNumTriangles(){return this.__numTriangles}genBuffers(){super.genBuffers();const e=this.__gl,t=this.__geom.genBuffers(),i=t.indices;this.__numTriIndices=t.indices.length,i instanceof Uint8Array&&(this.__indexDataType=this.__gl.UNSIGNED_BYTE),i instanceof Uint16Array&&(this.__indexDataType=this.__gl.UNSIGNED_SHORT),i instanceof Uint32Array&&(this.__indexDataType=this.__gl.UNSIGNED_INT),this.__numVertices=this.__geom.getNumVertices(),this.__numTriangles=i.length/3,this.__numRenderVerts=t.numRenderVerts,this.__indexBuffer&&e.deleteBuffer(this.__indexBuffer),this.__indexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,t.indices,e.STATIC_DRAW);for(const i in t.attrBuffers){const s=t.attrBuffers[i];this.__glattrbuffers[i]&&this.__glattrbuffers[i].buffer&&e.deleteBuffer(this.__glattrbuffers[i].buffer);const a=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,s.values,e.STATIC_DRAW),this.__glattrbuffers[i]={buffer:a,dataType:s.dataType,normalized:s.normalized},"textureCoords"==i&&(this.__glattrbuffers.texCoords=this.__glattrbuffers.textureCoords)}}updateBuffers(e){const t=this.__gl;if(this.__numVertices!=this.__geom.getNumVertices())return void this.genBuffers();const i=this.__geom.genBuffers({includeIndices:!1});for(const e in i.attrBuffers){const s=i.attrBuffers[e],a=this.__glattrbuffers[e];t.bindBuffer(t.ARRAY_BUFFER,a.buffer),t.bufferData(t.ARRAY_BUFFER,s.values,t.STATIC_DRAW)}}clearBuffers(){this.__gl.deleteBuffer(this.__indexBuffer),this.__indexBuffer=null,super.clearBuffers()}generateWireframesVAO(){if(!this.__vao)return!1;this.__geom.edgeVerts||this.__geom.genTopologyInfo(),this.__wireframesVao&&this.__ext.deleteVertexArrayOES(this.__wireframesVao),this.__wireframesVao=this.__ext.createVertexArrayOES(),this.__ext.bindVertexArrayOES(this.__wireframesVao);const e=this.__gl,t=e.createBuffer(),i=Uint32Array.from(this.__geom.edgeVerts);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t),e.bufferData(e.ELEMENT_ARRAY_BUFFER,i,e.STATIC_DRAW);const s=this.__glattrbuffers.positions.buffer;e.enableVertexAttribArray(0),e.bindBuffer(e.ARRAY_BUFFER,s),e.vertexAttribPointer(0,3,e.FLOAT,!1,12,0),this.__numWireIndices=i.length,this.__ext.bindVertexArrayOES(null)}bindWireframeVAO(e){return null!=this.__wireframesVao&&(this.__ext.bindVertexArrayOES(this.__wireframesVao),!0)}unbindWireframeVAO(){this.__ext.bindVertexArrayOES(null)}drawWireframe(){this.__wireframesVao&&this.__gl.drawElements(this.__gl.LINES,this.__numWireIndices,this.__gl.UNSIGNED_INT,0)}generateHardEdgesVAO(){if(!this.__vao)return!1;this.__hardEdgesVao&&this.__ext.deleteVertexArrayOES(this.__hardEdgesVao),this.__hardEdgesVao=this.__ext.createVertexArrayOES(),this.__ext.bindVertexArrayOES(this.__hardEdgesVao);const e=this.__gl,t=e.createBuffer(),i=this.__geom.computeHardEdgesIndices();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t),e.bufferData(e.ELEMENT_ARRAY_BUFFER,i,e.STATIC_DRAW);const s=this.__glattrbuffers.positions.buffer;e.enableVertexAttribArray(0),e.bindBuffer(e.ARRAY_BUFFER,s),e.vertexAttribPointer(0,3,e.FLOAT,!1,12,0),this.__numEdgeIndices=i.length,this.__ext.bindVertexArrayOES(null)}bindHardEdgesVAO(e){return null!=this.__hardEdgesVao&&(this.__ext.bindVertexArrayOES(this.__hardEdgesVao),!0)}unbindHardEdgesVAO(){this.__ext.bindVertexArrayOES(null)}drawHardEdges(){this.__hardEdgesVao&&this.__gl.drawElements(this.__gl.LINES,this.__numEdgeIndices,this.__gl.UNSIGNED_INT,0)}drawPoints(){this.__gl.drawArrays(this.__gl.POINTS,0,this.__geom.numVertices())}draw(){this.__gl.drawElements(this.__gl.TRIANGLES,this.__numTriIndices,this.__indexDataType,0)}drawInstanced(e){this.__gl.drawElementsInstanced(this.__gl.TRIANGLES,this.__numTriIndices,this.__indexDataType,0,e)}destroy(){super.destroy();this.__gl.deleteBuffer(this.__indexBuffer),this.__indexBuffer=void 0}}const sn={GEOMITEM_CHANGED:0,GEOM_CHANGED:1,VISIBILITY_CHANGED:2,HIGHLIGHT_CHANGED:3};class an extends Jt{constructor(e,t,i,s,a,r=!1){if(super(),this.gl=e,this.geomItem=t,this.drawItemId=i,this.geomId=s,this.materialId=a,this.supportInstancing=r,this.geomVisible=this.geomItem.isVisible(),this.visible=this.geomVisible,this.culled=!1,this.updateVisibility=this.updateVisibility.bind(this),this.geomItem.on("visibilityChanged",this.updateVisibility),!this.supportInstancing){this.cutDataChanged=!1,this.cutData=[0,0,0,0];const e=0;let t=0;if(this.geomItem.isCutawayEnabled()){t|=1}this.geomData=[t,e,0,0],this.geomMatrixDirty=!0,this.geomItem.getParameter("GeomMat").on("valueChanged",(()=>{this.geomMatrixDirty=!0,this.emit("updated")})),this.geomItem.on("cutAwayChanged",(()=>{this.cutDataChanged=!0,this.emit("updated")}))}}getGeomItem(){return this.geomItem}isVisible(){return this.visible}getDrawItemId(){return this.drawItemId}updateVisibility(){this.geomVisible=this.geomItem.isVisible();const e=this.geomVisible&&!this.culled;this.visible!=e&&(this.visible=e,this.emit("visibilityChanged",{visible:e}),this.emit("updated",{}))}setCulled(e){this.culled=e;const t=this.geomVisible&&!this.culled;this.visible!=t&&(this.visible=t,this.emit("visibilityChanged",{visible:t}))}bind(e){const t=this.gl,i=e.unifs;if(!this.supportInstancing){const e=i.modelMatrix;e&&(this.geomMatrixDirty&&(this.modelMatrixArray=this.geomItem.getGeomMat4().asArray()),t.uniformMatrix4fv(e.location,!1,this.modelMatrixArray));const s=i.drawItemData;s&&t.uniform4fv(s.location,this.geomData);const a=i.cutawayData;if(a){if(this.cutDataChanged&&this.geomItem.isCutawayEnabled()){const e=this.geomItem.getCutVector(),t=this.geomItem.getCutDist();this.cutData=[e.x,e.y,e.z,t]}t.uniform4fv(a.location,this.cutData)}}const s=i.transformIndex;return s&&t.uniform1i(s.location,this.drawItemId),!0}destroy(){this.geomItem.off("visibilityChanged",this.updateVisibility),this.supportInstancing||(this.geomItem.getParameter("GeomMat").off("valueChanged",this.geomMatrixChanged),this.geomItem.off("cutAwayChanged",this.cutAwayChanged),this.geomItem.off("highlightChanged",this.highlightChanged))}}class rn extends Jt{constructor(e,t){super(),this.gl=e,this.glGeom=t,this.id=t?t.getGeom().getId():this.getId(),this.glGeomItems=[],this.glgeomItems_freeIndices=[],this.glgeomItemEventHandlers=[],this.drawIdsArray=null,this.drawIdsBuffer=null,this.drawIdsBufferDirty=!0,this.highlightedIdsArray=null,this.highlightedIdsBuffer=null,this.highlightedIdsBufferDirty=!0,this.visibleItems=[],this.highlightedItems=[]}getGLGeom(){return this.glGeom}getDrawCount(){return this.visibleItems.length}addGLGeomItem(e){let t;this.glgeomItems_freeIndices.length>0?t=this.glgeomItems_freeIndices.pop():(t=this.glGeomItems.length,this.glGeomItems.push(null)),e.geomItem.isVisible()&&(this.visibleItems.push(t),this.emit("drawCountChanged",{change:1,count:this.visibleItems.length})),e.geomItem.isHighlighted()&&(this.highlightedItems.push(t),this.highlightedIdsBufferDirty=!0);const i={};i.highlightChanged=i=>{if(e.geomItem.isHighlighted()){if(this.highlightedItems.includes(t))return;this.highlightedItems.push(t),this.emit("highlightedCountChanged",{change:1,count:this.highlightedItems.length})}else this.highlightedItems.splice(this.highlightedItems.indexOf(t),1),this.emit("highlightedCountChanged",{change:-1,count:this.highlightedItems.length});this.highlightedIdsBufferDirty=!0},e.geomItem.on("highlightChanged",i.highlightChanged),i.visibilityChanged=e=>{e.visible?(this.visibleItems.push(t),this.emit("drawCountChanged",{change:1,count:this.visibleItems.length})):(this.visibleItems.splice(this.visibleItems.indexOf(t),1),this.emit("drawCountChanged",{change:-1,count:this.visibleItems.length})),this.drawIdsBufferDirty=!0},e.geomItem.on("visibilityChanged",i.visibilityChanged),this.glGeomItems[t]=e,this.glgeomItemEventHandlers[t]=i,e.geomItem.setMetadata("geomItemSet",this),this.drawIdsBufferDirty=!0}removeGLGeomItem(e){const t=this.glGeomItems.indexOf(e),i=this.glgeomItemEventHandlers[t];e.geomItem.off("highlightChanged",i.highlightChanged),e.geomItem.off("visibilityChanged",i.visibilityChanged),this.glGeomItems[t]=null,this.glgeomItemEventHandlers[t]=null,this.glgeomItems_freeIndices.push(t),e.geomItem.isVisible()&&(this.visibleItems.splice(this.visibleItems.indexOf(t),1),this.emit("drawCountChanged",{change:-1,count:this.visibleItems.length})),e.geomItem.isHighlighted()&&(this.highlightedItems.splice(this.highlightedItems.indexOf(t),1),this.emit("highlightedCountChanged",{change:-1,count:this.highlightedItems.length})),this.drawIdsBufferDirty=!0,this.glGeomItems.length==this.glgeomItems_freeIndices.length&&this.destroy()}updateDrawIDsBuffer(){const e=this.gl;e.floatTexturesSupported?(this.drawIdsBuffer&&this.glGeomItems.length!=this.drawIdsArray.length&&(this.gl.deleteBuffer(this.drawIdsBuffer),this.drawIdsBuffer=null),this.drawIdsBuffer||(this.drawIdsBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.drawIdsBuffer)),e.bindBuffer(e.ARRAY_BUFFER,this.drawIdsBuffer),e.bufferData(e.ARRAY_BUFFER,this.getDrawIdsArray(),e.STATIC_DRAW),this.drawIdsBufferDirty=!1):this.drawIdsBufferDirty=!1}getDrawIdsArray(){return this.drawIdsBufferDirty&&(this.drawIdsArray&&this.glGeomItems.length==this.drawIdsArray.length||(this.drawIdsArray=new Float32Array(this.glGeomItems.length)),this.visibleItems.forEach(((e,t)=>{this.drawIdsArray[t]=this.glGeomItems[e].getDrawItemId()})),this.drawIdsBufferDirty=!1),this.drawIdsArray}updateHighlightedIDsBuffer(){const e=this.gl;e.floatTexturesSupported?(this.highlightedIdsBuffer&&this.glGeomItems.length>this.highlightedIdsArray.length&&(this.gl.deleteBuffer(this.highlightedIdsBuffer),this.highlightedIdsBuffer=null),this.highlightedIdsBuffer||(this.highlightedIdsBuffer=e.createBuffer()),e.bindBuffer(e.ARRAY_BUFFER,this.highlightedIdsBuffer),e.bufferData(e.ARRAY_BUFFER,this.getHighlightedIdsArray(),e.STATIC_DRAW),this.highlightedIdsBufferDirty=!1):this.highlightedIdsBufferDirty=!1}getHighlightedIdsArray(){return this.highlightedIdsBufferDirty&&((!this.highlightedIdsArray||this.highlightedItems.length>this.highlightedIdsArray.length)&&(this.highlightedIdsArray=new Float32Array(this.glGeomItems.length)),this.highlightedItems.forEach(((e,t)=>{this.highlightedIdsArray[t]=this.glGeomItems[e].getDrawItemId()})),this.highlightedIdsBufferDirty=!1),this.highlightedIdsArray}draw(e){0!=this.visibleItems.length&&(this.drawIdsBufferDirty&&this.updateDrawIDsBuffer(),this.__bindAndRender(e,this.visibleItems,this.drawIdsBuffer))}drawHighlighted(e){0!=this.highlightedItems.length&&(this.highlightedIdsBufferDirty&&this.updateHighlightedIDsBuffer(),this.__bindAndRender(e,this.highlightedItems,this.highlightedIdsBuffer))}__bindAndRender(e,t,i){const s=this.gl,a=e.unifs;if(e.glGeom!=this.glGeom&&(this.glGeom.bind(e),e.glGeom=this.glGeom),s.floatTexturesSupported&&s.drawElementsInstanced&&e.supportsInstancing){e.unifs.instancedDraw&&s.uniform1i(e.unifs.instancedDraw.location,1);const r=e.attrs.instancedIds.location;s.enableVertexAttribArray(r),s.bindBuffer(s.ARRAY_BUFFER,i),s.vertexAttribPointer(r,1,s.FLOAT,!1,4,0),s.vertexAttribDivisor(r,1),e.bindViewports(a,(()=>{this.glGeom.drawInstanced(t.length)}))}else e.unifs.instancedDraw&&s.uniform1i(e.unifs.instancedDraw.location,0),t.forEach((t=>{this.glGeomItems[t].bind(e),e.bindViewports(a,(()=>{this.glGeom.draw(e)}))}))}destroy(){this.drawIdsBuffer&&(this.gl.deleteBuffer(this.drawIdsBuffer),this.drawIdsBuffer=null),this.highlightedIdsBuffer&&(this.gl.deleteBuffer(this.highlightedIdsBuffer),this.highlightedIdsBuffer=null),this.emit("destructing")}}class nn extends Jt{constructor(e,t){super(),this.pass=e,this.__gl=e.__gl,this.glMaterial=t,this.glGeomItemSets={},this.drawCount=0,this.visibleInGeomDataBuffer=t.getMaterial().visibleInGeomDataBuffer,this.drawCountChanged=this.drawCountChanged.bind(this);const i=t.getMaterial(),s=e=>{i.off("transparencyChanged",s);for(const e in this.glGeomItemSets){const t=this.glGeomItemSets[e];for(const e of t.glGeomItems){const t=e.geomItem;this.pass.removeGeomItem(t),this.pass.__renderer.assignTreeItemToGLPass(t)}}};i.on("transparencyChanged",s)}getGLMaterial(){return this.glMaterial}addGLGeomItem(e,t){const i=t.getGeom().getId();let s=this.glGeomItemSets[i];s||(s=new rn(this.__gl,t),this.addGeomItemSet(s)),s.addGLGeomItem(e)}drawCountChanged(e){this.drawCount+=e.change,this.emit("updated")}__materialChanged(){const e=this.glMaterial.getMaterial();if(!this.pass.checkMaterial(e))for(const e in this.glGeomItemSets){const t=this.glGeomItemSets[e];for(const e of t.glGeomItems){const t=e.geomItem;this.pass.removeGeomItem(t),this.pass.__renderer.assignTreeItemToGLPass(t)}}}addGeomItemSet(e){const t=e.getGLGeom().getGeom().getId();this.glGeomItemSets[t]=e,e.on("drawCountChanged",this.drawCountChanged),e.on("destructing",(()=>{e.off("drawCountChanged",this.drawCountChanged),delete this.glGeomItemSets[t],0==Object.keys(this.glGeomItemSets).length&&this.emit("destructing")}))}draw(e){if(0==this.drawCount)return;this.glMaterial.bind(e,!0);for(const t in this.glGeomItemSets){this.glGeomItemSets[t].draw(e)}}drawHighlighted(e){this.glMaterial.bind(e,!1);for(const t in this.glGeomItemSets){this.glGeomItemSets[t].drawHighlighted(e)}}drawGeomData(e){this.glMaterial.bind(e,!1);for(const t in this.glGeomItemSets){this.glGeomItemSets[t].draw(e)}}}class on extends Jt{constructor(e,t,i){super(),this.gl=e,this.pass=t,this.glShader=i.glShader,this.glgeomdatashader=i.glgeomdatashader,this.glselectedshader=i.glselectedshader,this.glMaterialGeomItemSets=[]}findMaterialGeomItemSets(e){for(const t of this.glMaterialGeomItemSets)if(t.glMaterial==e)return t}addGLGeomItem(e,t,i){let s=this.findMaterialGeomItemSets(i);s||(s=new nn(this.pass,i),this.addMaterialGeomItemSets(s)),s.addGLGeomItem(e,t)}addMaterialGeomItemSets(e){this.glMaterialGeomItemSets.push(e);const t=()=>{this.emit("updated")},i=()=>{e.off("updated",t),e.off("destructing",i);const s=this.glMaterialGeomItemSets.indexOf(e);this.glMaterialGeomItemSets.splice(s,1),0==this.glMaterialGeomItemSets.length&&this.emit("destructing")};e.on("updated",t),e.on("destructing",i)}removeMaterialGeomItemSets(e){const t=this.glMaterialGeomItemSets.indexOf(e);this.glMaterialGeomItemSets.splice(t,1)}getMaterialGeomItemSets(){return this.glMaterialGeomItemSets}draw(e){const t=this.glShader;if(this.glShader.bind(e)){this.pass.renderer.glGeomItemLibrary.bind(e);for(const t of this.glMaterialGeomItemSets)t.draw(e);t.unbind(e)}}drawHighlightedGeoms(e){if(this.glselectedshader&&this.glselectedshader.bind(e)){this.pass.renderer.glGeomItemLibrary.bind(e);for(const t of this.glMaterialGeomItemSets)t.drawHighlighted(e)}}drawGeomData(e){if(!this.glgeomdatashader||!this.glgeomdatashader.bind(e))return;this.pass.renderer.glGeomItemLibrary.bind(e);const t=this.gl;{const i=e.unifs.floatGeomBuffer;i&&t.uniform1i(i.location,t.floatGeomBuffer?1:0)}{const i=e.unifs.passId;i&&t.uniform1i(i.location,e.passIndex)}for(const t of this.glMaterialGeomItemSets)t.drawGeomData(e)}}const ln=(e,t)=>{const i=new Int32Array(t);return i.set(e),i};class hn extends Jt{constructor(e){super(),this.renderer=e,this.__gl=e.gl,this.shaderAttrSpec={},this.freeGeomIndices=[],this.geoms=[],this.geomRefCounts=[],this.geomsDict={},this.glGeomsDict={},this.geomBuffersTmp=[],this.glattrbuffers={},this.shaderBindings={},this.bufferNeedsRealloc=!1,this.attributesAllocator=new $t,this.dirtyGeomIndices=new Set,this.attributesAllocator.on("resized",(()=>{this.bufferNeedsRealloc=!0})),this.attributesAllocator.on("dataReallocated",(e=>{const t=e.id,i=e.allocation;this.dirtyGeomIndices.add(t),this.geomVertexOffsets[t]=i.start,this.geomVertexCounts[t]=i.size})),this.geomVertexCounts=new Int32Array(0),this.geomVertexOffsets=new Int32Array(0),this.numIndices=0,this.indicesAllocator=new $t,this.indicesCounts=new Int32Array(0),this.indicesOffsets=new Int32Array(0),this.indicesAllocator.on("resized",(()=>{this.bufferNeedsRealloc=!0})),this.indicesAllocator.on("dataReallocated",(e=>{const t=e.id;this.dirtyGeomIndices.add(t)}))}constructGLGeom(e){let t=this.glGeomsDict[e.getId()];if(null!=t)return t;const i=this.__gl;if(e instanceof Ms||e instanceof Zs)t=new tn(i,e);else if(e instanceof ws||e instanceof Ss)t=new en(i,e);else{if(!(e instanceof Rs||e instanceof Ls))throw new Error("Unsupported geom type:"+e.constructor.name);t=new $r(i,e)}return this.glGeomsDict[e.getId()]=t,t.on("updated",(()=>{this.renderer.requestRedraw()})),t.addRef(this),t}addGeom(e){let t=this.geomsDict[e.getId()];if(null!=t)return this.geomRefCounts[t]++,t;this.freeGeomIndices.length?t=this.freeGeomIndices.pop():(t=this.geoms.length,this.geomRefCounts[t]=0,this.geomVertexCounts=ln(this.geomVertexCounts,t+1),this.geomVertexOffsets=ln(this.geomVertexOffsets,t+1)),this.geomVertexCounts[t]=0,this.geomVertexOffsets[t]=0;return e.on("geomDataChanged",(()=>{this.dirtyGeomIndices.add(t),this.emit("updated")})),e.on("geomDataTopologyChanged",(()=>{this.dirtyGeomIndices.add(t),this.emit("updated")})),this.geoms[t]=e,this.geomRefCounts[t]++,this.geomsDict[e.getId()]=t,this.dirtyGeomIndices.add(t),t==this.indicesCounts.length&&(this.indicesCounts=ln(this.indicesCounts,this.indicesCounts.length+1),this.indicesOffsets=ln(this.indicesOffsets,this.indicesOffsets.length+1)),this.indicesCounts[t]=0,this.indicesOffsets[t]=0,t}removeGeom(e){const t=this.geomsDict[e.getId()];this.geomRefCounts[t]--,this.geomRefCounts[t]>0||(this.attributesAllocator.getAllocation(t)&&this.attributesAllocator.deallocate(t),this.indicesAllocator.getAllocation(t)&&this.indicesAllocator.deallocate(t),this.dirtyGeomIndices.has(t)&&this.dirtyGeomIndices.delete(t),this.geomVertexCounts[t]=0,this.geomVertexOffsets[t]=0,this.geoms[t]=null,this.freeGeomIndices.push(t),delete this.geomsDict[e.getId()],delete this.geomBuffersTmp[t],this.indicesCounts[t]=0,this.indicesOffsets[t]=0)}getGeom(e){return this.geoms[e]}getGeomOffsetAndCount(e){return[this.indicesOffsets[e],this.indicesCounts[e]]}allocateBuffers(e){const t=this.geoms[e];if(!t)return;const i=t.genBuffers(),s=i.numRenderVerts?i.numRenderVerts:i.numVertices;if(this.geomVertexCounts[e]!=s)if(0==s)this.attributesAllocator.deallocate(e),this.geomVertexOffsets[e]=0,this.geomVertexCounts[e]=0;else{const t=this.attributesAllocator.allocate(e,s);this.geomVertexOffsets[e]=t.start,this.geomVertexCounts[e]=t.size}for(const e in i.attrBuffers)if(!this.shaderAttrSpec[e]){const t=i.attrBuffers[e],s=vr(this.__gl,t.dataType);this.shaderAttrSpec[e]={dataType:t.dataType,normalized:t.normalized,dimension:s.dimension,elementSize:s.elementSize}}if(i.indices){const t=i.indices.length;if(this.indicesCounts[e]!=t)if(0==t)this.indicesAllocator.deallocate(e),this.indicesOffsets[e]=0,this.indicesCounts[e]=0;else{const i=this.indicesAllocator.allocate(e,t),s=4;this.indicesOffsets[e]=i.start*s,this.indicesCounts[e]=i.size}}else this.indicesOffsets[e]=this.geomVertexOffsets[e],this.indicesCounts[e]=this.geomVertexCounts[e];this.geomBuffersTmp[e]=i}genBuffers(){const e=this.attributesAllocator.reservedSpace,t=this.__gl;for(const i in this.shaderAttrSpec){const s=this.shaderAttrSpec[i],a=e*s.dimension;s.numValues=a,this.glattrbuffers[i]&&this.glattrbuffers[i].buffer&&t.deleteBuffer(this.glattrbuffers[i].buffer);const r=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,r);const n=a*s.elementSize;t.bufferData(t.ARRAY_BUFFER,n,t.STATIC_DRAW),this.glattrbuffers[i]={buffer:r,dataType:s.dataType,normalized:s.normalized,length:a,dimension:s.dimension},"textureCoords"==i&&(this.glattrbuffers.texCoords=this.glattrbuffers.textureCoords)}const i=this.indicesAllocator.reservedSpace;if(this.numIndices!=i){const e=this.__gl;this.indexBuffer&&e.deleteBuffer(this.indexBuffer),this.indexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer);const t=this.indicesAllocator.reservedSpace,i=t*4;e.bufferData(e.ELEMENT_ARRAY_BUFFER,i,e.STATIC_DRAW),this.numIndices=t}}uploadBuffers(e){const t=this.__gl;let i=this.geomBuffersTmp[e];if(!i){const t=this.geoms[e];if(!t)return;i=t.genBuffers(),this.geomBuffersTmp[e]=i}const s=this.geomVertexCounts[e],a=i.numRenderVerts?i.numRenderVerts:i.numVertices;if(s!=a)throw new Error("Invalid allocation for this geom");if(0!=a){for(const s in i.attrBuffers){const a=this.shaderAttrSpec[s],r=i.attrBuffers[s],n=this.glattrbuffers[s];if(!r||!n)continue;t.bindBuffer(t.ARRAY_BUFFER,n.buffer);const o=a.elementSize,l=this.geomVertexOffsets[e]*o*a.dimension;t.bufferSubData(t.ARRAY_BUFFER,l,r.values,0)}if(t.bindBuffer(t.ARRAY_BUFFER,null),i.indices&&i.indices.length>0){const t=i.indices,s=this.indicesAllocator.getAllocation(e);if(s.size!=t.length)throw new Error("Invalid allocation for this geom");const a=this.attributesAllocator.getAllocation(e),r=new Uint32Array(s.size);for(let e=0;e<t.length;e++)r[e]=i.indices[e]+a.start;const n=this.__gl;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.indexBuffer);const o=4,l=s.start*o;n.bufferSubData(n.ELEMENT_ARRAY_BUFFER,l,r,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null)}this.emit("geomDataChanged",{index:e})}else this.emit("geomDataChanged",{index:e})}cleanGeomBuffers(){if(new Set(this.dirtyGeomIndices).forEach((e=>{this.allocateBuffers(e)})),this.bufferNeedsRealloc){for(const e in this.shaderBindings){this.shaderBindings[e].destroy()}this.shaderBindings={};for(let e=0;e<this.geoms.length;e++)this.geoms[e]&&this.dirtyGeomIndices.add(e);this.genBuffers(),this.bufferNeedsRealloc=!1}this.dirtyGeomIndices.forEach((e=>{this.uploadBuffers(e)})),this.dirtyGeomIndices=new Set,this.geomBuffersTmp=[];for(const e in this.shaderBindings){this.shaderBindings[e].destroy()}this.shaderBindings={}}bind(e){this.dirtyGeomIndices.size>0&&this.cleanGeomBuffers();let t=this.shaderBindings[e.shaderkey];if(t)t.bind(e);else{t=Mr(this.__gl,e.attrs,this.glattrbuffers,this.indexBuffer),this.shaderBindings[e.shaderkey]=t}return!0}unbind(e){const t=this.shaderBindings[e.shaderkey];t&&t.unbind(e)}clearBuffers(){const e=this.__gl;for(const t in this.glattrbuffers){const i=this.glattrbuffers[t];i.shared||e.deleteBuffer(i.buffer)}this.glattrbuffers={},this.indexBuffer&&(e.deleteBuffer(this.indexBuffer),this.indexBuffer=null);for(const e in this.shaderBindings){this.shaderBindings[e].destroy()}this.shaderBindings={}}destroy(){this.clearBuffers(),this.__destroyed=!0,this.emit("destructing",{})}}var dn=Ca("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwp2YXIgd29ya2VyX2NvZGU9ZnVuY3Rpb24oZSl7InVzZSBzdHJpY3QiO2NvbnN0IHQ9KGUsdCk9PltlWzBdKnQsZVsxXSp0XSxhPWU9Pk1hdGguc3FydChlWzBdKmVbMF0rZVsxXSplWzFdKSxzPWU9PlstZVswXSwtZVsxXSwtZVsyXSxlWzNdXSxuPShlLHQpPT57Y29uc3QgYT1lWzBdLHM9ZVsxXSxuPWVbMl0saT1lWzNdLHI9dFswXSxvPXRbMV0sbD10WzJdLGg9dFszXTtyZXR1cm5bYSpoK2kqcitzKmwtbipvLHMqaCtpKm8rbipyLWEqbCxuKmgraSpsK2Eqby1zKnIsaSpoLWEqci1zKm8tbipsXX0saT1bXSxyPVtdO2xldCBvLGwsaCx1LGQ9W10sYz1bXTtjb25zdCBNPWU9PntyW2VdfHwocltlXT0hMCxkLnB1c2goZSkpfSxmPWU9PntyW2VdJiYocltlXT0hMSxjLnB1c2goZSkpfSxwPWU9PntpZighZXx8IW8pcmV0dXJuO2lmKCFlLmN1bGxhYmxlKXJldHVybiB2b2lkIGYoZS5pZCk7Y29uc3QgaT1lLnBvcyxyPWUuYm91bmRpbmdSYWRpdXMsZD0ocD1vLFsoYz1pKVswXS1wWzBdLGNbMV0tcFsxXSxjWzJdLXBbMl1dKTt2YXIgYyxwO2NvbnN0IGc9KGU9Pk1hdGguc3FydChlWzBdKmVbMF0rZVsxXSplWzFdK2VbMl0qZVsyXSkpKGQpO2lmKGc8cilyZXR1cm4gdm9pZCBmKGUuaWQpO2lmKE1hdGguYXNpbihyL2cpPC4wMDQpcmV0dXJuIHZvaWQgTShlLmlkKTtjb25zdCBtPSgoZSx0KT0+e2NvbnN0IGE9W3RbMF0sdFsxXSx0WzJdLDBdLGk9bihuKGUsYSkscyhlKSk7cmV0dXJuW2lbMF0saVsxXSxpWzJdXX0pKGwsZCksdj1bbVswXSxtWzJdXSx5PVttWzFdLG1bMl1dLGI9YSh2KSx3PWEoeSksST1NYXRoLmFzaW4oci9iKSxDPU1hdGguYXNpbihyL3cpLEU9dCh2LDEvYiksUD10KHksMS93KTtsZXQgXztfPW1bMl0+MD9bTWF0aC5QSS1NYXRoLmFicyhNYXRoLmFzaW4oRVswXSkpLUksTWF0aC5QSS1NYXRoLmFicyhNYXRoLmFzaW4oUFswXSkpLUNdOltNYXRoLmFicyhNYXRoLmFzaW4oRVswXSkpLUksTWF0aC5hYnMoTWF0aC5hc2luKFBbMF0pKS1DXSxfWzBdPmh8fF9bMV0+dT9NKGUuaWQpOmYoZS5pZCl9LGc9ZT0+e2QubGVuZ3RoPjB8fGMubGVuZ3RoPjA/KGUoe3R5cGU6IkN1bGxSZXN1bHRzIixuZXdseUN1bGxlZDpkLG5ld2x5VW5DdWxsZWQ6Y30pLGQ9W10sYz1bXSk6ZSh7dHlwZToiRG9uZSJ9KX0sbT0oZSx0KT0+eyJWaWV3cG9ydENoYW5nZWQiPT1lLnR5cGU/KChlLHQpPT57aD1lLmZydXN0dW1IYWxmQW5nbGVYLHU9ZS5mcnVzdHVtSGFsZkFuZ2xlWSxvJiZsJiYoaS5mb3JFYWNoKHApLGcodCkpfSkoZSx0KToiVmlld0NoYW5nZWQiPT1lLnR5cGU/KChlLHQpPT57bz1lLnZpZXdQb3MsbD1zKGUudmlld09yaSksaS5mb3JFYWNoKHApLGcodCl9KShlLHQpOiJVcGRhdGVHZW9tSXRlbXMiPT1lLnR5cGUmJihlLmdlb21JdGVtcy5mb3JFYWNoKChlPT57aVtlLmlkXT1lLHAoaVtlLmlkXSl9KSksZS5yZW1vdmVkSXRlbUluZGljZXMuZm9yRWFjaCgoZT0+e2lbZV09bnVsbH0pKSxnKHQpKX07cmV0dXJuIHNlbGYub25tZXNzYWdlPWZ1bmN0aW9uKGUpe20oZS5kYXRhLHNlbGYucG9zdE1lc3NhZ2UpfSxlLmhhbmRsZU1lc3NhZ2U9bSxPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwiX19lc01vZHVsZSIse3ZhbHVlOiEwfSksZX0oe30pOwoK",null,!1);class cn extends Jt{constructor(e){super(),this.renderer=e,this.glGeomItems=[void 0],this.glGeomItemEventHandlers=[void 0],this.glGeomItemsMap={},this.glGeomItemsIndexFreeList=[],this.dirtyItemIndices=[],this.removedItemIndices=[],this.worker=new dn;let t=!0;this.worker.onmessage=e=>{"CullResults"==e.data.type?this.applyCullResults(e.data):"Done"==e.data.type&&this.renderer.emit("CullingUpdated"),t=!0};const i=()=>{const t=e.getWidth()/e.getHeight(),i=.5*e.getViewport().getCamera().getFov(),s=Math.atan(Math.tan(i)*t);this.worker.postMessage({type:"ViewportChanged",frustumHalfAngleX:s,frustumHalfAngleY:i})};e.on("resized",i),i(),e.once("xrViewportSetup",(e=>{e.xrViewport.on("presentingChanged",(e=>{if(e.state){const e=Math.PI/180,t=62*e,i=50*e;this.worker.postMessage({type:"ViewportChanged",frustumHalfAngleX:i,frustumHalfAngleY:t})}}))}));let s=0;e.on("viewChanged",(e=>{if(t){if(s%5==0){t=!1;const i=e.viewXfo.tr,s=e.viewXfo.ori;this.worker.postMessage({type:"ViewChanged",viewPos:i.asArray(),viewOri:s.asArray()})}s++}}));const a=()=>{const t=e.getViewport().getCamera().getParameter("GlobalXfo").getValue(),i=t.tr,s=t.ori;this.worker.postMessage({type:"ViewChanged",viewPos:i.asArray(),viewOri:s.asArray()})};e.getViewport().getCamera().on("movementFinished",a),a()}addGeomItem(e){let t=this.glGeomItemsMap[e.getId()];if(null!=t)return this.glGeomItems[t];const i=e.getParameter("Material");let s=i.getValue(),a=-1;s.getShaderClass().getPackedMaterialData&&(a=this.renderer.glMaterialLibrary.addMaterial(s));const r=e=>{s=i.getValue(),u.materialId=this.renderer.glMaterialLibrary.addMaterial(s),m()};i.on("valueChanged",r);const n=e.getParameter("Geometry");let o=n.getValue();const l=this.renderer.glGeomLibrary.addGeom(o),h=e=>{this.renderer.glGeomLibrary.removeGeom(o),o=n.getValue(),u.geomId=this.renderer.glGeomLibrary.addGeom(o),m()};n.on("valueChanged",h),this.glGeomItemsIndexFreeList.length>0?t=this.glGeomItemsIndexFreeList.pop():(t=this.glGeomItems.length,this.glGeomItems.push(null)),this.dirtyItemIndices.push(t);const d=this.renderer.gl,c=d.floatTexturesSupported,u=new an(d,e,t,l,a,c),m=()=>{this.dirtyItemIndices.includes(t)||(this.dirtyItemIndices.push(t),this.renderer.drawItemChanged())};return e.getParameter("GeomMat").on("valueChanged",m),e.on("cutAwayChanged",m),e.on("highlightChanged",m),this.glGeomItems[t]=u,this.glGeomItemEventHandlers[t]={geomItemChanged:m,materialChanged:r,geomChanged:h},this.glGeomItemsMap[e.getId()]=t,this.renderer.requestRedraw(),u}applyCullResults(e){e.newlyCulled.forEach((e=>{this.glGeomItems[e].setCulled(!0)})),e.newlyUnCulled.forEach((e=>{this.glGeomItems[e].setCulled(!1)})),this.renderer.requestRedraw(),this.renderer.emit("CullingUpdated")}removeGeomItem(e){const t=this.glGeomItemsMap[e.getId()],i=this.glGeomItems[t],s=e.getParameter("Geometry").getValue();this.renderer.glGeomLibrary.removeGeom(s);const a=this.glGeomItemEventHandlers[t];return e.getParameter("Material").off("valueChanged",a.materialChanged),e.getParameter("Geometry").off("valueChanged",a.geomChanged),e.getParameter("GeomMat").off("valueChanged",a.geomItemChanged),e.off("cutAwayChanged",a.geomItemChanged),e.off("highlightChanged",a.geomItemChanged),this.glGeomItems[t]=null,this.glGeomItemsIndexFreeList.push(t),delete this.glGeomItemsMap[e.getId()],this.removedItemIndices.push(t),this.renderer.requestRedraw(),i}getGeomItem(e){if(!(e>=this.glGeomItems.length))return this.glGeomItems[e].geomItem;console.warn("Invalid Draw Item id:"+e+" NumItems:"+(this.glGeomItems.length-1))}getGLGeomItem(e){const t=this.glGeomItemsMap[e.getId()];return null!=t?this.glGeomItems[t]:null}populateDrawItemDataArray(e,t,i,s){const a=this.glGeomItems[e];if(!a)return;const{geomItem:r,geomId:n}=a,o=24*t;let l=0;if(r.isCutawayEnabled()){l|=1}const h=ci.createFromBuffer(i.buffer,4*(o+0));h.set(l,0,0,0);const d=r.getParameter("Material").getValue(),c=this.renderer.glMaterialLibrary.getMaterialAllocation(d);c&&(h.z=c.start),h.w=n;const u=r.getGeomMat4(),m=ci.createFromBuffer(i.buffer,4*(o+4)),g=ci.createFromBuffer(i.buffer,4*(o+8)),_=ci.createFromBuffer(i.buffer,4*(o+12));m.set(u.xAxis.x,u.yAxis.x,u.zAxis.x,u.translation.x),g.set(u.xAxis.y,u.yAxis.y,u.zAxis.y,u.translation.y),_.set(u.xAxis.z,u.yAxis.z,u.zAxis.z,u.translation.z);const f=ci.createFromBuffer(i.buffer,4*(o+16));if(r.isHighlighted()){const e=r.getHighlight();f.set(e.r,e.g,e.b,e.a)}const p=ci.createFromBuffer(i.buffer,4*(o+20));if(r.isCutawayEnabled()){const e=r.getCutVector(),t=r.getCutDist();p.set(e.x,e.y,e.z,t)}s.push(this.getCullingWorkerData(r,d,e))}getCullingWorkerData(e,t,i){const s=e.getParameter("BoundingBox").getValue(),a=.5*s.size(),r=s.center();let n=!0;const o=t.getParameter("MaintainScreenSize");return o&&o.getValue()&&(n=!1),t.hasParameter("PointSize")&&(n=!1),{id:i,boundingRadius:a,pos:r.asArray(),cullable:n}}uploadGeomItems(e){const t=this.renderer.gl;if(!t.floatTexturesSupported){const e=[];return this.dirtyItemIndices.forEach((t=>{const i=this.glGeomItems[t];if(!i)return;const{geomItem:s}=i,a=s.getParameter("Material").getValue();e.push(this.getCullingWorkerData(s,a,t))})),this.worker.postMessage({type:"UpdateGeomItems",geomItems:e,removedItemIndices:this.removedItemIndices}),this.removedItemIndices=[],void(this.dirtyItemIndices=[])}let i=Math.round(Math.sqrt(6*this.glGeomItems.length)+.5);i=jt.nextPow2(i),i%6!=0&&(i+=6-i%6),this.glGeomItemsTexture?this.glGeomItemsTexture.width!=i&&(this.glGeomItemsTexture.resize(i,i),this.dirtyItemIndices=Array(i*i/6).fill().map(((e,t)=>t))):(this.glGeomItemsTexture=new pr(t,{format:"RGBA",type:"FLOAT",width:i,height:i,filter:"NEAREST",wrap:"CLAMP_TO_EDGE",mipMapped:!1}),this.glGeomItemsTexture.clear()),t.bindTexture(t.TEXTURE_2D,this.glGeomItemsTexture.glTex);const s=this.glGeomItemsTexture.getTypeID(),a=[];for(let e=0;e<this.dirtyItemIndices.length;e++){const r=this.dirtyItemIndices[e],n=Math.floor(6*r/i);let o=r+1;for(let t=e+1;t<this.dirtyItemIndices.length;t++){const e=this.dirtyItemIndices[t];if(Math.floor(6*e/i)!=n)break;if(e!=o)break;o++}const l=o-r,h=6*r%i,d=6*l,c=1,u=new Float32Array(24*l);for(let e=r;e<o;e++)this.populateDrawItemDataArray(e,e-r,u,a);if(s==t.FLOAT)this.glGeomItemsTexture.populate(u,d,c,h,n,!1);else{const e=jt.convertFloat32ArrayToUInt16Array(u);this.glGeomItemsTexture.populate(e,d,c,h,n,!1)}e+=l-1}this.worker.postMessage({type:"UpdateGeomItems",geomItems:a,removedItemIndices:this.removedItemIndices}),this.removedItemIndices=[],this.dirtyItemIndices=[]}bind(e){(this.dirtyItemIndices.length>0||this.removedItemIndices.length>0)&&this.uploadGeomItems(e);const t=this.renderer.gl,{instancesTexture:i,instancesTextureSize:s}=e.unifs;i&&(this.glGeomItemsTexture.bindToUniform(e,i),t.uniform1i(s.location,this.glGeomItemsTexture.width))}destroy(){}}let un,mn=!1,gn=!1;const _n={};class fn extends Mi{constructor(e,t={}){if(super(),si.gpuDesc){this.__shaders={},this.__passes={},this.__passesRegistrationOrder=[],this.__passCallbacks=[],this.__childItemAdded=this.__childItemAdded.bind(this),this.__childItemRemoved=this.__childItemRemoved.bind(this),this.__viewports=[],this.__activeViewport=void 0,this.__continuousDrawing=!1,this.__redrawRequested=!1,this.__isMobile=si.isMobileDevice,this.__drawSuspensionLevel=0,this.__shaderDirectives={},this.directives={},this.__xrViewportPresenting=!1,this.renderGeomDataFbos=this.renderGeomDataFbos.bind(this),this.requestRedraw=this.requestRedraw.bind(this),this.setupWebGL(e,t.webglOptions?{...t,...t.webglOptions}:t),this.bindEventHandlers(),this.addViewport("main"),this.glMaterialLibrary=new jr(this),this.glMaterialLibrary.on("updated",(()=>{this.requestRedraw()})),this.glGeomLibrary=new hn(this),this.glGeomLibrary.on("updated",(()=>{this.requestRedraw()})),this.glGeomItemLibrary=new cn(this),this.glGeomItemLibrary.on("updated",(()=>{this.requestRedraw()}));for(const e in _n)for(const t of _n[e])this.addPass(new t,e,!1);this.__supportXR=void 0===t.supportXR||t.supportXR,this.__xrViewport=void 0,this.__xrViewportPromise=new Promise(((e,t)=>{if(this.__supportXR&&navigator.xr){const t=()=>{this.__gl.makeXRCompatible().then((()=>{this.__xrViewport=this.__setupXRViewport(),this.emit("xrViewportSetup",{xrViewport:this.__xrViewport}),e(this.__xrViewport)}))};navigator.xr.isSessionSupported("immersive-vr").then((e=>{e&&t()})).catch((e=>{console.warn("Unable to setup XR:"+e)}))}}))}else console.warn("Unable to create renderer")}addShaderPreprocessorDirective(e,t){this.__shaderDirectives[e]=t?"#define "+e+" = "+t:"#define "+e;const i=[];for(const e in this.__shaderDirectives)i.push(this.__shaderDirectives[e]);this.directives=i,this.__gl.shaderopts={directives:i}}getWidth(){return this.__glcanvas.width}getHeight(){return this.__glcanvas.height}addViewport(e){const t=new Wr(this,e,this.getWidth(),this.getHeight());t.createGeomDataFbo(this.__floatGeomBuffer);return t.on("updated",(()=>{this.requestRedraw()})),t.on("viewChanged",(e=>{this.__xrViewportPresenting||this.emit("viewChanged",e)})),this.__viewports.push(t),t}getViewport(e=0){return this.__viewports[e]}getViewportAtPos(e,t){for(const i of this.__viewports){const s=i.getPosX(),a=i.getPosY(),r=i.getWidth(),n=i.getHeight();if(e>=s&&t>=a&&e<=r+s&&t<=n+a)return i}}activateViewport(e){this.__activeViewport!=e&&(this.__activeViewport=e)}activateViewportAtPos(e,t){if(this.__xrViewportPresenting)return;const i=this.getViewportAtPos(e,t);i&&i!=this.__activeViewport&&this.activateViewport(i)}getActiveViewport(){return this.__activeViewport}suspendDrawing(){this.__drawSuspensionLevel++}resumeDrawing(){this.__drawSuspensionLevel--,0==this.__drawSuspensionLevel&&(this.renderGeomDataFbos(),this.requestRedraw())}renderGeomDataFbos(){if(1==this.__renderGeomDataFbosRequested)return;this.__renderGeomDataFbosRequested=!0;window.requestAnimationFrame((()=>{for(const e of this.__viewports)e.renderGeomDataFbo();this.__renderGeomDataFbosRequested=!1}))}setupGrid(e,t,i,s){return console.warn("@GLBaseRenderer#setupGrid - Deprecated Method. Please use scene.setupGrid"),this.__scene.setupGrid(e,i,t)}getScene(){return this.__scene}setScene(e){this.__scene=e,this.addTreeItem(this.__scene.getRoot()),this.__gizmoContext&&this.__gizmoContext.setSelectionManager(e.getSelectionManager()),this.emit("sceneSet",{scene:this.__scene})}__childItemAdded(e){this.addTreeItem(e.childItem)}__childItemRemoved(e){this.removeTreeItem(e.childItem)}addTreeItem(e){if(e instanceof us){if(e instanceof va){const t=e.getParameter("Geometry");if(null==t.getValue()){const i=()=>{this.assignTreeItemToGLPass(e)};t.once("valueChanged",i)}else this.assignTreeItemToGLPass(e)}else this.assignTreeItemToGLPass(e);for(const t of e.getChildren())t&&this.addTreeItem(t);e.on("childAdded",this.__childItemAdded),e.on("childRemoved",this.__childItemRemoved),this.renderGeomDataFbos()}}assignTreeItemToGLPass(e){if(e instanceof va){const t=e;this.glGeomItemLibrary.addGeomItem(t)}let t=!1;for(let i=this.__passesRegistrationOrder.length-1;i>=0;i--){const s={continueInSubTree:!0};if(t=this.__passesRegistrationOrder[i].itemAddedToScene(e,s),t){if(!s.continueInSubTree)return;break}}if(!t)for(const t of this.__passCallbacks){const i={continueInSubTree:!0};if(t.itemAddedFn(e,i)){if(!i.continueInSubTree)return;break}}}removeTreeItem(e){if(e instanceof us){e.off("childAdded",this.__childItemAdded),e.off("childRemoved",this.__childItemRemoved);for(let t=this.__passesRegistrationOrder.length-1;t>=0;t--){const i={continueInSubTree:!0};if(this.__passesRegistrationOrder[t].itemRemovedFromScene(e,i)){if(!i.continueInSubTree)return;break}}for(const t of this.__passCallbacks){if(!t.itemRemovedFn)continue;const i={continueInSubTree:!0};if(t.itemRemovedFn(e,i)){if(!i.continueInSubTree)return;break}}for(const t of e.getChildren())t&&this.removeTreeItem(t);if(e instanceof va){const t=e;this.glGeomItemLibrary.removeGeomItem(t)}this.renderGeomDataFbos()}}get gl(){return this.__gl}getGL(){return this.__gl}resizeFbos(e,t){}handleResize(e,t){if(this.__xrViewportPresenting)return;if(e<16||t<16)return;const i=1*e,s=1*t;this.__glcanvas.width=i,this.__glcanvas.height=s,this.resizeFbos(i,s);for(const e of this.__viewports)e.resize(i,s);this.emit("resized",{width:i,height:s}),this.requestRedraw()}getDiv(){return this.__glcanvas.parentElement}setupWebGL(e,t){const{tagName:i}=e;if(!["DIV","CANVAS"].includes(i))throw new Error("Only CANVAS and DIV are valid root elements.");const s="DIV"===i;this.__glcanvas=e,s?(console.warn("@GLBaseRenderer#setupWebGL.","Using a DIV as root element is deprecated.","Use a CANVAS instead.","See: https://docs.zea.live/zea-engine/#/getting-started/get-started-with-engine?id=basic-setup"),this.__glcanvas=document.createElement("canvas"),this.__glcanvas.style.left="0px",this.__glcanvas.style.top="0px",this.__glcanvas.style.width="100%",this.__glcanvas.style.height="100%",this.__div=e,this.__div.appendChild(this.__glcanvas)):this.__glcanvas=e,this.__glcanvas.style["touch-action"]="none";if("static"===window.getComputedStyle(this.__glcanvas).position&&(console.warn("@GLBaseRenderer#setupWebGL.","The CANVAS element's position must be other than `static`.","See: https://docs.zea.live/zea-engine/#/getting-started/get-started-with-engine?id=basic-setup"),this.__glcanvas.style.position=t.canvasPosition?t.canvasPosition:"absolute"),this.resizeObserver=new ResizeObserver((e=>{for(const t of e){if(!t.contentRect)return;this.handleResize(t.contentRect.width,t.contentRect.height)}})),this.handleResize(this.__glcanvas.parentElement.clientWidth,this.__glcanvas.parentElement.clientHeight),this.resizeObserver.observe(this.__glcanvas.parentElement),t.preserveDrawingBuffer=!0,t.antialias=null==t.antialias||t.antialias,t.depth=null==t.depth||t.depth,t.stencil=!!t.stencil&&t.stencil,t.alpha=!!t.alpha&&t.alpha,t.xrCompatible=null!=t.xrCompatible&&t.xrCompatible,t.powerPreference=t.powerPreference||"high-performance",this.__gl=fr(this.__glcanvas,t),this.__gl||alert("Unable to create WebGL context. WebGL not supported."),this.__gl.renderer=this,"webgl2"==this.__gl.name&&this.addShaderPreprocessorDirective("ENABLE_ES3"),this.__gl.floatTexturesSupported&&this.addShaderPreprocessorDirective("ENABLE_FLOAT_TEXTURES"),!t.disableMultiDraw){const e=this.__gl.getExtension("WEBGL_multi_draw");e&&(this.__gl.multiDrawArrays=e.multiDrawArraysWEBGL.bind(e),this.__gl.multiDrawElements=e.multiDrawElementsWEBGL.bind(e),this.__gl.multiDrawElementsInstanced=e.multiDrawElementsInstancedWEBGL.bind(e),this.__gl.multiDrawArraysInstanced=e.multiDrawArraysInstancedWEBGL.bind(e))}this.__gl.screenQuad=new Nr(this.__gl),this.__screenQuad=this.__gl.screenQuad,this.__floatGeomBuffer=this.__gl.floatTexturesSupported&&"Safari"!=si.browserName,this.__gl.floatGeomBuffer=this.__floatGeomBuffer}bindEventHandlers(){const e=()=>this.getWidth()>0&&this.getHeight(),t=e=>{e.propagating=!0;const t=e.stopPropagation;e.stopPropagation=()=>{e.propagating=!1,t&&t.call(e)}},i=e=>{const t=this.__glcanvas.getBoundingClientRect();e.rendererX=1*(e.clientX-t.left),e.rendererY=1*(e.clientY-t.top)},s=e=>!(!si.isMobileDevice||"Safari"!=si.browserName)&&(console.warn("Mobile Safari is triggering mouse event:",e.type),!0);this.__glcanvas.addEventListener("mousedown",(e=>{if(s(e))return;t(e),i(e),mn=!0,un=this,un.activateViewportAtPos(e.rendererX,e.rendererY);const a=un.getActiveViewport();return a&&(e.pointerType=ti.mouse,a.onPointerDown(e)),gn=!1,!1})),document.addEventListener("mouseup",(a=>{if(s(a))return;if(un!=this||!e())return;t(a),i(a),mn=!1;const r=un.getActiveViewport();return r&&(a.pointerType=ti.mouse,r.onPointerUp(a)),gn&&(r&&(a.pointerType=ti.mouse,r.onPointerLeave(a)),un=void 0),!1})),document.addEventListener("mousemove",(a=>{if(s(a))return;if(un!=this||!e())return;t(a),i(a),mn||un.activateViewportAtPos(a.rendererX,a.rendererY);const r=un.getActiveViewport();return r&&(a.pointerType=ti.mouse,r.onPointerMove(a)),!1})),this.__glcanvas.addEventListener("mouseenter",(e=>{if(!s(e)&&!mn){if(un=this,e.pointerType=ti.mouse,t(e),i(e),un.activateViewportAtPos(e.rendererX,e.rendererY),!mn){const t=un.getActiveViewport();t&&(e.pointerType=ti.mouse,t.onPointerEnter(e))}gn=!1}})),this.__glcanvas.addEventListener("mouseleave",(i=>{if(!s(i)&&un==this&&e())if(t(i),mn)gn=!0;else{const e=un.getActiveViewport();e&&(i.pointerType=ti.mouse,e.onPointerLeave(i)),un=void 0}})),this.__glcanvas.addEventListener("touchstart",(e=>{e.stopPropagation(),e.preventDefault=()=>{},t(e);for(let t=0;t<e.touches.length;t++)i(e.touches[t]);e.pointerType=ti.touch,this.getViewport().onPointerDown(e)}),{passive:!0}),this.__glcanvas.addEventListener("touchend",(e=>{e.stopPropagation(),e.preventDefault=()=>{},t(e);for(let t=0;t<e.changedTouches.length;t++)i(e.changedTouches[t]);e.pointerType=ti.touch,this.getViewport().onPointerUp(e)}),{passive:!0}),this.__glcanvas.addEventListener("touchmove",(e=>{e.stopPropagation(),e.preventDefault=()=>{},t(e);for(let t=0;t<e.touches.length;t++)i(e.touches[t]);e.pointerType=ti.touch,this.getViewport().onPointerMove(e)}),{passive:!0});const a=s=>{if(un==this&&e()){if(un){t(s),i(s);const e=un.getActiveViewport();e&&e.onWheel(s)}return!1}};window.addEventListener?window.addEventListener("wheel",a,{passive:!1}):window.onmousewheel=document.onmousewheel=a,window.oncontextmenu=function(){return!1},document.addEventListener("keydown",(i=>{if(un!=this||!e())return;t(i);const s=un.getActiveViewport();s&&s.onKeyDown(i)})),document.addEventListener("keyup",(i=>{if(un!=this||!e())return;t(i);const s=un.getActiveViewport();s&&s.onKeyUp(i)}))}getGLCanvas(){return this.__glcanvas}frameAll(e=0){this.__viewports[e].frameView([this.__scene.getRoot()])}getOrCreateShader(e){let t=this.__shaders[e];return t||(t=oi.constructClass(e,this.__gl),t||console.error("@GLBaseRenderer#getOrCreateShader - Shader not registered with the Registry:",e),this.__shaders[e]=t),t}addPass(e,t=-1,i=!0){-1==t&&(t=e.getPassType()),this.__passes[t]||(this.__passes[t]=[]);let s=0;for(const e in this.__passes){if(e==t)break;s+=this.__passes[e].length}if(s+=this.__passes[t].length,e.on("updated",this.requestRedraw),e.init(this,s),this.__passes[t].push(e),i){let e=0;for(const t in this.__passes){const i=this.__passes[t];i.forEach(((t,i)=>{t.setPassIndex(e+i)})),e+=i.length}}return this.__passesRegistrationOrder.push(e),this.requestRedraw(),s}registerPass(e,t){console.warn("Deprecated, GLPass must now implement #itemAddedToScene and #itemRemovedFromScene instead"),this.__passCallbacks.splice(0,0,{itemAddedFn:e,itemRemovedFn:t})}getPass(e){let t=0;for(const i in this.__passes){const s=this.__passes[i];if(e-t<s.length)return s[e-t];t+=s.length}}supportsVR(){return console.warn("@GLBaseRenderer#supportVR - Deprecated Method. Please instead connect to the vrViewportSetup signal."),this.__supportXR&&null!=navigator.xr}__setupXRViewport(){const e=new Dr(this),t=e=>{this.emit("viewChanged",e)};return e.on("presentingChanged",(i=>{const s=i.state;if(this.__xrViewportPresenting=s,s){for(const e in this.__passes){const t=this.__passes[e];for(const e of t)e.startPresenting()}e.on("viewChanged",t)}else{e.off("viewChanged",t),this.emit("updated",{});for(const e in this.__passes){const t=this.__passes[e];for(const e of t)e.stopPresenting()}const i={interfaceType:"CameraAndPointer",viewXfo:this.getViewport().getCamera().getParameter("GlobalXfo").getValue()};this.emit("viewChanged",i),this.resizeFbos(this.getWidth(),this.getHeight()),this.requestRedraw()}})),e}getVRViewport(){return this.__xrViewport}getXRViewport(){return this.__xrViewportPromise}isXRViewportPresenting(){return this.__xrViewportPresenting}isContinuouslyDrawing(){return this.__continuousDrawing}startContinuousDrawing(){if(this.isContinuouslyDrawing()||this.__xrViewportPresenting)return;const e=()=>{this.__continuousDrawing&&!this.__xrViewportPresenting&&window.requestAnimationFrame(e);for(const e of this.__viewports)e.draw()};this.__continuousDrawing=!0,window.requestAnimationFrame(e)}stopContinuousDrawing(){this.__continuousDrawing=!1}toggleContinuousDrawing(){this.__continuousDrawing?this.stopContinuousDrawing():this.startContinuousDrawing()}drawItemChanged(){for(const e of this.__viewports)e.invalidateGeomDataBuffer();this.requestRedraw()}requestRedraw(){if(this.__redrawRequested||this.__continuousDrawing||this.__xrViewportPresenting||this.__drawSuspensionLevel>0)return!1;return window.requestAnimationFrame((()=>{this.__redrawRequested=!1;for(const e of this.__viewports)e.draw()})),this.__redrawRequested=!0,!0}forceRender(){if(this.__redrawRequested){this.__redrawRequested=!1;for(const e of this.__viewports)e.draw()}else console.warn("@GlBaseRenderer#forceRender - Scene is not dirty")}bindGLBaseRenderer(e){e.gl=this.__gl,e.shaderopts={directives:this.directives};const t=this.__gl;e.viewports&&1!=e.viewports.length?(e.bindRendererUnifs=i=>{const{cameraMatrix:s}=i;s&&t.uniformMatrix4fv(s.location,!1,e.cameraMatrix.asArray())},e.bindViewports=(i,s)=>{e.viewports.forEach(((e,a)=>{t.viewport(...e.region);const{viewMatrix:r,projectionMatrix:n,eye:o}=i;r&&t.uniformMatrix4fv(r.location,!1,e.viewMatrix.asArray()),n&&t.uniformMatrix4fv(n.location,!1,e.projectionMatrix.asArray()),o&&t.uniform1i(o.location,a),s()}))}):(e.bindRendererUnifs=i=>{const{cameraMatrix:s,viewMatrix:a,projectionMatrix:r,eye:n}=i;s&&t.uniformMatrix4fv(s.location,!1,e.cameraMatrix.asArray());const o=e.viewports[0];a&&t.uniformMatrix4fv(a.location,!1,o.viewMatrix.asArray()),r&&t.uniformMatrix4fv(r.location,!1,o.projectionMatrix.asArray()),n&&t.uniform1i(n.location,index)},e.bindViewports=(e,t)=>t())}drawScene(e){e.directives=[...this.directives,"#define DRAW_COLOR"],e.shaderopts.directives=e.directives;for(const t in this.__passes){const i=this.__passes[t];for(const t of i)t.enabled&&t.draw(e)}}drawHighlightedGeoms(e){this.bindGLBaseRenderer(e),e.directives=[...this.directives,"#define DRAW_HIGHLIGHT"],e.shaderopts.directives=e.directives;for(const t in this.__passes){const i=this.__passes[t];for(const t of i)t.enabled&&t.drawHighlightedGeoms(e)}}drawSceneGeomData(e,t=255){this.bindGLBaseRenderer(e),e.directives=[...this.directives,"#define DRAW_GEOMDATA"],e.shaderopts.directives=e.directives;for(const i in this.__passes){if(0==(Number.parseInt(i)&t))continue;const s=this.__passes[i];for(const t of s)t.enabled&&t.drawGeomData(e)}}static registerPass(e,t){_n[t]||(_n[t]=[]),_n[t].push(e)}destroy(){super.destroy(),this.resizeObserver.unobserve()}}class pn extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER","\nprecision highp float;\n\nattribute vec3 positions;    //(location = 0)\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n    v_texCoord = positions.xy+0.5;\n    gl_Position = vec4(positions.xy*2.0, 0.0, 1.0);\n}\n\n"),this.setShaderStage("FRAGMENT_SHADER","\nprecision highp float;\n\nuniform sampler2D highlightDataTexture;\nuniform vec2 highlightDataTextureSize;\n\nvarying vec2 v_texCoord;\n\n\nbool isFilledPixel(vec4 p) {\n    return p.r > 0.01 || p.g > 0.01 || p.b > 0.01;\n}\nvoid accumOutlinePixel(vec2 fragCoord, inout vec4 res) {\n    vec3 p = texture2D(highlightDataTexture, fragCoord/highlightDataTextureSize).rgb;\n    if(p.r > 0.01 || p.g > 0.01 || p.b > 0.01) {\n        res.r += p.r;\n        res.g += p.g;\n        res.b += p.b;\n        res.a += 1.0;\n    }\n}\nvec4 getOutlinePixelColor(vec2 fragCoord) {\n    vec4 M = texture2D(highlightDataTexture, fragCoord/highlightDataTextureSize);\n    \n    /// To display a fill instead of an outline.\n    // return M;\n\n    if( isFilledPixel(M) ) {\n        // Note: the filled pixel has an alpha value\n        // that determines how much fill is applied\n        // The outline is a solid color. \n        return M;\n    }\n    // Search surrounding pixels for selected geoms.\n    vec4 res;\n    accumOutlinePixel(fragCoord+vec2( 1, 1), res); // NW\n    accumOutlinePixel(fragCoord+vec2(-1, 1), res); // NE\n    accumOutlinePixel(fragCoord+vec2( 1,-1), res); // SW\n    accumOutlinePixel(fragCoord+vec2(-1,-1), res); // SE\n    accumOutlinePixel(fragCoord+vec2( 0, 2), res); // NN\n    accumOutlinePixel(fragCoord+vec2(-2, 0), res); // EE\n    accumOutlinePixel(fragCoord+vec2( 2, 0), res); // WW\n    accumOutlinePixel(fragCoord+vec2( 0,-2), res); // SS\n    accumOutlinePixel(fragCoord+vec2( 1, 2), res); // NNW\n    accumOutlinePixel(fragCoord+vec2(-1, 2), res); // NNE\n    accumOutlinePixel(fragCoord+vec2(-2, 1), res); // EEN\n    accumOutlinePixel(fragCoord+vec2(-2,-1), res); // EES\n    accumOutlinePixel(fragCoord+vec2( 2, 1), res); // WWN\n    accumOutlinePixel(fragCoord+vec2( 2,-1), res); // WWS\n    accumOutlinePixel(fragCoord+vec2( 1,-2), res); // SSW\n    accumOutlinePixel(fragCoord+vec2(-1,-2), res); // SSE\n\n    if(isFilledPixel(res))\n        return vec4(res.rgb / res.a, 1.0);\n    else\n        return vec4(0.0, 0.0, 0.0, 0.0);\n}\n\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n    // fragColor = texture2D(highlightDataTexture, v_texCoord);;\n    //can also use gl_FragCoord.xy\n    mediump vec2 fragCoord = v_texCoord * highlightDataTextureSize; \n    /////////////////\n    // Selection Outlines\n    vec4 outlineColor = getOutlinePixelColor(fragCoord);\n    if(outlineColor.a > 0.0001){\n#ifndef ENABLE_ES3\n        gl_FragColor = outlineColor;\n#else\n        fragColor = outlineColor;\n#endif\n    }\n    else {\n        discard;\n    }\n}\n\n")}}const bn=dr.OPAQUE|dr.TRANSPARENT|dr.OVERLAY;class yn extends fn{constructor(e,t={}){super(e,t),this.__exposure=1,this.__tonemap=!0,this.__gamma=2.2,this.__glEnvMap=void 0,this.__glBackgroundMap=void 0,this.__displayEnvironment=!0,this.__debugMode=0,this._planeDist=0,this.__cutPlaneNormal=new di(1,0,0),this.rayCastDist=0,this.rayCastArea=0;const i=this.__gl;this.__debugTextures=[void 0],this.addShaderPreprocessorDirective("ENABLE_INLINE_GAMMACORRECTION"),t.disableTextures||this.addShaderPreprocessorDirective("ENABLE_TEXTURES"),t.debugGeomIds&&this.addShaderPreprocessorDirective("DEBUG_GEOM_ID"),this.__outlineShader=new pn(i),this.quad=new tn(i,new Hs(1,1)),this.createSelectedGeomsFbo()}__bindEnvMap(e){const t=this.__gl;if(e instanceof pa)"webgl2"===t.name&&(this.__glEnvMap=e.getMetadata("gltexture"),this.__glEnvMap||("FLOAT"===e.type?(this.addShaderPreprocessorDirective("ENABLE_PBR"),this.__glEnvMap=new Er(this,e)):e.isStreamAtlas()?this.__glEnvMap=new GLImageStream(t,e):this.__glEnvMap=new pr(t,e)),this.__glEnvMap.on("loaded",this.requestRedraw),this.__glEnvMap.on("updated",this.requestRedraw),this.emit("envMapAssigned",{envMap:this.__glEnvMap}));else{const i=e;if(this.__glBackgroundMap=i.getMetadata("gltexture"),this.__glBackgroundMap||("FLOAT"===i.type?this.__glBackgroundMap=new Tr(t,i):this.__glBackgroundMap=new pr(t,i)),this.__glBackgroundMap.on("loaded",this.requestRedraw),this.__glBackgroundMap.on("updated",this.requestRedraw),!this.__backgroundMapShader){t.__quadVertexIdsBuffer||t.setupInstancedQuad(),this.__backgroundMapShader=new Fr(t);const e=this.__backgroundMapShader.compileForTarget();this.__backgroundMapShaderBinding=Mr(t,e.attrs,t.__quadattrbuffers,t.__quadIndexBuffer)}}}getGLEnvMap(){return this.__glEnvMap}getEnvMapTex(){return console.warn("Deprecated Function"),this.__glEnvMap}setScene(e){const t=e.settings.getParameter("EnvMap");null!=t.getValue()&&this.__bindEnvMap(t.getValue()),t.on("valueChanged",(()=>{this.__bindEnvMap(t.getValue())}));const i=e.settings.getParameter("Display EnvMap");this.__displayEnvironment=i.getValue(),i.on("valueChanged",(()=>{this.__displayEnvironment=i.getValue(),this.requestRedraw()})),super.setScene(e)}addViewport(e){return super.addViewport(e)}get exposure(){return this.__exposure}set exposure(e){this.__exposure=e,this.requestRedraw()}get gamma(){return this.__gamma}set gamma(e){this.__gamma=e,this.requestRedraw()}get displayEnvironment(){return this.__displayEnvironment}set displayEnvironment(e){this.__displayEnvironment=e,this.requestRedraw()}get planeDist(){return this._planeDist}set planeDist(e){this._planeDist=e,this.requestRedraw()}get cutPlaneNormal(){return this.__cutPlaneNormal}set cutPlaneNormal(e){this.__cutPlaneNormal=e,this.requestRedraw()}resizeFbos(e,t){super.resizeFbos(),this.__fbo&&this.__fbo.resize(e,t),this.__highlightedGeomsBuffer&&this.__highlightedGeomsBuffer.resize(e,t)}createSelectedGeomsFbo(){const e=this.__gl;this.__highlightedGeomsBuffer=new pr(e,{type:"UNSIGNED_BYTE",format:"RGBA",filter:"NEAREST",width:this.__glcanvas.width<=1?1:this.__glcanvas.width,height:this.__glcanvas.height<=1?1:this.__glcanvas.height}),this.__highlightedGeomsBufferFbo=new xr(e,this.__highlightedGeomsBuffer,!0),this.__highlightedGeomsBufferFbo.setClearColor([0,0,0,0])}getFbo(){return this.__fbo}createOffscreenFbo(e="RGB"){const t=this.__glcanvas.width,i=this.__glcanvas.height,s=this.__gl;this.__fwBuffer=new pr(s,{type:"FLOAT",format:e,filter:"NEAREST",width:t,height:i}),this.__fbo=new xr(s,this.__fwBuffer,!0),this.__fbo.setClearColor(this.__backgroundColor.asArray())}raycastWithRay(e,t,i=.01,s=bn){const a=new yi;return a.setLookAt(e.start,e.start.add(e.dir)),this.raycast(a,e,t,i,s)}raycastWithXfo(e,t,i=.01,s=bn){const a=new bi(e.tr,e.ori.getZaxis().negate());return this.raycast(e,a,t,i,s)}raycast(e,t,i,s=.01,a=bn){const r=this.__gl;this.__rayCastRenderTarget||(this.__rayCastRenderTarget=new Ir(r,{type:"FLOAT",format:"RGBA",filter:"NEAREST",width:3,height:3,numColorChannels:1}),this.__rayCastRenderTargetProjMatrix=new fi),this.rayCastDist==i&&this.rayCastArea==s||(this.__rayCastRenderTargetProjMatrix.setOrthographicMatrix(-.5*s,.5*s,-.5*s,.5*s,0,i),this.rayCastDist=i,this.rayCastArea=s);const n={cameraMatrix:e.toMat4(),viewports:[{region:[0,0,3,3],viewMatrix:e.inverse().toMat4(),projectionMatrix:this.__rayCastRenderTargetProjMatrix,isOrthographic:!0}]};this.__rayCastRenderTarget.bindForWriting(n,!0),r.enable(r.CULL_FACE),r.enable(r.DEPTH_TEST),r.depthFunc(r.LEQUAL),r.depthMask(!0),this.drawSceneGeomData(n,a),r.finish(),this.__rayCastRenderTarget.unbindForWriting(),this.__rayCastRenderTarget.bindForReading();const o=new Float32Array(36);r.readPixels(0,0,3,3,r.RGBA,r.FLOAT,o),this.__rayCastRenderTarget.unbindForReading();const l=[4,3,5,1,7];let h;for(const e of l)if(0!=o[4*e+3]){h=o.subarray(4*e,4*e+4);break}if(!h)return;const d=63&Math.round(h[0]),c=this.getPass(d).getGeomItemAndDist(h);if(c){const e=t.start.add(t.dir.scale(c.dist));return{ray:t,intersectionPos:e,geomItem:c.geomItem,dist:c.dist,geomData:h}}}raycastCluster(e,t,i,s=.01,a=bn){const r=this.__gl;this.__rayCastRenderTarget||(this.__rayCastRenderTarget=new Ir(r,{type:"FLOAT",format:"RGBA",filter:"NEAREST",width:3,height:3,numColorChannels:1}),this.__rayCastRenderTargetProjMatrix=new fi),this.rayCastDist==i&&this.rayCastArea==s||(this.__rayCastRenderTargetProjMatrix.setOrthographicMatrix(-.5*s,.5*s,-.5*s,.5*s,0,i),this.rayCastDist=i,this.rayCastArea=s);const n={cameraMatrix:e.toMat4(),viewports:[{region:[0,0,3,3],viewMatrix:e.inverse().toMat4(),projectionMatrix:this.__rayCastRenderTargetProjMatrix,isOrthographic:!0}]};this.__rayCastRenderTarget.bindForWriting(n,!0),r.enable(r.CULL_FACE),r.enable(r.DEPTH_TEST),r.depthFunc(r.LEQUAL),r.depthMask(!0),this.drawSceneGeomData(n,a),r.finish(),this.__rayCastRenderTarget.unbindForWriting(),this.__rayCastRenderTarget.bindForReading();const o=new Float32Array(36);r.readPixels(0,0,3,3,r.RGBA,r.FLOAT,o),this.__rayCastRenderTarget.unbindForReading();const l=[];for(let e=0;e<9;e++)if(0!=o[4*e+3]){const i=o.subarray(4*e,4*e+4),s=63&Math.round(i[0]),a=this.getPass(s).getGeomItemAndDist(i);if(a){const e=t.start.add(t.dir.scale(a.dist));l.push({ray:t,intersectionPos:e,geomItem:a.geomItem,dist:a.dist,geomData:i})}}return l}drawBackground(e){if(this.__glBackgroundMap){if(!this.__glBackgroundMap.isLoaded())return;const t=this.__gl;t.depthMask(!1),this.__backgroundMapShader.bind(e);const i=e.unifs;this.__glBackgroundMap.bindToUniform(e,i.backgroundImage),this.__backgroundMapShaderBinding.bind(e),t.drawQuad()}else this.__glEnvMap&&this.__glEnvMap.draw&&this.__glEnvMap.draw(e)}bindGLRenderer(e){super.bindGLBaseRenderer(e),e.envMap=this.__glEnvMap,e.exposure=this.__exposure,e.gamma=this.__gamma}drawScene(e){if(this.bindGLRenderer(e),this.__displayEnvironment&&this.drawBackground(e),super.drawScene(e),this.__highlightedGeomsBufferFbo){const t=this.__gl;this.__highlightedGeomsBufferFbo.bindForWriting(e),this.__highlightedGeomsBufferFbo.clear(),t.disable(t.BLEND),t.enable(t.DEPTH_TEST),t.depthFunc(t.LESS),t.depthMask(!0),e.glShader=null,this.drawHighlightedGeoms(e),this.__highlightedGeomsBufferFbo.unbindForWriting(e),t.viewport(...e.region),this.__outlineShader.bind(e),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA);const i=e.unifs;this.__highlightedGeomsBuffer.bindToUniform(e,i.highlightDataTexture),t.uniform2f(i.highlightDataTextureSize.location,e.region[2],e.region[3]),this.quad.bindAndDraw(e),t.disable(t.BLEND)}this.emit("redrawOccurred",{})}}yr.setShaderModule("GLSLUtils.glsl","\n\n\nint ftoi(float val){\n    return int(floor(val + 0.5));\n}\nivec2 ftoi(vec2 v2) {\n    return ivec2(ftoi(v2.x), ftoi(v2.y));\n}\nivec3 ftoi(vec3 v4) {\n    return ivec3(ftoi(v4.x), ftoi(v4.y), ftoi(v4.z));\n}\nivec4 ftoi(vec4 v4) {\n    return ivec4(ftoi(v4.x), ftoi(v4.y), ftoi(v4.z), ftoi(v4.w));\n}\n\n#ifdef ENABLE_ES3\n\nint imod(int x, int y) {\n    return x % y;\n}\n\nvoid setFlag(inout int flags, int flag) {\n    flags |= flag;\n}\n\nvoid clearFlag(inout int flags, int flag) {\n    flags &= ~flag;\n}\n\nbool testFlag(int flags, int flag) {\n    return (flags & flag) != 0;\n}\n\n// private function: Mangle me...\nivec2 _pixelIndexToUV(int index, int textureWidth){\n    return ivec2(index % textureWidth, index / textureWidth);\n}\n\nvec4 fetchTexel(sampler2D texture, int textureWidth, int index) {\n    return texelFetch(texture, _pixelIndexToUV(index, textureWidth), 0);\n}\n\nvec4 fetchTexel(sampler2D texture, ivec2 textureSize, ivec2 texCoord) {\n    return texelFetch(texture, texCoord, 0);\n}\n\n#else\n\n// TODO: integrate: https://gist.github.com/mattatz/70b96f8c57d4ba1ad2cd\n\nint max(int a, int b) {\n    return a > b ? a : b;\n}\nint min(int a, int b) {\n    return a < b ? a : b;\n}\n\n\nfloat round(float val){\n    return floor(val + 0.4);\n}\n\nint imod(int x, int y) {\n    return x-y*(x/y);\n}\n\nvoid setFlag(inout int flags, int flag) {\n    flags += flag;\n}\nvoid clearFlag(inout int flags, int flag) {\n    flags -= flag;\n}\n\nbool testFlag(int flags, int flag) {\n    return imod(flags / flag, 2) != 0;\n}\n\n// private function: Mangle me...\nvec2 _pixelIndexToUV(int index, int textureSize){\n    float flTexSize = float(textureSize);\n    float x = (float(imod(index, textureSize))+0.5)/flTexSize;\n    float y = (floor(float(index / textureSize))+0.5)/flTexSize;\n    return vec2(x, y);\n}\n\nvec4 fetchTexel(sampler2D texture, int textureSize, int index) {\n    vec2 texCoord = _pixelIndexToUV(index, textureSize);\n    return texture2D(texture, texCoord);\n}\n\nvec4 fetchTexel(sampler2D texture, ivec2 textureSize, ivec2 texCoord) {\n    vec2 ftextureSize = vec2(textureSize);\n    return texture2D(texture, (vec2(texCoord) + 0.5) / ftextureSize);\n}\n\n\n#endif // ENABLE_ES3\n\nint uvToPixelIndex(vec2 uv, int textureSize){\n    return int(uv.x * float(textureSize)) + (int(floor(uv.y * float(textureSize))) * textureSize);\n}\n\n"),yr.setShaderModule("drawItemId.glsl","\n\n\n#ifdef ENABLE_MULTI_DRAW\n\nuniform sampler2D drawIdsTexture;\n\nuniform int instancedDraw;\n\nint getDrawItemId() {\n  ivec2 drawIdsTextureSize = textureSize(drawIdsTexture, 0);\n  ivec2 drawIdsArrayCoords = ivec2(gl_DrawID % drawIdsTextureSize.x, gl_DrawID / drawIdsTextureSize.x);\n  return int(texelFetch(drawIdsTexture, drawIdsArrayCoords, 0).r + 0.5);\n}\n\n#else // ENABLE_MULTI_DRAW\n\nuniform int transformIndex;\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\nattribute float instancedIds;    // instanced attribute..\nuniform int instancedDraw;\n\nint getDrawItemId() {\n  if(instancedDraw == 0){\n    return transformIndex;\n  }\n  else{\n    return int(instancedIds);\n  }\n}\n\n\n#else\n\nint getDrawItemId() {\n  return transformIndex;\n}\n\n#endif // ENABLE_FLOAT_TEXTURES\n#endif // ENABLE_MULTI_DRAW\n\n"),yr.setShaderModule("drawItemTexture.glsl",'\n<%include file="GLSLUtils.glsl"/>\n  \n\n#ifdef ENABLE_FLOAT_TEXTURES\n\nuniform sampler2D instancesTexture;\nuniform highp int instancesTextureSize;\n\nconst int pixelsPerItem = 6;\n\nvec4 getInstanceData(int id) {\n    return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 0);\n}\n\n#else\n\nuniform vec4 drawItemData;\n\nvec4 getInstanceData(int id) {\n    return drawItemData;\n}\n\n#endif\n\n\n'),yr.setShaderModule("modelMatrix.glsl","\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\nmat4 getMatrix(sampler2D texture, int textureSize, int index) {\n    // Unpack 3 x 4 matix columns into a 4 x 4 matrix.\n    vec4 col0 = fetchTexel(texture, textureSize, (index * pixelsPerItem) + 1);\n    vec4 col1 = fetchTexel(texture, textureSize, (index * pixelsPerItem) + 2);\n    vec4 col2 = fetchTexel(texture, textureSize, (index * pixelsPerItem) + 3);\n    mat4 result = mat4(col0, col1, col2, vec4(0.0, 0.0, 0.0, 1.0));\n    return transpose(result);\n    // return mat4(1.0);\n}\n\nmat4 getModelMatrix(int id) {\n    return getMatrix(instancesTexture, instancesTextureSize, id);\n}\n\n#else\n\nuniform mat4 modelMatrix;\n\nmat4 getModelMatrix(int id) {\n    return modelMatrix;\n}\n\n#endif\n\n\n"),yr.setShaderModule("materialparams.glsl","\n\n#ifdef ENABLE_MULTI_DRAW\n  \nuniform sampler2D materialsTexture;\n\nvec4 getMaterialValue(vec2 materialCoords, int valueIndex) {\n    int index = ftoi(materialCoords.x) + valueIndex;\n    ivec2 materialsTextureSize = textureSize(materialsTexture, 0);\n    ivec2 texelCoords = ivec2(index % materialsTextureSize.x, index / materialsTextureSize.x);\n    \n    return texelFetch(materialsTexture, texelCoords, 0);\n}\n\n#else // ENABLE_MULTI_DRAW\n\n////////////////////////\n// Material Param Helpers.\n\nvec4 getColorParamValue(vec4 value, sampler2D tex, int texType, vec2 texCoord) {\n    if(texType == 0){\n        return toLinear(value);\n    }\n    else if(texType == 1 || texType == 2){\n        // TODO: Use SRGB textures.\n        return toLinear(texture2D(tex, texCoord));\n    }\n    else if(texType == 3){\n        // Float HDR Texture\n        return texture2D(tex, texCoord);\n    }\n    else\n        return value;\n}\n\n\n\nfloat luminanceFromRGB(vec3 rgb) {\n    return 0.2126*rgb.r + 0.7152*rgb.g + 0.0722*rgb.b;\n}\n\nfloat getLuminanceParamValue(float value, sampler2D tex, int texType, vec2 texCoord) {\n    if(texType == 0)\n        return value;\n    else\n        return luminanceFromRGB(texture2D(tex, texCoord).rgb);\n}\n\n\n#endif // ENABLE_MULTI_DRAW\n"),yr.setShaderModule("debugColors.glsl","\n\nvec3 getDebugColor(float id) {\n    int sel = int(round(mod(round(id), 16.0)));\n    \n    if(sel==0)\n        return vec3(0.0, 1.0, 1.0);\n    else if (sel==1)\n        return vec3(0.0, 1.0, 0.0);\n    else if (sel==2)\n        return vec3(1.0, 0.0, 1.0);\n    else if (sel==3)\n        return vec3(0.75, 0.75, 0.0);\n    else if (sel==4)\n        return vec3(0.0, 0.75, 0.75);\n    else if (sel==5)\n        return vec3(0.75, 0.0, 0.75);\n    else if (sel==6)\n        return vec3(0.45, 0.95, 0.0);\n    else if (sel==7)\n        return vec3(0.0, 0.45, 0.95);\n    else if (sel==8)\n        return vec3(0.95, 0.0, 0.45);\n    else if (sel==9)\n        return vec3(0.95, 0.45, 0.0);\n    else if (sel==10)\n        return vec3(0.0, 0.95, 0.45);\n    else if (sel==11)\n        return vec3(0.45, 0.0, 0.95);\n    else if (sel==12)\n        return vec3(0.45, 0.45, 0.95);\n    else if (sel==13)\n        return vec3(0.0, 0.0, 0.45);\n    else if (sel==14)\n        return vec3(0.0, 0.45, 0.45);\n    else if (sel==15)\n        return vec3(0.45, 0.0, 0.45);\n    else return vec3(0.2, 0.2, 0.2);\n}\n\n\n");class Gn extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 cameraMatrix;\n\n<%include file="GLSLUtils.glsl"/>\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\n// A sorted attribute of instance Ids so we draw from back to front.\ninstancedattribute float instanceIds;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="utils/imageAtlas.glsl"/>\n\nuniform sampler2D atlasBillboards_layout;\nuniform vec4 atlasBillboards_desc;\n\nuniform sampler2D instancesTexture;\nuniform int instancesTextureSize;\n\n\nconst int cols_per_instance = 6;\n\nmat4 getMatrix(sampler2D texture, int textureSize, int index) {\n  // Unpack 3 x 4 matix columns into a 4 x 4 matrix.\n  vec4 col0 = fetchTexel(texture, textureSize, (index * cols_per_instance) + 0);\n  vec4 col1 = fetchTexel(texture, textureSize, (index * cols_per_instance) + 1);\n  vec4 col2 = fetchTexel(texture, textureSize, (index * cols_per_instance) + 2);\n  mat4 result = mat4(col0, col1, col2, vec4(0.0, 0.0, 0.0, 1.0));\n  return transpose(result);\n  // return mat4(1.0);\n}\n\nmat4 getModelMatrix(int id) {\n  return getMatrix(instancesTexture, instancesTextureSize, id);\n}\nvec4 getInstanceData(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * cols_per_instance) + 3);\n}\nvec4 getPivot(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * cols_per_instance) + 4);\n}\n\nvec4 getTintColor(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * cols_per_instance) + 5);\n}\n\n\n#else\n\nuniform vec4 atlasBillboards_desc;\n\nuniform mat4 modelMatrix;\nuniform vec2 pivot;\nuniform vec4 billboardData;\nuniform vec4 tintColor;\nuniform vec4 layoutData;\n\n#endif\n\nuniform int inVR;\n\nmat4 calcLookAtMatrix(vec3 origin, vec3 target, float roll) {\n  // vec3 rr = vec3(sin(roll), 0.0, cos(roll));\n  vec3 rr = vec3(0.0, 0.0, 1.0);\n  vec3 ww = normalize(target - origin);\n  vec3 uu = normalize(cross(rr, ww));\n  vec3 vv = normalize(cross(ww, uu));\n\n  return mat4(vec4(uu, 0.0), vec4(vv, 0.0), vec4(ww, 0.0), vec4(origin, 1.0));\n}\n\nfloat map(float value, float inMin, float inMax, float outMin, float outMax) {\n  return outMin + (outMax - outMin) * (value - inMin) / (inMax - inMin);\n}\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying float v_alpha;\nvarying vec4 v_tint;\n\nvoid main(void) {\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\n  int instanceID = int(instanceIds);\n\n  mat4 modelMatrix = getModelMatrix(instanceID);\n  vec2 pivot = getPivot(instanceID).xy;\n  vec4 billboardData = getInstanceData(instanceID);\n  vec4 layoutData = fetchTexel(atlasBillboards_layout, int(atlasBillboards_desc.z), int(billboardData.z));\n  v_tint = getTintColor(instanceID);\n\n#else\n\n  v_tint = tintColor;\n\n#endif\n\n  vec2 quadVertex = getQuadVertexPositionFromID();\n  \n  vec2 pos = quadVertex + vec2(0.5, 0.0) - pivot;\n  v_texCoord = vec2(quadVertex.x, -quadVertex.y) + 0.5;\n  v_alpha = billboardData.w;\n  v_texCoord *= layoutData.zw;\n  v_texCoord += layoutData.xy;\n\n  float scl = billboardData.x;\n  float width = layoutData.z * atlasBillboards_desc.x * scl;\n  float height = layoutData.w * atlasBillboards_desc.y * scl;\n  int flags = int(billboardData.y);\n\n  // Use cross platform bit flags methods\n  bool alignedToCamera = testFlag(flags, 4); // flag = 1<<2\n  bool drawOnTop = testFlag(flags, 8); // flag = 1 << 3\n  bool fixedSizeOnscreen = testFlag(flags, 16); // flag = 1 << 4\n\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n  float sc = 1.0;\n  if(fixedSizeOnscreen) {\n    float dist = modelViewMatrix[3][2];\n    sc = abs(dist); // Note: items in front of the camera will have a negative value here.\n  }\n  \n  mat4 modelViewProjectionMatrix;\n  if(alignedToCamera){\n    if (inVR == 0) {\n      gl_Position = modelViewMatrix * vec4(0.0, 0.0, 0.0, 1.0);\n      gl_Position += vec4(pos.x * width * sc, (pos.y + 0.5) * height * sc, 0.0, 0.0);\n      gl_Position = projectionMatrix * gl_Position;\n    } else {\n      vec3 cameraPos = vec3(cameraMatrix[3][0], cameraMatrix[3][1], cameraMatrix[3][2]);\n      vec3 billboardPos = vec3(modelMatrix[3][0], modelMatrix[3][1], modelMatrix[3][2]);\n      mat4 lookAt = calcLookAtMatrix(billboardPos, cameraPos, 0.0);\n      mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * lookAt;\n      gl_Position = modelViewProjectionMatrix * vec4(pos.x * width * sc, (pos.y + 0.5) * height * sc, 0.0, 1.0);\n    }\n  }\n  else{\n    modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n    gl_Position = modelViewProjectionMatrix * vec4(pos.x * width, (pos.y + 0.5) * height, 0.0, 1.0);\n  }\n\n  // Use cross platform bit flags methods\n  if(drawOnTop){\n    gl_Position.z = mix(gl_Position.z, -gl_Position.w, 0.5);\n  }\n}\n'),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="materialparams.glsl"/>\n<%include file="utils/imageAtlas.glsl"/>\n\nuniform sampler2D atlasBillboards;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying float v_alpha;\nvarying vec4 v_tint;\n\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  fragColor = texture2D(atlasBillboards, v_texCoord) * v_tint;\n  fragColor.a *= v_alpha;\n\n  // fragColor.r = 1.0;\n  // fragColor.a = 1.0;\n  \n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n')}}class Xn extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER","\nprecision highp float;\n\nattribute vec3 positions;    //(location = 0)\n\nuniform mat4 modelMatrix;\nuniform mat4 lightViewMatrix;\nuniform mat4 lightProjectionMatrix;\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\n\nvoid main(void) {\n  mat4 modelViewMatrix = lightViewMatrix * modelMatrix;\n  v_viewPos = modelViewMatrix * vec4(positions, 1.0);\n  gl_Position = lightProjectionMatrix * v_viewPos;\n}\n\n"),this.setShaderStage("FRAGMENT_SHADER","\n#extension GL_OES_standard_derivatives : enable\nprecision highp float;\n\nuniform float near;\nuniform float far;\n\nvarying vec3 v_viewPos;\n\nfloat linstep(float edge0, float edge1, float value){\n  return clamp((value-edge0)/(edge1-edge0), 0.0, 1.0);\n}\n\nvoid main(void) {\n  float depth = linstep(near, far, -v_viewPos.z);\n  //gl_FragColor = vec4(depth, depth, depth,  1.0);\n\n  float dx = dFdx(depth);\n  float dy = dFdy(depth);\n  gl_FragColor = vec4(depth, pow(depth, 2.0) + 0.25*(dx*dx + dy*dy), 0.0, 1.0);\n}\n")}}class xn extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\nattribute vec3 positions;    //(location = 0)\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform vec3 projectionCenter;\n\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\n \nvoid main()\n{\n  int drawItemId = getDrawItemId();\n  vec4 pos = vec4(positions, 1.);\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n\n  gl_Position = modelViewProjectionMatrix * pos;\n\n  vec4 worldPos = modelMatrix * pos;\n  v_worldDir = worldPos.xyz - projectionCenter;\n}\n\n'),this.finalize()}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"projectionCenter",defaultValue:new di(0,0,1.7)}),e}}class In extends xn{constructor(e){super(e),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="envmap-octahedral.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\n\nuniform color envMap;\nuniform sampler2D envMapTex;\nuniform int envMapTexType;\n\n\nuniform float exposure;\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 texCoord = dirToSphOctUv(normalize(v_worldDir));\n  vec4 env = getColorParamValue(envMap, envMapTex, envMapTexType, texCoord);\n\n  fragColor = vec4(env.rgb/env.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}}oi.register("OctahedralEnvProjectionShader",In);class Vn extends xn{constructor(e){super(e),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-equirect.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\nuniform color envMap;\nuniform sampler2D envMapTex;\nuniform int envMapTexType;\n\nuniform float exposure;\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 texCoord = latLongUVsFromDir(normalize(v_worldDir));\n  vec4 env = getColorParamValue(envMap, envMapTex, envMapTexType, texCoord);\n  fragColor = vec4(env.rgb/env.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}}oi.register("LatLongEnvProjectionShader",Vn),yr.setShaderModule("calcFatLinesViewPos.glsl","\n\nvec3 calcFatLinesViewPos(int vertexID, mat4 modelViewMatrix, inout vec3 viewNormal, inout vec2 texCoord, inout vec3 pos) {\n\n  int seqentialIndex_0 = int(mod(segmentIndices.x, 2.));\n  int seqentialIndex_1 = int(mod(segmentIndices.y, 2.));\n  int index_0 = int(segmentIndices.x) / 2;\n  int index_1 = int(segmentIndices.y) / 2;\n\n  vec3 viewPos;\n  vec4 data_0 = fetchTexel(positionsTexture, positionsTextureSize, index_0);\n  vec4 data_1 = fetchTexel(positionsTexture, positionsTextureSize, index_1);\n\n  vec4 pos_0 = modelViewMatrix * vec4(data_0.xyz, 1.0);\n  vec4 pos_1 = modelViewMatrix * vec4(data_1.xyz, 1.0);\n  // Note: multiply the per-vertex line thickness with the line thickness uniform value;\n  float lineThickness_0 = LineThickness * data_0.w;\n  float lineThickness_1 = LineThickness * data_1.w;\n\n  if(vertexID < 2){\n    pos = data_0.xyz;\n    viewPos = pos_0.xyz;\n  }\n  else{\n    pos = data_1.xyz;\n    viewPos = pos_1.xyz;\n  }\n  if(pos_1 != pos_0){\n    vec3 segmentDir = normalize(pos_1.xyz - pos_0.xyz);\n    vec3 viewVector = normalize(viewPos);\n\n    if(vertexID < 2){\n      vec3 segmentStartDir = segmentDir;\n      if(seqentialIndex_0 != 0){\n        //if index_0 == 0, get the last index in the line as previous\n        int index_prev = (index_0 > 0) ? (index_0-1) : (positionsTextureSize-1);\n        vec4 data_prev = fetchTexel(positionsTexture, positionsTextureSize, index_prev);\n        vec4 pos_prev = modelViewMatrix * vec4(data_prev.xyz, 1.0);\n        segmentStartDir = normalize(segmentDir + normalize(pos_0.xyz - pos_prev.xyz));\n        // segmentStartDir = segmentDir;\n      }\n      // vec3 startBiTangent = normalize(cross(segmentStartDir, viewVector));\n      // viewNormal = normalize(cross(segmentStartDir, startBiTangent));\n      vec3 startBiTangent = normalize(vec3(-segmentStartDir.y, segmentStartDir.x, 0.0));\n      viewNormal = normalize(-viewVector);\n      // Move the endpoints to overlap a bit more.\n      //viewPos -= vec3(segmentStartDir * lineThickness_0 * 0.25);\n      if(mod(vertexIDs, 2.0) == 0.0){\n        viewPos += vec3(startBiTangent * lineThickness_0);\n        texCoord.x = 1.0;\n      }\n      else{\n        viewPos -= vec3(startBiTangent * lineThickness_0);\n        texCoord.x = 0.0;\n      }\n      texCoord.y = 0.0;\n    }\n    else{\n      vec3 segmentEndDir = segmentDir;\n      if(seqentialIndex_1 != 0){\n        //if index_1 == numPoints-1, get the first index in the line as next\n        int index_next = (index_1 < (positionsTextureSize-1)) ? (index_1+1) : 0;\n        vec4 data_next = fetchTexel(positionsTexture, positionsTextureSize, index_next);\n        vec4 pos_next = modelViewMatrix * vec4(data_next.xyz, 1.0);\n        segmentEndDir = normalize(segmentDir + normalize(pos_next.xyz - pos_1.xyz));\n        // segmentEndDir = segmentDir;\n      }\n      // vec3 endBiTangent = normalize(cross(segmentEndDir, viewVector));\n      // viewNormal = normalize(cross(segmentEndDir, endBiTangent));\n      vec3 endBiTangent = normalize(vec3(-segmentEndDir.y, segmentEndDir.x, 0.0));\n      viewNormal = normalize(-viewVector);\n      // Move the endpoints to overlap a bit more.\n      //viewPos += vec3(segmentEndDir * lineThickness_1 * 0.25);\n      if(mod(vertexIDs, 2.0) == 0.0){\n        viewPos += vec3(endBiTangent * lineThickness_1);\n        texCoord.x = 1.0;\n      }\n      else{\n        viewPos -= vec3(endBiTangent * lineThickness_1);\n        texCoord.x = 0.0;\n      }\n      texCoord.y = 1.0;\n    }\n\n    // Move the line towards the viewer by the line thickness.\n    // this is to avoid depth issues when lines are rendered over meshes. \n    viewPos.z += (lineThickness_0 + lineThickness_1) * 0.5;\n  }\n\n  return viewPos;\n}\n\n");class vn extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\ninstancedattribute vec2 segmentIndices;\nattribute float vertexIDs;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nuniform sampler2D positionsTexture;\nuniform int positionsTextureSize;\n\nuniform float LineThickness;\nuniform float Overlay;\n\n<%include file="calcFatLinesViewPos.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\nvarying vec2 v_texCoord;\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  int vertexID = int(vertexIDs);\n\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n\n  vec3 pos;\n  v_viewPos       = calcFatLinesViewPos(vertexID, modelViewMatrix, v_viewNormal, v_texCoord, pos);\n  gl_Position     = projectionMatrix * vec4(v_viewPos, 1.0);\n  \n  if(Overlay > 0.0){\n    gl_Position.z = mix(gl_Position.z, -gl_Position.w, Overlay);\n  }\n}\n'),this.setShaderStage("FRAGMENT_SHADER","\nprecision highp float;\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\nvarying vec2 v_texCoord;\n\nuniform color BaseColor;\nuniform mat4 cameraMatrix;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  int debugLevel = 0;\n  if(debugLevel == 0){\n\n    vec3 viewVector = mat3(cameraMatrix) * normalize(-v_viewPos);\n    vec3 normal = mat3(cameraMatrix) * v_viewNormal;\n    float NdotV = dot(normalize(normal), normalize(viewVector));\n\n    // Modulate the lighting using the texture coord so the line looks round.\n    NdotV *= cos((v_texCoord.x - 0.5) * 2.0);\n\n    vec4 color = BaseColor * NdotV;\n    fragColor = vec4(color.rgb, BaseColor.a);\n  }\n  else{\n    fragColor = vec4(v_texCoord.x, 0.0, 0.0, 1.0);\n  }\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n"),this.finalize()}bind(e){return!!super.bind(e)&&(e.supportsInstancing=!1,!0)}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new mi(1,1,.5)}),e.push({name:"Opacity",defaultValue:1}),e.push({name:"LineThickness",defaultValue:.01}),e.push({name:"Overlay",defaultValue:0}),e}static getGeomDataShaderName(){return"FatLinesGeomDataShader"}static supportsInstancing(){return!1}}oi.register("FatLinesShader",vn);class Rn extends vn{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\ninstancedattribute vec2 segmentIndices;\nattribute float vertexIDs;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nuniform sampler2D positionsTexture;\nuniform int positionsTextureSize;\n\nuniform float LineThickness;\nuniform float Overlay;\n\n<%include file="calcFatLinesViewPos.glsl"/>\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying float v_drawItemID;\nvarying vec3 v_worldPos;\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  v_drawItemId = float(drawItemId);\n  v_geomItemData = getInstanceData(drawItemId);\n\n  int vertexID = int(vertexIDs);\n\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n\n  vec3  viewNormal;\n  vec2  texCoord;\n  vec3  pos;\n  v_viewPos       = calcFatLinesViewPos(vertexID, modelViewMatrix, viewNormal, texCoord, pos);\n  gl_Position     = projectionMatrix * vec4(v_viewPos, 1.0);\n  \n\n  v_drawItemID = float(getDrawItemId());\n  \n  v_worldPos      = (modelMatrix * vec4(pos, 1.0)).xyz;\n\n  if(Overlay > 0.0){\n    gl_Position.z = mix(gl_Position.z, -gl_Position.w, Overlay);\n  }\n\n}\n'),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n\n<%include file="drawItemTexture.glsl"/>\n<%include file="cutaways.glsl"/>\n<%include file="GLSLBits.glsl"/>\n\nuniform int floatGeomBuffer;\nuniform int passId;\n\n#ifdef ENABLE_FLOAT_TEXTURES\nvec4 getCutaway(int id) {\n    return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 5);\n}\n\n#else\n\nuniform vec4 cutawayData;\n\nvec4 getCutaway(int id) {\n    return cutawayData;\n}\n\n#endif\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying float v_drawItemID;\nvarying vec3 v_worldPos;\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n  int drawItemId = int(v_drawItemId + 0.5);\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n  int flags = int(v_geomItemData.r + 0.5);\n  // Cutaways\n  if(testFlag(flags, GEOMITEM_FLAG_CUTAWAY)) {\n      vec4 cutAwayData   = getCutaway(drawItemId);\n      vec3 planeNormal = cutAwayData.xyz;\n      float planeDist = cutAwayData.w;\n      if(cutaway(v_worldPos, planeNormal, planeDist)){\n          discard;\n          return;\n      }\n  }\n\n    float dist = length(v_viewPos);\n\n    if(floatGeomBuffer != 0) {\n        fragColor.r = float(passId); \n        fragColor.g = float(v_drawItemID);\n        fragColor.b = 0.0;// TODO: store poly-id or something.\n        fragColor.a = dist;\n    }\n    else {\n        ///////////////////////////////////\n        // UInt8 buffer\n        fragColor.r = (mod(v_drawItemID, 256.) + 0.5) / 255.;\n        fragColor.g = (floor(v_drawItemID / 256.) + 0.5) / 255.;\n\n        // encode the dist as a 16 bit float\n        vec2 float16bits = encode16BitFloatInto2xUInt8(dist);\n        fragColor.b = float16bits.x;\n        fragColor.a = float16bits.y;\n    }\n\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}bind(e){return!!super.bind(e)&&(e.supportsInstancing=!1,!0)}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new mi(1,1,.5)}),e.push({name:"Opacity",defaultValue:1}),e.push({name:"LineThickness",defaultValue:1}),e.push({name:"Overlay",defaultValue:0}),e}}oi.register("FatLinesGeomDataShader",Rn),yr.setShaderModule("stack-gl/gamma.glsl","\n\nconst float gamma_const = 2.2;\n\nfloat toLinear(float v) {\n  return pow(v, gamma_const);\n}\n\nvec2 toLinear(vec2 v) {\n  return pow(v, vec2(gamma_const));\n}\n\nvec3 toLinear(vec3 v) {\n  return pow(v, vec3(gamma_const));\n}\n\nvec4 toLinear(vec4 v) {\n  return vec4(toLinear(v.rgb), v.a);\n}\n\n\nfloat toGamma(float v) {\n  return pow(v, 1.0 / gamma_const);\n}\n\nvec2 toGamma(vec2 v) {\n  return pow(v, vec2(1.0 / gamma_const));\n}\n\nvec3 toGamma(vec3 v) {\n  return pow(v, vec3(1.0 / gamma_const));\n}\n\nvec4 toGamma(vec4 v) {\n  return vec4(toGamma(v.rgb), v.a);\n}\n\nfloat toGamma(float v, float gamma) {\n  return pow(v, 1.0 / gamma);\n}\n\nvec2 toGamma(vec2 v, float gamma) {\n  return pow(v, vec2(1.0 / gamma));\n}\n\nvec3 toGamma(vec3 v, float gamma) {\n  return pow(v, vec3(1.0 / gamma));\n}\n\nvec4 toGamma(vec4 v, float gamma) {\n  return vec4(toGamma(v.rgb, gamma), v.a);\n}\n\n\n");class wn extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\nattribute vec3 positions;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  v_drawItemId = float(drawItemId);\n  v_geomItemData  = getInstanceData(drawItemId);\n\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n\n    vec4 viewPos = (modelViewMatrix * vec4(positions, 1.0));\n    gl_Position = projectionMatrix * viewPos;\n\n    v_viewPos = viewPos.xyz;\n#ifdef ENABLE_TEXTURES\n    v_textureCoord = texCoords;\n    v_textureCoord.y = 1.0 - v_textureCoord.y;// Flip y\n#endif\n}\n'),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n\n<%include file="GLSLUtils.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\n#ifndef ENABLE_MULTI_DRAW\n\nuniform color BaseColor;\n\n#ifdef ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n#endif\n\n\n#endif // ENABLE_MULTI_DRAW\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\nvoid main(void) {\n\n  //////////////////////////////////////////////\n  // Material\n\n#ifdef ENABLE_MULTI_DRAW\n\n  vec2 materialCoords = v_geomItemData.zw;\n  vec4 baseColor = toLinear(getMaterialValue(materialCoords, 0));\n\n#else // ENABLE_MULTI_DRAW\n\n#ifndef ENABLE_TEXTURES\n  vec4 baseColor = toLinear(BaseColor);\n#else\n  vec4 baseColor = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, v_textureCoord);\n#endif // ENABLE_TEXTURES\n\n#endif // ENABLE_MULTI_DRAW\n  //////////////////////////////////////////////\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n  fragColor = baseColor;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  fragColor.rgb = toGamma(fragColor.rgb);\n#endif\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new mi(1,1,.5)}),e}static getPackedMaterialData(e){const t=new Float32Array(8),i=e.getParameter("BaseColor").getValue();return t[0]=i.r,t[1]=i.g,t[2]=i.b,t[3]=i.a,t}static getGeomDataShaderName(){return"StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return"StandardSurfaceSelectedGeomsShader"}}oi.register("FlatSurfaceShader",wn);class Mn extends Xr{constructor(e){super(e,"LinesShader"),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\nattribute vec3 positions;\n\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n#ifdef ENABLE_MULTI_DRAW\n<%include file="materialparams.glsl"/>\n#else\nuniform float Overlay;\n#endif\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_worldPos;\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  v_drawItemId = float(drawItemId);\n  v_geomItemData  = getInstanceData(drawItemId);\n\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n  gl_Position = modelViewProjectionMatrix * vec4(positions, 1.0);\n    \n\n  //////////////////////////////////////////////\n  // Overlay\n\n#ifdef ENABLE_MULTI_DRAW\n  vec2 materialCoords = v_geomItemData.zw;\n  vec4 materialValue1 = getMaterialValue(materialCoords, 1);\n  int maintainScreenSize = int(materialValue1.x + 0.5);\n  float overlay = materialValue1.y;\n#else\n  float overlay = Overlay;\n#endif\n\ngl_Position.z = mix(gl_Position.z, -gl_Position.w, overlay);\n\n  //////////////////////////////////////////////\n  \n  \n  vec4 pos = vec4(positions, 1.);\n  v_worldPos      = (modelMatrix * pos).xyz;\n}\n'),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="cutaways.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\n\n#ifndef ENABLE_MULTI_DRAW\n\nuniform color BaseColor;\nuniform float Opacity;\n\n#endif // ENABLE_MULTI_DRAW\n\n\n#ifdef ENABLE_FLOAT_TEXTURES\nvec4 getCutaway(int id) {\n    return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 5);\n}\n\n#else\n\nuniform vec4 cutawayData;\n\nvec4 getCutaway(int id) {\n    return cutawayData;\n}\n\n#endif\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_worldPos;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  int drawItemId = int(v_drawItemId + 0.5);\n  int flags = int(v_geomItemData.r + 0.5);\n\n  // Cutaways\n  if(testFlag(flags, GEOMITEM_FLAG_CUTAWAY)) \n  {\n      vec4 cutAwayData   = getCutaway(drawItemId);\n      vec3 planeNormal = cutAwayData.xyz;\n      float planeDist = cutAwayData.w;\n      if(cutaway(v_worldPos, planeNormal, planeDist)){\n          discard;\n          return;\n      }\n  }\n\n\n  //////////////////////////////////////////////\n  // Material\n\n#ifdef ENABLE_MULTI_DRAW\n\n  vec2 materialCoords = v_geomItemData.zw;\n  vec4 baseColor = getMaterialValue(materialCoords, 0);\n  vec4 matValue1 = getMaterialValue(materialCoords, 1);\n  float opacity  = matValue1.r;\n\n#else // ENABLE_MULTI_DRAW\n\n  vec4 baseColor = BaseColor;\n  float opacity = Opacity;\n\n#endif // ENABLE_MULTI_DRAW\n  //////////////////////////////////////////////\n  \n  fragColor = baseColor;\n  fragColor.a *= opacity;\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new mi(1,1,.5)}),e.push({name:"Opacity",defaultValue:.7}),e.push({name:"Overlay",defaultValue:1e-5}),e}static getPackedMaterialData(e){const t=new Float32Array(8),i=e.getParameter("BaseColor").getValue();return t[0]=i.r,t[1]=i.g,t[2]=i.b,t[3]=i.a,t[4]=e.getParameter("Opacity").getValue(),t[5]=e.getParameter("Overlay").getValue(),t}static getGeomDataShaderName(){return"StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return"StandardSurfaceSelectedGeomsShader"}bind(e,t){const i=super.bind(e,t),s=this.__gl;return s.enable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),i}unbind(e){const t=super.unbind(e),i=this.__gl;return i.disable(i.BLEND),t}}oi.register("LinesShader",Mn);class Tn extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\ninstancedattribute vec3 positions;\ninstancedattribute vec3 normals;\nattribute vec2 vertexIDs;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\nuniform float normalLength;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n\n/* VS Outputs */\nvarying float v_weight;\n\nvoid main(void) {\n  mat4 modelMatrix = getModelMatrix(transformIndex);\n  mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n  if(vertexIDs.x == 0.0){\n    gl_Position = modelViewProjectionMatrix * vec4(positions, 1.0);\n    v_weight = 1.0;\n  }\n  else{\n    gl_Position = modelViewProjectionMatrix * vec4(positions+(normals*normalLength), 1.0);\n    v_weight = 0.0;\n  }\n}\n'),this.setShaderStage("FRAGMENT_SHADER","\nprecision highp float;\n\nuniform color normalColor;\n\n/* VS Outputs */\nvarying float v_weight;\n\n\nvoid main(void) {\n  gl_FragColor = normalColor;\n  gl_FragColor.a = v_weight;\n}\n")}}class Ln extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\nattribute vec3 positions;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n#ifdef ENABLE_MULTI_DRAW\n<%include file="materialparams.glsl"/>\n#else\nuniform float PointSize;\nuniform float Overlay;\n#endif\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  v_drawItemId = float(drawItemId);\n  v_geomItemData  = getInstanceData(drawItemId);\n\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n  \n  vec4 viewPos = modelViewMatrix * vec4(positions, 1.);\n  gl_Position = projectionMatrix * viewPos;\n  \n\n  //////////////////////////////////////////////\n  // Material\n#ifdef ENABLE_MULTI_DRAW\n  vec2 materialCoords = v_geomItemData.zw;\n  vec4 materialValue1 = getMaterialValue(materialCoords, 1);\n  int maintainScreenSize = int(materialValue1.x + 0.5);\n  float pointSize = materialValue1.x;\n  float overlay = materialValue1.y;\n#else\n  float pointSize = PointSize;\n  float overlay = Overlay;\n#endif\n  //////////////////////////////////////////////\n\n  // Note: as of 22/01/2021 gl_PointSize has stopped working again...\n  gl_PointSize = pointSize;\n\n#if defined(DRAW_GEOMDATA)\n  // Make the geom data point size at least 8 pixels across, else its impossible to hit.\n  gl_PointSize = max(8.0, pointSize);\n#endif\n  gl_Position.z = mix(gl_Position.z, -gl_Position.w, overlay);\n\n  \n  v_viewPos = -viewPos.xyz;\n}\n'),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n\n#ifndef ENABLE_MULTI_DRAW\n\nuniform color BaseColor;\n\n#endif\n\n<%include file="math/constants.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="cutaways.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\n#if defined(DRAW_GEOMDATA)\n\nuniform int floatGeomBuffer;\nuniform int passId;\n\n#elif defined(DRAW_HIGHLIGHT)\n\n#ifdef ENABLE_FLOAT_TEXTURES\nvec4 getHighlightColor(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 4);\n}\n#else // ENABLE_FLOAT_TEXTURES\n\nuniform vec4 highlightColor;\n\nvec4 getHighlightColor() {\n    return highlightColor;\n}\n\n#endif // ENABLE_FLOAT_TEXTURES\n\n#endif // DRAW_HIGHLIGHT\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\n/* VS Outputs */\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  //////////////////////////////////////////////\n  // Color\n#if defined(DRAW_COLOR)\n\n#ifdef ENABLE_MULTI_DRAW\n\n  vec2 materialCoords = v_geomItemData.zw;\n  vec4 baseColor = getMaterialValue(materialCoords, 0);\n  vec4 matValue1 = getMaterialValue(materialCoords, 1);\n  float pointSize       = baseColor.a * matValue1.r;\n  float overlay      = matValue1.g;\n\n#else // ENABLE_MULTI_DRAW\n\n  vec4 baseColor = BaseColor;\n\n#endif // ENABLE_MULTI_DRAW\n\n  fragColor = baseColor;\n\n  //////////////////////////////////////////////\n  // GeomData\n#elif defined(DRAW_GEOMDATA)\n\n  float viewDist = length(v_viewPos);\n\n  if(floatGeomBuffer != 0) {\n    fragColor.r = float(passId); \n    fragColor.g = float(v_drawItemId);\n    fragColor.b = 0.0;// TODO: store poly-id or something.\n    fragColor.a = viewDist;\n  }\n\n  //////////////////////////////////////////////\n  // Highlight\n#elif defined(DRAW_HIGHLIGHT)\n  \n  int drawItemId = int(v_drawItemId + 0.5);\n  fragColor = getHighlightColor(drawItemId);\n\n#endif // DRAW_HIGHLIGHT\n\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n')}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new mi(1,1,.5)}),e.push({name:"PointSize",defaultValue:2}),e.push({name:"Overlay",defaultValue:2e-5}),e}static getPackedMaterialData(e){const t=new Float32Array(12),i=e.getParameter("BaseColor").getValue();return t[0]=i.r,t[1]=i.g,t[2]=i.b,t[3]=i.a,t[4]=e.getParameter("PointSize").getValue(),t[5]=e.getParameter("Overlay").getValue(),t}}oi.register("PointsShader",Ln);class Sn extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\ninstancedattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform float PointSize;\nuniform float Overlay;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying vec3 v_viewPos;\nvarying float v_drawItemId;\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  vec2 quadPointPos = getQuadVertexPositionFromID();\n  v_texCoord = quadPointPos + 0.5;\n\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n  \n  vec4 viewPos = modelViewMatrix * vec4(positions, 1.);\n\n  viewPos += vec4(vec3(quadPointPos, 0.0) * PointSize, 0.);\n\n  // Generate a quad which is 0.5 * PointSize closer towards\n  // us. This allows points to be visualized even if snug on \n  // a surface. (else they get fully clipped)\n  viewPos.z += 0.5 * PointSize;\n\n  v_drawItemId = float(getDrawItemId());\n  v_viewPos = -viewPos.xyz;\n  \n  gl_Position = projectionMatrix * viewPos;\n  if(Overlay > 0.0){\n    gl_Position.z = mix(gl_Position.z, -gl_Position.w, Overlay);\n  }\n}\n'),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n\nuniform color BaseColor;\nuniform float Rounded;\nuniform float BorderWidth;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying vec3 v_viewPos;\nvarying float v_drawItemId;\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  float dist = length(v_texCoord - 0.5);\n  if(dist > 0.5)\n    discard;\n  if(dist > 0.5 - (BorderWidth * 0.5))\n    fragColor = vec4(0.,0.,0.,1.);\n  else {\n    // Modulate the lighting using the texture coord so the point looks round.\n    float NdotV = cos(dist * PI);\n\n    fragColor = BaseColor * mix(1.0, NdotV, Rounded);\n  }\n  \n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n')}bind(e){return!!super.bind(e)&&(e.supportsInstancing=!1,!0)}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new mi(1,1,.5)}),e.push({name:"PointSize",defaultValue:.05}),e.push({name:"Rounded",defaultValue:1}),e.push({name:"BorderWidth",defaultValue:.2}),e.push({name:"Overlay",defaultValue:0}),e}static getGeomDataShaderName(){return"FatPointsGeomDataShader"}static getSelectedShaderName(){return"FatPointsSelectedShader"}static supportsInstancing(){return!1}}class Zn extends Sn{constructor(e){super(e),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLBits.glsl"/>\n\nuniform int floatGeomBuffer;\nuniform int passId;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying vec3 v_viewPos;\nvarying float v_drawItemId;\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  float dist = length(v_texCoord - 0.5);\n  if(dist > 0.5)\n    discard;\n    \n\n  float viewDist = length(v_viewPos);\n\n  if(floatGeomBuffer != 0) {\n    fragColor.r = float(passId); \n    fragColor.g = float(v_drawItemId);\n    fragColor.b = 0.0;// TODO: store poly-id or something.\n    fragColor.a = viewDist;\n  }\n  else {\n    ///////////////////////////////////\n    // UInt8 buffer\n    fragColor.r = (mod(v_drawItemId, 256.) + 0.5) / 255.;\n    fragColor.g = (floor(v_drawItemId / 256.) + 0.5) / 255.;\n\n    // encode the dist as a 16 bit float\n    vec2 float16bits = encode16BitFloatInto2xUInt8(viewDist);\n    fragColor.b = float16bits.x;\n    fragColor.a = float16bits.y;\n  }\n\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n')}}class Cn extends Sn{constructor(e){super(e),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLBits.glsl"/>\n\nuniform int floatGeomBuffer;\nuniform int passId;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying vec3 v_viewPos;\nvarying float v_drawItemId;\n\n\n<%include file="drawItemTexture.glsl"/>\n\n#ifdef ENABLE_FLOAT_TEXTURES\nvec4 getHighlightColor(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 4);\n}\n#else\n\nuniform vec4 highlightColor;\n\nvec4 getHighlightColor() {\n    return highlightColor;\n}\n\n#endif\n\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  float dist = length(v_texCoord - 0.5);\n  if(dist > 0.5)\n    discard;\n  \n  int drawItemId = int(v_drawItemId + 0.5);\n  fragColor = getHighlightColor(drawItemId);\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n')}}oi.register("FatPointsShader",Sn),oi.register("FatPointsGeomDataShader",Zn),oi.register("FatPointsSelectedShader",Cn),yr.setShaderModule("computeViewNormal.glsl","\nvec3 computeViewNormal(vec3 viewPos) {\n  vec3 fdx = dFdx(viewPos);\n  vec3 fdy = dFdy(viewPos);\n  return normalize(cross(fdx, fdy));\n}\n");class Fn extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\n\nattribute vec3 positions;\nattribute vec3 normals;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\nvarying vec3 v_worldPos;\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n    v_drawItemId = float(drawItemId);\n    v_geomItemData  = getInstanceData(drawItemId);\n\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n\n    vec4 pos = vec4(positions, 1.);\n    vec4 viewPos    = modelViewMatrix * pos;\n    gl_Position     = projectionMatrix * viewPos;\n\n    mat3 normalMatrix = mat3(transpose(inverse(modelViewMatrix)));\n    v_viewPos       = -viewPos.xyz;\n    v_viewNormal    = normalMatrix * normals;\n\n#ifdef ENABLE_TEXTURES\n    v_textureCoord  = texCoords;\n    // v_textureCoord.y = 1.0 - v_textureCoord.y;// Flip y\n#endif\n\n    v_worldPos      = (modelMatrix * pos).xyz;\n}\n'),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n#ifdef ENABLE_MULTI_DRAW\n// #define DEBUG_GEOM_ID\n#endif\n\n<%include file="math/constants.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="cutaways.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\n#ifdef DEBUG_GEOM_ID\n<%include file="debugColors.glsl"/>\n#endif\n\nuniform color cutColor;\n\n#ifdef ENABLE_FLOAT_TEXTURES\nvec4 getCutaway(int id) {\n    return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 5);\n}\n\n#else\n\nuniform vec4 cutawayData;\n\nvec4 getCutaway(int id) {\n    return cutawayData;\n}\n\n#endif\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\nuniform mat4 cameraMatrix;\n\n#ifndef ENABLE_MULTI_DRAW\n\nuniform color BaseColor;\nuniform float Opacity;\nuniform float EmissiveStrength;\n\n#ifdef ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\nuniform sampler2D OpacityTex;\nuniform int OpacityTexType;\nuniform sampler2D EmissiveStrengthTex;\nuniform int EmissiveStrengthTexType;\n#endif // ENABLE_TEXTURES\n\n#endif // ENABLE_MULTI_DRAW\n\n<%include file="computeViewNormal.glsl"/>\n  \n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\n\nvoid main(void) {\n    int drawItemId = int(v_drawItemId + 0.5);\n\n    int flags = int(v_geomItemData.r + 0.5);\n    // Cutaways\n    if(testFlag(flags, GEOMITEM_FLAG_CUTAWAY)) \n    {\n        vec4 cutAwayData   = getCutaway(drawItemId);\n        vec3 planeNormal = cutAwayData.xyz;\n        float planeDist = cutAwayData.w;\n        if(cutaway(v_worldPos, planeNormal, planeDist)){\n            discard;\n            return;\n        }\n        else if(!gl_FrontFacing){\n#ifdef ENABLE_ES3\n            fragColor = cutColor;\n#else\n            gl_FragColor = cutColor;\n#endif\n            return;\n        }\n    }\n\n    //////////////////////////////////////////////\n    // Normals\n    \n    vec3 viewNormal;\n    if (length(v_viewNormal) < 0.1) {\n      viewNormal = computeViewNormal(v_viewPos);\n    } else {\n      viewNormal = normalize(v_viewNormal);\n    }\n    vec3 normal = normalize(mat3(cameraMatrix) * viewNormal);\n    vec3 viewVector = normalize(mat3(cameraMatrix) * normalize(v_viewPos));\n\n    //////////////////////////////////////////////\n    // Material\n\n#ifdef ENABLE_MULTI_DRAW\n\n    vec2 materialCoords = v_geomItemData.zw;\n    vec4 baseColor = toLinear(getMaterialValue(materialCoords, 0));\n    vec4 matValue1 = getMaterialValue(materialCoords, 1);\n    float opacity       = baseColor.a * matValue1.r;\n    float emission      = matValue1.g;\n\n#else // ENABLE_MULTI_DRAW\n\n#ifndef ENABLE_TEXTURES\n    vec4 baseColor      = toLinear(BaseColor);\n    float emission      = EmissiveStrength;\n    float opacity       = baseColor.a * Opacity;\n#else\n    vec4 baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, v_textureCoord);\n    float opacity       = baseColor.a * getLuminanceParamValue(Opacity, OpacityTex, OpacityTexType, v_textureCoord);\n    float emission      = getLuminanceParamValue(EmissiveStrength, EmissiveStrengthTex, EmissiveStrengthTexType, v_textureCoord);\n#endif\n\n#endif // ENABLE_MULTI_DRAW\n\n    // Hacky simple irradiance. \n    float ndotv = dot(normal, viewVector);\n    if(ndotv < 0.0){\n        normal = -normal;\n        ndotv = dot(normal, viewVector);\n\n        // Note: these 2 lines can be used to debug inverted meshes.\n        //baseColor = vec4(1.0, 0.0, 0.0, 1.0);\n        //ndotv = 1.0;\n    }\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = vec4((ndotv * baseColor.rgb) + (emission * baseColor.rgb), opacity);\n\n#ifdef DEBUG_GEOM_ID\n    // ///////////////////////\n    // Debug Draw ID (this correlates to GeomID within a GLGeomSet)\n    float geomId = v_geomItemData.w;\n    fragColor.rgb = getDebugColor(geomId);\n    // ///////////////////////\n#endif\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new mi(1,1,.5)}),e.push({name:"Opacity",defaultValue:1,range:[0,1]}),e.push({name:"EmissiveStrength",defaultValue:0,range:[0,1]}),e}static getPackedMaterialData(e){const t=new Float32Array(8),i=e.getParameter("BaseColor").getValue();return t[0]=i.r,t[1]=i.g,t[2]=i.b,t[3]=i.a,t[4]=e.getParameter("Opacity").getValue(),t[5]=e.getParameter("EmissiveStrength").getValue(),t}static getGeomDataShaderName(){return"StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return"StandardSurfaceSelectedGeomsShader"}}oi.register("SimpleSurfaceShader",Fn),yr.setShaderModule("math/constants.glsl","\n\n#define PI 3.141592653589793\n#define TwoPI (2.0 * PI)\n#define HalfPI (0.5 * PI)\n\n\n\n\n"),yr.setShaderModule("GGX_Specular.glsl"," "),yr.setShaderModule("SHCoeffs.glsl","\n  uniform vec3 shCoeffs[9];\n  \n  vec3 sampleSHCoeffs(vec3 dir) {\n    // dir is assumed to have unit length\n    float x = dir.x, y = dir.y, z = dir.z;\n    // band 0\n    vec3 result = shCoeffs[ 0 ] * 0.886227;\n    // band 1\n    result += shCoeffs[ 1 ] * 2.0 * 0.511664 * y;\n    result += shCoeffs[ 2 ] * 2.0 * 0.511664 * z;\n    result += shCoeffs[ 3 ] * 2.0 * 0.511664 * x;\n    // band 2\n    result += shCoeffs[ 4 ] * 2.0 * 0.429043 * x * y;\n    result += shCoeffs[ 5 ] * 2.0 * 0.429043 * y * z;\n    result += shCoeffs[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n    result += shCoeffs[ 7 ] * 2.0 * 0.429043 * x * z;\n    result += shCoeffs[ 8 ] * 0.429043 * ( x * x - y * y );\n    return result;\n  }\n"),yr.setShaderModule("PBRSurfaceRadiance.glsl","\nconst int ENVMAP_FLAG_HEADLIGHT =  1; // 1<<0;\n\nstruct MaterialParams {\n  vec3 baseColor;\n  float ambientOcclusion;\n  float metallic;\n  float roughness;\n  float reflectance;\n  float opacity;\n  float emission;\n};\n\n#ifndef ENABLE_PBR\n\nvec4 pbrSurfaceRadiance(in MaterialParams material, vec3 normal, in vec3 viewVector) {\n  vec3 irradiance = vec3(dot(normal, viewVector));\n  float ao = material.ambientOcclusion; \n  return vec4(material.baseColor * ao * irradiance + (material.emission * material.baseColor), material.opacity);\n\n  // return vec4(material.baseColor * ao * irradiance , material.opacity);\n}\n\n#else\n\nuniform int envMapFlags;\nuniform samplerCube irradianceMap;\nuniform samplerCube prefilterMap;\nuniform sampler2D brdfLUT;\n\nvec3 sampleIrradiance(vec3 dir) {\n  return texture(irradianceMap, dir).rgb;\n}\n\n\nvec3 fresnelSchlickRoughness(float cosTheta, vec3 F0, float roughness) {\n    return F0 + (max(vec3(1.0 - roughness), F0) - F0) * pow(max(1.0 - cosTheta, 0.0), 5.0);\n}\n\nfloat luminance(vec3 color) {\n  return 0.2126 * color.r + 0.7152 * color.g + 0.0722 * color.b;\n}\n\nvec4 pbrSurfaceRadiance(in MaterialParams material, vec3 normal, in vec3 viewVector) {\n\n    vec3 N = normal;\n    vec3 V = viewVector;\n    vec3 R = reflect(-V, N);\n    float roughness = material.roughness * material.roughness;\n    vec3 diffuseColor = (1.0 - material.metallic) * material.baseColor;\n\n    // Note: The specular reflectance of metallic surfaces is chromatic\n    // https://google.github.io/filament/Filament.html#listing_fnormal\n    vec3 F0 = 0.16 * material.reflectance * material.reflectance * (1.0 - material.metallic) + material.baseColor * material.metallic;\n\n    float NdotV = dot(N, V);\n\n    vec3 F = fresnelSchlickRoughness(max(NdotV, 0.0), F0, roughness);\n\n    vec3 kS = F;\n    vec3 kD = 1.0 - kS;\n    kD *= 1.0 - material.metallic;\n    float ao = material.ambientOcclusion; \n    \n    vec3 irradiance;\n    vec3 irradianceSampleDir = normal;\n    \n    bool headLightMode = testFlag(envMapFlags, ENVMAP_FLAG_HEADLIGHT);\n    if (headLightMode) {\n      irradianceSampleDir = viewVector;\n    }\n    irradiance = sampleIrradiance(irradianceSampleDir);\n   // vec3 irradiance = shGetIrradianceAt(shCoefficients, N);\n    vec3 diffuse    = irradiance * diffuseColor;\n    \n    const float MAX_REFLECTION_LOD = 4.0;\n    vec3 prefilteredColor = textureLod(prefilterMap, R,  roughness * MAX_REFLECTION_LOD).rgb;   \n    vec2 envBRDF  = texture(brdfLUT, vec2(max(NdotV, 0.0), roughness)).rg;\n    vec3 specular = prefilteredColor * (F * envBRDF.x + envBRDF.y);\n    \n    vec3 radiance = (kD * diffuse + specular) * ao;\n    \n    // Now handle semi-transparent objects. We need to be able to linearly interpolate\n    // opacity to make objects disappear, so we need a continuous change.\n    float opacity = material.opacity;\n    vec4 transparent = vec4((radiance * opacity) + specular, opacity + luminance(specular) + luminance(F));\n    vec4 result = mix(transparent, vec4(radiance, 1.0), opacity);\n\n    // Add emission on as the final component.\n    // Note: emission allows a material to blend off its specular component, \n    // which can also be used to make an object completely disappear if also transparent.\n    return mix(result, vec4(material.baseColor, opacity), material.emission);\n}\n\n\n#endif // ENABLE_PBR\n"),yr.setShaderModule("utils/imageAtlas.glsl","\n\n// Note: On mobile, I can't seem to pass around a stuct containing sampler2D.\n// I have to unpack the struct and pass its members. :(\n// struct ImageAtlas {\n//     sampler2D layout;\n//     sampler2D image;\n//     vec4 desc;\n// };\n\n\n\nvec4 getSubImageLayout(int index, in sampler2D atlasLayout, in vec4 atlasDesc){\n    return fetchTexel(atlasLayout, int(floor(atlasDesc.z+0.5)), index);\n}\n\nvec2 calcSubImageTexCoords(vec2 texCoord, int index, in sampler2D atlasLayout, in vec4 atlasDesc){\n    vec4 layoutData = fetchTexel(atlasLayout, int(floor(atlasDesc.z+0.5)), index);\n    // The following line is a hack to fix artifacts in our PBR lighting\n    // We were seeing loads of lighting garbage on some sufaces that were orthogonal\n    // to the world. The UV coordinates would have been landing right on the edges\n    // of our subimages and were often sampling outside the image. This couuld\n    // have been because of filtering, or an error in the uv coords. \n    texCoord = clamp(texCoord, vec2(0.01, 0.01), vec2(0.99, 0.99));\n    vec2 subimageTexel = texCoord * layoutData.zw;\n    // subimageTexel = clamp(subimageTexel, vec2(0.0, 0.0), vec2(1.0, 1.0));\n    return subimageTexel + layoutData.xy;\n}\n\nvec4 sampleSubImage(vec2 texCoord, int index, in sampler2D atlasLayout, in sampler2D atlasImage, in vec4 atlasDesc){\n    vec4 layoutData = fetchTexel(atlasLayout, int(floor(atlasDesc.z+0.5)), index);\n    vec2 atlasCoords = calcSubImageTexCoords(texCoord, index, atlasLayout, atlasDesc);\n    return texture2D(atlasImage, atlasCoords);\n}\n\n"),yr.setShaderModule("utils/imagePyramid.glsl",'\n\n<%include file="utils/imageAtlas.glsl"/>\n\nvec4 sampleImagePyramid(vec2 uv, float lod, in sampler2D atlasLayout, in sampler2D atlasImage, in vec4 atlasDesc){\n  if (lod < 0.00001 || lod > 0.9999) {\n    float imageIndex = lod * (atlasDesc.z-1.0);\n    int imageId0 = int(imageIndex);\n    return sampleSubImage(uv, imageId0, atlasLayout, atlasImage, atlasDesc);\n  } else {\n    float imageIndex = lod * (atlasDesc.z-1.0);\n    int imageId0 = int(floor(imageIndex));\n    int imageId1 = imageId0+1;\n    float blend = fract(imageIndex);\n    vec4 c0 = sampleSubImage(uv, imageId0, atlasLayout, atlasImage, atlasDesc);\n    vec4 c1 = sampleSubImage(uv, imageId1, atlasLayout, atlasImage, atlasDesc);\n    return mix(c0, c1, blend);\n  } \n}\n\n\n'),yr.setShaderModule("cutaways.glsl","\n\nconst int GEOMITEM_FLAG_CUTAWAY =  1; // 1<<0;\n\n\n#define RAY_EPS 0.0000001\nstruct Ray {\n    vec3 start;\n    vec3 dir;\n};\n\nfloat intersectRayPlane(Ray ray, Ray plane) {\n    vec3 w = ray.start - plane.start;\n    float D = dot(plane.dir, ray.dir);\n    float N = dot(-plane.dir, w);\n\n    if (abs(D) < RAY_EPS) {\n        // segment is parallel to plane\n        if (N == 0.0)\n            return -1.0; // segment lies in plane\n        else\n            return -1.0; // no intersection\n    }\n    // they are not parallel\n    // compute intersect param\n    float sI = N / D;\n    if (sI < -RAY_EPS) {\n        return -1.0; // no intersection\n    }\n    return sI;\n}\n\n\nbool cutaway(vec3 worldPos, vec3 planeNormal, float planeDist) {\n\n    vec3 planePos = planeNormal * planeDist;\n    vec3 planeDir = worldPos + planePos;\n    float planeOffset = dot(planeDir, planeNormal);\n    if(planeOffset > 0.0){\n        return true;\n    }\n    return  false;\n}\n");class En extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\nattribute vec3 positions;\nattribute vec3 normals;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  v_drawItemId = float(drawItemId);\n  v_geomItemData = getInstanceData(drawItemId);\n\n  vec4 pos = vec4(positions, 1.);\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n  vec4 viewPos    = modelViewMatrix * pos;\n  gl_Position     = projectionMatrix * viewPos;\n\n  mat3 normalMatrix = mat3(transpose(inverse(modelViewMatrix)));\n  v_viewPos       = -viewPos.xyz;\n  v_viewNormal    = normalMatrix * normals;\n\n#ifdef ENABLE_TEXTURES\n  v_textureCoord  = texCoords;\n#endif\n\n  v_worldPos      = (modelMatrix * pos).xyz;\n}\n'),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n#ifdef ENABLE_MULTI_DRAW\n// #define DEBUG_GEOM_ID\n#endif\n\n<%include file="math/constants.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="cutaways.glsl"/>\n\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\n#ifdef DEBUG_GEOM_ID\n<%include file="debugColors.glsl"/>\n#endif\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\n\nuniform color cutColor;\n\n#ifdef ENABLE_FLOAT_TEXTURES\nvec4 getCutaway(int id) {\n    return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 5);\n}\n\n#else\n\nuniform vec4 cutawayData;\n\nvec4 getCutaway(int id) {\n    return cutawayData;\n}\n\n#endif\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\nuniform mat4 cameraMatrix;\n\n#ifndef ENABLE_MULTI_DRAW\n\nuniform color BaseColor;\nuniform float AmbientOcclusion;\nuniform float Roughness;\nuniform float Metallic;\nuniform float Reflectance;\nuniform float EmissiveStrength;\nuniform float Opacity;\n\n#ifdef ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n\nuniform sampler2D AmbientOcclusionTex;\nuniform int AmbientOcclusionTexType;\n\n#ifdef ENABLE_PBR\nuniform sampler2D RoughnessTex;\nuniform int RoughnessTexType;\n\nuniform sampler2D MetallicTex;\nuniform int MetallicTexType;\n\nuniform sampler2D ReflectanceTex;\nuniform int ReflectanceTexType;\n\nuniform sampler2D NormalTex;\nuniform int NormalTexType;\n#endif // ENABLE_PBR\n\nuniform sampler2D EmissiveStrengthTex;\nuniform int EmissiveStrengthTexType;\n\n#endif // ENABLE_TEXTURES\n#endif // ENABLE_MULTI_DRAW\n\n<%include file="PBRSurfaceRadiance.glsl"/>\n\n#ifdef ENABLE_PBR\nmat3 cotangentFrame( in vec3 normal, in vec3 pos, in vec2 texCoord ) {\n  // https://stackoverflow.com/questions/5255806/how-to-calculate-tangent-and-binormal\n  vec3 n = normal;\n  // derivations of the fragment position\n  vec3 pos_dx = dFdx( pos );\n  vec3 pos_dy = dFdy( pos );\n  // derivations of the texture coordinate\n  vec2 texC_dx = dFdx( texCoord );\n  vec2 texC_dy = dFdy( texCoord );\n  // tangent vector and binormal vector\n  vec3 t = -(texC_dy.y * pos_dx - texC_dx.y * pos_dy);\n  vec3 b = -(texC_dx.x * pos_dy - texC_dy.x * pos_dx);\n\n  t = t - n * dot( t, n ); // orthonormalization ot the tangent vectors\n  b = b - n * dot( b, n ); // orthonormalization of the binormal vectors to the normal vector\n  b = b - t * dot( b, t ); // orthonormalization of the binormal vectors to the tangent vector\n  mat3 tbn = mat3( normalize(t), normalize(b), n );\n\n  return tbn;\n}\n#endif\n\n<%include file="computeViewNormal.glsl"/>\n\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n    int drawItemId = int(v_drawItemId + 0.5);\n\n    int flags = int(v_geomItemData.r + 0.5);\n    // Cutaways\n    if(testFlag(flags, GEOMITEM_FLAG_CUTAWAY)) {\n        vec4 cutAwayData   = getCutaway(drawItemId);\n        vec3 planeNormal = cutAwayData.xyz;\n        float planeDist = cutAwayData.w;\n        if(cutaway(v_worldPos, planeNormal, planeDist)){\n            discard;\n            return;\n        }\n        else if(!gl_FrontFacing){\n#ifdef ENABLE_ES3\n            fragColor = cutColor;\n#else\n            gl_FragColor = cutColor;\n#endif\n            return;\n        }\n    }\n\n    //////////////////////////////////////////////\n    // Normals\n    vec3 viewNormal;\n    if (length(v_viewNormal) < 0.1) {\n      viewNormal = computeViewNormal(v_viewPos);\n    } else {\n      viewNormal = normalize(v_viewNormal);\n    }\n    vec3 normal = normalize(mat3(cameraMatrix) * viewNormal);\n    vec3 viewVector = normalize(mat3(cameraMatrix) * normalize(v_viewPos));\n    if(dot(normal, viewVector) < 0.0){\n        normal = -normal;\n        // Note: this line can be used to debug inverted meshes.\n        //material.baseColor = vec3(1.0, 0.0, 0.0);\n    }\n\n    //////////////////////////////////////////////\n    // Material\n\n    MaterialParams material;\n\n#ifdef ENABLE_MULTI_DRAW\n    vec2 materialCoords = v_geomItemData.zw;\n    vec4 matValue0      = getMaterialValue(materialCoords, 0);\n    vec4 matValue1      = getMaterialValue(materialCoords, 1);\n    vec4 matValue2      = getMaterialValue(materialCoords, 2);\n\n    material.baseColor     = toLinear(matValue0.rgb);\n    material.ambientOcclusion      = matValue1.r;\n    material.metallic      = matValue1.g;\n    material.roughness     = matValue1.b;\n    material.reflectance   = matValue1.a;\n\n    material.emission         = matValue2.r;\n    material.opacity          = matValue2.g * matValue0.a;\n\n#else // ENABLE_MULTI_DRAW\n\n#ifndef ENABLE_TEXTURES\n    material.baseColor     = toLinear(BaseColor.rgb);\n    material.emission      = EmissiveStrength;\n\n#ifdef ENABLE_PBR\n    material.roughness     = Roughness;\n    material.metallic      = Metallic;\n    material.reflectance   = Reflectance;\n#endif\n\n#else\n    // Planar YZ projection for texturing, repeating every meter.\n    // vec2 texCoord       = v_worldPos.xz * 0.2;\n    vec2 texCoord          = v_textureCoord;\n\n    vec4 baseColor         = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, texCoord);\n    material.ambientOcclusion = getLuminanceParamValue(AmbientOcclusion, AmbientOcclusionTex, AmbientOcclusionTexType, texCoord);\n    material.baseColor     = baseColor.rgb;\n    \n#ifdef ENABLE_PBR\n\n    material.metallic      = getLuminanceParamValue(Metallic, MetallicTex, MetallicTexType, texCoord);\n    material.roughness     = getLuminanceParamValue(Roughness, RoughnessTex, RoughnessTexType, texCoord);\n\n    // TODO: Communicate that this tex contains the roughness as well.\n    if (MetallicTexType != 0) {\n      vec4 metallicRoughness = vec4(Metallic, Roughness, 0.0, 1.0);\n      metallicRoughness     = texture2D(MetallicTex, texCoord);\n      material.roughness     = metallicRoughness.g;\n      material.metallic     = metallicRoughness.b;\n    }\n\n    material.reflectance   = getLuminanceParamValue(Reflectance, ReflectanceTex, ReflectanceTexType, texCoord);\n#endif // ENABLE_PBR\n    material.emission         = getLuminanceParamValue(EmissiveStrength, EmissiveStrengthTex, EmissiveStrengthTexType, texCoord);\n#endif // ENABLE_TEXTURES\n    material.opacity       = Opacity * baseColor.a;\n\n#ifdef ENABLE_TEXTURES\n#ifdef ENABLE_PBR\n    if(NormalTexType != 0) {\n        mat3 tbn = cotangentFrame(normal, viewVector, texCoord);\n        normal = normalize(tbn * (texture2D(NormalTex, texCoord).rgb * 2.0 - 1.0));\n    }\n#endif // ENABLE_PBR\n#endif // ENABLE_TEXTURES\n#endif // ENABLE_MULTI_DRAW\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n    fragColor = pbrSurfaceRadiance(material, normal, viewVector);\n    // fragColor = vec4(texture2D(NormalTex, texCoord).rgb, 1.0);\n    // fragColor = metallicRoughness;\n    // fragColor = vec4(material.baseColor, 1.0);;\n    // fragColor = vec4(vec3(material.metallic), 1.0);;\n    // fragColor = vec4(vec3(material.roughness), 1.0);;\n    // fragColor = vec4(vec3(material.ambientOcclusion), 1.0);\n    \n#ifdef DEBUG_GEOM_ID\n    // ///////////////////////\n    // Debug Draw ID (this correlates to GeomID within a GLGeomSet)\n    float geomId = v_geomItemData.w;\n    fragColor.rgb = getDebugColor(geomId);\n    // ///////////////////////\n#endif\n\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new mi(1,1,.5)}),e.push({name:"AmbientOcclusion",defaultValue:1,range:[0,1]}),e.push({name:"Metallic",defaultValue:.05,range:[0,1]}),e.push({name:"Roughness",defaultValue:.5,range:[0,1]}),e.push({name:"Reflectance",defaultValue:.5,range:[0,1]}),e.push({name:"Normal",defaultValue:new mi(.5,.5,.5)}),e.push({name:"EmissiveStrength",defaultValue:0,range:[0,1]}),e.push({name:"Opacity",defaultValue:1,range:[0,1]}),e}bind(e,t){super.bind(e,t);const i=this.__gl;e.envMap&&e.envMap.bind(e);const{exposure:s}=e.unifs;return s&&i.uniform1f(s.location,e.exposure),!0}static getPackedMaterialData(e){const t=new Float32Array(12),i=e.getParameter("BaseColor").getValue();return t[0]=i.r,t[1]=i.g,t[2]=i.b,t[3]=i.a,t[4]=e.getParameter("AmbientOcclusion").getValue(),t[5]=e.getParameter("Metallic").getValue(),t[6]=e.getParameter("Roughness").getValue(),t[7]=e.getParameter("Reflectance").getValue(),t[8]=e.getParameter("EmissiveStrength").getValue(),t[9]=e.getParameter("Opacity").getValue(),t}static getGeomDataShaderName(){return"StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return"StandardSurfaceSelectedGeomsShader"}}oi.register("StandardSurfaceShader",En),oi.register("TransparentSurfaceShader",En),yr.setShaderModule("GLSLBits.glsl",'\n    \n/////////////////////////////////////////////////////////////////\n// http://concord-consortium.github.io/lab/experiments/webgl-gpgpu/script.js\nfloat shift_right(float v, float amt) {\n  v = floor(v) + 0.5;\n  return floor(v / exp2(amt));\n}\nfloat shift_left(float v, float amt) {\n  return floor(v * exp2(amt) + 0.5);\n}\n\nfloat mask_last(float v, float bits) {\n  return mod(v, shift_left(1.0, bits));\n}\nfloat extract_bits(float num, float from, float to) {\n  from = floor(from + 0.5);\n  to = floor(to + 0.5);\n  return mask_last(shift_right(num, from), to - from);\n}\n\n/////////////////////////////////////////////////////////////////\n// https://stackoverflow.com/questions/18453302/how-do-you-pack-one-32bit-int-into-4-8bit-ints-in-glsl-webgl\n\nconst vec4 bitEnc = vec4(1.,255.,65025.,16581375.);\nconst vec4 bitDec = 1./bitEnc;\nvec4 EncodeFloatRGBA (float v) {\n    vec4 enc = bitEnc * v;\n    enc = fract(enc);\n    enc -= enc.yzww * vec2(1./255., 0.).xxxy;\n    return enc;\n}\nfloat DecodeFloatRGBA (vec4 v) {\n    return dot(v, bitDec);\n}\n\n\n\n/////////////////////////////////////////////////////////////////\n// https://gist.github.com/Flexi23/1713774\n// \nvec2 encode16BitFloatInto2xUInt8(float v){\n    vec2 c = vec2(0.);\n\n    int signum = (v >= 0.) ? 128 : 0;\n    v = abs(v);\n    int exponent = 15;\n    float limit = 1024.; // considering the bias from 2^-5 to 2^10 (==1024)\n    for(int exp = 15; exp > 0; exp--){\n        if( v < limit){\n            limit /= 2.;\n            exponent--;\n        }\n    }\n\n    float rest;\n    if(exponent == 0){\n        rest = v / limit / 2.;      // "subnormalize" implicite preceding 0. \n    }else{\n        rest = (v - limit)/limit;   // normalize accordingly to implicite preceding 1.\n    }\n\n    int mantissa = int(rest * 2048.);   // 2048 = 2^11 for the (split) 11 bit mantissa\n    int msb = mantissa / 256;           // the most significant 3 bits go into the lower part of the first byte\n    int lsb = mantissa - msb * 256;     // there go the other 8 bit of the lower significance\n\n    c.x = float(signum + exponent * 8 + msb) / 255.;    // color normalization for texture2D\n    c.y = float(lsb) / 255.;\n\n    if(v >= 2048.){\n        c.y = 1.;\n    }\n\n    return c;\n}\n\nfloat decode16BitFloatFrom2xUInt8(vec2 c){\n    float v = 0.;\n\n    int ix = int(c.x*255.); // 1st byte: 1 bit signum, 4 bits exponent, 3 bits mantissa (MSB)\n    int iy = int(c.y*255.); // 2nd byte: 8 bit mantissa (LSB)\n\n    int s = (c.x >= 0.5) ? 1 : -1;\n    ix = (s > 0) ? ix - 128 : ix;   // remove the signum bit from exponent\n    int iexp = ix / 8;              // cut off the last 3 bits of the mantissa to select the 4 exponent bits\n    int msb = ix - iexp * 8;        // subtract the exponent bits to select the 3 most significant bits of the mantissa\n\n    int norm = (iexp == 0) ? 0 : 2048;          // distinguish between normalized and subnormalized numbers\n    int mantissa = norm + msb * 256 + iy;       // implicite preceding 1 or 0 added here\n    norm = (iexp == 0) ? 1 : 0;                 // normalization toggle\n    float exponent = pow( 2., float(iexp + norm) - 16.); // -5 for the the exponent bias from 2^-5 to 2^10 plus another -11 for the normalized 12 bit mantissa \n    v = float( s * mantissa ) * exponent;\n\n    return v;\n}\n\n\n// TODO : Encoding Float32 to 4x UInt8\n// http://concord-consortium.github.io/lab/experiments/webgl-gpgpu/script.js\n// http://ultraist.hatenablog.com/entry/20110608/1307539319\n\n');class zn extends Xr{constructor(e,t){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\nattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_worldPos;\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  v_drawItemId = float(drawItemId);\n  v_geomItemData = getInstanceData(drawItemId);\n\n  vec4 pos = vec4(positions, 1.);\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n  vec4 viewPos = modelViewMatrix * pos;\n  gl_Position = projectionMatrix * viewPos;\n\n  v_viewPos = -viewPos.xyz;\n\n  v_worldPos      = (modelMatrix * pos).xyz;\n}\n'),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n\n<%include file="drawItemTexture.glsl"/>\n<%include file="math/constants.glsl"/>\n<%include file="cutaways.glsl"/>\n<%include file="GLSLBits.glsl"/>\n\nuniform int floatGeomBuffer;\nuniform int passId;\n\n#ifdef ENABLE_FLOAT_TEXTURES\nvec4 getCutaway(int id) {\n    return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 5);\n}\n\n#else\n\nuniform vec4 cutawayData;\n\nvec4 getCutaway(int id) {\n    return cutawayData;\n}\n\n#endif\n\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_worldPos;\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n  int drawItemId = int(v_drawItemId + 0.5);\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n  int flags = int(v_geomItemData.r + 0.5);\n  // Cutaways\n  if(testFlag(flags, GEOMITEM_FLAG_CUTAWAY)) {\n      vec4 cutAwayData   = getCutaway(drawItemId);\n      vec3 planeNormal = cutAwayData.xyz;\n      float planeDist = cutAwayData.w;\n      if(cutaway(v_worldPos, planeNormal, planeDist)){\n          discard;\n          return;\n      }\n  }\n\n    float dist = length(v_viewPos);\n\n    if(floatGeomBuffer != 0) {\n        fragColor.r = float(passId);\n        fragColor.g = float(drawItemId) - 0.1;\n        fragColor.b = 0.0;// TODO: store poly-id or something.\n        fragColor.a = dist;\n    }\n    else {\n        ///////////////////////////////////\n        // UInt8 buffer\n        fragColor.r = mod(v_drawItemId, 256.) / 256.;\n        fragColor.g = (floor(v_drawItemId / 256.) + (float(passId) * 64.)) / 256.;\n\n\n        // encode the dist as a 16 bit float\n        vec2 float16bits = encode16BitFloatInto2xUInt8(dist);\n        fragColor.b = float16bits.x;\n        fragColor.a = float16bits.y;\n    }\n\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n')}}oi.register("StandardSurfaceGeomDataShader",zn);class Nn extends Xr{constructor(e,t){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\nattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nvarying float v_drawItemId;\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n    v_drawItemId = float(drawItemId);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n    vec4 viewPos = modelViewMatrix * vec4(positions, 1.0);\n    gl_Position = projectionMatrix * viewPos;\n\n}\n'),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n\nvarying float v_drawItemId;\n\n\n<%include file="drawItemTexture.glsl"/>\n\n#ifdef ENABLE_FLOAT_TEXTURES\nvec4 getHighlightColor(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 4);\n}\n#else\n\nuniform vec4 highlightColor;\n\nvec4 getHighlightColor(int id) {\n    return highlightColor;\n}\n\n#endif\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    int drawItemId = int(v_drawItemId + 0.5);\n    fragColor = getHighlightColor(drawItemId);\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n')}}oi.register("StandardSurfaceSelectedGeomsShader",Nn);class Pn extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\nattribute vec3 positions;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  v_drawItemId = float(drawItemId);\n  v_geomItemData  = getInstanceData(drawItemId);\n\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n\n  gl_Position = (modelMatrix * vec4(positions, 1.0));\n\n  v_textureCoord = texCoords;\n  v_textureCoord.y = 1.0 - v_textureCoord.y;// Flip y\n}\n'),this.setShaderStage("FRAGMENT_SHADER",'\nprecision highp float;\n\n#ifdef ENABLE_MULTI_DRAW\n<%include file="math/constants.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n#endif\n\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\n#ifndef ENABLE_MULTI_DRAW\n\nuniform color BaseColor;\n\n#ifdef ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n#endif\n\n#endif // ENABLE_MULTI_DRAW\n\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n  \n\n  //////////////////////////////////////////////\n  // Material\n\n#ifdef ENABLE_MULTI_DRAW\n\nvec2 materialCoords = v_geomItemData.zw;\nvec4 baseColor = getMaterialValue(materialCoords, 0);\n\n#else // ENABLE_MULTI_DRAW\n\n#ifndef ENABLE_TEXTURES\n    vec4 baseColor = BaseColor;\n#else\n    vec4 baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, v_textureCoord);\n#endif\n\n#endif // ENABLE_MULTI_DRAW\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = baseColor;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static isOverlay(){return!0}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new mi(1,1,.5)}),e}static getPackedMaterialData(e){const t=new Float32Array(8),i=e.getParameter("BaseColor").getValue();return t[0]=i.r,t[1]=i.g,t[2]=i.b,t[3]=i.a,t}static getGeomDataShaderName(){return null}static getSelectedShaderName(){return null}}oi.register("ScreenSpaceShader",Pn);class Wn extends cr{constructor(){super()}init(e,t){super.init(e,t)}itemAddedToScene(e,t){if(!(e instanceof va))return!1;{const t=e;if(!this.filterGeomItem(t))return!1;this.addGeomItem(t),t.setMetadata("glpass",this)}}itemRemovedFromScene(e,t){return e instanceof va&&e.getMetadata("glpass")==this&&this.removeGeomItem(e)}filterGeomItem(e){return!0}constructShaders(e){let t,i;const s=this.__renderer.getOrCreateShader(e);return s.constructor.getGeomDataShaderName()&&(t=this.__renderer.getOrCreateShader(s.constructor.getGeomDataShaderName())),s.constructor.getSelectedShaderName()&&(i=this.__renderer.getOrCreateShader(s.constructor.getSelectedShaderName())),{glShader:s,glgeomdatashader:t,glselectedshader:i}}getGeomItemAndDist(e){let t,i;this.__gl.floatGeomBuffer?(t=Math.round(e[1]),i=e[3]):(t=e[0]+((63&e[1])<<8),i=jt.decode16BitFloatFrom2xUInt8([e[2],e[3]]));const s=this.renderer.glGeomItemLibrary.getGeomItem(t);if(s)return{geomItem:s,dist:i}}}class Bn extends Jt{constructor(e){super(),this.renderer=e,this.gl=e.gl,this.glGeomItems=[],this.glGeomIdsMapping={},this.glgeomItemEventHandlers=[],this.freeIndices=[],this.dirtyDrawGeomIds=[],this.drawElementCounts=new Int32Array(0),this.drawElementOffsets=new Int32Array(0),this.highlightElementCounts=new Int32Array(0),this.highlightElementOffsets=new Int32Array(0),this.reserved=0,this.visibleItems=[],this.drawIdsArray=new Float32Array(0),this.drawIdsBufferDirty=!0,this.drawIdsTexture=null,this.highlightedItems=[],this.highlightedIdsArray=null,this.highlightedIdsTexture=null,this.highlightedIdsBufferDirty=!0,this.renderer.glGeomLibrary.on("geomDataChanged",(e=>{const t=this.glGeomIdsMapping[e.index];null!=t&&t.forEach((e=>{const t=this.glGeomItems[e];if(t.isVisible()){const e=this.visibleItems.indexOf(t),i=this.renderer.glGeomLibrary.getGeomOffsetAndCount(t.geomId);this.drawElementOffsets[e]=i[0],this.drawElementCounts[e]=i[1];const s=this.highlightedItems.indexOf(t);-1!=s&&(this.highlightElementOffsets[s]=i[0],this.highlightElementCounts[s]=i[1])}}))}))}addGLGeomItem(e){const t=this.freeIndices.length>0?this.freeIndices.pop():this.glGeomItems.length;this.glGeomIdsMapping[e.geomId]?this.glGeomIdsMapping[e.geomId].push(t):this.glGeomIdsMapping[e.geomId]=[t];const i={};e.isVisible()&&this.visibleItems.push(e),i.visibilityChanged=t=>{t.visible?this.visibleItems.push(e):this.visibleItems.splice(this.visibleItems.indexOf(e),1),this.drawIdsBufferDirty=!0,this.emit("updated")},e.on("visibilityChanged",i.visibilityChanged),e.geomItem.isHighlighted()&&(this.highlightedItems.push(e),this.highlightedIdsBufferDirty=!0),i.highlightChanged=t=>{if(t&&t.name){if(this.highlightedItems.includes(e))return;this.highlightedItems.push(e)}else this.highlightedItems.splice(this.highlightedItems.indexOf(e),1);this.highlightedIdsBufferDirty=!0,this.emit("updated")},e.geomItem.on("highlightChanged",i.highlightChanged),this.glGeomItems[t]=e,this.glgeomItemEventHandlers[t]=i,e.geomItem.setMetadata("geomItemSet",this),this.drawIdsBufferDirty=!0,this.emit("updated")}removeGLGeomItem(e){const t=this.glGeomItems.indexOf(e),i=this.glGeomIdsMapping[e.geomId];i.splice(i.indexOf(t),1);const s=this.glgeomItemEventHandlers[t];if(e.geomItem.off("highlightChanged",s.highlightChanged),e.off("visibilityChanged",s.visibilityChanged),this.glGeomItems[t]=null,this.glgeomItemEventHandlers[t]=null,this.drawElementOffsets[t]=0,this.drawElementCounts[t]=0,this.freeIndices.push(t),e.isVisible()){const t=this.visibleItems.indexOf(e);this.visibleItems.splice(t,1),this.drawIdsBufferDirty=!0}if(e.geomItem.isHighlighted()){const t=this.visibleItems.indexOf(e);this.highlightedItems.splice(t,1),this.highlightedIdsBufferDirty=!0}this.emit("updated")}getHighlightedIdsArray(){if(this.highlightedIdsBufferDirty){(!this.highlightedIdsArray||this.highlightedItems.length>this.highlightedIdsArray.length)&&(this.highlightedIdsArray=new Float32Array(this.highlightedItems.length),this.highlightElementOffsets=new Uint32Array(this.highlightedItems.length),this.highlightElementCounts=new Uint32Array(this.highlightedItems.length)),this.highlightedItems.forEach(((e,t)=>{this.highlightedIdsArray[t]=e.drawItemId;const i=this.renderer.glGeomLibrary.getGeomOffsetAndCount(e.geomId);this.highlightElementOffsets[t]=i[0],this.highlightElementCounts[t]=i[1]}));for(let e=this.highlightedItems.length;e<this.highlightElementCounts.length;e++)this.highlightElementOffsets[e]=0,this.highlightElementCounts[e]=0;this.highlightedIdsBufferDirty=!1}return this.highlightedIdsArray}updateDrawIDsBuffer(e){const t=this.renderer.gl,i=e.boundTextures++;t.activeTexture(t.TEXTURE0+i);const s=jt.nextPow2(Math.ceil(Math.sqrt(this.visibleItems.length)));this.drawIdsTexture?(this.drawIdsTexture.width<s||this.drawIdsTexture.height<s)&&this.drawIdsTexture.resize(s,s):this.drawIdsTexture=new pr(t,{format:"RED",internalFormat:"R32F",type:"FLOAT",width:s,height:s,filter:"NEAREST",wrap:"CLAMP_TO_EDGE",mipMapped:!1}),(!this.drawIdsArray||this.visibleItems.length>this.drawIdsArray.length)&&(this.drawIdsArray=new Float32Array(this.visibleItems.length),this.drawElementOffsets=new Int32Array(this.visibleItems.length),this.drawElementCounts=new Int32Array(this.visibleItems.length)),this.visibleItems.forEach(((e,t)=>{const i=this.renderer.glGeomLibrary.getGeomOffsetAndCount(e.geomId);this.drawElementOffsets[t]=i[0],this.drawElementCounts[t]=i[1],this.drawIdsArray[t]=e.drawItemId}));for(let e=this.visibleItems.length;e<this.drawElementCounts.length;e++)this.drawElementOffsets[e]=0,this.drawElementCounts[e]=0;this.dirtyDrawGeomIds=[];{const e=this.drawIdsTexture,i=this.drawIdsTexture.width;t.bindTexture(t.TEXTURE_2D,e.glTex);const s=0,a=0,r=1,n=e.__format,o=e.__type,l=Math.ceil((a+this.drawIdsArray.length)/i);let h=0,d=this.drawIdsArray.length,c=a;for(let e=0;e<l;e++){let e;c+d>i?(e=i-c,c=0):e=d;const a=h%i,l=Math.floor(h/i),u=this.drawIdsArray.subarray(h,h+e);t.texSubImage2D(t.TEXTURE_2D,s,a,l,e,r,n,o,u),h+=e,d-=e}}t.bindTexture(t.TEXTURE_2D,null),e.boundTextures--,this.drawIdsBufferDirty=!1}updateHighlightedIDsBuffer(e){const t=this.renderer.gl,i=e.boundTextures++;t.activeTexture(t.TEXTURE0+i);const s=this.getHighlightedIdsArray(),a=jt.nextPow2(Math.ceil(Math.sqrt(this.highlightedItems.length)));this.highlightedIdsTexture?(this.highlightedIdsTexture.width<a||this.highlightedIdsTexture.height<a)&&this.highlightedIdsTexture.resize(a,a):this.highlightedIdsTexture=new pr(t,{format:"RED",internalFormat:"R32F",type:"FLOAT",width:a,height:a,filter:"NEAREST",wrap:"CLAMP_TO_EDGE",mipMapped:!1});{const e=this.highlightedIdsTexture,i=this.highlightedIdsTexture.width;t.bindTexture(t.TEXTURE_2D,e.glTex);const a=0,r=0,n=1,o=e.__format,l=e.__type,h=Math.ceil((r+s.length)/i);let d=0,c=s.length,u=r;for(let e=0;e<h;e++){let e;u+c>i?(e=i-u,u=0):e=c;const r=d%i,h=Math.floor(d/i),m=s.subarray(d,d+e);t.texSubImage2D(t.TEXTURE_2D,a,r,h,e,n,o,l,m),d+=e,c-=e}}t.bindTexture(t.TEXTURE_2D,null),e.boundTextures--}draw(e){0!=this.visibleItems.length&&(this.drawIdsBufferDirty&&this.updateDrawIDsBuffer(e),this.drawIdsTexture.bindToUniform(e,e.unifs.drawIdsTexture),this.__bindAndRender(e,this.drawElementCounts,this.drawElementOffsets))}drawHighlighted(e){0!=this.highlightedItems.length&&(this.highlightedIdsBufferDirty&&this.updateHighlightedIDsBuffer(e),this.highlightedIdsTexture.bindToUniform(e,e.unifs.drawIdsTexture),this.__bindAndRender(e,this.highlightElementCounts,this.highlightElementOffsets))}__bindAndRender(e,t,i){const s=this.gl,a=e.unifs;s.floatTexturesSupported&&s.drawElementsInstanced&&e.supportsInstancing?(a.instancedDraw&&s.uniform1i(e.unifs.instancedDraw.location,1),e.bindViewports(a,(()=>{this.multiDraw(t,i)}))):(e.unifs.instancedDraw&&s.uniform1i(e.unifs.instancedDraw.location,0),t.forEach((s=>{this.glGeomItems[s].bind(e),e.bindViewports(a,(()=>{this.singleDraw(t[s],i[s])}))})))}sortItems(e){const t=[],i=[];this.visibleItems.forEach(((s,a)=>{if(s){const r=s.geomItem.getGeomMat4().translation.distanceTo(e);t.push(r),i.push(a)}})),i.sort(((e,i)=>t[i]-t[e]));const s=[],a=new Int32Array(this.drawElementCounts.length),r=new Int32Array(this.drawElementOffsets.length);i.forEach(((e,t)=>{s[t]=this.visibleItems[e],a[t]=this.drawElementCounts[e],r[t]=this.drawElementOffsets[e],this.drawIdsArray[t]=this.visibleItems[e].drawItemId})),this.visibleItems=s,this.drawElementCounts=a,this.drawElementOffsets=r,this.drawIdsBufferDirty=!0}destroy(){this.drawIdsTexture&&this.drawIdsTexture.destroy(),this.highlightedIdsTexture&&this.highlightedIdsTexture.destroy(),this.emit("destructing")}}class Yn extends Bn{singleDraw(e,t){const i=this.gl;i.drawElements(i.LINES,e,i.UNSIGNED_INT,t)}multiDraw(e,t){const i=this.gl;i.multiDrawElements(i.LINES,e,0,i.UNSIGNED_INT,t,0,e.length)}}class An extends Bn{singleDraw(e,t){const i=this.gl;i.drawArrays(i.POINTS,t,e)}multiDraw(e,t){const i=this.gl;i.multiDrawArrays(i.POINTS,t,0,e,0,e.length)}}class Dn extends Bn{singleDraw(e,t){const i=this.gl;i.drawElements(i.TRIANGLES,e,i.UNSIGNED_INT,t)}multiDraw(e,t){const i=this.gl;i.multiDrawElements(i.TRIANGLES,e,0,i.UNSIGNED_INT,t,0,e.length)}}class kn extends Jt{constructor(e,t,i){super(),this.pass=e,this.gl=t,this.glShader=i.glShader,this.glGeomDataShader=i.glgeomdatashader?i.glgeomdatashader:i.glShader,this.glHighlightShader=i.glselectedshader?i.glselectedshader:i.glShader,this.glGeomItemSets={},this.glShaderKey=i.glShader.getId()+"multidraw-draw",this.glGeomDataShader&&(this.glGeomDataShaderKey=this.glGeomDataShader.getId()+"multidraw-geomdata"),this.glHighlightShader&&(this.glHighlightShaderKey=this.glHighlightShader.getId()+"multidraw-highlight")}getOrCreateGLGeomItemSet(e){let t;if(e instanceof Ms||e instanceof Zs){if(this.glGeomItemSets.GLMesh)return this.glGeomItemSets.GLMesh;t=new Dn(this.pass.renderer),this.glGeomItemSets.GLMesh=t}else if(e instanceof ws||e instanceof Ss){if(this.glGeomItemSets.GLLines)return this.glGeomItemSets.GLLines;t=new Yn(this.pass.renderer),this.glGeomItemSets.GLLines=t}else{if(!(e instanceof Rs||e instanceof Ls))throw new Error("Unsupported geom type:"+e.constructor.name);if(this.glGeomItemSets.GLPoints)return this.glGeomItemSets.GLPoints;t=new An(this.pass.renderer),this.glGeomItemSets.GLPoints=t}return e.setMetadata("glGeomItemSet",t),t.on("updated",(()=>{this.emit("updated")})),t}addGLGeomItem(e){const t=e.geomItem,i=t.getParameter("Geometry").getValue(),s=e.geomItem.getParameter("Material").getValue();this.pass.renderer.glMaterialLibrary.addMaterial(s);const a=e=>{i instanceof ws||i instanceof Rs||i instanceof Ls||i instanceof Ss||(s.off("transparencyChanged",a),t.getParameter("Material").off("valueChanged",a),t.getParameter("Geometry").off("valueChanged",a),this.pass.removeGeomItem(t),this.pass.__renderer.assignTreeItemToGLPass(t))};s.on("transparencyChanged",a),t.getParameter("Material").on("valueChanged",a),t.getParameter("Geometry").on("valueChanged",a);this.getOrCreateGLGeomItemSet(i).addGLGeomItem(e)}bindShader(e,t,i){if(e.isCompiledForTarget(i)||(t.shaderopts.directives.push("#define ENABLE_MULTI_DRAW 1\n#extension GL_ANGLE_multi_draw : enable"),e.compileForTarget(i,t.shaderopts),t.shaderopts.directives.pop()),!e.bind(t,i))throw new Error("Unable to bind shader:"+e);this.pass.renderer.glGeomItemLibrary.bind(t),this.pass.renderer.glGeomLibrary.bind(t),this.pass.renderer.glMaterialLibrary.bind(t)}draw(e){this.bindShader(this.glShader,e,this.glShaderKey);for(const t in this.glGeomItemSets)this.glGeomItemSets[t].draw(e);this.glShader.unbind(e)}drawHighlightedGeoms(e){if(this.glHighlightShader){this.bindShader(this.glHighlightShader,e,this.glHighlightShaderKey);for(const t in this.glGeomItemSets)this.glGeomItemSets[t].drawHighlighted(e);this.glHighlightShader.unbind(e)}}drawGeomData(e){this.bindShader(this.glGeomDataShader,e,this.glGeomDataShaderKey);const t=e.gl,i=e.unifs;i.floatGeomBuffer&&t.uniform1i(i.floatGeomBuffer.location,1),i.passId&&t.uniform1i(i.passId.location,e.passIndex);for(const t in this.glGeomItemSets)this.glGeomItemSets[t].draw(e);this.glGeomDataShader.unbind(e)}sortItems(e){for(const t in this.glGeomItemSets)this.glGeomItemSets[t].sortItems(e)}}class Kn extends Wn{constructor(){super(),this.__glshadermaterials={},this.__glShaderGeomSets={}}init(e,t){super.init(e,t)}getPassType(){return dr.OPAQUE}filterGeomItem(e){const t=e.getParameter("Geometry").getValue();if(t instanceof ws||t instanceof Rs||t instanceof Ls||t instanceof Ss)return!0;const i=e.getParameter("Material").getValue();return this.checkMaterial(i)}checkMaterial(e){return!e.isTransparent()}removeAndReAddGeomItem(e){this.removeGeomItem(e),this.__renderer.assignTreeItemToGLPass(e)}addGeomItem(e){const t=e.getParameter("Material"),i=t.getValue();if(this.__gl.multiDrawElementsInstanced&&!i.isTextured()){const t=i.getShaderName(),s=oi.getBlueprint(t);if(s.supportsInstancing()&&s.getPackedMaterialData){let i=this.__glShaderGeomSets[t];if(!i){const e=this.constructShaders(t);if(i=new kn(this,this.__gl,e),i.on("updated",(()=>{this.__renderer.requestRedraw()})),this.__glShaderGeomSets[t]=i,this.__glShaderGeomSets.LinesShader){const e=this.__glShaderGeomSets.LinesShader;delete this.__glShaderGeomSets.LinesShader,this.__glShaderGeomSets.LinesShader=e}}const s=this.renderer.glGeomItemLibrary.getGLGeomItem(e);return i.addGLGeomItem(s),this.emit("updated"),!0}}const s=this.renderer.glGeomLibrary.constructGLGeom(e.getParameter("Geometry").getValue()),a=this.renderer.glGeomItemLibrary.getGLGeomItem(e),r=()=>{this.removeGeomItem(e),this.__renderer.assignTreeItemToGLPass(e)};t.on("valueChanged",r),e.setMetadata("materialChanged",r);const n=i.getShaderName(),o=this.renderer.glMaterialLibrary.getGLMaterial(i);let l=this.__glshadermaterials[n];if(!l){const e=this.constructShaders(n);l=new on(this.__gl,this,e),this.__glshadermaterials[n]=l,l.on("updated",(()=>{this.__renderer.requestRedraw()}))}return l.addGLGeomItem(a,s,o),!0}removeGeomItem(e){const t=this.renderer.glGeomItemLibrary.getGLGeomItem(e),i=e.getMetadata("geomItemSet");i&&(i.removeGLGeomItem(t),e.deleteMetadata("geomItemSet"));const s=e.getParameter("Material"),a=e.getMetadata("materialChanged");return s&&a&&(s.off("valueChanged",a),e.deleteMetadata("materialChanged")),!0}removeMaterial(e){const t=this.__glshadermaterials[e.hash];if(!t||t!=e.getMetadata("glshaderMaterials"))return void console.warn("Material not found in pass");const i=e.getMetadata("glMaterialGeomItemSets");t.removeMaterialGeomItemSets(i)}__traverseTreeAndDraw(e){for(const t in this.__glShaderGeomSets)this.__glShaderGeomSets[t].draw(e);for(const t in this.__glshadermaterials)this.__glshadermaterials[t].draw(e);e.glGeom&&e.glGeom.unbind(e)}draw(e){const t=this.__gl;t.disable(t.BLEND),t.disable(t.CULL_FACE),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.depthMask(!0),this.__traverseTreeAndDraw(e)}drawHighlightedGeoms(e){const t=this.__gl;t.disable(t.CULL_FACE),e.drawItemsTexture=this.__drawItemsTexture;for(const t in this.__glShaderGeomSets)this.__glShaderGeomSets[t].drawHighlightedGeoms(e);for(const t in this.__glshadermaterials){this.__glshadermaterials[t].drawHighlightedGeoms(e)}e.glGeom&&e.glGeom.unbind(e)}drawGeomData(e){e.passIndex=this.passIndex;const t=this.__gl;t.disable(t.BLEND),t.disable(t.CULL_FACE),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.depthMask(!0);for(const t in this.__glShaderGeomSets)this.__glShaderGeomSets[t].drawGeomData(e);for(const t in this.__glshadermaterials){this.__glshadermaterials[t].drawGeomData(e)}e.glGeom&&e.glGeom.unbind(e)}}yn.registerPass(Kn,dr.OPAQUE);class Hn extends Wn{constructor(){super()}init(e,t){super.init(e,t),this.itemCount=0,this.__glShaderGeomSets={},this.transparentItems=[],this.transparentItemIndices={},this.freeList=[],this.visibleItems=[],this.prevSortCameraPos=new di(999,999,999),this.sortCameraMovementDistance=.25,this.reSort=!1,this.resortNeeded=this.resortNeeded.bind(this)}getPassType(){return dr.TRANSPARENT}filterGeomItem(e){const t=e.getParameter("Geometry").getValue();if(t instanceof ws||t instanceof Rs||t instanceof Ls||t instanceof Ss)return!1;return e.getParameter("Material").getValue().isTransparent()}resortNeeded(){this.reSort=!0}addGeomItem(e){this.itemCount++;const t=e.getParameter("Material"),i=t.getValue(),s=i.getShaderName();if(this.__gl.multiDrawElementsInstanced){const t=oi.getBlueprint(s);if(!i.isTextured()&&t.supportsInstancing()&&t.getPackedMaterialData){let t=this.__glShaderGeomSets[s];if(!t){const e=this.constructShaders(s);t=new kn(this,this.__gl,e),t.on("updated",(()=>{this.__renderer.requestRedraw()})),this.__glShaderGeomSets[s]=t}const i=this.renderer.glGeomItemLibrary.getGLGeomItem(e);return t.addGLGeomItem(i),i.on("visibilityChanged",this.resortNeeded),this.emit("updated"),void(this.reSort=!0)}}const a=this.renderer.glGeomLibrary.constructGLGeom(e.getParameter("Geometry").getValue()),r=this.renderer.glGeomItemLibrary.getGLGeomItem(e),n=this.constructShaders(s),o=this.renderer.glMaterialLibrary.getGLMaterial(i),l=()=>{i.off("valueChanged",l),i.off("transparencyChanged",l),t.off("valueChanged",l),this.removeGeomItem(e),this.__renderer.assignTreeItemToGLPass(e)};i.on("valueChanged",l),i.on("transparencyChanged",l),t.on("valueChanged",l);const h=e=>{if(e.visible)this.visibleItems.push(c);else{const e=this.visibleItems.indexOf(c);this.visibleItems.splice(e,1)}this.reSort=!0};r.on("visibilityChanged",h);const d=()=>{this.reSort=!0};e.getParameter("GeomMat").on("valueChanged",d);const c={geomItem:e,shaders:n,glGeom:a,glMaterial:o,glGeomItem:r,material:i,materialChanged:l,visibilityChanged:h,geomMatChanged:d};let u;u=this.freeList.length>0?this.freeList.pop():this.transparentItems.length,this.transparentItems[u]=c,this.transparentItemIndices[e.getId()]=u,e.isVisible()&&this.visibleItems.push(c),this.reSort=!0}removeGeomItem(e){this.itemCount--;const t=this.renderer.glGeomItemLibrary.getGLGeomItem(e),i=e.getMetadata("geomItemSet");if(i)i.removeGLGeomItem(t),e.deleteMetadata("geomItemSet"),t.off("visibilityChanged",this.resortNeeded);else{const i=this.transparentItemIndices[e.getId()],s=this.transparentItems[i];delete this.transparentItemIndices[e.getId()],t.off("visibilityChanged",s.visibilityChanged),e.getParameter("GeomMat").off("valueChanged",s.geomMatChanged),this.transparentItems[i]=null,this.freeList.push(i);const a=this.visibleItems.indexOf(s);-1!=a&&this.visibleItems.splice(a,1)}this.emit("updated")}sortItems(e){for(const t in this.__glShaderGeomSets)this.__glShaderGeomSets[t].sortItems(e);for(const t of this.visibleItems){const i=t.glGeomItem.geomItem.getGeomMat4();t.dist=i.translation.distanceTo(e)}this.visibleItems.sort(((e,t)=>e.dist>t.dist?-1:e.dist<t.dist?1:0)),this.reSort=!1}_drawItem(e,t,i){if(i.currentGLMaterial!=t.glMaterial&&(i.currentGLMaterial=t.glMaterial,!i.currentGLMaterial.bind(e)))return;if(i.currentGLGeom!=t.glGeom&&(i.currentGLGeom=t.glGeom,!i.currentGLGeom.bind(e)))return;t.glGeomItem.bind(e)&&e.bindViewports(e.unifs,(()=>{i.currentGLGeom.draw(e)}))}_drawItems(e){for(const t in this.__glShaderGeomSets)this.__glShaderGeomSets[t].draw(e);const t={currentglShader:null,currentGLMaterial:null,currentGLGeom:null};for(const i of this.visibleItems){const s=i.shaders.glShader;if(t.currentglShader!=s){if(!s.bind(e))continue;const i=this.__gl,a=e.unifs;a.instancedDraw&&i.uniform1i(a.instancedDraw.location,0),this.renderer.glGeomItemLibrary.bind(e),t.currentglShader=s}this._drawItem(e,i,t)}}draw(e){if(0==this.itemCount)return;const t=this.__gl,i=e.viewXfo.tr;if((this.reSort||i.distanceTo(this.prevSortCameraPos)>this.sortCameraMovementDistance)&&(this.sortItems(i),this.prevSortCameraPos=i,e.viewport)){const t=e.viewport.getCamera();this.sortCameraMovementDistance=.3*t.getFocalDistance()}t.enable(t.DEPTH_TEST),t.depthFunc(t.LESS),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),e.pass="ADD",t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.enable(t.CULL_FACE),t.cullFace(t.BACK),this._drawItems(e),t.disable(t.BLEND),t.depthMask(!0)}drawHighlightedGeoms(e){const t=this.__gl;t.disable(t.CULL_FACE);for(const t in this.__glShaderGeomSets)this.__glShaderGeomSets[t].drawHighlightedGeoms(e);const i={currentglShader:null,currentGLMaterial:null,currentGLGeom:null};for(const t of this.visibleItems){if(!t.geomItem.isHighlighted())continue;if(!t.shaders.glselectedshader)continue;const s=t.shaders;if(i.currentglShader!=s.glselectedshader){if(!s.glselectedshader.bind(e))continue;i.currentglShader=s.glselectedshader}this._drawItem(e,t,i)}i.currentGLGeom&&i.currentGLGeom.unbind(e)}drawGeomData(e){const t=this.__gl;t.disable(t.BLEND),t.disable(t.CULL_FACE),t.enable(t.DEPTH_TEST),t.depthFunc(t.LESS),t.depthMask(!0);for(const t in this.__glShaderGeomSets)this.__glShaderGeomSets[t].drawGeomData(e);const i={currentglShader:null,currentGLMaterial:null,currentGLGeom:null};for(const s of this.visibleItems){const a=s.shaders;if(!a.glgeomdatashader)continue;if(i.currentglShader!=a.glgeomdatashader){if(!a.glgeomdatashader.bind(e))continue;i.currentglShader=a.glgeomdatashader}if(s.glMaterial.getMaterial().visibleInGeomDataBuffer){{const i=e.unifs.floatGeomBuffer;i&&t.uniform1i(i.location,t.floatGeomBuffer?1:0)}{const i=e.unifs.passId;i&&t.uniform1i(i.location,this.passIndex)}this._drawItem(e,s,i)}}i.currentGLGeom&&i.currentGLGeom.unbind(e)}}yn.registerPass(Hn,dr.TRANSPARENT);class Un extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\n\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform vec2 pos;\nuniform vec2 size;\nuniform vec2 srctextureDim;\nconst int border = 2;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n  vec2 position = getQuadVertexPositionFromID();\n  v_texCoord = position+0.5;\n  gl_Position = vec4(vec2(-1.0, -1.0) + (pos * 2.0) + (v_texCoord * size * 2.0), 0.0, 1.0);\n\n  vec2 borderVec2 = vec2(float(border), float(border));\n  v_texCoord *= (srctextureDim + (borderVec2 * 2.0)) / srctextureDim;\n  v_texCoord -= borderVec2 / srctextureDim;\n}\n\n'),this.setShaderStage("FRAGMENT_SHADER","\nprecision highp float;\n\nuniform sampler2D srctexture;\nuniform vec2 srctextureDim;\nuniform bool alphaFromLuminance;\nuniform bool invert;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n\nfloat luminanceFromRGB(vec3 rgb) {\n  return 0.2126*rgb.r + 0.7152*rgb.g + 0.0722*rgb.b;\n}\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n  vec2 pixelCoord = v_texCoord*srctextureDim;\n  vec2 uv = v_texCoord;\n\n  // Wrap X coords\n  if(pixelCoord.x < 0.0){\n    uv.x += 1.0/srctextureDim.x;\n    uv.y = 1.0 - uv.y;\n  }\n  else if(pixelCoord.x > srctextureDim.x){\n    uv.x -= 1.0/srctextureDim.x;\n    uv.y = 1.0 - uv.y;\n  }\n\n  // Wrap Y coords\n  if(pixelCoord.y < 0.0){\n    uv.y += 1.0/srctextureDim.y;\n    uv.x = 1.0 - uv.x;\n  }\n  else if(pixelCoord.y > srctextureDim.y){\n    uv.y -= 1.0/srctextureDim.y;\n    uv.x = 1.0 - uv.x;\n  }\n\n  vec4 texel = texture2D(srctexture, uv);\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  // TODO: check why we pre-multiply alphas here.\n  // fragColor = vec4(texel.rgb/texel.a, texel.a);\n\n  if(alphaFromLuminance) {\n    fragColor = vec4(texel.rgb, luminanceFromRGB(texel.rgb));\n  }\n  else {\n    fragColor = texel;\n  }\n  \n  if(invert) {\n    fragColor = vec4(1.0) - fragColor;\n  }\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n\n")}}class On extends Ir{constructor(e,t,i="RGBA",s="FLOAT"){super(e),this.__name=t,this.__formatParam=i,this.__typeParam=s,this.clearColor=new mi(0,0,0,0),this.__subImages=[],this.__layoutNeedsRegeneration=!1,this.__asyncCount=0,this.loaded=!1}incAsyncCount(e=1){this.__asyncCount+=e,this.ready=!1}decAsyncCount(){this.__asyncCount>0&&(this.__asyncCount--,0==this.__asyncCount&&(this.loaded=!0,this.emit("loaded",{})))}isLoaded(){return 0==this.__asyncCount}getMainImage(){return this.super}addSubImage(e){if(e instanceof ps){const t=new pr(this.__gl,e);e.isLoaded()||(this.incAsyncCount(),e.on("loaded",(()=>{this.decAsyncCount()}))),e.setMetadata("ImageAtlas_gltex",t),t.addRef(this);const i=()=>{this.__layoutNeedsRegeneration=!0,this.renderAtlas()};e.on("updated",i),this.__subImages.push(t)}else e.addRef(this),this.__subImages.push(e);return this.__layoutNeedsRegeneration=!0,this.__subImages.length-1}removeSubImage(e){let t;if(e instanceof ps){const i=e.getMetadata("ImageAtlas_gltex");t=this.__subImages.indexOf(i),e.deleteMetadata("ImageAtlas_gltex")}else t=this.__subImages.indexOf(e);this.__subImages[t].removeRef(this),this.__subImages.splice(t,1),this.__layoutNeedsRegeneration=!0}getSubImage(e){return this.__subImages[e]}numSubImages(){return this.__layout?this.__layout.length:this.__subImages.length}generateAtlasLayout(){if(0==this.__subImages.length)return void(this.__layoutNeedsRegeneration=!1);const e=[];this.__subImages.forEach(((t,i)=>{e.push({w:t.width+4,h:t.height+4,area:t.width*t.height,index:i})})),e.sort(((e,t)=>e.area>t.area?-1:e.area<t.area?1:0));const t=new Qt;t.fit(e),this.__layout=[],e.forEach(((e,t)=>{this.__subImages[e.index],e.fit?this.__layout[e.index]={pos:new hi(e.fit.x+2,e.fit.y+2),size:new hi(e.w,e.h)}:console.warn("Unable to fit image")}));const i=t.root.w,s=t.root.h;this.configure({width:i,height:s,format:"FLOAT"==this.__typeParam&&"RGB"==this.__formatParam?"RGBA":this.__formatParam,type:this.__typeParam,filter:"LINEAR"});const a=this.__gl;if(a.__quadVertexIdsBuffer||a.setupInstancedQuad(),!a.__atlasLayoutShader){a.__atlasLayoutShader=new Un(a);const e=a.__atlasLayoutShader.compileForTarget("GLImageAtlas");a.__atlasLayoutShaderBinding=Mr(a,e.attrs,a.__quadattrbuffers,a.__quadIndexBuffer)}let r=Math.round(Math.sqrt(1*this.__layout.length)+.5);if(r=jt.nextPow2(r),r%1!=0&&(r+=1-r%1),a.floatTexturesSupported){const e=new Float32Array(r*r*4);for(let t=0;t<this.__layout.length;t++){const a=this.__layout[t];ci.createFromBuffer(e.buffer,4*t*4).set(a.pos.x/i,a.pos.y/s,a.size.x/i,a.size.y/s)}this.__atlasLayoutTexture&&this.__atlasLayoutTexture.width==r&&this.__atlasLayoutTexture.height==r?this.__atlasLayoutTexture.bufferData(e,r,r):(this.__atlasLayoutTexture&&this.__atlasLayoutTexture.destroy(),this.__atlasLayoutTexture=new pr(a,{format:"RGBA",type:"FLOAT",filter:"NEAREST",wrap:"CLAMP_TO_EDGE",mipMapped:!1,width:r,height:r,data:e}))}else this.__layoutVec4s=[],this.__layout.forEach(((e,t)=>{this.__layoutVec4s[t]=[e.pos.x/i,e.pos.y/s,e.size.x/i,e.size.y/s]}));this.textureDesc[0]=this.width,this.textureDesc[1]=this.height,this.textureDesc[2]=this.__atlasLayoutTexture.width,this.__layoutNeedsRegeneration=!1}getLayoutData(e){return this.__layoutVec4s[e]}renderAtlas(e=!1,t=0){if(0==this.__subImages.length)return;this.__layoutNeedsRegeneration&&this.generateAtlasLayout();const i=this.__gl,s={};this.bindForWriting(s,!0),i.__atlasLayoutShader.bind(s,"GLImageAtlas"),i.__atlasLayoutShaderBinding.bind(s);const a=new hi(1/this.width,1/this.height),r=s.unifs;for(let e=t;e<this.__subImages.length;e++){const t=this.__subImages[e],n=this.__layout[e];t.bindToUniform(s,r.srctexture),i.uniform2fv(r.pos.location,n.pos.multiply(a).asArray()),i.uniform2fv(r.size.location,n.size.multiply(a).asArray()),i.uniform2f(r.srctextureDim.location,t.width,t.height),i.uniform1i(r.alphaFromLuminance.location,t.alphaFromLuminance),i.uniform1i(r.invert.location,t.invert),i.drawQuad(),s.boundTextures--}e&&this.cleanup(),this.unbind(s),this.emit("updated",{})}isReady(){return null!=this.__atlasLayoutTexture}bindToUniform(e,t){super.bindToUniform(e,t);const i=e.unifs;if(this.__atlasLayoutTexture){const s=i[t.name+"_layout"];s&&this.__atlasLayoutTexture.bindToUniform(e,s);const a=i[t.name+"_desc"];a&&this.__gl.uniform4fv(a.location,this.textureDesc)}else{const e=i[t.name+"_desc"];e&&this.__gl.uniform4f(e.location,this.width,this.height,0,0)}return!0}cleanup(){for(const e of this.__subImages)e.removeRef(this);this.__subImages=[],this.destroy()}destroy(){this.cleanup(),super.destroy()}}class Jn extends cr{constructor(){super()}init(e,t){super.init(e,t),this.billboards=[],this.dirtyBillboards=new Set,this.freeIndices=[],this.drawCount=0,this.threshold=0,this.updateRequested=!1,this.prevSortCameraPos=new di,this.atlas=new On(this.renderer.gl,"Billboards","RGBA","UNSIGNED_BYTE",[1,1,1,0]);const i=e=>this.emit("updated",e);this.atlas.on("loaded",i),this.atlas.on("updated",i)}getPassType(){return dr.TRANSPARENT}itemAddedToScene(e,t){return e instanceof ka&&(this.addBillboard(e),!0)}itemRemovedFromScene(e,t){return e instanceof ka&&(this.removeBillboard(e),!0)}filterRenderTree(){}addBillboard(e){const t=e.getParameter("Image"),i=t.getValue();if(!i)return void t.on("valueChanged",(()=>this.addBillboard(e)));let s;s=this.freeIndices.length>0?this.freeIndices.pop():this.billboards.length;const a=this.atlas.addSubImage(i);e.setMetadata("GLBillboardsPass_Index",s);const r=()=>{e.isVisible()?(this.drawCount++,this.dirtyBillboards.add(s)):this.drawCount--,this.reqUpdateIndexArray()};e.on("visibilityChanged",r);const n=()=>{e.isVisible()&&(this.dirtyBillboards.add(s),this.emit("updated",{}))};e.getParameter("GlobalXfo").on("valueChanged",n);const o=()=>{e.isVisible()&&(this.dirtyBillboards.add(s),this.emit("updated",{}))};e.getParameter("Alpha").on("valueChanged",o),e.isVisible()&&this.drawCount++,this.billboards[s]={billboard:e,imageIndex:a,visibilityChanged:r,xfoChanged:n,alphaChanged:o},this.indexArrayUpdateNeeded=!0,this.requestUpdate()}removeBillboard(e){const t=e.getMetadata("GLBillboardsPass_Index");if(-1==t)return void console.warn("Billboard already removed.");const i=this.billboards[t],s=i.billboard.getParameter("Image").getValue();this.atlas.removeSubImage(s),e.off("visibilityChanged",i.visibilityChanged),e.getParameter("GlobalXfo").off("valueChanged",i.xfoChanged),e.getParameter("Alpha").off("valueChanged",i.alphaChanged),this.billboards[t]=null,this.freeIndices.push(t),e.isVisible()&&this.drawCount--,this.indexArrayUpdateNeeded=!0,this.requestUpdate()}populateBillboardDataArray(e,t,i){const s=e.billboard,a=s.getParameter("GlobalXfo").getValue().toMat4(),r=s.getParameter("PixelsPerMeter").getValue(),n=s.getParameter("Pivot").getValue(),o=1/r;let l=0;s.getParameter("AlignedToCamera").getValue()&&(l|=4),s.getParameter("DrawOnTop").getValue()&&(l|=8),s.getParameter("FixedSizeOnscreen").getValue()&&(l|=16);const h=s.getParameter("Alpha").getValue(),d=s.getParameter("Color").getValue(),c=6*t*4,u=ci.createFromBuffer(i.buffer,4*c),m=ci.createFromBuffer(i.buffer,4*(c+4)),g=ci.createFromBuffer(i.buffer,4*(c+8)),_=ci.createFromBuffer(i.buffer,4*(c+12));u.set(a.xAxis.x,a.yAxis.x,a.zAxis.x,a.translation.x),m.set(a.xAxis.y,a.yAxis.y,a.zAxis.y,a.translation.y),g.set(a.xAxis.z,a.yAxis.z,a.zAxis.z,a.translation.z),_.set(o,l,e.imageIndex,h);ci.createFromBuffer(i.buffer,4*(c+16)).set(n.x,n.y,0,0);ci.createFromBuffer(i.buffer,4*(c+20)).set(d.r,d.g,d.b,d.a)}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.emit("updated"))}reqUpdateIndexArray(){this.indexArrayUpdateNeeded||(this.indexArrayUpdateNeeded=!0,this.emit("updated"))}updateIndexArray(){const e=this.__gl;this.indexArray&&this.indexArray.length!=this.drawCount&&(e.deleteBuffer(this.instanceIdsBuffer),this.instanceIdsBuffer=null),this.indexArray=new Float32Array(this.drawCount);let t=0;for(let e=0;e<this.billboards.length;e++)this.billboards[e]&&this.billboards[e].billboard.isVisible()&&(this.indexArray[t]=e,t++);this.instanceIdsBuffer||(this.instanceIdsBuffer=e.createBuffer()),e.bindBuffer(e.ARRAY_BUFFER,this.instanceIdsBuffer),e.bufferData(e.ARRAY_BUFFER,this.indexArray,e.STATIC_DRAW),this.indexArrayUpdateNeeded=!1}updateBillboards(e){const t=()=>{this.indexArrayUpdateNeeded&&this.updateIndexArray();const t=this.__gl;if(!this.glshader){t.__quadVertexIdsBuffer||t.setupInstancedQuad(),this.glshader=new Gn(t);const i=this.glshader.compileForTarget("GLBillboardsPass",e.shaderopts);this.shaderBinding=Mr(t,i.attrs,t.__quadattrbuffers,t.__quadIndexBuffer)}if(this.atlas.renderAtlas(),!t.floatTexturesSupported||!t.drawElementsInstanced)return this.modelMatrixArray=[],this.billboardDataArray=[],this.tintColorArray=[],this.indexArray.forEach((e=>{const t=this.billboards[e],i=t.billboard,s=i.getParameter("GlobalXfo").getValue().toMat4(),a=1/i.getParameter("PixelsPerMeter").getValue();let r=0;i.getParameter("AlignedToCamera").getValue()&&(r|=4),i.getParameter("DrawOnTop").getValue()&&(r|=8),i.getParameter("FixedSizeOnscreen").getValue()&&(r|=16);const n=i.getParameter("Alpha").getValue(),o=i.getParameter("Color").getValue();this.modelMatrixArray[e]=s.asArray(),this.billboardDataArray[e]=[a,r,t.imageIndex,n],this.tintColorArray[e]=[o.r,o.g,o.b,o.a]})),void(this.updateRequested=!1);let i=Math.round(Math.sqrt(6*(this.billboards.length-this.freeIndices.length))+.5);i%6!=0&&(i+=6-i%6),this.width=i,this.drawItemsTexture?this.drawItemsTexture.resize(i,i):(this.drawItemsTexture=new pr(t,{format:"RGBA",type:"FLOAT",width:i,height:i,filter:"NEAREST",wrap:"CLAMP_TO_EDGE",mipMapped:!1}),this.drawItemsTexture.clear()),this.indexArray.forEach((e=>{-1!=e&&this.updateBillboard(e)})),this.updateRequested=!1};this.atlas.isLoaded()?t():this.atlas.on("loaded",t)}updateBillboard(e){if(0==this.drawCount||!this.drawItemsTexture)return;const t=this.billboards[e];if(!t.billboard.isVisible())return;const i=this.__gl,s=new Float32Array(24);this.populateBillboardDataArray(t,0,s),i.bindTexture(i.TEXTURE_2D,this.drawItemsTexture.glTex);const a=6*e%this.width,r=Math.floor(6*e/this.width),n=this.drawItemsTexture.getType(),o=this.drawItemsTexture.getFormat();if("FLOAT"==n)i.texSubImage2D(i.TEXTURE_2D,0,a,r,6,1,i[o],i[n],s);else{const e=jt.convertFloat32ArrayToUInt16Array(s);i.texSubImage2D(i.TEXTURE_2D,0,a,r,6,1,i[o],i[n],e)}}sort(e){for(const t of this.billboards){const{billboard:i}=t;if(i&&i.isVisible()){const s=i.getParameter("GlobalXfo").getValue();t.dist=s.tr.distanceTo(e)}}this.indexArray.sort(((e,t)=>-1==e?1:-1==t||this.billboards[e].dist>this.billboards[t].dist?-1:this.billboards[e].dist<this.billboards[t].dist?1:0));const t=this.__gl;t.floatTexturesSupported&&this.instanceIdsBuffer&&(t.bindBuffer(t.ARRAY_BUFFER,this.instanceIdsBuffer),t.bufferData(t.ARRAY_BUFFER,this.indexArray,t.STATIC_DRAW))}draw(e){if(0==this.drawCount)return;if(this.updateRequested&&this.updateBillboards(e),this.dirtyBillboards.size>0&&(this.dirtyBillboards.forEach((e=>{this.updateBillboard(e)})),this.dirtyBillboards.clear()),this.indexArrayUpdateNeeded&&this.updateIndexArray(),!this.glshader)return;const t=this.__gl;t.disable(t.CULL_FACE),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA);const i=e.viewXfo.tr;if(i.distanceTo(this.prevSortCameraPos)>this.threshold)if(this.sort(i),this.prevSortCameraPos=i.clone(),this.drawCount>1){const e=this.billboards[this.indexArray[0]].billboard.getParameter("GlobalXfo").getValue().tr,t=this.billboards[this.indexArray[1]].billboard.getParameter("GlobalXfo").getValue().tr;this.threshold=e.distanceTo(t)}else this.threshold=9999;this.glshader.bind(e),this.shaderBinding.bind(e);const s=e.unifs;this.atlas.bindToUniform(e,s.atlasBillboards);const a=1==e.vrPresenting;if(t.uniform1i(s.inVR.location,a),t.floatTexturesSupported&&t.drawElementsInstanced){this.drawItemsTexture.bindToUniform(e,s.instancesTexture),t.uniform1i(s.instancesTextureSize.location,this.width);{const i=e.attrs.instanceIds.location;t.enableVertexAttribArray(i),t.bindBuffer(t.ARRAY_BUFFER,this.instanceIdsBuffer),t.vertexAttribPointer(i,1,t.FLOAT,!1,4,0),t.vertexAttribDivisor(i,1)}e.bindViewports(s,(()=>{t.drawElementsInstanced(t.TRIANGLES,6,t.UNSIGNED_SHORT,0,this.drawCount)}))}else{const i=this.indexArray.length;for(let a=0;a<i;a++)t.uniformMatrix4fv(s.modelMatrix.location,!1,this.modelMatrixArray[a]),t.uniform4fv(s.billboardData.location,this.billboardDataArray[a]),t.uniform4fv(s.tintColor.location,this.tintColorArray[a]),t.uniform4fv(s.layoutData.location,this.atlas.getLayoutData(this.billboards[a].imageIndex)),e.bindViewports(s,(()=>{t.drawQuad()}))}t.disable(t.BLEND)}}yn.registerPass(Jn,dr.TRANSPARENT);class Qn extends Kn{constructor(){super()}init(e,t){super.init(e,t)}getPassType(){return dr.OVERLAY}filterGeomItem(e){if(e.isOverlay())return!0;const t=e.getParameter("Material").getValue().getShaderClass();return!(!t||!t.isOverlay())}draw(e){const t=this.__gl;t.clear(t.DEPTH_BUFFER_BIT),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),e.pass="ADD",t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.__traverseTreeAndDraw(e),t.disable(t.BLEND)}drawGeomData(e){const t=this.__gl;t.clear(t.DEPTH_BUFFER_BIT),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),e.pass="ADD",t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),super.drawGeomData(e),t.disable(t.BLEND),t.enable(t.DEPTH_TEST)}}yn.registerPass(Qn,dr.OVERLAY);class jn extends Xr{constructor(e){super(e),this.setShaderStage("VERTEX_SHADER",'\nprecision highp float;\n\nattribute vec4 positions;\ninstancedattribute float instanceIds;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 cameraMatrix;\n\n<%include file="GLSLUtils.glsl"/>\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\n\n<%include file="stack-gl/transpose.glsl"/>\n\nuniform sampler2D instancesTexture;\nuniform int instancesTextureSize;\n\n\nconst int cols_per_instance = 6;\n\nmat4 getMatrix(sampler2D texture, int textureSize, int index) {\n  // Unpack 3 x 4 matix columns into a 4 x 4 matrix.\n  vec4 col0 = fetchTexel(texture, textureSize, (index * cols_per_instance) + 0);\n  vec4 col1 = fetchTexel(texture, textureSize, (index * cols_per_instance) + 1);\n  vec4 col2 = fetchTexel(texture, textureSize, (index * cols_per_instance) + 2);\n  mat4 result = mat4(col0, col1, col2, vec4(0.0, 0.0, 0.0, 1.0));\n  return transpose(result);\n  // return mat4(1.0);\n}\n\nmat4 getModelMatrix(int id) {\n  return getMatrix(instancesTexture, instancesTextureSize, id);\n}\nvec4 getInstanceData(int id, int row) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * cols_per_instance) + row);\n}\n\n\n#else\n\nuniform mat4 modelMatrix;\nuniform vec4 row3;\nuniform vec4 row4;\nuniform vec4 row5;\n\n#endif\n\n\n/* VS Outputs */\nvarying vec4 v_color;\n\nvoid main(void) {\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\n  int instanceID = int(instanceIds);\n\n  mat4 modelMatrix = getModelMatrix(instanceID);\n  vec4 row3 = getInstanceData(instanceID, 3);\n  vec4 row4 = getInstanceData(instanceID, 4);\n  vec4 row5 = getInstanceData(instanceID, 5);\n\n#else\n\n#endif\n\n  v_color = row5;\n\n  vec4 pos = positions;\n  if (pos.x < 0.0) pos.x = row3.x;\n  else if (pos.x > 0.0) pos.x = row4.x;\n  if (pos.y < 0.0) pos.y = row3.y;\n  else if (pos.y > 0.0) pos.y = row4.y;\n  if (pos.z < 0.0) pos.z = row3.z;\n  else if (pos.z > 0.0) pos.z = row4.z;\n\n  // Use cross platform bit flags methods\n  bool drawOnTop = false;//testFlag(flags, 8); // flag = 1 << 3\n\n  mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix;// * modelMatrix;\n  gl_Position = modelViewProjectionMatrix * pos;\n\n  // Use cross platform bit flags methods\n  if(drawOnTop){\n    gl_Position.z = mix(gl_Position.z, -gl_Position.w, 0.5);\n  }\n}\n'),this.setShaderStage("FRAGMENT_SHADER","\nprecision highp float;\n\n/* VS Outputs */\nvarying vec4 v_color;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  fragColor = v_color;\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n")}}class qn extends cr{constructor(){super(),this.boxes=[],this.dirtyBoxes=new Set,this.freeIndices=[],this.drawCount=0,this.indexArrayUpdateNeeded=!1,this.__updateRequested=!1,this.__childItemAdded=this.__childItemAdded.bind(this),this.__childItemRemoved=this.__childItemRemoved.bind(this)}getPassType(){return dr.OPAQUE}init(e,t){super.init(e,t);const i=this.__renderer.gl;this.glgeom=new en(i,new Bs(1,1,1)),this.glshader=new jn(i)}itemAddedToScene(e,t){return!1}itemRemovedFromScene(e,t){return!1}addTreeItem(e,t=!0){if(e instanceof us&&(this.bindTreeItem(e),t)){for(const t of e.getChildren())t&&this.addTreeItem(t);e.on("childAdded",this.__childItemAdded),e.on("childRemoved",this.__childItemRemoved)}}__childItemAdded(e){this.addTreeItem(e.childItem)}__childItemRemoved(e){this.unbindTreeItem(e.childItem)}bindTreeItem(e){let t;t=this.freeIndices.length>0?this.freeIndices.pop():this.boxes.length,e.setMetadata("GLBoundingBoxPass_Index",t);const i=()=>{e.isVisible()?(this.drawCount++,this.dirtyBoxes.add(t)):this.drawCount--,this.indexArrayUpdateNeeded=!0};e.on("visibilityChanged",i);const s=()=>{e.isVisible()&&(this.dirtyBoxes.add(t),this.emit("updated",{}))};e.getParameter("GlobalXfo").on("valueChanged",s),e.getParameter("BoundingBox").on("valueChanged",s),e.isVisible()&&this.drawCount++,this.boxes[t]={treeitem:e,visibilityChanged:i,xfoChanged:s},this.indexArrayUpdateNeeded=!0,this.__updateRequested=!0,this.emit("updated")}unbindTreeItem(e){const t=e.getMetadata("GLBoundingBoxPass_Index");if(-1==t)return void console.warn("Billboard already removed.");const i=this.boxes[t];e.off("visibilityChanged",i.visibilityChanged),e.getParameter("GlobalXfo").off("valueChanged",i.xfoChanged),e.getParameter("BoundingBox").off("valueChanged",i.xfoChanged),this.boxes[t]=null,this.freeIndices.push(t),e.isVisible()&&this.drawCount--,this.indexArrayUpdateNeeded=!0,this.__updateRequested=!0,this.__updateBoxes(),this.emit("updated")}__populateBoxesDataArray(e,t,i){const s=e.treeitem,a=s.getParameter("GlobalXfo"),r=s.getParameter("GeomMat"),n=r?new mi(1,0,0,1):new mi(0,0,1,1),o=r?r.getValue():a.getValue().toMat4(),l=s.getParameter("BoundingBox").getValue(),h=6*t*4,d=ci.createFromBuffer(i.buffer,4*h),c=ci.createFromBuffer(i.buffer,4*(h+4)),u=ci.createFromBuffer(i.buffer,4*(h+8)),m=ci.createFromBuffer(i.buffer,4*(h+12)),g=ci.createFromBuffer(i.buffer,4*(h+16)),_=ci.createFromBuffer(i.buffer,4*(h+20));d.set(o.xAxis.x,o.yAxis.x,o.zAxis.x,o.translation.x),c.set(o.xAxis.y,o.yAxis.y,o.zAxis.y,o.translation.y),u.set(o.xAxis.z,o.yAxis.z,o.zAxis.z,o.translation.z),m.set(l.p0.x,l.p0.y,l.p0.z,0),g.set(l.p1.x,l.p1.y,l.p1.z,0),_.set(n.r,n.g,n.b,n.a)}__updateIndexArray(){const e=this.__gl;this.__indexArray&&this.__indexArray.length!=this.drawCount&&(e.deleteBuffer(this.__instanceIdsBuffer),this.__instanceIdsBuffer=null),this.__indexArray=new Float32Array(this.drawCount);let t=0;for(let e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].treeitem.isVisible()&&(this.__indexArray[t]=e,t++);this.__instanceIdsBuffer||(this.__instanceIdsBuffer=e.createBuffer()),e.bindBuffer(e.ARRAY_BUFFER,this.__instanceIdsBuffer),e.bufferData(e.ARRAY_BUFFER,this.__indexArray,e.STATIC_DRAW),this.indexArrayUpdateNeeded=!1}__updateBoxes(){this.indexArrayUpdateNeeded&&this.__updateIndexArray();const e=this.__renderer.gl;if(!e.floatTexturesSupported||!e.drawElementsInstanced)return this.__modelMatrixArray=[],this.__treeitemDataArray=[],this.__tintColorArray=[],this.__indexArray.forEach((e=>{const t=this.boxes[e],i=t.treeitem,s=i.getParameter("GlobalXfo").getValue().toMat4(),a=1/i.getParameter("PixelsPerMeter").getValue();let r=0;i.getParameter("AlignedToCamera").getValue()&&(r|=4),i.getParameter("DrawOnTop").getValue()&&(r|=8),i.getParameter("FixedSizeOnscreen").getValue()&&(r|=16);const n=i.getParameter("Alpha").getValue(),o=i.getParameter("Color").getValue();this.__modelMatrixArray[e]=s.asArray(),this.__treeitemDataArray[e]=[a,r,t.imageIndex,n],this.__tintColorArray[e]=[o.r,o.g,o.b,o.a]})),void(this.__updateRequested=!1);let t=Math.round(Math.sqrt(6*(this.boxes.length-this.freeIndices.length))+.5);t%6!=0&&(t+=6-t%6),this.__width=t,this.__drawItemsTexture?this.__drawItemsTexture.resize(t,t):(this.__drawItemsTexture=new pr(e,{format:"RGBA",type:"FLOAT",width:t,height:t,filter:"NEAREST",wrap:"CLAMP_TO_EDGE",mipMapped:!1}),this.__drawItemsTexture.clear()),this.__indexArray.forEach((e=>{-1!=e&&this.__updateBox(e)})),this.__updateRequested=!1}__updateBox(e){if(0==this.drawCount||!this.__drawItemsTexture)return;const t=this.boxes[e];if(!t.treeitem.isVisible())return;const i=this.__gl,s=new Float32Array(24);this.__populateBoxesDataArray(t,0,s),i.bindTexture(i.TEXTURE_2D,this.__drawItemsTexture.glTex);const a=6*e%this.__width,r=Math.floor(6*e/this.__width),n=this.__drawItemsTexture.getType(),o=this.__drawItemsTexture.getFormat();if("FLOAT"==n)i.texSubImage2D(i.TEXTURE_2D,0,a,r,6,1,i[o],i[n],s);else{const e=jt.convertFloat32ArrayToUInt16Array(s);i.texSubImage2D(i.TEXTURE_2D,0,a,r,6,1,i[o],i[n],e)}}draw(e){if(0==this.drawCount)return;this.__updateRequested&&this.__updateBoxes(),this.dirtyBoxes.size>0&&(this.dirtyBoxes.forEach((e=>{this.__updateBox(e)})),this.dirtyBoxes.clear()),this.indexArrayUpdateNeeded&&this.__updateIndexArray();const t=this.__gl;this.glshader.bind(e),this.glgeom.bind(e);const i=e.unifs;if(t.floatTexturesSupported&&t.drawElementsInstanced){this.__drawItemsTexture.bindToUniform(e,i.instancesTexture),t.uniform1i(i.instancesTextureSize.location,this.__width);{const i=e.attrs.instanceIds.location;t.enableVertexAttribArray(i),t.bindBuffer(t.ARRAY_BUFFER,this.__instanceIdsBuffer),t.vertexAttribPointer(i,1,t.FLOAT,!1,4,0),t.vertexAttribDivisor(i,1)}e.bindViewports(i,(()=>{this.glgeom.drawInstanced(this.drawCount)}))}else{const s=this.__indexArray.length;for(let a=0;a<s;a++)e.bindViewports(i,(()=>{t.drawQuad()}))}}}const $n={SystemDesc:si,Registry:oi,...vi,...ii,..._r,...Object.freeze({__proto__:null,create3DContext:fr,GLTexture2D:pr,GLShader:Xr,GLFbo:xr,GLRenderTarget:Ir,GLRenderer:yn,GLBaseViewport:Pr,GLViewport:Wr,shaderLibrary:yr,GLGeom:qr,GLPoints:$r,GLLines:en,GLMesh:tn,GLGeomItemChangeType:sn,GLGeomItem:an,GLGeomItemSet:rn,GLMaterial:Qr,GLMaterialGeomItemSets:nn,GLShaderMaterials:on,generateShaderGeomBinding:Mr,genDataTypeDesc:vr,BillboardShader:Gn,DepthMapShader:Xn,EnvMapShader:Fr,EnvProjectionShader:xn,OctahedralEnvProjectionShader:In,LatLongEnvProjectionShader:Vn,FatLinesShader:vn,FatLinesGeomDataShader:Rn,FlatSurfaceShader:wn,LinesShader:Mn,NormalsShader:Tn,PointsShader:Ln,FatPointsShader:Sn,FatPointsGeomDataShader:Zn,FatPointsSelectedShader:Cn,ScreenQuadShader:zr,SimpleSurfaceShader:Fn,StandardSurfaceShader:En,StandardSurfaceGeomDataShader:zn,StandardSurfaceSelectedGeomsShader:Nn,ScreenSpaceShader:Pn,UnpackHDRShader:Vr,GLPass:cr,PassType:dr,GLStandardGeomsPass:Wn,GLOpaqueGeomsPass:Kn,GLTransparentGeomsPass:Hn,GLBillboardsPass:Jn,GLOverlayPass:Qn,GLBoundingBoxPass:qn,VRViewport:Dr})},eo=new class{constructor(e){this.version=e,this.registry={}}registerLib(e){const t=e.name,i=e.version,s=e.dependencies["@zeainc/zea-engine"],a=this.version.split("-")[0];if(Dt.satisfies(a,s))return this.registry[t]=i,void P("Registered lib '%s' v%s",t,i);throw new Error(`The library '${t}' is not compatible with this version of the Zea Engine (${this.version}). It expects version '${s}'.`)}listLibs(){return this.registry}}(t.version);P("Zea Engine version %s",t.version),P("Zea Engine env %O",Ut),e.Allocator1D=$t,e.AssetItem=Da,e.AttrValue=li,e.Attribute=Is,e.BaseGeom=vs,e.BaseGeomItem=xa,e.BaseGroup=Ra,e.BaseImage=ps,e.BaseItem=Si,e.BaseProxy=Ts,e.BaseTool=hr,e.BillboardItem=ka,e.BillboardShader=Gn,e.BinReader=Ti,e.BinWriter=_s,e.BooleanParameter=Ai,e.Box2=Gi,e.Box3=xi,e.Camera=Ka,e.CameraManipulator=mr,e.Circle=Ps,e.CodeParameter=$i,e.Color=mi,e.ColorParameter=Hi,e.Cone=As,e.Cross=Ws,e.Cuboid=Ds,e.CuttingPlane=er,e.Cylinder=ks,e.DataImage=Js,e.DepthMapShader=Xn,e.Disc=Ks,e.Env=Ut,e.EnvMap=pa,e.EnvMapShader=Fr,e.EnvProjectionShader=xn,e.EulerAngles=gi,e.EventEmitter=Jt,e.FatLinesGeomDataShader=Rn,e.FatLinesShader=vn,e.FatPointsGeomDataShader=Zn,e.FatPointsSelectedShader=Cn,e.FatPointsShader=Sn,e.FileImage=js,e.FileImage2D=qs,e.FilePathParameter=fs,e.FlatSurfaceShader=wn,e.Float32=6,e.Frustum=Vi,e.GIFImage=_a,e.GLBaseViewport=Pr,e.GLBillboardsPass=Jn,e.GLBoundingBoxPass=qn,e.GLFbo=xr,e.GLGeom=qr,e.GLGeomItem=an,e.GLGeomItemChangeType=sn,e.GLGeomItemSet=rn,e.GLLines=en,e.GLMaterial=Qr,e.GLMaterialGeomItemSets=nn,e.GLMesh=tn,e.GLOpaqueGeomsPass=Kn,e.GLOverlayPass=Qn,e.GLPass=cr,e.GLPoints=$r,e.GLRenderTarget=Ir,e.GLRenderer=yn,e.GLShader=Xr,e.GLShaderMaterials=on,e.GLStandardGeomsPass=Wn,e.GLTexture2D=pr,e.GLTransparentGeomsPass=Hn,e.GLViewport=Wr,e.GeomItem=va,e.GeomLibrary=Ya,e.GeometryParameter=as,e.Grid=Ys,e.GridTreeItem=sr,e.Group=Ja,e.GrowingPacker=Qt,e.ImageParameter=ji,e.InstanceItem=Xa,e.ItemSetParameter=ss,e.KinematicGroup=ja,e.LDRImage=$s,e.LDRVideo=ea,e.Label=ya,e.LatLongEnvProjectionShader=Vn,e.Lines=ws,e.LinesCuboid=Bs,e.LinesProxy=Ss,e.LinesShader=Mn,e.ListParameter=es,e.Mat3=_i,e.Mat3Parameter=Oi,e.Mat4=fi,e.Mat4Parameter=Ji,e.Material=Xs,e.MaterialColorParam=ys,e.MaterialFloatParam=bs,e.MaterialGroup=qa,e.MaterialLibrary=Aa,e.MaterialParameter=xs,e.MathFunctions=jt,e.Mesh=Ms,e.MeshProxy=Zs,e.MultiChoiceParameter=Yi,e.NormalsShader=Tn,e.NumberParameter=Bi,e.ObjAsset=or,e.OctahedralEnvProjectionShader=In,e.Operator=os,e.OperatorInput=rs,e.OperatorOutput=ns,e.OperatorOutputMode=Pi,e.POINTER_TYPES=ti,e.Parameter=Wi,e.ParameterOwner=Mi,e.PassType=dr,e.Plane=Hs,e.PlaneType=Ii,e.PointGrid=zs,e.Points=Rs,e.PointsProxy=Ls,e.PointsShader=Ln,e.ProceduralLines=Fs,e.ProceduralMesh=Es,e.ProceduralPoints=Cs,e.Quat=pi,e.QuatParameter=Ui,e.RGBA=ui,e.Ray=bi,e.Rect=Ns,e.RefCounted=wi,e.Registry=oi,e.RouterOperator=lr,e.SInt16=3,e.SInt32=5,e.SInt8=1,e.Scene=rr,e.ScreenQuadShader=zr,e.ScreenSpaceShader=Pn,e.SelectionSet=wa,e.SimpleSurfaceShader=Fn,e.Sphere=Us,e.SphereType=Xi,e.StandardSurfaceGeomDataShader=zn,e.StandardSurfaceSelectedGeomsShader=Nn,e.StandardSurfaceShader=En,e.StringFunctions=ei,e.StringParameter=qi,e.StructParameter=ts,e.SystemDesc=si,e.Torus=Os,e.TreeItem=us,e.TreeItemParameter=is,e.UInt16=2,e.UInt32=4,e.UInt8=0,e.UnpackHDRShader=Vr,e.VLAAsset=nr,e.VRViewport=Dr,e.Vec2=hi,e.Vec2Parameter=Di,e.Vec3=di,e.Vec3Parameter=ki,e.Vec4=ci,e.Vec4Parameter=Ki,e.Version=gs,e.VertexAttribute=Vs,e.VideoStreamImage2D=Ga,e.Xfo=yi,e.XfoParameter=Qi,e.ZeaEngine=$n,e.create3DContext=fr,e.genDataTypeDesc=vr,e.generateShaderGeomBinding=Mr,e.getFileFolder=Zi,e.labelManager=ba,e.libsRegistry=eo,e.loadBinfile=Ni,e.loadJSONfile=Ei,e.loadTextfile=Fi,e.loadXMLfile=zi,e.packageJson=t,e.resourceLoader=ms,e.sgFactory=gr,e.shaderLibrary=yr,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=index.umd.js.map
